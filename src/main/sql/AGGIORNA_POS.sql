--SET search_path = public, pg_catalog;

SET statement_timeout = 0;
-- decommentare la riga seguente in caso di lancio da interprete di comando direttamente da linux
--SET client_encoding = 'LATIN1';
SET standard_conforming_strings = off;
SET check_function_bodies = false;
SET client_min_messages = warning;
SET escape_string_warning = off;

-- Function: sp_backupanddropviews(text)

-- DROP FUNCTION sp_backupanddropviews(text);

CREATE OR REPLACE FUNCTION sp_backupanddropviews(root_name text)
  RETURNS void AS
$BODY$
-- dichiarazione variabili
	DECLARE 
		r record;
		s TEXT;
		is_table boolean;
		dependencies_num integer;
	begin

		perform count(*) from dump_view_tmp as numview ;

		-- Se la tabella temporanea dump_view_tmp esiste gia', allora la ripopolo partendo dalla nuova root
		
		insert into dump_view_tmp   with recursive find_children(parent,child, depth, parent_definition, child_definition) as
		   (
		      select vtu_parent.table_name as parent , vtu_parent.view_name as children, 0 as depth, pg_get_viewdef(vtu_parent.table_name, true) as parent_definition, pg_get_viewdef(vtu_parent.view_name, true) as child_definition
		      from information_schema.view_table_usage as vtu_parent 
		      where vtu_parent.view_schema=current_schema() and vtu_parent.table_name=LOWER($1)
		      group by parent,children

		      union all

		      select vtu_child.table_name, vtu_child.view_name, depth+1,  pg_get_viewdef(vtu_child.table_name, true), pg_get_viewdef(vtu_child.view_name, true)
		      from find_children vtu_parent, information_schema. view_table_usage vtu_child
		      where vtu_child.table_name = vtu_parent.child and vtu_child.view_schema=current_schema()
		)

		      select distinct dependencies.parent, dependencies.child, dependencies.depth, dependencies.parent_definition, dependencies.child_definition
		      from find_children dependencies
		      order by dependencies.depth DESC;

		select into is_table (select EXISTS (
				    SELECT 1 
				    FROM   pg_catalog.pg_class c
				    JOIN   pg_catalog.pg_namespace n ON n.oid = c.relnamespace
				    AND    c.relname = LOWER($1)
				    AND    c.relkind = 'r'    --tabelle
				)) ;


		if not is_table then
			-- se il parametro passato e' una view la salvo nella tabella 
			insert into dump_view_tmp values(LOWER($1), '', 0, pg_get_viewdef(LOWER($1), true), pg_get_viewdef(LOWER($1), true));
		end if;

		-- conto il numero di dipendenze trovate a partire dalla root => prevenzione di esecuzione query vuota in caso non ci fossero dipendenze per la root 
		select into dependencies_num count(*) from dump_view_tmp;
		
		-- se per la root sono state trovate dipendenze
		if dependencies_num > 0 then
			-- procedo alla drop delle dipendenze
			FOR r IN 
				select distinct to_drop.child, to_drop.depth
				from dump_view_tmp as to_drop
				order by to_drop.depth DESC
			LOOP
				if r.child <> '' then
					s := 'DROP VIEW IF EXISTS ' ||   quote_ident(r.child) || ';';
					EXECUTE s;
					RAISE NOTICE 's = % ',s;
				end if;
			END LOOP;
		end if;

		if not is_table then
			s:= 'DROP VIEW IF EXISTS ' ||   quote_ident(LOWER($1)) || ';';
			execute s;
		end if;


		-- se la tabella temporanea non esiste, allora la creo partendo dalla root fornita
			
		exception
			when SQLSTATE '42P01' then
				raise notice 'la tabella temporanea non e presente : CREAZIONE TABELLA TEMPORANEA';
				-- creazione della tabella temporanea delle dipendenze
				create temp table dump_view_tmp as
				(
				   with recursive find_children(parent,child, depth, parent_definition, child_definition) as
				   (
				      select vtu_parent.table_name as parent , vtu_parent.view_name as children, 0 as depth, pg_get_viewdef(vtu_parent.table_name, true) as parent_definition, pg_get_viewdef(vtu_parent.view_name, true) as child_definition
				      from information_schema.view_table_usage as vtu_parent 
				      where vtu_parent.view_schema=current_schema() and vtu_parent.table_name=LOWER($1)
				      group by parent,children

				      union all

				      select vtu_child.table_name, vtu_child.view_name, depth+1,  pg_get_viewdef(vtu_child.table_name, true), pg_get_viewdef(vtu_child.view_name, true)
				      from find_children vtu_parent, information_schema. view_table_usage vtu_child
				      where vtu_child.table_name = vtu_parent.child and vtu_child.view_schema=current_schema()
				)

				      select distinct dependencies.parent, dependencies.child, dependencies.depth, dependencies.parent_definition, dependencies.child_definition
				      from find_children dependencies
				      order by dependencies.depth DESC
				);


				select into is_table (select EXISTS (
							    SELECT 1 
							    FROM   pg_catalog.pg_class c
							    JOIN   pg_catalog.pg_namespace n ON n.oid = c.relnamespace
							    AND    c.relname = LOWER($1)
							    AND    c.relkind = 'r'    --tabelle
							)) ;


				if not is_table then
					-- se il parametro passato una view la salvo nella tabella 
					insert into dump_view_tmp values(LOWER($1), '', 0, pg_get_viewdef(LOWER($1), true), pg_get_viewdef(LOWER($1), true));
				end if;

				-- conto il numero di dipendenze trovate a partire dalla root => prevenzione di esecuzione query vuota in caso non ci fossero dipendenze per la root 
				select into dependencies_num count(*) from dump_view_tmp;
				
				-- se per la root sono state trovate dipendenze
				if dependencies_num > 0 then
					-- procedo alla drop delle dipendenze
					FOR r IN 
						select distinct to_drop.child, to_drop.depth
						from dump_view_tmp as to_drop
						order by to_drop.depth DESC
					LOOP
						if r.child <> '' then
							s := 'DROP VIEW IF EXISTS ' ||   quote_ident(r.child) || ';';
							EXECUTE s;
							RAISE NOTICE 's = % ',s;
						end if;
					END LOOP;
				end if;

				if not is_table then
					s:= 'DROP VIEW IF EXISTS ' ||   quote_ident(LOWER($1)) || ';';
					execute s;
				end if;
	end;
	
$BODY$
  LANGUAGE plpgsql VOLATILE
  COST 100;

-- Script per la creazione della tabella temporanea delle dipendenze, in questo modo la store procedure sp_restoreviews si riesce a compilare
create temp table dump_view_tmp(parent character varying, child character varying, depth integer, parent_definition text, child_definition text);


-- Function: sp_restoreviews(text)

-- DROP FUNCTION sp_restoreviews(text);

CREATE OR REPLACE FUNCTION sp_restoreviews(root_name text)
  RETURNS void AS
$$
declare 
	i integer;
begin	
	
	execute sp_recursiverestoreviews(LOWER($1), 1);

	truncate table dump_view_tmp;

	exception 
		when others then 

		raise notice 'The transaction is in an uncommittable state. '
				'Transaction was rolled back';
	
		raise notice '% %', SQLERRM, SQLSTATE;
end;	
$$
  LANGUAGE plpgsql ;


-- NOME  : SP_RESTOREVIEWS
-- INPUT : root_name text, nome della root da cui far partire la procedura di restore
--         root_inclusion, 0 indica l'inclusione della root / 1 indica l'esclusione della root (in caso di view lanciare la sp con il parametro -e) 	   
create or replace function sp_recursiverestoreviews(root_name text, root_inclusion integer) returns void as   $$
begin
	declare
		s TEXT;
		curr_view_definition text; 		-- script sql della view corrente
		further_dep integer;	   		-- dipendenze ulteriori che sono propedeutiche alla rigenerazione della view corrente
		leaf integer;		   		-- se 0 indica che la view corrente ?na foglia (non ha discendenti)
		dependency record;	   		-- record di una dipendenza		
		f_dependency dump_view_tmp%ROWTYPE;	-- record di una dipendenza propedeutica
		is_table boolean;			-- indica se la root ?na tabella oppure no
		parent_is_table boolean;		-- indica se il padre della root corrente ?na tabella oppure no
		
	begin
		 further_dep := 0;
		 select into is_table (select EXISTS (
					    SELECT 1 
					    FROM   pg_catalog.pg_class c
					    JOIN   pg_catalog.pg_namespace n ON n.oid = c.relnamespace
					    AND    c.relname = LOWER($1)
					    AND    c.relkind = 'r'    --tabelle
					)); 
		 if is_table or $2 = 1 then
			 -- se la root ?na tabella o la root ?a escludere
			 for dependency in select distinct parent, child, parent_definition, child_definition from dump_view_tmp where parent=LOWER($1) loop
				-- per ogni vista discendente riapplico la procedura di rigenerazione
				execute sp_recursiverestoreviews(dependency.child, 0);
			 end loop;
		 else 
			 -- se la view corrente non ?tata ancora rigenerata 
			 IF NOT EXISTS ( SELECT 1 
				     FROM pg_catalog.pg_class c
				     JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace
				     WHERE  n.nspname = current_schema()  AND    c.relname = LOWER($1)
				   ) THEN

				-- controllo se la view corrente dipende da altre view 
				select into further_dep count(*) from dump_view_tmp where child=LOWER($1);

				if further_dep <> 0 then
					-- se la view corrente ha degli ascendenti
					for f_dependency in select * from dump_view_tmp where child=LOWER($1) loop
						select into parent_is_table (select EXISTS (
										    SELECT 1 
										    FROM   pg_catalog.pg_class c
										    JOIN   pg_catalog.pg_namespace n ON n.oid = c.relnamespace
										    AND    c.relname = f_dependency.parent
										    AND    c.relkind = 'r'    --tabelle
										));
						-- se non discendo da una tabella
						if not parent_is_table then
							-- per ogni ascendente riapplico la procedura di rigenerazione
							execute sp_recursiverestoreviews(f_dependency.parent, 0);
						end if;
					end loop;
				end if;
				
				-- controllo se la view corrente ha dei discendenti 
				select into leaf count(*) from dump_view_tmp where parent=LOWER($1);
				
				if leaf <> 0 then
					if LOWER($1) <> '' then
						-- se la view corrente ha dei discendenti => la definizione della view corrente si trova nella colonna parent
						select into curr_view_definition parent_definition from dump_view_tmp where parent=LOWER($1);
					end if;
				else
					if LOWER($1) <> '' then
						-- la view ?na foglia => la definizione della view corrente si trova nella colonna child
						select into curr_view_definition child_definition from dump_view_tmp where child=LOWER($1);
					end if;
				end if;
			
				-- rigenero la view corrente 
				if LOWER($1) <> '' then
					s := 'CREATE OR REPLACE VIEW ' ||   quote_ident(LOWER($1)) || ' AS ' || curr_view_definition || ';';
					EXECUTE s;
					raise notice ' rigenerazione vista : %  : OK', LOWER($1);
				end if;
				
				-- per ogni discendente diretto della view corrente riapplico la procedura di rigenerazione
				for dependency in select distinct parent, child, parent_definition, child_definition from dump_view_tmp where parent=LOWER($1) loop
					if dependency.child <> '' then
						execute sp_recursiverestoreviews(dependency.child, 0);
					end if;
				end loop;
				
			 END IF;
		end if;
	end;
end;	
$$ language plpgsql;

-- view dismesse, vanno eliminate
drop view if exists v_ws_abilitazioni_bando;
drop view if exists v_ws_fornitori_documenti;

-- le drop view sono inserite al contrario rispetto alla creazione delle view in modo da ripulire il db da tutto senza problemi di dipendenze
drop view if exists v_ws_sommaurgenza;
drop view if exists v_ws_apertura_buste_allegati;
drop view if exists v_ws_gara_graduatoria;
drop view if exists v_ws_apertura_off_economica;
drop view if exists v_ws_apertura_val_tecnica;
drop view if exists v_ws_apertura_doc_amm;
drop view if exists v_ws_fasi_gara_partecipanti;
drop view if exists v_ws_trasp_contratti_dett_rti;
drop view if exists v_ws_gare_n_aggiudicatari;
drop view if exists v_ws_trasp_contratti_partecip;
drop view if exists v_ws_trasp_contratti;
drop view if exists v_ws_trasp_contratti_estesa;
drop view if exists v_ws_trasp_contratti_ult_contr;
drop view if exists v_ws_gare_pubb_esito;
drop view if exists v_ws_aderente_lotto;
drop view if exists v_ws_gare_anticor_ditte;
drop view if exists v_ws_gare_anticor;
drop view if exists v_ws_adempimenti_anticor;
drop view if exists v_ws_gare_ammaperta_doc;
drop view if exists v_ws_gare_ammaperta;
drop view if exists v_ws_gare_lotti_tab_ammaperta;
drop view if exists v_ws_gare_lotti_ammaperta;
drop view if exists v_ws_consulenti;
drop view if exists v_ws_consulenti_lotti;
drop view if exists v_ws_esiti_ammaperta;
drop view if exists v_ws_gare_tabinf_doc;
drop view if exists v_ws_gare_tabinf;
drop view if exists v_ws_gare_istruttori;
drop view if exists v_ws_gare_ordinanti;
drop view if exists v_ws_oda;
drop view if exists v_ws_esiti;
drop view if exists v_ws_esiti_ultimo_lotto;
drop view if exists v_ws_avvisi;
drop view if exists v_ws_mandanti_ati;
drop view if exists v_ws_fornitori_ati;
drop view if exists v_ws_attrib_agg_offerta;
drop view if exists v_ws_voci_dettaglio_offerta;
drop view if exists v_ws_dettaglio_bando;
drop view if exists v_ws_lotti_per_comprovareq;
drop view if exists v_ws_lotti_per_offerte_pl_un;
drop view if exists v_ws_lotti_per_offerta;
drop view if exists v_ws_lotti_per_partecipazione;
drop view if exists v_ws_bandi_per_aste;
drop view if exists v_ws_bandi_per_procaggiud;
drop view if exists v_ws_bandi_per_comprovareq;
drop view if exists v_ws_bandi_per_offerta;
drop view if exists v_ws_gare_lotti_per_offerta;
drop view if exists v_ws_gare_lotti_inviti;
drop view if exists v_ws_bandi_per_partecipazione;
drop view if exists v_ws_bandi;
drop view if exists v_ws_tipi_impresa;
drop view if exists v_ws_tecnici;
drop view if exists v_ws_fornitori_datiannui;
drop view if exists v_ws_fornitori_tec;
drop view if exists v_ws_fornitori_indirizzi;
drop view if exists v_ws_fornitori_cciaa;
drop view if exists v_ws_fornitori;
drop view if exists v_ws_elenchi_ricisc;
drop view if exists v_ws_invii;
drop view if exists v_ws_comunicazioni_per_sa;
drop view if exists v_ws_comunicazioni_da_sa;
drop view if exists v_ws_comunicazioni_primo_dest;
drop view if exists v_ws_elenchi_cat_iscritte;
drop view if exists v_ws_elenchi_categorie;
drop view if exists v_ws_elenchi_documenti;
drop view if exists v_ws_comunicazioni_documenti;
drop view if exists v_ws_fornitori_catiscrizione;
drop view if exists v_ws_oe_abilitati_rinnovo;
drop view if exists v_ws_oe_abilitati_catalogo;
drop view if exists v_ws_prodotti_allegati;
drop view if exists v_ws_prodotti_in_catalogo;
drop view if exists v_ws_prodotti;
drop view if exists v_ws_schede_tecn_articolo;
drop view if exists v_ws_articoli_catalogo;
drop view if exists v_ws_aggiscr_posticipate;
drop view if exists v_ws_elenchi;
drop view if exists v_ws_elenchi_sa;
drop view if exists v_ws_elenchi_ter;
drop view if exists v_ws_gare_fascicoli;
drop view if exists v_ws_pubbterm;
drop view if exists v_ws_gare_categorie;
drop view if exists v_ws_documenti_digitali;
drop view if exists v_ws_gare_documenti;
drop view if exists v_ws_gare_lotti_pub_ris;
drop view if exists v_ws_gare_lotti_pubbliche;
drop view if exists v_ws_gare_lotti_riservate;
drop view if exists v_ws_gare_lotti_tab;
drop view if exists v_ws_gare_isesito;
drop view if exists v_ws_gare_iselenco;
drop view if exists v_ws_gare_lotti;
drop view if exists v_ws_gare_rettifiche;
drop view if exists v_ws_esiti_pub;
drop view if exists v_ws_bandi_pub_ris;
drop view if exists v_ws_bandi_ris;
drop view if exists v_ws_bandi_pub;
drop view if exists v_ws_pubbli_maxdatpub_pub_ris;
drop view if exists v_ws_pubbli_maxdatpub_ris;
drop view if exists v_ws_pubbli_maxdatpub_pub;
drop view if exists v_ws_stazioni_app;
drop view if exists v_ws_ditg;
drop view if exists v_ws_classif_lavori_elenchi;
drop view if exists v_ws_stati_elenchi;
drop view if exists v_ws_stati_bandi;

--Elimina view per integrazione DL229
drop view if exists qe_229 cascade;
drop view if exists v_prog_loc_a cascade;
drop view if exists v_prog_appa	   cascade;
drop view if exists v_prog_anagsc  cascade;
drop view if exists v_prog_fin	   cascade;
drop view if exists v_prog_impegni cascade;
drop view if exists v_prog_iterpa  cascade;
drop view if exists v_prog_iterpp  cascade;
drop view if exists v_prog_loc	   cascade;
drop view if exists v_prog_pag	   cascade;
drop view if exists v_prog_qe	   cascade;
drop view if exists v_prog_sal	   cascade;
drop view if exists v_prog_sosp	   cascade;
drop view if exists v_prog_anag	   cascade;

delete from eldaver where codapp='v_229';

CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.77' or numver like '1.4.77.%')) THEN
		-- Nuovi campi per la gestione dei tabellati archiviati
		ALTER TABLE TAB0 ADD TAB0ARC VARCHAR(1) NULL;
		ALTER TABLE TAB1 ADD TAB1ARC VARCHAR(1) NULL;
		ALTER TABLE TAB2 ADD TAB2ARC VARCHAR(1) NULL;
		ALTER TABLE TAB3 ADD TAB3ARC VARCHAR(1) NULL;
		ALTER TABLE TAB5 ADD TAB5ARC VARCHAR(1) NULL;
		
		DELETE FROM c0campi where coc_mne_uni like '%.TAB0.GENE';
		DELETE FROM c0campi where coc_mne_uni like '%.TAB1.GENE';
		DELETE FROM c0campi where coc_mne_uni like '%.TAB2.GENE';
		DELETE FROM c0campi where coc_mne_uni like '%.TAB3.GENE';
		DELETE FROM c0campi where coc_mne_uni like '%.TAB4.GENE';
		DELETE FROM c0campi where coc_mne_uni like '%.TAB5.GENE';
		DELETE FROM c0campi where coc_mne_uni like '%.TAB6.GENE';
		
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800113001, 'P', 'P', 'TAB0COD.TAB0.GENE', 'TAB0COD', 'Codice tabellato', 'Codice tabellato', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800113002, 'P', 'P', 'TAB0TIP.TAB0.GENE', 'TAB0TIP', 'Identificativo (alfanumerico)', 'Identificativo', 'A1', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800113003, 'P', NULL, 'TAB0VID.TAB0.GENE', 'TAB0VID', 'Caratteri da mostrare all''utente (tre caratteri)', 'Caratteri', 'A3', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800113004, 'P', NULL, 'TAB0DESC.TAB0.GENE', 'TAB0DESC', 'Descrizione', 'Descrizione', 'A60', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800113005, 'P', NULL, 'TAB0MOD.TAB0.GENE', 'TAB0MOD', 'Dato bloccato in modifica?', 'Bloccato?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800113006, 'P', NULL, 'TAB0NORD.TAB0.GENE', 'TAB0NORD', 'Numero d''ordine', 'Numero d''ordine', 'F8.2', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800113007, 'P', NULL, 'TAB0ARC.TAB0.GENE', 'TAB0ARC', 'Dato archiviato?', 'Archiviato?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800114001, 'P', 'P', 'TAB1COD.TAB1.GENE', 'TAB1COD', 'Codice tabellato', 'Codice tabellato', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800114002, 'P', 'P', 'TAB1TIP.TAB1.GENE', 'TAB1TIP', 'Identificativo (numerico)', 'Identificativo', 'N7', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800114003, 'P', NULL, 'TAB1DESC.TAB1.GENE', 'TAB1DESC', 'Descrizione', 'Descrizione', 'A100', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800114004, 'P', NULL, 'TAB1MOD.TAB1.GENE', 'TAB1MOD', 'Dato bloccato in modifica?', 'Bloccato?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800114005, 'P', NULL, 'TAB1NORD.TAB1.GENE', 'TAB1NORD', 'Numero d''ordine', 'Numero d''ordine', 'F8.2', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800114006, 'P', NULL, 'TAB1ARC.TAB1.GENE', 'TAB1ARC', 'Dato archiviato?', 'Archiviato?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800115001, 'P', 'P', 'TAB2COD.TAB2.GENE', 'TAB2COD', 'Codice tabellato', 'Codice tabellato', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800115002, 'P', 'P', 'TAB2TIP.TAB2.GENE', 'TAB2TIP', 'Identificativo (alfanumerico)', 'Identificativo', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800115003, 'P', NULL, 'TAB2D1.TAB2.GENE', 'TAB2D1', 'Parametro associato', 'Parametro associato', 'A100', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800115004, 'P', NULL, 'TAB2D2.TAB2.GENE', 'TAB2D2', 'Descrizione', 'Descrizione', 'A100', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800115005, 'P', NULL, 'TAB2MOD.TAB2.GENE', 'TAB2MOD', 'Dato bloccato in modifica?', 'Bloccato?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800115006, 'P', NULL, 'TAB2NORD.TAB2.GENE', 'TAB2NORD', 'Numero d''ordine', 'Numero d''ordine', 'F8.2', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800115007, 'P', NULL, 'TAB2ARC.TAB2.GENE', 'TAB2ARC', 'Dato archiviato?', 'Archiviato?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800116001, 'P', 'P', 'TAB3COD.TAB3.GENE', 'TAB3COD', 'Codice tabellato', 'Codice tabellato', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800116002, 'P', 'P', 'TAB3TIP.TAB3.GENE', 'TAB3TIP', 'Identificativo (alfanumerico)', 'Identificativo', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800116003, 'P', NULL, 'TAB3DESC.TAB3.GENE', 'TAB3DESC', 'Descrizione', 'Descrizione', 'A100', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800116004, 'P', NULL, 'TAB3MOD.TAB3.GENE', 'TAB3MOD', 'Dato bloccato in modifica?', 'Bloccato?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800116005, 'P', NULL, 'TAB3NORD.TAB3.GENE', 'TAB3NORD', 'Numero d''ordine', 'Numero d''ordine', 'F8.2', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800116006, 'P', NULL, 'TAB3ARC.TAB3.GENE', 'TAB3ARC', 'Dato archiviato?', 'Archiviato?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800117001, 'P', 'P', 'TAB4COD.TAB4.GENE', 'TAB4COD', 'Schema applicativo', 'Schema applicativo', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800117002, 'P', 'P', 'TAB4TIP.TAB4.GENE', 'TAB4TIP', 'Codice tabellato', 'Codice tabellato', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800117003, 'P', NULL, 'TAB4DESC.TAB4.GENE', 'TAB4DESC', 'Descrizione', 'Descrizione', 'A100', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800118001, 'P', 'P', 'TAB5COD.TAB5.GENE', 'TAB5COD', 'Codice tabellato', 'Codice tabellato', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800118002, 'P', 'P', 'TAB5TIP.TAB5.GENE', 'TAB5TIP', 'Identificativo (alfanumerico)', 'Identificativo', 'A15', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800118003, 'P', NULL, 'TAB5DESC.TAB5.GENE', 'TAB5DESC', 'Descrizione', 'Descrizione', 'A240', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800118004, 'P', NULL, 'TAB5MOD.TAB5.GENE', 'TAB5MOD', 'Dato bloccato in modifica?', 'Bloccato?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800118005, 'P', NULL, 'TAB5NORD.TAB5.GENE', 'TAB5NORD', 'Numero d''ordine', 'Numero d''ordine', 'F8.2', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800118006, 'P', NULL, 'TAB5ARC.TAB5.GENE', 'TAB5ARC', 'Dato archiviato?', 'Archiviato?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800119001, 'P', 'P', 'TAB6COD.TAB6.GENE', 'TAB6COD', 'Schema applicativo', 'Schema applicativo', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800119002, 'P', 'P', 'TAB6TIP.TAB6.GENE', 'TAB6TIP', 'Codice tabellato', 'Codice tabellato', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800119003, 'P', NULL, 'TAB6DESC.TAB6.GENE', 'TAB6DESC', 'Descrizione', 'Descrizione', 'A100', NULL, NULL, NULL);

		create view v_tab4_tab6 as select tab4cod as tab46cod, tab4tip as tab46tip, tab4desc as tab46desc from tab4 union select tab6cod as tab46cod, tab6tip as tab46tip, tab6desc as tab46desc from tab6;
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('V_TAB4_TAB6.GENE', 0, 'P', 'TAB46', 'Tabella elenco dati tabellati', 'TAB46COD.V_TAB4_TAB6.GENE,TAB46TIP.V_TAB4_TAB6.GENE', NULL, NULL, NULL, NULL, 'g_tab46');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'P', 'P', 'TAB46COD.V_TAB4_TAB6.GENE', 'TAB46COD', 'Schema applicativo', 'Schema applicativo', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'P', 'P', 'TAB46TIP.V_TAB4_TAB6.GENE', 'TAB46TIP', 'Codice tabellato', 'Codice tabellato', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'P', NULL, 'TAB46DESC.V_TAB4_TAB6.GENE', 'TAB46DESC', 'Descrizione', 'Descrizione', 'A100', NULL, NULL, NULL);

		-- Gestione valori criptati per W_CONFIG
		ALTER TABLE W_CONFIG ADD CRIPTATO VARCHAR(1) NULL;
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CRIPTATO.W_CONFIG.GENE', 'WCFG_CRIPTATO', 'Valore criptato?', 'Criptato?', 'A2', NULL, 'SN', NULL);

		-- pulizia tabellati 1% non utilizzati
		DELETE FROM tab1 WHERE tab1cod = '1002';
		DELETE FROM tab1 WHERE tab1cod = '1005';
		DELETE FROM tab1 WHERE tab1cod = '1017';
		DELETE FROM tab1 WHERE tab1cod = '1023';
		DELETE FROM tab1 WHERE tab1cod = '1025';
		DELETE FROM tab1 WHERE tab1cod = '1028';
		DELETE FROM tab1 WHERE tab1cod = '1029';
		DELETE FROM tab1 WHERE tab1cod = '10291';
		DELETE FROM tab1 WHERE tab1cod = '10292';
		DELETE FROM tab1 WHERE tab1cod = '10293';
		DELETE FROM tab1 WHERE tab1cod = '10295';
		DELETE FROM tab1 WHERE tab1cod = '10296';
		DELETE FROM tab1 WHERE tab1cod = '1030';
		DELETE FROM tab1 WHERE tab1cod = '1031';
		DELETE FROM tab1 WHERE tab1cod = '1032';
		DELETE FROM tab1 WHERE tab1cod = '1033';
		DELETE FROM tab1 WHERE tab1cod = '1034';
		DELETE FROM tab1 WHERE tab1cod = '1035';
		DELETE FROM tab1 WHERE tab1cod = '1036';
		DELETE FROM tab1 WHERE tab1cod = '1037';
		DELETE FROM tab1 WHERE tab1cod = '1038';
		DELETE FROM tab1 WHERE tab1cod = '1039';
		DELETE FROM tab1 WHERE tab1cod = '1040';
		DELETE FROM tab1 WHERE tab1cod = '1042';
		DELETE FROM tab1 WHERE tab1cod = '1043';
		DELETE FROM tab1 WHERE tab1cod = '1044';
		DELETE FROM tab1 WHERE tab1cod = '1045';
		DELETE FROM tab1 WHERE tab1cod = '1046';
		DELETE FROM tab1 WHERE tab1cod = '10462';
		DELETE FROM tab1 WHERE tab1cod = '10471';
		DELETE FROM tab1 WHERE tab1cod = '10472';
		DELETE FROM tab1 WHERE tab1cod = '10473';
		DELETE FROM tab1 WHERE tab1cod = '10481';
		DELETE FROM tab1 WHERE tab1cod = '10482';
		DELETE FROM tab1 WHERE tab1cod = '10483';
		DELETE FROM tab1 WHERE tab1cod = '10501';
		DELETE FROM tab1 WHERE tab1cod = '10502';
		DELETE FROM tab1 WHERE tab1cod = '10503';
		DELETE FROM tab1 WHERE tab1cod = '10521';
		DELETE FROM tab1 WHERE tab1cod = '10522';
		DELETE FROM tab1 WHERE tab1cod = '10523';
		DELETE FROM tab1 WHERE tab1cod = '1054';
		DELETE FROM tab1 WHERE tab1cod = '10541';
		DELETE FROM tab1 WHERE tab1cod = '10542';
		DELETE FROM tab1 WHERE tab1cod = '10543';
		DELETE FROM tab1 WHERE tab1cod = '10544';
		DELETE FROM tab1 WHERE tab1cod = '1O292';
		
		-- corretto il codice istat di un comune
		update tabsche set tabcod3='003108051' where tabcod='S2003' and  tabcod1='09' and  tabcod2='2023' and  tabdesc='BUSNAGO';

		update eldaver set numver = '1.4.78', datvet = now() where codapp = 'G_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.78' or numver like '1.4.78.%')) THEN
		-- revisione scadenzario
		ALTER TABLE g_scadenz ADD stpromem NUMERIC(7);
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.78' or numver like '1.4.78.%')) THEN
		-- Nuovi campi per la gestione dei tabellati archiviati
		ALTER TABLE c0oggass ADD c0anatto VARCHAR(20);
		ALTER TABLE c0oggass ADD c0adatto TIMESTAMP;
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800127026, 'E', NULL, 'C0ANATTO.C0OGGASS.GENE', 'C0A_NATTO', 'Numero atto del file associato', 'Numero atto', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800127027, 'E', NULL, 'C0ADATTO.C0OGGASS.GENE', 'C0A_DATTO', 'Data atto del file associato', 'Data atto', 'A10', NULL, 'DATA_ELDA', NULL);

		-- revisione scadenzario
		delete from c0campi where c0c_mne_ber = 'G_SCADTIT';
		delete from c0campi where c0c_mne_ber = 'G_SCADTIPOEV';
		delete from c0campi where c0c_mne_ber = 'G_SCADTIPOFI';
		delete from c0campi where c0c_mne_ber = 'G_SCADIDATTIV';
		delete from c0campi where c0c_mne_ber = 'G_SCADDATAFI';
		delete from c0campi where c0c_mne_ber = 'G_SCADDOPO';
		delete from c0campi where c0c_mne_ber = 'G_SCADDATASCAD';
		delete from c0campi where c0c_mne_ber = 'G_SCADDATACONS';
		
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (880038297, 'E', NULL, 'TIT.G_SCADENZ.GENE', 'G_SCADTIT', 'Titolo attivita''', 'Titolo', 'A400', NULL, NULL, 'Titolo');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (880038299, 'E', NULL, 'TIPOEV.G_SCADENZ.GENE', 'G_SCADTIPOEV', 'Tipo evento', 'Tipo evento', 'A100', 'G_050', NULL, 'Tipo');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (880038304, 'E', NULL, 'TIPOFI.G_SCADENZ.GENE', 'G_SCADTIPOFI', 'Tipo termine', 'Tipo termine', 'A100', 'G_052', NULL, 'Modalita'' definizione data scadenza prevista');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (880038306, 'E', NULL, 'IDATTIV.G_SCADENZ.GENE', 'G_SCADIDATTIV', 'Attivita'' di riferimento', 'Att. riferimento', 'N12', NULL, NULL, 'Attivita'' di riferimento');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (880038307, 'E', NULL, 'DATAFI.G_SCADENZ.GENE', 'G_SCADDATAFI', 'Data scadenza prevista', 'Data scadenza prev.', 'A10', NULL, 'DATA_ELDA', 'Data scadenza prevista');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (880038305, 'E', NULL, 'FINEDOPO.G_SCADENZ.GENE', 'G_SCADDOPO', 'N. giorni (+/-)', 'N. giorni (+/-)', 'N3', NULL, NULL, 'Numero giorni (+/-) rispetto alla data di scadenza dell''attivita'' di riferimento');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (880038311, 'E', NULL, 'DATASCAD.G_SCADENZ.GENE', 'G_SCADDATASCAD', 'Data scadenza aggiornata', 'Data scad. agg.', 'A10', NULL, 'DATA_ELDA', 'Data scadenza aggiornata');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (880038310, 'E', NULL, 'DATACONS.G_SCADENZ.GENE', 'G_SCADDATACONS', 'Data scadenza effettiva', 'Data scad. eff.', 'A10', NULL, 'DATA_ELDA', 'Data scadenza effettiva');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'STPROMEM.G_SCADENZ.GENE', 'G_STPROMEM', 'Promemoria inviato ?', 'Prom. inv.?', 'N7', NULL, NULL, NULL);
		
		update tab1 set tab1desc = 'Inserimento manuale della data di scadenza' where tab1cod = 'G_052' and tab1tip = 1;
		update tab1 set tab1desc = 'Data di scadenza calcolata in relazione ad altra attività' where tab1cod = 'G_052' and tab1tip = 2;
		
		update g_scadenz set stpromem = 1 where datascad < (now() + interval '1' day * ggpromem);
		
		update eldaver set numver = '1.4.79', datvet = now() where codapp = 'G_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.79' or numver like '1.4.79.%')) THEN
		
		update eldaver set numver = '1.4.80', datvet = now() where codapp = 'G_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.80' or numver like '1.4.80.%')) THEN
	-- Nuovo attributo per la gestione dei permessi in dl229
		IF not exists (SELECT column_name FROM information_schema.columns WHERE table_name='g_permessi' and column_name='idcup') THEN
			ALTER TABLE G_PERMESSI ADD IDCUP NUMERIC(12) NULL;
			Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) 
				Values(880038137, 'E', NULL, 'IDCUP.G_PERMESSI.GENE', 'G_IDCUP', 'Id cup', 'Id cup', 'N12', NULL, NULL, NULL);
			INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re)
				Values ('G_PERMESSI.GENE#3', 6800111, 'C', NULL, 'Configurazione condivisione e protezioni del cup', 'IDCUP.G_PERMESSI.GENE', 'PROG_ANAG.DL229', 'ID.PROG_ANAG.DL229', NULL, NULL, 'g_perm0');	
		end if;
		
        --Aggiornamento C0ENTIT - nuove relazioni per UFFINT (S.Santi 19.04.2017)
		delete from c0entit where c0e_nom in ('UFFINT.GENE#4','UFFINT.GENE#5');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('UFFINT.GENE#4',0,'C',NULL,NULL,'CODEIN.UFFINT.GENE','GARALTSOG.GARE','CENINT.GARALTSOG.GARE',NULL,NULL,'g_10uffi');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('UFFINT.GENE#5',0,'C',NULL,NULL,'CODEIN.UFFINT.GENE','ISCRIZUFF.GARE','CENINT.ISCRIZUFF.GARE',NULL,NULL,'g_10uffi');
			
		-- Aggiornamento codici ISTAT
		Update tabsche set tabcod3='001096085' where tabcod='S2003' and tabcod1='09' and tabcod3='001096029';
		Update tabsche set tabcod3='001096086' where tabcod='S2003' and tabcod1='09' and tabcod3='001096011';
		Update tabsche set tabcod3='003013250' where tabcod='S2003' and tabcod1='09' and tabcod3='003013019';
		Update tabsche set tabcod3='003108052' where tabcod='S2003' and tabcod1='09' and tabcod3='003108047';
		Update tabsche set tabcod3='003108053' where tabcod='S2003' and tabcod1='09' and tabcod3='003108088';
		Update tabsche set tabcod3='003108054' where tabcod='S2003' and tabcod1='09' and tabcod3='003108119';
		Update tabsche set tabcod3='003108055' where tabcod='S2003' and tabcod1='09' and tabcod3='003108186';
		Update tabsche set tabcod3='005025071' where tabcod='S2003' and tabcod1='09' and tabcod3='005025031';
		Update tabsche set tabcod3='008099021' where tabcod='S2003' and tabcod1='09' and tabcod3='011041011';
		Update tabsche set tabcod3='008099022' where tabcod='S2003' and tabcod1='09' and tabcod3='011041024';
		Update tabsche set tabcod3='008099023' where tabcod='S2003' and tabcod1='09' and tabcod3='011041039';
		Update tabsche set tabcod3='008099024' where tabcod='S2003' and tabcod1='09' and tabcod3='011041042';
		Update tabsche set tabcod3='008099025' where tabcod='S2003' and tabcod1='09' and tabcod3='011041053';
		Update tabsche set tabcod3='008099026' where tabcod='S2003' and tabcod1='09' and tabcod3='011041055';
		Update tabsche set tabcod3='008099027' where tabcod='S2003' and tabcod1='09' and tabcod3='011041063';
		Update tabsche set tabcod3='009052037' where tabcod='S2003' and tabcod1='09' and tabcod3='009052014';
		Update tabsche set tabcod3='020090001' where tabcod='S2003' and tabcod1='09' and tabcod3='020104001';
		Update tabsche set tabcod3='020090002' where tabcod='S2003' and tabcod1='09' and tabcod3='020104003';
		Update tabsche set tabcod3='020090006' where tabcod='S2003' and tabcod1='09' and tabcod3='020104004';
		Update tabsche set tabcod3='020090009' where tabcod='S2003' and tabcod1='09' and tabcod3='020104006';
		Update tabsche set tabcod3='020090014' where tabcod='S2003' and tabcod1='09' and tabcod3='020104007';
		Update tabsche set tabcod3='020090017' where tabcod='S2003' and tabcod1='09' and tabcod3='020104008';
		Update tabsche set tabcod3='020090021' where tabcod='S2003' and tabcod1='09' and tabcod3='020104010';
		Update tabsche set tabcod3='020090035' where tabcod='S2003' and tabcod1='09' and tabcod3='020104012';
		Update tabsche set tabcod3='020090036' where tabcod='S2003' and tabcod1='09' and tabcod3='020104014';
		Update tabsche set tabcod3='020090037' where tabcod='S2003' and tabcod1='09' and tabcod3='020104015';
		Update tabsche set tabcod3='020090041' where tabcod='S2003' and tabcod1='09' and tabcod3='020104016';
		Update tabsche set tabcod3='020090047' where tabcod='S2003' and tabcod1='09' and tabcod3='020104017';
		Update tabsche set tabcod3='020090049' where tabcod='S2003' and tabcod1='09' and tabcod3='020104018';
		Update tabsche set tabcod3='020090054' where tabcod='S2003' and tabcod1='09' and tabcod3='020104020';
		Update tabsche set tabcod3='020090062' where tabcod='S2003' and tabcod1='09' and tabcod3='020104002';
		Update tabsche set tabcod3='020090063' where tabcod='S2003' and tabcod1='09' and tabcod3='020104022';
		Update tabsche set tabcod3='020090070' where tabcod='S2003' and tabcod1='09' and tabcod3='020104025';
		Update tabsche set tabcod3='020090074' where tabcod='S2003' and tabcod1='09' and tabcod3='020104026';
		Update tabsche set tabcod3='020090080' where tabcod='S2003' and tabcod1='09' and tabcod3='020104024';
		Update tabsche set tabcod3='020090081' where tabcod='S2003' and tabcod1='09' and tabcod3='020104005';
		Update tabsche set tabcod3='020090083' where tabcod='S2003' and tabcod1='09' and tabcod3='020104011';
		Update tabsche set tabcod3='020090084' where tabcod='S2003' and tabcod1='09' and tabcod3='020104013';
		Update tabsche set tabcod3='020090085' where tabcod='S2003' and tabcod1='09' and tabcod3='020104021';
		Update tabsche set tabcod3='020090090' where tabcod='S2003' and tabcod1='09' and tabcod3='020104019';
		Update tabsche set tabcod3='020090091' where tabcod='S2003' and tabcod1='09' and tabcod3='020104009';
		Update tabsche set tabcod3='020090092' where tabcod='S2003' and tabcod1='09' and tabcod3='020104023';
		Update tabsche set tabcod3='020091002' where tabcod='S2003' and tabcod1='09' and tabcod3='020105001';
		Update tabsche set tabcod3='020091005' where tabcod='S2003' and tabcod1='09' and tabcod3='020105002';
		Update tabsche set tabcod3='020091006' where tabcod='S2003' and tabcod1='09' and tabcod3='020105003';
		Update tabsche set tabcod3='020091019' where tabcod='S2003' and tabcod1='09' and tabcod3='020105005';
		Update tabsche set tabcod3='020091026' where tabcod='S2003' and tabcod1='09' and tabcod3='020105006';
		Update tabsche set tabcod3='020091031' where tabcod='S2003' and tabcod1='09' and tabcod3='020105007';
		Update tabsche set tabcod3='020091032' where tabcod='S2003' and tabcod1='09' and tabcod3='020105008';
		Update tabsche set tabcod3='020091035' where tabcod='S2003' and tabcod1='09' and tabcod3='020105009';
		Update tabsche set tabcod3='020091037' where tabcod='S2003' and tabcod1='09' and tabcod3='020105010';
		Update tabsche set tabcod3='020091039' where tabcod='S2003' and tabcod1='09' and tabcod3='020105011';
		Update tabsche set tabcod3='020091042' where tabcod='S2003' and tabcod1='09' and tabcod3='020105012';
		Update tabsche set tabcod3='020091069' where tabcod='S2003' and tabcod1='09' and tabcod3='020105013';
		Update tabsche set tabcod3='020091072' where tabcod='S2003' and tabcod1='09' and tabcod3='020105014';
		Update tabsche set tabcod3='020091088' where tabcod='S2003' and tabcod1='09' and tabcod3='020105016';
		Update tabsche set tabcod3='020091089' where tabcod='S2003' and tabcod1='09' and tabcod3='020105017';
		Update tabsche set tabcod3='020091095' where tabcod='S2003' and tabcod1='09' and tabcod3='020105018';
		Update tabsche set tabcod3='020091097' where tabcod='S2003' and tabcod1='09' and tabcod3='020105019';
		Update tabsche set tabcod3='020091098' where tabcod='S2003' and tabcod1='09' and tabcod3='020105020';
		Update tabsche set tabcod3='020091099' where tabcod='S2003' and tabcod1='09' and tabcod3='020105021';
		Update tabsche set tabcod3='020091100' where tabcod='S2003' and tabcod1='09' and tabcod3='020105022';
		Update tabsche set tabcod3='020091101' where tabcod='S2003' and tabcod1='09' and tabcod3='020105023';
		Update tabsche set tabcod3='020091103' where tabcod='S2003' and tabcod1='09' and tabcod3='020105004';
		Update tabsche set tabcod3='020111001' where tabcod='S2003' and tabcod1='09' and tabcod3='020106001';
		Update tabsche set tabcod3='020111002' where tabcod='S2003' and tabcod1='09' and tabcod3='020092002';
		Update tabsche set tabcod3='020111003' where tabcod='S2003' and tabcod1='09' and tabcod3='020092004';
		Update tabsche set tabcod3='020111004' where tabcod='S2003' and tabcod1='09' and tabcod3='020092005';
		Update tabsche set tabcod3='020111005' where tabcod='S2003' and tabcod1='09' and tabcod3='020106002';
		Update tabsche set tabcod3='020111006' where tabcod='S2003' and tabcod1='09' and tabcod3='020107001';
		Update tabsche set tabcod3='020111007' where tabcod='S2003' and tabcod1='09' and tabcod3='020092008';
		Update tabsche set tabcod3='020111008' where tabcod='S2003' and tabcod1='09' and tabcod3='020107002';
		Update tabsche set tabcod3='020111009' where tabcod='S2003' and tabcod1='09' and tabcod3='020107003';
		Update tabsche set tabcod3='020111010' where tabcod='S2003' and tabcod1='09' and tabcod3='020107004';
		Update tabsche set tabcod3='020111011' where tabcod='S2003' and tabcod1='09' and tabcod3='020092106';
		Update tabsche set tabcod3='020111012' where tabcod='S2003' and tabcod1='09' and tabcod3='020106003';
		Update tabsche set tabcod3='020111013' where tabcod='S2003' and tabcod1='09' and tabcod3='020092016';
		Update tabsche set tabcod3='020111014' where tabcod='S2003' and tabcod1='09' and tabcod3='020092017';
		Update tabsche set tabcod3='020111015' where tabcod='S2003' and tabcod1='09' and tabcod3='020092018';
		Update tabsche set tabcod3='020111016' where tabcod='S2003' and tabcod1='09' and tabcod3='020107005';
		Update tabsche set tabcod3='020111017' where tabcod='S2003' and tabcod1='09' and tabcod3='020092020';
		Update tabsche set tabcod3='020111018' where tabcod='S2003' and tabcod1='09' and tabcod3='020092110';
		Update tabsche set tabcod3='020111019' where tabcod='S2003' and tabcod1='09' and tabcod3='020092111';
		Update tabsche set tabcod3='020111020' where tabcod='S2003' and tabcod1='09' and tabcod3='020092112';
		Update tabsche set tabcod3='020111021' where tabcod='S2003' and tabcod1='09' and tabcod3='020107006';
		Update tabsche set tabcod3='020111022' where tabcod='S2003' and tabcod1='09' and tabcod3='020106004';
		Update tabsche set tabcod3='020111023' where tabcod='S2003' and tabcod1='09' and tabcod3='020095081';
		Update tabsche set tabcod3='020111024' where tabcod='S2003' and tabcod1='09' and tabcod3='020106005';
		Update tabsche set tabcod3='020111025' where tabcod='S2003' and tabcod1='09' and tabcod3='020092113';
		Update tabsche set tabcod3='020111026' where tabcod='S2003' and tabcod1='09' and tabcod3='020092024';
		Update tabsche set tabcod3='020111027' where tabcod='S2003' and tabcod1='09' and tabcod3='020106006';
		Update tabsche set tabcod3='020111028' where tabcod='S2003' and tabcod1='09' and tabcod3='020107007';
		Update tabsche set tabcod3='020111029' where tabcod='S2003' and tabcod1='09' and tabcod3='020092027';
		Update tabsche set tabcod3='020111030' where tabcod='S2003' and tabcod1='09' and tabcod3='020107008';
		Update tabsche set tabcod3='020111031' where tabcod='S2003' and tabcod1='09' and tabcod3='020106007';
		Update tabsche set tabcod3='020111032' where tabcod='S2003' and tabcod1='09' and tabcod3='020092030';
		Update tabsche set tabcod3='020111033' where tabcod='S2003' and tabcod1='09' and tabcod3='020092031';
		Update tabsche set tabcod3='020111034' where tabcod='S2003' and tabcod1='09' and tabcod3='020106008';
		Update tabsche set tabcod3='020111035' where tabcod='S2003' and tabcod1='09' and tabcod3='020107009';
		Update tabsche set tabcod3='020111036' where tabcod='S2003' and tabcod1='09' and tabcod3='020092114';
		Update tabsche set tabcod3='020111037' where tabcod='S2003' and tabcod1='09' and tabcod3='020106009';
		Update tabsche set tabcod3='020111038' where tabcod='S2003' and tabcod1='09' and tabcod3='020106010';
		Update tabsche set tabcod3='020111039' where tabcod='S2003' and tabcod1='09' and tabcod3='020092036';
		Update tabsche set tabcod3='020111040' where tabcod='S2003' and tabcod1='09' and tabcod3='020107010';
		Update tabsche set tabcod3='020111041' where tabcod='S2003' and tabcod1='09' and tabcod3='020092038';
		Update tabsche set tabcod3='020111042' where tabcod='S2003' and tabcod1='09' and tabcod3='020092039';
		Update tabsche set tabcod3='020111043' where tabcod='S2003' and tabcod1='09' and tabcod3='020107011';
		Update tabsche set tabcod3='020111044' where tabcod='S2003' and tabcod1='09' and tabcod3='020107012';
		Update tabsche set tabcod3='020111045' where tabcod='S2003' and tabcod1='09' and tabcod3='020092115';
		Update tabsche set tabcod3='020111046' where tabcod='S2003' and tabcod1='09' and tabcod3='020092116';
		Update tabsche set tabcod3='020111047' where tabcod='S2003' and tabcod1='09' and tabcod3='020092042';
		Update tabsche set tabcod3='020111048' where tabcod='S2003' and tabcod1='09' and tabcod3='020092117';
		Update tabsche set tabcod3='020111049' where tabcod='S2003' and tabcod1='09' and tabcod3='020107013';
		Update tabsche set tabcod3='020111050' where tabcod='S2003' and tabcod1='09' and tabcod3='020092118';
		Update tabsche set tabcod3='020111051' where tabcod='S2003' and tabcod1='09' and tabcod3='020092044';
		Update tabsche set tabcod3='020111052' where tabcod='S2003' and tabcod1='09' and tabcod3='020106011';
		Update tabsche set tabcod3='020111053' where tabcod='S2003' and tabcod1='09' and tabcod3='020106012';
		Update tabsche set tabcod3='020111054' where tabcod='S2003' and tabcod1='09' and tabcod3='020107014';
		Update tabsche set tabcod3='020111055' where tabcod='S2003' and tabcod1='09' and tabcod3='020092048';
		Update tabsche set tabcod3='020111056' where tabcod='S2003' and tabcod1='09' and tabcod3='020107015';
		Update tabsche set tabcod3='020111057' where tabcod='S2003' and tabcod1='09' and tabcod3='020107016';
		Update tabsche set tabcod3='020111058' where tabcod='S2003' and tabcod1='09' and tabcod3='020092119';
		Update tabsche set tabcod3='020111059' where tabcod='S2003' and tabcod1='09' and tabcod3='020106013';
		Update tabsche set tabcod3='020111060' where tabcod='S2003' and tabcod1='09' and tabcod3='020092053';
		Update tabsche set tabcod3='020111061' where tabcod='S2003' and tabcod1='09' and tabcod3='020092054';
		Update tabsche set tabcod3='020111062' where tabcod='S2003' and tabcod1='09' and tabcod3='020106014';
		Update tabsche set tabcod3='020111063' where tabcod='S2003' and tabcod1='09' and tabcod3='020107017';
		Update tabsche set tabcod3='020111064' where tabcod='S2003' and tabcod1='09' and tabcod3='020092058';
		Update tabsche set tabcod3='020111065' where tabcod='S2003' and tabcod1='09' and tabcod3='020092059';
		Update tabsche set tabcod3='020111066' where tabcod='S2003' and tabcod1='09' and tabcod3='020092064';
		Update tabsche set tabcod3='020111067' where tabcod='S2003' and tabcod1='09' and tabcod3='020106015';
		Update tabsche set tabcod3='020111068' where tabcod='S2003' and tabcod1='09' and tabcod3='020107018';
		Update tabsche set tabcod3='020111069' where tabcod='S2003' and tabcod1='09' and tabcod3='020092061';
		Update tabsche set tabcod3='020111070' where tabcod='S2003' and tabcod1='09' and tabcod3='020107019';
		Update tabsche set tabcod3='020111071' where tabcod='S2003' and tabcod1='09' and tabcod3='020107020';
		Update tabsche set tabcod3='020111072' where tabcod='S2003' and tabcod1='09' and tabcod3='020106016';
		Update tabsche set tabcod3='020111073' where tabcod='S2003' and tabcod1='09' and tabcod3='020106017';
		Update tabsche set tabcod3='020111074' where tabcod='S2003' and tabcod1='09' and tabcod3='020092069';
		Update tabsche set tabcod3='020111075' where tabcod='S2003' and tabcod1='09' and tabcod3='020092070';
		Update tabsche set tabcod3='020111076' where tabcod='S2003' and tabcod1='09' and tabcod3='020092071';
		Update tabsche set tabcod3='020111077' where tabcod='S2003' and tabcod1='09' and tabcod3='020106018';
		Update tabsche set tabcod3='020111078' where tabcod='S2003' and tabcod1='09' and tabcod3='020106019';
		Update tabsche set tabcod3='020111079' where tabcod='S2003' and tabcod1='09' and tabcod3='020092120';
		Update tabsche set tabcod3='020111080' where tabcod='S2003' and tabcod1='09' and tabcod3='020106020';
		Update tabsche set tabcod3='020111081' where tabcod='S2003' and tabcod1='09' and tabcod3='020105015';
		Update tabsche set tabcod3='020111082' where tabcod='S2003' and tabcod1='09' and tabcod3='020092121';
		Update tabsche set tabcod3='020111083' where tabcod='S2003' and tabcod1='09' and tabcod3='020106021';
		Update tabsche set tabcod3='020111084' where tabcod='S2003' and tabcod1='09' and tabcod3='020092078';
		Update tabsche set tabcod3='020111085' where tabcod='S2003' and tabcod1='09' and tabcod3='020092079';
		Update tabsche set tabcod3='020111086' where tabcod='S2003' and tabcod1='09' and tabcod3='020092081';
		Update tabsche set tabcod3='020111087' where tabcod='S2003' and tabcod1='09' and tabcod3='020092082';
		Update tabsche set tabcod3='020111088' where tabcod='S2003' and tabcod1='09' and tabcod3='020092083';
		Update tabsche set tabcod3='020111089' where tabcod='S2003' and tabcod1='09' and tabcod3='020092084';
		Update tabsche set tabcod3='020111090' where tabcod='S2003' and tabcod1='09' and tabcod3='020107021';
		Update tabsche set tabcod3='020111091' where tabcod='S2003' and tabcod1='09' and tabcod3='020106022';
		Update tabsche set tabcod3='020111092' where tabcod='S2003' and tabcod1='09' and tabcod3='020106023';
		Update tabsche set tabcod3='020111093' where tabcod='S2003' and tabcod1='09' and tabcod3='020092088';
		Update tabsche set tabcod3='020111094' where tabcod='S2003' and tabcod1='09' and tabcod3='020106024';
		Update tabsche set tabcod3='020111095' where tabcod='S2003' and tabcod1='09' and tabcod3='020092091';
		Update tabsche set tabcod3='020111096' where tabcod='S2003' and tabcod1='09' and tabcod3='020106025';
		Update tabsche set tabcod3='020111097' where tabcod='S2003' and tabcod1='09' and tabcod3='020106026';
		Update tabsche set tabcod3='020111098' where tabcod='S2003' and tabcod1='09' and tabcod3='020107022';
		Update tabsche set tabcod3='020111099' where tabcod='S2003' and tabcod1='09' and tabcod3='020092122';
		Update tabsche set tabcod3='020111100' where tabcod='S2003' and tabcod1='09' and tabcod3='020106027';
		Update tabsche set tabcod3='020111101' where tabcod='S2003' and tabcod1='09' and tabcod3='020106028';
		Update tabsche set tabcod3='020111102' where tabcod='S2003' and tabcod1='09' and tabcod3='020107023';
		Update tabsche set tabcod3='020111103' where tabcod='S2003' and tabcod1='09' and tabcod3='020092097';
		Update tabsche set tabcod3='020111104' where tabcod='S2003' and tabcod1='09' and tabcod3='020092098';
		Update tabsche set tabcod3='020111105' where tabcod='S2003' and tabcod1='09' and tabcod3='020092100';
		Update tabsche set tabcod3='020111106' where tabcod='S2003' and tabcod1='09' and tabcod3='020092101';
		Update tabsche set tabcod3='020111107' where tabcod='S2003' and tabcod1='09' and tabcod3='020092102';

		-- Nuovi comuni
		Delete from tabsche where tabcod='S2003' and tabcod1='09' and tabcod3 in 
			( '009047023', '005025072', '003013253', '004022235', '008037062', '004022236', '004022237', '004022238', '004022239', '003020071', '001103078', '009050040', '004022240', '009051040', 
			  '004022241', '011041069', '003013251', '004022228', '004022242', '003018191', '003018192', '009050041', '004022233', '009046036', '009048052', '008038027', '012058122', '006030042',
			  '003013249', '004022229', '003012142', '004022243', '008099029', '015064121', '004022234', '008099028', '008034050', '004022244', '009051041', '004022230', '004022245', '005025070', 
			  '006030188', '004022231', '009047024', '003016252', '009048053', '004022246', '009046037', '008034049', '008038028', '011041070', '004022247', '011042050', '003013252', '003016253', 
			  '005025073', '004022232', '011043058', '011041068', '004022248', '008037061', '006093053', '008035046', '003097091', '004022249');

		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8555', 'ABETONE CUTIGLIANO', '009047023', '51021', 'A275');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8556', 'ALPAGO', '005025072', '32016', 'G262');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8557', 'ALTA VALLE INTELVI', '003013253', '22024', 'G396');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8558', 'ALTAVALLE', '004022235', '38092', 'G462');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8559', 'ALTO RENO TERME', '008037062', '40046', 'G777');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8560', 'ALTOPIANO DELLA VIGOLANA', '004022236', '38049', 'G973');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8561', 'AMBLAR-DON', '004022237', '38011', 'H340');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8562', 'BORGO CHIESE', '004022238', '38083', 'D802');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8563', 'BORGO LARES', '004022239', '38079', 'E295');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8564', 'BORGO VIRGILIO', '003020071', '46034', 'F390');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8565', 'BORGOMEZZAVALLE', '001103078', '28846', 'G358');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8566', 'CASCIANA TERME LARI', '009050040', '56035', 'F828');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8567', 'CASTEL IVANO', '004022240', '38059', 'F070');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8568', 'CASTELFRANCO PIANDISCO''', '009051040', '52026', 'A413');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8569', 'CEMBRA LISIGNAGO', '004022241', '38034', 'E751');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8570', 'COLLI AL METAURO', '011041069', '61036', 'A690');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8571', 'COLVERDE', '003013251', '22041', 'B945');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8572', 'COMANO TERME', '004022228', '38077', 'C053');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8573', 'CONTA''', '004022242', '38093', 'E310');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8574', 'CORNALE E BASTIDA', '003018191', '27056', 'G851');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8575', 'CORTEOLONA E GENZONE', '003018192', '27014', 'I968');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8576', 'CRESPINA LORENZANA', '009050041', '56042', 'B129');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8577', 'DIMARO FOLGARIDA', '004022233', '38025', 'C118');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8578', 'FABBRICHE DI VERGEMOLI', '009046036', '55021', 'F265');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8579', 'FIGLINE E INCISA VALDARNO', '009048052', '50063', 'A376');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8580', 'FISCAGLIA', '008038027', '44027', 'E786');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8581', 'FONTE NUOVA', '012058122', '00013', 'D222');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8582', 'FORNI DI SOTTO', '006030042', '33020', 'G083');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8583', 'GRAVEDONA ED UNITI', '003013249', '22015', 'A954');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8584', 'LEDRO', '004022229', '38067', 'D578');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8585', 'MACCAGNO CON PINO E VEDDASCA', '003012142', '21061', 'B259');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8586', 'MADRUZZO', '004022243', '38076', 'D316');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8587', 'MONTESCUDO - MONTE COLOMBO', '008099029', '47854', 'G768');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8588', 'MONTORO', '015064121', '83025', 'D899');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8589', 'PIEVE DI BONO-PREZZO', '004022234', '38085', 'G232');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8590', 'POGGIO TORRIANA', '008099028', '47824', 'G704');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8591', 'POLESINE ZIBELLO', '008034050', '43016', 'H658');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8592', 'PORTE DI RENDENA', '004022244', '38094', 'D682');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8593', 'PRATOVECCHIO STIA', '009051041', '52015', 'C766');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8594', 'PREDAIA', '004022230', '38012', 'C866');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8595', 'PRIMIERO SAN MARTINO DI CASTROZZA', '004022245', '38054', 'G524');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8596', 'QUERO VAS', '005025070', '32038', 'A885');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8597', 'RIVIGNANO TEOR', '006030188', '33061', 'H495');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8598', 'SAN LORENZO DORSINO', '004022231', '38078', 'F397');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8599', 'SAN MARCELLO PITEGLIO', '009047024', '51028', 'F988');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8600', 'SANT''OMOBONO TERME', '003016252', '24038', 'F587');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8601', 'SCARPERIA E SAN PIERO', '009048053', '50038', 'H047');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8602', 'SELLA GIUDICARIE', '004022246', '38087', 'A482');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8603', 'SILLANO GIUNCUGNANO', '009046037', '55039', 'A053');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8604', 'SISSA TRECASALI', '008034049', '43018', 'B813');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8605', 'TERRE DEL RENO', '008038028', '44047', 'I537');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8606', 'TERRE ROVERESCHE', '011041070', '61038', 'I600');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8607', 'TRE VILLE', '004022247', '38095', 'H428');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8608', 'TRECASTELLI', '011042050', '60012', 'I188');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8609', 'TREMEZZINA', '003013252', '22016', 'L837');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8610', 'VAL BREMBILLA', '003016253', '24012', 'H159');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8611', 'VAL DI ZOLDO', '005025073', '32012', 'H743');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8612', 'VALDAONE', '004022232', '38091', 'I723');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8613', 'VALFORNACE', '011043058', '62035', 'I824');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8614', 'VALLEFOGLIA', '011041068', '61022', 'A766');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8615', 'VALLELAGHI', '004022248', '38096', 'A841');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8616', 'VALSAMOGGIA', '008037061', '40053', 'G597');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8617', 'VALVASONE ARZENE', '006093053', '33098', 'I202');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8618', 'VENTASSO', '008035046', '42032', 'B265');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8619', 'VERDERIO', '003097091', '23879', 'E425');
		Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) values ('S2003', '09', '8620', 'VILLE D''ANAUNIA', '004022249', '38019', 'L991');

		update eldaver set numver = '1.4.81', datvet = now() where codapp = 'G_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.81' or numver like '1.4.81.%')) THEN
		--Definizione nuovi campi
		-- Nuovo campo 'Numero d'ordine' per ordinamento Configurazione codifica automatica
		ALTER TABLE G_CONFCOD ADD NUMORD NUMERIC(3);
		
		CREATE TABLE UFFSET (
		ID NUMERIC(10) NOT NULL,
		CODEIN VARCHAR(16) NOT NULL,
		NOMSET NUMERIC(7) null,
		DATFIN TIMESTAMP null,
		primary key (ID));
		
		ALTER TABLE UFFSET ADD CONSTRAINT FK_UFFSET_UFFINT FOREIGN KEY ( CODEIN ) REFERENCES UFFINT( CODEIN ) ON DELETE CASCADE;
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.81' or numver like '1.4.81.%')) THEN
		
		-- Inizializzazione nuovo campo 'Numero d'ordine' per ordinamento Configurazione codifica automatica
		Update g_confcod set numord=1 where noment='TECNI' and nomcam='CODTEC' and tipcam=-1;
		Update g_confcod set numord=2 where noment='IMPR' and nomcam='CODIMP' and tipcam=-1;
		Update g_confcod set numord=3 where noment='TEIM' and nomcam='CODTIM' and tipcam=-1;
		Update g_confcod set numord=4 where noment='UFFINT' and nomcam='CODEIN' and tipcam=-1;
		Update g_confcod set numord=5 where noment='UTENT' and nomcam='CODUTE' and tipcam=-1;
		
		if (select count(*) = 0 from tab1 where tab1cod = 'A1092' ) then
		  INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1092',1,'Servizio edilizia',NULL,0,NULL);
		  INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1092',2,'Servizio viabilità',NULL,0,NULL);
		  INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1092',3,'Servizio ambiente',NULL,0,NULL);
		end if;
		if (select count(*) = 0 from tab6 where tab6tip='A1092') then
			INSERT INTO TAB6 (TAB6COD,TAB6TIP,TAB6DESC) VALUES ('G__1','A1092','Ufficio della stazione appaltante');
		else 
			UPDATE TAB6 SET TAB6COD='G__1' where tab6cod='G1_1' and tab6tip='A1092';
		end if;

		--Aggiornamento C0CAMPI
	    delete from c0campi where c0c_mne_ber in ('G_NUMORDCC','G_IDUFFSET','G_CODEINSE','G_NOMSET','G_DATFINSE');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMORD.G_CONFCOD.GENE', 'G_NUMORDCC', 'Numero d''ordine', 'Numero d''ordine', 'N3', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.UFFSET.GENE','G_IDUFFSET','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODEIN.UFFSET.GENE','G_CODEINSE','Codice dell''ufficio intestatario','Codice uff.intestat.','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NOMSET.UFFSET.GENE','G_NOMSET','Denominazione del settore','Denominaz.settore','A100','A1092',NULL,'Denominazione');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATFIN.UFFSET.GENE','G_DATFINSE','Data disattivazione del settore','Data disattivazione','A10',NULL,'DATA_ELDA',NULL);

		UPDATE C0CAMPI SET C0C_TIP='E' WHERE  C0C_MNE_BER in ('G_NOMENT1','G_NOMCAM1','G_TIPCAM1','G_CODAPP','G_DESCAM','G_CONTAT','G_CODCAL');		
		UPDATE C0CAMPI SET COC_DES='Descrizione oggetto della codifica',COC_DES_FRM='Oggetto codifica',COC_DES_WEB='Oggetto della codifica' WHERE  C0C_MNE_BER = 'G_DESCAM';
		UPDATE C0CAMPI SET COC_DES_FRM='Contatore' WHERE  C0C_MNE_BER = 'G_CONTAT';
		UPDATE C0CAMPI SET COC_DES_FRM='Criterio di calcolo' WHERE  C0C_MNE_BER = 'G_CODCAL';
		
		--Aggiornamento C0ENTIT
		delete from c0entit where c0e_nom in ('UFFSET.GENE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('UFFSET.GENE',0,'E','ARC_UF_SET','Settori dell''ufficio intestatario','CODEIN.UFFSET.GENE','UFFINT.GENE','CODEIN.UFFINT.GENE',NULL,NULL,'g_setuf0');

		UPDATE C0ENTIT SET C0E_TIP='E' WHERE C0E_NOM='G_CONFCOD.GENE';
		
		-- Tabella GENE.G_DURC - Aumento dimensione campi a 20 caratteri
		perform sp_backupanddropviews('g_durc');
		ALTER TABLE g_durc ALTER COLUMN protocol type varchar(20);
		perform sp_restoreviews('g_durc');
		update c0campi set c0c_fs = 'A20' where coc_mne_uni = 'PROTOCOL.G_DURC.GENE';
		
		-- Tabella GENE.IMPANTIMAFIA - Aumento dimensione campi a 20 caratteri
		perform sp_backupanddropviews('impantimafia');
		ALTER TABLE impantimafia ALTER COLUMN ncdedu type varchar(20);
		ALTER TABLE impantimafia ALTER COLUMN nprich type varchar(20);
		perform sp_restoreviews('impantimafia');
		update c0campi set c0c_fs = 'A20' where coc_mne_uni = 'NCDEDU.IMPANTIMAFIA.GENE';
		update c0campi set c0c_fs = 'A20' where coc_mne_uni = 'NPRICH.IMPANTIMAFIA.GENE';
		
		update eldaver set numver = '1.4.82', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.82' or numver like '1.4.82.%')) THEN
		
		-- aggiornato ordinamento delle tipologie appalto in CAIS (prima le 2 di lavori, poi forniture, poi le 2 di servizi)
		update tab1 set tab1nord=1 where tab1cod='G_038' and tab1tip=1;
		update tab1 set tab1nord=2 where tab1cod='G_038' and tab1tip=4;
		update tab1 set tab1nord=3 where tab1cod='G_038' and tab1tip=2;
		update tab1 set tab1nord=4 where tab1cod='G_038' and tab1tip=3;
		update tab1 set tab1nord=5 where tab1cod='G_038' and tab1tip=5;

		-- definizione campo iscrcciaa in impr
		ALTER TABLE IMPR ADD iscrcciaa VARCHAR(1);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800102129, 'E', NULL, 'ISCRCCIAA.IMPR.GENE', 'G_ISCRCCIAA', 'Iscritto alla Camera di Commercio?', 'Iscr. CCIAA?', 'A1', NULL, 'SN', 'Iscritto alla Camera di Commercio?');

		-- (S.Santi 10.07.2017) Inizializza flag 'Iscritto  C.C.I.A.A.'
		update impr set iscrcciaa='1' where ncciaa is not null or dcciaa is not null or regdit is not null or discif is not null or pcciaa is not null or ncercc is not null or dcercc is not null or dantim is not null;
		update impr set iscrcciaa='2' where tipimp=6 and ncciaa is null and dcciaa is null and regdit is null and discif is null and  pcciaa is null and ncercc is null and dcercc is null and dantim is null;
		
		update eldaver set numver = '1.4.83', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.83' or numver like '1.4.83.%')) THEN
	
		ALTER TABLE USRSYS ADD SYSABAP VARCHAR(5);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'SYSABAP.USRSYS.GENE', 'G_USYSABAP', 'Privilegi dell''utente su AP (Non definito,Ammin.,Utente)', 'Privilegi AP', 'A5', NULL, NULL, NULL);
	
		--Allineamento codice NUTS a SIMAP R2.0.9.S02
		delete from TABNUTS;
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('IT','IT',NULL,NULL,NULL,'ITALIA');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC','IT','C',NULL,NULL,'NORD-OVEST');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC1','IT','C','1',NULL,'Piemonte');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC11','IT','C','1','1','Torino');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC12','IT','C','1','2','Vercelli');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC13','IT','C','1','3','Biella');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC14','IT','C','1','4','Verbano-Cusio-Ossola');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC15','IT','C','1','5','Novara');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC16','IT','C','1','6','Cuneo');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC17','IT','C','1','7','Asti');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC18','IT','C','1','8','Alessandria');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC2','IT','C','2',NULL,'Valle d''Aosta / Vallée d''Aoste');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC20','IT','C','2','0','Valle d''Aosta / Vallée d''Aoste');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC3','IT','C','3',NULL,'Liguria');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC31','IT','C','3','1','Imperia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC32','IT','C','3','2','Savona');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC33','IT','C','3','3','Genova');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC34','IT','C','3','4','La Spezia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC4','IT','C','4',NULL,'Lombardia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC41','IT','C','4','1','Varese');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC42','IT','C','4','2','Como');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC43','IT','C','4','3','Lecco');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC44','IT','C','4','4','Sondrio');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC46','IT','C','4','6','Bergamo');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC47','IT','C','4','7','Brescia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC48','IT','C','4','8','Pavia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC49','IT','C','4','9','Lodi');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC4A','IT','C','4','A','Cremona');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC4B','IT','C','4','B','Mantova');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC4C','IT','C','4','C','Milano');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITC4D','IT','C','4','D','Monza e della Brianza');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF','IT','F',NULL,NULL,'SUD');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF1','IT','F','1',NULL,'Abruzzo');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF11','IT','F','1','1','L''Aquila');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF12','IT','F','1','2','Teramo');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF13','IT','F','1','3','Pescara');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF14','IT','F','1','4','Chieti');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF2','IT','F','2',NULL,'Molise');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF21','IT','F','2','1','Isernia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF22','IT','F','2','2','Campobasso');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF3','IT','F','3',NULL,'Campania');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF31','IT','F','3','1','Caserta');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF32','IT','F','3','2','Benevento');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF33','IT','F','3','3','Napoli');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF34','IT','F','3','4','Avellino');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF35','IT','F','3','5','Salerno');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF4','IT','F','4',NULL,'Puglia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF43','IT','F','4','3','Taranto');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF44','IT','F','4','4','Brindisi');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF45','IT','F','4','5','Lecce');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF46','IT','F','4','6','Foggia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF47','IT','F','4','7','Bari');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF48','IT','F','4','8','Barletta-Andria-Trani');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF5','IT','F','5',NULL,'Basilicata');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF51','IT','F','5','1','Potenza');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF52','IT','F','5','2','Matera');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF6','IT','F','6',NULL,'Calabria');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF61','IT','F','6','1','Cosenza');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF62','IT','F','6','2','Crotone');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF63','IT','F','6','3','Catanzaro');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF64','IT','F','6','4','Vibo Valentia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITF65','IT','F','6','5','Reggio di Calabria');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG','IT','G',NULL,NULL,'ISOLE');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG1','IT','G','1',NULL,'Sicilia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG11','IT','G','1','1','Trapani');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG12','IT','G','1','2','Palermo');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG13','IT','G','1','3','Messina');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG14','IT','G','1','4','Agrigento');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG15','IT','G','1','5','Caltanissetta');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG16','IT','G','1','6','Enna');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG17','IT','G','1','7','Catania');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG18','IT','G','1','8','Ragusa');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG19','IT','G','1','9','Siracusa');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG2','IT','G','2',NULL,'Sardegna');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG25','IT','G','2','5','Sassari');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG26','IT','G','2','6','Nuoro');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG27','IT','G','2','7','Cagliari');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG28','IT','G','2','8','Oristano');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG29','IT','G','2','9','Olbia-Tempio');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG2A','IT','G','2','A','Ogliastra');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG2B','IT','G','2','B','Medio Campidano');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITG2C','IT','G','2','C','Carbonia-Iglesias');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH','IT','H',NULL,NULL,'NORD-EST');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH1','IT','H','1',NULL,'Provincia Autonoma di Bolzano / Bozen');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH10','IT','H','1','0','Bolzano-Bozen');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH2','IT','H','2',NULL,'Provincia Autonoma di Trento');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH20','IT','H','2','0','Trento');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH3','IT','H','3',NULL,'Veneto');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH31','IT','H','3','1','Verona');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH32','IT','H','3','2','Vicenza');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH33','IT','H','3','3','Belluno');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH34','IT','H','3','4','Treviso');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH35','IT','H','3','5','Venezia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH36','IT','H','3','6','Padova');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH37','IT','H','3','7','Rovigo');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH4','IT','H','4',NULL,'Friuli-Venezia Giulia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH41','IT','H','4','1','Pordenone');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH42','IT','H','4','2','Udine');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH43','IT','H','4','3','Gorizia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH44','IT','H','4','4','Trieste');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH5','IT','H','5',NULL,'Emilia-Romagna');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH51','IT','H','5','1','Piacenza');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH52','IT','H','5','2','Parma');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH53','IT','H','5','3','Reggio nell''Emilia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH54','IT','H','5','4','Modena');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH55','IT','H','5','5','Bologna');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH56','IT','H','5','6','Ferrara');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH57','IT','H','5','7','Ravenna');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH58','IT','H','5','8','Forlì-Cesena');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITH59','IT','H','5','9','Rimini');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI','IT','I',NULL,NULL,'CENTRO (IT)');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI1','IT','I','1',NULL,'Toscana');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI11','IT','I','1','1','Massa-Carrara');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI12','IT','I','1','2','Lucca');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI13','IT','I','1','3','Pistoia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI14','IT','I','1','4','Firenze');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI15','IT','I','1','5','Prato');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI16','IT','I','1','6','Livorno');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI17','IT','I','1','7','Pisa');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI18','IT','I','1','8','Arezzo');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI19','IT','I','1','9','Siena');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI1A','IT','I','1','A','Grosseto');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI2','IT','I','2',NULL,'Umbria');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI21','IT','I','2','1','Perugia');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI22','IT','I','2','2','Terni');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI3','IT','I','3',NULL,'Marche');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI31','IT','I','3','1','Pesaro e Urbino');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI32','IT','I','3','2','Ancona');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI33','IT','I','3','3','Macerata');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI34','IT','I','3','4','Ascoli Piceno');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI35','IT','I','3','5','Fermo');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI4','IT','I','4',NULL,'Lazio');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI41','IT','I','4','1','Viterbo');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI42','IT','I','4','2','Rieti');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI43','IT','I','4','3','Roma');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI44','IT','I','4','4','Latina');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITI45','IT','I','4','5','Frosinone');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITZ','IT','Z',NULL,NULL,'EXTRA-REGIO NUTS 1');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITZZ','IT','Z','Z',NULL,'Extra-Regio NUTS 2');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE) VALUES ('ITZZZ','IT','Z','Z','Z','Extra-Regio NUTS 3');

				-- Inserimento Comuni
		Delete from TABSCHE where tabcod='S2003' and tabcod1='09' and tabcod3 in ('001001316','005024123','003108047');
		INSERT INTO TABSCHE (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8621', 'MAPPANO', '001001316', '10072', 'M316');
		INSERT INTO TABSCHE (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8622', 'VAL LIONA', '005024123', '36040', 'M384');
		INSERT INTO TABSCHE (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8623', 'VEDUGGIO CON COLZANO', '003108047', '20837', 'L709');
		
		-- Correzioni codici catastali
		Update TABSCHE set TABCOD5='M376' where tabcod='S2003' and tabcod1='09' and tabcod3='009047023';
		Update TABSCHE set TABCOD5='M375' where tabcod='S2003' and tabcod1='09' and tabcod3='005025072';
		Update TABSCHE set TABCOD5='M383' where tabcod='S2003' and tabcod1='09' and tabcod3='003013253';
		Update TABSCHE set TABCOD5='M349' where tabcod='S2003' and tabcod1='09' and tabcod3='004022235';
		Update TABSCHE set TABCOD5='M369' where tabcod='S2003' and tabcod1='09' and tabcod3='008037062';
		Update TABSCHE set TABCOD5='M350' where tabcod='S2003' and tabcod1='09' and tabcod3='004022236';
		Update TABSCHE set TABCOD5='M351' where tabcod='S2003' and tabcod1='09' and tabcod3='004022237';
		Update TABSCHE set TABCOD5='M352' where tabcod='S2003' and tabcod1='09' and tabcod3='004022238';
		Update TABSCHE set TABCOD5='M353' where tabcod='S2003' and tabcod1='09' and tabcod3='004022239';
		Update TABSCHE set TABCOD5='M340' where tabcod='S2003' and tabcod1='09' and tabcod3='003020071';
		Update TABSCHE set TABCOD5='M370' where tabcod='S2003' and tabcod1='09' and tabcod3='001103078';
		Update TABSCHE set TABCOD5='M327' where tabcod='S2003' and tabcod1='09' and tabcod3='009050040';
		Update TABSCHE set TABCOD5='M354' where tabcod='S2003' and tabcod1='09' and tabcod3='004022240';
		Update TABSCHE set TABCOD5='M322' where tabcod='S2003' and tabcod1='09' and tabcod3='009051040';
		Update TABSCHE set TABCOD5='M355' where tabcod='S2003' and tabcod1='09' and tabcod3='004022241';
		Update TABSCHE set TABCOD5='M380' where tabcod='S2003' and tabcod1='09' and tabcod3='011041069';
		Update TABSCHE set TABCOD5='M336' where tabcod='S2003' and tabcod1='09' and tabcod3='003013251';
		Update TABSCHE set TABCOD5='M314' where tabcod='S2003' and tabcod1='09' and tabcod3='004022228';
		Update TABSCHE set TABCOD5='M356' where tabcod='S2003' and tabcod1='09' and tabcod3='004022242';
		Update TABSCHE set TABCOD5='M338' where tabcod='S2003' and tabcod1='09' and tabcod3='003018191';
		Update TABSCHE set TABCOD5='M372' where tabcod='S2003' and tabcod1='09' and tabcod3='003018192';
		Update TABSCHE set TABCOD5='M328' where tabcod='S2003' and tabcod1='09' and tabcod3='009050041';
		Update TABSCHE set TABCOD5='M366' where tabcod='S2003' and tabcod1='09' and tabcod3='004022233';
		Update TABSCHE set TABCOD5='M319' where tabcod='S2003' and tabcod1='09' and tabcod3='009046036';
		Update TABSCHE set TABCOD5='M321' where tabcod='S2003' and tabcod1='09' and tabcod3='009048052';
		Update TABSCHE set TABCOD5='M323' where tabcod='S2003' and tabcod1='09' and tabcod3='008038027';
		Update TABSCHE set TABCOD5='M309' where tabcod='S2003' and tabcod1='09' and tabcod3='012058122';
		Update TABSCHE set TABCOD5='D720' where tabcod='S2003' and tabcod1='09' and tabcod3='006030042';
		Update TABSCHE set TABCOD5='M315' where tabcod='S2003' and tabcod1='09' and tabcod3='003013249';
		Update TABSCHE set TABCOD5='M313' where tabcod='S2003' and tabcod1='09' and tabcod3='004022229';
		Update TABSCHE set TABCOD5='M339' where tabcod='S2003' and tabcod1='09' and tabcod3='003012142';
		Update TABSCHE set TABCOD5='M357' where tabcod='S2003' and tabcod1='09' and tabcod3='004022243';
		Update TABSCHE set TABCOD5='M368' where tabcod='S2003' and tabcod1='09' and tabcod3='008099029';
		Update TABSCHE set TABCOD5='M330' where tabcod='S2003' and tabcod1='09' and tabcod3='015064121';
		Update TABSCHE set TABCOD5='M365' where tabcod='S2003' and tabcod1='09' and tabcod3='004022234';
		Update TABSCHE set TABCOD5='M324' where tabcod='S2003' and tabcod1='09' and tabcod3='008099028';
		Update TABSCHE set TABCOD5='M367' where tabcod='S2003' and tabcod1='09' and tabcod3='008034050';
		Update TABSCHE set TABCOD5='M358' where tabcod='S2003' and tabcod1='09' and tabcod3='004022244';
		Update TABSCHE set TABCOD5='M329' where tabcod='S2003' and tabcod1='09' and tabcod3='009051041';
		Update TABSCHE set TABCOD5='M344' where tabcod='S2003' and tabcod1='09' and tabcod3='004022230';
		Update TABSCHE set TABCOD5='M359' where tabcod='S2003' and tabcod1='09' and tabcod3='004022245';
		Update TABSCHE set TABCOD5='M332' where tabcod='S2003' and tabcod1='09' and tabcod3='005025070';
		Update TABSCHE set TABCOD5='M317' where tabcod='S2003' and tabcod1='09' and tabcod3='006030188';
		Update TABSCHE set TABCOD5='M345' where tabcod='S2003' and tabcod1='09' and tabcod3='004022231';
		Update TABSCHE set TABCOD5='M377' where tabcod='S2003' and tabcod1='09' and tabcod3='009047024';
		Update TABSCHE set TABCOD5='M333' where tabcod='S2003' and tabcod1='09' and tabcod3='003016252';
		Update TABSCHE set TABCOD5='M326' where tabcod='S2003' and tabcod1='09' and tabcod3='009048053';
		Update TABSCHE set TABCOD5='M360' where tabcod='S2003' and tabcod1='09' and tabcod3='004022246';
		Update TABSCHE set TABCOD5='M347' where tabcod='S2003' and tabcod1='09' and tabcod3='009046037';
		Update TABSCHE set TABCOD5='M325' where tabcod='S2003' and tabcod1='09' and tabcod3='008034049';
		Update TABSCHE set TABCOD5='M381' where tabcod='S2003' and tabcod1='09' and tabcod3='008038028';
		Update TABSCHE set TABCOD5='M379' where tabcod='S2003' and tabcod1='09' and tabcod3='011041070';
		Update TABSCHE set TABCOD5='M361' where tabcod='S2003' and tabcod1='09' and tabcod3='004022247';
		Update TABSCHE set TABCOD5='M318' where tabcod='S2003' and tabcod1='09' and tabcod3='011042050';
		Update TABSCHE set TABCOD5='M341' where tabcod='S2003' and tabcod1='09' and tabcod3='003013252';
		Update TABSCHE set TABCOD5='M334' where tabcod='S2003' and tabcod1='09' and tabcod3='003016253';
		Update TABSCHE set TABCOD5='M374' where tabcod='S2003' and tabcod1='09' and tabcod3='005025073';
		Update TABSCHE set TABCOD5='M343' where tabcod='S2003' and tabcod1='09' and tabcod3='004022232';
		Update TABSCHE set TABCOD5='M382' where tabcod='S2003' and tabcod1='09' and tabcod3='011043058';
		Update TABSCHE set TABCOD5='M331' where tabcod='S2003' and tabcod1='09' and tabcod3='011041068';
		Update TABSCHE set TABCOD5='M362' where tabcod='S2003' and tabcod1='09' and tabcod3='004022248';
		Update TABSCHE set TABCOD5='M320' where tabcod='S2003' and tabcod1='09' and tabcod3='008037061';
		Update TABSCHE set TABCOD5='M346' where tabcod='S2003' and tabcod1='09' and tabcod3='006093053';
		Update TABSCHE set TABCOD5='M364' where tabcod='S2003' and tabcod1='09' and tabcod3='008035046';
		Update TABSCHE set TABCOD5='M337' where tabcod='S2003' and tabcod1='09' and tabcod3='003097091';
		Update TABSCHE set TABCOD5='M363' where tabcod='S2003' and tabcod1='09' and tabcod3='004022249';
		
		
		update eldaver set numver = '1.4.84', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION add_impleg_id() RETURNS Void AS $$
BEGIN
	IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.84' or numver like '1.4.84.%')) THEN
		ALTER TABLE IMPLEG ADD ID NUMERIC(12);
	END IF;
END;
$$ LANGUAGE plpgsql;
select * from add_impleg_id();
drop function add_impleg_id();


CREATE OR REPLACE FUNCTION add_impdte_id() RETURNS Void AS $$
BEGIN
	IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.84' or numver like '1.4.84.%')) THEN
		ALTER TABLE impdte ADD ID NUMERIC(12);
	END IF;
END;
$$ LANGUAGE plpgsql;
select * from add_impdte_id();
drop function add_impdte_id();


CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
DECLARE
	ls_impleg_codimp2 varchar(10);
	ls_impleg_codleg varchar(10);
	ll_impleg_new_id numeric(12) := 0;
	ls_impleg_pk_constraint varchar(2000);
	ll_impleggest_esiste_entita numeric(10) := 0;
	ll_impleggest_riga numeric(10) := 0;
	ll_impleg_max_id numeric(12) := 0;
	ls_impdte_codimp3 varchar(10);
	ls_impdte_coddte varchar(10);
	ll_impdte_new_id numeric(12) := 0;
	ls_impdte_pk_constraint varchar(2000);
	ll_impdtegest_esiste_entita numeric(10) := 0;
	ll_impdtegest_riga numeric(10) := 0;
	ll_impdte_max_id numeric(12) := 0;
	ciclo_impleg cursor for select impleg.codimp2, impleg.codleg from impleg order by impleg.codimp2, impleg.codleg;
	ciclo_impdte cursor for select impdte.codimp3, impdte.coddte from impdte order by impdte.codimp3, impdte.coddte;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.84' or numver like '1.4.84.%')) THEN
		
		-- nuovi campi in IMPR		
		--Definizione nuovi campi
		ALTER TABLE IMPR ADD CLADIM NUMERIC(7);
		-- Iscrizione white list antimafia 
		ALTER TABLE IMPR ADD ISCRIWL VARCHAR(1);
		ALTER TABLE IMPR ADD WLPREFE VARCHAR(50);
		ALTER TABLE IMPR ADD WLSEZIO VARCHAR(20);
		ALTER TABLE IMPR ADD WLDISCRI TIMESTAMP;
		ALTER TABLE IMPR ADD WLDSCAD TIMESTAMP;
		ALTER TABLE IMPR ADD WLINCORSO VARCHAR(1);
		
		--CODATT.IMPR esteso a VC(15)
		ALTER TABLE IMPR ALTER COLUMN CODATT type VARCHAR(15);
		
		--Nuova entità DURC 
		CREATE TABLE IMPDURC (
		ID NUMERIC(12) NOT NULL,
		CODIMP VARCHAR(10) NOT NULL,
		NPROTO VARCHAR(20),
		DATRIC TIMESTAMP,
		DATSCA TIMESTAMP,
		TIPESI NUMERIC(7),
		NOTDUR VARCHAR(2000),
		primary key (ID));
		
		ALTER TABLE IMPDURC ADD CONSTRAINT FK_IMPDURC_IMPR FOREIGN KEY ( CODIMP ) REFERENCES IMPR( CODIMP ) ON DELETE CASCADE;
		
		-- Nuova view V_IMPR_VERIFICA. Indica per ogni ditta in anagrafica se ha DURC regolare e se è iscritta alla WhiteList.
		-- DURC regolare: è soggetta a DURC con durc regolare e con scadenza successiva alla data odierna oppure non è soggetta a DURC. Nel caso di RT,
		-- tutte le ditte componenti devono avere DURC regolare.
		-- WhiteList: è iscritta con scadenza successiva alla data odierna. Nel caso di RT, tutte le ditte componenti devono essere iscritte.
		create or replace view v_impr_verifica as 
		with durc_reg as (
		select CODIMP from impr where 
		((IMPR.TIPIMP is null or tipimp not in (3,10)) and 
		((IMPR.SOGGDURC = '1' and exists(select codimp from impdurc where impdurc.codimp = impr.codimp and to_timestamp(to_char(COALESCE(impdurc.datsca,  '1900/01/01'),'YYYY/MM/DD') || ' ' || '23:59:59', 'YYYY/MM/DD HH24:MI:SS')>=now() and TIPESI=1 )) OR (IMPR.SOGGDURC = '2'))
		)
		OR
		(IMPR.TIPIMP in (3,10) and exists (select codime9 from ragimp where ragimp.codime9=impr.codimp)
		and not exists(select codime9 from ragimp,impr imprcomp where ragimp.coddic=imprcomp.codimp and ragimp.codime9=impr.codimp
		and ((imprcomp.SOGGDURC = '1' and NOT exists(select codimp from impdurc where impdurc.codimp = imprcomp.codimp and to_timestamp(to_char(COALESCE(impdurc.datsca,  '1900/01/01'),'YYYY/MM/DD') || ' ' || '23:59:59', 'YYYY/MM/DD HH24:MI:SS')>=now() and TIPESI=1 )) OR (imprcomp.SOGGDURC IS NULL)))
		)),
		wl_reg as (
		select codimp from impr where 
		((IMPR.TIPIMP is null or tipimp not in (3,10)) and iscriwl='1' and to_timestamp(to_char(COALESCE(wldscad,  '1900/01/01'),'YYYY/MM/DD') || ' ' || '23:59:59', 'YYYY/MM/DD HH24:MI:SS')>=now())
		OR 
		(IMPR.TIPIMP in (3,10) and exists (select codime9 from ragimp where ragimp.codime9=impr.codimp)
		and not exists (select codime9 from ragimp,impr imprcomp where ragimp.coddic=imprcomp.codimp and ragimp.codime9=impr.codimp
		and (imprcomp.iscriwl is null or imprcomp.iscriwl='2' or NOT(imprcomp.iscriwl='1' and to_timestamp(to_char(COALESCE(imprcomp.wldscad,  '1900/01/01'),'YYYY/MM/DD') || ' ' || '23:59:59', 'YYYY/MM/DD HH24:MI:SS')>=now()))))
		)
		select impr.codimp, 
		case when durc_reg.codimp is null then '2' else '1' end durc_reg,
		case when wl_reg.codimp is null then '2' else '1' end wl_reg
		from impr 
		left outer join durc_reg on (impr.codimp=durc_reg.codimp)
		left outer join wl_reg on (impr.codimp=wl_reg.codimp);
		
		
		--Spostata creazione W_GENCHIAVI dagli script di GENEWEB a quelli di GENE
		if (select count(*) <= 0 from information_schema.tables where upper(table_name) = 'W_GENCHIAVI') then
			EXECUTE ('CREATE TABLE w_genchiavi (
							tabella VARCHAR(35) not null,
							chiave NUMERIC(20) not null,
							primary key (TABELLA))');
			INSERT INTO w_genchiavi (tabella, chiave) VALUES ('UFFSET', 0);
		end if;
		--Inizializzazione W_GENCHIAVI
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('IMPDURC',0);
		
		--Inizializzazione W_GENCHIAVI per IMPLEG e IMPDTE
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('IMPLEG',0);
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('IMPDTE',0);
		--
		-- CAMBIA LA CHIAVE PRIMARIA DELL'ENTITA' IMPLEG:
		-- Valorizza il nuovo campo IMPLEG.ID (quì non ancora impostato come chiave)
		ll_impleg_new_id := 0;
		open ciclo_impleg;
		loop
			-- Inizializzazione i campi della query ciclo_impleg
			fetch ciclo_impleg into ls_impleg_codimp2, ls_impleg_codleg;
			-- Se non ci sono più dati da scorrere, esce dal ciclo
			if not found then
				exit;
			end if;
			-- Inizializza ll_impleg_new_id
			ll_impleg_new_id := ll_impleg_new_id + 1;
			-- Gestisce l'update in IMPLEG.ID
			if (ls_impleg_codimp2 is not NULL) and (length(ls_impleg_codimp2) > 0) then
				if (ls_impleg_codleg is not NULL) and (length(ls_impleg_codleg) > 0) then
					if (ll_impleg_new_id is not NULL) and (ll_impleg_new_id > 0) then
						UPDATE IMPLEG set ID=ll_impleg_new_id where codimp2=ls_impleg_codimp2 and codleg=ls_impleg_codleg;
					end if;
				end if;
			end if;
		end loop;
		close ciclo_impleg;
		-- Elimina l'eventuale indice IMPLEG_PK che veniva creato nei DB inizializzati fino a 05/2009
		select count(1) into ll_impleggest_riga from pg_indexes where Upper(indexname)='IMPLEG_PK';
		if (ll_impleggest_riga > 0) then
			DROP INDEX IMPLEG_PK;
		end if;
		-- Imposta la constraint di tipo 'not null' sul campo ID
		ALTER TABLE impleg ALTER COLUMN ID SET NOT NULL;
		-- Sostituisce la definizione corrente dei campi chiave con la nuova definizione
		select count(1) into ll_impleggest_riga from impleg where (id is null) or (id=0);
		if (ll_impleggest_riga <= 0) then
			select constraint_name into ls_impleg_pk_constraint from information_schema.table_constraints where upper(table_name) = 'IMPLEG' and constraint_type='PRIMARY KEY';
			if (ls_impleg_pk_constraint is not NULL) and (length(ls_impleg_pk_constraint) > 0) then
				EXECUTE ('ALTER TABLE impleg DROP CONSTRAINT '||ls_impleg_pk_constraint);
				ALTER TABLE impleg ADD PRIMARY KEY (ID);
			end if;
		end if;
		-- Imposta l'occorrenza in W_GENCHIAVI
		select count(1) into ll_impleggest_esiste_entita from information_schema.tables where upper(table_name) = 'W_GENCHIAVI';
		if (ll_impleggest_esiste_entita > 0) then
			SELECT MAX(ID) INTO ll_impleg_max_id FROM impleg;
			if (ll_impleg_max_id is NULL) then
				ll_impleg_max_id := 0;
			end if;
			UPDATE W_GENCHIAVI set CHIAVE=ll_impleg_max_id where TABELLA='IMPLEG';
		end if;
		-- Imposta le occorrenze in C0CAMPI
		DELETE FROM c0campi WHERE coc_mne_uni LIKE '%IMPLEG%';
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800104001, 'E', 'P', 'ID.IMPLEG.GENE', 'G_IDLEG', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800104002, 'E', NULL, 'CODIMP2.IMPLEG.GENE', 'CODIMP2', 'Codice impresa', 'Codice impresa', 'A10', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800104003, 'E', NULL, 'CODLEG.IMPLEG.GENE', 'CODLEG', 'Codice del legale rappresentante', 'Cod. legale rappres.', 'A10', NULL, NULL, 'Codice');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800104004, 'E', NULL, 'NOMLEG.IMPLEG.GENE', 'NOMLEG', 'Nome del legale rappresentante', 'Nome legale rappres.', 'A161', NULL, NULL, 'Nome');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800104005, 'E', NULL, 'LEGINI.IMPLEG.GENE', 'G_LEGINI', 'Data inizio dell''incarico', 'Inizio incarico', 'A10', NULL, 'DATA_ELDA', 'Data inizio incarico');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800104006, 'E', NULL, 'LEGFIN.IMPLEG.GENE', 'G_LEGFIN', 'Data termine dell''incarico', 'Termine incarico', 'A10', NULL, 'DATA_ELDA', 'Data termine incarico');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800104007, 'E', NULL, 'NOTLEG.IMPLEG.GENE', 'G_NOTLEG', 'Eventuali note', 'Note', 'A2000', NULL, 'NOTE', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800104008, 'C', NULL, 'DAESTERN.IMPLEG.GENE', 'G_DAESTELR', 'Inserito da portale o esterno', 'Inserito da portale', 'A2', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800104009, 'E', NULL, 'RESPDICH.IMPLEG.GENE', 'G_RESDICLR', 'Responsabile delle dichiarazioni (DPR 445/2000)', 'Resp. dichiarazioni', 'A2', NULL, 'SN', 'Responsabile delle dichiarazioni (DPR 445/2000)');
		--
		-- CAMBIA LA CHIAVE PRIMARIA DELL'ENTITA' IMPDTE:
		-- Valorizza il nuovo campo IMPDTE.ID (quì non ancora impostato come chiave)
		ll_impdte_new_id := 0;
		open ciclo_impdte;
		loop
			-- Inizializzazione i campi della query ciclo_impdte
			fetch ciclo_impdte into ls_impdte_codimp3, ls_impdte_coddte;
			-- Se non ci sono più dati da scorrere, esce dal ciclo
			if not found then
				exit;
			end if;
			-- Inizializza ll_impdte_new_id
			ll_impdte_new_id := ll_impdte_new_id + 1;
			-- Gestisce l'update in IMPDTE.ID
			if (ls_impdte_codimp3 is not NULL) and (length(ls_impdte_codimp3) > 0) then
				if (ls_impdte_coddte is not NULL) and (length(ls_impdte_coddte) > 0) then
					if (ll_impdte_new_id is not NULL) and (ll_impdte_new_id > 0) then
						UPDATE IMPDTE set ID=ll_impdte_new_id where codimp3=ls_impdte_codimp3 and coddte=ls_impdte_coddte;
					end if;
				end if;
			end if;
		end loop;
		close ciclo_impdte;
		-- Elimina l'eventuale indice IMPLEG_PK che veniva creato nei DB inizializzati fino a 05/2009
		select count(1) into ll_impdtegest_riga from pg_indexes where Upper(indexname)='IMPDTE_PK';
		if (ll_impdtegest_riga > 0) then
			DROP INDEX IMPDTE_PK;
		end if;
		-- Imposta la constraint di tipo 'not null' sul campo ID
		ALTER TABLE impdte ALTER COLUMN ID SET NOT NULL;
		-- Sostituisce la definizione corrente dei campi chiave con la nuova definizione
		select count(1) into ll_impdtegest_riga from impdte where (id is null) or (id=0);
		if (ll_impdtegest_riga <= 0) then
			select constraint_name into ls_impdte_pk_constraint from information_schema.table_constraints where upper(table_name) = 'IMPDTE' and constraint_type='PRIMARY KEY';
			if (ls_impdte_pk_constraint is not NULL) and (length(ls_impdte_pk_constraint) > 0) then
				EXECUTE ('ALTER TABLE impdte DROP CONSTRAINT '||ls_impdte_pk_constraint);
				ALTER TABLE impdte ADD PRIMARY KEY (ID);
			end if;
		end if;
		-- Imposta l'occorrenza in W_GENCHIAVI
		select count(1) into ll_impdtegest_esiste_entita from information_schema.tables where upper(table_name) = 'W_GENCHIAVI';
		if (ll_impdtegest_esiste_entita > 0) then
			SELECT MAX(ID) INTO ll_impdte_max_id FROM impdte;
			if (ll_impdte_max_id is NULL) then
				ll_impdte_max_id := 0;
			end if;
			UPDATE W_GENCHIAVI set CHIAVE=ll_impdte_max_id where TABELLA='IMPDTE';
		end if;
		-- Imposta le occorrenze in C0CAMPI
		DELETE FROM c0campi WHERE coc_mne_uni LIKE '%IMPDTE%';
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800103001, 'E', 'P', 'ID.IMPDTE.GENE', 'G_IDDTE', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800103002, 'E', NULL, 'CODIMP3.IMPDTE.GENE', 'CODIMP3', 'Codice impresa', 'Codice impresa', 'A10', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800103003, 'E', NULL, 'CODDTE.IMPDTE.GENE', 'CODDTE', 'Codice del direttore tecnico', 'Cod. dir.tecnico', 'A10', NULL, NULL, 'Codice');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800103004, 'E', NULL, 'NOMDTE.IMPDTE.GENE', 'NOMDTE', 'Nome del direttore tecnico', 'Nome dir.tecnico', 'A161', NULL, NULL, 'Nome');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800103005, 'E', NULL, 'DIRINI.IMPDTE.GENE', 'G_DIRINI', 'Data inizio dell''incarico', 'Inizio incarico', 'A10', NULL, 'DATA_ELDA', 'Data inizio incarico');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800103006, 'E', NULL, 'DIRFIN.IMPDTE.GENE', 'G_DIRFIN', 'Data termine dell''incarico', 'Termine incarico', 'A10', NULL, 'DATA_ELDA', 'Data termine incarico');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800103007, 'E', NULL, 'NOTDTE.IMPDTE.GENE', 'G_NOTDTE', 'Eventuali note', 'Note', 'A2000', NULL, 'NOTE', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800103008, 'C', NULL, 'DAESTERN.IMPDTE.GENE', 'G_DAESTEDT', 'Inserito da portale o esterno', 'Inserito da portale', 'A2', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800103009, 'E', NULL, 'RESPDICH.IMPDTE.GENE', 'G_RESDICDT', 'Responsabile delle dichiarazioni (DPR 445/2000)', 'Resp. dichiarazioni', 'A2', NULL, 'SN', 'Responsabile delle dichiarazioni (DPR 445/2000)');
		
		--sbiancato campo CODATT.IMPR 
		UPDATE IMPR SET CODATT=NULL;
		
		-- G_060 - tabellato per TIPESI.IMPDURC
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_060', 1, 'Regolare', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_060', 2, 'Irregolare', NULL, 0);
		
		-- G_061 - tabellato per whitelist (art.53 L.190/2012)
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 1, 'Trasporto di materiali a discarica per conto di terzi', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 2, 'Trasporto, anche transfrontaliero, e smaltimento di rifiuti per conto di terzi', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 3, 'Estrazione, fornitura e trasporto di terra e materiali inerti', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 4, 'Confezionamento, fornitura e trasporto di calcestruzzo e di bitume', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 5, 'Noli a freddo di macchinari', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 6, 'Fornitura di ferro lavorato', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 7, 'Noli a caldo', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 8, 'Autotrasporto per conto di terzi', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 9, 'Guardiania dei cantieri', NULL, 0);

		-- G_062 - tabellato per il campo CLADIM.IMPR
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_062', 3, 'Micro impresa', NULL, 1);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_062', 2, 'Piccola impresa', NULL, 2);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_062', 1, 'Media impresa', NULL, 3);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_062', 4, 'Grande impresa', NULL, 4);		
		
		
		-- G_j07 tabellato per CODATT
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A011', 'COLTIVAZIONE DI COLTURE AGRICOLE NON PERMANENTI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A012', 'COLTIVAZIONE DI COLTURE PERMANENTI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A013', 'RIPRODUZIONE DELLE PIANTE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A014', 'ALLEVAMENTO DI ANIMALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A015', 'COLTIVAZIONI AGRICOLE ASSOCIATE ALL''ALLEVAMENTO DI ANIMALI: ATTIVITA'' MISTA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A016', 'ATTIVITA'' DI SUPPORTO ALL''AGRICOLTURA E ATTIVITA'' SUCCESSIVE ALLA RACCOLTA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A017', 'CACCIA, CATTURA DI ANIMALI E SERVIZI CONNESSI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A021', 'SILVICOLTURA ED ALTRE ATTIVITA'' FORESTALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A022', 'UTILIZZO DI AREE FORESTALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A023', 'RACCOLTA DI PRODOTTI SELVATICI NON LEGNOSI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A024', 'SERVIZI DI SUPPORTO PER LA SILVICOLTURA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A031', 'PESCA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007A032', 'ACQUACOLTURA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007B051', 'ESTRAZIONE DI ANTRACITE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007B052', 'ESTRAZIONE DI LIGNITE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007B061', 'ESTRAZIONE DI PETROLIO GREGGIO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007B062', 'ESTRAZIONE DI GAS NATURALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007B071', 'ESTRAZIONE DI MINERALI METALLIFERI FERROSI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007B072', 'ESTRAZIONE DI MINERALI METALLIFERI NON FERROSI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007B081', 'ESTRAZIONE DI PIETRA, SABBIA E ARGILLA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007B089', 'ESTRAZIONE DI MINERALI DA CAVE E MINIERE NCA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007B091', 'ATTIVITA'' DI SUPPORTO ALL''ESTRAZIONE DI PETROLIO E DI GAS NATURALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007B099', 'ATTIVITA'' DI SUPPORTO PER L''ESTRAZIONE DA CAVE E MINIERE DI ALTRI MINERALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C101', 'LAVORAZIONE E CONSERVAZIONE DI CARNE E PRODUZIONE DI PRODOTTI A BASE DI CARNE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C102', 'LAVORAZIONE E CONSERVAZIONE DI PESCE, CROSTACEI E MOLLUSCHI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C103', 'LAVORAZIONE E CONSERVAZIONE DI FRUTTA E ORTAGGI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C104', 'PRODUZIONE DI OLI E GRASSI VEGETALI E ANIMALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C105', 'INDUSTRIA LATTIERO-CASEARIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C106', 'LAVORAZIONE DELLE GRANAGLIE, PRODUZIONE DI AMIDI E DI PRODOTTI AMIDACEI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C107', 'PRODUZIONE DI PRODOTTI DA FORNO E FARINACEI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C108', 'PRODUZIONE DI ALTRI PRODOTTI ALIMENTARI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C109', 'PRODUZIONE DI PRODOTTI PER L''ALIMENTAZIONE DEGLI ANIMALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C110', 'INDUSTRIA DELLE BEVANDE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C120', 'INDUSTRIA DEL TABACCO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C131', 'PREPARAZIONE E FILATURA DI FIBRE TESSILI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C132', 'TESSITURA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C133', 'FINISSAGGIO DEI TESSILI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C139', 'ALTRE INDUSTRIE TESSILI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C141', 'CONFEZIONE DI ARTICOLI DI ABBIGLIAMENTO (ESCLUSO ABBIGLIAMENTO IN PELLICCIA)', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C142', 'CONFEZIONE DI ARTICOLI IN PELLICCIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C143', 'FABBRICAZIONE DI ARTICOLI DI MAGLIERIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C151', 'PREPARAZIONE E CONCIA DEL CUOIO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C152', 'FABBRICAZIONE DI CALZATURE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C161', 'TAGLIO E PIALLATURA DEL LEGNO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C162', 'FABBRICAZIONE DI PRODOTTI IN LEGNO, SUGHERO, PAGLIA E MATERIALI DA INTRECCIO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C171', 'FABBRICAZIONE DI PASTA-CARTA, CARTA E CARTONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C172', 'FABBRICAZIONE DI ARTICOLI DI CARTA E CARTONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C181', 'STAMPA E SERVIZI CONNESSI ALLA STAMPA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C182', 'RIPRODUZIONE DI SUPPORTI REGISTRATI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C191', 'FABBRICAZIONE DI PRODOTTI DI COKERIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C192', 'FABBRICAZIONE DI PRODOTTI DERIVANTI DALLA RAFFINAZIONE DEL PETROLIO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C201', 'FABBRICAZIONE DI PRODOTTI CHIMICI DI BASE, DI FERTILIZZANTI E COMPOSTI AZOTATI, DI MATERIE PLASTICHE E GOMMA SINTETICA IN FORME PRIMARIE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C202', 'FABBRICAZIONE DI AGROFARMACI E DI ALTRI PRODOTTI CHIMICI PER L''AGRICOLTURA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C203', 'FABBRICAZIONE DI PITTURE, VERNICI E SMALTI, INCHIOSTRI DA STAMPA E ADESIVI SINTETICI (MASTICI)', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C204', 'FABBRICAZIONE DI SAPONI E DETERGENTI, DI PRODOTTI PER LA PULIZIA E LA LUCIDATURA, DI PROFUMI E COSMETICI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C205', 'FABBRICAZIONE DI ALTRI PRODOTTI CHIMICI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C206', 'FABBRICAZIONE DI FIBRE SINTETICHE E ARTIFICIALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C211', 'FABBRICAZIONE DI PRODOTTI FARMACEUTICI DI BASE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C239', 'FABBRICAZIONE DI PRODOTTI ABRASIVI E DI PRODOTTI IN MINERALI NON METALLIFERI NCA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C241', 'SIDERURGIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C242', 'FABBRICAZIONE DI TUBI, CONDOTTI, PROFILATI CAVI E RELATIVI ACCESSORI IN ACCIAIO (ESCLUSI QUELLI IN ACCIAIO COLATO)', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C243', 'FABBRICAZIONE DI ALTRI PRODOTTI DELLA PRIMA TRASFORMAZIONE DELL''ACCIAIO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C244', 'PRODUZIONE DI METALLI DI BASE PREZIOSI E ALTRI METALLI NON FERROSI, TRATTAMENTO DEI COMBUSTIBILI NUCLEARI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C245', 'FONDERIE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C251', 'FABBRICAZIONE DI ELEMENTI DA COSTRUZIONE IN METALLO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C252', 'FABBRICAZIONE DI CISTERNE, SERBATOI, RADIATORI E CONTENITORI IN METALLO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C253', 'FABBRICAZIONE DI GENERATORI DI VAPORE (ESCLUSI I CONTENITORI IN METALLO PER CALDAIE PER IL RISCALDAMENTO CENTRALE AD ACQUA CALDA)', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C254', 'FABBRICAZIONE DI ARMI E MUNIZIONI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C255', 'FUCINATURA, IMBUTITURA, STAMPAGGIO E PROFILATURA DEI METALLI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C256', 'TRATTAMENTO E RIVESTIMENTO DEI METALLI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C257', 'FABBRICAZIONE DI ARTICOLI DI COLTELLERIA, UTENSILI E OGGETTI DI FERRAMENTA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C259', 'FABBRICAZIONE DI ALTRI PRODOTTI IN METALLO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C261', 'FABBRICAZIONE DI COMPONENTI ELETTRONICI E SCHEDE ELETTRONICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C262', 'FABBRICAZIONE DI COMPUTER E UNITÀ PERIFERICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C263', 'FABBRICAZIONE DI APPARECCHIATURE PER LE TELECOMUNICAZIONI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C264', 'FABBRICAZIONE DI PRODOTTI DI ELETTRONICA DI CONSUMO AUDIO E VIDEO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C265', 'FABBRICAZIONE DI STRUMENTI E APPARECCHI DI MISURAZIONE, PROVA E NAVIGAZIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C266', 'FABBRICAZIONE DI STRUMENTI PER IRRADIAZIONE, APPARECCHIATURE ELETTROMEDICALI ED ELETTROTERAPEUTICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C267', 'FABBRICAZIONE DI STRUMENTI OTTICI E ATTREZZATURE FOTOGRAFICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C268', 'FABBRICAZIONE DI SUPPORTI MAGNETICI ED OTTICI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C271', 'FABBRICAZIONE DI MOTORI, GENERATORI E TRASFORMATORI ELETTRICI E DI APPARECCHIATURE PER LA DISTRIBUZIONE E IL CONTROLLO DELL''ELETTRICITA''', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C272', 'FABBRICAZIONE DI BATTERIE DI PILE ED ACCUMULATORI ELETTRICI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C273', 'FABBRICAZIONE DI CABLAGGI E APPARECCHIATURE DI CABLAGGIO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C274', 'FABBRICAZIONE DI APPARECCHIATURE PER ILLUMINAZIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C275', 'FABBRICAZIONE DI APPARECCHI PER USO DOMESTICO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C279', 'FABBRICAZIONE DI ALTRE APPARECCHIATURE ELETTRICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C281', 'FABBRICAZIONE DI MACCHINE DI IMPIEGO GENERALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C282', 'FABBRICAZIONE DI ALTRE MACCHINE DI IMPIEGO GENERALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C283', 'FABBRICAZIONE DI MACCHINE PER L''AGRICOLTURA E LA SILVICOLTURA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C284', 'FABBRICAZIONE DI MACCHINE PER LA FORMATURA DEI METALLI E DI ALTRE MACCHINE UTENSILI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C289', 'FABBRICAZIONE DI ALTRE MACCHINE PER IMPIEGHI SPECIALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C291', 'FABBRICAZIONE DI AUTOVEICOLI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C292', 'FABBRICAZIONE DI CARROZZERIE PER AUTOVEICOLI, RIMORCHI E SEMIRIMORCHI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C293', 'FABBRICAZIONE DI PARTI ED ACCESSORI PER AUTOVEICOLI E LORO MOTORI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C301', 'COSTRUZIONE DI NAVI E IMBARCAZIONI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C302', 'COSTRUZIONE DI LOCOMOTIVE E DI MATERIALE ROTABILE FERRO-TRANVIARIO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C303', 'FABBRICAZIONE DI AEROMOBILI, DI VEICOLI SPAZIALI E DEI RELATIVI DISPOSITIVI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C304', 'FABBRICAZIONE DI VEICOLI MILITARI DA COMBATTIMENTO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C309', 'FABBRICAZIONE DI MEZZI DI TRASPORTO NCA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C310', 'FABBRICAZIONE DI MOBILI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C321', 'FABBRICAZIONE DI GIOIELLERIA, BIGIOTTERIA E ARTICOLI CONNESSI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C322', 'FABBRICAZIONE DI STRUMENTI MUSICALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C323', 'FABBRICAZIONE DI ARTICOLI SPORTIVI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C324', 'FABBRICAZIONE DI GIOCHI E GIOCATTOLI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C325', 'FABBRICAZIONE DI STRUMENTI E FORNITURE MEDICHE E DENTISTICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C329', 'INDUSTRIE MANIFATTURIERE NCA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C331', 'RIPARAZIONE E MANUTENZIONE DI PRODOTTI IN METALLO, MACCHINE ED APPARECCHIATURE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C332', 'INSTALLAZIONE DI MACCHINE ED APPARECCHIATURE INDUSTRIALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007D351', 'PRODUZIONE, TRASMISSIONE E DISTRIBUZIONE DI ENERGIA ELETTRICA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007D352', 'PRODUZIONE DI GAS', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007D353', 'FORNITURA DI VAPORE E ARIA CONDIZIONATA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007E360', 'RACCOLTA, TRATTAMENTO E FORNITURA DI ACQUA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007E370', 'GESTIONE DELLE RETI FOGNARIE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007E381', 'RACCOLTA DEI RIFIUTI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007E382', 'TRATTAMENTO E SMALTIMENTO DEI RIFIUTI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007E383', 'RECUPERO DEI MATERIALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007E390', 'ATTIVITA'' DI RISANAMENTO E ALTRI SERVIZI DI GESTIONE DEI RIFIUTI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007F411', 'SVILUPPO DI PROGETTI IMMOBILIARI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007F412', 'COSTRUZIONE DI EDIFICI RESIDENZIALI E NON RESIDENZIALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007F421', 'COSTRUZIONE DI STRADE E FERROVIE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007F422', 'COSTRUZIONE DI OPERE DI PUBBLICA UTILITÀ', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007F429', 'COSTRUZIONE DI ALTRE OPERE DI INGEGNERIA CIVILE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007F431', 'DEMOLIZIONE E PREPARAZIONE DEL CANTIERE EDILE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007F432', 'INSTALLAZIONE DI IMPIANTI ELETTRICI, IDRAULICI ED ALTRI LAVORI DI COSTRUZIONE E INSTALLAZIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007F433', 'COMPLETAMENTO E FINITURA DI EDIFICI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007F439', 'ALTRI LAVORI SPECIALIZZATI DI COSTRUZIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G451', 'COMMERCIO DI AUTOVEICOLI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G452', 'MANUTENZIONE E RIPARAZIONE DI AUTOVEICOLI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G453', 'COMMERCIO DI PARTI E ACCESSORI DI AUTOVEICOLI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G454', 'COMMERCIO, MANUTENZIONE E RIPARAZIONE DI MOTOCICLI E RELATIVE PARTI ED ACCESSORI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G461', 'INTERMEDIARI DEL COMMERCIO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G462', 'COMMERCIO ALL''INGROSSO DI MATERIE PRIME AGRICOLE E DI ANIMALI VIVI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G463', 'COMMERCIO ALL''INGROSSO DI PRODOTTI ALIMENTARI, BEVANDE E PRODOTTI DEL TABACCO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G464', 'COMMERCIO ALL''INGROSSO DI BENI DI CONSUMO FINALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G465', 'COMMERCIO ALL''INGROSSO DI APPARECCHIATURE ICT', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G466', 'COMMERCIO ALL''INGROSSO DI ALTRI MACCHINARI, ATTREZZATURE E FORNITURE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G467', 'COMMERCIO ALL''INGROSSO SPECIALIZZATO DI ALTRI PRODOTTI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G469', 'COMMERCIO ALL''INGROSSO NON SPECIALIZZATO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G471', 'COMMERCIO AL DETTAGLIO IN ESERCIZI NON SPECIALIZZATI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G472', 'COMMERCIO AL DETTAGLIO DI PRODOTTI ALIMENTARI, BEVANDE E TABACCO IN ESERCIZI SPECIALIZZATI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G473', 'COMMERCIO AL DETTAGLIO DI CARBURANTE PER AUTOTRAZIONE IN ESERCIZI SPECIALIZZATI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G474', 'COMMERCIO AL DETTAGLIO DI APPARECCHIATURE INFORMATICHE E PER LE TELECOMUNICAZIONI (ICT) IN ESERCIZI SPECIALIZZATI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G475', 'COMMERCIO AL DETTAGLIO DI ALTRI PRODOTTI PER USO DOMESTICO IN ESERCIZI SPECIALIZZATI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G476', 'COMMERCIO AL DETTAGLIO DI ARTICOLI CULTURALI E RICREATIVI IN ESERCIZI SPECIALIZZATI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G477', 'COMMERCIO AL DETTAGLIO DI ALTRI PRODOTTI IN ESERCIZI SPECIALIZZATI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G478', 'COMMERCIO AL DETTAGLIO AMBULANTE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007G479', 'COMMERCIO AL DETTAGLIO AL DI FUORI DI NEGOZI, BANCHI E MERCATI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H491', 'TRASPORTO FERROVIARIO DI PASSEGGERI (INTERURBANO)', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H492', 'TRASPORTO FERROVIARIO DI MERCI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H493', 'ALTRI TRASPORTI TERRESTRI DI PASSEGGERI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H494', 'TRASPORTO DI MERCI SU STRADA E SERVIZI DI TRASLOCO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H495', 'TRASPORTO MEDIANTE CONDOTTE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H501', 'TRASPORTO MARITTIMO E COSTIERO DI PASSEGGERI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H502', 'TRASPORTO MARITTIMO E COSTIERO DI MERCI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H503', 'TRASPORTO DI PASSEGGERI PER VIE D''ACQUA INTERNE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H504', 'TRASPORTO DI MERCI PER VIE D''ACQUA INTERNE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H511', 'TRASPORTO AEREO DI PASSEGGERI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H512', 'TRASPORTO AEREO DI MERCI E TRASPORTO SPAZIALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H521', 'MAGAZZINAGGIO E CUSTODIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H522', 'ATTIVITA'' DI SUPPORTO AI TRASPORTI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H531', 'ATTIVITA'' POSTALI CON OBBLIGO DI SERVIZIO UNIVERSALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007H532', 'ALTRE ATTIVITA'' POSTALI E DI CORRIERE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007I551', 'ALBERGHI E STRUTTURE SIMILI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007I552', 'ALLOGGI PER VACANZE E ALTRE STRUTTURE PER BREVI SOGGIORNI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007I553', 'AREE DI CAMPEGGIO E AREE ATTREZZATE PER CAMPER E ROULOTTE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007I559', 'ALTRI ALLOGGI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007I561', 'RISTORANTI E ATTIVITA'' DI RISTORAZIONE MOBILE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007I562', 'FORNITURA DI PASTI PREPARATI (CATERING) E ALTRI SERVIZI DI RISTORAZIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007I563', 'BAR E ALTRI ESERCIZI SIMILI SENZA CUCINA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J581', 'EDIZIONE DI LIBRI, PERIODICI ED ALTRE ATTIVITA'' EDITORIALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J582', 'EDIZIONE DI SOFTWARE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J591', 'ATTIVITA'' DI PRODUZIONE, POST-PRODUZIONE E DISTRIBUZIONE CINEMATOGRAFICA, DI VIDEO E DI PROGRAMMI TELEVISIVI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J592', 'ATTIVITA'' DI REGISTRAZIONE SONORA E DI EDITORIA MUSICALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J601', 'TRASMISSIONI RADIOFONICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J602', 'ATTIVITA'' DI PROGRAMMAZIONE E TRASMISSIONI TELEVISIVE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J611', 'TELECOMUNICAZIONI FISSE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J612', 'TELECOMUNICAZIONI MOBILI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J613', 'TELECOMUNICAZIONI SATELLITARI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J619', 'ALTRE ATTIVITA'' DI TELECOMUNICAZIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J620', 'PRODUZIONE DI SOFTWARE, CONSULENZA INFORMATICA E ATTIVITA'' CONNESSE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J631', 'ELABORAZIONE DEI DATI, HOSTING E ATTIVITA'' CONNESSE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007J639', 'ALTRE ATTIVITA'' DEI SERVIZI D''INFORMAZIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007K641', 'INTERMEDIAZIONE MONETARIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007K642', 'ATTIVITA'' DELLE SOCIETÀ DI PARTECIPAZIONE (HOLDING)', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007K643', 'SOCIETA'' FIDUCIARIE, FONDI E ALTRE SOCIETÀ SIMILI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007K649', 'ALTRE ATTIVITA'' DI SERVIZI FINANZIARI (ESCLUSE LE ASSICURAZIONI E I FONDI PENSIONE)', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007K651', 'ASSICURAZIONI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007K652', 'RIASSICURAZIONI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007K653', 'FONDI PENSIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007K661', 'ATTIVITA'' AUSILIARIE DEI SERVIZI FINANZIARI (ESCLUSE LE ASSICURAZIONI E I FONDI PENSIONE)', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007K662', 'ATTIVITA'' AUSILIARIE DELLE ASSICURAZIONI E DEI FONDI PENSIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007K663', 'ATTIVITA'' DI GESTIONE DEI FONDI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007L681', 'COMPRAVENDITA DI BENI IMMOBILI EFFETTUATA SU BENI PROPRI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007L682', 'AFFITTO E GESTIONE DI IMMOBILI DI PROPRIETÀ O IN LEASING', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007L683', 'ATTIVITA'' IMMOBILIARI PER CONTO TERZI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M691', 'ATTIVITA'' DEGLI STUDI LEGALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M692', 'CONTABILITÀ, CONTROLLO E REVISIONE CONTABILE, CONSULENZA IN MATERIA FISCALE E DEL LAVORO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M701', 'ATTIVITA'' DI DIREZIONE AZIENDALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M702', 'ATTIVITA'' DI CONSULENZA GESTIONALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M711', 'ATTIVITA'' DEGLI STUDI DI ARCHITETTURA, INGEGNERIA ED ALTRI STUDI TECNICI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M712', 'COLLAUDI ED ANALISI TECNICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M721', 'RICERCA E SVILUPPO SPERIMENTALE NEL CAMPO DELLE SCIENZE NATURALI E DELL''INGEGNERIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M722', 'RICERCA E SVILUPPO SPERIMENTALE NEL CAMPO DELLE SCIENZE SOCIALI E UMANISTICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M731', 'PUBBLICITA''', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M732', 'RICERCHE DI MERCATO E SONDAGGI DI OPINIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M741', 'ATTIVITA'' DI DESIGN SPECIALIZZATE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M742', 'ATTIVITA'' FOTOGRAFICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M743', 'TRADUZIONE E INTERPRETARIATO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M749', 'ALTRE ATTIVITA'' PROFESSIONALI, SCIENTIFICHE E TECNICHE NCA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007M750', 'SERVIZI VETERINARI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N771', 'NOLEGGIO DI AUTOVEICOLI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N772', 'NOLEGGIO DI BENI PER USO PERSONALE E PER LA CASA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N773', 'NOLEGGIO DI ALTRE MACCHINE, ATTREZZATURE E BENI MATERIALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N774', 'CONCESSIONE DEI DIRITTI DI SFRUTTAMENTO DI PROPRIETÀ INTELLETTUALE E PRODOTTI SIMILI (ESCLUSE LE OPERE PROTETTE DAL COPYRIGHT)', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N781', 'ATTIVITA'' DI AGENZIE DI COLLOCAMENTO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N782', 'ATTIVITA'' DELLE AGENZIE DI LAVORO TEMPORANEO (INTERINALE)', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N783', 'ALTRE ATTIVITA'' DI FORNITURA E GESTIONE DI RISORSE UMANE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N791', 'ATTIVITA'' DELLE AGENZIE DI VIAGGIO E DEI TOUR OPERATOR', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N799', 'ALTRI SERVIZI DI PRENOTAZIONE E ATTIVITA'' CONNESSE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N801', 'SERVIZI DI VIGILANZA PRIVATA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N802', 'SERVIZI CONNESSI AI SISTEMI DI VIGILANZA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N803', 'SERVIZI INVESTIGATIVI PRIVATI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N811', 'SERVIZI INTEGRATI DI GESTIONE AGLI EDIFICI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N812', 'ATTIVITA'' DI PULIZIA E DISINFESTAZIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N813', 'CURA E MANUTENZIONE DEL PAESAGGIO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N821', 'ATTIVITA'' DI SUPPORTO PER LE FUNZIONI D''UFFICIO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N822', 'ATTIVITA'' DEI CALL CENTER', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N823', 'ORGANIZZAZIONE DI CONVEGNI E FIERE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007N829', 'SERVIZI DI SUPPORTO ALLE IMPRESE NCA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007O841', 'AMMINISTRAZIONE PUBBLICA: AMMINISTRAZIONE GENERALE, ECONOMICA E SOCIALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007O842', 'SERVIZI COLLETTIVI DELLE AMMINISTRAZIONI PUBBLICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007O843', 'ASSICURAZIONE SOCIALE OBBLIGATORIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007P851', 'ISTRUZIONE PRESCOLASTICA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007P852', 'ISTRUZIONE PRIMARIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007P853', 'ISTRUZIONE SECONDARIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007P854', 'ISTRUZIONE POST-SECONDARIA UNIVERSITARIA E NON UNIVERSITARIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007P855', 'ALTRI SERVIZI DI ISTRUZIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007P856', 'ATTIVITA'' DI SUPPORTO ALL''ISTRUZIONE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007Q861', 'SERVIZI OSPEDALIERI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007Q862', 'SERVIZI DEGLI STUDI MEDICI E ODONTOIATRICI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007Q869', 'ALTRI SERVIZI DI ASSISTENZA SANITARIA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007Q871', 'STRUTTURE DI ASSISTENZA INFERMIERISTICA RESIDENZIALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007Q872', 'STRUTTURE DI ASSISTENZA RESIDENZIALE PER PERSONE AFFETTE DA RITARDI MENTALI, DISTURBI MENTALI O CHE ABUSANO DI SOSTANZE STUPEFACENTI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007Q873', 'STRUTTURE DI ASSISTENZA RESIDENZIALE PER ANZIANI E DISABILI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007Q879', 'ALTRE STRUTTURE DI ASSISTENZA SOCIALE RESIDENZIALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007Q881', 'ASSISTENZA SOCIALE NON RESIDENZIALE PER ANZIANI E DISABILI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007Q889', 'ALTRE ATTIVITA'' DI ASSISTENZA SOCIALE NON RESIDENZIALE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007R900', 'ATTIVITA'' CREATIVE, ARTISTICHE E DI INTRATTENIMENTO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007R910', 'ATTIVITA'' DI BIBLIOTECHE, ARCHIVI, MUSEI ED ALTRE ATTIVITA'' CULTURALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007R920', 'ATTIVITA'' RIGUARDANTI LE LOTTERIE, LE SCOMMESSE, LE CASE DA GIOCO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007R931', 'ATTIVITA'' SPORTIVE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007R932', 'ATTIVITA'' RICREATIVE E DI DIVERTIMENTO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007S941', 'ATTIVITA'' DI ORGANIZZAZIONI ECONOMICHE, DI DATORI DI LAVORO E PROFESSIONALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007S942', 'ATTIVITA'' DEI SINDACATI DI LAVORATORI DIPENDENTI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007S949', 'ATTIVITA'' DI ALTRE ORGANIZZAZIONI ASSOCIATIVE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007S951', 'RIPARAZIONE DI COMPUTER E DI APPARECCHIATURE PER LE COMUNICAZIONI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007S952', 'RIPARAZIONE DI BENI PER USO PERSONALE E PER LA CASA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007S960', 'ALTRE ATTIVITA'' DI SERVIZI PER LA PERSONA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007T970', 'ATTIVITA'' DI FAMIGLIE E CONVIVENZE COME DATORI DI LAVORO PER PERSONALE DOMESTICO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007T981', 'PRODUZIONE DI BENI INDIFFERENZIATI PER USO PROPRIO DA PARTE DI FAMIGLIE E CONVIVENZE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007T982', 'PRODUZIONE DI SERVIZI INDIFFERENZIATI PER USO PROPRIO DA PARTE DI FAMIGLIE E CONVIVENZE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007U990', 'ORGANIZZAZIONI ED ORGANISMI EXTRATERRITORIALI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C212', 'FABBRICAZIONE DI MEDICINALI E PREPARATI FARMACEUTICI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C221', 'FABBRICAZIONE DI ARTICOLI IN GOMMA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C222', 'FABBRICAZIONE DI ARTICOLI IN MATERIE PLASTICHE', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C231', 'FABBRICAZIONE DI VETRO E DI PRODOTTI IN VETRO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C232', 'FABBRICAZIONE DI PRODOTTI REFRATTARI', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C233', 'FABBRICAZIONE DI MATERIALI DA COSTRUZIONE IN TERRACOTTA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C234', 'FABBRICAZIONE DI ALTRI PRODOTTI IN PORCELLANA E IN CERAMICA', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C235', 'PRODUZIONE DI CEMENTO, CALCE E GESSO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C236', 'FABBRICAZIONE DI PRODOTTI IN CALCESTRUZZO, CEMENTO E GESSO', NULL, NULL);
		INSERT INTO tab5 (tab5cod, tab5tip, tab5desc, tab5mod, tab5nord) VALUES ('G_j07', '2007C237', 'TAGLIO, MODELLATURA E FINITURA DI PIETRE', NULL, NULL);		
		
		
		--Aggiornamento C0CAMPI
		-- Inserimento in C0CAMPI nuovi campi in IMPR
		delete from c0campi where c0c_mne_ber in ('G_CLADIM','G_ISCRIWL','G_WLPREFE','G_WLSEZIO','G_WLDISCRI','G_WLDSCAD','G_WLINCORSO');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CLADIM.IMPR.GENE', 'G_CLADIM', 'Classe di dimensione dell''impresa', 'Classe di dimensione', 'A100', 'G_062', NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ISCRIWL.IMPR.GENE', 'G_ISCRIWL', 'Iscritto nella white list antimafia (dpcm 18 aprile 2013)?', 'Iscr.white list?', 'A2', NULL, 'SN', 'Iscritto nella white list?');		
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'WLPREFE.IMPR.GENE', 'G_WLPREFE', 'Sede prefettura presso cui è istituita la white list antim.', 'Prefett. white list', 'A50', NULL, NULL, 'Sede prefettura competente');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'WLSEZIO.IMPR.GENE', 'G_WLSEZIO', 'Sezioni di iscrizione white list antimafia', 'Sez.iscr.white list', 'A20', NULL, NULL, 'Sezioni di iscrizione');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'WLDISCRI.IMPR.GENE', 'G_WLDISCRI', 'Data iscrizione white list antimafia', 'Data iscr.white list', 'A10', NULL, 'DATA_ELDA', 'Data iscrizione');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'WLDSCAD.IMPR.GENE', 'G_WLDSCAD', 'Data scadenza iscrizione white list antimafia', 'Data scad.iscr.wh.li', 'A10', NULL, 'DATA_ELDA', 'Data scadenza iscrizione');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'WLINCORSO.IMPR.GENE', 'G_WLINCORSO', 'Aggiornamento in corso white list antimafia?', 'Agg.in corso wh.li?', 'A2', NULL, 'SN', 'Aggiornamento in corso?');		
		
		--Reso non visibile SETATT.IMPR	
		UPDATE C0CAMPI SET C0C_TIP='C' WHERE  C0C_MNE_BER = 'SETATT';	
		--CODATT.IMPR cambiata descrizione e dimensione
		UPDATE C0CAMPI SET COC_DES='Settore attività economica (codice ATECO 2007)',COC_DES_FRM='Settore attiv.econ.',C0C_FS='A240',C0C_TAB1='G_j07',COC_DES_WEB='Settore attività economica' WHERE  C0C_MNE_BER = 'CODATT';
		
		--Aggiornamento campi SN da A1 a A2	
		UPDATE C0CAMPI SET C0C_FS='A2' WHERE  C0C_MNE_BER in ('G_ASSOBBL','G_ISMPMI','G_ISCRCCIAA');
		
		--Nuovi campi entità DURC 
		delete from c0campi where c0c_mne_ber in ('G_IDDURC','G_CODIMPDU','G_NPROTODU','G_DATRICDU','G_DATSCADU','G_TIPESIDU','G_NOTDUR');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'ID.IMPDURC.GENE', 'G_IDDURC', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODIMP.IMPDURC.GENE', 'G_CODIMPDU', 'Codice impresa', 'Codice impresa', 'A10', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'NPROTO.IMPDURC.GENE', 'G_NPROTODU', 'Numero protocollo', 'N. protocollo', 'A20', NULL, NULL, 'Numero protocollo');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DATRIC.IMPDURC.GENE', 'G_DATRICDU', 'Data di richiesta del DURC', 'Data richiesta', 'A10', NULL, 'DATA_ELDA',NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DATSCA.IMPDURC.GENE', 'G_DATSCADU', 'Data scadenza validità del DURC', 'Data scadenza', 'A10', NULL, 'DATA_ELDA','Data scadenza validità');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TIPESI.IMPDURC.GENE', 'G_TIPESIDU', 'Tipo di esito (regolare, irregolare)', 'Tipo esito', 'A100', 'G_060', NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'NOTDUR.IMPDURC.GENE', 'G_NOTDUR', 'Eventuali note', 'Note', 'A2000', NULL, 'NOTE', NULL);
		
		--Nuova view V_IMPR_VERIFICA
		delete from c0campi where c0c_mne_ber in ('G_CODIMP_V','G_DURC_REG','G_WL_REG');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'CODIMP.V_IMPR_VERIFICA.GENE', 'G_CODIMP_V', 'Codice impresa', 'Codice impresa', 'A10', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DURC_REG.V_IMPR_VERIFICA.GENE', 'G_DURC_REG', 'DURC regolare o non soggetto a obblighi DURC?', 'DURC regolare?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'WL_REG.V_IMPR_VERIFICA.GENE', 'G_WL_REG', 'Iscrizione alla white list antimafia valida?', 'Iscr.wh.list valida?', 'A2', NULL, 'SN','Iscrizione white list?');
		
		
		--Aggiornamento C0ENTIT 
		----Nuova entità DURC 
		delete from c0entit where c0e_nom in ('IMPDURC.GENE');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('IMPDURC.GENE', 0, 'E', 'IMP_DURC', 'DURC on line emessi per l''impresa', 'CODIMP.IMPDURC.GENE', 'IMPR.GENE', 'CODIMP.IMPR.GENE', NULL, NULL, 'g_idurc0');
		
		---Nuova view V_IMPR_VERIFICA 
		delete from c0entit where c0e_nom in ('V_IMPR_VERIFICA.GENE');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('V_IMPR_VERIFICA.GENE', 0, 'E', 'IMP_VERIFI', 'Dati di sintesi anagrafica impresa a scopo di verifiche', 'CODIMP.V_IMPR_VERIFICA.GENE', 'IMPR.GENE', 'CODIMP.IMPR.GENE', NULL, NULL, 'g_veri0');
		
		-- Modifica CAP comune di Rimini
		Update tabsche set tabcod4='47921' where tabcod='S2003' and tabcod1='09' and tabcod2='8355';
		
		-- Corretta definizione dei campi chiave per entità UNIMIS nel c0campi: Non risultavano definiti
		Update c0campi SET c0c_chi='P' where coc_mne_uni='CONTA.UNIMIS.GENE';
		Update c0campi SET c0c_chi='P' where coc_mne_uni='TIPO.UNIMIS.GENE';
		
		update eldaver set numver = '1.4.85', datvet = now() where codapp = 'G_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();





CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.4.85' or numver like '1.4.85.%')) THEN
		
		--Inserisce la riga relativa a IMPLEG (solamente se non è già esistente)
		if (select count(1) <= 0 from w_genchiavi where tabella = 'IMPLEG') then
			INSERT INTO w_genchiavi (tabella, chiave) VALUES ('IMPLEG', 0);
		end if;
		
		--Inserisce la riga relativa a IMPDTE (solamente se non è già esistente)
		if (select count(1) <= 0 from w_genchiavi where tabella = 'IMPDTE') then
			INSERT INTO w_genchiavi (tabella, chiave) VALUES ('IMPDTE', 0);
		end if;
		
		UPDATE TAB1 set TAB1ARC='1' WHERE TAB1COD='G_044' AND TAB1TIP=37;
		
		update eldaver set numver = '1.5.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
DECLARE
	ll_pre151_esiste_riga numeric(10) := 0;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.5.0' or numver like '1.5.0.%')) THEN
		
		-- Modifica dell'eventuale utente denominato ADMIN (diventa AdminOLD)
		update stoutesys set sysnom='!DDYz<dw8', syslogin='AdminOLD' where syscon=(select syscon from usrsys where upper(syslogin) = 'ADMIN' and syscon>50);
		update usrsys set sysute = 'Admin (OLD)', sysnom = '!DDYz<dw8', syslogin = 'AdminOLD' where upper(syslogin) = 'ADMIN' and syscon>50;
		
		-- Modifica dell'eventuale utente denominato EnteAdmin (diventa EnteAdminOLD)
		update stoutesys set sysnom='!DDYz<dw8E/z:', syslogin='EnteAdminOLD' where syscon=(select syscon from usrsys where upper(syslogin) = 'ENTEADMIN' and syscon>50);
		update usrsys set sysute = 'EnteAdmin (OLD)', sysnom = '!DDYz<dw8E/z:', syslogin = 'EnteAdminOLD' where upper(syslogin) = 'ENTEADMIN' and syscon>50;
		
		-- Utenti di default precaricati in USRSYS: Inserimento nuovo utente "48 - ADMIN" (include "ou89", non include "ou39" e SYSDISAB=NULL)
		select count(1) into ll_pre151_esiste_riga from usrsys where syscon=48;
		if (ll_pre151_esiste_riga <= 0) then
			INSERT INTO usrsys (syscon, sysute, sysnom, syspwd, sysdat, sysab1, sysab2, sysab3, sysliv, syspwbou, codimp, impimp, sysabg, syslig, sysabc, syslic, sysabu, codtec, abilap, syspri, codtei, uducla1, flag_ldap, dn, syscongrp, sysdisab, email, sysscad, sysuffapp, emailpec, meruolo, syscateg, syscf, syslogin) VALUES (48, 'ADMIN', '!G_)Li', '!G_)Li', NULL, NULL, NULL, 'A', 0, 'ou8|ou11|ou91|ou1|ou43|ou13|ou48|ou50|ou56|ou59|ou62|ou89|', NULL, 0, 'A', 0, 'NDEFM', 0, '$'||'$'||'22', NULL, NULL, NULL, NULL, NULL, 0, NULL, 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'ADMIN');
		end if;
		
		-- Utenti di default precaricati in USRSYS: Inserimento nuovo utente "49 - EnteAdmin" (include "ou89", include "ou39" e SYSDISAB='1')
		select count(1) into ll_pre151_esiste_riga from usrsys where syscon=49;
		if (ll_pre151_esiste_riga <= 0) then
		end if;
		
		-- Utenti di default precaricati in USRSYS:  Modifica vecchio utente "50 - MANAGER" (adesso non include "ou89" ed include "ou39")
		UPDATE usrsys SET syspwbou=REPLACE(syspwbou,'ou89|','') WHERE (syscon=50);
		UPDATE usrsys set syspwbou=syspwbou||'ou39|' WHERE syscon=50 and (POSITION('ou39|' in syspwbou)<=0);
		UPDATE usrsys set sysute='MANAGER', syslogin='MANAGER' WHERE syscon=50 and sysute='Super Utente';
		
		-- Modifica del dato tabellato relativo a "Giorni di validità password (sicurezza)" impostando "90" giorni qualora sia superiore
		update tab1 set tab1desc = '90' where tab1cod='G_048' and tab1tip=1 and CAST(tab1desc AS INT)>90;
		
		-- definizione tabella storico utenti rimossi
		CREATE TABLE USRCANC (ID NUMERIC(12) not null, SYSCON NUMERIC(12) not null, SYSLOGIN VARCHAR(60) not null, SYSSCAD TIMESTAMP not null, primary key (ID));
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('USRCANC.GENE', 6800111, 'E', 'USRCANC', 'Storico utenti amministratori rimossi', 'ID.USRCANC.GENE', NULL, NULL, NULL, NULL, 'g_usrca0');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (048001300, 'E', 'P', 'ID.USRCANC.GENE', 'USCAID', 'Id registrazione', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (048001301, 'E', NULL, 'SYSCON.USRCANC.GENE', 'USCASYSCON', 'Codice utente', 'Codice utente', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (048001302, 'E', NULL, 'SYSLOGIN.USRCANC.GENE', 'USCASYLOGIN', 'Login', 'Login', 'A60', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (048001303, 'E', NULL, 'SYSDATCANC.USRCANC.GENE ', 'USCADATCANC', 'Data eliminazione', 'Data eliminazione', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO w_genchiavi (tabella, chiave) VALUES ('USRCANC',0);

		-- Aggiunta nuovi comuni
		Delete from tabsche where tabcod='S2003' and tabcod1='09' and tabcod3 in ('008033049', '006030190', '006030191', '007008068', '003013254', '003097093', '003098062', '003020072', '001006192', '001006191', '001002170', '001002171', '009051042', '009049021', '004022250','005024124','005028107');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8624', 'ALTA VAL TIDONE', '008033049', '29010', 'M386');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8625', 'FIUMICELLO VILLA VICENTINA', '006030190', '33050', 'M399');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8626', 'TREPPO LIGOSULLO', '006030191', '33020', 'M400');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8627', 'MONTALTO CARPASIO', '007008068', '18010', 'M387');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8628', 'CENTRO VALLE INTELVI', '003013254', '22028', 'M394');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8629', 'VALVARRONE', '003097093', '23836', 'M395');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8630', 'CASTELGERUNDO', '003098062', '26823', 'M393');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8631', 'BORGO MANTOVANO', '003020072', '46036', 'M396');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8632', 'ALLUVIONI PIOVERA', '001006192', '15040', 'M397');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8633', 'CASSANO SPINOLA', '001006191', '15063', 'M388');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8634', 'ALTO SERMENZA', '001002170', '13026', 'M389');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8635', 'CELLIO CON BREIA', '001002171', '13024', 'M398');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8636', 'LATERINA PERGINE VALDARNO', '009051042', '52020', 'M392');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8637', 'RIO', '009049021', '57039', 'M391');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8638', 'SEN JAN DI FASSA', '004022250', '38036', 'M390');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8639', 'BARBARANO MOSSANO', '005024124', '36021', 'M401');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8640', 'BORGO VENETO', '005028107', '35046', 'M402');
		
		-- delete G_022 rimasti con il valore di default delle precedenti installazioni
		delete from tab1 where tab1cod='G_022' and tab1tip =1 and tab1desc='Uffico appartenenza  A';
		delete from tab1 where tab1cod='G_022' and tab1tip =2 and tab1desc='Ufficio appartenenza B';
		delete from tab1 where tab1cod='G_022' and tab1tip =3 and tab1desc='Ufficio appartenenza C';
		delete from tab1 where tab1cod='G_022' and tab1tip =4 and tab1desc='Ufficio appartenenza D';
		delete from tab1 where tab1cod='G_022' and tab1tip =5 and tab1desc='Ufficio appartenenza E';
		delete from tab1 where tab1cod='G_022' and tab1tip =6 and tab1desc='Ufficio appartenenza F';
	
		
		update eldaver set numver = '1.5.1', datvet = now() where codapp = 'G_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.5.1' or numver like '1.5.1.%')) THEN
		
		--delete G_059 rimasti al valore di default delle precedenti installazioni
		delete from tab1 where tab1cod='G_059' and tab1tip =1 and tab1desc='Categoria 1';
		delete from tab1 where tab1cod='G_059' and tab1tip =2 and tab1desc='Categoria 2';
	
		-- Join di TECNI ed IMPR con tabelle di SITAT e Programmi triennali
		Delete from c0entit where c0e_nom in ('TECNI.GENE#28','TECNI.GENE#29','TECNI.GENE#30','TECNI.GENE#31','TECNI.GENE#32','IMPR.GENE#33','IMPR.GENE#34','IMPR.GENE#35');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('TECNI.GENE#28', 0, 'C', NULL, 'Archivio Tecnici Esterni', 'CODTEC.TECNI.GENE', 'W9INCA.W9', 'CODTEC.W9INCA.W9', NULL, NULL, 'g_tece0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('TECNI.GENE#29', 0, 'C', NULL, 'Archivio Tecnici Esterni', 'CODTEC.TECNI.GENE', 'W9GARA.W9', 'RUP.W9GARA.W9INCA.W9', NULL, NULL, 'g_tece0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('TECNI.GENE#30', 0, 'C', NULL, 'Archivio Tecnici Esterni', 'CODTEC.TECNI.GENE', 'W9LOTT.W9', 'RUP.W9LOTT.W9INCA.W9', NULL, NULL, 'g_tece0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('TECNI.GENE#31', 0, 'C', NULL, 'Archivio Tecnici Esterni', 'CODTEC.TECNI.GENE', 'PIATRI.PIANI', 'RESPRO.PIATRI.PIANI', NULL, NULL, 'g_tece0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('TECNI.GENE#32', 0, 'C', NULL, 'Archivio Tecnici Esterni', 'CODTEC.TECNI.GENE', 'INTTRI.PIANI', 'CODRUP.INTTRI.PIANI', NULL, NULL, 'g_tece0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('IMPR.GENE#33', 0, 'C', NULL, 'Anagrafico delle IMPRESE', 'CODIMP.IMPR.GENE', 'W9AGGI.W9', 'CODIMP_AUSILIARIA.W9AGGI.W9', NULL, NULL, 'g_impr0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('IMPR.GENE#34', 0, 'C', NULL, 'Anagrafico delle IMPRESE', 'CODIMP.IMPR.GENE', 'W9IMPRESE.W9', 'CODIMP.W9IMPRESE.W9', NULL, NULL, 'g_impr0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('IMPR.GENE#35', 0, 'C', NULL, 'Anagrafico delle IMPRESE', 'CODIMP.IMPR.GENE', 'W9SUBA.W9', 'CODIMP.W9SUBA.W9', NULL, NULL, 'g_impr0');

		update eldaver set numver = '1.5.2', datvet = now() where codapp = 'G_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.5.2' or numver like '1.5.2.%')) THEN
		
		-- Nuovi campi IMPR per ART.80
		ALTER TABLE IMPR ADD art80_stato NUMERIC(7);
		ALTER TABLE IMPR ADD art80_data_richiesta TIMESTAMP;
		ALTER TABLE IMPR ADD art80_data_lettura TIMESTAMP;

		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ART80_STATO.IMPR.GENE', 'G_A80STATO', 'Stato documentale', 'Stato documentale', 'A100', 'G_063', NULL, 'Stato documentale');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ART80_DATA_RICHIESTA.IMPR.GENE', 'G_A80DRICH', 'Data invio anagrafica', 'Data invio', 'A10', NULL, 'DATA_ELDA', 'Data invio anagrafica');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ART80_DATA_LETTURA.IMPR.GENE', 'G_A80DLETT', 'Data ultima lettura stato', 'Data lett. stato', 'A10', NULL, 'DATA_ELDA', 'Data ultima lettura stato');		
		
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_063', 1, 'In lavorazione', NULL, 1);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_063', 2, 'Non anomalo', NULL, 2);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_063', -1, 'Anomalo', NULL, 3);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_063', 10, 'Anagrafica inviata', NULL, 10);	
		
		update eldaver set numver = '1.5.3', datvet = now() where codapp = 'G_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.5.3' or numver like '1.5.3.%')) THEN
		
		-- Nuovo campo di IMPR per codice BIC
		ALTER TABLE IMPR ADD CODBIC VARCHAR(11) null;

                ALTER TABLE TABNUTS ADD SIGLAPROV VARCHAR(5) null;

                --Aggiornamento del campo TABNUTS.SIGLAPROV con i valori di TAB3COD=Agx15
                UPDATE TABNUTS set siglaprov=(select tab3tip from tab3 where tab3cod='Agx15' and upper(tab3desc)=upper(descrizione));
                --Si deve procedere all'aggiornamento manuale di alcuni campi per cui non c'è corrispondenza fra le descrizioni nelle due tabelle
                UPDATE TABNUTS set SIGLAPROV='VB' where codice='ITC14';
                UPDATE TABNUTS set SIGLAPROV='AO' where codice='ITC20';
                UPDATE TABNUTS set SIGLAPROV='RC' where codice='ITF65';
                UPDATE TABNUTS set SIGLAPROV='OT' where codice='ITG29';
                UPDATE TABNUTS set SIGLAPROV='CI' where codice='ITG2C';
                UPDATE TABNUTS set SIGLAPROV='BZ' where codice='ITH10';
                UPDATE TABNUTS set SIGLAPROV='RE' where codice='ITH53';
                UPDATE TABNUTS set SIGLAPROV='FO' where codice='ITH58';
                UPDATE TABNUTS set SIGLAPROV='MS' where codice='ITI11';

		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODBIC.IMPR.GENE', 'G_CODBIC', 'Conto corrente dedicato: codice BIC (o SWIFT)', 'Coord.banc.:cod.BIC', 'A11', NULL, NULL, 'Conto corrente dedicato:codice BIC');
		UPDATE c0campi set  coc_des='Conto corrente dedicato: codice IBAN', coc_des_frm='Coord.banc.:cod.IBAN', coc_des_web='Conto corrente dedicato:codice IBAN' where c0c_mne_ber='G_COORBA';
		
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'P', NULL, 'SIGLAPROV.TABNUTS.GENE', 'NUTSPROVSI', 'Sigla della provincia', 'Sigla provincia', 'A5', NULL, NULL, NULL);

		update eldaver set numver = '1.5.4', datvet = now() where codapp = 'G_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.5.4' or numver like '1.5.4.%')) THEN
		
		Update C0CAMPI set c0c_tip='E' where coc_mne_uni in ('CGENTEI.TECNI.GENE','CGENUTE.UTENT.GENE','CGENIMP.IMPR.GENE','CGENTIM.TEIM.GENE');

		if (select count(*)=0 from tabsche where tabcod='S2003' and tabcod1='09' and tabcod2='8641')
		then
			INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8641', 'CASALI DEL MANCO', '018078156', '87050', 'M385');
		end if;

		update eldaver set numver = '1.5.5', datvet = now() where codapp = 'G_';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and (numver = '1.5.5' or numver like '1.5.5.%')) THEN
		
		ALTER TABLE UFFINT ADD CODIPA VARCHAR(20);
		ALTER TABLE IMPR ADD COGNOME VARCHAR(80);
		ALTER TABLE IMPR ADD NOME VARCHAR(80);
                
		--Aggiornamento C0CAMPI
        INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODIPA.UFFINT.GENE', 'G_CODIPA', 'Codice iPA (indice delle Pubbliche Amministrazioni)', 'Codice iPA', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'COGNOME.IMPR.GENE', 'G_COGNIMPR', 'Cognome dell''impresa', 'Cognome', 'A80', NULL, NULL, 'Cognome');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'NOME.IMPR.GENE', 'G_NOMIMPR', 'Nome dell''impresa', 'Nome', 'A80', NULL, NULL, 'Nome');
		
		if (select count(1) <=0 from c0entit where c0e_nom='UFFINT.GENE#6' and c0e_key='CODEIN.UFFINT.GENE' and c0e_nom_ex='PIATRI.PIANI' and coe_key_ex='CENINT.PIATRI.PIANI') then
			INSERT INTO c0entit (c0e_nom,c0e_num,c0e_tip,coe_arg,c0e_des,c0e_key,c0e_nom_ex,coe_key_ex,c0e_frm_ri,coe_frm_ca,coe_frm_re) VALUES ('UFFINT.GENE#6',88020110,'C',null,null,'CODEIN.UFFINT.GENE','PIATRI.PIANI','CENINT.PIATRI.PIANI',null,null,'g_10uffi');
		end if;
		
		update eldaver set numver = '1.6.0', datvet = now() where codapp = 'G_';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
	DECLARE maxtip INT;
	DECLARE conta INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.6.%') THEN
		
		--Nuova tipologia 'Impresa sociale' - sposta in coda eventuali valori del tabellato Ag008 con TAB1TIP=13
		if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='Ag008' and TAB1TIP=13 and (TAB1DESC is null or TAB1DESC!='Impresa sociale (art.45 c.2/a DLgs 50/2016)')) = 1) then
			maxtip := 0;
			SELECT MAX(TAB1TIP) INTO maxtip FROM TAB1 WHERE TAB1COD='Ag008';
			conta := maxtip + 1;
			UPDATE TAB1 SET TAB1TIP=conta WHERE TAB1COD='Ag008' and TAB1TIP=13;
			IF exists (select tablename from pg_tables where upper(tablename) = 'GARE') THEN
				conta := maxtip + 1;
				UPDATE DOCUMGARA SET CONTESTOVAL=conta WHERE CONTESTOVAL=13;
				UPDATE ARCHDOCG SET CONTESTOVAL=conta WHERE CONTESTOVAL=13;
			END IF;
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag008', 13, 'Impresa sociale (art.45 c.2/a DLgs 50/2016)', '1', 2);
		end if;

		UPDATE tab1 set tab1nord=3 where tab1cod='Ag008' and tab1tip=2;
		UPDATE tab1 set tab1nord=4 where tab1cod='Ag008' and tab1tip=3;
		UPDATE tab1 set tab1nord=6 where tab1cod='Ag008' and tab1tip=5;
		UPDATE tab1 set tab1nord=7 where tab1cod='Ag008' and tab1tip=6;
		UPDATE tab1 set tab1nord=9 where tab1cod='Ag008' and tab1tip=7;
		UPDATE tab1 set tab1nord=10 where tab1cod='Ag008' and tab1tip=8;
		UPDATE tab1 set tab1nord=11 where tab1cod='Ag008' and tab1tip=9;
		UPDATE tab1 set tab1nord=12 where tab1cod='Ag008' and tab1tip=10;
		UPDATE tab1 set tab1nord=13 where tab1cod='Ag008' and tab1tip=11;
		UPDATE tab1 set tab1nord=8 where tab1cod='Ag008' and tab1tip=12;

		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_045', 2, '1   obbligatoria per Impresa sociale(0) non obbligatoria(1)', NULL, 0);
		UPDATE tab1 SET tab1desc=substr(tab1desc,1,1)||'   obbligatoria per Libero professionista(0) non obbligatoria(1)' where tab1cod='G_045' and tab1tip=1;
		UPDATE tab4 SET tab4desc='Partita IVA obbligatoria per tipologia impresa' WHERE tab4cod='G__1' and tab4tip='G_045';

		update eldaver set numver = '1.7.0', datvet = now() where codapp = 'G_';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
	DECLARE maxtip INT;
	DECLARE conta INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.7.%') THEN
		-- aumento campo DN a 2000 caratteri
		ALTER TABLE usrsys ALTER COLUMN dn type varchar(2000);

		update eldaver set numver = '1.8.0', datvet = now() where codapp = 'G_';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.8.%') THEN
		-- esteso campo CODFE a 7 caratteri
		ALTER TABLE UFFINT ALTER COLUMN CODFE type varchar(7);
		ALTER TABLE PUNTICON ALTER COLUMN CODFE type varchar(7);
		
		UPDATE C0CAMPI set COC_DES='Codice Univoco Ufficio o cod.destinat. per fatturaz.elettr.',C0C_FS='A7',COC_DES_WEB='Codice Univoco Ufficio o codice destinatario per fatturazione elettronica' where C0C_MNE_BER = 'G_CODFE';
		UPDATE C0CAMPI set COC_DES='Codice Univoco Ufficio o cod.destinat. per fatturaz.elettr.',C0C_FS='A7',COC_DES_WEB='Codice Univoco Ufficio o codice destinatario per fatturazione elettronica' where C0C_MNE_BER = 'G_CODFEPC';

		--Forzato inserimento voci vers.1.6.0 erroneamente non inserite in inizializzazione
		delete from c0campi where c0c_mne_ber in ('G_COGNIMPR','G_NOMIMPR');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'COGNOME.IMPR.GENE', 'G_COGNIMPR', 'Cognome dell''impresa', 'Cognome', 'A80', NULL, NULL, 'Cognome');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'NOME.IMPR.GENE', 'G_NOMIMPR', 'Nome dell''impresa', 'Nome', 'A80', NULL, NULL, 'Nome');

		update eldaver set numver = '1.9.0', datvet = now() where codapp = 'G_';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.9.%') THEN

		Delete from TABSCHE where tabcod='S2003' and tabcod1='09' and tabcod2 in ('8642');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8642', 'CORIGLIANO-ROSSANO', '018078157', '87064', 'M403');

		-- fix errori sulle descrizioni introdotte con l'aggiornamento alla 1.4.84 causa codifica UTF8 del file di aggiornamento
		DELETE FROM TABNUTS WHERE CODICE IN ('ITC2', 'ITC20', 'ITF11', 'ITH53', 'ITH58');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE,SIGLAPROV) VALUES ('ITC2','IT','C','2',NULL,'Valle d''Aosta / Vallée d''Aoste',NULL);
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE,SIGLAPROV) VALUES ('ITC20','IT','C','2','0','Valle d''Aosta / Vallée d''Aoste','AO');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE,SIGLAPROV) VALUES ('ITF11','IT','F','1','1','L''Aquila','AQ');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE,SIGLAPROV) VALUES ('ITH53','IT','H','5','3','Reggio nell''Emilia','RE');
		INSERT INTO TABNUTS (CODICE,PAESE,AREA,REGIONE,PROVINCIA,DESCRIZIONE,SIGLAPROV) VALUES ('ITH58','IT','H','5','8','Forlì-Cesena','FO');

		Delete from tabsche where tabcod='S2003' and tabcod1='09' and tabcod3 in ('001103079','001001317','003020073','004022251','009048054','008038030','008038029','008034051','003013255','011041071','001096087','001001318','001003166','001096088','003019116','003018193');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8643', 'VALLE CANNOBINA', '001103079', '28825', 'M404');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8644', 'VAL DI CHY', '001001317', '10010', 'M405');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8645', 'BORGOCARBONARA  ', '003020073', '46020', 'M406');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8646', 'TERRE D''ADIGE', '004022251', '38010', 'M407');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8647', 'BARBERINO TAVARNELLE', '009048054', '50028', 'M408');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8648', 'TRESIGNANA', '008038030', '44035', 'M409');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8649', 'RIVA DEL PO', '008038029', '44030', 'M410');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8650', 'SORBOLO MEZZANI', '008034051', '43058', 'M411');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8651', 'SOLBIATE CON CAGNO', '003013255', '22070', 'M412');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8652', 'SASSOCORVARO AUDITORE', '011041071', '61028', 'M413');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8653', 'QUAREGNA CERRETO ', '001096087', '13854', 'M414');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8654', 'VALCHIUSA', '001001318', '10080', 'M415');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8655', 'GATTICO-VERUNO', '001003166', '28013', 'M416');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8656', 'VALDILANA  ', '001096088', '13825', 'M417');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8657', 'PIADENA DRIZZONA', '003019116', '26034', 'M418');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8658', 'COLLI VERDI', '003018193', '27040', 'M419');

		update eldaver set numver = '1.10.0', datvet = now() where codapp = 'G_';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.10.%') THEN

		--Aggiunge o aggiorna nuovi comuni 
		Delete from tabsche where tabcod='S2003' and tabcod1='09' and tabcod3 in ('003020061','003020057','003015251','003012143','001006193','005025074','005026096','005024125');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '3055', 'SERMIDE E FELONICA', '003020061', '46028', 'I632');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '3051', 'SAN GIORGIO BIGARELLO', '003020057', '46030', 'H883');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8659', 'VERMEZZO CON ZELO', '003015251', '20080', 'M424');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8660', 'CADREZZATE CON OSMATE', '003012143', '21020', null);
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8661', 'LU E CUCCARO MONFERRATO', '001006193', '15040', 'M420');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8662', 'BORGO VALBELLUNA', '005025074', '32026', 'M421');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8663', 'PIEVE DEL GRAPPA', '005026096', '31017', 'M422');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8664', 'VALBRENTA', '005024125', '36020', 'M423');
		
		Update tabsche set tabcod5='D066',tabdesc='CORTENUOVA' where tabcod='S2003' and tabcod1='09' and tabcod3='003016083';
		Update tabsche set tabcod5='D065',tabdesc='CORTENOVA' where tabcod='S2003' and tabcod1='09' and tabcod3='003097025';
		Update tabsche set tabcod5='G416',tabdesc='PEGLIO (PU)' where tabcod='S2003' and tabcod1='09' and tabcod3='011041041';
		Update tabsche set tabcod5='A165' where tabcod='S2003' and tabcod1='09' and tabcod3='007009003';
		Update tabsche set tabcod5='A581' where tabcod='S2003' and tabcod1='09' and tabcod3='007008007';
		Update tabsche set tabcod5='A618' where tabcod='S2003' and tabcod1='09' and tabcod3='003015250';
		Update tabsche set tabcod5='A710' where tabcod='S2003' and tabcod1='09' and tabcod3='010054002';
		Update tabsche set tabcod5='B184' where tabcod='S2003' and tabcod1='09' and tabcod3='003017030';
		Update tabsche set tabcod5='B185' where tabcod='S2003' and tabcod1='09' and tabcod3='004022028';
		Update tabsche set tabcod5='B259' where tabcod='S2003' and tabcod1='09' and tabcod3='006030013';
		Update tabsche set tabcod5='B385' where tabcod='S2003' and tabcod1='09' and tabcod3='019081003';
		Update tabsche set tabcod5='B418' where tabcod='S2003' and tabcod1='09' and tabcod3='001005014';
		Update tabsche set tabcod5='B419' where tabcod='S2003' and tabcod1='09' and tabcod3='004022035';
		Update tabsche set tabcod5='M311' where tabcod='S2003' and tabcod1='09' and tabcod3='006030138';
		Update tabsche set tabcod5='C337' where tabcod='S2003' and tabcod1='09' and tabcod3='003016065';
		Update tabsche set tabcod5='M261' where tabcod='S2003' and tabcod1='09' and tabcod3='016075096';
		Update tabsche set tabcod5='M308' where tabcod='S2003' and tabcod1='09' and tabcod3='005027044';
		Update tabsche set tabcod5='E623' where tabcod='S2003' and tabcod1='09' and tabcod3='003013130';
		Update tabsche set tabcod5='E624' where tabcod='S2003' and tabcod1='09' and tabcod3='004022106';
		Update tabsche set tabcod5='F910' where tabcod='S2003' and tabcod1='09' and tabcod3='018079087';
		Update tabsche set tabcod5='G232' where tabcod='S2003' and tabcod1='09' and tabcod3='012057048';
		Update tabsche set tabcod5='G415' where tabcod='S2003' and tabcod1='09' and tabcod3='003013178';
		Update tabsche set tabcod5='H224' where tabcod='S2003' and tabcod1='09' and tabcod3='018080063';
		Update tabsche set tabcod5='H223' where tabcod='S2003' and tabcod1='09' and tabcod3='008035033';
		Update tabsche set tabcod5='H396' where tabcod='S2003' and tabcod1='09' and tabcod3='003018125';
		Update tabsche set tabcod5='H754' where tabcod='S2003' and tabcod1='09' and tabcod3='004022165';
		Update tabsche set tabcod5='H753' where tabcod='S2003' and tabcod1='09' and tabcod3='001001235';
		Update tabsche set tabcod5='I162' where tabcod='S2003' and tabcod1='09' and tabcod3='003013248';
		Update tabsche set tabcod5='I328' where tabcod='S2003' and tabcod1='09' and tabcod3='019083090';
		Update tabsche set tabcod5='I329' where tabcod='S2003' and tabcod1='09' and tabcod3='020090092';
		Update tabsche set tabcod5='I138' where tabcod='S2003' and tabcod1='09' and tabcod3='007008055';
		Update tabsche set tabcod5='I778' where tabcod='S2003' and tabcod1='09' and tabcod3='020095078';
		Update tabsche set tabcod5='L658' where tabcod='S2003' and tabcod1='09' and tabcod3='019087052';
		Update tabsche set tabcod5='L659' where tabcod='S2003' and tabcod1='09' and tabcod3='003018170';
		
		--Nuova provincia 'Sud Sardegna'
		INSERT INTO tab3 (tab3cod, tab3tip, tab3desc, tab3mod, tab3nord) VALUES ('Agx15', 'SU', 'Sud Sardegna', NULL, NULL);
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '07', '0111', 'SUD SARDEGNA', 'SU', NULL, NULL);
		--Archivia le province soppresse
		Update tab3 set tab3arc='1' where tab3cod='Agx15' and tab3tip='CI';
		Update tab3 set tab3arc='1' where tab3cod='Agx15' and tab3tip='OT';
		Update tab3 set tab3arc='1' where tab3cod='Agx15' and tab3tip='VS';
		Update tab3 set tab3arc='1' where tab3cod='Agx15' and tab3tip='OG';

		update eldaver set numver = '1.11.0', datvet = now() where codapp = 'G_';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.11.%') THEN

		perform sp_backupanddropviews('impr');
		ALTER TABLE IMPR ALTER COLUMN WLSEZIO TYPE VARCHAR(100);
		perform sp_restoreviews('impr');

		-- Aggiunge tabellato 'Impresa sociale', non inserito in seguito a errore nell'aggiornamento alla versione 1.7.0
		if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='Ag008' and TAB1TIP=13 and TAB1DESC='Impresa sociale (art.45 c.2/a DLgs 50/2016)') = 0) then
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag008', 13, 'Impresa sociale (art.45 c.2/a DLgs 50/2016)', NULL, 2);
		end if;

		update c0campi set c0c_fs='A100' where c0c_mne_ber='G_WLSEZIO';

		update eldaver set numver = '1.12.0', datvet = now() where codapp = 'G_';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.12.%') THEN

			update cais set quaobb='1' where (caisim like 'OG%' or caisim like 'OS%') and tiplavg=1;
			update cais set acontec='1' where caisim='OS12B';

                        Delete from TABSCHE where tabcod='S2003' and tabcod1='09' and tabcod3 in ('005024126','005024127');
			INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8665', 'COLCERESA', '005024126', '36060', 'M426');
			INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8666', 'LUSIANA CONCO', '005024127', '36046', 'M427');

			Update ELDAVER set NUMVER = '1.13.0', datvet = now() where codapp = 'G_';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();




CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.13.%') THEN
		
		Update C0ENTIT set COE_KEY_EX = 'RUP.W9GARA.W9' where C0E_NOM = 'TECNI.GENE#29';
		Update C0ENTIT set COE_KEY_EX = 'RUP.W9LOTT.W9' where C0E_NOM = 'TECNI.GENE#30';

		--- Tabellato per la conversione del codice nazione NAZIMP (Ag010) nel codice ISO_3166-1_alpha-2
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','16', 'AD','Andorra');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','17', 'AE','Emirati Arabi Uniti');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','18', 'AF','Afghanistan');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','19', 'AG','Antigua e Barbuda');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','20', 'AI','Anguilla');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','21', 'AL','Albania');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','22', 'AM','Armenia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','23', 'AN','Antille Olandesi');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','24', 'AO','Angola');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','25', 'AQ','Antartico');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','26', 'AR','Argentina');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','27', 'AS','Samoa Americane');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','2',  'AT','Austria');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','28', 'AU','Australia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','29', 'AW','Aruba');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','30', 'AX','Isole Aland');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','31', 'AZ','Azerbaigian');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','32', 'BA','Bosnia-Erzegovina');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','33', 'BB','Barbados');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','34', 'BD','Bangladesh');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','3',  'BE','Belgio');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','35', 'BF','Burkina Faso');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','36', 'BG','Bulgaria');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','37', 'BH','Bahrain');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','38', 'BI','Burundi');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','39', 'BJ','Benin');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','40', 'BL','Saint-Barthelemy');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','41', 'BM','Bermuda');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','42', 'BN','Brunei');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','43', 'BO','Bolivia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','44', 'BR','Brasile');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','45', 'BS','Bahamas');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','46', 'BT','Bhutan');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','47', 'BV','Isola Bouvet');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','48', 'BW','Botswana');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','49', 'BY','Bielorussia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','50', 'BZ','Belize');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','51', 'CA','Canada');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','52', 'CC','Isole Cocos');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','53', 'CD','Repubblica Democratica del Congo');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','54', 'CF','Repubblica Centrafricana');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','55', 'CG','Repubblica del Congo');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','56', 'CH','Svizzera');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','57', 'CI','Costa d''Avorio');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','58', 'CK','Isole Cook');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','59', 'CL','Cile');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','60', 'CM','Camerun');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','61', 'CN','Cina');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','62', 'CO','Colombia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','63', 'CR','Costa Rica');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','64', 'CU','Cuba');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','65', 'CV','Capo Verde');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','66', 'CX','Isola Christmas');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','67', 'CY','Cipro');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','68', 'CZ','Repubblica Ceca');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','7',  'DE','Germania');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','69', 'DJ','Gibuti');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','4',  'DK','Danimarca');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','70', 'DM','Dominica');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','71', 'DO','Repubblica Dominicana');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','72', 'DZ','Algeria');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','73', 'EC','Ecuador');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','74', 'EE','Estonia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','75', 'EG','Egitto');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','76', 'EH','Sahara Occidentale');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','77', 'ER','Eritrea');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','14', 'ES','Spagna');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','78', 'ET','Etiopia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','5',  'FI','Finlandia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','79', 'FJ','Figi');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','80', 'FK','Isole Falkland');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','81', 'FM','Stati Federati di Micronesia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','82', 'FO','Isole Faorer');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','6',  'FR','Francia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','83', 'GA','Gabon');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','13', 'GB','Regno Unito');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','84', 'GD','Grenada');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','85', 'GE','Georgia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','86', 'GF','Guyana Francese');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','87', 'GG','Guernsey');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','88', 'GH','Ghana');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','89', 'GI','Gibilterra');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','90', 'GL','Groenlandia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','91', 'GM','Gambia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','92', 'GN','Guinea');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','93', 'GP','Guadalupa');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','94', 'GQ','Guinea Equatoriale');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','8',  'GR','Grecia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','95', 'GS','Georgia del Sud e isole Sandwich meridionali');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','96', 'GT','Guatemala');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','97', 'GU','Guam');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','98', 'GW','Guinea-Bissau');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','247','GY','Guyana');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','100','HK','Hong Kong');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','101','HM','Isole Heard e McDonald');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','102','HN','Honduras');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','103','HR','Croazia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','104','HT','Haiti');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','105','HU','Ungheria');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','106','ID','Indonesia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','9',  'IE','Irlanda');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','107','IL','Israele');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','108','IM','Isola di Man');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','109','IN','India');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','110','IO','Territori Britannici dell''Oceano Indiano');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','111','IQ','Iraq');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','112','IR','Iran');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','113','IS','Islanda');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','114','JE','Jersey');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','115','JM','Giamaica');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','116','JO','Giordania');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','117','JP','Giappone');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','118','KE','Kenya');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','119','KG','Kirghizistan');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','120','KH','Cambogia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','121','KI','Kiribati');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','122','KM','Comore');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','123','KN','Saint Kitts e Nevis');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','124','KP','Corea del Nord');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','125','KR','Corea del Sud');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','126','KW','Kuwait');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','127','KY','Isole Cayman');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','128','KZ','Kazakistan');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','129','LA','Laos');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','130','LB','Libano');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','131','LC','Santa Lucia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','132','LI','Liechtenstein');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','133','LK','Sri Lanka');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','134','LR','Liberia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','135','LS','Lesotho');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','136','LT','Lituania');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','10', 'LU','Lussemburgo');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','137','LV','Lettonia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','138','LY','Libia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','139','MA','Marocco');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','140','MC','Monaco');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','141','MD','Moldavia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','142','ME','Montenegro');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','143','MF','Saint-Martin');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','144','MG','Madagascar');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','145','MH','Isole Marshall');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','146','MK','Macedonia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','147','ML','Mali');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','148','MM','Birmania');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','149','MN','Mongolia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','150','MO','Macao');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','151','MP','Isole Marianne Settentrionali');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','152','MQ','Martinica');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','153','MR','Mauritania');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','154','MS','Montserrat');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','155','MT','Malta');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','156','MU','Mauritius');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','157','MV','Maldive');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','158','MW','Malawi');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','159','MX','Messico');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','160','MY','Malesia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','161','MZ','Mozambico');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','162','NA','Namibia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','163','NC','Nuova Caledonia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','164','NE','Niger');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','165','NF','Isola Norfolk');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','166','NG','Nigeria');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','167','NI','Nicaragua');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','11', 'NL','Olanda');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','168','NO','Norvegia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','169','NP','Nepal');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','170','NR','Nauru');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','171','NU','Niue');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','172','NZ','Nuova Zelanda');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','173','OM','Oman');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','174','PA','Panama');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','175','PE','Peru''');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','176','PF','Polinesia Francese');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','177','PG','Papua Nuova Guinea');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','178','PH','Filippine');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','179','PK','Pakistan');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','180','PL','Polonia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','181','PM','Saint Pierre e Miquelon');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','182','PN','Isole Pitcairn');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','183','PR','Porto Rico');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','184','PS','Territori Palestinesi Occupati');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','12', 'PT','Portogallo');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','185','PW','Palau');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','186','PY','Paraguay');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','187','QA','Qatar');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','188','RE','Reunion');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','189','RO','Romania');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','190','RS','Serbia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','191','RU','Russia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','192','RW','Ruanda');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','193','SA','Arabia Saudita');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','194','SB','Isole Salomone');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','195','SC','Seychelles');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','196','SD','Sudan');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','15', 'SE','Svezia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','197','SG','Singapore');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','198','SH','Sant''Elena');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','199','SI','Slovenia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','200','SJ','Svalbard');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','201','SK','Slovacchia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','202','SL','Sierra Leone');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','203','SM','San Marino');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','204','SN','Senegal');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','205','SO','Somalia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','206','SR','Suriname');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','207','ST','Sao Tome''e Principe');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','208','SV','El Salvador');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','209','SY','Siria');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','210','SZ','Swaziland');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','211','TC','Isole Turks e Caicos');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','212','TD','Ciad');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','213','TF','Territori Francesi del Sud');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','214','TG','Togo');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','215','TH','Thailandia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','216','TJ','Tagikistan');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','217','TK','Tokelau');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','218','TL','Timor Est');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','219','TM','Turkmenistan');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','220','TN','Tunisia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','221','TO','Tonga');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','222','TR','Turchia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','223','TT','Trinidad e Tobago');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','224','TV','Tuvalu');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','225','TW','Repubblica di Cina');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','226','TZ','Tanzania');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','227','UA','Ucraina');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','228','UG','Uganda');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','229','UM','Isole minori esterne degli Stati Uniti');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','230','US','Stati Uniti d''America');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','231','UY','Uruguay');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','232','UZ','Uzbekistan');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','233','VA','Citta''del Vaticano');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','234','VC','Saint Vincent e Grenadine');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','235','VE','Venezuela');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','236','VG','Isole Vergini Britanniche');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','237','VI','Isole Vergini Americane');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','238','VN','Vietnam');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','239','VU','Vanuatu');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','240','WF','Wallis e Futuna');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','241','WS','Samoa');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','242','YE','Yemen');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','243','YT','Mayotte');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','244','ZA','Sudafrica');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','245','ZM','Zambia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','246','ZW','Zimbabwe');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z23','1',  'IT','Italia');

		-- Nuovo campo per ART80
		ALTER TABLE IMPR ADD ART80_UFF_CODEIN VARCHAR(16) null;
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ART80_UFF_CODEIN.IMPR.GENE', 'G_A80UFCO', 'Ufficio di invio', 'Ufficio di invio', 'A16', NULL, NULL, 'Ufficio di invio');

		--Correzione CAP
		Update TABSCHE set tabcod4='36048' where tabcod='S2003' and tabcod1='09' and tabcod2='8639';
		Update TABSCHE set tabcod4='36064' where tabcod='S2003' and tabcod1='09' and tabcod2='8665';
		Update TABSCHE set tabcod4='36029' where tabcod='S2003' and tabcod1='09' and tabcod2='8664';

		Update ELDAVER set NUMVER = '1.14.0', datvet = now() where codapp = 'G_';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
declare
maxtab1tip Numeric(10) := 0;
newtab1tip Numeric(10) := 0;
oldtab1tip Numeric(10) := 0;
ciclo_tab1_Ag020 cursor for select tab1tip from tab1 where tab1cod='Ag020' and tab1tip < 100 order by tab1tip;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver = '1.14.0') THEN
       if (select count(tab1tip) = 0 from tab1 where tab1cod='Ag020' and tab1tip=25 and tab1desc='UNISOA S.p.A.') THEN
           -- Le occorrenze del tabellato Ag020 vengono spostate a partire dal valore 100 di TAB1TIP e impostare come archiviate.
           -- Vengono inseriti i nuovi valori SOA e cancellata l'occorrenza da TAB6
           select max(tab1tip) INTO maxtab1tip from tab1 where tab1cod='Ag020';
           IF (maxtab1tip < 100 ) THEN
              maxtab1tip := 99;
           END IF;
           open ciclo_tab1_Ag020;
           loop
               fetch ciclo_tab1_Ag020 into oldtab1tip;
				
               if not found then
	          exit;
               end if;
               newtab1tip := maxtab1tip + 1;
               UPDATE TAB1 SET TAB1TIP = newtab1tip, TAB1ARC='1' WHERE TAB1COD='Ag020' and TAB1TIP = oldtab1tip;
               UPDATE IMPR SET OCTSOA = newtab1tip WHERE OCTSOA = oldtab1tip;
               maxtab1tip := maxtab1tip + 1;
           end loop;
           close ciclo_tab1_Ag020;
           
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 1, 'ARGENTA SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 2, 'ATT.I.CO.', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 3, 'ATTESTA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 4, 'AXSOA', NULL, 0);--
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 5, 'BENTLEY SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 6, 'C.Q.O.P. SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 7, 'CONSULT SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 8, 'DAP SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 9, 'ESNA SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 10, 'EURO SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 11, 'HI-QUALITY SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 12, 'I.C. SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 13, 'IMPRESOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 14, 'ITALSOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 15, 'LA SOATECH SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 16, 'MEDITERRANEA SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 17, 'N.C.S. SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 18, 'PEGASO SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 19, 'QLP SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 20, 'QUADRIFOGLIO SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 21, 'RINA SOA', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 22, 'SOA GROUP (GIA'' PROTOS SOA)', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 23, 'SOALAGHI', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 24, 'SOATEAM', NULL, 0);
           INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag020', 25, 'UNISOA S.p.A.', NULL, 0);
           
           DELETE FROM TAB6 WHERE TAB6COD='G__1' AND TAB6TIP='Ag020';
       END IF;


      Update ELDAVER set NUMVER = '1.14.1M1', datvet = now() where codapp = 'G_';

    END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver = '1.14.1M1') THEN
	
		perform sp_backupanddropviews('tab1');
		ALTER TABLE TAB1 ALTER COLUMN TAB1DESC TYPE VARCHAR(200);
		perform sp_restoreviews('tab1');
        UPDATE C0CAMPI SET C0C_FS='A200' WHERE  C0C_MNE_BER='TAB1DESC';

		UPDATE C0CAMPI SET COC_DES_WEB='Centrale unica di committenza?' WHERE  C0C_MNE_BER='G_ISCUC';

		-- fix alle definizioni dei metadati
		DELETE FROM c0campi WHERE c0c_mne_ber = 'USCADATCANC';
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (048001303, 'E', NULL, 'SYSDATCANC.USRCANC.GENE', 'USCADATCANC', 'Data eliminazione', 'Data eliminazione', 'A10', NULL, 'DATA_ELDA', NULL);
		
		DELETE FROM c0entit WHERE c0e_nom = 'COMP_G.GENE';
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('COMP_G.GENE', 80010100, 'E', 'INT_UFF', 'Intestazione ufficio titolare', 'C_COMP.COMP_G.GENE,C_CENT.COMP_G.GENE,C_NUCL.COMP_G.GENE,C_SQUA.COMP_G.GENE', NULL, NULL, 'g_comp2', 'g_comp1', 'g_comp0');
		
		DELETE FROM c0entit WHERE c0e_nom = 'G_FUNZ.GENE';
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('G_FUNZ.GENE', 80010200, 'E', 'FUNZ_I_UFF', 'Funzionari Intestazione Ufficio', 'C_COMP.G_FUNZ.GENE', 'COMP_G.GENE', 'C_COMP.COMP_G.GENE', NULL, NULL, 'g_funz0');

		DELETE FROM c0entit WHERE c0e_nom = 'C0RIC.GENE';
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('C0RIC.GENE', 80040108, 'C', NULL, 'Testata delle ricerche generiche', 'C0RCOD.C0RIC.GENE', NULL, NULL, NULL, NULL, 'g__c0r0');

		DELETE FROM c0entit WHERE c0e_nom = 'PUNTICON.GENE#1';
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('PUNTICON.GENE#1', 88000052, 'C', NULL, 'Punti di contatto dell''ufficio intestatario', 'CODEIN.PUNTICON.GENE,NUMPUN.PUNTICON.GENE', 'TORN.GARE', 'CENINT.TORN.GARE,PCOPRE.TORN.GARE', NULL, NULL, 'g_pcont0');
		DELETE FROM c0entit WHERE c0e_nom = 'PUNTICON.GENE#2';
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('PUNTICON.GENE#2', 88000052, 'C', NULL, 'Punti di contatto dell''ufficio intestatario', 'CODEIN.PUNTICON.GENE,NUMPUN.PUNTICON.GENE', 'TORN.GARE', 'CENINT.TORN.GARE,PCODOC.TORN.GARE', NULL, NULL, 'g_pcont0');
		DELETE FROM c0entit WHERE c0e_nom = 'PUNTICON.GENE#3';
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('PUNTICON.GENE#3', 88000052, 'C', NULL, 'Punti di contatto dell''ufficio intestatario', 'CODEIN.PUNTICON.GENE,NUMPUN.PUNTICON.GENE', 'TORN.GARE', 'CENINT.TORN.GARE,PCOOFF.TORN.GARE', NULL, NULL, 'g_pcont0');
		DELETE FROM c0entit WHERE c0e_nom = 'PUNTICON.GENE#4';
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('PUNTICON.GENE#4', 88000052, 'C', NULL, 'Punti di contatto dell''ufficio intestatario', 'CODEIN.PUNTICON.GENE,NUMPUN.PUNTICON.GENE', 'TORN.GARE', 'CENINT.TORN.GARE,PCOGAR.TORN.GARE', NULL, NULL, 'g_pcont0');
		DELETE FROM c0entit WHERE c0e_nom = 'PUNTICON.GENE#5';
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('PUNTICON.GENE#5', 88000052, 'C', NULL, 'Punti di contatto dell''ufficio intestatario', 'CODEIN.PUNTICON.GENE,NUMPUN.PUNTICON.GENE', 'GARECONT.GARE', 'CENINT.TORN.GARE,PCOESE.GARECONT.GARE', NULL, NULL, 'g_pcont0');
		DELETE FROM c0entit WHERE c0e_nom = 'PUNTICON.GENE#6';
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('PUNTICON.GENE#6', 88000052, 'C', NULL, 'Punti di contatto dell''ufficio intestatario', 'CODEIN.PUNTICON.GENE,NUMPUN.PUNTICON.GENE', 'GARECONT.GARE', 'CENINT.TORN.GARE,PCOFAT.GARECONT.GARE', NULL, NULL, 'g_pcont0');
		
		Update ELDAVER set NUMVER = '1.14.1', datvet = now() where codapp = 'G_';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
	IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver = '1.14.1') THEN

	perform sp_backupanddropviews('tab2');
	ALTER TABLE TAB2 ALTER COLUMN TAB2D1 TYPE VARCHAR(200);
	ALTER TABLE TAB2 ALTER COLUMN TAB2D2 TYPE VARCHAR(200);
	perform sp_restoreviews('tab2');
	UPDATE C0CAMPI SET C0C_FS='A200' WHERE  C0C_MNE_BER='TAB2D1';
	UPDATE C0CAMPI SET C0C_FS='A200' WHERE  C0C_MNE_BER='TAB2D2';
	UPDATE C0CAMPI SET C0C_FS='F9.5' WHERE  C0C_MNE_BER='QUODIC';
 
	DELETE FROM C0ENTIT where c0e_nom='UFFINT.GENE#7' and c0e_key = 'CODEIN.UFFINT.GENE' and c0e_nom_ex = 'FABBISOGNI.PIANI' and coe_key_ex = 'CODEIN.FABBISOGNI.PIANI';
	INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('UFFINT.GENE#7',0, 'C',NULL,NULL,'CODEIN.UFFINT.GENE','FABBISOGNI.PIANI','CODEIN.FABBISOGNI.PIANI',NULL,NULL,'g_10uffi');
	
	CREATE TABLE ART80 (
	CODIMP VARCHAR(10) not null, 
	STATO NUMERIC(7), 
	DATA_RICHIESTA TIMESTAMP, 
	DATA_LETTURA TIMESTAMP, 
	CODEIN VARCHAR(16) not null,
	primary key (CODIMP,CODEIN));

	ALTER TABLE ART80 ADD CONSTRAINT FK_ART80_IMPR FOREIGN KEY ( CODIMP ) REFERENCES IMPR( CODIMP ) ON DELETE CASCADE;
	ALTER TABLE ART80 ADD CONSTRAINT FK_ART80_UFFINT FOREIGN KEY ( CODEIN ) REFERENCES UFFINT( CODEIN ) ON DELETE CASCADE;
	
	INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('ART80.GENE', 0, 'E', 'ART80', 'Articolo 80', 'CODIMP.ART80.GENE', NULL, NULL, 'g_art80', 'g_art80', 'g_art80');

	INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'CODIMP.ART80.GENE', 'ART80_CODIMP', 'Codice dell''impresa', 'Codice', 'A10', NULL, NULL, 'Codice dell''anagrafico');
	INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'STATO.ART80.GENE', 'ART80_STATO', 'Stato documentale', 'Stato documentale', 'A100', 'G_063', NULL, 'Stato documentale');
	INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DATA_RICHIESTA.ART80.GENE', 'ART80_DRICH', 'Data invio anagrafica', 'Data invio', 'A10', NULL, 'DATA_ELDA', 'Data invio anagrafica');
	INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DATA_LETTURA.ART80.GENE', 'ART80_DLETT', 'Data ultima lettura stato', 'Data lett. stato', 'A10', NULL, 'DATA_ELDA', 'Data ultima lettura stato');		
	INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'CODEIN.ART80.GENE', 'ART80_CODEIN', 'Ufficio di invio', 'Ufficio di invio', 'A16', NULL, NULL, 'Ufficio di invio');
	
	Update tabsche set tabdesc='SAPPADA (fino al 2017)' where tabcod='S2003' and  tabcod1='09' and  tabcod2='3674' and tabcod3='005025052';
	Delete from tabsche where tabcod='S2003' and tabcod1='09' and tabcod3='006030189';
	Insert into tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8667', 'SAPPADA', '006030189', '32047', 'I421');	

	Update ELDAVER set NUMVER = '1.15.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.15.%') THEN
                
		create table VERIFICHE (
			ID NUMERIC(12) not null,
			CFEIN VARCHAR(16) not null,
			CODIMP VARCHAR(10) not null,
			CONTESTO_VERIFICA VARCHAR(5),
			TIPO_VERIFICA NUMERIC(7),
			DESCR_VERIFICA VARCHAR(500),
			ESITO_VERIFICA NUMERIC(7),
			STATO_VERIFICA NUMERIC(7),
			GG_VALIDITA NUMERIC(3),
			GG_AVVISO_SCADENZA NUMERIC(3),
			DATA_ULTIMA_RICHIESTA TIMESTAMP,
			DATA_SILENZIO_ASSENSO TIMESTAMP,
			DATA_ULTIMA_CERTIFICAZIONE TIMESTAMP,
			DATA_SCADENZA TIMESTAMP,
			MODO_GESTIONE_VERIFICA NUMERIC(7),
			ENTE_COMPETENZA NUMERIC(7),
			IS_SILENZIO_ASSENSO VARCHAR(1),
			IS_ARCHIVIATO VARCHAR(1),
			primary key (ID));

		create table DOCUMENTI_VERIFICHE (
			ID NUMERIC(12) not null,                
			ID_VERIFICA NUMERIC(12) not null,
			TIPO NUMERIC(7),
			DESCRIZIONE VARCHAR(500),
			PROTOCOLLO_RICHIESTA VARCHAR(20),
			NUMERO_PRATICA VARCHAR(20),
			GG_VALIDITA NUMERIC(3),
			GG_AVVISO_SCADENZA NUMERIC(3),
			DATA_INVIO_RICHIESTA TIMESTAMP,
			DATA_SILENZIO_ASSENSO TIMESTAMP,
			DATA_EMISSIONE TIMESTAMP,
			DATA_SCADENZA TIMESTAMP,
			MODALITA VARCHAR(500),
			NOTE_VERIFICA_DOC VARCHAR(2000),
			ESITO_VERIFICA_DOC NUMERIC(7),
			NOTE_ESITO_VERIFICA_DOC VARCHAR(2000),
			IDPRG VARCHAR(2),
			IDDOCDG NUMERIC(12),
			KEYSESS VARCHAR(500),
			CODTIM VARCHAR(10),
			ISARCHI VARCHAR(1),
			primary key (ID));
		
		ALTER TABLE VERIFICHE ADD CONSTRAINT FK_VERIFICHE FOREIGN KEY (CODIMP) REFERENCES IMPR(CODIMP) ON DELETE CASCADE;		
		ALTER TABLE DOCUMENTI_VERIFICHE ADD CONSTRAINT FK_DOCUMENTI_VERIFICHE FOREIGN KEY (ID_VERIFICA) REFERENCES VERIFICHE(ID) ON DELETE CASCADE;
		
		create or replace view v_soggetti_verifiche as 
			(select codimp2 codimp, codtim, (cast('Legale rappresentante' as varchar(100))) incarico, nomtim, cftim, nomimp,cfimp
			from impleg, teim, impr 
			where codtim=codleg and codimp2=codimp and (tipimp is null or tipimp<>3)
			union
			select codime9 codimp, codtim, (cast('Legale rappresentante' as varchar(100))) incarico, nomtim, cftim, nomdic, (select cfimp from impr where codimp = coddic)
			from impleg, teim, impr ,ragimp
			where codtim=codleg and codimp2=coddic and codime9=codimp and tipimp=3)
			UNION
			(select codimp3 codimp, codtim, (cast('Direttore tecnico' as varchar(100))) incarico, nomtim, cftim, nomimp, cfimp
			from impdte, teim , impr 
			where codtim=coddte  and codimp3=codimp and (tipimp is null or tipimp<>3)
			union 
			select codime9 codimp, codtim, (cast('Direttore tecnico' as varchar(100))) incarico, nomtim, cftim, nomdic,(select cfimp from impr where codimp = coddic)
			from impdte, teim , impr ,ragimp
			where codtim=coddte and codimp3=coddic and codime9=codimp and tipimp=3)
			UNION
			(select codimp4 codimp, codtim, tab1desc incarico, nomtim, cftim, nomimp, cfimp
			from impazi, teim, tab1 , impr 
			where codtim=codtec and tab1cod like 'Ag007' and tab1tip=incazi and codimp4=codimp and (tipimp is null or tipimp<>3)
			union
			select codime9 codimp, codtim, tab1desc incarico, nomtim, cftim, nomdic, (select cfimp from impr where codimp = coddic) 
			from impazi, teim, tab1 , impr ,ragimp
			where codtim=codtec and tab1cod like 'Ag007' and tab1tip=incazi and codimp4=coddic and codime9=codimp and tipimp=3)
			UNION
			(select c.codimp, codtim, tab1desc incarico, nomtim, cftim, nomimp, cfimp
			from g_impcol c, teim, tab1, impr i
			where codtim=codtec and tab1cod like 'G_039' and tab1tip=inctip and c.codimp=i.codimp and (tipimp is null or tipimp<>3)
			union
			select codime9, codtim, tab1desc incarico, nomtim, cftim, nomdic, (select cfimp from impr where codimp = coddic)
			from g_impcol c, teim, tab1 , impr i ,ragimp
			where codtim=codtec and tab1cod like 'G_039' and tab1tip=inctip and c.codimp=coddic and codime9=i.codimp and tipimp=3);
		
		
		perform sp_backupanddropviews('uffint');
		ALTER TABLE UFFINT ALTER COLUMN CITEIN type VARCHAR(36);
		perform sp_restoreviews('uffint');
		
		perform sp_backupanddropviews('punticon');
		ALTER TABLE PUNTICON ALTER COLUMN CITEIN type VARCHAR(36);
		perform sp_restoreviews('punticon');
		
		ALTER TABLE USRSYS ADD sysultacc TIMESTAMP;
		
		Create Table G_LOGINKO (
			id NUMERIC(12) not null,
			username VARCHAR(60),
			logintime TIMESTAMP not null,
			ipaddress VARCHAR(40),
			primary key (ID));
		
		ALTER TABLE IMPR ADD ISCRIAE VARCHAR(1);
		ALTER TABLE IMPR ADD AEDSCAD TIMESTAMP;
		ALTER TABLE IMPR ADD AEINCORSO VARCHAR(1);
		ALTER TABLE IMPR ADD ISCRIESP VARCHAR(1);
		ALTER TABLE IMPR ADD ISCRIRAT VARCHAR(1);
                ALTER TABLE IMPR ADD RATING NUMERIC(7);
                ALTER TABLE IMPR ADD RATDSCAD TIMESTAMP;
                ALTER TABLE IMPR ADD RATINCORSO VARCHAR(1);
				
				

		update eldaver set numver = 'M1.1.16.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();



CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver = 'M1.1.16.0') THEN
	
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re)
			VALUES ('VERIFICHE.GENE', 0, 'E', 'EL_VERIF', 'Verifiche imprese', 'ID.VERIFICHE.GENE', NULL, NULL, 'g_verif2', 'g_verif1', 'g_verif0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re)
			VALUES ('DOCUMENTI_VERIFICHE.GENE', 0, 'E', 'DOC_VERIF', 'Documenti verifiche Art.80', 'ID_VERIFICA.DOCUMENTI_VERIFICHE.GENE', 'VERIFICHE.GENE', 'ID.VERIFICHE.GENE', 'g_verif2', 'g_verif1', 'g_verif0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re)
			VALUES ('V_SOGGETTI_VERIFICHE.GENE', 0, 'E', 'SOGG_VF', 'Soggetti verifiche (Leg.Rap.,Dir.Tec.,altri)', 'CODIMP.V_SOGGETTI_VERIFICHE.GENE', 'IMPR.GENE', 'CODIMP.IMPR.GENE', NULL, NULL, 'g_sgvf0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('G_LOGINKO.GENE ', 0, 'C', 'G_LOGINKO', 'Login fallite', 'ID.G_LOGINKO.GENE', NULL, NULL, 'g_logko0', 'g_logko0', 'g_logko0');
		-- VERIFICHE
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', 'P', 'ID.VERIFICHE.GENE', 'VERIF_ID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'CFEIN.VERIFICHE.GENE', 'VERIF_CFEIN', 'Codice fiscale S.A.', 'CF S.A.', 'A16', NULL, NULL, 'Codice fiscale dellaq S.A.');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'CODIMP.VERIFICHE.GENE', 'VERIF_CODIMP', 'Codice dell''impresa', 'Codice', 'A10', NULL, NULL, 'Codice dell''anagrafico');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'CONTESTO_VERIFICA.VERIFICHE.GENE', 'VERIF_CONTESTO', 'Contesto verifica', 'Contesto verifica', 'A10', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'TIPO_VERIFICA.VERIFICHE.GENE', 'VERIF_TIPO', 'Tipo verifica', 'Tipo verifica', 'A100', 'G_z24', NULL, 'Tipo verifica');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'DESCR_VERIFICA.VERIFICHE.GENE', 'VERIF_DESCR', 'Descrizione verifica', 'Descr verifica', 'A500', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'ESITO_VERIFICA.VERIFICHE.GENE', 'VERIF_ESITO', 'Esito verifica', 'Esito verifica', 'A100', 'G_064', NULL, 'Esito verifica');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'STATO_VERIFICA.VERIFICHE.GENE', 'VERIF_STATO', 'Stato verifica', 'Stato verifica', 'A100', 'G_068', NULL, 'Stato verifica');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'GG_VALIDITA.VERIFICHE.GENE', 'VERIF_GGVALIDITA', 'Giorni di validita', 'GG validita', 'N3', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'GG_AVVISO_SCADENZA.VERIFICHE.GENE', 'VERIF_GGAVVSCADENZA', 'Giorni prima di avviso scadenza', 'Promemoria', 'N3', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'DATA_ULTIMA_RICHIESTA.VERIFICHE.GENE', 'VERIF_DULTRICH', 'Data ultima richiesta', 'Data ult. richiesta', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'DATA_SILENZIO_ASSENSO.VERIFICHE.GENE', 'VERIF_DSILASS', 'Data silenzio assenso', 'Data silenz. assenso', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
	VALUES (0, 'E', NULL, 'DATA_ULTIMA_CERTIFICAZIONE.VERIFICHE.GENE', 'VERIF_DULTCERT', 'Data ultima certificazione', 'Data ult. cert.', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'DATA_SCADENZA.VERIFICHE.GENE', 'VERIF_DSCAD', 'Data scadenza', 'Data scadenza', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
	VALUES (0, 'E', NULL, 'MODO_GESTIONE_VERIFICA.VERIFICHE.GENE', 'VERIF_MODOGESTV', 'Modo gestione verifica', 'Modo gestione', 'A100', 'G_065', NULL, 'Modo gestione verifica');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
	VALUES (0, 'E', NULL, 'ENTE_COMPETENZA.VERIFICHE.GENE', 'VERIF_ENTECOMP', 'Ente competenza', 'Ente competenza', 'A100', 'G_066', NULL, 'Ente competenza');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'IS_SILENZIO_ASSENSO.VERIFICHE.GENE', 'VERIF_ISSILASS', 'Silenzio/assenso?', 'Silenzio/assenso?', 'A1', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'IS_ARCHIVIATO.VERIFICHE.GENE', 'VERIF_ISARCH', 'Archiviato?', 'Archiviato?', 'A1', NULL, 'SN', NULL);
			
		--DOCUMENTI VERIFICHE
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', 'P', 'ID.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_ID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'ID_VERIFICA.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_ID_VERIFICA', 'Id verifica', 'Id verifica', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'TIPO.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_TIPO', 'Tipo', 'Tipo', 'A100', 'G_067', NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'DESCRIZIONE.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_DESC', 'Descrizione verifica', 'Descrizione verifica', 'A500', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'PROTOCOLLO_RICHIESTA.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_PROTRICH', 'Protocollo richiesta', 'Protocollo richiesta', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'NUMERO_PRATICA.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_NUMPRAT', 'Numero pratica', 'Numero pratica', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'GG_VALIDITA.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_GGVALIDITA', 'Giorni di validita', 'GG validita', 'N3', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'GG_AVVISO_SCADENZA.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_GGAVVSCADENZA', 'Giorni prima di avviso scadenza', 'Promemoria', 'N3', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'DATA_INVIO_RICHIESTA.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_DINVIORICH', 'Data invio richiesta', 'Data invio richiesta', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'DATA_SILENZIO_ASSENSO.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_DSILASS', 'Data silenzio assenso', 'Data silenz. assenso', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'DATA_EMISSIONE.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_DEMISS', 'Data emissione', 'Data emissione', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'DATA_SCADENZA.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_DSCAD', 'Data scadenza', 'Data scadenza', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'MODALITA.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_MODALITA', 'Modalita''', 'Modalita''', 'A500', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'NOTE_VERIFICA_DOC.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_NOTVFDOC', 'Note verifica documento', 'Note verif. doc.', 'A2000', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'ESITO_VERIFICA_DOC.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_ESVFDOC', 'Esito verifica documento', 'Esito verif. doc.', 'A100', 'G_064', NULL, 'Esito verifica documento');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'NOTE_ESITO_VERIFICA_DOC.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_NOTESVFDOC', 'Note esito verifica documento', 'Note esito vf. doc.', 'A2000', NULL, NULL, 'Note esito verifica documento');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) 
			Values (0, 'E', NULL, 'IDPRG.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_IDPRG', 'Codice applicativo (riferimento ad arch.documenti digitali)', 'Codice applicativo', 'A2', NULL, NULL, NULL);
		Insert into C0CAMPI(COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB)
			Values (0, 'E', NULL,'IDDOCDG.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_IDDOCDG', 'ID documento (riferimento ad arch.documenti digitali)', 'Codice documento', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'CODTIM.DOCUMENTI_VERIFICHE.GENE', 'DOCVF_CODTIM', 'Codice del soggetto', 'Cod. soggetto', 'A10', NULL, NULL, 'Codice soggetto');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)
			VALUES (0,'E',NULL,'ISARCHI.DOCUMENTI_VERIFICHE.GENE','DOCVF_ISARCHI','Documento archiviato o superato ?','Doc. archiviato?','A2',NULL,'SN',NULL);
			
		--SOGGETTI VERIFICHE
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', 'P', 'CODIMP.V_SOGGETTI_VERIFICHE.GENE', 'SVF_CODIMP', 'Codice impresa', 'Codice impresa', 'A10', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', 'P', 'CODTIM.V_SOGGETTI_VERIFICHE.GENE', 'SVF_CODTIM', 'Codice del soggetto', 'Cod. soggetto', 'A10', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'INCARICO.V_SOGGETTI_VERIFICHE.GENE', 'SVF_INCARI', 'Tipo di incarico', 'Incarico', 'A100', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'NOMTIM.V_SOGGETTI_VERIFICHE.GENE', 'SVF_NOMTIM', 'Cognome e nome del soggetto', 'Intestazione', 'A161', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'CFTIM.V_SOGGETTI_VERIFICHE.GENE', 'SVF_CFTIM', 'Codice fiscale', 'Codice fiscale', 'A16', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'NOMIMP.V_SOGGETTI_VERIFICHE.GENE', 'SVF_NOMIMP', 'Cognome e nome del soggetto', 'Intestazione', 'A161', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
			VALUES (0, 'E', NULL, 'CFIMP.V_SOGGETTI_VERIFICHE.GENE', 'SVF_CFIMP', 'Codice Fiscale del soggetto', 'C.F.', 'A16', NULL, NULL, NULL);

		-- G_LOGINKO E USRSYS
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'SYSULTACC.USRSYS.GENE', 'G_USYSULTAC', 'Data ultimo accesso', 'Ultimo accesso', 'A10', NULL, 'TIMESTAMP', NULL);
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'C', 'P','ID.G_LOGINKO.GENE', 'LOGKOID', 'Id registrazione', 'Id', 'N12', NULL, NULL, NULL);
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'C', NULL,'USERNAME.G_LOGINKO.GENE', 'LOGKOUSER', 'Username', 'Username', 'A60', NULL, NULL, NULL);
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'C', NULL,'LOGINTIME.G_LOGINKO.GENE', 'LOGKOTIME', 'Data tentativo di login fallito', 'Data', 'A19', NULL, 'TIMESTAMP', NULL);
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'C', NULL,'IPADDRESS.G_LOGINKO.GENE', 'LOGKOIP', 'Indirizzo IP', 'Indirizzo IP', 'A40', NULL, NULL, NULL);
		
                -- Iscrizione elenchi ricostruzione
                Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL,'ISCRIAE.IMPR.GENE', 'G_ISCRIAE', 'Iscritto a anagrafe antimaf.esecut.(art.30 c.6 DL 189/2016)?', 'Iscr.an.antim.esec.?', 'A2', NULL, 'SN', 'Iscritto a anagrafe antimafia esecutori (art.30 c.6 DL 189/2016)?');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL,'AEDSCAD.IMPR.GENE', 'G_AEDSCAD', 'Data scadenza iscrizione anagrafe antimafia esecutori', 'Data scad.iscr.an.es', 'A10', NULL, 'DATA_ELDA', 'Data scadenza iscrizione');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL,'AEINCORSO.IMPR.GENE', 'G_AEINCOR', 'Rinnovo iscrizione in corso anagrafe antimafia esecutori?', 'Rinn.in corso an.es?', 'A2', NULL, 'SN', 'Rinnovo in corso?');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL,'ISCRIESP.IMPR.GENE', 'G_ISCRIESP', 'Iscritto a elenco speciale profession.(art.34 DL 189/2016)? ', 'Iscr.el.spec.prof.?', 'A2', NULL, 'SN', 'Iscritto a elenco speciale professionisti (art.34 DL 189/2016)?');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL,'ISCRIRAT.IMPR.GENE', 'G_ISCRIRAT', 'Possiede rating di legalità?', 'Possiede rating leg?', 'A2', NULL, 'SN', 'In possesso del rating di legalità?');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL,'RATING.IMPR.GENE', 'G_RATING', 'Rating di legalità  ', 'Rating legalità ', 'A100', 'G_069',  NULL,'Rating');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL,'RATDSCAD.IMPR.GENE', 'G_RATDSCAD', 'Data scadenza possesso rating di legalità ', 'Data scad.rating', 'A10', NULL, 'DATA_ELDA', 'Data scadenza rating');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL,'RATINCORSO.IMPR.GENE', 'G_RATINCOR', 'Aggiornamento rating di legalità in corso?', 'Agg.in corso rating?', 'A2', NULL, 'SN', 'Aggiornamento in corso?');

		INSERT INTO w_genchiavi (tabella, chiave) VALUES ('VERIFICHE', 0);
		INSERT INTO w_genchiavi (tabella, chiave) VALUES ('DOCUMENTI_VERIFICHE', 0);
		INSERT INTO w_genchiavi (tabella, chiave) VALUES ('G_LOGINKO', 0);
		
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z24','1', NULL,'Attestazione ottemperanza legge 68/99 (Art. 80 - Comma 5.I)');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z24','2', NULL,'Certificato anagrafe sanzione amministrative da reato e Casellario ANAC');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z24','3', NULL,'Certificato del casellario giudiziale relativo ai soggetti dotati di rappresentanza in carica');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z24','4', NULL,'Certificato del casellario giudiziale relativo ai soggetti dotati di rappresentanza cessati nell''ultimo anno');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z24','5', NULL,'Certificazione Antimafia');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z24','6', NULL,'DURC');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z24','7', NULL,'Attestazione di regolarità fiscale, Art. 80 - Comma 4');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z24','8', NULL,'Estratto casellario ANAC');
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z24','9', NULL,'Visura Camerale');
		-- Corrispondenza con G_z24 per annoverare nell'ordine: default GG_VALIDITA verifica,GG_AVVISO_SCADENZA verifica
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z25','1', NULL,NULL);
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z25','2', NULL,NULL);
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z25','3', NULL,NULL);
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z25','4', NULL,NULL);
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z25','5', NULL,NULL);
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z25','6', NULL,NULL);
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z25','7', NULL,NULL);
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z25','8', NULL,NULL);
		Insert into TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) values ('G_z25','9', NULL,NULL);
		--Esito verifica interna
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_064',1,'Regolare',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_064',2,'In lavorazione',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_064',3,'Anomalo',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_064',4,'Non applicabile',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_064',5,'Regolare per S.A.',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_064',6,'Superato',NULL,0,NULL);
		--Modalità di gestione della verifica
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_065',1,'Autonoma',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_065',2,'Avcpass',NULL,0,NULL);
		--Ente di competenza a cui deve essere inviata la richiesta
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_066',1,'Agenzia delle entrate',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_066',2,'Cassa Previdenziale',NULL,0,NULL);
		--Tipo verifica
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_067',1,'Richiesta',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_067',2,'Certificazione',NULL,0,NULL);
		--Stato verifica
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_068',1,'In corso',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_068',2,'In scadenza',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_068',3,'Scaduta',NULL,0,NULL);

                --rating
                INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_069',1,'*',NULL,NULL,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_069',2,'*+',NULL,NULL,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_069',3,'*++',NULL,NULL,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_069',4,'**',NULL,NULL,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_069',5,'**+',NULL,NULL,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_069',6,'**++',NULL,NULL,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_069',7,'***',NULL,NULL,NULL);

                INSERT INTO tab6 (tab6cod, tab6tip, tab6desc) VALUES ('G__1', 'G_069', 'Rating');

		UPDATE C0CAMPI set C0C_FS = 'A36' where COC_MNE_UNI in ('CITEIN.PUNTICON.GENE','CITEIN.UFFINT.GENE');			
	
		-- gli utenti amministratori per il GDPR non devono accedere a tutti i dati
		UPDATE USRSYS SET SYSAB3='U',SYSABG='U',MERUOLO=1 WHERE SYSPWBOU LIKE '%ou89%';

		-- accentramento delle properties relative alle password all'interno della sezione "Gestione account"
		UPDATE W_CONFIG SET SEZIONE = 'Gestione account' WHERE CHIAVE = 'it.eldasoft.account.durataPassword';
		UPDATE W_CONFIG SET SEZIONE = 'Gestione account' WHERE CHIAVE = 'account.intervalloMinimoCambioPassword';

		update eldaver set numver = '1.16.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.16.%') THEN

		--addizionati attributi per gestione Ordini NSO
		perform sp_backupanddropviews('uffint');
		ALTER TABLE UFFINT ADD COLUMN ENDPOINT_NSO VARCHAR(200);
		ALTER TABLE UFFINT ADD COLUMN CODCONS_NSO VARCHAR(100);
		perform sp_restoreviews('uffint');
		perform sp_backupanddropviews('punticon');
		ALTER TABLE PUNTICON ADD COLUMN CODCONS_NSO VARCHAR(100);
		perform sp_restoreviews('punticon');
		perform sp_backupanddropviews('impr');
		ALTER TABLE IMPR ADD COLUMN ENDPOINT_NSO VARCHAR(200);
		perform sp_restoreviews('impr');

		update eldaver set numver = 'M1.1.17.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver = 'M1.1.17.0') THEN
	
		--rating - modificato diciture
		UPDATE TAB1 SET TAB1DESC='* +' where tab1cod='G_069' and tab1tip=2 and tab1desc='*+';
		UPDATE TAB1 SET TAB1DESC='* + +' where tab1cod='G_069' and tab1tip=3 and tab1desc='*++';
		UPDATE TAB1 SET TAB1DESC='* *' where tab1cod='G_069' and tab1tip=4 and tab1desc='**';
		UPDATE TAB1 SET TAB1DESC='* * +' where tab1cod='G_069' and tab1tip=5 and tab1desc='**+';
		UPDATE TAB1 SET TAB1DESC='* * + +' where tab1cod='G_069' and tab1tip=6 and tab1desc='**++';
		UPDATE TAB1 SET TAB1DESC='* * *' where tab1cod='G_069' and tab1tip=7 and tab1desc='***';

        UPDATE tab6 SET TAB6DESC='Rating di legalità' WHERE tab6cod='G__1' and tab6tip='G_069' and tab6desc='Rating';
		--addizionato valore in tabellato per gestione verifiche interne Art.80
		IF (select count(*) = 0 from tab1 where tab1cod='G_064' and tab1tip=6) THEN
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_064',6,'Superato',NULL,0,NULL);
		END IF;
		
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
		VALUES (0, 'E', NULL, 'ENDPOINT_NSO.UFFINT.GENE', 'ENDPU_NSO', 'Endpoint NSO', 'Endpoint NSO', 'A200', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
		VALUES (0, 'E', NULL, 'ENDPOINT_NSO.IMPR.GENE', 'ENDPI_NSO', 'Endpoint NSO', 'Endpoint NSO', 'A200', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
		VALUES (0, 'E', NULL, 'CODCONS_NSO.UFFINT.GENE', 'CCONSU_NSO', 'Codice punto di consegna NSO', 'Punto cons. NSO', 'A100', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web)
		VALUES (0, 'E', NULL, 'CODCONS_NSO.PUNTICON.GENE', 'CCONSP_NSO', 'Codice punto di consegna NSO', 'Punto cons. NSO', 'A100', NULL, NULL, NULL);

		update eldaver set numver = '1.17.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
newtab1tip Numeric(10) := 0;
oldtab1tip Numeric(10) := 0;
maxtab1tip Numeric(10) := 0;
ciclo_tab1_Ag021 cursor for select tab1tip from tab1 where tab1cod='Ag021' order by tab1tip;
BEGIN
	IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.17.%') THEN
		 if (select count(tab1tip) = 0 from tab1 where tab1cod='Ag021' and tab1tip=446 and tab1desc='XEFRACERT S.r.l.') THEN
			select max(tab1tip) INTO maxtab1tip from tab1 where tab1cod='Ag021';
			IF (maxtab1tip < 1000 ) THEN
				maxtab1tip := 999;
			END IF;
			open ciclo_tab1_Ag021;
				loop
				   fetch ciclo_tab1_Ag021 into oldtab1tip;
					if not found then
					exit;
					end if;
					newtab1tip := maxtab1tip + 1;
					UPDATE TAB1 SET TAB1TIP = newtab1tip, TAB1ARC='1' WHERE TAB1COD='Ag021' and tab1tip < 1000 and TAB1TIP = oldtab1tip;
					UPDATE IMPR SET OCTSOA = newtab1tip WHERE OCTSOA = oldtab1tip;
					maxtab1tip := maxtab1tip + 1;
				end loop;
			close ciclo_tab1_Ag021;
			
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 1, '3A - PARCO TECNOLOGICO AGROALIMENTARE DELLUMBRIA s.c.a r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 2, 'A.E.S. AGENZIA EUROPEA PER LA SICUREZZA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 3, 'A.I.S.A. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 4, 'A.N.C.I. Servizi S.r.l. a Socio Unico  Sezione C.I.M.A.C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 5, 'A.S.TER. - Ambiente Sostenibilità e Territorio S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 6, 'ABCERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 7, 'ABICERT S.a.s. di Bianco Antonio & C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 8, 'ACAE', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 9, 'ACCERTA S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 10, 'ACEA ELABORI S.p.A. - ACEA ENGINEERING LABORATORIES RESEARCH INNOVATION S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 11, 'ACM Cert S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 12, 'ACS Italia Srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 13, 'ACSQ S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 14, 'AENOR INTERNATIONAL S.A.U.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 15, 'AFNOR ITALIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 16, 'AGIQUALITAS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 17, 'AGRICONSULTING S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 18, 'AGROQUALITÀ S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 19, 'AIASCERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 20, 'AICA - Associazione Italiana per l''informatica ed il calcolo automatico', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 21, 'AICQ SICEV S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 22, 'AJA Europe Ltd', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 23, 'AJA Registrars Europe S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 24, 'AMiCERT', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 25, 'ANAS S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 26, 'ANCC Srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 27, 'ANCCP Certification Agency S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 28, 'ANCIS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 29, 'APAVE CERTIFICATION ITALIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 30, 'APAVE ITALIA CPM S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 31, 'API - Assistenza Pesatura Industriale S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 32, 'ASACERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 33, 'ASSAM Agenzia Servizi Settore Agroalimentare delle Marche', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 34, 'ASSYTECH S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 35, 'AUTOMATOS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 36, 'AUTOSTRADA DEL BRENNERO S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 37, 'AVRV AE', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 38, 'AZIENDA SPECIALE DELLA CAMERA DI COMMERCIO DI ASTI PER LA PROMOZIONE E PER LA REGOLAZIONE DEL MERCATO', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 39, 'AZZURRA CERTIFICAZIONI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 40, 'Association Sénégalaise de Normalisation', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 41, 'Automotive Technical Service S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 42, 'Autostrade per lItalia S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 43, 'BARON PE.S.I. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 44, 'BESSEL S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 45, 'BIOAGRIcert S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 46, 'BIOS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 47, 'BIPIEMME TECHNOLOGY S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 48, 'BIZERBA S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 49, 'BOREAS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 50, 'BSI Assurance UK Limited', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 51, 'BSI Group Italia S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 52, 'BTP ITALIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 53, 'Barbera Bilance S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 54, 'Bottari Tecnologie S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 55, 'Bureau Veritas Italia S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 56, 'C & P S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 57, 'C.C.Q.A.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 58, 'C.E.N.P.I. SCRL', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 59, 'C.E.V.I. - CENTRO ELETTROTECNICO VERIFICHE IMPIANTI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 60, 'C.E.V.I. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 61, 'C.S.D.M. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 62, 'CAMERA DI COMMERCIO, INDUSTRIA, ARTIGIANATO E AGRICOLTURA DI TRENTO', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 63, 'CATAS S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 64, 'CCPB S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 65, 'CEB S.r.l. - Certificazione Economica dei beni intangibili', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 66, 'CEC - CONSORZIO EUROPEO CERTIFICAZIONE S.c.ar.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 67, 'CELAB S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 68, 'CENTRO CERTIFICAZIONE QUALITA'' - C.C.Q. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 69, 'CENTRO TESSILE COTONIERO E ABBIGLIAMENTO S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 70, 'CENTRO TOSCANO CERTIFICAZIONI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 71, 'CEPAS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 72, 'CER S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 73, 'CERSA S.r.l. socio unico', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 74, 'CERSIST S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 75, 'CERT UNIVERSE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 76, 'CERT.IM. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 77, 'CERT2000 S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 78, 'CERTAT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 79, 'CERTIEURO S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 80, 'CERTIFER ITALIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 81, 'CERTIFICA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 82, 'CERTIFICA TRADE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 83, 'CERTIFICATION S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 84, 'CERTIFICAZIONE PRODOTTI E SISTEMI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 85, 'CERTIFICAZIONI S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 86, 'CERTIFOR S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 87, 'CERTIQUALITY S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 88, 'CERTITALIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 89, 'CERTOTTICA S.c.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 90, 'CERTY CEQ S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 91, 'CERTing', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 92, 'CERVINO S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 93, 'CESI S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 94, 'CETOC TECHNICAL SERVICE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 95, 'CEVIQ S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 96, 'CHECK FRUIT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 97, 'CICPND SERVIZI S.R.L. con Unico Socio', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 98, 'CITIGAS Società Cooperativa S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 99, 'CM Servizi S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 100, 'CMT S.n.c. di Bracaloni Alessandro & C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 101, 'CND SERVICE CONTROLLI NON DISTRUTTIVI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 102, 'CNIM S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 103, 'CO.IN. COSTRUZIONI INDUSTRIALI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 104, 'CODEX S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 105, 'CONCERT S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 106, 'CONFORTI MARIO e F.lli s.n.c.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 107, 'CONSORZIO PASCAL S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 108, 'CONSORZIO SERVIZI QUALIFICATI', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 109, 'CONTECO CHECK s.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 110, 'CORFILCARNI G.C.C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 111, 'COSMOB S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 112, 'CPL Concordia Soc. Coop. - UNITÀ SERVIZI ISPETTIVI', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 113, 'CREI VEN S.c.a.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 114, 'CSI S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 115, 'CSQA Certificazioni S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 116, 'CST - CENTRO SERVIZI TECNOLOGICI S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 117, 'CTE CERTIFICAZIONI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 118, 'CVI ITALIA S.r.l.s.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 119, 'CeRSAA Centro di Sperimentazione ed Assistenza Agricola', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 120, 'Certi.s Srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 121, 'CertiProDop S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 122, 'Certipass srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 123, 'Control S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 124, 'Control Società per Controlli non Distruttivi di Mercatali Livio e Figli S.n.c.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 125, 'Cote dIvoire Normalisation', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 126, 'Cutino & C. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 127, 'DASA RÄGISTER S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 128, 'DEKRA Testing and Certification S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 129, 'DI.QU. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 130, 'DIMITTO Italia S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 131, 'DNV GL Business Assurance Italia S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 132, 'DNV GL ITALY S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 133, 'DOLOMITICERT S.C.A.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 134, 'DQA - DIPARTIMENTO QUALITA AGROALIMENTARE S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 135, 'DQUADRO ENERGIE S.r.l.s.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 136, 'E.C.S. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 137, 'E.L.T.I. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 138, 'E.M.Q. - DIN S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 139, 'E.QU.A. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 140, 'E.S.C. ENGINEERING SAFETY CERTIFICATION S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 141, 'E.T.C. European Technological Certification S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 142, 'ECEPA (Ente Certificazione Prodotti Agroalimentari)', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 143, 'ECO European Certifying Organization S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 144, 'ECOGRUPPO Italia S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 145, 'ECOS ITALIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 146, 'ECOS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 147, 'ELETTRA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 148, 'ELETTRO-LAB S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 149, 'ELLISSE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 150, 'ELSTER S.r.l.u.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 151, 'EN MEASURE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 152, 'EN.I.C. s.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 153, 'ENAMA SERVIZI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 154, 'ENER.CO.VE.CO. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 155, 'ENERGHIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 156, 'ENISERVIZI S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 157, 'ENTE CERTIFICAZIONI S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 158, 'ERGO Società di Certificazione e Validazione S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 159, 'ERGOCERT - Ente di Certificazione per l''Ergonomia s.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 160, 'ERSAF ENTE REGIONALE SERVIZI ALL''AGRICOLTURA E ALLE FORESTE', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 161, 'ESQ CERT Ltd', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 162, 'ETRURIA CERTIFICAZIONI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 163, 'EUCER S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 164, 'EUCERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 165, 'EUROCERT S.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 166, 'EUROCONTROLLI S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 167, 'EVIT TECHNICAL SERVICE S.r.l.s. (EVIT TS SRLS)', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 168, 'Eco Tech Engineering e Servizi Ambientali S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 169, 'Ente Certificazione Macchine S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 170, 'Eurobil S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 171, 'Eurocert S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 172, 'Eurofins Modulo Uno S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 173, 'Eurofins Product Testing Italy S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 174, 'European Quality Assurance Italia S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 175, 'FA.CA. di Favaro G. & C. S.n.c.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 176, 'FAC CERTIFICA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 177, 'FAKT CERTIFICATION SERVICES S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 178, 'FERP S.a.s. di Favaro Roberto & C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 179, 'FIRE-SECEM', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 180, 'FLAM GAS LABORATORIES S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 181, 'FONDO BANCHE ASSICURAZIONI', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 182, 'Form Up S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 183, 'G & R Organismo di Certificazione S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 184, 'G.F.G. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 185, 'G2S S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 186, 'GALILEO INSPECTORATE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 187, 'GARDHEN BILANCE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 188, 'GASTEC S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 189, 'GCERTI ITALY S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 190, 'GCL International Ltd T/A Globalgroup', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 191, 'GE.DI. Gestione Distribuzione S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 192, 'GI ONE S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 193, 'GIACAS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 194, 'GLI Italy B.V. Filiale Italiana', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 195, 'GSC Global System Certification Srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 196, 'GSP S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 197, 'Ge.Si. S.n.c. di Ing. Michele Vicentini & Co.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 198, 'Germanischer Lloyd Industrial Services Italia Srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 199, 'Globe S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 200, 'Guardian Independent Certification Limited', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 201, 'HQAI Humanitarian Quality Assurance Initiative', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 202, 'HT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 203, 'I BILANCIAI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 204, 'I.A.C.E. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 205, 'I.C.E.P.I. S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 206, 'I.CE.C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 207, 'I.E.C. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 208, 'I.G.M. CERTIFICAZIONI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 209, 'I.G.S. DATAFLOW S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 210, 'I.N.C.S.A. S.r.l. - Istituto Nazionale Controllo e Sicurezza Ascensori', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 211, 'I.Q.M. Ispezioni S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 212, 'I.T.A. International Technical Alliance S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 213, 'IAS REGISTER AG', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 214, 'IAS REGISTER AG', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 215, 'ICA SUD S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 216, 'ICARIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 217, 'ICB Qualità S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 218, 'ICDQ S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 219, 'ICEA Consorzio', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 220, 'ICERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 221, 'ICFP- ISTITUTO CERTIFICAZIONE FIGURE DELLA PREVENZIONE', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 222, 'ICIM S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 223, 'ICMQ S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 224, 'ICOVER srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 225, 'ICT GENESIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 226, 'ICert for Development of Agriculture systems', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 227, 'IE.DI.GE. ENGINEERING S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 228, 'IES INGEGNERIA E SICUREZZA DEGASPERI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 229, 'IFCQ Certificazioni S.r.l. a socio unico', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 230, 'IGNAZZI GIUSEPPE & C. S.n.c.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 231, 'IGQ', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 232, 'IIS CERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 233, 'IIS SERVICE S.r.l. con un unico socio', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 234, 'IMQ S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 235, 'INAIL - DIPARTIMENTO INNOVAZIONI TECNOLOGICHE E SICUREZZA DEGLI IMPIANTI, PRODOTTI ED INSEDIAMENTI ANTROPICI', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 236, 'INARCHECK S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 237, 'INGEGNERIA PER L''INDUSTRIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 238, 'INSPECTA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 239, 'INSPECTION OILFIELD VERIFICATION (IOV) IT-SERVIZI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 240, 'INTERNATIONAL WELD S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 241, 'INTERTEK ITALIA S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 242, 'INVEO S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 243, 'IPEM S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 244, 'IS.E.CERT Istituto Europeo di Certificazione S.r.l. Unipersonale', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 245, 'ISARail S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 246, 'ISET S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 247, 'ISFCERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 248, 'ISPEL S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 249, 'ISRANDT - ISRACERT Division', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 250, 'ISTITUTO ITALIANO SICUREZZA DEI GIOCATTOLI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 251, 'ISTITUTO NAZIONALE DI CERTIFICAZIONE S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 252, 'ISTITUTO NORD OVEST QUALITA'' - INOQ', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 253, 'ITA.C.A. Italiana Certificazioni Aziende S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 254, 'ITALCERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 255, 'ITALCERTIFER S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 256, 'ITALFERR S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 257, 'ITALGAS RETI S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 258, 'ITALY BUREAU OF VERIFICATION S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 259, 'ITEC - Istituto Tecnologico Europeo di Certificazione S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 260, 'ITS CONTROLLI TECNICI S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 261, 'IVEC S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 262, 'Inspectionslot Srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 263, 'InterCert GmbH  Group of MTIC', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 264, 'Iren Laboratori S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 265, 'Istituto Giordano S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 266, 'Istituto Italiano dei Plastici S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 267, 'Istituto Meridiana S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 268, 'Itron Italia S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 269, 'KERI', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 270, 'KHC - Know How Certification S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 271, 'KIWA CERMET Italia S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 272, 'Kiwa UNAVIAcert S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 273, 'L.M.T. LABORATORIO METROLOGICO TERNANO di Stentella Angelo e Stefano & C. S.n.c.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 274, 'LABCERT S.n.c. di Giuseppe Blandino & C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 275, 'LAPI LABORATORIO PREVENZIONE INCENDI S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 276, 'LL-C (certification) Czech Republic a.s.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 277, 'LLOYD''S Register Quality Assurance Italy S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 278, 'M.A. MISURE S.n.c. di Agostino Curci & C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 279, 'M.E.C. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 280, 'MA.DE. ENGINEERING S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 281, 'MALVEZZI & PARTNERS Servizi Integrati S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 282, 'MANUTENZIONI METANO S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 283, 'MARIO BOTTARI S.r.l. - ORGANISMO DI ISPEZIONE', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 284, 'MCJ Srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 285, 'ME.TE.MA. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 286, 'METIDE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 287, 'METROCAL S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 288, 'MI.RE. S.a.S. di Salerno Michele & C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 289, 'MM S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 290, 'MSCERT- MANAGEMENT SYSTEMS CERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 291, 'MTIC InterCert S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 292, 'MVM S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 293, 'Mated Srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 294, 'Mezzalana S.n.c. di Gianni Mezzalana & C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 295, 'Misure e Servizi s.a.s. di Dizadji Arch. Saeideh & C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 296, 'Modolo Impianti S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 297, 'NEMKO S.p.A. A SOCIO UNICO', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 298, 'NEW WEIGHING EXPERTS S.a.S. di Michael Francesco Sala', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 299, 'NO GAP CONTROLS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 300, 'NOBEL Certification Vista', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 301, 'NORMATEMPO Italia S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 302, 'NQA Certification Ltd', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 303, 'NRG GROUP S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 304, 'O.C.E. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 305, 'O.M.N.I.A. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 306, 'O.R.A.T. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 307, 'OBIETTIVO QUALITA'' S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 308, 'OCERT S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 309, 'OE.CIS. S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 310, 'OIL & GAS Service S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 311, 'OMEGA BILANCE S.r.l. - OMEGALAB', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 312, 'OMNIA QUALITA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 313, 'OVERTEC S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 314, 'Organismo Controllo Qualità Produzioni Regolamentate Soc. Coop.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 315, 'Organismo Europeo di Certificazione - OEC S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 316, 'PCC-CERT Sp. z o.o. Sp. K.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 317, 'PIETRO FIORENTINI S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 318, 'PLC S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 319, 'PRO ITER Progetto Infrastrutture Territorio S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 320, 'PRO-CERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 321, 'PRO.VE.CO. ENGINEERING SERVICE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 322, 'PROTOS CHECK S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 323, 'PT Bureau Veritas Indonesia', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 324, 'Pa.L.Mer. S.c.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 325, 'Perry Johnson Registrars, Inc.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 326, 'Politecnico di Milano', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 327, 'Produs di G. Stilo & C. S.n.c.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 328, 'Progetto Costruzione Qualità - P.C.Q. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 329, 'Q CERTIFICAZIONI S.r.l. a socio unico', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 330, 'Q GEST S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 331, 'Q-AID ASSESSMENT & CERTIFICATION S.r.l. UNIPERSONALE', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 332, 'Q-AID INSPECTION S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 333, 'Q.C.B. ITALIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 334, 'QMSCERT Ltd', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 335, 'QS CERTIFICAZIONI ITALIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 336, 'QS Zurich A.G.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 337, 'QSC S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 338, 'QUADRIFOGLIO S.r.l. UNIPERSONALE', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 339, 'QUALITAL', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 340, 'QUALITY ITALIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 341, 'QUASER CERTIFICAZIONI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 342, 'QUINEL Limited', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 343, 'Quality Austria - Trainings - Zertifizierungs - und Begutachtungs GmbH', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 344, 'R.A.F. VERIFICHE S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 345, 'REGAS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 346, 'RENALDI RICCARDO & C. S.n.c. di Renaldi Mario', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 347, 'RICEC International OOD', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 348, 'RICOTEST S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 349, 'RIMIFLU S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 350, 'RINA CHECK S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 351, 'RINA Services S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 352, 'Regione Siciliana - Assessorato Regionale delle Infrastrutture e Mobilità', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 353, 'Rete Ferroviaria Italiana S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 354, 'RetiPiù Srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 355, 'Roma Metropolitane S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 356, 'S.C. ALL CERT SYSTEMS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 357, 'S.C.E.C.eS. S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 358, 'S.I.C. S.r.l. - Società Italiana Certificazioni', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 359, 'S.O.C.I.F. Eclat S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 360, 'S.T. SAFETY TECHNOLOGY S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 361, 'SA CERTIFICATION S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 362, 'SACERT', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 363, 'SAFETY SYSTEMS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 364, 'SAI Global Italia S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 365, 'SANDRI BILANCE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 366, 'SEB - Servizi Elettrici Branchi S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 367, 'SECUR CONTROL S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 368, 'SERBLOK S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 369, 'SERVIZI ISACCHI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 370, 'SEUCER S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 371, 'SGS Italia S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 372, 'SI Cert S.a.g.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 373, 'SICAPT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 374, 'SICI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 375, 'SICIT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 376, 'SICURCERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 377, 'SIDEL S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 378, 'SIDELMED S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 379, 'SIET S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 380, 'SIQURIA S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 381, 'SIRTEM S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 382, 'SMC Società Mediterranea Certificazioni S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 383, 'SN Registrars (Holdings) Limited trading as DAS Certification Ltd & QEC Certification Ltd', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 384, 'SO.SEL. S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 385, 'SO.VE.P.I. Società Verifiche Periodiche Impianti S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 386, 'SQS -Swiss Association for Quality and Management Systems', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 387, 'SQS -Swiss Association for Quality and Management Systems', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 388, 'STS Servizi e Tecnologie di Saldatura S.r.l. - Certificazioni', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 389, 'STUDIO NAVA AUEEI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 390, 'SVI CERTIFICAZIONI S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 391, 'SVI S.r.l. - Società di verifica impianti', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 392, 'SYSTEM GAS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 393, 'Safety Management Service S.p.A.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 394, 'Sicel s.a.s. di Malfassi P. I. Fabio & C.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 395, 'Suolo e Salute S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 396, 'T.P.E. S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 397, 'TALENTO CONSULTING S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 398, 'TEC EUROLAB S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 399, 'TECLAB S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 400, 'TECNEA ITALIA S.r.l. a socio unico', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 401, 'TECNICA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 402, 'TECNO S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 403, 'TECNOLAB S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 404, 'TEGON-SALVALAGGIO di Salvalaggio Ida', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 405, 'TIFERNOGAS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 406, 'TORAMO CERTIFICAZIONI S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 407, 'TOSCANA CERTIFICAZIONE AGROALIMENTARE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 408, 'TRIVENETA CERTIFICAZIONI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 409, 'TRIVENETO S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 410, 'TTR INSTITUTE S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 411, 'TUEV AUSTRIA ITALIA - BLU SOLUTIONS S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 412, 'TUV NORD CERT Gmbh', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 413, 'TUV Technische Uberwachung Hessen Gmbh', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 414, 'TUV Thuringen Italia S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 415, 'TUV Thuringen e.V.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 416, 'Test-St. Petersburg Company Limited', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 417, 'The First Agricultural Co., for Registration, Inspection and Certification Limited Liability Company', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 418, 'Ticinum Papia Impianti S.n.c. di Ing. Stefano e Geom Lino Barbieri', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 419, 'Tokheim Sofitam Italia Srl', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 420, 'Toscana Energia S.p.a.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 421, 'TÜV AUSTRIA HELLAS Limited Company', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 422, 'TÜV INTERCERT S.r.l. - Group of TÜV Saarland', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 423, 'TÜV Italia S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 424, 'TÜV NORD ITALIA S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 425, 'TÜV Rheinland Italia S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 426, 'UL International Italia S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 427, 'UNISAPIENS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 428, 'UNITED REGISTRAR OF SYSTEMS - U.R.S. ITALIA S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 429, 'UNITER S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 430, 'UNOCERTIFICAZIONI S.R.L.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 431, 'V. BARBAGLI S.r.l. - ODI Barbagli', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 432, 'V.I.S. S.r.l. - VERIFICHE IMPIANTI E SISTEMI', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 433, 'V.P.E. Validazione Progetti Energetici S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 434, 'VALORITALIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 435, 'VCA Europe S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 436, 'VE.GHI.GAS S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 437, 'VEC S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 438, 'VENETA ENGINEERING S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 439, 'VERICERT S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 440, 'VERIFICHE INDUSTRIALI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 441, 'VERIMPIANTI S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 442, 'VERTEC ITALIA S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 443, 'Verigas S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 444, 'Viglienzone Adriatica S.r.l.', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 445, 'World Certification Services Limited', NULL, 0);
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021', 446, 'XEFRACERT S.r.l.', NULL, 0);
		   
			DELETE FROM TAB6 WHERE TAB6COD='G__1' AND TAB6TIP='Ag021';
			
			END IF;
		
		update eldaver set numver = '1.18.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.18.%') THEN

		Update TABSCHE set tabcod4='63812' where tabcod='S2003' and tabcod1='09' and tabcod2='4710';

		update eldaver set numver = '1.19.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.19.%') THEN

		perform sp_backupanddropviews('COMP_G');
		ALTER TABLE COMP_G ALTER COLUMN c_loc type VARCHAR(100);
		perform sp_restoreviews('COMP_G');

		perform sp_backupanddropviews('impr');
		ALTER TABLE IMPR ALTER COLUMN LOCIMP type VARCHAR(100);
		ALTER TABLE IMPR ALTER COLUMN CNATEC type VARCHAR(100);
		ALTER TABLE IMPR ALTER COLUMN DOFIMP type VARCHAR(100);
		ALTER TABLE IMPR ALTER COLUMN OGGSOC TYPE VARCHAR(2000);
		perform sp_restoreviews('impr');

		perform sp_backupanddropviews('impind');
		ALTER TABLE IMPIND ALTER COLUMN INDLOC type VARCHAR(100);
		perform sp_restoreviews('impind');
		
		perform sp_backupanddropviews('punticon');
		ALTER TABLE PUNTICON ALTER COLUMN CITEIN type VARCHAR(100);
		perform sp_restoreviews('punticon');

		perform sp_backupanddropviews('teim');
		ALTER TABLE TEIM ALTER COLUMN LOCTIM type VARCHAR(100);
		ALTER TABLE TEIM ALTER COLUMN CNATIM type VARCHAR(100);
		ALTER TABLE TEIM ALTER COLUMN DOFTIM type VARCHAR(100);
		perform sp_restoreviews('teim');

		perform sp_backupanddropviews('tecni');
		ALTER TABLE TECNI ALTER COLUMN LOCTEC type VARCHAR(100);
		ALTER TABLE TECNI ALTER COLUMN DOFTEC type VARCHAR(100);
		ALTER TABLE TECNI ALTER COLUMN CNATEC type VARCHAR(100);
		perform sp_restoreviews('tecni');

		perform sp_backupanddropviews('tecn');
		ALTER TABLE TECN ALTER COLUMN LOCTEC type VARCHAR(100);
		ALTER TABLE TECN ALTER COLUMN DOFTEC type VARCHAR(100);
		ALTER TABLE TECN ALTER COLUMN CNATEC type VARCHAR(100);
		perform sp_restoreviews('tecn');

		perform sp_backupanddropviews('utent');
		ALTER TABLE UTENT ALTER COLUMN LNAUTE type VARCHAR(100);
		ALTER TABLE UTENT ALTER COLUMN DOFUTE type VARCHAR(100);
		ALTER TABLE UTENT ALTER COLUMN LOCUTE type VARCHAR(100);
		perform sp_restoreviews('utent');

		perform sp_backupanddropviews('uffint');
		ALTER TABLE UFFINT ALTER COLUMN CITEIN type VARCHAR(100);
		ALTER TABLE UFFINT ALTER COLUMN LNAEIN type VARCHAR(100);
		ALTER TABLE UFFINT ALTER COLUMN DOFEIN type VARCHAR(100);
		perform sp_restoreviews('uffint');

		update eldaver set numver = 'M1.19.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();



CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver = 'M1.19.0') THEN

		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='C_LOC.COMP_G.GENE';

		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='LOCIMP.IMPR.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='CNATEC.IMPR.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='DOFIMP.IMPR.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='LINAIL.IMPR.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='LCEDIL.IMPR.GENE';
		UPDATE C0CAMPI SET C0C_FS='A2000' WHERE C0C_MNE_BER='G_OGGSOC';
		
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='INDLOC.IMPIND.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='CITEIN.PUNTICON.GENE';
		
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='LOCTIM.TEIM.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='CNATIM.TEIM.GENE';
		
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='LOCTEC.TECNI.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='DOFTEC.TECNI.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='CNATEC.TECNI.GENE';

		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='LOCTEC.TECN.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='DOFTEC.TECN.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='CNATEC.TECN.GENE';
		
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='LNAUTE.UTENT.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='DOFUTE.UTENT.GENE';	
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='LOCUTE.UTENT.GENE';	

		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='CITEIN.UFFINT.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='LNAEIN.UFFINT.GENE';
		UPDATE C0CAMPI SET C0C_FS='A100' WHERE COC_MNE_UNI='DOFEIN.UFFINT.GENE';

		update eldaver set numver = '1.20.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.20.%') THEN
	
		IF not exists (SELECT column_name FROM information_schema.columns WHERE table_name='g_scadenz' and column_name='appoggion1') THEN
			ALTER TABLE G_SCADENZ ADD APPOGGION1 NUMERIC(5);
			ALTER TABLE G_SCADENZ ADD APPOGGION2 NUMERIC(5);
			ALTER TABLE G_SCADENZ ADD APPOGGIOD1 TIMESTAMP;
			ALTER TABLE G_SCADENZ ADD APPOGGIOD2 TIMESTAMP;
			ALTER TABLE G_SCADENZ ADD APPOGGIOS1 VARCHAR(60);
			ALTER TABLE G_SCADENZ ADD APPOGGIOS2 VARCHAR(60);
		END IF;
		
		ALTER TABLE IMPR ADD ULTDIC VARCHAR(2000);

		update eldaver set numver = 'M1.1.21.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	pre1210_esiste_riga numeric(10) := 0;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver = 'M1.1.21.0') THEN
		
		if(select count(*) = 0 from tab5 where tab5cod='G_j07' and tab5desc like '_.%') then
			update tab5 set tab5desc=substr(tab5tip,5,1) ||'.'|| substr(tab5tip,6,2) ||'.'|| substr(tab5tip,8,1) ||' - '||tab5desc where tab5cod='G_j07';
		end if;
		
		select count(1) into pre1210_esiste_riga from usrsys where syscon=47;
		if (pre1210_esiste_riga <= 0) then
		end if;
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G_SCAPPOGGION1','G_SCAPPOGGION2','G_SCAPPOGGIOD1','G_SCAPPOGGIOD2','G_SCAPPOGGIOS1','G_SCAPPOGGIOS2');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'APPOGGION1.G_SCADENZ.GENE','G_SCAPPOGGION1','Campo numero di appoggio per procedura esterne','Campo appoggio num.','N5',NULL,NULL,NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'APPOGGION2.G_SCADENZ.GENE','G_SCAPPOGGION2','Campo numero di appoggio per procedura esterne','Campo appoggio num.','N5',NULL,NULL,NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'APPOGGIOD1.G_SCADENZ.GENE','G_SCAPPOGGIOD1','Campo data di appoggio per procedura esterne','Campo appoggio data','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'APPOGGIOD2.G_SCADENZ.GENE','G_SCAPPOGGIOD2','Campo data di appoggio per procedura esterne','Campo appoggio data','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'APPOGGIOS1.G_SCADENZ.GENE','G_SCAPPOGGIOS1','Campo stringa di appoggio per procedura esterne','Campo appoggio stg','A60',NULL,NULL,NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'APPOGGIOS2.G_SCADENZ.GENE','G_SCAPPOGGIOS2','Campo stringa di appoggio per procedura esterne','Campo appoggio stg','A60',NULL,NULL,NULL);
				
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G_ULTDIC');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ULTDIC.IMPR.GENE','G_ULTDIC','Ulteriori dichiarazioni dell''operatore','Ulteriori dichiaraz.','A2000',NULL,'NOTE','Ulteriori dichiarazioni dell''operatore');

		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('IMPR.GENE#36', 0, 'C', NULL, 'Anagrafico delle IMPRESE', 'CODIMP.IMPR.GENE', 'APPA.LAVO', 'CODIMPSUBENT.APPA.LAVO', 'g_impr2', 'g_impr1', 'g_impr0');	

		Update tabsche set tabcod5='M400' where tabcod='S2003' and tabcod1= '09' and tabdesc='FIUMICELLO VILLA VICENTINA';
		Update tabsche set tabcod5='M399' where tabcod='S2003' and tabcod1= '09' and tabdesc='TREPPO LIGOSULLO';

		update eldaver set numver = '1.21.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();



CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
 maxtip INT;
 conta INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.21.%') THEN
	
		--Nuova tipologia 'Rete di imprese - soggetto' - valore introdotto nella patch 9.0.2 di Appalti
		if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='Ag008' and TAB1TIP=14 and TAB1DESC='Rete di imprese con soggettività giuridica (art.45 c.2/f DLgs 50/2016)') = 0) then
			if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='Ag008' and TAB1TIP=14 and (TAB1DESC is null or TAB1DESC!='Rete di imprese con soggettività giuridica (art.45 c.2/f DLgs 50/2016)')) = 1) then
				maxtip := 0;
				SELECT MAX(TAB1TIP) INTO maxtip FROM TAB1 WHERE TAB1COD='Ag008';
				conta := maxtip + 1;
				UPDATE TAB1 SET TAB1TIP=conta WHERE TAB1COD='Ag008' and TAB1TIP=14;
				IF exists (select tablename from pg_tables where upper(tablename) = 'GARE') THEN
					conta := maxtip + 1;
					UPDATE DOCUMGARA SET CONTESTOVAL=conta WHERE CONTESTOVAL=14;
					UPDATE ARCHDOCG SET CONTESTOVAL=conta WHERE CONTESTOVAL=14;
				END IF;
			end if;
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag008', 14, 'Rete di imprese con soggettività giuridica (art.45 c.2/f DLgs 50/2016)', '1', 3.5);
		end if;

                update eldaver set numver = '1.22.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
-- Procedura che concatena alla stringa passata come parametro, il separatore ed il numero
CREATE OR REPLACE FUNCTION aggiornaValore(numero IN Numeric, stringaIn IN varchar, separatore IN varchar) RETURNS varchar AS $$
DECLARE
       stringaOut  varchar(30);

BEGIN
       if(numero < 3 )  then
            stringaOut :=  stringaIn || separatore || '10';
       end if;
       if(numero >= 3 )  then
            stringaOut :=   stringaIn || separatore || cast(numero - 2 as text);
       end if;
       return  stringaOut;
END;
$$ LANGUAGE plpgsql;


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
codiceImp varchar(10);
  cA Numeric(2):= 0;
  cB Numeric(2):= 0;
  cC Numeric(2):= 0;
  cD Numeric(2):= 0;
  ce Numeric(2):= 0;
  cF Numeric(2):= 0;
  cG Numeric(2):= 0;
  cH Numeric(2):= 0;
  cI Numeric(2):= 0;
  newWlsezio varchar(30):= '';

  ciclo_impr cursor for select codimp from impr where wlsezio is not null and LENGTH(wlsezio) > 1;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.22.%') THEN
	         --aggiornamento del campo WLSEZIO di IMPR
                 open ciclo_impr;
                 loop
	             fetch ciclo_impr into codiceImp;
                     if not found then
                        exit;
                     end if;
                     newWlsezio:='';

                     cA :=null;
                     cB :=null;
                     cC :=null;
                     cD :=null;
                     ce :=null;
                     cF :=null;
                     cG :=null;
                     cH :=null;
                     cI :=null;

                     select into cA,cB,cC,cD,cE,cF,cG,cH,cI NULLIF(split_part(wlsezio,'-',1),'') ::numeric, NULLIF(split_part(wlsezio,'-',2),'') ::numeric,
                      NULLIF(split_part(wlsezio,'-',3),'')::numeric , NULLIF(split_part(wlsezio,'-',4),'')::numeric ,
                      NULLIF(split_part(wlsezio,'-',5),'')::numeric , NULLIF(split_part(wlsezio,'-',6),'')::numeric ,
                      NULLIF(split_part(wlsezio,'-',7),'')::numeric , NULLIF(split_part(wlsezio,'-',8),'')::numeric ,
                      NULLIF(split_part(wlsezio,'-',9),'')::numeric  from impr where  codimp=codiceImp;

                       if (cA is not null) then
                         newWlsezio := aggiornaValore(cA,newWlsezio,'');

                       end if;
                       if (cB is not null) then
                          newWlsezio := aggiornaValore(cB,newWlsezio,'-');

                       end if;
                       if (cC is not null) then
                          newWlsezio :=aggiornaValore(cC,newWlsezio,'-');

                       end if;
                       if (cD is not null) then
                          newWlsezio := aggiornaValore(cD,newWlsezio,'-');

                       end if;
                       if (cE is not null) then
                          newWlsezio := aggiornaValore(cE,newWlsezio,'-');

                       end if;
                       if (cF is not null) then
                          newWlsezio := aggiornaValore(cF,newWlsezio,'-');

                       end if;
                       if (cG is not null) then
                          newWlsezio := aggiornaValore(cG,newWlsezio,'-');

                       end if;
                       if (cH is not null) then
                          newWlsezio := aggiornaValore(cH,newWlsezio,'-');

                       end if;
                        if (cI is not null) then
                          newWlsezio := aggiornaValore(cI,newWlsezio,'-');

                       end if;

        
                       update impr set wlsezio=newWlsezio where codimp= codiceImp;
                 end loop;
                 close ciclo_impr;

                 update IMPR set WLSEZIO = '10' where LENGTH(WLSEZIO)=1 and  TO_NUMBER(WLSEZIO,'99999') < 3;
                 update IMPR set WLSEZIO = cast(TO_NUMBER(WLSEZIO,'99999') - 2 as text) where LENGTH(WLSEZIO)=1 and TO_NUMBER(WLSEZIO,'99999') > 2 and TO_NUMBER(WLSEZIO,'99999') <10;

                 update eldaver set numver = 'M1.1.23.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
drop function aggiornaValore(Numeric, varchar, varchar);

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE tabtip INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver = 'M1.1.23.0') THEN
	
		Delete from tabsche where tabcod='S2003' and tabcod1='09' and tabcod2 in ('8668','8669','8670','8671');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8668', 'PRESICCE-ACQUARICA', '016075098', '73054', 'M428');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8669', 'BORGO D''ANAUNIA', '004022252', '38013', 'M429');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8670', 'NOVELLA', '004022253', '38028', 'M430');
		INSERT INTO tabsche (tabcod, tabcod1, tabcod2, tabdesc, tabcod3, tabcod4, tabcod5) VALUES ('S2003', '09', '8671', 'VILLE DI FIEMME', '004022254', '38099', 'M431');
         
		if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='Ag021' and TAB1TIP=447 and TAB1DESC = 'European Certification Institute Ltd') = 0) then
			update tab1 set  TAB1NORD =  TAB1TIP where  TAB1COD = 'Ag021' and TAB1TIP < 174 and (TAB1ARC is null or TAB1ARC <> '1') ;
			update tab1 set  TAB1NORD =  TAB1TIP + 1  where  TAB1COD = 'Ag021' and TAB1TIP >= 174 and (TAB1ARC is null or TAB1ARC <> '1') ;
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('Ag021',447,'European Certification Institute Ltd',NULL,174,NULL);
		end if;
		--Forza il n.ordine nel caso in cui la voce sia stata inserita in precedenza
		UPDATE TAB1 SET TAB1NORD=174 where TAB1COD='Ag021' and TAB1TIP=447; 

		if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='Ag021' and TAB1TIP=448 and TAB1DESC = 'Alcumus ISOQAR Ltd') = 0) then
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('Ag021',448,'Alcumus ISOQAR Ltd',NULL,23.5,NULL); 
		end if;

		delete from tab1 where tab1cod='G_061';
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 1, 'Estrazione, fornitura e trasporto di terra e materiali inerti', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 2, 'Confezionamento, fornitura e trasporto di calcestruzzo e di bitume', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 3, 'Noli a freddo di macchinari', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 4, 'Fornitura di ferro lavorato', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 5, 'Noli a caldo', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 6, 'Autotrasporto per conto di terzi', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 7, 'Guardiania dei cantieri', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 8, 'Servizi funerari e cimiteriali', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 9, 'Ristorazione, gestione delle mense e catering', NULL, 0);
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('G_061', 10, 'Servizi ambientali', NULL, 0);

		--Aggiorna voce inserita in seguito a errore di codifica nello script di aggiornamento 1.22.0
		update TAB1 SET TAB1DESC='Rete di imprese con soggettività giuridica (art.45 c.2/f DLgs 50/2016)' where TAB1COD='Ag008' and TAB1TIP=14;
		--Elimina eventuale occ. doppia inserita in seguito a errore di codifica del carattere accentato
		if (SELECT count(TAB1TIP)=1 FROM TAB1 WHERE TAB1COD='Ag008' and TAB1TIP<>14 and TAB1DESC like 'Rete di imprese con soggettivi%giuridica (art.45 c.2/f DLgs 50/2016)') then
			tabtip :=0;
			SELECT TAB1TIP into tabtip FROM TAB1 WHERE TAB1COD='Ag008' and TAB1TIP<>14 and TAB1DESC like 'Rete di imprese con soggettivi%giuridica (art.45 c.2/f DLgs 50/2016)';
			IF exists (select tablename from pg_tables where upper(tablename) = 'GARE') THEN
				UPDATE DOCUMGARA SET CONTESTOVAL=14 WHERE CONTESTOVAL=tabtip;
				UPDATE ARCHDOCG SET CONTESTOVAL=14 WHERE CONTESTOVAL=tabtip;
			end if;
			UPDATE IMPR SET TIPIMP=14 WHERE TIPIMP=tabtip;
			DELETE FROM tab1 where TAB1COD='Ag008'and TAB1TIP=tabtip;
		end if;

		 update eldaver set numver = '1.23.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver like '1.23.%') THEN

		ALTER TABLE IMPR ADD SOCIOUNICO VARCHAR(1);
		ALTER TABLE IMPR ADD REGFISC NUMERIC(7);
		ALTER TABLE IMPR ADD DINTSOA TIMESTAMP;
		
		create table sto_uffint (
			id NUMERIC(12) not null,
			codein VARCHAR(16),
			data_fine_validita TIMESTAMP,
			nomein VARCHAR(254),
			viaein VARCHAR(60),
			nciein VARCHAR(10),
			codcit VARCHAR(9),
			citein VARCHAR(100),
			proein VARCHAR(2),
			capein VARCHAR(5),
			codnaz NUMERIC(7),
			telein VARCHAR(50),
			faxein VARCHAR(20),
			cfein VARCHAR(16),
			tipoin NUMERIC(7),
			emaiin VARCHAR(100),
			emai2in VARCHAR(100),
			iscuc VARCHAR(1),
			cfanac VARCHAR(20),
		primary key (ID));

        update eldaver set numver = 'M1.1.24.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'G_' and numver = 'M1.1.24.0') THEN
	
		INSERT INTO tab6 (tab6cod, tab6tip, tab6desc) VALUES ('G__1', 'G_070', 'Regime fiscale');
	
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',1,'Regime ordinario',NULL,'1',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',2,'Contribuenti minimi (art.1, c.96-117, L. 244/07)',NULL,'3',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',4,'Agricoltura e attivitÃ  connesse e pesca (artt.34 e 34-bis, DPR 633/72)',NULL,'4',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',5,'Vendita sali e tabacchi (art.74, c.1, DPR. 633/72)',NULL,'5',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',6,'Commercio fiammiferi (art.74, c.1, DPR  633/72)',NULL,'6',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',7,'Editoria (art.74, c.1, DPR  633/72)',NULL,'7',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',8,'Gestione servizi telefonia pubblica (art.74, c.1, DPR 633/72)',NULL,'8',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',9,'Rivendita documenti di trasporto pubblico e di sosta (art.74, c.1, DPR  633/72)',NULL,'9',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',10,'Intrattenimenti, giochi e altre attivitÃ  di cui alla tariffa allegata al DPR 640/72 (art.74, c.6, DPR 633/72)',NULL,'10',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',11,'Agenzie viaggi e turismo (art.74-ter, DPR 633/72)',NULL,'11',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',12,'Agriturismo (art.5, c.2, L. 413/91)',NULL,'12',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',13,'Vendite a domicilio (art.25-bis, c.6, DPR  600/73)',NULL,'13',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',14,'Rivendita beni usati, oggetti d''arte, d''antiquariato o da collezione (art.36, DL 41/95)',NULL,'14',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',15,'Agenzie di vendite all''asta di oggetti d''arte, antiquariato o da collezione (art.40-bis, DL 41/95)',NULL,'15',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',16,'IVA per cassa P.A. (art.6, c.5, DPR 633/72)',NULL,'16',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',17,'IVA per cassa (art. 32-bis, DL 83/2012)',NULL,'17',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',18,'Altro',NULL,'18',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('G_070',19,'Regime forfettario (art.1, c.54-89, L. 190/2014)',NULL,'2',NULL);

		--Nuovo valore Organismo certificato iso9001
		if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='Ag021' and TAB1TIP=449) = 0) then
			INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('Ag021',449,'Universal GmbH',null,430.5);
		end if;
		
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL,'REGFISC.IMPR.GENE', 'G_REGFISC', 'Regime fiscale', 'Regime fiscale', 'A100', 'G_070',  NULL, NULL);		
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'SOCIOUNICO.IMPR.GENE', 'G_SOCIOUNI', 'Impresa a socio unico?', 'Socio unico?', 'A2', NULL, 'SN', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DINTSOA.IMPR.GENE', 'G_DINTSOA', 'Data scadenza intermedia attestazione SOA (consorzi stabili)', 'D.scad.interm.SOA', 'A10', NULL, 'DATA_ELDA', 'Data scadenza intermedia (cons.stab.)');
	
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0,'E','P','ID.STO_UFFINT.GENE','STO_ID','ID storico','ID storico','N12',null,null,'ID storico');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODEIN.STO_UFFINT.GENE', 'STO_CODEIN', 'Codice dell''ufficio intestatario', 'Codice', 'A16', NULL, NULL, 'Codice dell''anagrafico');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DATA_FINE_VALIDITA.STO_UFFINT.GENE', 'STO_DATFV', 'Data fine validita''', 'Data fine validita''', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'NOMEIN.STO_UFFINT.GENE', 'STO_NOMEIN', 'Denominazione', 'Denominazione', 'A254', NULL, 'NOTE', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'VIAEIN.STO_UFFINT.GENE', 'STO_VIAEIN', 'Indirizzo (via/piazza/corso)', 'Indirizzo', 'A60', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'NCIEIN.STO_UFFINT.GENE', 'STO_NCIEIN', 'Numero civico', 'N.Civico', 'A10', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CITEIN.STO_UFFINT.GENE', 'STO_CITEIN', 'Localita''dell''intestatario', 'Comune', 'A100', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'PROEIN.STO_UFFINT.GENE', 'STO_PROEIN', 'Provincia dell''intestatario', 'Provincia', 'A100', 'Agx15', NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CAPEIN.STO_UFFINT.GENE', 'STO_CAPEIN', 'Codice di avviamento postale', 'C.A.P.', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TELEIN.STO_UFFINT.GENE', 'STO_TELEIN', 'Telefono', 'Telefono', 'A50', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'FAXEIN.STO_UFFINT.GENE', 'STO_FAXEIN', 'FAX', 'FAX', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CFEIN.STO_UFFINT.GENE', 'STO_CFEIN', 'Codice fiscale', 'Codice fiscale', 'A16', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TIPOIN.STO_UFFINT.GENE', 'STO_TIPOIN', 'Tipo di amministrazione', 'Tipologia', 'A100', 'G_044', NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODCIT.STO_UFFINT.GENE', 'STO_CODCIT', 'Codice ISTAT del comune', 'Cod.ISTAT comune', 'A9', NULL, NULL, 'Codice ISTAT del comune');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODNAZ.STO_UFFINT.GENE', 'STO_CODNAZ', 'Nazione', 'Nazione', 'A2', 'Ag010', NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'EMAIIN.STO_UFFINT.GENE', 'STO_EMAIIN', 'Indirizzo E-mail', 'E-mail', 'A100', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'EMAI2IN.STO_UFFINT.GENE', 'STO_EMAI2IN', 'Indirizzo PEC', 'PEC', 'A100', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ISCUC.STO_UFFINT.GENE', 'STO_ISCUC', 'Centrale unica di committenza?', 'Centr.Unica Commit.?', 'A2', NULL, 'SN', 'Centrale unica di committenza?');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CFANAC.STO_UFFINT.GENE', 'STO_CFANAC', 'Codice fiscale fittizio assegnato da ANAC', 'Codice fiscale ANAC', 'A20', NULL, NULL, 'Codice fiscale fittizio ANAC (valorizzare quando non disponibile il codice fiscale)');

		delete from c0campi where c0c_mne_ber in ('PIVIMP','CFIMPE','CFIMPO','CFIMPC');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800102031, 'E', NULL, 'PIVIMP.IMPR.GENE', 'PIVIMP', 'Partita I.V.A. o V.A.T.', 'Partita I.V.A.', 'A16', NULL, NULL, 'Partita I.V.A. o V.A.T.');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800102032, 'C', NULL, 'PIVIMP.IMPR.GENE', 'CFIMPE', 'Partita I.V.A.', 'Partita I.V.A.', 'A16', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800102033, 'C', NULL, 'PIVIMP.IMPR.GENE', 'CFIMPO', 'Partita I.V.A.', 'Partita I.V.A.', 'A16', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800102034, 'C', NULL, 'PIVIMP.IMPR.GENE', 'CFIMPC', 'Partita I.V.A.', 'Partita I.V.A.', 'A16', NULL, NULL, NULL);
		delete from c0campi where c0c_mne_ber in ('IVAEIN');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (880038181, 'E', NULL, 'IVAEIN.UFFINT.GENE', 'IVAEIN', 'Partita I.V.A. o V.A.T.', 'Partita I.V.A.', 'A16', NULL, NULL, 'Partita I.V.A. o V.A.T.');
		delete from c0campi where c0c_mne_ber in ('G_PIVATEC');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800109064, 'E', NULL, 'PIVATEC.TECNI.GENE', 'G_PIVATEC', 'Partita I.V.A. o V.A.T.', 'Partita I.V.A.', 'A16', NULL, NULL, 'Partita I.V.A. o V.A.T.');
		delete from c0campi where c0c_mne_ber in ('G_PIVATEI');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800107038, 'E', NULL, 'PIVATEI.TEIM.GENE', 'G_PIVATEI', 'Partita I.V.A. o V.A.T.', 'Partita I.V.A', 'A16', NULL, NULL, 'Partita I.V.A. o V.A.T.');
		delete from c0campi where c0c_mne_ber in ('PIVAUTE');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (800110017, 'E', 'I', 'PIVAUTE.UTENT.GENE', 'PIVAUTE', 'Partita I.V.A. o V.A.T.', 'Partita I.V.A', 'A16', NULL, NULL, 'Partita I.V.A. o V.A.T.');

		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('STO_UFFINT.GENE',0,'E','STO_UFFINT','Storico uffici intestatari','ID.STO_UFFINT.GENE',null,null,null,null,'sto_uffint');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('UFFINT.GENE#8',0, 'C',NULL,NULL,'CODEIN.UFFINT.GENE','STO_UFFINT.GENE','CODEIN.STO_UFFINT.GENE',NULL,NULL,'g_10uffi');
		
		--E.C. - In accordo con S.C., viene eliminata occorrenza C0ENTITI con C0ENTIT.C0E_NOM='IMPR.GENE#36' (introdotta in GENE 1.21.0):
		DELETE FROM C0ENTIT WHERE C0E_NOM='IMPR.GENE#36';
		
		update eldaver set numver = '1.24.0', datvet = now() where codapp = 'G_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.1' or numver like '2.1.1.%')) THEN
	
		CREATE TABLE W_MAIL (
			CODAPP VARCHAR(10) NOT NULL,
			IDCFG VARCHAR(16) NOT NULL,
			SERVER VARCHAR(100),
			PORTA VARCHAR(100),
			PROTOCOLLO VARCHAR(100),
			TIMEOUT VARCHAR(100),
			TRACCIATURA_MESSAGGI VARCHAR(1),
			MAIL_MITTENTE VARCHAR(100),
			PASSWORD VARCHAR(100),
			ID_USER VARCHAR(100),
			DIM_TOT_ALLEGATI VARCHAR(100),
			PRIMARY KEY (CODAPP, IDCFG));

		insert into w_mail (codapp,idcfg,server,porta,protocollo,timeout,tracciatura_messaggi,mail_mittente,password,id_user,dim_tot_allegati)
		select codapp, 'STD',
		case when (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.server') is null then (select valore from w_config c_spec where c_spec.codapp='W_' and chiave ='mail.server') else (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.server') end as server,
		case when (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.porta') is null then (select valore from w_config c_spec where c_spec.codapp='W_' and chiave ='mail.porta') else (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.porta') end as porta,
		case when (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.protocollo') is null then (select valore from w_config c_spec where c_spec.codapp='W_' and chiave ='mail.protocollo') else (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.protocollo') end as protocollo,
		case when (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.timeout') is null then (select valore from w_config c_spec where c_spec.codapp='W_' and chiave ='mail.timeout') else (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.timeout') end as timeout,
		case when (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.debug') is null then (select valore from w_config c_spec where c_spec.codapp='W_' and chiave ='mail.debug') else (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.debug') end as debug,
		case when (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.indirizzoApplicativo') is null then (select valore from w_config c_spec where c_spec.codapp='W_' and chiave ='mail.indirizzoApplicativo') else (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.indirizzoApplicativo') end as mittente,
		case when (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.passwordApplicativo') is null then (select valore from w_config c_spec where c_spec.codapp='W_' and chiave ='mail.passwordApplicativo') else (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.passwordApplicativo') end as password,
		case when (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.useridApplicativo') is null then (select valore from w_config c_spec where c_spec.codapp='W_' and chiave ='mail.useridApplicativo') else (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.useridApplicativo') end as userid,
		case when (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.limiteDimensioneAllegati') is null then (select valore from w_config c_spec where c_spec.codapp='W_' and chiave ='mail.limiteDimensioneAllegati') else (select valore from w_config c_spec where c_spec.codapp=a.codapp and chiave ='mail.limiteDimensioneAllegati') end as maxdimallegati
		from (select distinct codapp from w_config where codapp <> 'W_') a
		where 'STD' not in (select idcfg from w_mail where w_mail.codapp=a.codapp);
		
		DELETE FROM W_CONFIG where chiave like 'mail.%';

		ALTER TABLE W_INVCOM ADD IDCFG VARCHAR(16) NULL;

		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) values ('COLS', 'VIS', 'GENE.TAB0.*', 'Visualizza', 1, 1, 1, 1611370584);
		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) VALUES ('COLS', 'VIS', 'GENE.TAB1.*', 'Visualizza', 1, 1, 1, 2874622973);
		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) VALUES ('COLS', 'VIS', 'GENE.TAB2.*', 'Visualizza', 1, 1, 1, 767766867);
		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) VALUES ('COLS', 'VIS', 'GENE.TAB3.*', 'Visualizza', 1, 1, 1, 3869238006);
		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) VALUES ('COLS', 'VIS', 'GENE.TAB4.*', 'Visualizza', 1, 1, 1, 4221227598);
		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) values ('COLS', 'VIS', 'GENE.TAB5.*', 'Visualizza', 1, 1, 1, 818282987);
		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) VALUES ('COLS', 'VIS', 'GENE.TAB6.*', 'Visualizza', 1, 1, 1, 3058856773);
		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) values ('COLS', 'VIS', 'GENE.V_TAB4_TAB6.*', 'Visualizza', 1, 1, 1, 2916393329);
		UPDATE c0entit set coe_arg = 'DETTPROF' where c0e_nom = 'W_PROAZI.GENEWEB';
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('W_OGGETTI.GENEWEB', 10000000, 'P', 'OGGETTI', 'Definizioni oggetti configurabili da profilo', 'TIPO.W_OGGETTI.GENEWEB,OGGETTO.W_OGGETTI.GENEWEB', NULL, NULL, NULL, NULL, 'g1_ogg0');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (100000001, 'P', 'P', 'TIPO.W_OGGETTI.GENEWEB', 'W_TIPOGG', 'Tipo di oggetto', 'Tipo oggetto', 'A10', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (100000001, 'P', 'P', 'OGGETTO.W_OGGETTI.GENEWEB', 'W_IDOGG', 'Identificativo oggetto', 'ID Oggetto', 'A100', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (100000001, 'P', NULL, 'DESCR.W_OGGETTI.GENEWEB', 'W_DESCROGG', 'Descrizione', 'Descrizione', 'A120', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (100000001, 'P', NULL, 'ORD.W_OGGETTI.GENEWEB', 'W_ORDOGG', 'Numero d''ordine', 'Num. ordine', 'N12', NULL, NULL, NULL);
		
		INSERT INTO C0CAMPI (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (100000001, 'E', NULL, 'IDCFG.W_INVCOM.GENEWEB', 'COMIDCFG', 'ID configurazione', 'ID configurazione', 'A16', NULL, NULL, NULL);


		update eldaver set numver = '2.1.2', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.2' or numver like '2.1.2.%')) THEN
	
		perform sp_backupanddropviews('w_profili');
		alter table w_profili alter column nome type varchar(100);
		alter table w_profili alter column descrizione type varchar(500);
		perform sp_restoreviews('w_profili');

		DELETE FROM c0campi WHERE coc_mne_uni = 'NOME.W_PROFILI.GENEWEB';
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (100000003, 'P', NULL, 'NOME.W_PROFILI.GENEWEB', 'W_NOME', 'Nome profilo (obbligatorio)', 'Nome profilo', 'A100', NULL, NULL, NULL);
		DELETE FROM c0campi WHERE coc_mne_uni = 'DESCRIZIONE.W_PROFILI.GENEWEB';
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (100000004, 'P', NULL, 'DESCRIZIONE.W_PROFILI.GENEWEB', 'W_DESCRIZ', 'Descrizione del profilo', 'Descrizione', 'A500', NULL, 'NOTE', NULL);

		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('MASC', 'GENE.G_SCADENZ-timeline', 'Sequenza temporale', 1855);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'ALT.GENE.G_SCADENZ.Timeline', 'Sequenza temporale', 1935);
		
		update eldaver set numver = '2.1.3', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.3' or numver like '2.1.3.%')) THEN
	
		update c0campi set c0c_fs = 'N6' where coc_mne_uni = 'COD_CLIENTE.W_PROFILI.GENEWEB';
		
		--gestione permessi dl229
		INSERT INTO w_accliv (tabella, discr, liv1, liv2, valore) VALUES ('PROG_ANAG', 'SYSAB3', 'ID', NULL, 'IDCUP');
		
		-- Nuovi campi per integrazione protocollo ENGINEERING
		ALTER TABLE WSLOGIN ADD IDUTENTE VARCHAR(50) NULL;
		ALTER TABLE WSLOGIN ADD IDUTENTEUNOP VARCHAR(50) NULL;
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'IDUTENTE.WSLOGIN.GENEWEB', 'WSLOIDUTENTE', 'Id. utente', 'Id. utente', 'A50', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'IDUTENTEUNOP.WSLOGIN.GENEWEB', 'WSLOIDUTENTEUNOP', 'Id. UO utente', 'Id. UO utente', 'A50', NULL, NULL, NULL);
		
		update eldaver set numver = '2.1.4', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.4' or numver like '2.1.4.%')) THEN
		-- aumento la dimensione del campo  per compatibilita' con il codice applicazione '229'
		perform sp_backupanddropviews('w_docdig');
		ALTER TABLE W_DOCDIG ALTER COLUMN IDPRG TYPE VARCHAR(3);
        perform sp_restoreviews('w_docdig');
		
		DELETE FROM c0campi WHERE coc_mne_uni = 'IDPRG.W_DOCDIG.GENEWEB';
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (100000301, 'E', 'P', 'IDPRG.W_DOCDIG.GENEWEB', 'DIGIDPRG', 'Codice applicativo', 'Codice applicativo', 'A3', NULL, NULL, NULL);

		-- eliminazione fk per permettere la gestione delle credenziali comuni
		ALTER TABLE wslogin DROP CONSTRAINT wslogin_fk;
		
		--Nuova voce per funzione 'Nuovo' nella lista di selezione da archivio TEIM
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'INS.GENE.ListaTeim.nuovo', 'Nuovo tecnico (popup selezione archivio)', 1685);

		update eldaver set numver = '2.1.5', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.5' or numver like '2.1.5.%')) THEN
		
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('UFFSET',0);

		--Aggiornamento profili
		-- Aggiornamento per Configurazione codifica automatica
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GENE.G_CONFCOD-lista','Lista configurazione codifica automatica',1990);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GENE.G_CONFCOD-scheda','Scheda configurazione codifica automatica',2000);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GENE.G_CONFCOD-lista.MOD','Modifica',2010);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GENE.G_CONFCOD-scheda.SCHEDAMOD','Modifica',2020);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SUBMENU','AMMINISTRAZIONE.Configurazione-G_CONFCOD','Configurazione codifica automatica',2030);

        --Nuova sezione dinamica Settori per gli uffici intestatari
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('SEZ', 'GENE.SchedaUffint.UFFSET', 'Sezione dinamica settori', 1736);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'INS.GENE.SchedaUffint.INS-UFFSET', 'Nuovo settore', 1739);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'DEL.GENE.SchedaUffint.DEL-UFFSET', 'Elimina settore', 1740);

        INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) values ('SEZ', 'VIS', 'GENE.SchedaUffint.UFFSET', 'Visualizza', 0, 1, 1, 2354783444);
        INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) values ('FUNZ', 'VIS', 'INS.GENE.SchedaUffint.INS-UFFSET', 'Visualizza', 0, 1, 1, 1133224913);
        INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) values ('FUNZ', 'VIS', 'DEL.GENE.SchedaUffint.DEL-UFFSET', 'Visualizza', 0, 1, 1, 1651293914);

		update eldaver set numver = '2.1.6', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.6' or numver like '2.1.6.%')) THEN
		
		update eldaver set numver = '2.1.7', datvet = now() where codapp = 'W_';

		END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.7' or numver like '2.1.7.%')) THEN
		
		update eldaver set numver = '2.1.8', datvet = now() where codapp = 'W_';

		END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento() 
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.8' or numver like '2.1.8.%')) THEN

		-- Allineamento campo al corrispondente in W_PROFILI
		perform sp_backupanddropviews('w_gruppi');
		ALTER TABLE W_GRUPPI ALTER COLUMN NOME TYPE VARCHAR(100);
		perform sp_restoreviews('w_gruppi');

		-- Nuovo campo 'Richiesta firma?'
		ALTER TABLE W_DOCDIG ADD DIGFIRMA VARCHAR(1);
		DELETE FROM c0campi WHERE c0c_mne_ber in ('DIGFIRMA');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DIGFIRMA.W_DOCDIG.GENEWEB', 'DIGFIRMA', 'Documento in attesa di firma?', 'Richiesta firma?', 'A2', NULL, 'SN', NULL);
		
		-- Aggiornamenti per Anagrafica impresa: nuova sezione 'White list'
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GENE.ImprScheda.DATIGEN.WHLA','Iscrizione white list antimafia per l''impresa',1006);
		
		-- Aggiornamenti per Anagrafica impresa: gestione DURC
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('PAGE','GENE.ImprScheda.DURC','Pagina "DURC on line"',940);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GENE.ImprScheda.DURC.DEL','Elimina DURC on line',13420);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GENE.ImprScheda.DURC.LISTADELSEL','Elimina DURC on line selezionati',13430);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GENE.ImprScheda.DURC.LISTANUOVO','Nuovo DURC on line',13440);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GENE.ImprScheda.DURC.MOD','Modifica DURC on line',13450);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GENE.ImpdurcScheda','Scheda DURC on line per l''impresa',13460);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GENE.ImpdurcScheda.SCHEDAMOD','Modifica DURC on line per l''impresa',13470);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GENE.ImpdurcScheda.SCHEDANUOVO','Nuovo DURC on line per l''impresa',13480);
		
		-- aggiunta menu dell'utente loggato della voce "Il mio account" voce nascosta da profilo di default
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('SUBMENU', 'UTILITA.Mio-account', 'Il mio account', 1448);
		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) VALUES ('SUBMENU', 'VIS', 'UTILITA.Mio-account', 'Visualizza', 0, 1, 1, 998611131);

		-- mappatura mancante del tipo comunicazione
		INSERT INTO tab3 (tab3cod, tab3tip, tab3desc, tab3mod, tab3nord) VALUES ('G_x10', 'FS12', 'Comunicazione generica verso l''Ente', NULL, NULL);

		-- Aggiornamenti per C0CAMPI
		--Modifica il formato del campo COMDATAPUB a TIMESTAMP 
		UPDATE C0CAMPI SET COC_DOM='TIMESTAMP' WHERE C0C_MNE_BER='COMDATPUB';
		--Abilitata la visibilita' (C0C_TIP da 'P' a 'E') per i campi COMPUB, COMDATAPUB, COMNUMPROT, COMDATPROT 
		UPDATE C0CAMPI SET C0C_TIP='E' WHERE  C0C_MNE_BER in ('COMPUB','COMDATPUB','COMNUMPROT','COMDATPROT');
		
		update eldaver set numver = '2.1.9', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.9' or numver like '2.1.9.%')) THEN

		-- Nuovo campo 'Codice AOO'
		ALTER TABLE WSFASCICOLO ADD CODAOO VARCHAR(30);
		DELETE FROM c0campi WHERE c0c_mne_ber in ('WSCODAOO');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODAOO.WSFASCICOLO.GENEWEB ', 'WSCODAOO', 'Codice AOO (Amministrazione organizzativa)', 'Codice AOO', 'A30', NULL, NULL, NULL);

                -- Nuovo campo delay
		ALTER TABLE W_MAIL ADD DELAY VARCHAR(6);

		update eldaver set numver = '2.1.10', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.10' or numver like '2.1.10.%')) THEN

		-- aggiornata configurazione sulla durata password con miglioramento descrizione ed abbassamento del tempo massimo della durata
		update w_config set descrizione = 'Durata della password (espressa in GIORNI) per utenti con abilitazione alla sicurezza password' where chiave='it.eldasoft.account.durataPassword';	
		update w_config set valore = '90' where chiave='it.eldasoft.account.durataPassword' and TO_NUMBER(valore,'999') > 90;
		
		-- in seguito alla definizione dei nuovi utenti 48 (ADMIN) e 49 (EnteAdmin) si creano le medesime associazioni con gruppi e profili dell'utente 50 (MANAGER)
		insert into w_accgrp (id_account, id_gruppo, priorita) select 48, id_gruppo, priorita from w_accgrp where id_account = 50 and not exists (select id_gruppo from w_accgrp grp2 where id_account = 48 and w_accgrp.id_gruppo = grp2.id_gruppo);
		insert into w_accgrp (id_account, id_gruppo, priorita) select 49, id_gruppo, priorita from w_accgrp where id_account = 50 and not exists (select id_gruppo from w_accgrp grp2 where id_account = 49 and w_accgrp.id_gruppo = grp2.id_gruppo);
		insert into w_accpro (id_account, cod_profilo) select 48, cod_profilo from w_accpro where id_account = 50 and not exists (select cod_profilo from w_accpro pro2 where id_account = 48 and w_accpro.cod_profilo = pro2.cod_profilo);
		insert into w_accpro (id_account, cod_profilo) select 49, cod_profilo from w_accpro where id_account = 50 and not exists (select cod_profilo from w_accpro pro2 where id_account = 49 and w_accpro.cod_profilo = pro2.cod_profilo);

		-- aumento del numero di caratteri del campo descrizione nei parametri di un report
		ALTER TABLE W_RICPARAM ALTER COLUMN DESCR TYPE VARCHAR(2000);
		ALTER TABLE W_MODPARAM ALTER COLUMN DESCR TYPE VARCHAR(2000);
		ALTER TABLE W_COMPARAM ALTER COLUMN DESCR TYPE VARCHAR(2000);

		-- tabella per semaforizzare i nodi che lanciano task di quartz sullo stesso db  (una sola esecuzione per ogni task indipendentemente dai nodi)
		CREATE TABLE W_QUARTZLOCK (
		codapp VARCHAR(10) NOT NULL,
		job VARCHAR(200) NOT NULL,
		lock_date TIMESTAMP NOT NULL,
		server_name VARCHAR(100),
		node_name VARCHAR(100),
		 primary key (CODAPP, JOB));
 
		update eldaver set numver = '2.1.11', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.11' or numver like '2.1.11.%')) THEN

		--Comunicazione archiviata
        INSERT INTO tab2 (tab2cod, tab2tip, tab2d1, tab2d2, tab2mod, tab2nord) VALUES ('G_z20', '12', 'StatoC', 'Archiviata', NULL, NULL);
                
        insert into W_OGGETTI( ORD, OGGETTO, TIPO, DESCR) values (13500, 'GENEWEB.LogEventiTrova', 'MASC', 'Trova eventi log');
        insert into W_OGGETTI( ORD, OGGETTO, TIPO, DESCR) values (13510, 'GENEWEB.LogEventiLista', 'MASC', 'Lista eventi log');
        insert into W_OGGETTI( ORD, OGGETTO, TIPO, DESCR) values (13520, 'GENEWEB.LogEventiScheda', 'MASC', 'Scheda eventi log');

		--Nascosto pagina 'Casellario giudiziale' in anagrafica impresa
		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) VALUES ('PAGE', 'VIS', 'GENE.ImprScheda.CASE', 'Visualizza', 0, 1, 1, 3116177681);

		update eldaver set numver = '2.1.12', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.12' or numver like '2.1.12.%')) THEN
		INSERT INTO w_oggetti (tipo, oggetto, descr, ORD) VALUES ('SEZ','GENE.ImprScheda.DATIGEN.ART80','Verifiche art. 80',13530);
		update eldaver set numver = '2.1.13', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.13' or numver like '2.1.13.%')) THEN
		update eldaver set numver = '2.1.14', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.14' or numver like '2.1.14.%')) THEN
		UPDATE W_CONFIG SET DESCRIZIONE = 'Tipologia protocollo SSO. Valori ammessi: 0 [default]=non prevista, 1=Shibboleth, 2=Cohesion, 3=SSOBart, 4=OpenID' WHERE CHIAVE = 'sso.protocollo';

		update eldaver set numver = '2.1.15', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.1.15' or numver like '2.1.15.%')) THEN

		ALTER TABLE WSDOCUMENTO ALTER COLUMN NUMERODOC TYPE VARCHAR(40);

                ALTER TABLE WSFASCICOLO ADD CODUFF VARCHAR(30);

                update C0CAMPI set C0C_FS = 'A40' where C0C_MNE_BER='WSDOCNDOC';

                delete from c0campi where c0c_mne_ber in ('WSCODUFF');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODUFF.WSFASCICOLO.GARE','WSCODUFF','Codice ufficio responsabile','Codice ufficio','A30',NULL,NULL,NULL);

		update eldaver set numver = '2.2.0', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and (numver = '2.2.0' or numver like '2.2.0.%')) THEN

		ALTER TABLE WSFASCICOLO ADD STRUTTURA VARCHAR(2000);

                delete from c0campi where c0c_mne_ber in ('WSSTRUTTU');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'STRUTTURA.WSFASCICOLO.GARE','WSSTRUTTU','Struttura competente','Struttura competente','A2000',NULL,NULL,NULL);

		update eldaver set numver = '2.3.0', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.3.%') THEN

		update eldaver set numver = '2.4.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.4.%') THEN

		--Nuovo stato per identificare comunicazioni da portale di cui in acquisizione deve essere solo cambiato lo stato
		INSERT INTO tab2 (tab2cod, tab2tip, tab2d1, tab2d2, tab2mod, tab2nord) VALUES ('G_z20', '13', 'StatoC', 'Evento da processare dopo correzione dati', NULL, NULL);

		update eldaver set numver = '2.5.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.5.%') THEN
		INSERT INTO tab2 (tab2cod, tab2tip, tab2d1, tab2d2, tab2mod, tab2nord) VALUES ('G_z20', '99', 'StatoC', 'Annullata', NULL, NULL);

		update eldaver set numver = '2.6.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.6.%') THEN

		update eldaver set numver = '2.7.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.7.%') THEN

        delete from c0campi where c0c_mne_ber in ('WSCODUFF','WSSTRUTTU');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODUFF.WSFASCICOLO.GENEWEB ', 'WSCODUFF', 'Codice ufficio responsabile', 'Codice ufficio', 'A30', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'STRUTTURA.WSFASCICOLO.GENEWEB ', 'WSSTRUTTU', 'Struttura competente', 'Struttura competente', 'A2000', NULL, NULL, NULL);

		update eldaver set numver = '2.8.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.8.%') THEN

		ALTER TABLE WSFASCICOLO ADD ISRISERVA VARCHAR(1);

        delete from c0campi where c0c_mne_ber in ('WSISRISERV');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ISRISERVA.WSFASCICOLO.GENEWEB ', 'WSISRISERV', 'Riservatezza attiva per il fascicolo?', 'Riservatezza attiva?', 'A2', NULL, 'SN', NULL);

		update eldaver set numver = '2.9.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.9.%') THEN

		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'ALT.GENE.SchedaUffint.Utenti', 'Associazioni utenti da scheda ufficio intestatario', 13540);
		
		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) VALUES ('FUNZ', 'VIS', 'ALT.GENE.SchedaUffint.Utenti', 'Visualizza', 0, 1, 1, 694064074);
		
		update eldaver set numver = '2.10.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	table_cnt Numeric (10) := 0;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.10.%') THEN

		ALTER TABLE W_MESSAGE_IN ALTER COLUMN MESSAGE_RECIPIENT_SYSCON TYPE NUMERIC(12) USING (MESSAGE_RECIPIENT_SYSCON::NUMERIC);
		
		update eldaver set numver = '2.11.0M1', datvet = now() where codapp = 'W_';

	END IF;
END;

$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver = '2.11.0M1') THEN
		
		DELETE FROM W_AZIONI WHERE OGGETTO = 'GENE.SchedaUffint.UFFSET';
		DELETE FROM W_AZIONI WHERE OGGETTO = 'INS.GENE.SchedaUffint.INS-UFFSET';
		DELETE FROM W_AZIONI WHERE OGGETTO = 'DEL.GENE.SchedaUffint.DEL-UFFSET';
		
		-- fix definizioni dei metadati
		DELETE FROM c0campi WHERE c0c_mne_ber = 'WSCODAOO';
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODAOO.WSFASCICOLO.GENEWEB', 'WSCODAOO', 'Codice AOO (Amministrazione organizzativa)', 'Codice AOO', 'A30', NULL, NULL, NULL);
		
		DELETE FROM c0campi WHERE c0c_mne_ber = 'WSCODUFF';
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODUFF.WSFASCICOLO.GENEWEB', 'WSCODUFF', 'Codice ufficio responsabile', 'Codice ufficio', 'A30', NULL, NULL, NULL);

		DELETE FROM c0campi WHERE c0c_mne_ber = 'WSSTRUTTU';
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'STRUTTURA.WSFASCICOLO.GENEWEB', 'WSSTRUTTU', 'Struttura competente', 'Struttura competente', 'A2000', NULL, NULL, NULL);
		
		DELETE FROM c0campi WHERE c0c_mne_ber = 'WSISRISERV';
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ISRISERVA.WSFASCICOLO.GENEWEB', 'WSISRISERV', 'Riservatezza attiva per il fascicolo?', 'Riservatezza attiva?', 'A2', NULL, 'SN', NULL);

		DELETE FROM c0entit WHERE c0e_nom = 'WSFASCICOLO.GENEWEB';
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('WSFASCICOLO.GENEWEB', 10000500, 'E', 'WSFASCICOL', 'Fascicolo documentale', 'ID.WSFASCICOLO.GENEWEB', NULL, NULL, NULL, NULL, NULL);
		
		update eldaver set numver = '2.11.0M2', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver = '2.11.0M2') THEN
		
		CREATE TABLE rpa_log (
			pkid NUMERIC(12) NOT NULL,
			data_ins TIMESTAMP NOT NULL,
			id_utente_ins NUMERIC(12) NOT NULL,
			data_upd TIMESTAMP NOT NULL,
			id_utente_upd NUMERIC(12) NOT NULL,
			count_upd NUMERIC(12) NOT NULL,
			type VARCHAR(1) NULL,
			code VARCHAR(100) NULL,
			context NUMERIC(12) NULL,
			text VARCHAR(300) NULL,
			id_session NUMERIC(12) NOT NULL,
			error_stack_trace VARCHAR(2000) NULL,
			CONSTRAINT pk_rpa_log PRIMARY KEY (pkid)
		);

		CREATE SEQUENCE seq_rpa_log;

		CREATE TABLE rpa_session (
			pkid NUMERIC(12) NOT NULL,
			data_ins TIMESTAMP NOT NULL,
			id_utente_ins NUMERIC(12) NOT NULL,
			data_upd TIMESTAMP NOT NULL,
			id_utente_upd NUMERIC(12) NOT NULL,
			count_upd NUMERIC(12) NOT NULL,
			id NUMERIC(12) NOT NULL,
			model VARCHAR(300) NULL,
			CONSTRAINT un_rpa_session_id UNIQUE (id),
			CONSTRAINT pk_rpa_session PRIMARY KEY (pkid)
		);

		CREATE SEQUENCE seq_rpa_session;
		
		update eldaver set numver = '2.11.0M3', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver = '2.11.0M3') THEN
		
		CREATE OR REPLACE VIEW rpa_c0campi AS 
		SELECT
			ROW_NUMBER() OVER () AS pkid,
			c0campi.coc_conta AS c0c_conta,
			c0campi.c0c_tip,
			c0campi.c0c_chi,
			c0campi.coc_mne_uni AS c0c_mne_uni,
			c0campi.c0c_mne_ber,
			c0campi.coc_des AS c0c_des,
			c0campi.coc_des_frm AS c0c_des_frm,
			c0campi.c0c_fs,
			c0campi.c0c_tab1,
			c0campi.coc_dom AS c0c_dom,
			c0campi.coc_des_web AS c0c_des_web,
			SUBSTR(c0campi.coc_mne_uni, LENGTH(c0campi.coc_mne_uni) - POSITION('.' IN REVERSE(c0campi.coc_mne_uni)) + 2) AS app_prefix
		FROM C0CAMPI;

		CREATE OR REPLACE VIEW rpa_c0entit AS 
		SELECT
			ROW_NUMBER() OVER () AS pkid,
			c0entit.c0e_nom,
			c0entit.c0e_num,
			c0entit.c0e_tip,
			c0entit.coe_arg AS c0e_arg,
			c0entit.c0e_des,
			c0entit.c0e_key,
			c0entit.c0e_nom_ex,
			c0entit.coe_key_ex AS c0e_key_ex,
			c0entit.c0e_frm_ri,
			c0entit.coe_frm_ca AS c0e_frm_ca,
			c0entit.coe_frm_re AS c0e_frm_re,
			SUBSTR(c0entit.c0e_key, LENGTH(c0entit.c0e_key) - POSITION('.' IN REVERSE(c0entit.c0e_key)) + 2) AS app_prefix
		FROM c0entit;

		CREATE OR REPLACE VIEW rpa_comparam AS
		SELECT 
			0 AS pkid,
			NULL::timestamp AS data_ins,
			NULL::integer AS id_utente_ins,
			NULL::timestamp AS data_upd,
			NULL::integer AS id_utente_upd,
			NULL::integer AS count_upd,
			w_comparam.id_sessione,
			w_comparam.codice,
			w_comparam.descr,
			w_comparam.valore
		FROM w_comparam;
		
		update eldaver set numver = '2.11.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.11.%') THEN
 
		CREATE TABLE w_tags 
		(codapp VARCHAR(10) NOT NULL, 
		tagcod VARCHAR(30) NOT NULL, 
		tagview VARCHAR(30),
		tagdesc VARCHAR(200), 
		tagcolor VARCHAR(20), 
		tagbordercolor VARCHAR(20), 
		tagmod VARCHAR(1),
		 primary key (CODAPP, TAGCOD));
		 
		CREATE TABLE w_tagslist 
		(codapp VARCHAR(10) NOT NULL, 
		tagcod VARCHAR(30) NOT NULL, 
		tagentity VARCHAR(30), 
		tagfield VARCHAR(30), 
		taginfo TEXT, 
		tagmod VARCHAR(1));

		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('W_TAGS.GENEWEB', 0, 'E', 'W_TAGS', 'Tag: lista delle integrazioni', 'CODAPP.W_TAGS.GENEWEB,TAGCOD.W_TAGS.GENEWEB', NULL, NULL, NULL, NULL, 'tags');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('W_TAGSLIST.GENEWEB', 0, 'E', 'W_TAGSLIST', 'Tag: lista dei tag', 'CODAPP.W_TAGSLIST.GENEWEB,TAGCOD.W_TAGSLIST.GENEWEB', 'W_TAGSLIST.GENEWEB','CODAPP.W_TAGS.GENEWEB,TAGCOD.W_TAGS.GENEWEB', NULL, NULL, 'tagslist');

		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'CODAPP.W_TAGS.GENEWEB', 'WTAGSCODAPP', 'Codice applicativo', 'Cod. app.', 'A10', NULL, NULL, 'Codice applicativo');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'TAGCOD.W_TAGS.GENEWEB', 'WTAGSTAGCOD', 'Codice integrazione', 'Cod. int.', 'A30', NULL, NULL, 'Codice integrazione');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TAGVIEW.W_TAGS.GENEWEB', 'WTAGSTAGVIEW', 'Codice etichetta', 'Cod. ett.', 'A30', NULL, NULL, 'Codice etichetta');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TAGDESC.W_TAGS.GENEWEB', 'WTAGSTAGDESC', 'Descrizione', 'Descrizione', 'A200', NULL, NULL, 'Descrizione');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TAGCOLOR.W_TAGS.GENEWEB', 'WTAGSTAGSCOLOR', 'Colore sfondo', 'Col. sfondo', 'A20', NULL, NULL, 'Colore sfondo');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TAGBORDERCOLOR.W_TAGS.GENEWEB', 'WTAGSTAGBORDERCOLOR', 'Colore bordo', 'Col. bordo', 'A20', NULL, NULL, 'Colore bordo');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TAGMOD.W_TAGS.GENEWEB', 'WTAGSTAGMOD', 'Modificabile ?', 'Mod. ?', 'A2', NULL, 'SN', 'Modificabile ?');

		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'CODAPP.W_TAGSLIST.GENEWEB', 'WTAGSLISTCODAPP', 'Codice applicativo', 'Cod. app.', 'A10', NULL, NULL, 'Codice applicativo');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'TAGCOD.W_TAGSLIST.GENEWEB', 'WTAGSLISTTAGCOD', 'Codice integrazione', 'Cod. int.', 'A30', NULL, NULL, 'Codice integrazione');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', null, 'TAGENTITY.W_TAGSLIST.GENEWEB', 'WTAGSLISTTAGENTITY', 'Entita''', 'Entita''', 'A30', NULL, NULL, 'Entita''');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', null, 'TAGFIELD.W_TAGSLIST.GENEWEB', 'WTAGSLISTTAGFIELD', 'Campo', 'Campo', 'A30', NULL, NULL, 'Campo');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', null, 'TAGINFO.W_TAGSLIST.GENEWEB', 'WTAGSLISTTAGINFO', 'Informazioni', 'Informazioni', 'A2000', NULL, 'CLOB', 'Informazioni');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TAGMOD.W_TAGSLIST.GENEWEB', 'WTAGSLISTAGMOD', 'Modificabile ?', 'Mod. ?', 'A2', NULL, 'SN', 'Modificabile ?');

		insert into w_azioni (tipo,azione,oggetto,descr,valore,inor,viselenco,crc) values ('COLS','VIS','GENEWEB.W_TAGS.*','Visualizza',1,1,1,1009627889);
		insert into w_azioni (tipo,azione,oggetto,descr,valore,inor,viselenco,crc) values ('COLS','VIS','GENEWEB.W_TAGSLIST.*','Visualizza',1,1,1,569747633);
		
		update eldaver set numver = '2.12.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.12.%') THEN
 
		update eldaver set numver = '2.13.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.13.%') THEN
	        INSERT INTO tab2 (tab2cod, tab2tip, tab2d1, tab2d2, tab2mod, tab2nord) VALUES ('G_z20', '14', 'StatoC', 'In protocollazione', NULL, NULL);
	        INSERT INTO tab2 (tab2cod, tab2tip, tab2d1, tab2d2, tab2mod, tab2nord) VALUES ('G_z20', '15', 'StatoC', 'In protocollazione con errore', NULL, NULL);
	        
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'DEL.GENE.ImprScheda.VART80.DEL', 'Lista verifiche - Elimina', 14290);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'DEL.GENE.ImprScheda.VART80.LISTADELSEL', 'Lista verifiche - Elimina selezionati', 14300);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'MOD.GENE.ImprScheda.VART80.MOD', 'Lista verifiche - Modifica', 14310);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('MASC', 'GENE.VerificheScheda', 'Scheda verifica', 14320);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('PAGE', 'GENE.VerificheScheda.DATIGEN', 'Pagina "Dati Generali"', 14330);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'MOD.GENE.VerificheScheda.DATIGEN.SCHEDAMOD', 'Modifica', 14340);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'GENE.VerificheScheda.DOCVERIF', 'Pagina "Documenti verifica"', 14350);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'DEL.GENE.VerificheScheda.DOCVERIF.DEL', 'Lista documenti verifica - Elimina', 14360);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'DEL.GENE.VerificheScheda.DOCVERIF.LISTADELSEL', 'Lista documenti verifica - Elimina selezionati', 14370);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'MOD.GENE.VerificheScheda.DOCVERIF.MOD', 'Lista documenti verifica - Modifica', 14380);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'GENE.DOCUMENTI_VERIFICHE-scheda', 'Scheda documenti verifica', 14390);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'MOD.GENE.DOCUMENTI_VERIFICHE-scheda.SCHEDAMOD', 'Modifica', 14400);
		
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('SEZ', 'GENE.ImprScheda.DATIGEN.ISCELRIC', 'Sezione Iscrizione elenchi ricostruzione (DL 189/2016)', 1007);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('SEZ', 'GENE.ImprScheda.DATIGEN.RATING', 'Sezione Rating di legalità (DL 1/2012) ', 1008);

		INSERT INTO w_note (tipo, oggetto, prog, modovis, nota) VALUES (2, 'GENE.ImprScheda.VART80', 0, '1', '<b>Legenda per Esito verifica:</b><br><br><i><b>Regolare:</b><i> verifica completata con esito giudicato positivo<br><i><b>In lavorazione:</b><i> verifica non ancora completata<br><i><b>Anomalo:</b><i> verifica completata con esito negativo<br><i><b>Non applicabile:</b><i> verifica non necessaria per la specifica tipologia di impresa/professionista<br><i><b>Regolare per S.A. </b><i>regolare per silenzio/assenso (equiparabile ad esito regolare)<br>');
		 
		update eldaver set numver = '2.14.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.14.%') THEN

	insert into w_azioni (tipo,azione,oggetto,descr,valore,inor,viselenco,crc) values ('COLS','VIS','GENE.PUNTICON.CODCONS_NSO','Visualizza',0,1,1,2682778736);
	insert into w_azioni (tipo,azione,oggetto,descr,valore,inor,viselenco,crc) values ('COLS','VIS','GENE.UFFINT.CODCONS_NSO','Visualizza',0,1,1,2084037300);
	insert into w_azioni (tipo,azione,oggetto,descr,valore,inor,viselenco,crc) values ('COLS','VIS','GENE.IMPR.ENDPOINT_NSO','Visualizza',0,1,1,2982023490);
	insert into w_azioni (tipo,azione,oggetto,descr,valore,inor,viselenco,crc) values ('COLS','VIS','GENE.UFFINT.ENDPOINT_NSO','Visualizza',0,1,1,2156470528);
	
	update eldaver set numver = '2.15.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.15.%') THEN

	delete from w_config where chiave in ('eventi.log','it.eldasoft.generatoreRicerche.tracciaTabelle');
	INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('W_','eventi.log','1',NULL,'Abilita tracciatura su W_LOGEVENTI. Valori ammessi: 0 = non abilitata, 1 [default] = abilitata',NULL);
	Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('W_','it.eldasoft.generatoreRicerche.tracciaTabelle',null,null,'Elenco delle tabelle, separate da ";", le cui esecuzioni vanno tracciate con un evento',null);

	delete from w_config where chiave in ('account.durata','account.loginKO.maxNumTentativi','account.loginKO.delaySecondi','account.loginKO.durataBloccoMinuti','it.eldasoft.account.durataPassword','account.intervalloMinimoCambioPassword');
	Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('W_','account.durata','180','Gestione account','Durata massima account senza accessi (espressa in GIORNI) per utenti con applicati i controlli di sicurezza',null);
	Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('W_','account.loginKO.maxNumTentativi','5','Gestione account','Numero massimo di tentativi di autenticazione oltre il quale viene bloccato l''accesso provvisoriamente',null);
	Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('W_','account.loginKO.delaySecondi','30','Gestione account','Ritardo (espresso in SECONDI) introdotto in caso di tentativo di autenticazione per un utente bloccato provvisoriamente per superamento del limite di tentativi di autenticazione fallita',null);
	Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('W_','account.loginKO.durataBloccoMinuti','30','Gestione account','Durata del blocco provvisorio (espresso in MINUTI) per un utente avente superato il limite di tentativi di autenticazione fallita',null);
	Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('W_','it.eldasoft.account.durataPassword','90','Password','Durata della password (espressa in GIORNI) per utenti con abilitazione alla sicurezza password',null);
	Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('W_','account.intervalloMinimoCambioPassword','30','Password','Intervallo minimo (espresso in SECONDI) tra un cambio password ed il successivo per lo stesso utente',null);
	
	update eldaver set numver = '2.16.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.16.%') THEN

	ALTER TABLE WSFASCICOLO ADD DESCLASSI VARCHAR(2000);
	ALTER TABLE WSFASCICOLO ADD DESVOCE VARCHAR(2000);
	ALTER TABLE WSFASCICOLO ADD DESAOO VARCHAR(2000);
	ALTER TABLE WSFASCICOLO ADD DESUFF VARCHAR(2000);

        INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DESCLASSI.WSFASCICOLO.GENEWEB', 'WSDESCLAS', 'Descrizione classifica', 'Descriz.classifica', 'A2000', NULL, NULL, NULL);
	INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DESVOCE.WSFASCICOLO.GENEWEB', 'WSDESVOCE', 'Voce classifica', 'Voce classifica', 'A2000', NULL, NULL, NULL);
	INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DESAOO.WSFASCICOLO.GENEWEB', 'WSDESAOO', 'Denominazione AOO (Amministrazione organizzativa)', 'Denominazione AOO', 'A2000', NULL, NULL, NULL);
	INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DESUFF.WSFASCICOLO.GENEWEB', 'WSDESUFF', 'Denominazione ufficio responsabile', 'Denominazione uffic.', 'A2000', NULL, NULL, NULL);


	update eldaver set numver = '2.17.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.17.%') THEN

		CREATE TABLE WSDMCFTAB (
		ID NUMERIC(12) NOT NULL,
		CODAPP VARCHAR(10),
		CODICE VARCHAR(50),
		DESCRI VARCHAR(100),
		SISTEMA VARCHAR(50),
		ISARCHI VARCHAR(1),
		primary key (ID));

		CREATE TABLE WSDMCONFI (
		ID NUMERIC(12) NOT NULL,
		CODAPP VARCHAR(10),
		DESCRI VARCHAR(500),
		primary key (ID));

		CREATE TABLE WSDMCONFIUFF (
		IDCONFI NUMERIC(12) NOT NULL,
		CODEIN VARCHAR(16) NOT NULL,
		primary key (IDCONFI,CODEIN));
		ALTER TABLE WSDMCONFIUFF ADD CONSTRAINT FK_WSDMCONFIUFF_WSDMCONFI FOREIGN KEY (IDCONFI) REFERENCES WSDMCONFI( ID ) ON DELETE CASCADE;	

		CREATE TABLE WSDMCONFIPRO (
		IDCONFI NUMERIC(12) NOT NULL,
		CHIAVE VARCHAR(100) NOT NULL,
		VALORE VARCHAR(500),
		DESCRI VARCHAR(2000),
		primary key (IDCONFI,CHIAVE));
		ALTER TABLE WSDMCONFIPRO ADD CONSTRAINT FK_WSDMCONFIPRO_WSDMCONFI FOREIGN KEY (IDCONFI) REFERENCES WSDMCONFI( ID ) ON DELETE CASCADE;

		CREATE TABLE WSDMTAB (
		ID NUMERIC(12) NOT NULL,
		IDCONFI NUMERIC(12),
		IDCFTAB NUMERIC(12),
		CODICE VARCHAR(50),
		VALORE VARCHAR(200),
		DESCRI VARCHAR(500),
		NUMORD NUMERIC(5),
		ISARCHI VARCHAR(1),
		SISTEMA VARCHAR(50),
		primary key (ID));
		ALTER TABLE WSDMTAB ADD CONSTRAINT FK_WSDMTAB_WSDMCONFI FOREIGN KEY (IDCONFI) REFERENCES WSDMCONFI( ID ) ON DELETE CASCADE;

		ALTER TABLE WSLOGIN ADD ID NUMERIC(12);
		ALTER TABLE WSLOGIN ADD IDCONFIWSDM NUMERIC(12);

		Update ELDAVER set NUMVER = 'M1.2.18.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
	
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	wslogin_id numeric(10);
	wslogin_syscon numeric(10);
	wslogin_servizio varchar(2000);
	v_cnt_wslogin numeric(10);
	wslogin_pk varchar(2000);
	ciclo_wslogin cursor for select syscon,servizio from wslogin order by syscon,servizio;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver = 'M1.2.18.0') THEN

		-- Inizializzazione nuova chiave ID di WSLOGIN
		wslogin_id := 0;
		open ciclo_wslogin;
		loop
			fetch ciclo_wslogin into wslogin_syscon, wslogin_servizio;
			if not found then
				exit;
			end if;
			wslogin_id := wslogin_id + 1;
			UPDATE WSLOGIN set ID=wslogin_id where syscon=wslogin_syscon and servizio=wslogin_servizio;
		end loop;
		close ciclo_wslogin;

		-- Imposta la constraint di tipo 'not null' sul campo ID
		ALTER TABLE wslogin ALTER COLUMN ID SET NOT NULL;
		
		--Inizializza contatore per WSLOGIN
		INSERT INTO W_GENCHIAVI(tabella, chiave) values('WSLOGIN',wslogin_id);

		-- Sostituisce la definizione corrente dei campi chiave con la nuova definizione
		select count(1) into v_cnt_wslogin from wslogin where id is null or id=0;
		if (v_cnt_wslogin <= 0) then
			select constraint_name into wslogin_pk from information_schema.table_constraints where upper(table_name) = 'WSLOGIN' and constraint_type='PRIMARY KEY';
			if (wslogin_pk is not NULL) and (length(wslogin_pk) > 0) then
				EXECUTE ('ALTER TABLE wslogin DROP CONSTRAINT '||wslogin_pk);
				ALTER TABLE wslogin ADD PRIMARY KEY (ID);
			end if;
			EXECUTE ('ALTER TABLE wslogin ADD CONSTRAINT FK_WSLOGIN_WSDMCONFI FOREIGN KEY (IDCONFIWSDM) REFERENCES WSDMCONFI( ID ) ON DELETE CASCADE');
		end if;

		Update ELDAVER set NUMVER = 'M2.2.18.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver = 'M2.2.18.0') THEN

        delete from c0campi where c0c_mne_ber in ('WSDMIDCFTAB','WSDMCODAPPCF','WSDMCODICECF','WSDMDESCRICF','WSDMSISTEMACF','WSDMISARCHICF');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','ID.WSDMCFTAB.GENEWEB','WSDMIDCFTAB','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODAPP.WSDMCFTAB.GENEWEB','WSDMCODAPPCF','Codice applicativo','Codice applicativo','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODICE.WSDMCFTAB.GENEWEB','WSDMCODICECF','Codice tabellato utilizzato dal sistema remoto','Codice tabellato','A50',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DESCRI.WSDMCFTAB.GENEWEB','WSDMDESCRICF','Descrizione tabellato','Descrizione','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SISTEMA.WSDMCFTAB.GENEWEB','WSDMSISTEMACF','Sistema remoto di protocollazione','Sistema remoto','A50',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ISARCHI.WSDMCFTAB.GENEWEB','WSDMISARCHICF','Tabellato Archiviato?','Archiviato?','A2',NULL,'SN',NULL);

        delete from c0campi where c0c_mne_ber in ('WSDMIDCONFI','WSDMCODAPP','WSDMDESCRI');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','ID.WSDMCONFI.GENEWEB','WSDMIDCONFI','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODAPP.WSDMCONFI.GENEWEB','WSDMCODAPP','Codice applicativo','Codice applicativo','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DESCRI.WSDMCONFI.GENEWEB','WSDMDESCRI','Descrizione configurazione','Descrizione','A500',NULL,NULL,NULL);
		
        delete from c0campi where c0c_mne_ber in ('WSDMIDCONFIUFF','WSDMCODEIN');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','IDCONFI.WSDMCONFIUFF.GENEWEB','WSDMIDCONFIUFF','Id configurazione','Id configurazione','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','CODEIN.WSDMCONFIUFF.GENEWEB','WSDMCODEIN','Codice dell''ufficio intestatario','Codice ufficio','A16',NULL,NULL,NULL);

        delete from c0campi where c0c_mne_ber in ('WSDMIDPRO','WSDMIDCONFIPRO','WSDMCHIAVEPRO','WSDMVALOREPRO','WSDMDESCRIPRO');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','IDCONFI.WSDMCONFIPRO.GENEWEB','WSDMIDCONFIPRO','Id configurazione','Id configurazione','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','CHIAVE.WSDMCONFIPRO.GENEWEB','WSDMCHIAVEPRO','Chiave','Chiave','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'VALORE.WSDMCONFIPRO.GENEWEB','WSDMVALOREPRO','Valore','Valore','A500',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DESCRI.WSDMCONFIPRO.GENEWEB','WSDMDESCRIPRO','Descrizione','Descrizione','A2000',NULL,NULL,NULL);

        delete from c0campi where c0c_mne_ber in ('WSDMIDTAB','WSDMIDCONFITAB','WSDMIDCFTABTAB','WSDMCODICETAB','WSDMVALORETAB','WSDMDESCRITAB','WSDMNUMORDTAB','WSDMISARCHITAB','WSDMSISTEMATAB');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','ID.WSDMTAB.GENEWEB','WSDMIDTAB','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDCONFI.WSDMTAB.GENEWEB','WSDMIDCONFITAB','Id configurazione','Id configurazione','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDCFTAB.WSDMTAB.GENEWEB','WSDMIDCFTABTAB','Id tabellato','Id tabellato','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODICE.WSDMTAB.GENEWEB','WSDMCODICETAB','Codice del tabellato','Codice tabellato','A50',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'VALORE.WSDMTAB.GENEWEB','WSDMVALORETAB','Valore identificativo del tabellato','Valore','A200',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DESCRI.WSDMTAB.GENEWEB','WSDMDESCRITAB','Descrizione','Descrizione','A500',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NUMORD.WSDMTAB.GENEWEB','WSDMNUMORDTAB','Numero d''ordine','Numero d''ordine','N5',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ISARCHI.WSDMTAB.GENEWEB','WSDMISARCHITAB','Dato Archiviato?','Archiviato?','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SISTEMA.WSDMTAB.GENEWEB','WSDMSISTEMATAB','Sistema remoto di protocollazione','Sistema remoto','A50',NULL,NULL,NULL);

        delete from c0campi where c0c_mne_ber in ('WSLOGID','WSIDCONFIWSDM');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','ID.WSLOGIN.GENEWEB','WSLOGID','Identificativo univoco','Id. univoco','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDCONFIWSDM.WSLOGIN.GENEWEB','WSIDCONFIWSDM','Id configurazione integrazione WSDM','Id configuraz.WSDM','N12',NULL,NULL,NULL);
		UPDATE C0CAMPI set C0C_CHI=NULL where C0C_MNE_BER in ('WSLOSYSCON','WSLOSERVIZ');

		DELETE FROM C0ENTIT WHERE C0E_NOM IN ('WSDMCFTAB.GENEWEB','WSDMCONFI.GENEWEB','WSDMCONFIUFF.GENEWEB','WSDMCONFIPRO.GENEWEB','WSDMTAB.GENEWEB');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('WSDMCFTAB.GENEWEB',0,'P','WSDMCFTAB','Elenco tabellati utilizzati in integrazione WSDM','ID.WSDMCFTAB.GENEWEB',NULL,NULL,NULL,NULL,NULL);			
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('WSDMCONFI.GENEWEB',0,'P','WSDMCONFI','Configurazioni integrazione WSDM','ID.WSDMCONFI.GENEWEB',NULL,NULL,NULL,NULL,NULL);
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('WSDMCONFIUFF.GENEWEB',0,'P','WSDMCONFIU','Associazione uffici intestatari a configurazioni WSDM','IDCONFI.WSDMCONFIUFF.GENEWEB',NULL,NULL,NULL,NULL,NULL);
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('WSDMCONFIPRO.GENEWEB',0,'P','WSDMCONFIP','Property configurazione WSDM ','IDCONFI.WSDMCONFIPRO.GENEWEB','WSDMCONFI.GENEWEB','ID.WSDMCONFI.GENEWEB',NULL,NULL,NULL);
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('WSDMTAB.GENEWEB',0,'P','WSDMTAB','Dati tabellati per configurazione integrazione WSDM','IDCONFI.WSDMTAB.GENEWEB','WSDMCONFI.GENEWEB','ID.WSDMCONFI.GENEWEB',NULL,NULL,NULL);

		INSERT INTO w_genchiavi (tabella, chiave) VALUES ('WSDMCONFI', 0);
		INSERT INTO w_genchiavi (tabella, chiave) VALUES ('WSDMTAB', 0);
		
		-- Nuovi campi per W_TAGS
		ALTER TABLE W_TAGS ADD TAGVIS VARCHAR(1) NULL;
		ALTER TABLE W_TAGS ADD TAGPROFILI TEXT NULL;

		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TAGVIS.W_TAGS.GENEWEB', 'WTAGSTAGVIS', 'Visibile ?', 'Vis. ?', 'A2', NULL, 'SN', 'Visibile ?');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TAGPROFILI.W_TAGS.GENEWEB', 'WTAGSTAGPRO', 'Profili', 'Profili', 'A2000', NULL, 'CLOB', 'Lista profili');

		
		Update ELDAVER set NUMVER = '2.18.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.18.%') THEN

		insert into w_accgrp (id_account, id_gruppo, priorita) select 47, id_gruppo, priorita from w_accgrp where id_account = 50 and not exists (select id_gruppo from w_accgrp grp2 where id_account = 47 and w_accgrp.id_gruppo = grp2.id_gruppo);
		insert into w_accpro (id_account, cod_profilo) select 47, cod_profilo from w_accpro where id_account = 50 and not exists (select cod_profilo from w_accpro pro2 where id_account = 47 and w_accpro.cod_profilo = pro2.cod_profilo);
		
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('W_','sso.portoken.url','https://portoken.maggiolicloud.it/api/jsonws/mggl.token/generate-token/id-utente/-/tipologia-id/-/cod-sap-cliente/-/cod-sap-area/-/cod-sap-famiglia/-/cliente/-/ticket-id/-/stato/1/scadenza/-/aghoritm/-/domini/%22%22/software/portaleappalti/email/-',NULL,'URL di accesso ai servizi REST di Portoken',NULL);
		
		Update ELDAVER set NUMVER = '2.19.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
	
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.19.%') THEN
		IF NOT EXISTS (SELECT TABLENAME FROM PG_TABLES WHERE UPPER(TABLENAME)='W_APPLICATION_KEYS') THEN
			CREATE TABLE W_APPLICATION_KEYS (
				CLIENTID VARCHAR(255) NOT NULL,
				CHIAVE VARCHAR(255),
				NOTE VARCHAR(2000),
				PRIMARY KEY (CLIENTID)
			);
		END IF;
		
		Update ELDAVER set NUMVER = 'M1.2.20.0', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like 'M1.2.20.%') THEN

		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('W_','sso.spid.validator','0','Autenticazione Single-Sign-On',' Attiva il link di validazione SPID per AGID. Valori ammessi: 0=Non attivo [default], 1=Attivo',NULL);
		
		DELETE FROM W_CONFIG WHERE CHIAVE = 'registrazione.sso.defaultPassword';
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('W_','registrazione.sso.defaultPassword','!!1xgnBwPfZl@O','Form registrazione','Password di default (per accesso interno via USRSYS) per utenti di SSO','1');

		Update ELDAVER set NUMVER = '2.20.0', datvet = now() where codapp = 'W_';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
	
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.20.%') THEN
	
		ALTER TABLE W_INVCOM ADD IDPRGRIS VARCHAR(2);
		ALTER TABLE W_INVCOM ADD IDCOMRIS NUMERIC(12);
		ALTER TABLE W_INVCOM ADD COMDATSCA TIMESTAMP;
		ALTER TABLE W_INVCOM ADD COMORASCA VARCHAR(6);
		
        DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('COMIDPRGRIS','COMIDCOMRIS','COMDATSCA','COMORASCA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDPRGRIS.W_INVCOM.GENEWEB','COMIDPRGRIS','Identif.comunicazione di provenienza - cod.applicativo','Id com.risp.- appl.','A2',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDCOMRIS.W_INVCOM.GENEWEB','COMIDCOMRIS','Identif.comunicazione di provenienza - progressivo','Id com.risp.- progr.','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COMDATSCA.W_INVCOM.GENEWEB','COMDATSCA','Data termine presentazione documentazione','Data term.pres.doc.','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COMORASCA.W_INVCOM.GENEWEB','COMORASCA','Ora termine presentazione documentazione','Ora term.pres.doc.','A6',NULL,'ORA',NULL);
		
		Update C0CAMPI set C0C_TIP='E', COC_DES='Ulteriore tipo di comunicazione (1 soccorso istruttorio)', COC_DES_FRM='Ult.tipo comunicaz.', C0C_FS='A100', C0C_TAB1='W_008' where C0C_MNE_BER='COMMODELLO';

		Update ELDAVER set NUMVER = '2.21.0', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

	
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'W_' and numver like '2.21.%') THEN
	
		ALTER TABLE W_CONFCOM ADD COMMODELLO NUMERIC(12);
		
		--Correzione dicitura tabellato
		UPDATE tab1 SET tab1desc='Riservata (invio mail o PEC e consultazione in area riservata)' where tab1cod='G_023' and tab1tip=2;
		
		INSERT INTO tab2 (tab2cod, tab2tip, tab2d1, tab2d2, tab2mod, tab2nord) VALUES ('G_z20', '16', 'StatoC', 'Processata parzialmente', NULL, NULL);
		INSERT INTO tab2 (tab2cod, tab2tip, tab2d1, tab2d2, tab2mod, tab2nord) VALUES ('G_z20', '17', 'StatoC', 'Processata parzialmente con messaggi', NULL, NULL);
		INSERT INTO tab2 (tab2cod, tab2tip, tab2d1, tab2d2, tab2mod, tab2nord) VALUES ('G_z20', '18', 'StatoC', 'In attesa di verifica', NULL, NULL);

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('W_COMMODEL','COMDATSCA','COMORASCA','COMTIPMA_');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'P',NULL,'COMMODELLO.W_CONFCOM.GENEWEB','W_COMMODEL','Ulteriore tipo di comunicazione (1 soccorso istruttorio)','Ult.tipo comunicaz.','N10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COMDATSCA.W_INVCOM.GENEWEB','COMDATSCA','Data termine presentazione documentazione','Data term.pres.doc.','A10',NULL,'DATA_ELDA','Data termine presentazione documentazione');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COMORASCA.W_INVCOM.GENEWEB','COMORASCA','Ora termine presentazione documentazione','Ora term.pres.doc.','A6',NULL,'ORA','Ora termine presentazione documentazione');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COMTIPMA.W_INVCOM.GENEWEB', 'COMTIPMA_', 'Tipologia di busta a cui Ã¨ riferita la comunicaz.(soc.ist.)', 'Riferimento busta', 'A100', 'A1013', NULL, NULL);

		Update C0CAMPI set COC_DES_WEB='Tipologia' where C0C_MNE_BER='COMMODELLO';
		
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'ALT.GENE.UFFINT.Storico', 'Gestione storico anagrafe uffici', 13550);
		INSERT INTO w_oggetti (tipo, oggetto, descr, ord) VALUES ('FUNZ', 'DEL.GENE.ListaStoUffint.DEL', 'Elimina storico uffici intestatari', 13560);
		
		INSERT INTO w_azioni (tipo, azione, oggetto, descr, valore, inor, viselenco, crc) VALUES ('FUNZ', 'VIS', 'ALT.GENE.UFFINT.Storico', 'Visualizza', 0, 1, 1, 1429551849);

		CREATE TABLE W_DISCUSS_P
			(DISCID_P NUMERIC(12) not null,
			DISCPRG VARCHAR(2),
			DISCENT VARCHAR(20),
			DISCKEY1 VARCHAR(20),
			DISCKEY2 VARCHAR(20),
			DISCKEY3 VARCHAR(20),
			DISCKEY4 VARCHAR(20),
			DISCKEY5 VARCHAR(20),
			DISCMESSOPE NUMERIC(12),
			DISCMESSINS TIMESTAMP,
			DISCOGGETTO VARCHAR(2000),
			PRIMARY KEY (DISCID_P));
			
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('W_DISCUSS_P.GENEWEB', 0, 'E', 'DISCUSS_P', 'Discussioni', 'DISCID.W_DISCUSS_P.GENEWEB', NULL, NULL, NULL, NULL, NULL);

		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'DISCID_P.W_DISCUSS_P.GENEWEB', 'W_DPDISCID_P', 'Id padre', 'Id padre', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCPRG.W_DISCUSS_P.GENEWEB', 'W_DPDISCPRG', 'Prg', 'Prg', 'A2', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCENT.W_DISCUSS_P.GENEWEB', 'W_DPDISCENT', 'Ent', 'Ent', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCKEY1.W_DISCUSS_P.GENEWEB', 'W_DPDISCKEY1', 'Key1', 'Key1', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCKEY2.W_DISCUSS_P.GENEWEB', 'W_DPDISCKEY2', 'Key2', 'Key2', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCKEY3.W_DISCUSS_P.GENEWEB', 'W_DPDISCKEY3', 'Key3', 'Key3', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCKEY4.W_DISCUSS_P.GENEWEB', 'W_DPDISCKEY4', 'Key4', 'Key4', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCKEY5.W_DISCUSS_P.GENEWEB', 'W_DPDISCKEY5', 'Key5', 'Key5', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCMESSOPE.W_DISCUSS_P.GENEWEB', 'W_DPDISCMESSOPE', 'Operatore', 'Operatore', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCMESSINS.W_DISCUSS_P.GENEWEB', 'W_DPDISCMESSINS', 'Data ins.', 'Data ins.', 'A19', NULL, 'TIMESTAMP', 'Data inserimento');	
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCOGGETTO.W_DISCUSS_P.GENEWEB', 'W_DPDISCOGGETTO', 'Oggetto', 'Oggetto', 'A2000', NULL, 'NOTE', NULL);	

		CREATE TABLE W_DISCUSS
			(DISCID_P NUMERIC(12) not null,
			DISCID NUMERIC(12) not null,
			DISCMESSOPE NUMERIC(12),
			DISCMESSINS TIMESTAMP,
			DISCMESSPUBBL VARCHAR(1),
			DISCMESSTESTO TEXT,
			PRIMARY KEY (DISCID_P, DISCID));

		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('W_DISCUSS.GENEWEB', 0, 'E', 'DISCUSS', 'Messaggi', 'DISCID.W_DISCUSS.GENEWEB', NULL, NULL, NULL, NULL, NULL);
		
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'DISCID_P.W_DISCUSS.GENEWEB', 'W_DDDISCID_P', 'Id padre', 'Id padre', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'DISCID.W_DISCUSS.GENEWEB', 'W_DDISCID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCMESSOPE.W_DISCUSS.GENEWEB', 'W_DDISCMESSOPE', 'Operatore', 'Operatore', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCMESSINS.W_DISCUSS.GENEWEB', 'W_DDISCMESSINS', 'Data ins.', 'Data ins.', 'A19', NULL, 'TIMESTAMP', 'Data inserimento');	
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCMESSPUBBL.W_DISCUSS.GENEWEB', 'W_DDISCMESSPUBBL', 'Pubbl.?', 'Pubbl.?', 'A2', NULL, 'SN', 'Pubblicato?');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCMESSTESTO.W_DISCUSS.GENEWEB', 'W_DDISCMESSTESTO', 'Testo', 'Testo', 'A2000', NULL, 'CLOB', NULL);		

		CREATE TABLE W_DISCREAD
			(DISCID_P NUMERIC(12) not null,
			DISCID NUMERIC(12) not null,
			DISCMESSOPE NUMERIC(12),
			PRIMARY KEY (DISCID_P, DISCID, DISCMESSOPE));
			
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('W_DISCREAD.GENEWEB', 0, 'E', 'DISCREAD', 'Messaggi letti', 'DISCID.W_DISCREAD.GENEWEB', 'W_DISCUSS.GENEWEB', 'DISCID.W_DISCUSS.GENEWEB', NULL, NULL, NULL);
		
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'DISCID_P.W_DISCREAD.GENEWEB', 'W_DRDISCID_P', 'Id padre', 'Id padre', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'DISCID.W_DISCREAD.GENEWEB', 'W_DRISCID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DISCMESSOPE.W_DISCREAD.GENEWEB', 'W_DRISCMESSOPE', 'Operatore', 'Operatore', 'N12', NULL, NULL, NULL);

			
		CREATE TABLE W_DISCDEST
			(DISCID_P NUMERIC(12) not null,
			DISCID NUMERIC(12) not null,
			DESTNUM NUMERIC(12) not null,
			DESTID NUMERIC(12),
			DESTNAME VARCHAR(500),
			DESTMAIL VARCHAR(200),
			DESTINVSTATO NUMERIC(7),
			DESTINVMESS VARCHAR(500),
			PRIMARY KEY (DISCID_P, DISCID, DESTNUM));
			
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('W_DISCDEST.GENEWEB', 0, 'E', 'DISCDEST', 'Destinatari', 'DISCID.W_DISCDEST.GENEWEB', 'W_DISCUSS.GENEWEB', 'DISCID.W_DISCUSS.GENEWEB', NULL, NULL, NULL);

		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'DISCID_P.W_DISCDEST.GENEWEB', 'W_DEDISCID_P', 'Id padre', 'Id padre', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'DISCID.W_DISCDEST.GENEWEB', 'W_DEDISCID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'DESTNUM.W_DISCDEST.GENEWEB', 'W_DEDESTNUM', 'Num', 'Num', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DESTID.W_DISCDEST.GENEWEB', 'W_DEDESTID', 'Id dest.', 'Id. dest.', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DESTNAME.W_DISCDEST.GENEWEB', 'W_DEDESTNAME', 'Nome dest.', 'Nome dest.', 'A500', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DESTMAIL.W_DISCDEST.GENEWEB', 'W_DEDESTMAIL', 'Mail dest.', 'Mail dest.', 'A200', NULL, NULL, NULL);			
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DESTINVSTATO.W_DISCDEST.GENEWEB', 'W_DEDESTINVSTATO', 'Stato invio', 'Stato invio', 'N7', NULL, NULL, NULL);	
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'DESTINVMESS.W_DISCDEST.GENEWEB', 'W_DEDESTINVMESS', 'Messaggio invio', 'Messaggio invio', 'A500', NULL, NULL, NULL);	
		
			
		CREATE TABLE W_DISCALL
			(DISCID_P NUMERIC(12) not null,
			DISCID NUMERIC(12) not null,
			ALLNUM NUMERIC(3) not null,
			ALLNAME VARCHAR(300),
			ALLSTREAM BYTEA,
			ALLNOTE VARCHAR(2000),
			PRIMARY KEY (DISCID_P, DISCID, ALLNUM));
			
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('W_DISCALL.GENEWEB', 0, 'E', 'DISCALL', 'Allegati', 'DISCID.W_DISCALL.GENEWEB', 'W_DISCUSS.GENEWEB', 'DISCID.W_DISCUSS.GENEWEB', NULL, NULL, NULL);

		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'DISCID_P.W_DISCALL.GENEWEB', 'W_DADISCID_P', 'Id padre', 'Id padre', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'DISCID.W_DISCALL.GENEWEB', 'W_DADISCID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'ALLNUM.W_DISCALL.GENEWEB', 'W_DAALLNUM', 'Num', 'Num', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ALLNAME.W_DISCALL.GENEWEB', 'W_DAALLNAME', 'Nome allegato', 'Nome allegato', 'A300', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ALLSTREAM.W_DISCALL.GENEWEB', 'W_DAALLSTREAM', 'Stream', 'Stream', 'A2000', NULL, 'BLOB', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ALLNOTE.W_DISCALL.GENEWEB', 'W_DAALLNOTE', 'Note', 'Note', 'A2000', NULL, 'NOTE', NULL);
		


		
		Update ELDAVER set NUMVER = '2.22.0', datvet = now() where codapp = 'W_';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

	
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.15.0' or numver like '6.15.0.%')) THEN

        ALTER TABLE TORN ADD COLUMN MODCONT NUMERIC(7);
		ALTER TABLE TORN ADD COLUMN URBASCO VARCHAR(1);
		ALTER TABLE TORN ADD COLUMN SOMMAUR VARCHAR(1);
        ALTER TABLE GARECONT ADD COLUMN NGARAL VARCHAR(20);
		ALTER TABLE GARE ADD COLUMN LOCINT VARCHAR(9);

        --Conversione da numerico a stringa del campo 'Codice SCP'
		perform sp_backupanddropviews('TORN');
		ALTER TABLE TORN ALTER COLUMN CODSCP TYPE VARCHAR(10);
		ALTER TABLE TORN ALTER COLUMN CODAVSCP TYPE VARCHAR(10);
		perform sp_restoreviews('TORN');

		--Estensione campo ORADOM.DITG
		perform sp_backupanddropviews('DITG');
		ALTER TABLE DITG ALTER COLUMN ORADOM TYPE VARCHAR(8);
		perform sp_restoreviews('DITG');

		--Inizializzazione campo MODCONT.TORN
		update torn set modcont=2 where modcont is null and exists(select ngara from gare where codgar1=codgar and genere=3);
		
		--Aggiornamento tabellati
		insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1115', 4, '1  Stipula contratto per lotto(1) per aggiudicatario(2)', 0);
		insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1130', 1, 'Per lotto', NULL);
		insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1130', 2, 'Per aggiudicatario (con aggregazione dei lotti)', NULL);
		insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1131', 1, 'O    Ordinario(O)  Speciale(S)', NULL);
		insert into TAB4(TAB4COD, TAB4TIP, TAB4DESC) VALUES('G1_1',  'A1131', 'Tipo di settore');

		--Correzione descrizione
		update tab2 set tab2d1='Contratto d''appalto' where tab2cod='A1z06' and tab2tip=1;
		update tab2 set tab2d1='Contratto d''appalto discendente da accordo quadro/convenzione senza successivo confronto compet.' where tab2cod='A1z06' and tab2tip=2;

		--Aggiornamento C0campi e C0entit
		delete from c0campi where c0c_mne_ber in ('G1MODCONT','G1NGARAL','G1LOCINT','G1URBASCO','G1SOMMAUR');
		insert into C0CAMPI(COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER,COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM,COC_DES_WEB) Values(0, 'E', NULL, 'MODCONT.TORN.GARE',    'G1MODCONT', 'Modalità stipula contratto per gare a lotti plico unico',     'Mod.stipula contr.',   'A100', 'A1130', NULL, 'Modalità stipula contratto');
		insert into C0CAMPI(COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER,COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM,COC_DES_WEB) Values(0, 'E', NULL, 'NGARAL.GARECONT.GARE', 'G1NGARAL',  'Codice lotto di gara (nel caso di plico unico)',              'Codice lotto',         'A20',  NULL,    NULL,  NULL);
		insert into C0CAMPI(COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER,COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM,COC_DES_WEB) Values(0, 'E', NULL, 'LOCINT.GARE.GARE',     'G1LOCINT',  'Codice ISTAT del comune sede del lavoro o della forn./serv.', 'Cod.ISTAT comune',     'A9',   NULL,    NULL, 'Codice ISTAT del comune');
		insert into C0CAMPI(COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER,COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM,COC_DES_WEB) Values(0, 'E', NULL, 'URBASCO.TORN.GARE',    'G1URBASCO', 'Opere di urbanizzazione a scomputo?',                         'Op.urbaniz.scomputo?', 'A2',   NULL,    'SN', 'Opere di urbanizzazione a scomputo?');
		insert into C0CAMPI(COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER,COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM,COC_DES_WEB) Values(0, 'E', NULL, 'SOMMAUR.TORN.GARE',    'G1SOMMAUR', 'Procedura per lavori in caso di somma urgenza?',              'Somma urgenza?',       'A2',   NULL,    'SN', 'Somma urgenza?');
		update C0CAMPI SET C0C_FS = 'A10' WHERE COC_MNE_UNI = 'CODSCP.TORN.GARE';
		update C0CAMPI SET C0C_FS = 'A10' WHERE COC_MNE_UNI = 'CODAVSCP.TORN.GARE';
		update C0CAMPI SET C0C_FS = 'A8' WHERE COC_MNE_UNI = 'ORADOM.DITG.GARE';
		--Eliminazioni voci mai utilizzate dall'applicativo web - entità rimosse anche dal codice
		delete from c0campi where coc_mne_uni like '%.DODO.GARE';
		delete from c0campi where coc_mne_uni like '%.DOOF.GARE';
		delete from c0campi where coc_mne_uni like '%.IMDODO.GARE';
		delete from c0campi where coc_mne_uni like '%.OPSU.GARE';
		delete from c0campi where coc_mne_uni like '%.OPSD.GARE';
		delete from c0campi where coc_mne_uni like '%.SOSGAR.GARE';
		delete from c0campi where coc_mne_uni like '%.ELEARC.GARE';
		delete from c0campi where coc_mne_uni like '%.ELEDIT.GARE';
		delete from c0campi where coc_mne_uni like '%.ELECAT.GARE';
		delete from c0campi where coc_mne_uni like '%.TIPGAR.GARE';
		delete from c0campi where coc_mne_uni like '%.ALDOG.GARE';
		delete from c0campi where coc_mne_uni like '%.ALOFG.GARE';
		delete from c0entit where c0e_nom = 'DODO.GARE';
		delete from c0entit where c0e_nom = 'DOOF.GARE';
		delete from c0entit where c0e_nom = 'IMDODO.GARE';
		delete from c0entit where c0e_nom = 'OPSU.GARE';
		delete from c0entit where c0e_nom = 'OPSD.GARE';
		delete from c0entit where c0e_nom like 'ELEARC.GARE%';
		delete from c0entit where c0e_nom = 'ELEDIT.GARE';
		delete from c0entit where c0e_nom = 'ELECAT.GARE';
		delete from c0entit where c0e_nom = 'SOSGAR.GARE';
		delete from c0entit where c0e_nom = 'TIPGAR.GARE';
		delete from c0entit where c0e_nom = 'ALDOG.GARE';
		delete from c0entit where c0e_nom = 'ALOFG.GARE';

		--Aggiornamento profili
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('PAGE', 'GARE.TORN-OFFUNICA-scheda.STIPULA', 'Pagina "Stipula accordo quadro"', 4232);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('PAGE', 'GARE.GARE-scheda-contratto.STIPULA', 'Pagina Dati generali Accordo quadro', 4537);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('SEZ', 'GARE.GARE-scheda-contratto.STIPULA.AGGEFF', 'Sezione Fase integrativa efficacia', 12390);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('SEZ', 'GARE.GARE-scheda-contratto.STIPULA.CAUZIONE', 'Sezione Polizza cauzione definitiva', 12400);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('SEZ', 'GARE.GARE-scheda-contratto.STIPULA.COMMDITTECONTRATTO', 'Sezione Comunicazione alle ditte della data stipula del contratto', 12410);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('SEZ', 'GARE.GARE-scheda-contratto.STIPULA.ATTOCONTR', 'Sezione Stipula accordo quadro', 12420);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('FUNZ', 'MOD.GARE.GARE-scheda-contratto.STIPULA.SCHEDAMOD', 'Funzione modifica', 12430);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('PAGE', 'GARE.TORN-OFFUNICA-scheda.AGGEFF', 'Pagina "Aggiudicazione efficace"', 4234);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('PAGE', 'GARE.GARE-scheda-contratto.AGGEFF', 'Pagina Dati generali Aggiudicazione efficace', 4539);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('SEZ', 'GARE.GARE-scheda-contratto.AGGEFF.AGGEFF', 'Sezione Fase integrativa efficacia', 12460);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('SEZ', 'GARE.GARE-scheda-contratto.AGGEFF.CAUZIONE', 'Sezione Polizza cauzione definitiva', 12470);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('FUNZ', 'MOD.GARE.GARE-scheda-contratto.AGGEFF.SCHEDAMOD', 'Funzione modifica', 12480);
        update w_oggetti set descr='Pagina Dati generali Contratto' where tipo='PAGE' and oggetto='GARE.GARE-scheda-contratto.ATTOCONTR';
		update w_oggetti set descr='Gara divisa in lotti con plico unico - Dettaglio Contratto' where tipo='MASC' and oggetto='GARE.GARE-scheda-contratto';
        update w_oggetti set descr='Pagina Lotti aggiudicati' where tipo='PAGE' and oggetto='GARE.GARE-scheda-contratto.LOTTIAGGIUD';
   		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('FUNZ', 'ALT.GARE.FASIRICEZIONE.AcquisisciDomandePartecipazioneDaPortale', 'Procedure telematiche: acquisisci domande partecipazione da portale', 11087);
  		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('FUNZ', 'ALT.GARE.FASIRICEZIONE.AttivaAperturaDomandePart', 'Procedure telematiche: attiva apertura domande partecipazione', 11088);
  		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('FUNZ', 'ALT.GARE.FASIRICEZIONE.AcquisisciBustaPreq', 'Procedure telematiche: acquisisci busta prequalifica', 11089);

		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('COLS', 'VIS', 'GARE.TORN.BANWEB', 'Visualizza', 0, 1, 1, 1415770968);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('COLS', 'VIS', 'GARE.GARE.SUBGAR', 'Visualizza', 0, 1, 1, 3050541384);

		--Aggiornamento W_CONFIG
		UPDATE W_CONFIG SET descrizione='Abilita tracciatura su W_LOGEVENTI. Valori ammessi: 0 = non abilitata, 1 [default] = abilitata' where codapp='PG' and chiave='eventi.log';
		UPDATE W_CONFIG SET descrizione='Codice applicativo 1 (es.: PL) per filtrare i profili se il DB è lo stesso (OPZIONALE)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.codiceApplicativo.1';
		UPDATE W_CONFIG SET descrizione='Codice applicativo 2 (es.: PL) per filtrare i profili se il DB è lo stesso (OPZIONALE)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.codiceApplicativo.2';
		UPDATE W_CONFIG SET descrizione='Codice applicativo 3 (es.: PL) per filtrare i profili se il DB è lo stesso (OPZIONALE)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.codiceApplicativo.3';
		UPDATE W_CONFIG SET descrizione='Codice applicativo 4 (es.: PL) per filtrare i profili se il DB è lo stesso (OPZIONALE)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.codiceApplicativo.4';
		UPDATE W_CONFIG SET descrizione='Codice applicativo 5 (es.: PL) per filtrare i profili se il DB è lo stesso (OPZIONALE)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.codiceApplicativo.5';
		UPDATE W_CONFIG SET descrizione='Etichetta da presentare a video (es.:  Monitoraggio OO.PP.) per identificare l''applicativo 1 (OBBLIGATORIO)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.descrizioneApplicativo.1';
		UPDATE W_CONFIG SET descrizione='Etichetta da presentare a video (es.:  Monitoraggio OO.PP.) per identificare l''applicativo 2 (OBBLIGATORIO)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.descrizioneApplicativo.2';
		UPDATE W_CONFIG SET descrizione='Etichetta da presentare a video (es.:  Monitoraggio OO.PP.) per identificare l''applicativo 3 (OBBLIGATORIO)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.descrizioneApplicativo.3';
		UPDATE W_CONFIG SET descrizione='Etichetta da presentare a video (es.:  Monitoraggio OO.PP.) per identificare l''applicativo 4 (OBBLIGATORIO)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.descrizioneApplicativo.4';
		UPDATE W_CONFIG SET descrizione='Etichetta da presentare a video (es.:  Monitoraggio OO.PP.) per identificare l''applicativo 5 (OBBLIGATORIO)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.descrizioneApplicativo.5';
		UPDATE W_CONFIG SET descrizione='Indirizzo URL (es.: https://app.eldasoft.it/LFS/) a cui è disponibile l''applicativo 1 (OBBLIGATORIO)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.indirizzoApplicativo.1';
		UPDATE W_CONFIG SET descrizione='Indirizzo URL (es.: https://app.eldasoft.it/LFS/) a cui è disponibile l''applicativo 2 (OBBLIGATORIO)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.indirizzoApplicativo.2';
		UPDATE W_CONFIG SET descrizione='Indirizzo URL (es.: https://app.eldasoft.it/LFS/) a cui è disponibile l''applicativo 3 (OBBLIGATORIO)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.indirizzoApplicativo.3';
		UPDATE W_CONFIG SET descrizione='Indirizzo URL (es.: https://app.eldasoft.it/LFS/) a cui è disponibile l''applicativo 4 (OBBLIGATORIO)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.indirizzoApplicativo.4';
		UPDATE W_CONFIG SET descrizione='Indirizzo URL (es.: https://app.eldasoft.it/LFS/) a cui è disponibile l''applicativo 5 (OBBLIGATORIO)' where codapp='PG' and chiave='it.eldasoft.accessoAltroApplicativo.indirizzoApplicativo.5';
		UPDATE W_CONFIG SET descrizione='Property per disabilitare i gruppi nelle maschere in cui i gruppi stessi rappresentano dati in associativa (amministrazione ricerche e modelli). Valori ammessi: 1 [default] = gruppi disabilitati, 0 = gruppi abilitati (solo Report Console)' where codapp='PG' and chiave='it.eldasoft.associazioneGruppiDisabilitata';
		UPDATE W_CONFIG SET descrizione='Property per indicare quali sono gli archivi che vanno filtrati per ufficio intestatario (es.: IMPR;TECNI;TEIM)' where codapp='PG' and chiave='it.eldasoft.associazioneUffintAbilitata.archiviFiltrati';
		UPDATE W_CONFIG SET descrizione='Controlla al salvataggio di un account la presenza o meno dell''associazione con l''ufficio di appartenenza. Valori ammessi: 1 = associazione obbligatoria, 0 o vuoto [default] = associazione non obbligatoria' where codapp='PG' and chiave='it.eldasoft.dettaglioAccount.ufficioAppartenenza.obbligatorio';
		UPDATE W_CONFIG SET descrizione='Consente di indicare quali entità devono essere bloccate in eliminazione se è stato attivato fra le opzioni utente il blocco eliminazione su entita principale (es.: GARE;TORN;GAREALBO;GAREAVVISI)' where codapp='PG' and chiave='it.eldasoft.bloccoEliminazioneEntita.elencoEntita';
		UPDATE W_CONFIG SET descrizione='PATH assoluto di memorizzazione dei documenti associati nell''''area shared. ATTENZIONE: LA \\ INIZIALE VA RADDOPPIATA NELLA STRINGA IN QUANTO "\" E'''' UN CARATTERE SPECIALE, inoltre indicare / a fine percorso (es.: /opt/elda/PG/DocumentiAssociati/)' where codapp='PG' and chiave='it.eldasoft.documentiAssociati';
		UPDATE W_CONFIG SET descrizione='Indirizzo URL del primo feed RSS (es.: http://www.appaltiecontratti.it/rss/)' where codapp='PG' and chiave='it.eldasoft.feedrss.url.1';
		UPDATE W_CONFIG SET descrizione='Indirizzo URL del secondo feed RSS (es.: http://www.anticorruzione.it/portal/rest/jcr/repository/collaboration/Feeds/rss/comunicatiStampa)' where codapp='PG' and chiave='it.eldasoft.feedrss.url.2';
		UPDATE W_CONFIG SET descrizione='Indirizzo URL del terzo feed RSS (es.: http://www.anticorruzione.it/portal/rest/jcr/repository/collaboration/Feeds/rss/news)' where codapp='PG' and chiave='it.eldasoft.feedrss.url.3';
		UPDATE W_CONFIG SET descrizione='Indirizzo URL del quarto feed RSS (es.: http://www.anticorruzione.it/portal/rest/jcr/repository/collaboration/Feeds/rss/primoPiano)' where codapp='PG' and chiave='it.eldasoft.feedrss.url.4';
		UPDATE W_CONFIG SET descrizione='Indirizzo URL del quinto feed RSS (es.: http://www.mit.gov.it/rss.xml)' where codapp='PG' and chiave='it.eldasoft.feedrss.url.5';
		UPDATE W_CONFIG SET descrizione='PATH assoluto di memorizzazione dei modelli nell''''area shared. ATTENZIONE: LA \\ INIZIALE VA RADDOPPIATA NELLA STRINGA IN QUANTO "\" E'''' UN CARATTERE SPECIALE, inoltre indicare / a fine percorso (es.: /opt/elda/PG/Modelli/)' where codapp='PG' and chiave='it.eldasoft.generatoreModelli.pathModelli';
		UPDATE W_CONFIG SET descrizione='PATH relativo all''interno della cartella individuata dalla property "it.eldasoft.generatoreModelli.pathModelli" che gestisce la memorizzazione temporanea dei modelli composti dall''applicazione (indicare un percorso terminato da /)' where codapp='PG' and chiave='it.eldasoft.generatoreModelli.pathModelliComposti.relativa';
		UPDATE W_CONFIG SET descrizione='PATH relativo all''interno della cartella individuata dalla property "it.eldasoft.generatoreModelli.pathModelli" che gestisce la memorizzazione temporanea dei modelli esistenti prima durante un loro aggiornamento (indicare un percorso terminato da /)' where codapp='PG' and chiave='it.eldasoft.generatoreModelli.pathTemporanea.relativa';
		UPDATE W_CONFIG SET descrizione='URL del Web Service "compositore modelli" (esempio http://localhost:8080/AliceWSCompositore/services/ServizioCompositore)' where codapp='PG' and chiave='it.eldasoft.generatoreModelli.ws.url';
		UPDATE W_CONFIG SET descrizione='Codice dello schema che contiene le viste da utilizzare nelle ricerche base dell''applicazione (default VBASE)' where codapp='PG' and chiave='it.eldasoft.generatoreRicerche.base.schemaViste';
		UPDATE W_CONFIG SET descrizione='JSP pagina di registrazione' where codapp='PG' and chiave='it.eldasoft.registrazione.pagina';
		UPDATE W_CONFIG SET descrizione='Numero massimo di record estraibili con una ricerca (default 10000)' where codapp='PG' and chiave='it.eldasoft.generatoreRicerche.maxNumRecord';
		UPDATE W_CONFIG SET descrizione='Identificativo univoco da comunicare al Web Service ''compositore modelli'' per individuare tra le tante applicazioni web chi è il richiedente di un servizio, in modo da poter individuare la connessione al db e l''area su filesystem. Modificare il valore in caso di più installazioni dello stesso applicativo ma su database differenti e che interagiscono con il WSCompositore' where codapp='PG' and chiave='it.eldasoft.idApplicazioneMaster';
		UPDATE W_CONFIG SET descrizione='URL del Web Service "Portale Appalti" (es.: http://localhost:8080/PortaleAppalti/services/PortaleAliceSOAP)' where codapp='PG' and chiave='it.eldasoft.portaleAlice.ws.url';
		UPDATE W_CONFIG SET descrizione='Cartella contenente l''output generato dall''esecuzione dei report schedulati ATTENZIONE: LA \\ INIZIALE VA RADDOPPIATA NELLA STRINGA IN QUANTO "\" E'' UN CARATTERE SPECIALE ATTENZIONE: INSERIRE IL CARATTERE "/" ALLA FINE (es.: /opt/elda/PG/Schedulazioni/)' where codapp='PG' and chiave='it.eldasoft.webConsole.risSchedulazioni.path';
		UPDATE W_CONFIG SET descrizione='Password di default (per accesso interno via USRSYS) per utenti di SSO' where codapp='PG' and chiave='registrazione.sso.defaultPassword';
		UPDATE W_CONFIG SET descrizione='Richiesta del Ruolo all''utente in fase di registrazione. Il ruolo può assumere i valori Utente oppure Responsabile. Valori ammessi per il parametro: 0=non richiesto [default], 1=SYSAB3 (richiesto per Lavori), 2=SYSABG  (richiesto per Appalti), 3=SYSABC  (richiesto per Contratti)' where codapp='PG' and chiave='registrazione.ruolo';
		UPDATE W_CONFIG SET descrizione='Tipologia protocollo SSO. Valori ammessi: 0 [default]=non prevista, 1=Shibboleth, 2=Cohesion' where codapp='PG' and chiave='sso.protocollo';
		UPDATE W_CONFIG SET descrizione='Abilita il sistema di messaggistica interno. Valori ammessi: 0 [default] = non abilitato, 1 = abilitato' where codapp='PG' and chiave='messaggi.interni.abilitati';
		UPDATE W_CONFIG SET descrizione='URL  di accesso ad Archiflow' where codapp='PG' and chiave='autovie.url';
		UPDATE W_CONFIG SET descrizione='URL del web service per l''invio dati per composizione formulari GUUE (es.: http://localhost:8080/FormulariEU/services/EldasoftSimapWS)' where codapp='PG' and chiave='it.eldasoft.bandoavvisosimap.ws.url';
		UPDATE W_CONFIG SET descrizione='Attivazione del processo batch di controllo delle iscrizioni ad elenco scadute. Impostare a 1 per attivare il processo.' where codapp='PG' and chiave='it.eldasoft.sil.pg.controlloScadenzaIscrizioniElencoCatalogo';
		UPDATE W_CONFIG SET descrizione='Numero ditte per pagina nelle liste delle ditte in gara' where codapp='PG' and chiave='it.eldasoft.sil.pg.fasi.paginazione';
		UPDATE W_CONFIG SET descrizione='Modalità di integrazione con LFS (1 = DEC, 0 =Monitoraggio OO.PP.)' where codapp='PG' and chiave='it.eldasoft.sil.pg.integrazione.dec';
		UPDATE W_CONFIG SET descrizione='Numero operatori per pagina nelle liste degli operatori economici iscritti in elenco' where codapp='PG' and chiave='it.eldasoft.sil.pg.ritiro.paginazione';
		UPDATE W_CONFIG SET descrizione='URL pubblica del Portale Appalti per la pubblicazione dei file xml. ATTENZIONE: LA \\ INIZIALE VA RADDOPPIATA NELLA STRINGA IN QUANTO "\" E'' UN CARATTERE SPECIALE' where codapp='PG' and chiave='it.eldasoft.sil.pg.avcp.urlPortaleAlice';
		UPDATE W_CONFIG SET descrizione='URL del web service per la richiesta del codice CIG (es.: http://localhost:8080/VigilanzaCIG/services/EldasoftSimogWS)' where codapp='PG' and chiave='it.eldasoft.inviodaticig.ws.url';
		UPDATE W_CONFIG SET descrizione='Indirizzo URL per l''integrazione con il servizio WS Vigilanza - componenente PG (es.: http://localhost:8080/WS2Vigilanza/services/SitatWS )' where codapp='PG' and chiave='it.eldasoft.sil.pg.vigilanza.ws.url';
		UPDATE W_CONFIG SET descrizione='PATH dei documenti associati di LFS (Monitoraggio OO.PP. o DEC) (es.: /opt/elda/PL/DocumentiAssociati/ )' where codapp='PG' and chiave='it.eldasoft.sil.pg.pathDocumentiAssociatiPL';
		UPDATE W_CONFIG SET descrizione='Nome applicativo per l''integrazione con il servizio WS Vigilanza - componenente PG (es.: Vigilanza, SitatSA Locale, Siab...)' where codapp='PG' and chiave='it.eldasoft.sil.pg.vigilanza.nomeApplicativo';
		UPDATE W_CONFIG SET descrizione='Cartella (lato client) contenente le stampe ATTENZIONE: LA \\ INIZIALE VA RADDOPPIATA NELLA STRINGA IN QUANTO "\" E'' UN CARATTERE SPECIALE' where codapp='PG' and chiave='it.eldasoft.stampe.client';
		UPDATE W_CONFIG SET descrizione='Path relativa per raggiungere la sottodirectory contenente il prototipo dell''etichetta da stampare' where codapp='PG' and chiave='it.eldasoft.stampe.prototipoEtichetta.pathRelativo';
		UPDATE W_CONFIG SET descrizione='Cartella (lato server) contenente le stampe ATTENZIONE: LA \\ INIZIALE VA RADDOPPIATA NELLA STRINGA IN QUANTO "\" E'' UN CARATTERE SPECIALE' where codapp='PG' and chiave='it.eldasoft.stampe.server';
		UPDATE W_CONFIG SET descrizione='Percorso e nome del file XLS modello per l''esportazione/importazione dei criteri di valutazione per le gare di tipo OEPV (es.: /opt/tomcat/webapps/Appalti/xls/punteggiOepvGara.xls)' where codapp='PG' and chiave='it.eldasoft.importExportOEPV.modelloxls';
		UPDATE W_CONFIG SET descrizione='Percorso della cartella (lato server) contenente i file zip per l''export ANAC. ATTENZIONE: LA \\ INIZIALE VA RADDOPPIATA NELLA STRINGA IN QUANTO "\" E'' UN CARATTERE SPECIALE (es.: /opt/elda/PG/AdempimentiL190/ )' where codapp='PG' and chiave='it.eldasoft.sil.pg.avcp';
		-- rinominata la sezione
		UPDATE W_CONFIG SET sezione='Schedulazione report' where codapp='PG' and chiave='it.eldasoft.webConsole.risSchedulazioni.path';
		-- marcate a deprecate intere sezioni di properties
		UPDATE W_CONFIG SET sezione='Accesso anonimo (DEPRECATA)', descrizione='(DEPRECATA) Se impostata a 1 presenta il link nella pagina di login per accedere all''applicativo con un accesso anonimo; se impostata a 0 o non valorizzata, non presenta il link' where codapp='PG' and chiave='it.eldasoft.accessoAnonimo';
		UPDATE W_CONFIG SET sezione='Accesso anonimo (DEPRECATA)', descrizione='(DEPRECATA) Account in USRSYS per effettuare l''accesso anonimo (da valorizzare solo se it.eldasoft.accessoAnonimo=1)' where codapp='PG' and chiave='it.eldasoft.accessoAnonimo.account';
		UPDATE W_CONFIG SET sezione='Accesso anonimo (DEPRECATA)', descrizione='(DEPRECATA) Etichetta da visualizzare nel link per l''accesso anonimo (da valorizzare solo se it.eldasoft.accessoAnonimo=1)' where codapp='PG' and chiave='it.eldasoft.accessoAnonimo.etichettaLink';
		UPDATE W_CONFIG SET sezione='Accesso diretto (DEPRECATA)', descrizione='(DEPRECATA) Abilita l''accesso (mediante url specifica) senza autenticazione con login/password ma mediante la sola verifica della login. Se impostata a 1, attiva la url per l''accesso diretto (default = 0)' where codapp='PG' and chiave='it.eldasoft.accessoDiretto';
		UPDATE W_CONFIG SET sezione='Accesso diretto (DEPRECATA)', descrizione='(DEPRECATA) Elenco di parametri da inviare all''accesso, separati da ";"' where codapp='PG' and chiave='it.eldasoft.accessoDiretto.parametri';
		UPDATE W_CONFIG SET sezione='Accesso diretto (DEPRECATA)', descrizione='(DEPRECATA) Sottoelenco dei parametri obbligatori da inviare all''accesso, separati da ";" Tale elenco è un sottoinsieme di quello specificato in "it.eldasoft.accessoDiretto.parametri"' where codapp='PG' and chiave='it.eldasoft.accessoDiretto.parametri.obbligatori';
		UPDATE W_CONFIG SET sezione='Generazione PDF (DEPRECATA)', descrizione='(DEPRECATA) Property con il comando da eseguire per consentire la generazione di un file pdf a partire da un file in un altro formato (rtf, txt, ...). Il comando presuppone l''apertura di un processo con l''esecuzione di uno script/batch' where codapp='PG' and chiave='it.eldasoft.conversione.pdf.task';
		-- rimosse definitivamente perche' usate in sviluppo o in form dismesse
		DELETE FROM W_CONFIG WHERE codapp='PG' AND chiave='it.eldasoft.login.password.consentiNull';
		-- si modifica l'interfaccia per gestire dati salvati cifrati
		UPDATE W_CONFIG SET criptato='1' where codapp='PG' and chiave='registrazione.sso.defaultPassword';
		-- nuove property finora gestite solo su global
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','it.eldasoft.genAttributi.controllo.usaProfilo','0','Configurazione generale','Consente di controllare mediante personalizzazione dei profili la gestione dei dati del generatore attributi; USARE SOLO ALL''EFFETTIVA NECESSITA'', IMPLICA UNA MANUTENZIONE ONEROSA DI TUTTI I PROFILI CUSTOMIZZATI AD OGNI AGGIORNAMENTO! Valori ammessi: 0=controllo mediante generatore attributi [default], 1=controllo mediante personalizzazione dei profili',null);
		-- Nuova property gestione documenti associati su DB
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','it.eldasoft.documentiAssociatiDB',0,'Documenti associati','Abilita la gestione dei documenti associati in database e non su filesystem. Valori ammessi: 0 [default] = gestione disabilitata, 1 = gestione abilitata',null);

		--Aggiornamento view
		-- V_GARE_AGGIUDICATE -----------------------
		-- (S.Santi 27.09.12) Fornisce la lista delle gare aggiudicate in via definitiva (controllo su data atto aggiudicazione valorizzata)
		-- con alcuni dati della ditta aggiudicataria e del legale rappresentante (considera il primo con data inizio incarico valorizzata e data fine nulla).
		-- Nel caso di gara divisa in lotti con plico unico fornisce tante righe quante sono le ditte aggiudicatarie dei singoli lotti
		-- della gara e l''importo di aggiudicazione è il totale sui singoli lotti aggiudicati dalla stessa ditta
		--
		-- (S.Santi 17.09.2014) Esteso view agli ODA. Considera solo le ODA con stato 'Trasmesso' o 'Revocato'. Inoltre considera la data atto contrattuale invece della data atto aggiudicazione.
		--   Tolto il drop view iniziale e gestito specificamente per ogni tipo di DB per pb. con Postgres
		-- (S.Santi 24.06.2016) Differenziata la selezione per le gare a lotti con plico unico in base alla modalità di stipula contratto (MODCONT.TORN): se stipula per lotto, considera 
		--   i singoli lotti aggiudicati senza aggregarli per ditta aggiudicataria.
		perform sp_backupanddropviews('v_gare_aggiudicate');
		create or replace view v_gare_aggiudicate as
			select v_gare_genere.codgar,v_gare_genere.codice,v_gare_genere.oggetto,'0' islotti,gare.codcig,gare.tipgarg,
			gare.dinlavg,gare.teutil,gare.temesi,
			gare.dattoa,gare.iaggiu,gare.ditta,
			impr.nomest,impr.cfimp,impr.pivimp,
			case when impr.tipimp in (3,10) then '1' else '0' end isrt,
			case when impr.natgiui=12 then '1' else '0' end isonlus,
			dd.codleg,teim.nomtim,teim.cftim
			from gare inner join v_gare_genere on v_gare_genere.codice=gare.ngara
				  inner join impr on gare.ditta=impr.codimp
				  left outer join (select codimp2,min(codleg) codleg from impleg d where d.legini is not null and d.legfin is null group by d.codimp2) dd on dd.codimp2=impr.codimp
				  left outer join teim on teim.codtim=dd.codleg
			where v_gare_genere.genere in (2,100) and gare.ditta is not null and gare.dattoa is not null
		  union
			select v_gare_genere.codgar,v_gare_genere.codgar,v_gare_genere.oggetto,'1' islotti,'' codcig,gare.tipgarg,
			gare.dinlavg,gare.teutil,gare.temesi,
			gare.dattoa,ee.iaggiu,ee.ditta,
			impr.nomest,impr.cfimp,impr.pivimp,
			case when impr.tipimp in (3,10) then '1' else '0' end isrt,
			case when impr.natgiui=12 then '1' else '0' end isonlus,
			dd.codleg,teim.nomtim,teim.cftim
			from gare inner join v_gare_genere on gare.ngara=v_gare_genere.codice
				inner join torn on gare.codgar1=torn.codgar
				inner join (select codgar1,ditta,sum(iaggiu) iaggiu from gare e where e.ditta is not null group by codgar1,ditta) ee on ee.codgar1=v_gare_genere.codgar
				inner join impr on ee.ditta=impr.codimp
				left outer join (select codimp2,min(codleg) codleg from impleg d where d.legini is not null and d.legfin is null group by d.codimp2) dd on dd.codimp2=impr.codimp
				left outer join teim on teim.codtim=dd.codleg
			where v_gare_genere.genere=3 and gare.dattoa is not null and torn.modcont=2
		  union
			select v_gare_genere.codgar,v_gare_genere.codice,v_gare_genere.oggetto,'0' islotti,lotto.codcig,gare.tipgarg,
			gare.dinlavg,gare.teutil,gare.temesi,
			lotto.dattoa,lotto.iaggiu,lotto.ditta,
			impr.nomest,impr.cfimp,impr.pivimp,
			case when impr.tipimp in (3,10) then '1' else '0' end isrt,
			case when impr.natgiui=12 then '1' else '0' end isonlus,
			dd.codleg,teim.nomtim,teim.cftim
			from gare inner join v_gare_genere on gare.ngara=v_gare_genere.codgar
				inner join torn on gare.codgar1=torn.codgar
				inner join gare lotto on lotto.ngara=v_gare_genere.codice
				inner join impr on lotto.ditta=impr.codimp
				left outer join (select codimp2,min(codleg) codleg from impleg d where d.legini is not null and d.legfin is null group by d.codimp2) dd on dd.codimp2=impr.codimp
				left outer join teim on teim.codtim=dd.codleg
			where v_gare_genere.genere=300 and lotto.ditta is not null and lotto.dattoa is not null and torn.modcont=1
		  union
			select v_gare_genere.codgar,v_gare_genere.codice,v_gare_genere.oggetto,'0' islotti,gare.codcig,gare.tipgarg,
			gare.dinlavg,gare.teutil,gare.temesi,
			gare.daatto,gare.iaggiu,gare.ditta,
			impr.nomest,impr.cfimp,impr.pivimp,
			case when impr.tipimp in (3,10) then '1' else '0' end isrt,
			case when impr.natgiui=12 then '1' else '0' end isonlus,
			dd.codleg,teim.nomtim,teim.cftim
			from gare inner join v_gare_genere on v_gare_genere.codice=gare.ngara
				  inner join garecont on gare.ngara=garecont.ngara
				  inner join impr on gare.ditta=impr.codimp
				  left outer join (select codimp2,min(codleg) codleg from impleg d where d.legini is not null and d.legfin is null group by d.codimp2) dd on dd.codimp2=impr.codimp
				  left outer join teim on teim.codtim=dd.codleg
			where v_gare_genere.genere = 4 and gare.ditta is not null and garecont.stato>3;
		perform sp_restoreviews('v_gare_aggiudicate');
		
		update eldaver set numver = '6.15.1', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.15.1', datvet = now() where codapp = 'G1';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.15.1' or numver like '6.15.1.%')) THEN
	
				--Definizione nuovi campi
        ALTER TABLE DITG ADD COLUMN NVCOMMTECN VARCHAR(14);
		ALTER TABLE DITG ADD COLUMN DVCOMMTECN TIMESTAMP;
		ALTER TABLE DITG ADD COLUMN NVCONTRADD VARCHAR(14);
		ALTER TABLE DITG ADD COLUMN DVCONTRADD TIMESTAMP;
		
		ALTER TABLE ARCHDOCG ADD COLUMN GARTEL VARCHAR(1);
		ALTER TABLE ARCHDOCG ADD COLUMN ALLMAIL VARCHAR(1);
		ALTER TABLE ARCHDOCG ADD COLUMN IDPRG VARCHAR(2);
		ALTER TABLE ARCHDOCG ADD COLUMN IDDOCDG NUMERIC(12);
		
		ALTER TABLE TORN ADD AQNUMOPE NUMERIC(3);
		
		ALTER TABLE GARALTSOG ADD CODRUP VARCHAR(10);

		CREATE TABLE DITGAQ (
			ID NUMERIC(12) NOT NULL,
			NGARA VARCHAR(20) NOT NULL,
			DITTAO VARCHAR(10) NOT NULL,
			NUMORD NUMERIC(7),
			RIBAGG NUMERIC(24,9),
			PUNTOT NUMERIC(24,9),
			IAGGIU NUMERIC(24,5),
			IMPGAR NUMERIC(24,5),
			RIDISO VARCHAR(1),
			NQUIET VARCHAR(40),
			DQUIET TIMESTAMP,
			ISTCRE VARCHAR(50),
			INDIST VARCHAR(50),
			primary key (ID));

		ALTER TABLE DITGAQ ADD CONSTRAINT FK_DITGAQ_GARE FOREIGN KEY ( NGARA ) REFERENCES GARE( NGARA ) ON DELETE CASCADE;
		CREATE unique index idx_ditgaq_ditg on ditgaq (ngara,dittao);
			
		--Aggiornamento tabellati - verifica l'esistenza perchè già introdotti in patch versione precedente
		IF (select count(*) = 0 from tab1 where tab1cod = 'A1132' and tab1tip=1) THEN
		   insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1132', 1, '1   Tutte le ditte in gara(1)  Ditte in gara dopo taglio ali(2)', NULL);
		END IF;
		IF (select count(*) = 0 from tab4 where tab4cod = 'G1_1' and tab4tip='A1132') THEN
		   insert into TAB4(TAB4COD, TAB4TIP, TAB4DESC) VALUES('G1_1',  'A1132', 'Calcolo aggiudicazione: (DLgs.50/2016) criterio somma ribassi metodo B');
		END IF;

		-- Modifica parametri calcolo aggiudicazione - solo se non già attivate modifiche in patch versione precedente
		IF (select count(*) = 0 from tab1 where tab1cod = 'A1134' and tab1tip=1) THEN
			--Imposta parametro a 100 per evitare esclusione ditte 'fuori limite' nel caso di offerte in aumento
			update TAB1 set tab1desc='100' where tab1cod='A2064' and tab1tip=1;
			--Imposta parametro numero minimo ditte per calcolo soglia anomalia DLgs.50/2016
			insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1135', 1, '5', NULL);
			insert into TAB4(TAB4COD, TAB4TIP, TAB4DESC) VALUES('G1_1',  'A1135', 'Calcolo aggiudicazione: (DLgs.50/2016) numero minimo ditte per calcolo soglia anomalia');
			delete from TAB1 where tab1cod='A2063' and tab1tip=2;
			update TAB1 set tab1desc='5' where tab1cod='A2063' and tab1tip=1;
			update TAB4 set tab4desc='Calcolo aggiudicazione: (DLgs.163/2006) numero minimo ditte per calcolo soglia anomalia' where tab4cod='G1_1' and tab4tip='A2063';
			--Imposta parametro per modalità taglio ali DLgs.50/2016
			insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1134', 1, '2    maniera unitaria (0) maniera individuale (1) nessun accorpamento (2)', NULL);
			insert into TAB4(TAB4COD, TAB4TIP, TAB4DESC) VALUES('G1_1',  'A1134', 'Calcolo aggiudicazione: (DLgs.50/2016) criterio accorpamento offerte uguali nel taglio ali');
			update TAB4 set tab4desc='Calcolo aggiudicazione: (DLgs.163/2006) criterio accorpamento offerte uguali nel taglio ali' where tab4cod='G1_1' and tab4tip='A1107';
			--Ridotto a 5 il numero cifre decimali di arrotondamento da applicare nel calcolo soglia
			update TAB1 set tab1desc='5' where tab1cod='A1018' and tab1tip=1;
			update TAB4 set tab4desc='Calcolo aggiudicazione: numero cifre decimali utilizzate nel calcolo soglia di anomalia' where tab4cod='G1_1' and tab4tip='A1018';
		END IF;

		-- Nuovo parametro per controllo esistenza punto ordinante
		insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1133', 1, '0   Attiva controllo(1) Disattiva controllo(0)', NULL);
		insert into TAB4(TAB4COD, TAB4TIP, TAB4DESC) VALUES('G1_1',  'A1133', 'Procedure telematiche: controllo esistenza punto istruttore');

		delete from c0campi where c0c_mne_ber in ('G1NVCOMMT','G1DVCOMMT','G1NVCONTRAD','G1DVCONTRAD','G1GARTELAD','G1ALLMAILAD','G1IDPRGAD','G1IDDOCDGAD','G1AQNUMOPE','G1CODRUPSOG');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'NVCOMMTECN.DITG.GARE', 'G1NVCOMMT', 'Numero verbale commissione tecnica', 'N.verb.comm.tecn.', 'A14', NULL, NULL, 'Num.verbale comm.tecnica');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'DVCOMMTECN.DITG.GARE', 'G1DVCOMMT', 'Data verbale commissione tecnica', 'Data verb.comm.tecn.', 'A10', NULL, 'DATA_ELDA', 'Data verbale comm.tecnica');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'NVCONTRADD.DITG.GARE', 'G1NVCONTRAD', 'Numero verbale contradditorio', 'N.verb.contradd.', 'A14', NULL, NULL, 'Num.verbale contraddittorio');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'DVCONTRADD.DITG.GARE', 'G1DVCONTRAD', 'Data verbale contraddittorio', 'Data verb.contradd.', 'A10', NULL, 'DATA_ELDA', 'Data verbale contraddittorio');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'GARTEL.ARCHDOCG.GARE', 'G1GARTELAD', 'Procedura telematica?', 'Proced.telematica?', 'A2', NULL, 'SN', NULL);
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'ALLMAIL.ARCHDOCG.GARE', 'G1ALLMAILAD', 'Documento da allegare alla comunicazione di invito?', 'Alleg.comun.invito?', 'A2', NULL, 'SN', 'Allegare alla comunicazione?');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'IDPRG.ARCHDOCG.GARE', 'G1IDPRGAD', 'Codice applicativo (riferimento ad arch.documenti digitali)', 'Codice applicativo', 'A2', NULL, NULL, NULL);
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'IDDOCDG.ARCHDOCG.GARE', 'G1IDDOCDGAD', 'ID documento (riferimento ad arch.documenti digitali)', 'Codice documento', 'N12', NULL, NULL, NULL);
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'AQNUMOPE.TORN.GARE', 'G1AQNUMOPE', 'Numero massimo operatori dell''accordo quadro', 'N.operatori acc.qua.', 'N3', NULL, NULL, 'N.operatori accordo quadro');
        Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'CODRUP.GARALTSOG.GARE', 'G1CODRUPSOG', 'Responsabile unico di procedimento', 'Resp.unico procedim.', 'A10', NULL, NULL, 'Codice responsabile unico procedimento');
		
		delete from c0campi where c0c_mne_ber in ('G1IDDQ','G1NGARADQ','G1DITTAODQ','G1NPROGGDQ','G1RIBAGGDQ','G1PUNTOTDQ','G1IAGGIUDQ','G1IMPGARDQ','G1RIDISODQ','G1NQUIETDQ','G1DQUIETDQ','G1ISTCREDQ','G1INDISTDQ');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', 'P', 'ID.DITGAQ.GARE', 'G1IDDQ', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'NGARA.DITGAQ.GARE', 'G1NGARADQ', 'Codice gara', 'Codice gara', 'A20', NULL, NULL, NULL);
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'DITTAO.DITGAQ.GARE', 'G1DITTAODQ', 'Cod.ditta aggiudicataria dell''accordo quadro', 'Codice ditta ', 'A10', NULL, NULL, NULL);
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'NUMORD.DITGAQ.GARE', 'G1NPROGGDQ', 'Numero d''ordine graduatoria aggiudicazione', 'Num.ordine graduat.', 'N7', NULL, NULL, NULL);
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'RIBAGG.DITGAQ.GARE', 'G1RIBAGGDQ', 'Ribasso di aggiudicazione definitiva della gara', 'Ribasso di aggiud.', 'F13.9', NULL, NULL, 'Ribasso di aggiudicazione');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'PUNTOT.DITGAQ.GARE', 'G1PUNTOTDQ', 'Punteggio di aggiudicazione definitiva della gara', 'Punteggio di aggiud.', 'F13.9', NULL, NULL, 'Punteggio di aggiudicazione');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'IAGGIU.DITGAQ.GARE', 'G1IAGGIUDQ', 'Importo di aggiudicazione definitiva della gara', 'Importo di aggiud.', 'F15', NULL, 'MONEY', 'Importo di aggiudicazione');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'IMPGAR.DITGAQ.GARE', 'G1IMPGARDQ', 'Importo cauzione definitiva', 'Imp.cauzione defin.', 'F15', NULL, 'MONEY', 'Importo cauzione definitiva');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'RIDISO.DITGAQ.GARE', 'G1RIDISODQ', 'Riduzione importo cauzione per certificazione ISO ?', 'Riduzione ISO?', 'A2', NULL, 'SN', 'Riduzione importo cauzione per certificaz.ISO?');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'NQUIET.DITGAQ.GARE', 'G1NQUIETDQ', 'Numero polizza per la cauzione definitiva', 'Num.polizza cauzione', 'A40', NULL, NULL, 'Numero polizza');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'DQUIET.DITGAQ.GARE', 'G1DQUIETDQ', 'Data polizza per la cauzione definitiva', 'Data polizza cauz. ', 'A10', NULL, 'DATA_ELDA', 'Data polizza');
		Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'ISTCRE.DITGAQ.GARE', 'G1ISTCREDQ', 'Istituto che rilascia la polizza per la cauzione definitiva', 'Ist. polizza cauz.', 'A50', NULL, NULL, 'Istituto che rilascia la polizza');
        Insert into C0CAMPI (COC_CONTA, C0C_TIP, C0C_CHI, COC_MNE_UNI, C0C_MNE_BER, COC_DES, COC_DES_FRM, C0C_FS, C0C_TAB1, COC_DOM, COC_DES_WEB) Values (0, 'E', NULL, 'INDIST.DITGAQ.GARE', 'G1INDISTDQ', 'Sede o filiale dell''istituto che rilascia la polizza', 'Sede ist.polizza', 'A50', NULL, NULL, 'Sede o filiale');

		delete from c0entit where c0e_nom in ('DITGAQ.GARE','DITG.GARE#3');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('DITGAQ.GARE', 0, 'E', 'DITTE_AQ', 'Operatori dell''accordo quadro', 'NGARA.DITGAQ.GARE', 'GARE.GARE', 'NGARA.GARE.GARE', NULL, NULL, 'g1_diaq0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('DITG.GARE#3', 0, 'C', NULL, 'Dati generali della ditta partecipante alla gara', 'NGARA5.DITG.GARE,DITTAO.DITG.GARE', 'DITGAQ.GARE', 'NGARA.DITGAQ.GARE,DITTAO.DITGAQ.GARE', NULL, NULL, 'g1_ditg0');
                
        Update C0CAMPI SET COC_DES_WEB='Da importo' where C0C_MNE_BER='LIMINFAD';
		Update C0CAMPI SET COC_DES_WEB='A importo' where C0C_MNE_BER='LIMSUPAD';
		Update C0CAMPI SET COC_DES_WEB='Identificativo per generazione automatica del documento' where C0C_MNE_BER='G1IDSTAMPA1';
		Update C0CAMPI SET COC_DES_WEB='Somma ribassi offerte' where C0C_MNE_BER='G1SOMMARIB';
		Update C0CAMPI SET COC_DES='Data protocollo dell''atto di autorizzazione della gara', COC_DES_FRM='Data prot.atto aut.', COC_DES_WEB='Data protocollo' where C0C_MNE_BER='G1DATRICT';
		Update C0CAMPI SET COC_DES='Data protocollo dell''atto di autorizzazione', COC_DES_FRM='D.prot.atto autoriz.', COC_DES_WEB='Data protocollo' where C0C_MNE_BER='G1DPROAA';
		Update C0CAMPI SET COC_DES='N.cifre decimali utilizzate nel calcolo soglia anomalia', COC_DES_FRM='N.decim.calc.soglia', COC_DES_WEB='N.decimali utilizzati nel calcolo' where C0C_MNE_BER='G1PRECUT';


		--Abilito la visibilità dei campi di ARCHDOCG
		update c0entit set c0e_tip = 'E' where c0e_nom='ARCHDOCG.GARE';
		update c0campi set c0c_tip = 'E' where coc_mne_uni like '%ARCHDOCG.GARE%';
		
        INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('DITGAQ',0);

		--Abilita sempre tracciatura su LOGEVENTI e tolta configurazione da interfaccia
		update W_CONFIG set valore='1', sezione=null where codapp='PG' and chiave='eventi.log';

		--Aggiornamento profili
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('MASC', 'GARE.DITG-DETTAVV', 'Dettaglio Avvalimento', 12490);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values('FUNZ', 'MOD.GARE.DITG-DETTAVV.SCHEDAMOD', 'Modifica Avvalimento', 12500);
		
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SUBMENU', 'AMMINISTRAZIONE.Configurazione-ARCHDOCG', 'Configurazione Documenti di gara', 12510);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.DettaglioAmmissioneDittaLotti', 'Dettaglio ammissione ditta ai lotti', 12520);
		
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.FasiGaraUlterioriDettagli.CONTRADD', 'Sezione Contradditorio', 6192);

		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-scheda.AGGDEF.DITGAQ', 'Sezione Ditte aggiudicatarie', 3012);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'DEL.GARE.GARE-scheda.AGGDEF.DEL-DITGAQ', 'Elimina Ditta aggiudicataria', 12530);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'INS.GARE.GARE-scheda.AGGDEF.INS-DITGAQ', 'Inserisci Ditta aggiudicataria', 12540);
                
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-scheda.STIPULA.DITGAQ', 'Sezione Ditte aggiudicatarie', 12152);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'DEL.GARE.GARE-scheda.STIPULA.DEL-DITGAQ', 'Elimina Ditta aggiudicataria', 12550);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'INS.GARE.GARE-scheda.STIPULA.INS-DITGAQ', 'Inserisci Ditta aggiudicataria', 12560);

        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-AGGIUDLOTTI.DITGAQ', 'Sezione Ditte aggiudicatarie', 6092);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'DEL.GARE.GARE-AGGIUDLOTTI.DEL-DITGAQ', 'Elimina Ditta aggiudicataria', 12570);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'INS.GARE.GARE-AGGIUDLOTTI.INS-DITGAQ', 'Inserisci Ditta aggiudicataria', 12580);
		
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-scheda-contratto.STIPULA.DITGAQ', 'Sezione Ditte aggiudicatarie', 12402);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'DEL.GARE.GARE-scheda-contratto.STIPULA.DEL-DITGAQ', 'Elimina Ditta aggiudicataria', 12590);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'INS.GARE.GARE-scheda-contratto.STIPULA.INS-DITGAQ', 'Inserisci Ditta aggiudicataria', 12600);

        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GENEWEB.W_INVCOM-lista.copiaComunicazioneReinvio', 'Copia comunicazione per reinvio', 12610);
                
		Update W_OGGETTI set ord=2060,descr='Personalizzazione Autovie: codifica automatica e diciture' where tipo='FUNZ' and oggetto='ALT.GARE.PersonalizzazioneAutovie';
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.AutovieArchiflow', 'Personalizzazione Autovie: consulta protocollo Archiflow', 2061);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.AutovieIds', 'Personalizzazione Autovie: gestione Impegni di spesa', 2062);

                Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-scheda.ORDINE.ALLEGATI', 'Sezione allegati ordine', 11185);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'DEL.GARE.GARE-scheda.ORDINE.DEL-ALLEGATI', 'Elimina allegato ordine', 12620);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'INS.GARE.GARE-scheda.ORDINE.INS-ALLEGATI', 'Inserisci allegato ordine', 12630);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARECONT-scheda.DATIGEN.ALLEGATI', 'Sezione allegati ordine', 10995);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'DEL.GARE.GARECONT-scheda.DATIGEN.DEL-ALLEGATI', 'Elimina allegato ordine', 12640);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'INS.GARE.GARECONT-scheda.DATIGEN.INS-ALLEGATI', 'Inserisci allegato ordine', 12650);

                Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.GARE-scheda.LISTALAVFORN.selezioneAccordoQuadro', 'Selezione da accordo quadro', 12660);

		--Default nuovi campi
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('COLS', 'VIS', 'GARE.DITG.NVCOMMTECN', 'Visualizza', 0, 1, 1, 3566396468);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('COLS', 'VIS', 'GARE.DITG.NVCONTRADD', 'Visualizza', 0, 1, 1, 2872555945);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('COLS', 'VIS', 'GARE.DITG.DVCOMMTECN', 'Visualizza', 0, 1, 1, 4006445586);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('COLS', 'VIS', 'GARE.DITG.DVCONTRADD', 'Visualizza', 0, 1, 1, 2439569295);
		
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('SEZ', 'VIS', 'GARE.FasiGaraUlterioriDettagli.CONTRADD', 'Visualizza', 0, 1, 1, 4189661105);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('FUNZ', 'VIS', 'INS.GARE.GARE-scheda.AGGDEF.INS-DITGAQ', 'Visualizza', 0, 1, 1, 1615890654);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('FUNZ', 'VIS', 'DEL.GARE.GARE-scheda.AGGDEF.DEL-DITGAQ', 'Visualizza', 0, 1, 1, 4032807932);
		
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('FUNZ', 'VIS', 'INS.GARE.GARE-scheda.STIPULA.INS-DITGAQ', 'Visualizza', 0, 1, 1, 3052330985);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('FUNZ', 'VIS', 'DEL.GARE.GARE-scheda.STIPULA.DEL-DITGAQ', 'Visualizza', 0, 1, 1, 1158797390);
		
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('FUNZ', 'VIS', 'INS.GARE.GARE-AGGIUDLOTTI.INS-DITGAQ', 'Visualizza', 0, 1, 1, 2726860363);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('FUNZ', 'VIS', 'DEL.GARE.GARE-AGGIUDLOTTI.DEL-DITGAQ', 'Visualizza', 0, 1, 1, 1864266780);

		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('FUNZ', 'VIS', 'INS.GARE.GARE-scheda-contratto.STIPULA.INS-DITGAQ', 'Visualizza', 0, 1, 1, 1434143442);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('FUNZ', 'VIS', 'DEL.GARE.GARE-scheda-contratto.STIPULA.DEL-DITGAQ', 'Visualizza', 0, 1, 1, 793239570);
		
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('FUNZ', 'VIS', 'ALT.GARE.AutovieArchiflow', 'Visualizza', 0, 1, 1, 2799314889);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('FUNZ', 'VIS', 'ALT.GARE.AutovieIds', 'Visualizza', 0, 1, 1, 1332971612);

		perform sp_backupanddropviews('v_dati_lotti_completa');
		IF exists (select tablename from pg_tables where upper(tablename) = 'APPA') THEN
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			  select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
				   torn.dteoff
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join v_gare_torn on gare.codgar1=v_gare_torn.codgar and v_gare_torn.codice = gare.ngara
			 left outer join (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9) pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			where v_gare_torn.genere=2
		   union
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
				  torn.dteoff
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join v_gare_torn on torn.codgar=v_gare_torn.codice
			 left outer join (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9) pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			where v_gare_torn.genere=1
		   union
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				  else gc.dverbc end datainizio,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
				   torn.dteoff
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join v_gare_torn on torn.codgar=v_gare_torn.codice
			 left outer join (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9) pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.codgar1 and gc.codimp=gare.ditta and (gc.ngaral is null or gc.ngaral=gare.ngara))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			where v_gare_torn.genere=3 and gare.ngara<>gare.codgar1
		   union
			 select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 where gare.genere=4';
		else
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join v_gare_torn on gare.codgar1=v_gare_torn.codgar and v_gare_torn.codice = gare.ngara
			 left outer join (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9) pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			where v_gare_torn.genere=2
		  union
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join v_gare_torn on torn.codgar=v_gare_torn.codice
			 left outer join (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9) pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			where v_gare_torn.genere=1
		   union
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join v_gare_torn on torn.codgar=v_gare_torn.codice
			 left outer join (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9) pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.codgar1 and gc.codimp=gare.ditta and (gc.ngaral is null or gc.ngaral=gare.ngara))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			where v_gare_torn.genere=3 and gare.ngara<>gare.codgar1
			union
			  select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 where gare.genere=4';
		end if;
		perform sp_restoreviews('v_dati_lotti_completa');

		-- Adeguamento per gestione di più aggiudicatari (caso di accordo quadro con più operatori)
		perform sp_backupanddropviews('v_dati_ditte_partecipanti');
		create or replace view V_DATI_DITTE_PARTECIPANTI as
			select d.dittao as ditta,d.ngara5 as lotto,
			   (case when i.tipimp=2 or i.tipimp=3 or i.tipimp=4 or i.tipimp=10 or i.tipimp=11 then 2 else 1 end) as tipo,
				i.nomest as ragsoc,
				(case when gare.ditta is null 
					then (case when ditgaq.dittao is null then 2 else 1 end)
					else 1 end) as isAggiudicataria
			from ditg d inner join impr i on (d.dittao=i.codimp)
			left outer join gare on (d.ngara5=gare.ngara and d.dittao=gare.ditta)
			left outer join ditgaq on (d.ngara5=ditgaq.ngara and d.dittao=ditgaq.dittao)
			where  d.rtofferta is null;
		perform sp_restoreviews('v_dati_ditte_partecipanti');
		
		-- Corretto riferimento a campo 'Fase di gara' nelle sedute di gara
		perform sp_backupanddropviews('v_scad_bandi_altro');
		CREATE OR REPLACE VIEW v_scad_bandi_altro AS
			/* Seduta pubblica apertura della busta A contenente la documentazione amministrativa */
			SELECT g.codgar, 'PG-SEDPUBBLDOCAMM' AS codevento, MIN(s.datini) AS dataconsuntivo 
			  FROM torn g INNER JOIN v_gare_torn vgt ON g.codgar=vgt.codgar INNER JOIN gare l ON g.codgar = l.codgar1 INNER JOIN garsed s ON l.ngara = s.ngara
			 WHERE vgt.genere in (2,3) AND s.fase=2
			GROUP BY g.codgar
			UNION ALL
			/* Data esame documentazione ex art. 48 comma 1 */
			SELECT g.codgar, 'PG-ESAMEDOC' AS codevento, desdoc AS dataconsuntivo 
			  FROM torn g INNER JOIN v_gare_torn vgt ON g.codgar=vgt.codgar
			 WHERE vgt.genere in (1,2,3)
			UNION ALL
			/* Seduta pubblica  di apertura delle offerte economiche */
			SELECT g.codgar, 'PG-SEDPUBBLOFFEC' AS codevento, MIN(s.datini) AS dataconsuntivo 
			  FROM torn g INNER JOIN v_gare_torn vgt ON g.codgar=vgt.codgar INNER JOIN gare l ON g.codgar = l.codgar1 INNER JOIN garsed s ON l.ngara = s.ngara
			 WHERE vgt.genere in (2,3) AND s.fase=6
			GROUP BY g.codgar
			UNION ALL
			/* Seduta apertura offerte tecniche */
			SELECT g.codgar, 'PG-SEDAPOFFTECN' AS codevento, MIN(s.datini) AS dataconsuntivo 
			  FROM torn g INNER JOIN v_gare_torn vgt ON g.codgar=vgt.codgar INNER JOIN gare l ON g.codgar = l.codgar1 INNER JOIN garsed s ON l.ngara = s.ngara
			 WHERE vgt.genere in (1,2,3) AND s.fase=5
			GROUP BY g.codgar
			UNION ALL
			/* Determinazione di aggiudicazione definitiva non efficace */
			SELECT g.codgar1 AS codgar, 'PG-AGGDEFNONEFF' AS codevento, MAX(g.dattoa) AS dataconsuntivo 
			  FROM gare g INNER JOIN v_gare_torn vgt ON g.codgar1=vgt.codgar
			 WHERE vgt.genere in (2,3)
			GROUP BY g.codgar1
			UNION ALL
			/* Data stipula contrattuale */
			SELECT g.codgar1 AS codgar, 'PG-DATASTIPCONTR' AS codevento, max(g.daatto) AS dataconsuntivo 
			  FROM gare g INNER JOIN v_gare_torn vgt ON g.codgar1=vgt.codgar
			 WHERE vgt.genere in (2,3)
			GROUP BY g.codgar1;
		perform sp_restoreviews('v_scad_bandi_altro');

		perform sp_backupanddropviews('v_scad_lottibando_altro');
		CREATE OR REPLACE VIEW v_scad_lottibando_altro AS
			/* Seduta pubblica apertura della busta A contenente la documentazione amministrativa */
			SELECT l.ngara, 'PG-LOT-SEDPUBBLDOCAMM' AS codevento, MIN(s.datini) AS dataconsuntivo 
			  FROM v_gare_genere vgt INNER JOIN gare l ON vgt.codice = l.ngara INNER JOIN garsed s ON l.ngara = s.ngara
			 WHERE vgt.genere=100 AND s.fase=2
			GROUP BY l.ngara
			UNION ALL
			/* Data esame documentazione ex art. 48 comma 1 del lotto */
			SELECT ngara, 'PG-LOT-ESAMEDOC' AS codevento, desdoc AS dataconsuntivo 
			  FROM gare g INNER JOIN v_gare_genere vgt ON g.ngara=vgt.codice
			 WHERE vgt.genere=100
			UNION ALL
			/* Seduta pubblica di apertura delle offerte economiche */
			SELECT l.ngara, 'PG-LOT-SEDPUBBLOFFEC' AS codevento, MIN(s.datini) AS dataconsuntivo 
			  FROM v_gare_genere vgt INNER JOIN gare l ON vgt.codice = l.ngara INNER JOIN garsed s ON l.ngara = s.ngara
			 WHERE vgt.genere=100 AND s.fase=6
			GROUP BY l.ngara
			UNION ALL
			/* Seduta apertura offerte tecniche */
			SELECT l.ngara, 'PG-LOT-SEDAPOFFTECN' AS codevento, MIN(s.datini) AS dataconsuntivo 
			  FROM v_gare_genere vgt INNER JOIN gare l ON vgt.codice = l.ngara INNER JOIN garsed s ON l.ngara = s.ngara
			 WHERE vgt.genere=100 AND s.fase=5
			GROUP BY l.ngara
			UNION ALL
			/* Determinazione di aggiudicazione definitiva non efficace */
			SELECT ngara, 'PG-LOT-AGGDEFNONEFF' AS codevento, g.dattoa AS dataconsuntivo 
			  FROM gare g INNER JOIN v_gare_genere vgt ON g.ngara=vgt.codice
			 WHERE vgt.genere=100
			UNION ALL
			/* Data stipula contrattuale */
			SELECT ngara, 'PG-LOT-DATASTIPCONTR' AS codevento, g.daatto AS dataconsuntivo 
			  FROM gare g INNER JOIN v_gare_genere vgt ON g.ngara=vgt.codice
			 WHERE vgt.genere=100;
		perform sp_restoreviews('v_scad_lottibando_altro');

		update eldaver set numver = '6.15.2', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.15.2', datvet = now() where codapp = 'G1';

		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilit&agrave;-> Manuali'),null,50,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0' 
		and exists(select w_accpro.cod_profilo 
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo 
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
	DECLARE maxnum INT;
	DECLARE maxtip INT;
	DECLARE conta INT;
	DECLARE valtab2d2 VARCHAR;
	DECLARE lentab2d2 INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.15.2' or numver like '6.15.2.%')) THEN

		--Definizione nuovi campi
		ALTER TABLE TORN ADD AERIBMIN NUMERIC(24,5);
		ALTER TABLE TORN ADD AERIBMAX NUMERIC(24,5);
		ALTER TABLE TORN ADD AEIMPMIN NUMERIC(24,5);
		ALTER TABLE TORN ADD AEIMPMAX NUMERIC(24,5);
		ALTER TABLE TORN ADD AEMODVIS NUMERIC(7);
		ALTER TABLE TORN ADD AENOTE VARCHAR(2000);

		ALTER TABLE GARE1 ADD AEDINVIT TIMESTAMP;
		ALTER TABLE GARE1 ADD AENPROTI VARCHAR(20);

		ALTER TABLE DITG ADD ISRILANCIO VARCHAR(1);

		CREATE TABLE AEFASI (
			ID NUMERIC(12) NOT NULL,
			NGARA VARCHAR(20) NOT NULL,
			DATINI TIMESTAMP,
			ORAINI VARCHAR(6),
			DURMIN NUMERIC(5),
			DURMAX NUMERIC(5),
			TBASE NUMERIC(5),
			DATAORAINI TIMESTAMP,
			DATAORAFINE TIMESTAMP,
			NUMFASE NUMERIC(5),
			primary key (ID));
        ALTER TABLE AEFASI ADD CONSTRAINT FK_AEFASI_GARE FOREIGN KEY ( NGARA ) REFERENCES GARE( NGARA ) ON DELETE CASCADE;

        CREATE TABLE AERILANCI (
			ID NUMERIC(12) NOT NULL,
			NGARA VARCHAR(20) NOT NULL,
			DITTAO VARCHAR(10) NOT NULL,
			NUMRIL NUMERIC(5) NOT NULL,
			NUMFASE NUMERIC(5),
			RIBAUO NUMERIC(24,9),
			IMPOFF NUMERIC(24,5),
			DATAORARIL TIMESTAMP,
			primary key (ID));
        ALTER TABLE AERILANCI ADD CONSTRAINT FK_AERILANCI_GARE FOREIGN KEY ( NGARA ) REFERENCES GARE( NGARA ) ON DELETE CASCADE;
		CREATE unique index idx_aerilanci_numril on aerilanci (ngara,dittao,numril);

        CREATE TABLE AERILPRE (
			ID NUMERIC(12) NOT NULL,
            IDRIL NUMERIC(12) NOT NULL,
            NGARA VARCHAR(20) NOT NULL,
			CONTAF NUMERIC(7) NOT NULL,
			DITTAO VARCHAR(10) NOT NULL,
			PREOFF NUMERIC(24,5),
			IMPOFF NUMERIC(24,5),
			primary key (ID));
        ALTER TABLE AERILPRE ADD CONSTRAINT FK_AERILPRE_AERILANCI FOREIGN KEY ( IDRIL ) REFERENCES AERILANCI( ID ) ON DELETE CASCADE;
		CREATE unique index idx_aerilpre_contaf on aerilpre (idril,ngara,contaf,dittao);

		CREATE TABLE GARDOC_JOBS (
		  ID_ARCHIVIAZIONE NUMERIC(10) NOT NULL,
		  SYSCON NUMERIC(12),
		  CODGARA VARCHAR(21),
		  DATA_INSERIMENTO TIMESTAMP,
		  DATA_CREAZIONE TIMESTAMP,
		  DA_PROCESSARE VARCHAR(1),
		  ESITO TEXT,
		  PRIMARY KEY (id_archiviazione));

		--Estensione campo LocalitÃ 
		perform sp_backupanddropviews('gare');
  		ALTER TABLE GARE ALTER COLUMN NOMSSL TYPE VARCHAR(500);
  		ALTER TABLE GARE ALTER COLUMN NUMSSL TYPE VARCHAR(500);
		ALTER TABLE GARE ALTER COLUMN NPROTI TYPE VARCHAR(20);
		perform sp_restoreviews('gare');

		--Estensione campi numero protocollo
		IF (select count(*) = 0 from c0campi where C0C_MNE_BER = 'G1NPRDOM' and C0C_FS='A20') THEN
			perform sp_backupanddropviews('torn');
			ALTER TABLE TORN ALTER COLUMN NPROTI TYPE VARCHAR(20);
			perform sp_restoreviews('torn');
			perform sp_backupanddropviews('ditg');
			ALTER TABLE DITG ALTER COLUMN NPRDOM TYPE VARCHAR(20);
			ALTER TABLE DITG ALTER COLUMN NPROFF TYPE VARCHAR(20);
			ALTER TABLE DITG ALTER COLUMN NPRREQ TYPE VARCHAR(20);
			ALTER TABLE DITG ALTER COLUMN NPLETTRICHGIU TYPE VARCHAR(20);
			ALTER TABLE DITG ALTER COLUMN NPRICEZGIU TYPE VARCHAR(20);
			perform sp_restoreviews('ditg');
			perform sp_backupanddropviews('ditgstati');
			ALTER TABLE DITGSTATI ALTER COLUMN NPLETTRICHCC TYPE VARCHAR(20);
			ALTER TABLE DITGSTATI ALTER COLUMN NPLETTCOMESCL TYPE VARCHAR(20);
			ALTER TABLE DITGSTATI ALTER COLUMN NCOMSVIP TYPE VARCHAR(20);
			ALTER TABLE DITGSTATI ALTER COLUMN NPPRESDOC TYPE VARCHAR(20);
			perform sp_restoreviews('ditgstati');
			perform sp_backupanddropviews('garestati');
			ALTER TABLE GARESTATI ALTER COLUMN NPLETTRICHCC TYPE VARCHAR(20);
			ALTER TABLE GARESTATI ALTER COLUMN NPLETTCOMESCL TYPE VARCHAR(20);
			perform sp_restoreviews('garestati');
		END IF;

		IF NOT EXISTS (SELECT 1 FROM pg_class c JOIN pg_namespace n ON n.oid = c.relnamespace WHERE  c.relname = 'idx_gare_codgar1') THEN
			CREATE INDEX idx_gare_codgar1 ON gare (codgar1);
		END IF;

        INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('AEFASI',0);
        INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('AERILANCI',0);
        INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('AERILPRE',0);
        INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('GARDOC_JOBS',0);

   	    --Aggiornamento tabellati
    	insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1136', 1, 'Classificazione della singola ditta ', NULL);
    	insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1136', 2, 'Classificazione della singola ditta e migliore offerta ', NULL);
    	insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1136', 3, 'Classificazione e offerta di tutti i concorrenti', NULL);
        insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1137', 1, '1   Applica vincolo(1) Non applica vincolo(0)', NULL);
		insert into TAB4(TAB4COD, TAB4TIP, TAB4DESC) VALUES('G1_1',  'A1137', 'Procedure telematiche: vincolo su unico punto ordinante');
        
		IF (select count(*) = 0 from tab1 where tab1cod = 'A1138' and tab1tip=1) THEN
			insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1138', 1, '0   Applica vincolo(1) Non applica vincolo(0)', NULL);
			insert into TAB4(TAB4COD, TAB4TIP, TAB4DESC) VALUES('G1_1',  'A1138', 'Affidamenti in adesione ad accordo quadro: vincolo su unico operatore');
		END IF;

	    -- (S.Santi 16.12.2016) Allineamento tabellati in seguito a introduzione tipi procedura 'Proc.negoziata previa indizione di gara/previa indagine di mercato'. Script presente anche in LFS/GIL
		-- Aggiunge due righe nel tabellato 'A2044' spostando prima quelle con chiave uguale e aggiorna tutte le entitÃ  che vi fanno riferimento
		if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='A2044' and TAB1TIP=27 and (TAB1DESC is null or TAB1DESC!='Procedura negoziata con previa indizione di gara')) = 1) then
			maxtip := 0;
			SELECT MAX(TAB1TIP) INTO maxtip FROM TAB1 WHERE TAB1COD='A2044';
			conta := maxtip + 1;
			UPDATE TAB1 SET TAB1TIP=conta WHERE TAB1COD='A2044' and TAB1TIP=27;
			conta := maxtip + 2;
			UPDATE TAB1 SET TAB1TIP=conta WHERE TAB1COD='A2044' and TAB1TIP=28;
			IF exists (select tablename from pg_tables where upper(tablename) = 'GARE') THEN
				conta := maxtip + 1;
				UPDATE TORN SET TIPGAR=conta WHERE TIPGAR=27;
				UPDATE GARE SET TIPGARG=conta WHERE TIPGARG=27;
				UPDATE CATPUB SET TIPGAR=conta WHERE TIPGAR=27;
				UPDATE ARCHDOCG SET TIPOPROC=conta WHERE TIPOPROC=27;
				UPDATE CONFOPECO SET TIPOPROCEDURA=conta WHERE TIPOPROCEDURA=27;
				conta := maxtip + 2;
				UPDATE TORN SET TIPGAR=conta WHERE TIPGAR=28;
				UPDATE GARE SET TIPGARG=conta WHERE TIPGARG=28;
				UPDATE CATPUB SET TIPGAR=conta WHERE TIPGAR=28;
				UPDATE ARCHDOCG SET TIPOPROC=conta WHERE TIPOPROC=28;
				UPDATE CONFOPECO SET TIPOPROCEDURA=conta WHERE TIPOPROCEDURA=28;
			END IF;
			IF exists (select tablename from pg_tables where upper(tablename) = 'PERI') THEN
				conta := maxtip + 1;
				UPDATE APPA SET TIPAGG=conta WHERE TIPAGG=27;
				UPDATE ORDI SET TIPAGG=conta WHERE TIPAGG=27;
				conta := maxtip + 2;
				UPDATE APPA SET TIPAGG=conta WHERE TIPAGG=28;
				UPDATE ORDI SET TIPAGG=conta WHERE TIPAGG=28;
			END IF;
			IF exists (select tablename from pg_tables where upper(tablename) = 'SCHCON') THEN
				conta := maxtip + 1;
				UPDATE SCHCON SET TIPGARG=conta WHERE TIPGARG=27;
				conta := maxtip + 2;
				UPDATE SCHCON SET TIPGARG=conta WHERE TIPGARG=28;
			END IF;
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 27, 'Procedura negoziata con previa indizione di gara', '1', 26);
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 28, 'Procedura negoziata con previa indagine di mercato', '1', 10);
		end if;
		--Aggiorna parametri di configurazione - solo nel caso di Appalti
		if ((SELECT count(TAB2TIP) FROM TAB2 WHERE TAB2COD='A1z05' and TAB2TIP=72 and (TAB2D2 is null or TAB2D2 not like '%27,28%')) = 1) then
			SELECT COALESCE(TAB2D2,''), COALESCE(length(TAB2D2),0) into valtab2d2,lentab2d2 FROM TAB2 WHERE TAB2COD='A1z05' and TAB2TIP=72;
			if (lentab2d2>0) then
				valtab2d2 := valtab2d2 || ',';
			end if;
			valtab2d2 := valtab2d2 || '27,28';
			UPDATE TAB2 SET TAB2D2=valtab2d2 WHERE TAB2COD='A1z05' and TAB2TIP=72;
		end if;
		if ((SELECT count(TAB2TIP) FROM TAB2 WHERE TAB2COD='A1z04' and TAB2TIP=4 and (TAB2D2 is null or TAB2D2 not like '%27,28%')) = 1) then
			SELECT COALESCE(TAB2D2,''), COALESCE(length(TAB2D2),0) into valtab2d2,lentab2d2 FROM TAB2 WHERE TAB2COD='A1z04' and TAB2TIP=4;
			if (lentab2d2>0) then
				valtab2d2 := valtab2d2 || ',';
			end if;
			valtab2d2 := valtab2d2 || '27,28';
			UPDATE TAB2 SET TAB2D2=valtab2d2 WHERE TAB2COD='A1z04' and TAB2TIP=4;
		end if;
		if ((SELECT count(TAB2TIP) FROM TAB2 WHERE TAB2COD='A1z03' and TAB2TIP=1 and (TAB2D2 is null or TAB2D2 not like '%27,28%')) = 1) then
			SELECT COALESCE(TAB2D2,''), COALESCE(length(TAB2D2),0) into valtab2d2,lentab2d2 FROM TAB2 WHERE TAB2COD='A1z03' and TAB2TIP=1;
			if (lentab2d2>0) then
				valtab2d2 := valtab2d2 || ',';
			end if;
			valtab2d2 := valtab2d2 || '27,28';
			UPDATE TAB2 SET TAB2D2=valtab2d2 WHERE TAB2COD='A1z03' and TAB2TIP=1;
		end if;
		if ((SELECT count(TAB2TIP) FROM TAB2 WHERE TAB2COD='A1z06' and TAB2TIP=1 and (TAB2D2 is null or TAB2D2 not like '%27,28%')) = 1) then
			SELECT COALESCE(TAB2D2,''), COALESCE(length(TAB2D2),0) into valtab2d2,lentab2d2 FROM TAB2 WHERE TAB2COD='A1z06' and TAB2TIP=1;
			if (lentab2d2>0) then
				valtab2d2 := valtab2d2 || ',';
			end if;
			valtab2d2 := valtab2d2 || '27,28';
			UPDATE TAB2 SET TAB2D2=valtab2d2 WHERE TAB2COD='A1z06' and TAB2TIP=1;
		end if;

		--Aggiornamento C0CAMPI
	    delete from c0campi where c0c_mne_ber in ('G1AERIBMIN','G1AERIBMAX','G1AEIMPMIN','G1AERIMPAX','G1AEMODVIS','G1AENOTE','G1AEDINVIT','G1AENPROTI','G1ISRILANCI');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AERIBMIN.TORN.GARE','G1AERIBMIN','Scarto minimo ribasso per il rilancio','Scarto min.rib.x ril','F13.5',NULL,NULL,'Scarto min. ribasso di rilancio');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AERIBMAX.TORN.GARE','G1AERIBMAX','Scarto massimo ribasso per il rilancio','Scarto max.rib.x ril','F13.5',NULL,NULL,'Scarto max. ribasso di rilancio');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AEIMPMIN.TORN.GARE','G1AEIMPMIN','Scarto minimo importo per il rilancio','Scarto min.imp.x ril','F15',NULL,'MONEY','Scarto min. importo di rilancio');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AEIMPMAX.TORN.GARE','G1AERIMPAX','Scarto massimo importo per il rilancio','Scarto max.imp.x ril','F15',NULL,'MONEY','Scarto max. importo di rilancio');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AEMODVIS.TORN.GARE','G1AEMODVIS','Criterio di visualizzazione dati asta su portale Appalti','Crit.dati su portale','A100','A1136',NULL,'Criterio visualizzazione classificazione ditte su portale');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AENOTE.TORN.GARE','G1AENOTE','Note sullo svolgimento dell''asta elettronica','Note svolgimen.asta','A2000',NULL,'NOTE','Note sullo svolgimento dell''asta');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AEDINVIT.GARE1.GARE','G1AEDINVIT','Data di invito ditte all''asta elettronica','Data invito asta el.','A10',NULL,'DATA_ELDA','Data invito ditte');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AENPROTI.GARE1.GARE','G1AENPROTI','Numero protocollo lettera di invito ditte all''asta elettr.','N.prot.invito asta','A20',NULL,NULL,'Numero lettera invito');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ISRILANCIO.DITG.GARE','G1ISRILANCI','Offerta della ditta aggiornata con rilancio asta elettr.','Rilancio asta elet.?','A2',NULL,'SN',NULL);

        delete from c0campi where c0c_mne_ber in ('G1IDAEF','G1NGARAAEF','G1DATINIAF','G1ORAINIAF','G1DURMINAF','G1DURMAXAF','G1TBASEAF','G1DOINIAF','G1DOFINEAF','G1NUMFASAF');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.AEFASI.GARE','G1IDAEF','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.AEFASI.GARE','G1NGARAAEF','Codice gara a lotto unico o lotto di gara','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATINI.AEFASI.GARE','G1DATINIAF','Data di apertura della fase','Data apertura fase','A10',NULL,'DATA_ELDA','Data apertura');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ORAINI.AEFASI.GARE','G1ORAINIAF','Ora di apertura della fase','Ora apertura fase','A6',NULL,'ORA','Ora apertura');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DURMIN.AEFASI.GARE','G1DURMINAF','Durata minima della fase, espressa in minuti','Durata minima (mim.)','N5',NULL,NULL,'Durata minima (in minuti)');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DURMAX.AEFASI.GARE','G1DURMAXAF','Durata massima della fase, espressa in minuti','Durata massima(min.)','N5',NULL,NULL,'Durata massima (in minuti)');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TBASE.AEFASI.GARE','G1TBASEAF','Tempo base, espresso in minuti','Tempo base (min.)','N5',NULL,NULL,'Tempo base (in minuti)');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATAORAINI.AEFASI.GARE','G1DOINIAF','Data-ora di apertura della fase','Data-ora apertura','A19',NULL,'TIMESTAMP',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATAORAFINE.AEFASI.GARE','G1DOFINEAF','Data-ora di chiusura della fase','Data-ora chiusura','A19',NULL,'TIMESTAMP',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMFASE.AEFASI.GARE','G1NUMFASAF','Numero d''ordine della fase','Numero d''ordine','N5',NULL,NULL,NULL);

		delete from c0campi where c0c_mne_ber in ('G1IDAER','G1NGARAAER','G1DITTAOAR','G1NUMRILAR','G1NUMFASAR','G1RIBAUOAR','G1IMPOFFAR','G1DORILAR');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.AERILANCI.GARE','G1IDAER','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.AERILANCI.GARE','G1NGARAAER','Codice gara a lotto unico o lotto di gara','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DITTAO.AERILANCI.GARE','G1DITTAOAR','Cod. ditta partecipante alla gara','Codice ditta','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMRIL.AERILANCI.GARE','G1NUMRILAR','Numero progressivo del rilancio della ditta','Numero rilancio','N5',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMFASE.AERILANCI.GARE','G1NUMFASAR','Numero d''ordine della fase in cui Ã¨ stato fatto il rilancio','Numero fase ','N5',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'RIBAUO.AERILANCI.GARE','G1RIBAUOAR','Ribasso offerto dalla ditta','Ribasso offerto','F13.9',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPOFF.AERILANCI.GARE','G1IMPOFFAR','Importo offerto dalla ditta ','Importo offerto','F15',NULL,'MONEY5',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATAORARIL.AERILANCI.GARE','G1DORILAR','Data-ora del rilancio','Data-ora rilancio','A19',NULL,'TIMESTAMP',NULL);

		delete from c0campi where c0c_mne_ber in ('G1IDARP','G1IDRILARP','G1NGARAARP','G1DITTAOAP','G1CONTAFAP','G1PREOFFAP','G1IMPOFFAP');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.AERILPRE.GARE','G1IDARP','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','IDRIL.AERILPRE.GARE','G1IDRILARP','Id rilancio','Id rilancio','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.AERILPRE.GARE','G1NGARAARP','Codice gara a lotto unico o lotto di gara','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DITTAO.AERILPRE.GARE','G1DITTAOAP','Cod. ditta partecipante alla gara','Codice ditta','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CONTAF.AERILPRE.GARE','G1CONTAFAP','Numero progressivo della lavorazione o fornitura','N.progressivo','N4',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PREOFF.AERILPRE.GARE','G1PREOFFAP','Prezzo unitario offerto dalla ditta','Prezzo unit.offerto','F15',NULL,'MONEY5',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPOFF.AERILPRE.GARE','G1IMPOFFAP','Importo totale (quantitÃ  x prezzo unit.)','Importo totale','F15',NULL,'MONEY5',NULL);

		delete from c0campi where c0c_mne_ber in ('G1IDDJ','G1SYSCONDJ','G1CODGARDJ','G1DATAINSDJ','G1DATACREDJ','G1DAPROCDJ','G1ESITODJ');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID_ARCHIVIAZIONE.GARDOC_JOBS.GARE','G1IDDJ','Id','Id','N10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'SYSCON.GARDOC_JOBS.GARE','G1SYSCONDJ','Codice utente che ha richiesto l''archiviazione','Codice utente','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODGARA.GARDOC_JOBS.GARE','G1CODGARDJ','Cod.gara divisa in lotti o cod.fittizio gara a lotto unico','Codice gara interno','A21',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATA_INSERIMENTO.GARDOC_JOBS.GARE','G1DATAINSDJ','Data richiesta archiviazione','Data richiesta','A19',NULL,'TIMESTAMP',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATA_CREAZIONE.GARDOC_JOBS.GARE','G1DATACREDJ','Data completamento archiviazione','Data completamento','A19',NULL,'TIMESTAMP',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DA_PROCESSARE.GARDOC_JOBS.GARE','G1DAPROCDJ','Richiesta archiviazione documenti da processare','Rich.da processare','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ESITO.GARDOC_JOBS.GARE','G1ESITODJ','Esito dell''operazione','Esito','A2000',NULL,'CLOB',NULL);

		delete from c0campi where c0c_mne_ber in ('LOCIMP_VDE','PROIMP_VDE','LOCIMP_VDS','PROIMP_VDS');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'LOCIMP.V_DITTE_ELECAT.GARE','LOCIMP_VDE','Localita'' dell''impresa','Comune','A32',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PROIMP.V_DITTE_ELECAT.GARE','PROIMP_VDE','Provincia dell''impresa','Provincia','A40','Agx15',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'LOCIMP.V_DITTE_ELECSUM.GARE','LOCIMP_VDS','Localita'' dell''impresa','Comune','A32',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PROIMP.V_DITTE_ELESUM.GARE','PROIMP_VDS','Provincia dell''impresa','Provincia','A40','Agx15',NULL,NULL);

        UPDATE C0CAMPI SET C0C_TIP='E', COC_DES='Data pubblicazione', COC_DES_FRM='Data pubblicazione' WHERE  C0C_MNE_BER = 'DATRILDG';
		UPDATE C0CAMPI SET C0C_FS='A500' WHERE  C0C_MNE_BER = 'NOMSSL' or C0C_MNE_BER = 'NUMSSL';
        UPDATE C0CAMPI SET C0C_TIP='C', COC_DES='Livello di progettazione (NON USATO)', COC_DES_FRM='NON USATO', COC_DES_WEB=NULL WHERE  C0C_MNE_BER = 'G1LIVPRO';
        UPDATE C0CAMPI SET C0C_FS='A20' WHERE C0C_MNE_BER in ('NPROTI','NPROTIG','G1NPRDOM','G1NPROFF','G1NPRREQ','NPROTLRGIU','NPROTRZGIU','NPROTDLRCC','NPROTDLCE','G1NCOMSVIPD','G1NPRESDOCD','NPROTLRCC','NPROTLCE');
		
		--Aggiornamento C0ENTIT
		delete from c0entit where c0e_nom in ('AEFASI.GARE','AERILANCI.GARE','AERILPRE.GARE','AERILPRE.GARE#2','GARDOC_JOBS.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('AEFASI.GARE',0,'E','ASTE_FASI','Fasi dell''asta elettronica','NGARA.AEFASI.GARE','GARE.GARE','NGARA.GARE.GARE',NULL,NULL,'g1_aefa0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('AERILANCI.GARE',0,'E','ASTE_RILAN','Rilanci delle ditte durante l''asta elettronica','NGARA.ARILANCI.GARE,DITTAO.AERILANCI.GARE','DITG.GARE','NGARA5.DITG.GARE,DITTAO.DITG.GARE',NULL,NULL,'g1_aeri0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('AERILPRE.GARE',0,'E','ASTE_RILPR','Rilanci prezzi unitari delle ditte durante l''asta elettron.','IDRIL.AERILPRE.GARE','AERILANCI.GARE','ID.AERILANCI.GARE',NULL,NULL,'g1_aerp0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('AERILPRE.GARE#2',0,'C',NULL,'Rilanci prezzi unitari delle ditte durante l''asta elettron.','NGARA.AERILPRE.GARE,CONTAF.AERILPRE.GAREDITTAO.AERILPRE.GARE','DPRE.GARE','NGARA.DPRE.GARE,CONTAF.DPRE.GARE,DITTAO.DPRE.GARE',NULL,NULL,'g1_aerp0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARDOC_JOBS.GARE',0,'E','JOBS_DOCUM','Richieste archiviazione documentazione di gara o elenco','CODGARA.GARDOC_JOBS.GARE','TORN.GARE','CODGAR.TORN.GARE',NULL,NULL,'g1_jdoc0');

		--Aggiornamento profili
		IF (select count(*) = 0 from w_oggetti where tipo='FUNZ' and oggetto='MOD.GARE.TORN-scheda.DOCUMGARA.MOD-DOCUMGARA') THEN
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-scheda.DOCUMGARA.MOD-DOCUMGARA', 'Modifica sezione documento', 5521);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMGARA', 'Modifica sezione documento', 5386);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMGARA', 'Modifica sezione documento', 5611);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-scheda.DOCUMGARA.MOD-ATTI', 'Modifica sezione atti e documenti art.29', 11522);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.GARE-scheda.DOCUMGARA.MOD-ATTI', 'Modifica sezione atti e documenti art.29', 11324);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-ATTI', 'Modifica sezione atti e documenti art.29', 11380);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-scheda.DOCUMGARA.MOD-DOCUMREQ', 'Modifica sezione requisiti dei concorrenti', 5526);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMREQ', 'Modifica sezione requisiti dei concorrenti', 5463);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMREQ', 'Modifica sezione requisiti dei concorrenti', 5641);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-scheda.DOCUMGARA.MOD-DOCUMCONC', 'Modifica sezione documentazione richiesta ai concorrenti', 5555);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMCONC', 'Modifica sezione documentazione richiesta ai concorrenti', 5476);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMCONC', 'Modifica sezione documentazione richiesta ai concorrenti', 5645);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMESITO', 'Modifica sezione documenti esito', 11322);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMESITO', 'Modifica sezione documenti esito', 11348);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMTRASP', 'Modifica sezione documenti per la trasparenza', 11385);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMTRASP', 'Modifica sezione documenti per la trasparenza', 11405);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMINVITI', 'Modifica sezione documenti dell''invito', 11320);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMINVITI', 'Modifica sezione documenti dell''invito', 11345);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.GARE-scheda.FASIRICEZIONE.MOD-DOCUMINVITI', 'Modifica sezione documenti dell''invito', 11465);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-OFFUNICA-scheda.FASIRICEZIONE.MOD-DOCUMINVITI', 'Modifica sezione documenti dell''invito', 11595);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.GARE-scheda.FASIRICEZIONE.MOD-DOCUMCONC', 'Modifica sezione documentazione richiesta ai concorrenti', 11485);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-OFFUNICA-scheda.FASIRICEZIONE.MOD-DOCUMCONC', 'Modifica sezione documentazione richiesta ai concorrenti', 11505);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.GARE-scheda.FASIRICEZIONE.MOD-ATTI', 'Modifica sezione atti e documenti art.29', 11529);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.TORN-OFFUNICA-scheda.FASIRICEZIONE.MOD-ATTI', 'Modifica sezione atti e documenti art.29', 11530);
		END IF;
		if (select count(*) = 0 from w_oggetti where tipo='FUNZ' and oggetto='ALT.GARE.GARE-AGGIUDLOTTI.AnnullaAggDef') then
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.GARE-AGGIUDLOTTI.AnnullaAggDef', 'Annulla aggiudicazione definitiva', 4327);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.GARE-scheda.AGGDEF.AnnullaAggDef', 'Annulla aggiudicazione definitiva', 3032);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.NotificaRinnoviIscrizioneElenco', 'Visualizza notifica richieste rinnovo iscrizione a elenco o catalogo', 12890);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.NotificaVerificaProdottiCatalogo', 'Visualizza notifica prodotti catalogo da verificare', 12900);
		end if;
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-scheda.DATIGEN.ASTA', 'Sezione "Asta elettronica"', 2390);
		Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.TORN-OFFUNICA-scheda.DATIGEN.ASTA', 'Sezione "Asta elettronica"', 3675);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.GARE-scheda.FASIGARA.MOD-FASE6.5', 'Modifica fase di gara "Asta elettronica"', 2662);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-scheda.FASIGARA.INVITO', 'Sezione "Estremi invito"', 12680);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-scheda.FASIGARA.AEFASI', 'Sezione dinamiche "Fasi dell''asta"', 12690);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-scheda.FASIGARA.DOCUMINVITI', 'Sezione dinamiche "documenti dell''invito"', 12700);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'DEL.GARE.GARE-scheda.FASIGARA.DEL-AEFASI', 'elimina fase dell''asta', 12710);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'INS.GARE.GARE-scheda.FASIGARA.INS-AEFASI', 'inserisci fase dell''asta', 12720);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'DEL.GARE.GARE-scheda.FASIGARA.DEL-DOCUMINVITI', 'elimina documento dell''invito', 12730);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'INS.GARE.GARE-scheda.FASIGARA.INS-DOCUMINVITI', 'inserisci documento dell''invito', 12740);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'VIS.GARE.GARE-scheda.FASIGARA.AMMISSIONE', 'Visualizza pagina "Ammissione ditte" dell''Asta elettronica', 12750);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'VIS.GARE.GARE-scheda.FASIGARA.INVITO', 'Visualizza pagina "Invito" dell''Asta elettronica', 12760);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'VIS.GARE.GARE-scheda.FASIGARA.SVOLGIMENTO', 'Visualizza pagina "Svolgimento" dell''Asta elettronica', 12770);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-APERTURAOFFERTEAGGIUDPROV.INVITO', 'Sezione "Estremi invito"', 12780);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-APERTURAOFFERTEAGGIUDPROV.AEFASI', 'Sezione dinamiche "Fasi dell''asta"', 12790);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-APERTURAOFFERTEAGGIUDPROV.DOCUMINVITI', 'Sezione dinamiche "documenti dell''invito"', 12800);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'DEL.GARE.GARE-APERTURAOFFERTEAGGIUDPROV.DEL-AEFASI', 'elimina fase dell''asta', 12810);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'INS.GARE.GARE-APERTURAOFFERTEAGGIUDPROV.INS-AEFASI', 'inserisci fase dell''asta', 12820);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'DEL.GARE.GARE-APERTURAOFFERTEAGGIUDPROV.DEL-DOCUMINVITI', 'elimina documento dell''invito', 12830);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'INS.GARE.GARE-APERTURAOFFERTEAGGIUDPROV.INS-DOCUMINVITI', 'inserisci documento dell''invito', 12840);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'VIS.GARE.GARE-APERTURAOFFERTEAGGIUDPROV.AMMISSIONE', 'Visualizza pagina "Ammissione ditte" dell''Asta elettronica', 12850);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'VIS.GARE.GARE-APERTURAOFFERTEAGGIUDPROV.INVITO', 'Visualizza pagina "Invito" dell''Asta elettronica', 12860);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'VIS.GARE.GARE-APERTURAOFFERTEAGGIUDPROV.SVOLGIMENTO', 'Visualizza pagina "Svolgimento" dell''Asta elettronica', 12870);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.InviaInvitoAstaElettronica', 'Funzione invia invito all''Asta elettronica', 12880);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.ConclusioneAstaElettronica', 'Funzione concludi asta elettronica', 12890);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.ExportDocumenti', 'Funzione esporta documenti su file zip', 10612);
        Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.V_GARE_TORN-trova.CONTR', 'Sezione "Contratto"', 2745);
        
		Update W_OGGETTI set DESCR='Modifica pagina' where TIPO='FUNZ' and OGGETTO='MOD.GARE.TORN-scheda.DOCUMGARA.SCHEDAMOD';
		Update W_OGGETTI set DESCR='Modifica pagina' where TIPO='FUNZ' and OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.SCHEDAMOD';
		Update W_OGGETTI set DESCR='Modifica pagina' where TIPO='FUNZ' and OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.SCHEDAMOD';

		--Reso visibile il campo NPPRESDOC.DITGSTATI
		Delete from W_AZIONI where TIPO='COLS' and AZIONE='VIS' and OGGETTO='GARE.DITGSTATI.NPPRESDOC';

		--Nuova property per funzione export documenti su zip
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','it.eldasoft.sil.pg.pathArchivioDocumentiGara',NULL,'Export documenti di gara o elenco','Percorso della cartella contenente il file zip. ATTENZIONE: LA \\ INIZIALE VA RADDOPPIATA NELLA STRINGA IN QUANTO "\" E'' UN CARATTERE SPECIALE',NULL);
		--Modificato descrizione
		UPDATE W_CONFIG SET DESCRIZIONE='URL pubblica del Portale Appalti per la pubblicazione dei file xml (es.: http://localhost:8080/PortaleAppalti/resources/appaltiavcp)' where CODAPP='PG' AND CHIAVE='it.eldasoft.sil.pg.avcp.urlPortaleAlice';

		--Schedulazione per funzione export documenti su zip
		INSERT INTO w_quartz(codapp, bean_id, cron_expression, cron_seconds, cron_minutes, cron_hours, cron_day_of_month, cron_month, cron_day_of_week, cron_year, descrizione)
			VALUES ('PG','creazioneArchivioDocumentiGaraManagerTrigger', '0 3/5 * * * ?', '0', '3/5', '*',  '*',  '*', '?', '', 'Schedulazione procedura export documenti di gara o elenco');		

			--Modello comunicazione invito all'asta elettronica
		IF (select count(*) = 0 from w_confcom where genere=55) THEN
			maxnum := 0;
			SELECT MAX(numpro) into maxnum FROM w_confcom;
			INSERT INTO W_CONFCOM (NUMPRO,GENERE,MODTIT,MODDESC,NUMORD,COMINTEST,COMMSGOGG,COMMSGTES,FILTROSOG,CRITTES) VALUES (maxnum + 1,55,'Comunicazione invito all''asta elettronica','Comunicazione invito all''asta elettronica',1,'1','Invito all''asta elettronica','con la presente si comunica l''invito a partecipare all''asta elettronica per la procedura e secondo le modalitÃ  di cui alla documentazione allegata.

			Cordiali saluti.

			SI PREGA DI NON RISPONDERE ALLA PRESENTE MAIL IN QUANTO E'' GENERATA DA UN SISTEMA AUTOMATICO',NULL,0);
   		END IF;
		INSERT INTO tab1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('W_004', 55, 'Funzione ''Invio invito asta elettronica''', NULL, 0);
		UPDATE w_confcom set modtit='Comunicazione invito a presentare offerta', moddesc='Comunicazione invito a presentare offerta' WHERE genere=53 and modtit='Comunicazione invito alla gara (Mercato elettronico)';
		UPDATE tab1 SET tab1desc='Funzione ''Invio invito a presentare offerta''' WHERE tab1cod='W_004' and tab1tip=53;

		-- (S.Santi 29.11.2016) Ridefinita la view, al fine di ottimizzare le prestazioni, con l'utilizzo di CTE
		perform sp_backupanddropviews('v_gare_torn');
		create or replace view v_gare_torn as 
		with
		--n.lotti di ogni gara
		lotti
		as (
		select codgar1, count(*) numlotti from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati senza esito negativo
		lottiagg
		as (
		select codgar1, count(*) numlottiagg from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null and esineg is null
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati o con esito negativo
		lotticonc
		as (
		select codgar1, count(*) numlotticonc from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null or esineg is not null
		group by codgar1
		)
		select codgar, codgar as codice, tipgen, destor as oggetto, imptor as importo, tipgar, 
			cast('1' as varchar(1)) as islotti, (case when gare.genere=3 then 3 else 1 end) as genere, isarchi,
			case when (lotti.numlotti>0 and lotti.numlotti=lottiagg.numlottiagg) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu,
			case when (lotti.numlotti>0 and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as islotticonclusi,
			(case when gare.genere=3 then gare.esineg else torn.esineg end) as esineg, profiloweb, gartel
		from torn 
			left outer join gare on (codgar=gare.ngara and gare.genere=3) 
			left outer join lotti on (lotti.codgar1=torn.codgar)
			left outer join lottiagg on (lottiagg.codgar1=torn.codgar)
			left outer join lotticonc on (lotticonc.codgar1=torn.codgar)
			where codgar not like '$%' 
		union
		select torn.codgar, gare.ngara as codice, torn.tipgen, gare.not_gar as oggetto, gare.impapp as importo, gare.tipgarg,
			cast('2' as varchar(1)) as islotti, 2 as genere, torn.isarchi, 
			case when (gare.ditta is not null and gare.esineg is null) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu, null as islotticonclusi,
			gare.esineg, torn.profiloweb, torn.gartel
			from gare,torn 
			where torn.codgar=gare.codgar1 and torn.codgar like '$%' and (gare.genere is null or (gare.genere not in (4,10,11,20)));
		perform sp_restoreviews('v_gare_torn');

		perform sp_backupanddropviews('v_dati_lotti_completa');
		IF exists (select tablename from pg_tables where upper(tablename) = 'APPA') THEN
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
				   torn.dteoff
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20)))
		   union
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
				  torn.dteoff
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.codimp=gare.ditta and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
		   union
			 select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 where gare.genere=4';
		else
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20)))
		  union
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.codimp=gare.ditta and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
		   union
			select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 where gare.genere=4';
		end if;
		perform sp_restoreviews('v_dati_lotti_completa');

		-- (S.Santi 10.01.2017) Aggiunto campi relativi a localitÃ  ditta (LOCIMP, PROIMP.IMPR)
 		perform sp_backupanddropviews('v_ditte_elesum');
		create or replace view v_ditte_elesum (gara, codice, ragsoc, locimp, proimp, numord, numinv, numpen, numalt, numir, numip) as 
			(select gare.ngara, ditg.dittao, ditg.nomimo, impr.locimp, impr.proimp, ditg.numordpl,
						 sum(case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end), 
						 sum(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end),
						 sum(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end),
						 sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
							(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) + 
							(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)),
						 sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
							(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end))
			from ditg, impr, iscrizcat, gare 
			where  ditg.codgar5=gare.codgar1 and ditg.ngara5=gare.ngara 
			  and ditg.dittao=impr.codimp
			  and ditg.codgar5=iscrizcat.codgar and ditg.ngara5=iscrizcat.ngara and ditg.dittao=iscrizcat.codimp 
			  and gare.genere in (10,20)
			  and ditg.abilitaz=1 and (ditg.dabilitaz is not null) and ditg.numordpl is not null
			  group by gare.ngara, ditg.dittao, ditg.nomimo, impr.locimp, impr.proimp, ditg.numordpl);
		perform sp_restoreviews('v_ditte_elesum');

		-- (S.Santi 10.01.2017) Aggiunto campi relativi a localitÃ  ditta (LOCIMP, PROIMP.IMPR) e ottimizzato view
		perform sp_backupanddropviews('v_ditte_elecat');
		create or replace view v_ditte_elecat (gara, codice, ragsoc, locimp, proimp, numord, numinv, numpen, numalt, numir, numip, 
					codcat, infnumclass, supnumclass,
					numclass, numinvcla, numpencla, numaltcla, numircla, numipcla,
					numinvtot, numpentot, numalttot, numirtot, numiptot) as
			with totali as 
		  (select iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp, 
				 sum(case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) numinv, 
				 sum(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) numpen,
				 sum(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt,
				 sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
					(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) + 
					(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numir,
				 sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
					(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numip
			from iscrizcat
			group by codgar, ngara, codimp)
		  select gare.ngara, ditg.dittao, ditg.nomimo, impr.locimp, impr.proimp, ditg.numordpl,
				  (case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end),
				  (case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end), 
				  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end), 
				  (case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
				  (case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) + 
				  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end),
				  (case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
				  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end),
				  iscrizcat.codcat, iscrizcat.infnumclass, iscrizcat.supnumclass,
				  iscrizclassi.numclass,
				  (case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end),
				  (case when (iscrizclassi.invpen is null) then 0 else iscrizclassi.invpen end), 
				  (case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end), 
				  (case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end) + 
				  (case when (iscrizclassi.invpen is null) then 0 else iscrizclassi.invpen end) +
				  (case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end),
				  (case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end) + 
				  (case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end),
				  totali.numinv, totali.numpen, totali.numalt,
				  totali.numir, totali.numip
			from ditg inner join gare on (ditg.codgar5=gare.codgar1 and ditg.ngara5=gare.ngara)
				inner join impr on (ditg.dittao=impr.codimp)
				inner join iscrizcat on (ditg.codgar5=iscrizcat.codgar and ditg.ngara5=iscrizcat.ngara and ditg.dittao=iscrizcat.codimp)
				inner join totali on (ditg.codgar5=totali.codgar and ditg.ngara5=totali.ngara and ditg.dittao=totali.codimp)
				left outer join iscrizclassi on (iscrizcat.codgar=iscrizclassi.codgar and iscrizcat.ngara=iscrizclassi.ngara 
					and iscrizcat.codimp=iscrizclassi.codimp and iscrizcat.codcat=iscrizclassi.codcat and iscrizcat.tipcat=iscrizclassi.tipcat)
			where gare.codgar1 like '$%' and gare.genere in (10,20) 
			   and ditg.abilitaz=1 and (ditg.dabilitaz is not null) and ditg.numordpl is not null;
		perform sp_restoreviews('v_ditte_elecat');

		update eldaver set numver = '6.16.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.0', datvet = now() where codapp = 'G1';

		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilit&agrave;-> Manuali'),null,50,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0' 
		and exists(select w_accpro.cod_profilo 
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo 
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
	DECLARE maxtip INT;
	DECLARE conta INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.0' or numver like '6.16.0%')) THEN

		--Definizione nuovi campi
		ALTER TABLE GARDOC_JOBS ADD TIPO_ARCHIVIAZIONE NUMERIC(10);
		ALTER TABLE GARDOC_JOBS ADD TIPO_WSDM VARCHAR(100);
		ALTER TABLE GARDOC_JOBS ADD CLASSIFICA VARCHAR(100);
		ALTER TABLE GARDOC_JOBS ADD CLASSIFICA_TIT VARCHAR(100);
		ALTER TABLE GARDOC_JOBS ADD COD_REG VARCHAR(100);
		ALTER TABLE GARDOC_JOBS ADD TIPO_DOC VARCHAR(100);
		ALTER TABLE GARDOC_JOBS ADD MITT_INT VARCHAR(100);
		ALTER TABLE GARDOC_JOBS ADD INDICE VARCHAR(100);
		ALTER TABLE GARDOC_JOBS ADD UO_MITTDEST VARCHAR(100);
		ALTER TABLE TORN ADD DULTAGG TIMESTAMP;
		ALTER TABLE TORN ADD ALTNEG VARCHAR(2000);
        ALTER TABLE ANTICOR ADD DATAPPR TIMESTAMP;

		update GARDOC_JOBS set TIPO_ARCHIVIAZIONE = 1;

		CREATE TABLE GARDOC_WSDM (
			ID NUMERIC(10) NOT NULL,
			ID_ARCHIVIAZIONE NUMERIC(10) NOT NULL,
			ENTITA VARCHAR(30),
			KEY1 VARCHAR(30),
			KEY2 VARCHAR(30),
			KEY3 VARCHAR(30),
			KEY4 VARCHAR(30),
			PROVENIENZA VARCHAR(2),
			GENERE NUMERIC(2),
			STATO_ARCHIVIAZIONE NUMERIC(10),
			ESITO VARCHAR(2000),
			primary key (ID));
        ALTER TABLE GARDOC_WSDM ADD CONSTRAINT FK_GARDOC_WSDM_JOBS FOREIGN KEY ( ID_ARCHIVIAZIONE ) REFERENCES GARDOC_JOBS( ID_ARCHIVIAZIONE ) ON DELETE CASCADE;
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('GARDOC_WSDM',0);
		
		---------------------------------------------
		-- Creazione TRIGGER ------------------------
		---------------------------------------------
		-- Cancellazione delle occorrenze di gardoc_wsdm relazionate ai
		-- documenti associati
		DROP TRIGGER IF EXISTS tr_gardoc_wsdm_before_del ON C0OGGASS CASCADE;

		CREATE OR REPLACE FUNCTION delete_gardoc_wsdm() 
			RETURNS trigger AS 
		$tr_gardoc_wsdm_before_del$
		BEGIN
			DELETE FROM gardoc_wsdm WHERE provenienza = '4' and key1 = OLD.c0aprg AND key2 = OLD.c0acod;
			RETURN OLD;
		END
		$tr_gardoc_wsdm_before_del$ LANGUAGE plpgsql;

		CREATE TRIGGER tr_gardoc_wsdm_before_del
			AFTER DELETE ON C0OGGASS
			FOR EACH ROW EXECUTE PROCEDURE delete_gardoc_wsdm();

		
		--Nuova entitÃ  GARACQUISIZ - aggiornamento presente in patch 6.16.0.a
		IF not exists (SELECT * FROM pg_tables WHERE tablename='garacquisiz') THEN
			CREATE TABLE GARACQUISIZ (
				ID NUMERIC(12) NOT NULL,
				NGARA VARCHAR(20),
				CODIMP VARCHAR(10),
				IDPRG VARCHAR(2)  NOT NULL,
				IDCOM NUMERIC(12)  NOT NULL,
				STATO NUMERIC(7),
				DATAORACQ TIMESTAMP,
				SYSCON NUMERIC(12),
				LOGMSG TEXT,
				primary key (ID));
			ALTER TABLE GARACQUISIZ ADD CONSTRAINT FK_GARACQUISIZ_W_INVCOM FOREIGN KEY ( IDPRG, IDCOM) REFERENCES W_INVCOM(IDPRG, IDCOM) ON DELETE CASCADE;
			INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('GARACQUISIZ',0);
			Insert into W_OGGETTI(TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'ALT.GARE.AcquisiciAggiornamentoCategorie', 'Funzione Acquisisci modifiche categorie iscrizione elenco/catalogo da portale posticipata', 5880);
		end if;
		
		--Nuova colonna ULTINF - aggiornamento presente in patch 6.16.0.b
		IF not exists (SELECT column_name FROM information_schema.columns WHERE table_name='iscrizcat' and column_name='ultinf') THEN
			ALTER TABLE ISCRIZCAT ADD ULTINF TEXT;
			INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.ISCRIZCAT-scheda','Scheda popup ulteriori dati categorie d''iscrizione in elenco',6165);
			INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.ISCRIZCAT-scheda.SCHEDAMOD','Modifica',12955);
		end if;

		-- (S.Santi 13.03.2017) Estensione campo 'N.protocollo'
		ALTER TABLE GARECONT ALTER COLUMN NPROAT TYPE VARCHAR(20);

		-- (S.Santi 22.02.2017) Inizializzazione nuovo campo 'Data ultimo aggiornamento'
		UPDATE anticor SET datappr=dataagg WHERE dataagg is not null and datappr is null;
		-- Considera la data pubblicazione esito per le gare a lotto unico o a lotti con plico unico
		UPDATE torn SET dultagg=(select dinpubg from pubg where tippubg=12 and (pubg.ngara=torn.codgar or pubg.ngara=substr(torn.codgar,2))) 
			WHERE dultagg is null;
		-- Considera la data pubblicazione esito massima tra tutti i lotti per le gare con plichi distinti
		UPDATE torn SET dultagg=(select max(dinpubg) from pubg,gare where pubg.ngara=gare.ngara and gare.codgar1=torn.codgar and (gare.genere<>3 or gare.genere is null) and substr(gare.codgar1,2)<>'$' and tippubg=12)
			WHERE dultagg is null;
		-- Considera la data pubblicazione bando
		UPDATE torn SET dultagg=(select max(datpub) from pubbli where (tippub=11 or tippub=13) and (pubbli.codgar9=torn.codgar))
			WHERE dultagg is null;
			
		-- (S.Santi 23.01.2017) Blocco modifica singola voce tabellato - se non c'Ã¨, la inserisce spostando in coda quella in posizione 1
		if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='A1087' and TAB1TIP=1 and (TAB1DESC is null or TAB1DESC!='Sorteggio')) = 1) then
			maxtip := 0;
			SELECT MAX(TAB1TIP) INTO maxtip FROM TAB1 WHERE TAB1COD='A1087';
			conta := maxtip + 1;
			UPDATE TAB1 SET TAB1TIP=conta WHERE TAB1COD='A1087' and TAB1TIP=1;
			UPDATE TORN SET SELPAR=conta WHERE SELPAR=1;
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A1087', 1, 'Sorteggio', '1', 0);
		end if;
		UPDATE TAB1 set tab1mod='1' where tab1cod='A1087' and tab1tip=1;

		--Aggiornamento tabellati - verifica l'esistenza perchÃ¨ giÃ  introdotti in patch 6.16.0.a
		if (select count(*) = 0 from tab1 where tab1cod = 'A1139' and tab1tip=1) then
			insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1139', 1, 'Da processare', NULL);
			insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1139', 2, 'Processata correttamente', NULL);
			insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1139', 3, 'Processata con errori', NULL);
			insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1139', 4, 'Rifiutata', NULL);
		end if;

		IF (select count(*) = 0 from tab1 where tab1cod = 'A2044' and tab1tip=27) THEN
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 27, 'Procedura negoziata con previa indizione di gara', '1', 26);
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 28, 'Procedura negoziata con previa indagine di mercato', '1', 10);
		END IF;

 		--Adeguamento normativo tab. 'Motivo ricorso procedura negoziata'
		update tab1 set tab1desc='Settori speciali: servizi a seguito di concorso progettazione (art.221, c.1, lett.l D.Lgs. 163/2006)' where tab1cod='A1040' and tab1tip=21;
		update tab1 set tab1desc='Settori speciali: forniture da occasioni vantaggiose (art.221, c.1, lett.j DLgs 163/2006)' where tab1cod='A1040' and tab1tip=23;
		update tab1 set tab1desc='Settori speciali: forniture da liquidazione fallimentare (art.221, c.1, lett.k DLgs 163/2006)' where tab1cod='A1040' and tab1tip=24;
		update tab1 set tab1arc='1' where tab1cod='A1040' and tab1tip <= 100 and tab1tip not in (29,30);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',25,'Altro',NULL,32,NULL);
        INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',101,'Gara deserta (art.63, c.2, lett.a DLgs 50/2016)',NULL,1,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',102,'Operatore unico (art.63, c.2, lett.b DLgs 50/2016)',NULL,2,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',103,'Urgenza (art.63, c.2, lett.c DLgs 50/2016)',NULL,3,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',104,'Forniture a scopo sperimentale (art.63, c.3, lett.a DLgs 50/2016)',NULL,4,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',105,'Forniture complementari (art.63, c.3, lett.b DLgs 50/2016)',NULL,5,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',106,'Forniture quotate in borsa materie prime (art.63, c.3, lett.c DLgs 50/2016)',NULL,6,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',107,'Forniture da liquidazione fallimentare (art.63, c.3, lett.d DLgs 50/2016)',NULL,7,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',108,'Servizi a seguito di concorso progettazione (art.63, c.4 DLgs 50/2016)',NULL,8,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',111,'Ripetizione di servizi giÃ  affidati (art.63, c.5 DLgs 50/2016)',NULL,11,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',112,'Settori speciali: gara deserta (art.125, c.1, lett.a DLgs 50/2016)',NULL,18,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',113,'Settori speciali: appalto a scopo di ricerca o sperimentazione (art.125, c.1, lett.b DLgs 50/2016)',NULL,19,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',114,'Settori speciali: operatore unico (art.125, c.1, lett.c DLgs 50/2016)',NULL,20,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',115,'Settori speciali: urgenza (art.125, c.1, lett.d DLgs 50/2016)',NULL,21,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',116,'Settori speciali: forniture complementari (art.125, c.1, lett.e DLgs 50/2016)',NULL,22,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',118,'Settori speciali: ripetizione di lavori o servizi giÃ  affidati (art.125, c.1, lett.f DLgs 50/2016)',NULL,24,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',119,'Settori speciali: forniture quotate in borsa materie prime (art.125, c.1, lett.g DLgs 50/2016)',NULL,25,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',120,'Settori speciali: adesione ad accordo quadro (art.54, c.6 DLgs 50/2016)',NULL,26,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',121,'Settori speciali: servizi a seguito di concorso progettazione (art.125, c.1, lett.h.2 DLgs. 50/2016)',NULL,29,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',124,'Settori speciali: forniture da liquidazione fallimentare (art.125, c.1, lett.h.1 DLgs 50/2016)',NULL,27,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',127,'Opere di urbanizzazione secondaria (art.36, c.3 DLgs 50/2016)',NULL,13,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',128,'Prog. a seguito di concorso progettazione o concorso idee (art.154,c.4,5 e art.156,c.7 DLgs 50/2016)',NULL,14,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',131,'Lavori di importo inferiore a 1 milione di euro (art.36, c.2, lett.b,c DLgs 50/2016)',NULL,12,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',132,'Incarichi di progettazione (art.157, c.2, DLgs 50/2016)',NULL,14.5,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',200,'Settori speciali: appalti sotto soglia con regolamento specifico (art.36, c.8 DLgs 50/2016)',NULL,30,NULL);

		--Aggiornamento C0CAMPI
        delete from c0campi where c0c_mne_ber in ('G1IDGARACQ','G1NGARAACQ','G1CODIMPACQ','G1IDPRGACQ','G1IDCOMACQ','G1STATOACQ','G1DATACQ','G1SYSCONACQ','G1LOGMSGACQ');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.GARACQUISIZ.GARE','G1IDGARACQ','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.GARACQUISIZ.GARE','G1NGARAACQ','Codice elenco operatori economici','Codice elenco','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODIMP.GARACQUISIZ.GARE','G1CODIMPACQ','Codice ditta iscritta all''elenco operatori economici','Codice ditta','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IDPRG.GARACQUISIZ.GARE','G1IDPRGACQ','Codice applicativo','Codice applicativo','A2',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IDCOM.GARACQUISIZ.GARE','G1IDCOMACQ','ID comunicazione (progressivo)','Codice comunicazione','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'STATO.GARACQUISIZ.GARE','G1STATOACQ','Stato dell''elaborazione','Stato elaborazione','A100','A1139',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATAORACQ.GARACQUISIZ.GARE','G1DATACQ','Data-ora di elaborazione','Data-ora elaboraz.','A19',NULL,NULL,'TIMESTAMP');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'SYSCON.GARACQUISIZ.GARE','G1SYSCONACQ','Codice utente usrsys','Codice utente','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'LOGMSG.GARACQUISIZ.GARE','G1LOGMSGACQ','Descrizione delle modifiche','Dettaglio modifiche','A2000',NULL,NULL,'CLOB');
		
        delete from c0campi where c0c_mne_ber in ('G1TIPOARCHDJ','G1CLASSDJ','G1CLASSTITDJ','G1CODREGDJ','G1TIPODOCDJ','G1MITTINTDJ','G1INDICEDJ','G1UOMITTDJ');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TIPO_ARCHIVIAZIONE.GARDOC_JOBS.GARE','G1TIPOARCHDJ','Tipo di archiviazione (1 zip, 2 documentale)','Tipo archiviazione','N10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CLASSIFICA.GARDOC_JOBS.GARE','G1CLASSDJ','Classifica','Classifica','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CLASSIFICA_TIT.GARDOC_JOBS.GARE','G1CLASSTITDJ','Classifica\Titolazione','Classifica\Titol','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'COD_REG.GARDOC_JOBS.GARE','G1CODREGDJ','Codice registro','Codice registro','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TIPO_DOC.GARDOC_JOBS.GARE','G1TIPODOCDJ','Tipo documento','Tipo documento','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'MITT_INT.GARDOC_JOBS.GARE','G1MITTINTDJ','Mittente interno','Mittente interno','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'INDICE.GARDOC_JOBS.GARE','G1INDICEDJ','Indice','Indice','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'UO_MITTDEST.GARDOC_JOBS.GARE','G1UOMITTDJ','Unita organizzativa mittente','U.O. mittente','A100',NULL,NULL,NULL);

        delete from c0campi where c0c_mne_ber in ('G1IDWSDM','G1IDDJWSDM','G1ENTWSDM','G1KEY1WSDM','G1KEY2WSDM','G1KEY3WSDM','G1KEY4WSDM','G1GENEREWSDM','G1PROVWSDM','G1STATOARCHWSDM','G1ESITOWSDM');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.GARDOC_WSDM.GARE','G1IDWSDM','Id','Id','N10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ID_ARCHIVIAZIONE.GARDOC_WSDM.GARE','G1IDDJWSDM','Id richiesta','Id richiesta','N10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ENTITA.GARDOC_WSDM.GARE','G1ENTWSDM','Entita','Entita','A30',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'KEY1.GARDOC_WSDM.GARE','G1KEY1WSDM','Key1','Key1','A30',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'KEY2.GARDOC_WSDM.GARE','G1KEY2WSDM','Key2','Key2','A30',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'KEY3.GARDOC_WSDM.GARE','G1KEY3WSDM','Key3','Key3','A30',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'KEY4.GARDOC_WSDM.GARE','G1KEY4WSDM','Key4','Key4','A30',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'GENERE.GARDOC_WSDM.GARE','G1GENEREWSDM','Genere della gara','Genere della gara','N2',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PROVENIENZA.GARDOC_WSDM.GARE','G1PROVWSDM','Provenienza della documentazione all''interno della gara','Provenienza','A2',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'STATO_ARCHIVIAZIONE.GARDOC_WSDM.GARE','G1STATOARCHWSDM','Stato archiviazione','Stato archiviazione','N10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ESITO.GARDOC_WSDM.GARE','G1ESITOWSDM','Esito dell''operazione','Esito','A2000',NULL,'CLOB',NULL);
		
        delete from c0campi where c0c_mne_ber in ('G1ULTINF','G1ISARCHIACCQ','G1DULTAGG','DATAPPANTICOR','G1ALTNEG');
        INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ULTINF.ISCRIZCAT.GARE','G1ULTINF','Ulteriori informazioni','Ulteriori informaz.','A2000',NULL,'CLOB',NULL);
        INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ISARCHI.V_GARE_ACCORDIQUADRO.GARE','G1ISARCHIACCQ','Gara archiviata ?','Gara archiviata?','A2',NULL,'SN',NULL);
        INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DULTAGG.TORN.GARE','G1DULTAGG','Data ultimo aggiornamento contenuto su portale','Data ult.agg.portale','A10',NULL,'DATA_ELDA',NULL);
        INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATAPPR.ANTICOR.GARE','DATAPPANTICOR','Data ultima approvazione dei dati','Data approvazione','A10',NULL,'DATA_ELDA',NULL);
        INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ALTNEG.TORN.GARE','G1ALTNEG','Dettaglio altre motivazioni ricorso a proc.negoz.senza bando','Dett.motivo proc.neg','A2000',NULL,'NOTE','Dettaglio altre motivazioni');

		UPDATE C0CAMPI SET COC_DES_WEB='Num.minimo operatori economici' WHERE  C0C_MNE_BER = 'NUMMINOE';
        UPDATE C0CAMPI SET C0C_TIP='E' WHERE  C0C_MNE_BER in ('G1MOTIES','G1ANNOFF');
		UPDATE C0CAMPI SET C0C_TIP='E' WHERE  C0C_MNE_BER in ('CODTAB_C','G1TIPCLA','TIPLAV_C','TIPGAR_C','LIMINF_C','LIMSUP_C');
		UPDATE C0CAMPI SET C0C_TIP='E' WHERE  C0C_MNE_BER in ('CODTAB_P','CODPUB_P','TIPPUB_P');
        UPDATE C0CAMPI SET C0C_TIP='E' WHERE  C0C_MNE_BER in ('CODTAB_S','TIPLAV_S','LIMINF_S','LIMSUP_S','G1CALCOLO','G1TIPGARS','G1PROURGS','G1TERRIDS','G1DOCWEBS','G1NUMGIO');
		UPDATE C0CAMPI SET COC_DES='Limite inferiore di importo',COC_DES_FRM='Limite imp.inferiore',COC_DES_WEB='Da importo' where C0C_MNE_BER='LIMINF_C';
		UPDATE C0CAMPI SET COC_DES='Limite superiore di importo',COC_DES_FRM='Limite imp.superiore',COC_DES_WEB='A importo' where C0C_MNE_BER='LIMSUP_C';
		UPDATE C0CAMPI SET COC_DES='Bando trasmesso per via elettronica ? (NON USATO)',COC_DES_FRM='NON USATO' where C0C_MNE_BER='G1BANWEBS';
		UPDATE C0CAMPI SET COC_DES='Oggetto del contratto per la gara per lavori (NON USATO)',COC_DES_FRM='NON USATO' where C0C_MNE_BER='G1OGGCONTS';
		UPDATE C0CAMPI SET COC_MNE_UNI='LOCIMP.V_DITTE_ELESUM.GARE' WHERE C0C_MNE_BER='LOCIMP_VDS';
		UPDATE C0CAMPI SET COC_DES='Data prima generazione XML',COC_DES_FRM='Data generazione XML',COC_DES_WEB='Data prima generazione XML' where C0C_MNE_BER='DATPUBANTICOR';
		UPDATE C0CAMPI SET COC_DES='Data ultimo aggiornamento XML',COC_DES_FRM='Data ultimo agg. XML',COC_DES_WEB='Data ultimo aggiornamento XML' where C0C_MNE_BER='DATAGGANTICOR';
		UPDATE C0CAMPI SET C0C_FS='A20' where C0C_MNE_BER='G1NPROAT';

		--Aggiornamento C0ENTIT
		delete from c0entit where c0e_nom in ('GARACQUISIZ.GARE','GARDOC_WSDM.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARACQUISIZ.GARE',0,'E','PORT_ACQUI','Acquisizioni da portale con elaborazione posticipata','NGARA.GARACQUISIZ.GARE,CODIMP.GARACQUISIZ.GARE','DITG.GARE','NGARA5.DITG.GARE,DITTAO.DITG.GARE',NULL,NULL,'g1_pacq0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARDOC_WSDM.GARE',0,'E','WSDM_DOCUM','Documenti da archiviare per singola	richiesta','ID_ARCHIVIAZIONE.GARDOC_WSDM.GARE','GARDOC_JOBS.GARE','ID_ARCHIVIAZIONE.GARDOC_JOBS.GARE',NULL,NULL,'g1_gdwsdm0');
		
		UPDATE C0ENTIT SET C0E_TIP='E', COE_ARG='CONF_ESCLU' WHERE C0E_NOM='DETMOT.GARE';
		UPDATE C0ENTIT SET C0E_TIP='E', COE_ARG='CONF_PUBBL', C0E_DES='Categorie per pubblicazioni predefinite bando e esito gara' WHERE C0E_NOM='CATPUB.GARE';
		UPDATE C0ENTIT SET C0E_TIP='E', COE_ARG='CONF_PUBB1', C0E_DES='Pubblicazioni predefinite bando e esito di gara per categ.' WHERE C0E_NOM='TABPUB.GARE';
		UPDATE C0ENTIT SET C0E_TIP='E', COE_ARG='CONF_SCAD', C0E_DES='Configurazione scadenze di gara' WHERE C0E_NOM='CATSCA.GARE';

		--Corretto descrizione property
		update W_CONFIG set descrizione='ModalitÃ  di gestione dei documenti associati: su filesystem(0)[default] o in database(1)' where CODAPP='PG' and CHIAVE='it.eldasoft.documentiAssociatiDB';

        --Aggiornamento profili
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.CONFOPECO-lista','Lista Configurazione selezione da elenco operatori',12910);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.CONFOPECO-scheda','Scheda Dettaglio configurazione selezione da elenco operatori',12920);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.CONFOPECO-lista.DEL','Elimina',12930);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.CONFOPECO-lista.LISTADELSEL','Elimina selezionati',12940);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.CONFOPECO-lista.LISTANUOVO','Nuovo',12950);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.CONFOPECO-lista.MOD','Modifica',12960);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.CONFOPECO-scheda.SCHEDANUOVO','Nuovo',12970);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.CONFOPECO-scheda.SCHEDAMOD','Modifica',12980);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SUBMENU','AMMINISTRAZIONE.Configurazione-CONFOPECO','Configurazione selezione da elenco operatori',12990);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.DETMOT-lista','Lista configurazione dettaglio motivo esclusione ditte in gara',13020);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.DETMOT-scheda','Scheda configurazione dettaglio motivo esclusione ditte in gara',13030);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.DETMOT-lista.MOD','Modifica',13040);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.DETMOT-scheda.SCHEDAMOD','Modifica',13050);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SUBMENU','AMMINISTRAZIONE.Configurazione-DETMOT','Configurazione Dettagli motivo esclusione ditte in gara',13060);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.TrasferisciAlDocumentale', 'Funzione trasferimento documenti al documentale', 13070);


        UPDATE W_OGGETTI SET DESCR='Lista popup categorie d''iscrizione in elenco' WHERE TIPO='MASC' AND OGGETTO='GARE.ISCRIZCAT-lista';
		
		perform sp_backupanddropviews('v_dati_lotti_completa');
		IF exists (select tablename from pg_tables where upper(tablename) = 'APPA') THEN
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
				   torn.dteoff
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20)))
		   union
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
				  torn.dteoff
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
		   union
			 select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 where gare.genere=4';
		else
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20)))
		  union
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
		   union
			select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 where gare.genere=4';
		end if;
		perform sp_restoreviews('v_dati_lotti_completa');

		perform sp_backupanddropviews('v_ditgammis');
		-- (S.Santi 09.02.2017) Esteso controllo su PARTGAR per le fasi -4 e 2
		create or replace view v_ditgammis as
			SELECT CODGAR, NGARA, g1.DITTAO, TAB1TIP as FASGAR, TAB1DESC,
				case when (ditg.partgar='2' and ditg.fasgar in (-4,2,5,6) and tab1tip >=ditg.fasgar) then null else g1.ammgar end AMMGAR,
				MOTIVESCL, DETMOTESCL 
				FROM DITGAMMIS g1, (SELECT * FROM TAB1 WHERE tab1cod='A1011') FASI,DITG
				WHERE g1.fasgar =(SELECT MAX(fasgar) FROM DITGAMMIS g2 WHERE g2.fasgar<=TAB1TIP AND g1.codgar=g2.codgar AND g1.ngara=g2.ngara AND g1.dittao=g2.dittao)
				and ditg.ngara5=g1.ngara and ditg.dittao=g1.dittao
			union 
				SELECT codgar5,ngara5,dittao,tab1tip as FASGAR,TAB1DESC,null,null,null 
				FROM ditg, (SELECT * FROM TAB1 WHERE tab1cod='A1011') FASI
				WHERE (tab1tip < (select min(fasgar) from ditgammis where ditgammis.ngara=ditg.ngara5 and ditgammis.dittao=ditg.dittao) 
				 or not exists (select ngara from ditgammis where ditgammis.ngara=ditg.ngara5 and ditgammis.dittao=ditg.dittao));
		perform sp_restoreviews('v_ditgammis');

		perform sp_backupanddropviews('v_gare_dittefasi');
		-- (S.Santi 09.02.2017) Aggiunto visualizzazione dettaglio lotti sulle fasi -4 e 2 per le gare con plico unico 
		create or replace view v_gare_dittefasi as
			with ditte as (select tab1tip num_fase,tab1desc desc_fase,codgar5 codgar,ngara5 ngara,dittao,nomimo, nprogg,numordpl,
					 (case when tab1tip in (3,4) then estimp else null end) sorteggio,
					 (case when tab1tip in (-4,2,5,6) then partgar else null end) partecipa,
					  fasgar fase_esclu 
					  from tab1,ditg where tab1cod='A1011'
					  and ((tab1tip <1 and (acquisizione is null or acquisizione <>5)) or (tab1tip>=1 and rtofferta is null)))
			select ditte.*,ammgar ammissione,motivescl,detmotescl
			  from gare, v_gare_genere, torn, gare1,
					 ditte, v_ditgammis 
			  where ditte.ngara=gare.ngara
				 and ditte.ngara=v_gare_genere.codice and v_gare_genere.genere not in (10,11,20,4)
				 and gare.codgar1=torn.codgar
				 and gare.ngara=gare1.ngara
				 and ditte.ngara=v_ditgammis.ngara and ditte.dittao=v_ditgammis.dittao and ditte.num_fase=v_ditgammis.fasgar
				 and ((torn.iterga=1 and num_fase>=1) or (torn.iterga in (3,5,6) and num_fase>=-3) or (torn.iterga in (2,4)))
				 and (((torn.compreq='2' or torn.compreq is null) and num_fase<>3 and num_fase<>4) or torn.compreq='1')
				 and (
					   (
					   ((v_gare_genere.genere <>3 and (((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5) or (modlicg=6 or gare1.valtec='1') or (modlicg is null and num_fase=1)))
							 or (
							 (v_gare_genere.genere=3 and gare.bustalotti=2 and num_fase < 7 and 
							   (
							   (not exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1')) and num_fase<>5)
								or exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1'))
								)
							   ))
							   or
							   (v_gare_genere.genere=3 and gare.bustalotti=1 and num_fase < 5))
						 and v_gare_genere.genere<>300)
						or 
						(v_gare_genere.genere=300 and num_fase in (-4,2,5,6,7,8) and ((modlicg=6 or gare1.valtec='1') or ((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5)))
					 )
				 and (num_fase<=fase_esclu or fase_esclu is null or fase_esclu=0);
		perform sp_restoreviews('v_gare_dittefasi');

		-- (M.Caminiti 15.02.2017) Inserito il campo isarchi
		perform sp_backupanddropviews('v_gare_accordiquadro');
		create or replace view v_gare_accordiquadro (ngara,tipgen,tipgarg,not_gar,codcig,cenint,datainizio,datafine,aqoper,aqdurata,aqtempo,isarchi) as
  	               select ngara,tipgen,tipgarg, not_gar, codcig, cenint,daatto as datainizio,
  		              CASE AQTEMPO WHEN 1
  			           THEN daatto + INTERVAL '1 day' * coalesce (AQDURATA * 30,0)
  			           ELSE daatto + INTERVAL '1 day' * coalesce (AQDURATA * 365,0)
  	                      END AS datafine, aqoper, aqdurata, aqtempo,isarchi
                       from gare,torn where codgar1=codgar and accqua='1' and daatto is not null;
		perform sp_restoreviews('v_gare_accordiquadro');

		update eldaver set numver = '6.16.1', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.1', datvet = now() where codapp = 'G1';

		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilit&agrave;-> Manuali'),null,50,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0' 
		and exists(select w_accpro.cod_profilo 
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo 
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
    
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
	DECLARE conta INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.1' or numver like '6.16.1.%')) THEN

		--Definizione nuovi campi
		ALTER TABLE GARE1 ADD COSTOFISSO VARCHAR(1);
		ALTER TABLE TORN ADD MODREA VARCHAR(5);

        CREATE TABLE ISCRIZUFF (
			ID NUMERIC(10) NOT NULL,
			CENINT VARCHAR(16) NOT NULL,
			CODGAR VARCHAR(21),
			NGARA VARCHAR(20),
			CODIMP VARCHAR(10),
			CODCAT VARCHAR(30),
			TIPCAT NUMERIC(7),
			INVREA NUMERIC(7),
			INVPEN NUMERIC(7),
			primary key (ID));
                
        INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('ISCRIZUFF',0);

        ALTER TABLE GCAP ADD CONTAFAQ NUMERIC(7);
		Update gcap set contafaq=contaf where exists
			(select adgcap.ngara from gcap adgcap,gare adgare,torn adtorn where gcap.ngara=adgcap.ngara and gcap.contaf=adgcap.contaf and 
				adgcap.ngara=adgare.ngara and adgare.codgar1=adtorn.codgar and adtorn.isadesione='1' and adgcap.contafaq is null 
				and exists (select aqgcap.ngara from gcap aqgcap,gare aqgare,torn aqtorn where aqgcap.ngara=aqgare.ngara and 
				aqgare.codgar1=aqtorn.codgar and aqtorn.accqua='1' and adtorn.ngaraaq=aqgcap.ngara));

		--Estensione campi N.protocollo a VC(20)
		perform sp_backupanddropviews('torn');
		ALTER TABLE TORN ALTER COLUMN NPROAT TYPE VARCHAR(20);
		ALTER TABLE TORN ALTER COLUMN NAVVIG TYPE VARCHAR(20);
		ALTER TABLE TORN ALTER COLUMN NRIDOC TYPE VARCHAR(20);
		ALTER TABLE TORN ALTER COLUMN NPNOMINACOMM TYPE VARCHAR(20);
		ALTER TABLE TORN ALTER COLUMN MODGAR TYPE VARCHAR(20);
		perform sp_restoreviews('torn');
		perform sp_backupanddropviews('gare');
		ALTER TABLE GARE ALTER COLUMN NPROAG TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NAVVIGG TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NATTOA TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NPROAA TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NCOMAG TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NCOMNG TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NPROVA TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NVPROV TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NREPAT TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN VERNUM TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NATTAMMESCL TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NPROREQ TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NAGGEFF TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NCOMDITTAGG TYPE VARCHAR(20);
		ALTER TABLE GARE ALTER COLUMN NCOMDITTNAG TYPE VARCHAR(20);
		perform sp_restoreviews('gare');
		perform sp_backupanddropviews('pubbli');
		ALTER TABLE PUBBLI ALTER COLUMN NPRPUB TYPE VARCHAR(20);
		perform sp_restoreviews('pubbli');
		perform sp_backupanddropviews('garatt');
		ALTER TABLE GARATT ALTER COLUMN NPROAT TYPE VARCHAR(20);
		perform sp_restoreviews('garatt');
		perform sp_backupanddropviews('gare1');
		ALTER TABLE GARE1 ALTER COLUMN NPLETTAGGPROVV TYPE VARCHAR(20);
		ALTER TABLE GARE1 ALTER COLUMN NPANNREVAGG TYPE VARCHAR(20);
		ALTER TABLE GARE1 ALTER COLUMN NCOMSVIP TYPE VARCHAR(20);
		ALTER TABLE GARE1 ALTER COLUMN NRICHNOMINAMIT TYPE VARCHAR(20);
		perform sp_restoreviews('gare1');
		perform sp_backupanddropviews('garsed');
		ALTER TABLE GARSED ALTER COLUMN NPROTRICONV TYPE VARCHAR(20);
		ALTER TABLE GARSED ALTER COLUMN NUMVERB TYPE VARCHAR(20);
		perform sp_restoreviews('garsed');
		perform sp_backupanddropviews('ditg');
		ALTER TABLE DITG ALTER COLUMN NVCOMMTECN TYPE VARCHAR(20);
		ALTER TABLE DITG ALTER COLUMN NVCONTRADD TYPE VARCHAR(20);
		perform sp_restoreviews('ditg');
		perform sp_backupanddropviews('gareatti');
		ALTER TABLE GAREATTI ALTER COLUMN NUMATTO TYPE VARCHAR(20);
		ALTER TABLE GAREATTI ALTER COLUMN NUMPROTATTO TYPE VARCHAR(20);
		perform sp_restoreviews('gareatti');
		perform sp_backupanddropviews('garcompreq');
		ALTER TABLE GARCOMPREQ ALTER COLUMN NRICREQ TYPE VARCHAR(20);
		perform sp_restoreviews('garcompreq');
		perform sp_backupanddropviews('garecont');
		ALTER TABLE GARECONT ALTER COLUMN NPROPO TYPE VARCHAR(20);
		ALTER TABLE GARECONT ALTER COLUMN NSVIPO TYPE VARCHAR(20);
		perform sp_restoreviews('garecont');
		perform sp_backupanddropviews('garattiagg');
		ALTER TABLE GARATTIAGG ALTER COLUMN NREPAT TYPE VARCHAR(20);
		perform sp_restoreviews('garattiagg');
		perform sp_backupanddropviews('gareids');
		ALTER TABLE GAREIDS ALTER COLUMN NPROT TYPE VARCHAR(20);
		perform sp_restoreviews('gareids');
		perform sp_backupanddropviews('pubbterm');
		ALTER TABLE PUBBTERM ALTER COLUMN NPUBAVVBAN TYPE VARCHAR(20);
		perform sp_restoreviews('pubbterm');

		--Aggiornamento tabellati - verifica l'esistenza perchè già introdotti in patch 6.16.0.a - istruzione già presente in 6.16.1 ma con errore per cui non vniva eseguita
		if (select count(*) = 0 from tab1 where tab1cod = 'A1139' and tab1tip=1) then
			insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1139', 1, 'Da processare', NULL);
			insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1139', 2, 'Processata correttamente', NULL);
			insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1139', 3, 'Processata con errori', NULL);
			insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1139', 4, 'Rifiutata', NULL);
		end if;

		--Nuovi criteri di rotazione selezione da elenco
        insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1073', 8, 'Rotazione in base a inviti per stazione appaltante', 7);
		insert into TAB1(TAB1COD, TAB1TIP, TAB1DESC, TAB1NORD) VALUES('A1073', 9, 'Rotazione in base a inviti per stazione appaltante, con accreditamento inviti virtuali', 8);
		update tab1 set tab1nord=9 where tab1cod='A1073' and tab1tip=2;
		INSERT INTO ALGORITMI (NUMALGO,CODAPP,CODALGO,TIPOALGO,DESCALGO) VALUES (8,'PG','A1073',8,'Presenta gli operatori in ordine inverso rispetto agli inviti ricevuti nell''ambito della stazione appaltante della gara e alle penalità assegnate dall''ente. A parità di numero di inviti e penalità, gli operatori sono ordinati secondo il numero ordine assegnato in elenco.');
		INSERT INTO ALGORITMI (NUMALGO,CODAPP,CODALGO,TIPOALGO,DESCALGO) VALUES (9,'PG','A1073',9,'Presenta gli operatori in ordine inverso rispetto agli inviti ricevuti nell''ambito della stazione appaltante della gara, alle penalità assegnate dall''ente e al numero di inviti virtuali accreditati al momento dell''attivazione in elenco. A parità di numero di inviti e penalità, gli operatori sono ordinati secondo il numero ordine assegnato in elenco.');

		--Modifica dicitura fasi di gara
		update tab1 set tab1desc='Proposta di aggiudicazione' where tab1cod='A1011' and tab1tip=7;
		update tab1 set tab1desc='Aggiudicazione' where tab1cod='A1011' and tab1tip=8;
		update tab1 set tab1desc='Calcolo aggiudicazione' where tab1cod='A1012' and tab1tip=70;
		update tab1 set tab1desc='Proposta di aggiudicazione' where tab1cod='A1012' and tab1tip=75;
		update tab1 set tab1desc='Aggiudicazione' where tab1cod='A1012' and tab1tip=80;

		--Modifica dicitura formato doc. richiesto
		update tab1 set tab1desc='Documento firmato digitalmente (P7M,TSD,PDF,XML)' where tab1cod='A1105' and tab1tip=1;
		
		--Gestione 'Modalità di realizzazione'
		INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z06','9','Accordo quadro/convenzione',NULL,NULL,9,NULL);
		UPDATE TAB2 set TAB2NORD=cast(TAB2TIP as int) WHERE TAB2COD='A1z06' and cast(TAB2TIP as int)>9;
		
		--Modifica configurazione pubblicazioni bando e esito
		update catpub set limsup=null where limsup=9999999999999;
		update catpub set liminf=null where liminf=0;

		--Aggiornamento C0CAMPI
        delete from c0campi where c0c_mne_ber in ('G1COSTOFISSO','G1ISSTIP_L');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'COSTOFISSO.GARE1.GARE','G1COSTOFISSO','OEPV con solo criteri qualitativi e senza busta economica?','OEPV solo crit.qual.','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ISSTIPULA.V_GARE_TORN.GARE','G1ISSTIP_L','Gara con contratto o ordine emesso ?','Emesso contratto?','A2',NULL,'SN',NULL);

        delete from c0campi where c0c_mne_ber in ('GARA_VDA','CODDIT_VDA','RAGSOC_VDA','LOCIMP_VDA','PROIMP_VDA','NUMORD_VDA','NUMINV_VDA','NUMPEN_VDA','NUMALT_VDA','NUMIR_VDA','NUMIP_VDA','CENINTI_VDA','CODCAT_VDA','INFNC_VDA','SUPNC_VDA','NUMCLASS_VDA','NUMINVTOT_VDA','NUMPENTOT_VDA','NUMALTTOT_VDA','NUMIRTOT_VDA','NUMIPTOT_VDA','TIPCAT_VDA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','GARA.V_DITTE_ELECAT_SA.GARE','GARA_VDA','Codice elenco operatori economici','Codice elenco','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','CODICE.V_DITTE_ELECAT_SA.GARE','CODDIT_VDA','Codice operatore economico','Codice operatore','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'RAGSOC.V_DITTE_ELECAT_SA.GARE','RAGSOC_VDA','Ragione sociale operatore partecipante alla gara','Ragione sociale','A61',NULL,NULL,'Ragione sociale');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'LOCIMP.V_DITTE_ELECAT_SA.GARE','LOCIMP_VDA','Localita'' dell''impresa','Comune','A32',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PROIMP.V_DITTE_ELECAT_SA.GARE','PROIMP_VDA','Provincia dell''impresa','Provincia','A40','Agx15',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMORD.V_DITTE_ELECAT_SA.GARE','NUMORD_VDA','Numero d''ordine progressivo dell''operatore','Numero ordine','N7',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMINV.V_DITTE_ELECAT_SA.GARE','NUMINV_VDA','N.inviti ricevuti relativamente alla categoria','N.inviti su categ.','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMPEN.V_DITTE_ELECAT_SA.GARE','NUMPEN_VDA','N.inviti virtuali su categoria assegnati all''attivazione','N.inviti virt.categ.','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMALT.V_DITTE_ELECAT_SA.GARE','NUMALT_VDA','N.penalità su categoria assegnate dall''ente','N.penalità categ.','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMIR.V_DITTE_ELECAT_SA.GARE','NUMIR_VDA','N.inviti su categ. come somma di inviti,inv.virt.e penalità','N.inv.+ pen. categ.','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMIP.V_DITTE_ELECAT_SA.GARE','NUMIP_VDA','N.inviti su categ. come somma di inviti e penalità','N.inv.reali+pen.cat.','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CENINT.V_DITTE_ELECAT_SA.GARE','CENINTI_VDA','Stazione appaltante','Stazione appaltante','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODCAT.V_DITTE_ELECAT_SA.GARE','CODCAT_VDA','Codice categoria','Codice categoria','A30',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'INFNUMCLASS.V_DITTE_ELECAT_SA.GARE','INFNC_VDA','Numero classifica inferiore','Classifica inferiore','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'SUPNUMCLASS.V_DITTE_ELECAT_SA.GARE','SUPNC_VDA','Numero classifica superiore','Classifica superiore','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMCLASS.V_DITTE_ELECAT_SA.GARE','NUMCLASS_VDA','Numero classifica','Classifica','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMINVTOT.V_DITTE_ELECAT_SA.GARE','NUMINVTOT_VDA','N.inviti totale ricevuti relativamente all''elenco','N.inviti totale','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMPENTOT.V_DITTE_ELECAT_SA.GARE','NUMPENTOT_VDA','N.inviti virtuali totale assegnati all''attivazione','N.inviti virt.totale','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMALTTOT.V_DITTE_ELECAT_SA.GARE','NUMALTTOT_VDA','N.penalità totale assegnate dall''ente','N.penalità totale','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMIRTOT.V_DITTE_ELECAT_SA.GARE','NUMIRTOT_VDA','N.inviti come somma di inviti,inv.virt.e penalità totali','N.inv.+ pen. totale','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMIPTOT.V_DITTE_ELECAT_SA.GARE','NUMIPTOT_VDA','N.inviti come somma di inviti e penalità totali','N.inv.reali+pen.tot.','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TIPCAT.V_DITTE_ELECAT_SA.GARE','TIPCAT_VDA','Tipo categoria','Tipo categoria','A100','G_038',NULL,NULL);

        delete from c0campi where c0c_mne_ber in ('G1IDISCRUF','G1CENINTIU','G1CODGARIU','G1NGARAIU','G1CODIMPIU','G1CODCATIU','G1TIPCATIU','G1INVREAIU','G1INVPENIU');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.ISCRIZUFF.GARE','G1IDISCRUF','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CENINT.ISCRIZUFF.GARE','G1CENINTIU','Stazione appaltante','Stazione appaltante','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODGAR.ISCRIZUFF.GARE','G1CODGARIU','Cod.fittizio elenco operatori economici','Codice elenco inter.','A21',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.ISCRIZUFF.GARE ','G1NGARAIU','Codice elenco operatori economici','Codice elenco','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODIMP.ISCRIZUFF.GARE','G1CODIMPIU','Codice ditta iscritta all''elenco operatori economici','Codice ditta','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODCAT.ISCRIZUFF.GARE','G1CODCATIU','Codice categoria','Codice categoria','A30',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TIPCAT.ISCRIZUFF.GARE','G1TIPCATIU','Tipo categoria','Tipo categoria','A100','G_038',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'INVREA.ISCRIZUFF.GARE','G1INVREAIU','N.inviti ricevuti dalla ditta relativamente alla categoria','N.inviti','N3',NULL,NULL,NULL);
        INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'INVPEN.ISCRIZUFF.GARE','G1INVPENIU','N.inviti virtuali assegnati all''attivazione dell''operatore','N.inviti virtuali','N3',NULL,NULL,'N.inviti virtuali');

        delete from c0campi where c0c_mne_ber in ('G1_CONTAQ','G1CODCIG_L','G1MODREA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CONTAFAQ.GCAP.GARE','G1_CONTAQ','Num.progressivo della lavorazione nell''accordo quadro','Num.lav.acc.quadro','N4',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODCIG.V_GARE_TORN.GARE','G1CODCIG_L','Codice identificativo della gara (CIG)','Codice CIG','A2000',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'MODREA.TORN.GARE','G1MODREA','Modalità di realizzazione','Modalità realizzaz.','A100','A1z06',NULL,'Modalità di realizzazione');

		UPDATE C0CAMPI SET COC_DES='Tipo di appalto (Lavori, Forniture o Servizi)',COC_DES_FRM='Tipo di appalto' where C0C_MNE_BER='TIPLAV_S';
		UPDATE C0CAMPI SET COC_DES='Iter di gara',COC_DES_FRM='Iter di gara' where C0C_MNE_BER='G1TIPGARS';
		UPDATE C0CAMPI SET COC_DES_FRM='Proced. accelerata?' where C0C_MNE_BER='G1PROURGS';
		UPDATE C0CAMPI SET COC_DES_FRM='Libera dispon. atti?' where C0C_MNE_BER='G1DOCWEBS';
		UPDATE C0CAMPI SET COC_DES_WEB='Da importo' where C0C_MNE_BER='LIMINF_S';
		UPDATE C0CAMPI SET COC_DES_WEB='A importo' where C0C_MNE_BER='LIMSUP_S';
		UPDATE C0CAMPI SET COC_DES_WEB='Data verbale' where C0C_MNE_BER='G1DVPROV';
		UPDATE C0CAMPI SET COC_DES_WEB='Num.prot.verbale' where C0C_MNE_BER='G1NVPROV';
		UPDATE C0CAMPI SET COC_DES_WEB='Data invio lettera' where C0C_MNE_BER='DATLAP';
		UPDATE C0CAMPI SET COC_DES_WEB='Num.prot.lettera' where C0C_MNE_BER='NPLETTAGGP';

        UPDATE C0CAMPI SET C0C_FS='A20' WHERE C0C_MNE_BER in ('NPROAT','NAVVIG','G1NRIDOC','G1NPNOMCOMM','NCOMMI');
		UPDATE C0CAMPI SET C0C_FS='A20' WHERE C0C_MNE_BER in ('NPROAG','NAVVIGG','NATTOA','NPROAA','NCOMAG','G1NCOMNG','G1NPROVA','G1NVPROV','G1NREPAT','G1VERNUM','NUMATTAE','G1NPROREQ','G1NAGGEFF','NCOMDITAGG','NCOMDITNAG');
		UPDATE C0CAMPI SET C0C_FS='A20' WHERE C0C_MNE_BER in ('NPRPUB','G1NPROAAT','NPLETTAGGP','NPANREVAGG','G1NCOMSVIP','G1NRINOMIT','G1NPRICONV','G1NUMVERB');
		UPDATE C0CAMPI SET C0C_FS='A20' WHERE C0C_MNE_BER in ('G1NVCOMMT','G1NVCONTRAD','G1AT_NUM','G1AT_NPROT','G1NRICREQ','G1NPROPO','G1NSVIPO','G1NREPATAA','G1NPROTIDS','NPAVVBANPT','G1PROT_D');

        --Aggiornamento C0ENTIT
		delete from c0entit where c0e_nom in ('V_DITTE_ELECAT_SA.GARE','ISCRIZUFF.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('V_DITTE_ELECAT_SA.GARE',0,'E','ELE_INV_SA','Lista per selezione operat.economici in gare per staz.appal.','GARA.V_DITTE_ELECAT_SA.GARE,CODICE.V_DITTE_ELECAT_SA.GARE',NULL,NULL,NULL,NULL,'g1_disa0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('ISCRIZUFF.GARE',0,'E','ELEN_INVSA','Inviti reali e virtuali su categorie per stazione appalt.','CODGAR.ISCRIZUFF.GARE,NGARA.ISCRIZUFF.GARE,CODIMP.ISCRIZUFF.GARE,CODCAT.ISCRIZUFF.GARE,TIPCAT.ISCRIZUFF.GARE','ISCRIZCAT.GARE','CODGAR.ISCRIZCAT.GARE,NGARA.ISCRIZCAT.GARE,CODIMP.ISCRIZCAT.GARE,CODCAT.ISCRIZCAT.GARE,TIPCAT.ISCRIZCAT.GARE',NULL,NULL,'g1_invs0');
		
		 --Aggiornamento profili
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.CATPUB-lista','Lista configurazione pubblicazioni bando e esito gara',13080);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.CATPUB-scheda','Scheda dettaglio configurazione pubblicazioni bando e esito gara',13090);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.CATPUB-lista.DEL','Elimina',13100);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.CATPUB-lista.LISTADELSEL','Elimina selezionati',13110);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.CATPUB-lista.LISTANUOVO','Nuovo',13120);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.CATPUB-lista.MOD','Modifica',13130);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.CATPUB-scheda.SCHEDANUOVO','Nuovo',13140);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.CATPUB-scheda.SCHEDAMOD','Modifica',13150);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.CATPUB-scheda.TABPUB','Sezione dinamica Pubblicazioni predefinite bando e esito di gara per categ.',13160);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.CATPUB-scheda.INS-TABPUB','Inserimento Sezione dinamica Pubblicazioni predefinite bando e esito di gara per categ.',13170);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.CATPUB-scheda.DEL-TABPUB','Eliminazione Sezione dinamica Pubblicazioni predefinite bando e esito di gara per categ.',13190);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SUBMENU','AMMINISTRAZIONE.Configurazione-CATPUB','Configurazione pubblicazioni bando e esito gara',13200);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.CATSCA-lista','Lista Configurazione scadenze gara',13210);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.CATSCA-lista-dettaglio','Lista Dettaglio Configurazione scadenze gara',13220);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.CATSCA-scheda','Scheda Dettaglio configurazione scadenze gara',13230);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.CATSCA-lista-dettaglio.MOD','Modifica',13240);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.CATSCA-scheda.SCHEDAMOD','Modifica',13250);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SUBMENU','AMMINISTRAZIONE.Configurazione-CATSCA','Configurazione scadenze gara',13260);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.DettaglioSoggettiAggregati','Dettaglio soggetti aggregati',13270);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-OFFUNICA-scheda.DATIGEN.IDS','Sezione impegni di spesa',13280);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.TORN-OFFUNICA-scheda.DATIGEN.INS-IDS','Inserisci impegno di spesa',13290);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.TORN-OFFUNICA-scheda.DATIGEN.DEL-IDS','Elimina impegno di spesa',13300);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.DATIGEN.PubblicaSuPortale','Funzione Pubblica su portale',5822);

		IF (select count(*) = 0 from w_oggetti where tipo='FUNZ' and oggetto='ALT.GARE.GARE-scheda.ORDINE.ImpostaOrdineDef') THEN
			INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.ORDINE.ImpostaOrdineDef','Imposta ordine definito',12665);
			INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.ORDINE.TrasmettiOrdine','Trasmetti ordine',12670);
			UPDATE W_OGGETTI SET ORD=2710 WHERE tipo='PAGE' and oggetto='GARE.GARE-scheda.ORDINE';
		END IF;
		
		UPDATE W_OGGETTI SET descr='Funzione Pubblica su portale' where tipo='FUNZ' and oggetto like '%PubblicaSuPortale%';
		UPDATE W_OGGETTI SET descr='Funzione Pubblica invito su portale' where tipo='FUNZ' and oggetto like '%PubblicaSuAreaRiservata%';

		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('SEZ', 'VIS', 'GARE.TORN-OFFUNICA-scheda.DATIGEN.IDS', 'Visualizza', 0, 1, 1, 3934754985);
		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('FUNZ', 'VIS', 'INS.GARE.TORN-OFFUNICA-scheda.DATIGEN.INS-IDS', 'Visualizza', 0, 1, 1, 1115614029);
		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('FUNZ', 'VIS', 'DEL.GARE.TORN-OFFUNICA-scheda.DATIGEN.DEL-IDS', 'Visualizza', 0, 1, 1, 1452874809);

		--Corretto descrizione property
		update W_CONFIG set descrizione='URL del Web Service "compositore modelli" (esempio http://localhost:8080/WSCompositore/services/ServizioCompositore)' where CODAPP='PG' and CHIAVE='it.eldasoft.generatoreModelli.ws.url';

		--Corretto configurazione task scadenzario
		update w_quartz set CRON_EXPRESSION='0 0 0 1 1 ? 2099'
			where CODAPP='PG' and BEAN_ID in ('ricalcoloScadenzariSchedulerTrigger','notificaPromemoriaScadenzariSchedulerTrigger')
			and CRON_SECONDS='0' and CRON_MINUTES='0' and CRON_HOURS='0' and CRON_DAY_OF_MONTH='1' and CRON_MONTH='1' and CRON_DAY_OF_WEEK='?' and CRON_YEAR='2099';
		
		perform sp_backupanddropviews('v_gare_torn');
		-- (S.Santi 31.03.2017) Aggiunto campo 'isstipula', che vale sÃ¬ se la gara, oltre ad essere aggiudicata senza esito negativo, 
		--    ha 'data atto contrattuale' valorizzata. Se gara divisa in lotti, vale sÃ¬ se tutti i lotti risultano con data atto contrattuale valorizzata
		-- (S.Santi 06.04.2017) Aggiunto campo 'Codice CIG'. Nel caso di gara a lotti, contiene elenco CIG dei lotti separati da ','
		--
		create or replace view v_gare_torn as 
		with
		--n.lotti di ogni gara
		lotti
		as (
		select codgar1, array_to_string(array_agg(gare.codcig),',') codciglotti, count(*) numlotti from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati senza esito negativo
		lottiagg
		as (
		select codgar1, count(*) numlottiagg from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null and esineg is null
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati e con contratto stipulato senza esito negativo
		lottistip
		as (
		select codgar1, count(*) numlottistip from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null and esineg is null and daatto is not null
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati o con esito negativo
		lotticonc
		as (
		select codgar1, count(*) numlotticonc from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null or esineg is not null
		group by codgar1
		)
		select codgar, codgar as codice, tipgen, destor as oggetto, imptor as importo, tipgar, 
			cast('1' as varchar(1)) as islotti, (case when gare.genere=3 then 3 else 1 end) as genere, isarchi,
			case when (lotti.numlotti>0 and lotti.numlotti=lottiagg.numlottiagg) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu,
			case when (lotti.numlotti>0 and lotti.numlotti=lottistip.numlottistip) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isstipula,
			case when (lotti.numlotti>0 and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as islotticonclusi,
			(case when gare.genere=3 then gare.esineg else torn.esineg end) as esineg, lotti.codciglotti as codcig, profiloweb, gartel
		from torn 
			left outer join gare on (codgar=gare.ngara and gare.genere=3) 
			left outer join lotti on (lotti.codgar1=torn.codgar)
			left outer join lottiagg on (lottiagg.codgar1=torn.codgar)
			left outer join lottistip on (lottistip.codgar1=torn.codgar)
			left outer join lotticonc on (lotticonc.codgar1=torn.codgar)
			where codgar not like '$%' 
		union
		select torn.codgar, gare.ngara as codice, torn.tipgen, gare.not_gar as oggetto, gare.impapp as importo, gare.tipgarg,
			cast('2' as varchar(1)) as islotti, 2 as genere, torn.isarchi, 
			case when (gare.ditta is not null and gare.esineg is null) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu, 
			case when (gare.ditta is not null and gare.daatto is not null and gare.esineg is null) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isstipula, 
			null as islotticonclusi,
			gare.esineg, gare.codcig, torn.profiloweb, torn.gartel
			from gare,torn 
			where torn.codgar=gare.codgar1 and torn.codgar like '$%' and (gare.genere is null or (gare.genere not in (4,10,11,20)));
		perform sp_restoreviews('v_gare_torn');

		perform sp_backupanddropviews('v_gare_statoesito');
		-- (S.Santi 31.03.2017) Aggiunto voce 'Emesso contratto/ordine' per gare e lotti aggiudicati con data atto contrattuale valorizzata
		--
		create or replace view v_gare_statoesito as
			select g.codgar, g.codice, g.genere, g.oggetto,
				case when g.genere in (100,300) then
				 case when dataoratermine is not null and dataoratermine >= now() and gare.ditta is null and gare.esineg is null then 1
					  when dataoratermine is not null and dataoratermine < now() and gare.ditta is null and gare.esineg is null then 2
					  when gare.ditta is not null or gare.esineg is not null then 3
					  else null end
				 when g.genere in (1,2,3) then
				 case when dataoratermine is not null and dataoratermine >= now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
						and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 1
					  when dataoratermine is not null and dataoratermine < now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
						and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 2
					  when v_gare_torn.esineg is not null or v_gare_torn.isaggiu='1' or v_gare_torn.islotticonclusi='1' then 3
					  else null end
				end codstato,
				case when g.genere in (100,300) then
				 case when dataoratermine is not null and dataoratermine >= now() and gare.ditta is null and gare.esineg is null then 'In corso'
					  when dataoratermine is not null and dataoratermine < now() and gare.ditta is null and gare.esineg is null then 'In aggiudicazione'
					  when gare.ditta is not null or gare.esineg is not null then 'Concluso'
					  else null end
				 when g.genere in (1,2,3) then
				 case when dataoratermine is not null and dataoratermine >= now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
						and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 'In corso'
					  when dataoratermine is not null and dataoratermine < now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
						and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 'In aggiudicazione'
					  when v_gare_torn.esineg is not null or v_gare_torn.isaggiu='1' or v_gare_torn.islotticonclusi='1' then 'Conclusa'
					  else null end
				end stato,
				case when g.genere in (100,300) then
				  case when gare.esineg is not null then (select tab1desc from tab1 where tab1cod='A1088' and tab1tip=gare.esineg)
					   when gare.ditta is not null and gare.daatto is not null then 'Emesso contratto/ordine'
					   when gare.ditta is not null then 'Aggiudicato' end
				 when g.genere in (1,2,3) then
				  case when v_gare_torn.esineg is not null then (select tab1desc from tab1 where tab1cod='A1088' and tab1tip=v_gare_torn.esineg)
					  when v_gare_torn.isaggiu='1' and v_gare_torn.isstipula='1' then 'Emesso contratto/ordine' 
					  when v_gare_torn.isaggiu='1' then 'Aggiudicata' end
				end esito
			 from v_gare_genere g
			 left outer join gare on gare.ngara=g.codice
			 left outer join v_gare_torn on v_gare_torn.codgar=g.codgar
			 where g.genere in (1,2,3,100,300);
		perform sp_restoreviews('v_gare_statoesito');

		perform sp_backupanddropviews('v_scad_bandi_altro');
		CREATE OR REPLACE VIEW v_scad_bandi_altro AS
			/* Seduta pubblica apertura della busta A contenente la documentazione amministrativa  - considera gare a lotto unico o con plico unico*/
			SELECT g.codgar1 AS codgar, 'PG-SEDPUBBLDOCAMM' AS codevento, MIN(s.datini) AS dataconsuntivo 
			  FROM gare g INNER JOIN garsed s ON g.ngara = s.ngara
			 WHERE (g.genere is null or g.genere=3) and (g.codgar1=g.ngara or g.codgar1='$'||g.ngara) AND s.fase=2 
			GROUP BY g.codgar1
			UNION ALL
			/* Data esame documentazione ex art. 48 comma 1 */
			SELECT g.codgar, 'PG-ESAMEDOC' AS codevento, desdoc AS dataconsuntivo 
			  FROM torn g INNER JOIN v_gare_torn vgt ON g.codgar=vgt.codgar
			 WHERE vgt.genere in (1,2,3)
			UNION ALL
			/* Seduta pubblica  di apertura delle offerte economiche - considera gare a lotto unico o con plico unico*/
			SELECT g.codgar1 AS codgar, 'PG-SEDPUBBLOFFEC' AS codevento, MIN(s.datini) AS dataconsuntivo 
			  FROM gare g INNER JOIN garsed s ON g.ngara = s.ngara
			 WHERE (g.genere is null or g.genere=3) and (g.codgar1=g.ngara or g.codgar1='$'||g.ngara) AND s.fase=6
			GROUP BY g.codgar1
			UNION ALL
			/* Seduta apertura offerte tecniche - considera gare a lotto unico o con plico unico*/
			SELECT g.codgar1 AS codgar, 'PG-SEDAPOFFTECN' AS codevento, MIN(s.datini) AS dataconsuntivo 
			  FROM gare g INNER JOIN garsed s ON g.ngara = s.ngara
			 WHERE (g.genere is null or g.genere=3) and (g.codgar1=g.ngara or g.codgar1='$'||g.ngara) AND s.fase=5
			GROUP BY g.codgar1
			UNION ALL
			/* Determinazione di aggiudicazione definitiva non efficace - considera gare a lotto unico o con plico unico*/
			SELECT g.codgar1 AS codgar, 'PG-AGGDEFNONEFF' AS codevento, g.dattoa AS dataconsuntivo 
				FROM gare g where (g.genere is null or g.genere=3) and (g.codgar1=g.ngara or g.codgar1='$'||g.ngara)
			UNION ALL
			/* Data stipula contrattuale - considera gare a lotto unico o con plico unico*/
			SELECT g.codgar1 AS codgar, 'PG-DATASTIPCONTR' AS codevento, max(g.daatto) AS dataconsuntivo 
			  FROM gare g INNER JOIN v_gare_torn vgt ON g.codgar1=vgt.codgar
			 WHERE vgt.genere in (2,3)
			GROUP BY g.codgar1;
		perform sp_restoreviews('v_scad_bandi_altro');

		-- (S.Santi 08.03.2017) Nuova view per selezione da elenco mediante rotazione per stazione appaltante
		--
		create or replace view v_ditte_elecat_sa (gara, codice, ragsoc, locimp, proimp, numord, numinv, numpen, numalt, numir, numip,
					cenint, codcat, tipcat, infnumclass, supnumclass, numclass, 
					numinvtot, numpentot, numalttot, numirtot, numiptot) as
			with
			totali_altpen as 
				(select iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp, 
					 sum(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt
				from iscrizcat
				group by codgar, ngara, codimp),
			totali_sa as
				(select iscrizuff.cenint, iscrizuff.codgar, iscrizuff.ngara, iscrizuff.codimp, 
					 sum(case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) numinv, 
					 sum(case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end) numpen,
					 sum((case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
						(case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end)) numirnoalt
				from iscrizuff 
				group by iscrizuff.cenint, iscrizuff.codgar, iscrizuff.ngara, iscrizuff.codimp)
			select gare.ngara, ditg.dittao, ditg.nomimo, impr.locimp, impr.proimp, ditg.numordpl,
					  (case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end),
					  (case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end), 
					  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end), 
					  (case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
					  (case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end) + 
					  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end),
					  (case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
					  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end),
					  uffint.codein, iscrizcat.codcat, iscrizcat.tipcat, iscrizcat.infnumclass, iscrizcat.supnumclass,
					  iscrizclassi.numclass,
					  (case when (totali_sa.numinv is null) then 0 else totali_sa.numinv end),
					  (case when (totali_sa.numpen is null) then 0 else totali_sa.numpen end),
					  totali_altpen.numalt,
					  (case when (totali_sa.numirnoalt is null) then totali_altpen.numalt else totali_sa.numirnoalt + totali_altpen.numalt end),
					  (case when (totali_sa.numinv is null) then totali_altpen.numalt else totali_sa.numinv + totali_altpen.numalt end)
				from ditg inner join gare on (ditg.codgar5=gare.codgar1 and ditg.ngara5=gare.ngara)
					inner join impr on (ditg.dittao=impr.codimp)
					inner join iscrizcat on (ditg.codgar5=iscrizcat.codgar and ditg.ngara5=iscrizcat.ngara and ditg.dittao=iscrizcat.codimp)
					inner join uffint on (1=1)
					left outer join iscrizuff on (uffint.codein=iscrizuff.cenint and iscrizuff.codgar=iscrizcat.codgar and iscrizuff.ngara=iscrizcat.ngara 
									and iscrizuff.codimp=iscrizcat.codimp and iscrizuff.codcat=iscrizcat.codcat and iscrizuff.tipcat=iscrizcat.tipcat)
					left outer join totali_sa on (uffint.codein=totali_sa.cenint and ditg.codgar5=totali_sa.codgar and ditg.ngara5=totali_sa.ngara and ditg.dittao=totali_sa.codimp)
					inner join totali_altpen on (ditg.codgar5=totali_altpen.codgar and ditg.ngara5=totali_altpen.ngara and ditg.dittao=totali_altpen.codimp)
					left outer join iscrizclassi on (iscrizcat.codgar=iscrizclassi.codgar and iscrizcat.ngara=iscrizclassi.ngara 
						and iscrizcat.codimp=iscrizclassi.codimp and iscrizcat.codcat=iscrizclassi.codcat and iscrizcat.tipcat=iscrizclassi.tipcat)
				where gare.codgar1 like '$%' and gare.genere in (10,20) 
				   and ditg.abilitaz=1 and (ditg.dabilitaz is not null) and ditg.numordpl is not null;

		update eldaver set numver = '6.16.2', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.2', datvet = now() where codapp = 'G1';

		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,50,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0' 
		and exists(select w_accpro.cod_profilo 
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo 
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
    
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
	DECLARE conta INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.2' or numver like '6.16.2.%')) THEN

        --Definizione nuovi campi
        perform sp_backupanddropviews('garsed');
        ALTER TABLE GARSED ADD NPRVERB VARCHAR(20);
        perform sp_restoreviews('garsed');
        
		perform sp_backupanddropviews('pubg');
        ALTER TABLE PUBG ADD NPRPUB VARCHAR(20);
        perform sp_restoreviews('pubg');
        
		perform sp_backupanddropviews('gare1');
        ALTER TABLE GARE1 ADD DATAPAGG TIMESTAMP;
        ALTER TABLE GARE1 ADD NPRAPAGG VARCHAR(20);
        ALTER TABLE GARE1 ADD NOFALASUP NUMERIC(3);
        ALTER TABLE GARE1 ADD NOFALAINF NUMERIC(3);
        perform sp_restoreviews('gare1');
        
		perform sp_backupanddropviews('garecont');
        ALTER TABLE GARECONT ADD BANAPP VARCHAR(100);
        perform sp_restoreviews('garecont');

        perform sp_backupanddropviews('ditgaq');
        ALTER TABLE DITGAQ ADD BANAPP VARCHAR(100);
        ALTER TABLE DITGAQ ADD COORBA VARCHAR(50);
        perform sp_restoreviews('ditgaq');
		
		-- Inizializzazione campo 'Numero d'ordine' per ordinamento Configurazione codifica automatica
		Update g_confcod set numord=1 where noment='TORN' and nomcam='CODGAR' and tipcam=-1;
		Update g_confcod set numord=2, descam='Suffisso lotto di gara' where noment='GARE' and nomcam='NGARA' and tipcam=-1;
		Update g_confcod set numord=3 where noment='GAREAVVISI' and nomcam='NGARA' and tipcam=-1;
		Update g_confcod set numord=4 where noment='GAREALBO' and nomcam='CODGAR' and tipcam=-1;
		Update g_confcod set numord=5 where noment='MECATALOGO' and nomcam='CODGAR' and tipcam=-1;
		Update g_confcod set numord=6 where noment='MERIC' and nomcam='CODRIC' and tipcam=-1;
		Update g_confcod set numord=7, descam='Codice ordine di acquisto' where noment='GARECONT' and nomcam='NGARA' and tipcam=-1;   
		delete from tab4 where tab4cod='G1_1' and tab4tip='A1050';
						
		-- Adeguamento DLgs.56/2017 - modifica parametri
		update TAB4 set tab4desc='Calcolo aggiudicazione: (DLgs.50/2016 dopo correttivo) % per taglio delle ali' where tab4cod='G1_1' and tab4tip='A2065';
		update TAB1 set tab1desc='20    - metodo A' where tab1cod='A2065' and tab1tip=1;
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A2065',2,'20    - metodo B',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A2065',3,'10    - metodo E',NULL,0,NULL);
		update TAB4 set tab4desc='Calcolo aggiudicazione: (DLgs.50/2016 prima di correttivo) coeff.per calcolo soglia metodo E' where tab4cod='G1_1' and tab4tip='A1127';
		INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1140','Calcolo aggiudicazione: (DLgs.50/2016 dopo correttivo) coeff.per calcolo soglia metodo E',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1140',1,'0,6',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1140',2,'0,7',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1140',3,'0,8',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1140',4,'0,9',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1129',2,'2000000     procedure ordinarie',NULL,1,NULL);
		UPDATE TAB1 set TAB1DESC='1000000     altre procedure',TAB1NORD=2 where tab1cod='A1129' and tab1tip=1;

		-- Adeguamento DLgs.56/2017 - modifica numero inviti
		update CONFOPECO set NUMMINOP=10 where tipologia=1 and daimporto=40000 and aimporto=150000;
		update CONFOPECO set NUMMINOP=15 where tipologia=1 and daimporto=150000 and aimporto=1000000;

        --Valorizzazione dei nuovi campi per contenere il numero di ali inferiori e superiori
        update gare1 set nofalainf=(select (case when count(ngara5) = 0 then null else count(ngara5) END) from ditg where ngara5=gare1.ngara and staggi=7) where nofalainf is null;
		update gare1 set nofalasup=(select gare.nofval - gare.nofmed - gare1.nofalainf from gare where gare.ngara=gare1.ngara and gare.nofval>=0 and gare.nofmed>=0 and gare1.nofalainf>0) where nofalasup is null and nofalainf is not null;

		--Aggiornamento C0CAMPI
        delete from c0campi where c0c_mne_ber in ('G1NPRVERB','G1NPRPUB','G1DATAPAGG','G1NPRAPAGG','G1NOFALASUP','G1NOFALAINF');
        INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NPRVERB.GARSED.GARE','G1NPRVERB','Numero protocollo verbale','Numero protocollo','A20',NULL,NULL,NULL);
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NPRPUB.PUBG.GARE','G1NPRPUB','Numero di protocollo','Num.protocollo','A20',NULL,NULL,'Numero protocollo ');
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATAPAGG.GARE1.GARE','G1DATAPAGG','Data approvazione proposta di aggiudicazione','Data appr.agg.provv.','A10',NULL,'DATA_ELDA','Data approvazione proposta di aggiudicazione');
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NPRAPAGG.GARE1.GARE','G1NPRAPAGG','Numero protocollo approvazione proposta di aggiudicazione','N.pr.appr.agg.provv.','A20',NULL,NULL,'Num.protocollo');
        INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NOFALASUP.GARE1.GARE','G1NOFALASUP','Numero offerte accantonate come ala superiore','Num.offerte ala sup.','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NOFALAINF.GARE1.GARE','G1NOFALAINF','Numero offerte accantonate come ala inferiore','Num.offerte ala inf.','N3',NULL,NULL,NULL);

        delete from c0campi where c0c_mne_ber in ('G1BANAPP','G1BANAPPDQ','G1COORBADQ');
        INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'BANAPP.GARECONT.GARE','G1BANAPP','Descrizione banca di appoggio','Banca','A100',NULL,NULL,'Descrizione banca');
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'BANAPP.DITGAQ.GARE','G1BANAPPDQ','Descrizione banca di appoggio','Banca','A100',NULL,NULL,'Descrizione banca');
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'COORBA.DITGAQ.GARE','G1COORBADQ','Conto corrente dedicato','Conto corrente','A50',NULL,NULL,'Conto corrente dedicato');

        UPDATE C0CAMPI SET COC_DES='Conto corrente dedicato', COC_DES_FRM='Conto corrente', COC_DES_WEB='Conto corrente dedicato' where C0C_MNE_BER='G1COORBA';
        UPDATE C0CAMPI SET COC_DES='Settore della stazione appaltante', COC_DES_FRM='Settore staz.appalt.', COC_DES_WEB='Settore' where C0C_MNE_BER='G1UFFDET';

        --Aggiornamento profili
	    INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.AGGDEF.CONTRATTPROC','Sezione "Controllo sugli atti della procedura (art.33 Dlgs.50/2016)"',2968);
	    INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-OFFUNICA-scheda.AGGIUDDEF.CONTRATTPROC','Sezione Controllo sugli atti della procedura (art.33 Dlgs.50/2016)',6758);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.CONTRATTO.COORBA','Sezione Coordinate bancarie ditta aggiudicataria',6655);
	    INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda-contratto.ATTOCONTR.COORBA','Sezione Coordinate bancarie ditta aggiudicataria',4945);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.STIPULA.COORBA','Sezione Coordinate bancarie ditta aggiudicataria',12155);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda-contratto.STIPULA.COORBA','Sezione Coordinate bancarie ditta aggiudicataria',12405);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.AGGEFF.COORBA','Sezione Coordinate bancarie ditta aggiudicataria',12265);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda-contratto.AGGEFF.COORBA','Sezione Coordinate bancarie ditta aggiudicataria',12475);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.ImpostaCondivisionePredefinita','Condividi e proteggi gara - Funzione Imposta condivisione predefinita',2050);
		UPDATE W_OGGETTI SET ORD=2045 where TIPO='FUNZ' and OGGETTO ='ALT.GARE.V_GARE_TORN-lista.Condividi-gara';
		
        --Default nuovi campi
        Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('COLS', 'VIS', 'GARE.GARSED.NPRVERB', 'Visualizza', 0, 1, 1, 3212336993);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('COLS', 'VIS', 'GARE.PUBBLI.NPRPUB', 'Visualizza', 0, 1, 1, 2202313017);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('COLS', 'VIS', 'GARE.PUBG.NPRPUB', 'Visualizza', 0, 1, 1, 1065221351);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('SEZ', 'VIS', 'GARE.GARE-scheda.AGGDEF.CONTRATTPROC', 'Visualizza', 0, 1, 1, 1354218718);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('SEZ', 'VIS', 'GARE.TORN-OFFUNICA-scheda.AGGIUDDEF.CONTRATTPROC', 'Visualizza', 0, 1, 1, 3835709268);

		update eldaver set numver = '6.16.3', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.3', datvet = now() where codapp = 'G1';

  	    --Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,50,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0' 
		and exists(select w_accpro.cod_profilo 
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo 
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
    
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
	DECLARE conta INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.3' or numver like '6.16.3%')) THEN

        --Definizione nuovi campi
		ALTER TABLE DITG ADD IMPMANO NUMERIC(24,5);
		ALTER TABLE GCAP ADD CODCAT VARCHAR(30);

		-- Tolto configurazione tabellato dimesso da applicativo WEB
		delete from tab6 where tab6cod='G1_1' and tab6tip='A1003';
		
        --Aggiornamento C0CAMPI
		delete from c0campi where c0c_mne_ber in ('G1IMPMANO');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPMANO.DITG.GARE','G1IMPMANO','Costi della manodopera (art.95 c.10 DLgs.50/2016)','Costi manodopera','F15',NULL,'MONEY',NULL);
		delete from c0campi where c0c_mne_ber in ('G1_CODCAT');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODCAT.GCAP.GARE','G1_CODCAT','Codice categoria','Codice categoria','A30',NULL,NULL,'Codice categoria');

		UPDATE C0CAMPI SET COC_DES='Costi di sicurezza aziendale (art.95 c.10 DLgs.50/2016)' where C0C_MNE_BER='G1IMPSICAZI';
		UPDATE C0CAMPI SET COC_DES='Tipo di calcolo (NON USATO)', COC_DES_FRM='NON USATO', C0C_TIP='C' where C0C_MNE_BER='G1_TIPCAE';
		UPDATE C0CAMPI SET COC_DES='Importo offerto dalla ditta (NON USATO)', COC_DES_FRM='NON USATO', C0C_TIP='C' where C0C_MNE_BER='G1_IMPOFP';
		UPDATE C0CAMPI SET COC_DES='Punteggio ottenuto dall''impresa' where C0C_MNE_BER='G1_PUNTIP';
		UPDATE C0CAMPI SET COC_DES='Coefficiente punteggio' where C0C_MNE_BER='G1_COEFFI';

		-- (S.Santi 26.06.2017) Introdotto voce per controllo su profili personalizzati (messo controllo perchè già fatto insert per il cliente UREGA)
		IF (select count(*) = 0 from w_oggetti where tipo='SEZ' and oggetto='GARE.GARE-scheda.AGGDEF.RAGDET') THEN
			INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.AGGDEF.RAGDET','Sezione dinamica "Consorziate esecutrici"',3020);
		END IF;
		
		-- (C.Febas 27.06.2017) Profilazione codice categoria in lavorazioni
		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('COLS', 'VIS', 'GARE.GCAP.CODCAT', 'Visualizza', 0, 1, 1, 3979949284);

		perform sp_backupanddropviews('v_gcapd');
		create or replace view v_gcapd as
		  select gcap.ngara,gcap.contaf,gcap.norvoc,gcap.codvoc,gcap.unimis,gcap.quanti,gcap.prezun,
		  gcap.clasi1,gcap.numpar,gcap.voce,gcap.solsic,gcap.sogrib,gcap.dittao,
		  ditg.dittao as cod_ditta, ditg.codgar5 as codgar, gare.codiga
		  from gcap, ditg, gare
		  where gcap.ngara=ditg.ngara5 and (gcap.dittao is null or gcap.dittao=ditg.dittao)
		   and gcap.ngara=gare.ngara;
		perform sp_restoreviews('v_gcapd');
		   
		update eldaver set numver = '6.16.4', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.4', datvet = now() where codapp = 'G1';

  	    --Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,50,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0' 
		and exists(select w_accpro.cod_profilo 
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo 
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
    
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
	DECLARE conta INT;
	DECLARE maxid INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.4' or numver like '6.16.4%')) THEN

       CREATE TABLE G1CRIDEF (
           ID NUMERIC(12) NOT NULL,
	       NGARA VARCHAR(20),
           NECVAN NUMERIC(7),
	       DESCRI TEXT,
	       MAXPUN NUMERIC(24,5),
	       FORMATO NUMERIC(7),
	       NUMDECI NUMERIC(7),
	       MODPUNTI NUMERIC(7),
	       MODMANU NUMERIC(7),
	       FORMULA NUMERIC(7),
	       primary key (ID));
        ALTER TABLE G1CRIDEF ADD CONSTRAINT FK_G1CRIDEF_GOEV FOREIGN KEY ( NGARA, NECVAN) REFERENCES GOEV( NGARA, NECVAN ) ON DELETE CASCADE;

        CREATE TABLE G1CRIVAL (
           ID NUMERIC(12) NOT NULL,
  	       IDCRIDEF NUMERIC(12) NOT NULL,
  	       NGARA VARCHAR(20) NOT NULL,
  	       NECVAN NUMERIC(7) NOT NULL,
  	       DITTAO VARCHAR(10),
  	       COEFFI NUMERIC(24,9),
  	       PUNTEG NUMERIC(24,9),
           primary key (ID));
        ALTER TABLE G1CRIVAL ADD CONSTRAINT FK_G1CRIVAL_G1CRIDEF FOREIGN KEY ( IDCRIDEF) REFERENCES G1CRIDEF( ID ) ON DELETE CASCADE;

		ALTER TABLE ANTICORLOTTI ADD CODFISRESP VARCHAR(16);
		ALTER TABLE ANTICORLOTTI ADD NOMERESP VARCHAR(161);

        --Definizione nuovi campi
		ALTER TABLE GARE1 ADD RIPTEC NUMERIC(7);
		ALTER TABLE GARE1 ADD RIPCRITEC NUMERIC(7);
		ALTER TABLE GARE1 ADD RIPECO NUMERIC(7);
		ALTER TABLE GARE1 ADD RIPCRIECO NUMERIC(7);
		ALTER TABLE GARE1 ADD METPUNTI NUMERIC(7);

		ALTER TABLE DITG ADD PUNTECRIP NUMERIC(24,9);
		ALTER TABLE DITG ADD PUNTECRIP1 NUMERIC(24,9);
		ALTER TABLE DITG ADD PUNECORIP NUMERIC(24,9);
		ALTER TABLE DITG ADD PUNECORIP1 NUMERIC(24,9);

		ALTER TABLE DPUN ADD PUNTEGRIP NUMERIC(24,9);
		ALTER TABLE DPUN ADD COEFFIRIP NUMERIC(24,9);
		perform sp_backupanddropviews('dpun');
		ALTER TABLE DPUN ALTER COLUMN PUNTEG TYPE NUMERIC(24,9);
		perform sp_restoreviews('dpun');

		-- Nuovi campi per Autovie
		ALTER TABLE GAREIDS ADD IMPIDS NUMERIC(24,5);
		ALTER TABLE GAREIDS ADD NOTEIDS VARCHAR(2000);

		ALTER TABLE GARE1 ADD DLETCOM TIMESTAMP;
		ALTER TABLE GARE1 ADD NPLETCOM VARCHAR(20);

		ALTER TABLE GFOF ADD IMPSPE NUMERIC(24,5);
		ALTER TABLE GFOF ADD DLIQSPE TIMESTAMP;

		ALTER TABLE GARECONT ADD NUMCONT VARCHAR(20);

        ALTER TABLE GAREALBO ADD PUBOPE VARCHAR(1);
		
		ALTER TABLE GCAP ADD PERCIVA NUMERIC(2);
		ALTER TABLE DPRE ADD PERCIVA NUMERIC(2);
		

		-- Forzato aggiornamento vincoli NOT NULL in GARALTSOG perchè falliti in precedente aggiornamento (6142to6150)
		if ((SELECT count(*) FROM GARALTSOG) = 0) then
			alter table garaltsog alter column codgar drop not null;
			alter table garaltsog alter column ngara set not null;
		end if;

		-- Inizializza occ. in G1CRIDEF e G1CRIVAL (aggiunto controllo per evitare di lanciare l'insert più volte)
		if ((SELECT coalesce(max(id),0) FROM G1CRIDEF) = 0) then
			insert into g1cridef (id,ngara,necvan,maxpun,formato,modpunti, modmanu) select row_number() over(order by ngara,necvan),ngara,necvan,maxpun,100,1,1 from goev where livpar in (1,2);
			SELECT COALESCE(MAX(id),0) INTO maxid FROM G1CRIDEF;
			INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('G1CRIDEF',maxid);

			insert into g1crival (id,idcridef,ngara,necvan,dittao,coeffi,punteg) select row_number() over(order by g1cridef.id),g1cridef.id,dpun.ngara,dpun.necvan,dpun.dittao,dpun.coeffi,dpun.punteg from dpun,g1cridef  where dpun.ngara=g1cridef.ngara and dpun.necvan=g1cridef.necvan;
			SELECT COALESCE(MAX(id),0) INTO maxid FROM G1CRIVAL;
			INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('G1CRIVAL',maxid);
		end if;

		-- Aggiornamento del campo GOEV.TIPPAR dei sottocriteri col valore del GOEV.TIPPAR del criterio padre
		update goev set tippar= (select g1.tippar from goev g1 where g1.ngara=goev.ngara and g1.necvan=goev.necvan1 and g1.livpar=3 ) where livpar=2;

        --Aggiornamento Tabellati
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1141',1,'Manuale da commissione',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1141',2,'Automatica da sistema',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1142',1,'Coefficiente',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1142',2,'Giudizio',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1143',1,'Data',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1143',2,'Importo',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1143',3,'Lista valori',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1143',4,'Testo',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1143',5,'Numero intero',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1143',6,'Numero decimale',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1143',50,'Offerta complessiva espressa mediante importo',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1143',51,'Offerta complessiva espressa mediante ribasso',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1143',52,'Offerta complessiva espressa mediante prezzi unitari',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1143',100,'Non definito',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1144',1,'Si, dopo esclusione soglia minima ',NULL,2,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1144',2,'Si, prima di esclusione soglia minima',NULL,3,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1144',3,'No',NULL,1,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1145',1,'Riparametrazione punteggio totale',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1145',2,'Riparametrazione punteggi criteri',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1145',3,'Riparametrazione punteggi criteri e punteggio totale',NULL,0,NULL);
        INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1146',1,'Punteggio iniziale',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1146',2,'Punteggio riparametrato',NULL,0,NULL);

		INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z07','1','0.00','Insufficiente (0,00)',NULL,NULL,NULL);
		INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z07','2','0.25','Sufficiente (0,25)',NULL,NULL,NULL);
		INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z07','3','0.50','Discreto (0,50)',NULL,NULL,NULL);
		INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z07','4','0.75','Buono (0,75)',NULL,NULL,NULL);
		INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z07','5','1.00','Ottimo (1,00)',NULL,NULL,NULL);

		INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1z07','OEPV: valori punteggio per giudizio',NULL);
		UPDATE TAB1 SET tab1desc='Inserimento valori offerti e upload di documenti' where tab1cod='A1109' and tab1tip=1;
		UPDATE TAB4 SET tab4desc='Numero cifre decimali del coefficiente del punteggio tecnico e economico' where tab4cod='G1_1' and tab4tip='A1049';

       --Aggiornamento C0CAMPI
		delete from c0campi where c0c_mne_ber in ('G1CFRESPANTICORL','G1NRESPANTICORL');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) values (0,'E',null,'CODFISRESP.ANTICORLOTTI.GARE','G1CFRESPANTICORL','Codice fiscale utente responsabile','Cod.fisc.utente resp','A16',null,null,'Codice fiscale utente responsabile');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) values (0,'E',null,'NOMERESP.ANTICORLOTTI.GARE','G1NRESPANTICORL','Nome utente responsabile','Nome utente respons.','A161',null,null,'Nome');

        delete from c0campi where c0c_mne_ber in ('G1IDCRIDEF','G1NGARACRD','G1NECVACRD','G1DESCRI','G1MAXPUN','G1FORMATO','G1NUMDECI','G1MODPUNTI','G1MODMANU','G1FORMULA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.G1CRIDEF.GARE','G1IDCRIDEF','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.G1CRIDEF.GARE','G1NGARACRD','Codice della gara','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NECVAN.G1CRIDEF.GARE','G1NECVACRD','Numero progressivo del criterio di valutazione','N.criterio valutaz.','N4',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DESCRI.G1CRIDEF.GARE','G1DESCRI','Descrizione','Descrizione','A2000',NULL,'CLOB','Note');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'MAXPUN.G1CRIDEF.GARE','G1MAXPUN','Punteggio massimo previsto','Punteggio massimo ','F8.3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'FORMATO.G1CRIDEF.GARE','G1FORMATO','Formato del valore offerto','Formato val.offerto','A100','A1143',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMDECI.G1CRIDEF.GARE','G1NUMDECI','Numero di decimali ammessi per valore offerto','N.decimali ammessi','N2',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'MODPUNTI.G1CRIDEF.GARE','G1MODPUNTI','Modalità assegnazione punteggio: manuale(1) automatica(2)','Mod.assegnaz.punteg.','A100','A1141',NULL,'Modalità assegnazione punteggio');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'MODMANU.G1CRIDEF.GARE','G1MODMANU','Criterio espress.punteggio manuale: coeffic.(1) giudizio(2)','Crit.punteg.manuale','A100','A1142',NULL,'Punteggio espresso mediante');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'FORMULA.G1CRIDEF.GARE','G1FORMULA','Formula per calcolo punteggio automatico','Formula punteg.autom','A100','A1147',NULL,NULL);

		delete from c0campi where c0c_mne_ber in ('G1IDCRIVAL','G1IDCDEF','G1NGARACRV','G1NECVACRV','G1DITTACRV','G1COEFFCRV','G1PUNTICRV');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.G1CRIVAL.GARE','G1IDCRIVAL','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IDCRIDEF.G1CRIVAL.GARE','G1IDCDEF','Id dettaglio definizione criterio di valutazone','Id dett.definizione','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.G1CRIVAL.GARE','G1NGARACRV','Codice della gara','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NECVAN.G1CRIVAL.GARE','G1NECVACRV','Numero progressivo del criterio di valutazione','N.criterio valutaz.','N2',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DITTAO.G1CRIVAL.GARE','G1DITTACRV','Codice ditta partecipante alla gara','Codice ditta','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'COEFFI.G1CRIVAL.GARE','G1COEFFCRV','Coefficiente applicato per il calcolo del punteggio','Coefficiente','F13.9',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUNTEG.G1CRIVAL.GARE','G1PUNTICRV','Punteggio assegnato alla ditta','Punteggio','F13.9',NULL,NULL,NULL);

		delete from c0campi where c0c_mne_ber in ('G1RIPTEC','G1RIPCRITEC','G1RIPECO','G1RIPCRIECO','G1METPUNTI');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'RIPTEC.GARE1.GARE','G1RIPTEC','Riparametrazione punteggio tecnico?','Riparametr.punt.tec?','A100','A1144',NULL,'Riparametrazione punteggio tecnico?');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'RIPCRITEC.GARE1.GARE','G1RIPCRITEC','Criterio riparametrazione punteggio tecnico','Crit.ripar.punt.tec?','A100','A1145',NULL,'Criterio');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'RIPECO.GARE1.GARE','G1RIPECO','Riparametrazione punteggio economico?','Riparametr.punt.eco?','A100','A1144',NULL,'Riparametrazione punteggio economico?');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'RIPCRIECO.GARE1.GARE','G1RIPCRIECO','Criterio riparametrazione punteggio economico','Crit.ripar.punt.eco?','A100','A1145',NULL,'Criterio');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'METPUNTI.GARE1.GARE','G1METPUNTI','Tipo punteggio da considerare nel calcolo aggiudic.per OEPV','Tipo punteg.agg.OEPV','A100','A1146',NULL,'Punteggio considerato nel calcolo');
		   
		delete from c0campi where c0c_mne_ber in ('G1_PUNTRIP','G1_COEFRIP');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUNTEGRIP.DPUN.GARE','G1_PUNTRIP','Punteggio ottenuto dall''impresa riparametrato','Punteggio riparam.','F13.9',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'COEFFIRIP.DPUN.GARE','G1_COEFRIP','Coefficiente punteggio riparametrato','Coeffic.riparam.','F13.9',NULL,NULL,NULL);

		delete from c0campi where c0c_mne_ber in ('G1PUNTERIP','G1PUNTERI1','G1PUNECRIP','G1PUNECRI1');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUNTECRIP.DITG.GARE','G1PUNTERIP','Punteggio totale tecnico riparametrato','Punt.tecnico riparam','F13.9',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUNTECRIP1.DITG.GARE','G1PUNTERI1','Punteggio totale tecnico riparametrato intermedio','Punt.tecnico rip.int','F13.9',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUNECORIP.DITG.GARE','G1PUNECRIP','Punteggio totale economico riparametrato','Punt.econom.riparam.','F13.9',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUNECORIP1.DITG.GARE','G1PUNECRI1','Punteggio totale economico riparametrato intermedio','Punt.econom.rip.int.','F13.9',NULL,NULL,NULL);

		delete from c0campi where c0c_mne_ber in ('G1IMPIDS','G1NOTEIDS','G1IMPSPE','G1DLIQSPE','G1DLETCOM','G1NPLETCOM','G1NUMCONT');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPIDS.GAREIDS.GARE','G1IMPIDS','Importo dell''impegno di spesa','Importo imp.di spesa','F15',NULL,'MONEY','Importo');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NOTEIDS.GAREIDS.GARE','G1NOTEIDS','Eventuali note','Note','A2000',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPSPE.GFOF.GARE','G1IMPSPE','Importo rimborso spese','Importo rimbor.spese','F15',NULL,'MONEY','Importo rimborso spese');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DLIQSPE.GFOF.GARE','G1DLIQSPE','Data liquidazione rimborso spese','Data liquid.rimb.sp.','A10',NULL,'DATA_ELDA','Data liquidazione rimborso spese');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DLETCOM.GARE1.GARE','G1DLETCOM','Pagamento della commissione di gara: data lettera','Data lettera pag.com','A10',NULL,'DATA_ELDA','Data lettera');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NPLETCOM.GARE1.GARE','G1NPLETCOM','Pagamento della commissione di gara: n.prot.lettera','N.prot.lett.pag.comm','A20',NULL,NULL,'Num.prot.lettera');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMCONT.GARECONT.GARE','G1NUMCONT','Numero di contratto','Num. contratto','A20',NULL,NULL,'Numero contratto');

        delete from c0campi where c0c_mne_ber in ('G1PUBOPE');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUBOPE.GAREALBO.GARE','G1PUBOPE','Pubblica lista operatori abilitati su portale Appalti?','Lista oper.su port.?','A2',NULL,'SN','Pubblica lista operatori su portale Appalti?');
			
       delete from c0campi where c0c_mne_ber in ('G1_PERCIVAG','G1_PERCIVAD','G1PERCIVAEFF_P');
	   INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PERCIVA.GCAP.GARE','G1_PERCIVAG','Aliquota IVA','Aliquota IVA','N2',NULL,'PRC',NULL);
	   INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PERCIVA.DPRE.GARE','G1_PERCIVAD','Aliquota IVA indicata dalla ditta','Aliquota IVA','N2',NULL,'PRC',NULL);
	   INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PERCIVAEFF.V_GCAP_DPRE.GARE','G1PIVAEFF_P','Aliquota IVA','Aliquota IVA','N2',NULL,'PRC',NULL);

		update C0CAMPI set C0C_FS='F13.9' where C0C_MNE_BER='G1_PUNTIP';
		update C0CAMPI set COC_DES_WEB='Offerta presentata su portale mediante' where C0C_MNE_BER='G1OFFTEL';

		   --Aggiornamento C0ENTIT
		delete from c0entit where c0e_nom in ('G1CRIDEF.GARE','G1CRIVAL.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('G1CRIDEF.GARE',0,'E','CRIT_DEFIN','Dettaglio definizione criterio di valutazione per OEPV','NGARA.G1CRIDEF.GARE,NECVAN.G1CRIDEF.GARE','GOEV.GARE','NGARA.GOEV.GARE,NECVAN.GOEV.GARE',NULL,NULL,'g1_disa0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('G1CRIVAL.GARE',0,'E','CRIT_VALOR','Dettaglio valore offerto per criterio di valutazione OEPV','NGARA.G1CRIVAL.GARE,NECVAN.G1CRIVAL.GARE,DITTAO.G1CRIVAL.GARE','DPUN.GARE','NGARA.GOEV.GARE,NECVAN.GOEV.GARE,DITTAO.DPUN.GARE',NULL,NULL,'g1_criv0');

		--Aggiornamento profili
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.G1CRIDEF-scheda','Dettaglio modalita'' assegnazione punteggio criterio di valutazione',3292);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.G1CRIDEF-scheda.DATGEN','Dati generali',3294);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.G1CRIDEF-scheda.SCHEDAMOD','Modifica dettaglio',3288);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.GOEV-dettaglioValutazioneTecEco-lista','Dettaglio valutazione tecnica o economica della ditta',3294);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GOEV-dettaglioValutazioneTecEco-lista.AssegnaCoefficente','Funzione Assegna coefficente dettaglio valutazione tecnica o economica',13370);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.FASIGARA.CalcoloPunteggi','Funzione Calcolo punteggi - OEPV',13380);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.FASIGARA.EsclusioneSoglia','Funzione Esclusione soglia minima e riparametrazione - OEPV',13390);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.FASIGARA.AnnullaCalcoloPunteggi','Funzione Annulla calcolo punteggi - OEPV',13400);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.GARE-scheda.CRITERI.SCHEDAMOD','Modifica sezione "Punteggio totale, soglie minime e riparametrazione"',3277);

		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('COLS', 'VIS', 'GARE.GARE1.DLETCOM', 'Visualizza', 0, 1, 1, 3330735457);
		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('COLS', 'VIS', 'GARE.GARE1.NPLETCOM', 'Visualizza', 0, 1, 1, 1305257381);
		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('COLS', 'VIS', 'GARE.GFOF.IMPSPE', 'Visualizza', 0, 1, 1, 2903368460);
		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('COLS', 'VIS', 'GARE.GFOF.DLIQSPE', 'Visualizza', 0, 1, 1, 4020132448);
		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('COLS', 'VIS', 'GARE.GARECONT.NUMCONT', 'Visualizza', 0, 1, 1, 746673093);
		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('COLS', 'VIS', 'GARE.GCAP.PERCIVA', 'Visualizza', 0, 1, 1, 2212955384);
		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('COLS', 'VIS', 'GARE.DPRE.PERCIVA', 'Visualizza', 0, 1, 1, 356460494);
		INSERT INTO W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('COLS', 'VIS', 'GARE.V_GCAP_DPRE.PERCIVAEFF', 'Visualizza', 0, 1, 1, 3435865664);
		
		--Personalizzazione Cineca
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cineca.ws.SoggettoCollettivo.url',NULL,'Personalizzazione Cineca','URL  di accesso al servizio Cineca',NULL);
		--W_GENCHIAVI: nuovo record
		INSERT INTO W_GENCHIAVI (TABELLA, CHIAVE) VALUES ('GARE.CODCIG',0);
           
		-- (S.Santi 12.07.2017) Aggiunto C.F. e nome del responsabile del lotto
		-- (S.Santi 27.09.2017) Aggiunto campi relativi a accordo quadro per controlli in fase di popolazione adempimento
		perform sp_backupanddropviews('v_dati_lotti_completa');
		IF exists (select tablename from pg_tables where upper(tablename) = 'APPA') THEN
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   torn.aqoper,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20)))
		   union
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   torn.aqoper,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
		   union
			 select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
			    null altrisog,
			    null accqua,
			    null aqoper,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
			    torn.dteoff,
			    tecni.cftec codfisresp,
			    tecni.nomtec nomeresp
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where gare.genere=4';
		else
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   torn.aqoper,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20)))
		  union
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   torn.aqoper,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
		   union
			select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
			    null altrisog,
			    null accqua,
			    null aqoper,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
			    torn.dteoff,
			    tecni.cftec codfisresp,
			    tecni.nomtec nomeresp
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where gare.genere=4';
		end if;
		perform sp_restoreviews('v_dati_lotti_completa');

		perform sp_backupanddropviews('v_gare_torn');
		-- (S.Santi 04.09.2017) Modificato criterio per stabilire se gara a lotti aggiudicata: tutti i lotti devono essere conclusi e almeno uno aggiudicato 
		--   (la precedente condizione era che tutti i lotti fossero aggiudicati - richiesta Publisys).
		--
		create or replace view v_gare_torn as 
		with
		--n.lotti di ogni gara
		lotti
		as (
		select codgar1, array_to_string(array_agg(gare.codcig),',') codciglotti, count(*) numlotti from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati senza esito negativo
		lottiagg
		as (
		select codgar1, count(*) numlottiagg from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null and esineg is null
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati e con contratto stipulato senza esito negativo
		lottistip
		as (
		select codgar1, count(*) numlottistip from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null and esineg is null and daatto is not null
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati o con esito negativo
		lotticonc
		as (
		select codgar1, count(*) numlotticonc from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null or esineg is not null
		group by codgar1
		)
		select codgar, codgar as codice, tipgen, destor as oggetto, imptor as importo, tipgar, 
			cast('1' as varchar(1)) as islotti, (case when gare.genere=3 then 3 else 1 end) as genere, isarchi,
			case when (lotti.numlotti>0 and lottiagg.numlottiagg>0 and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu,
			case when (lotti.numlotti>0 and lottistip.numlottistip>0 and lottiagg.numlottiagg=lottistip.numlottistip and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isstipula,
			case when (lotti.numlotti>0 and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as islotticonclusi,
			(case when gare.genere=3 then gare.esineg else torn.esineg end) as esineg, lotti.codciglotti as codcig, profiloweb, gartel
		from torn 
			left outer join gare on (codgar=gare.ngara and gare.genere=3) 
			left outer join lotti on (lotti.codgar1=torn.codgar)
			left outer join lottiagg on (lottiagg.codgar1=torn.codgar)
			left outer join lottistip on (lottistip.codgar1=torn.codgar)
			left outer join lotticonc on (lotticonc.codgar1=torn.codgar)
			where codgar not like '$%' 
		union
		select torn.codgar, gare.ngara as codice, torn.tipgen, gare.not_gar as oggetto, gare.impapp as importo, gare.tipgarg,
			cast('2' as varchar(1)) as islotti, 2 as genere, torn.isarchi, 
			case when (gare.ditta is not null and gare.esineg is null) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu, 
			case when (gare.ditta is not null and gare.daatto is not null and gare.esineg is null) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isstipula, 
			null as islotticonclusi,
			gare.esineg, gare.codcig, torn.profiloweb, torn.gartel
			from gare,torn 
			where torn.codgar=gare.codgar1 and torn.codgar like '$%' and (gare.genere is null or (gare.genere not in (4,10,11,20)));
		perform sp_restoreviews('v_gare_torn');
		
		perform sp_backupanddropviews('v_gcapd');
		-- (C.Febas 20.09.2017) Aggiunto l'attributo PERCIVA per la gestione 
		-- della percentuale iva offerta dalla ditta
		create or replace view v_gcapd as
		  select gcap.ngara,gcap.contaf,gcap.norvoc,gcap.codvoc,gcap.unimis,gcap.quanti,gcap.prezun,
			gcap.perciva,gcap.clasi1,gcap.numpar,gcap.voce,gcap.solsic,gcap.sogrib,gcap.dittao,
			ditg.dittao as cod_ditta, ditg.codgar5 as codgar, gare.codiga
		  from gcap, ditg, gare
		  where gcap.ngara=ditg.ngara5 and (gcap.dittao is null or gcap.dittao=ditg.dittao)
		    and gcap.ngara=gare.ngara;
   		perform sp_restoreviews('v_gcapd');

		perform sp_backupanddropviews('v_gcap_dpre');
		-- (C.Febas 20.09.2017) Aggiunto l'attributo PERCIVAEFF per la gestione 
		-- della percentuale iva offerta dalla ditta
		create or replace view v_gcap_dpre as
		  select (case when v_gcapd.dittao is null then '2' else '1' end) as issoloditta,
		   (case when v_gcapd.quanti=dpre.quanti or dpre.quanti is null then '2' else '1' end) as isquantimod,
		   v_gcapd.codgar, v_gcapd.ngara, v_gcapd.codiga, v_gcapd.contaf, v_gcapd.cod_ditta, v_gcapd.norvoc, v_gcapd.codvoc, v_gcapd.voce, 
		   v_gcapd.solsic, v_gcapd.sogrib, v_gcapd.unimis, dpre.quanti,
		   (case when dpre.unimis is null then v_gcapd.unimis else dpre.unimis end) as unimiseff, 
		   (case when dpre.quanti is null then v_gcapd.quanti else dpre.quanti end) as quantieff, 
		   (case when v_gcapd.solsic='1' or v_gcapd.sogrib='1' then v_gcapd.prezun else dpre.preoff end) as preoff, 
		   (case when dpre.perciva is null then v_gcapd.perciva else dpre.perciva end) as percivaeff, 
		   (case when v_gcapd.solsic='1' or v_gcapd.sogrib='1' then round(v_gcapd.prezun*v_gcapd.quanti,5) else dpre.impoff end) as impoff,
		   dpre.reqmin as reqmin			       
		from v_gcapd left outer join dpre on v_gcapd.cod_ditta=dpre.dittao and v_gcapd.ngara=dpre.ngara and v_gcapd.contaf=dpre.contaf;
   		perform sp_restoreviews('v_gcap_dpre');
	
		update eldaver set numver = '6.16.5', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.5', datvet = now() where codapp = 'G1';

  	    --Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,50,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0' 
		and exists(select w_accpro.cod_profilo 
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo 
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.5' or numver like '6.16.5%')) THEN

        --Definizione nuovi campi
		ALTER TABLE GAREALBO ADD CTRLAGGIU NUMERIC(7);
		ALTER TABLE GAREALBO ADD CTRLIMP NUMERIC(24,5);
		ALTER TABLE GAREALBO ADD CTRLGG NUMERIC(5);
		ALTER TABLE GAREALBO ADD CTRLELE VARCHAR(1);
		ALTER TABLE GAREALBO ADD CTRLIMPGA VARCHAR(1);
		ALTER TABLE GAREALBO ADD CTRLDATA TIMESTAMP;

         ALTER TABLE DITG ADD IAGGIUELE NUMERIC(24,5);
         ALTER TABLE DITG ADD DPRDOM TIMESTAMP;
         ALTER TABLE DITG ADD DPROFF TIMESTAMP;

        --Aggiornamento Tabellati
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1148',1,'Attivo con blocco selezione in gara',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1148',2,'Attivo senza blocco selezione in gara',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1148',3,'Non attivo',NULL,0,NULL);

 		-- Comunicazioni pubbliche. Valorizzata la data pubblicazione(COMDATAPUB) con la data inserimento (COMDATINS)
		UPDATE W_INVCOM SET COMDATAPUB = COMDATINS WHERE COMDATAPUB IS NULL and COMPUB = 1 and COMSTATO = 3 and IDPRG = 'PG';
		
       --Aggiornamento C0CAMPI
		delete from c0campi where c0c_mne_ber in ('G1CTRLAGGIU','G1CTRLIMP','G1CTRLGG','G1CTRLELE','G1CTRLIMPGA','G1CTRLDATA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CTRLAGGIU.GAREALBO.GARE','G1CTRLAGGIU','Controllo su importo aggiudicato dell''operatore nel periodo','Contr.su imp.agg.op.','A100','A1148',NULL,'Controllo su importo aggiudicato operatore nel periodo');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CTRLIMP.GAREALBO.GARE','G1CTRLIMP','Controllo su importo aggiudicato:importo limite','Limite importo agg.','F15',NULL,'MONEY','Limite importo aggiudicato');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CTRLGG.GAREALBO.GARE','G1CTRLGG','Controllo su importo aggiudicato:periodo espresso in giorni','N.gg.periodo contr.','N5',NULL,NULL,'N.gg. periodo di controllo');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CTRLELE.GAREALBO.GARE','G1CTRLELE','Controllo su importo aggiudicato:solo proced.dell''elenco?','Contr.solo elenco?','A2',NULL,'SN','Considera solo le procedure collegate all''elenco?');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CTRLIMPGA.GAREALBO.GARE','G1CTRLIMPGA','Controllo su importo aggiudicato:includi base di gara? ','Includi base gara?','A2',NULL,'SN','Includi nel controllo l''importo a base di gara della procedura?');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CTRLDATA.GAREALBO.GARE','G1CTRLDATA','Controllo su importo aggiudicato:data-ora conteggio imp.agg.','Data conteggio imp.','A19',NULL,'TIMESTAMP',NULL);

		delete from c0campi where c0c_mne_ber in ('G1IAGGIUELE','G1DPRDOM','G1DPROFF');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IAGGIUELE.DITG.GARE','G1IAGGIUELE','Importo aggiudicato complessivo nel periodo per elenco op.','Imp.aggiud.periodo','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DPRDOM.DITG.GARE','G1DPRDOM','Data-ora protocollo presentazione domanda di partecipazione','Data prot.dom.part.','A19',NULL,'TIMESTAMP','Data protocollo');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DPROFF.DITG.GARE','G1DPROFF','Data-ora protocollo di presentazione dell''offerta','Data prot.pres.off.','A19',NULL,'TIMESTAMP','Data protocollo');

		delete from c0campi where c0c_mne_ber in ('IAGGIUELE_VDE','IAGGIUELE_VDA','IAGGIUELE_VDS');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IAGGIUELE.V_DITTE_ELECAT.GARE','IAGGIUELE_VDE','Importo aggiudicato complessivo nel periodo per elenco op.','Imp.aggiud.periodo','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IAGGIUELE.V_DITTE_ELECAT_SA.GARE','IAGGIUELE_VDA','Importo aggiudicato complessivo nel periodo per elenco op.','Imp.aggiud.periodo','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IAGGIUELE.V_DITTE_ELESUM.GARE','IAGGIUELE_VDS','Importo aggiudicato complessivo nel periodo per elenco op.','Imp.aggiud.periodo','F15',NULL,'MONEY',NULL);

	   update C0CAMPI set COC_DES='Tipo punteggio considerato nel calcolo soglia anom.per OEPV',COC_DES_FRM='Tipo punt.anom.OEPV',COC_DES_WEB='Punteggio considerato nel calcolo soglia anomalia' where C0C_MNE_BER='G1METPUNTI';
	   update C0CAMPI set COC_DES_WEB='N.protocollo' where C0C_MNE_BER in ('G1NPRDOM','G1NPROFF');
	   update C0CAMPI set COC_DES_WEB='Data presentazione dom.partecipaz.' where C0C_MNE_BER ='DRICIND';
	   update C0CAMPI set COC_DES_WEB='Data presentazione offerta' where C0C_MNE_BER ='G1DATOFF';

        --Aggiornamento profili
	    INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.DITG-listaImportoAggiudicatoOperatori','Prospetto importo aggiudicato nel periodo in elenco operatori',6165);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.DITG-listaImportoAggiudicatoOperatori.ConteggioImporto','Conteggio importo aggiudicato nel periodo',13420);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FascicoloDocumentale','Funzione Fascicolo documentale',13430);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.WSDM-scheda','Fascicolo documentale',13440);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.WSDM-scheda.AssociaFascicoloEsistente','Associa fascicolo esistente',13450);

		-- Nuova opzione per form di registrazione e recupera password
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','registrazione.loginCF',null,'Form registrazione','Forza la valorizzazione del campo login con il codice fiscale del soggetto. Valori ammessi: 0 [default] = login libera, 1 = login codice fiscale',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','it.eldasoft.password.recupera','0','Form login','Richiesta recupera password',null);

		--Aggiornamento view
        perform sp_backupanddropviews('v_ditte_elecat');
        --(M.C. 04/10/2017) Aggiunto campo IAGGIU.DITG
        create or replace view v_ditte_elecat (gara, codice, ragsoc, locimp, proimp, numord, iaggiuele, numinv, numpen, numalt, numir, numip,
			codcat, infnumclass, supnumclass,
			numclass, numinvcla, numpencla, numaltcla, numircla, numipcla,
			numinvtot, numpentot, numalttot, numirtot, numiptot) as
    	with totali as
		(select iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp,
				sum(case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) numinv,
					sum(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) numpen,
					sum(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt,
					sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
						(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) + 
						(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numir,
					sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
						(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numip
			from iscrizcat
			group by codgar, ngara, codimp)
		select gare.ngara, ditg.dittao, ditg.nomimo, impr.locimp, impr.proimp, ditg.numordpl, ditg.iaggiuele,
				(case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end),
				(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end), 
				(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end), 
				(case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
				(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) + 
				(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end),
				(case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
				(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end),
				iscrizcat.codcat, iscrizcat.infnumclass, iscrizcat.supnumclass,
				iscrizclassi.numclass,
				(case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end),
				(case when (iscrizclassi.invpen is null) then 0 else iscrizclassi.invpen end), 
				(case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end), 
				(case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end) + 
				(case when (iscrizclassi.invpen is null) then 0 else iscrizclassi.invpen end) +
				(case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end),
				(case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end) + 
				(case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end),
			totali.numinv, totali.numpen, totali.numalt,
			totali.numir, totali.numip
		from ditg inner join gare on (ditg.codgar5=gare.codgar1 and ditg.ngara5=gare.ngara)
			inner join impr on (ditg.dittao=impr.codimp)
			inner join iscrizcat on (ditg.codgar5=iscrizcat.codgar and ditg.ngara5=iscrizcat.ngara and ditg.dittao=iscrizcat.codimp)
			inner join totali on (ditg.codgar5=totali.codgar and ditg.ngara5=totali.ngara and ditg.dittao=totali.codimp)
			left outer join iscrizclassi on (iscrizcat.codgar=iscrizclassi.codgar and iscrizcat.ngara=iscrizclassi.ngara 
				and iscrizcat.codimp=iscrizclassi.codimp and iscrizcat.codcat=iscrizclassi.codcat and iscrizcat.tipcat=iscrizclassi.tipcat)
		where gare.codgar1 like '$%' and gare.genere in (10,20) 
			and ditg.abilitaz=1 and (ditg.dabilitaz is not null) and ditg.numordpl is not null;
        perform sp_restoreviews('v_ditte_elecat');

        perform sp_backupanddropviews('v_ditte_elecat_sa');
        --(M.C. 04/10/2017) Aggiunto campo IAGGIU.DITG
        create or replace view v_ditte_elecat_sa (gara, codice, ragsoc, locimp, proimp, numord, iaggiuele, numinv, numpen, numalt, numir, numip,
			cenint, codcat, tipcat, infnumclass, supnumclass, numclass, 
			numinvtot, numpentot, numalttot, numirtot, numiptot) as
		with
		totali_altpen as 
			(select iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp, 
				sum(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt
			from iscrizcat
			group by codgar, ngara, codimp),
		totali_sa as
			(select iscrizuff.cenint, iscrizuff.codgar, iscrizuff.ngara, iscrizuff.codimp, 
				sum(case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) numinv, 
				sum(case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end) numpen,
				sum((case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
					(case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end)) numirnoalt
			from iscrizuff 
			group by iscrizuff.cenint, iscrizuff.codgar, iscrizuff.ngara, iscrizuff.codimp)
		select gare.ngara, ditg.dittao, ditg.nomimo, impr.locimp, impr.proimp, ditg.numordpl, ditg.iaggiuele,
				(case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end),
				(case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end), 
				(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end), 
				(case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
				(case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end) + 
				(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end),
				(case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
				(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end),
				uffint.codein, iscrizcat.codcat, iscrizcat.tipcat, iscrizcat.infnumclass, iscrizcat.supnumclass,
				iscrizclassi.numclass,
				(case when (totali_sa.numinv is null) then 0 else totali_sa.numinv end),
				(case when (totali_sa.numpen is null) then 0 else totali_sa.numpen end),
				totali_altpen.numalt,
				(case when (totali_sa.numirnoalt is null) then totali_altpen.numalt else totali_sa.numirnoalt + totali_altpen.numalt end),
				(case when (totali_sa.numinv is null) then totali_altpen.numalt else totali_sa.numinv + totali_altpen.numalt end)
			from ditg inner join gare on (ditg.codgar5=gare.codgar1 and ditg.ngara5=gare.ngara)
				inner join impr on (ditg.dittao=impr.codimp)
				inner join iscrizcat on (ditg.codgar5=iscrizcat.codgar and ditg.ngara5=iscrizcat.ngara and ditg.dittao=iscrizcat.codimp)
				inner join uffint on (1=1)
				left outer join iscrizuff on (uffint.codein=iscrizuff.cenint and iscrizuff.codgar=iscrizcat.codgar and iscrizuff.ngara=iscrizcat.ngara 
								and iscrizuff.codimp=iscrizcat.codimp and iscrizuff.codcat=iscrizcat.codcat and iscrizuff.tipcat=iscrizcat.tipcat)
				left outer join totali_sa on (uffint.codein=totali_sa.cenint and ditg.codgar5=totali_sa.codgar and ditg.ngara5=totali_sa.ngara and ditg.dittao=totali_sa.codimp)
				inner join totali_altpen on (ditg.codgar5=totali_altpen.codgar and ditg.ngara5=totali_altpen.ngara and ditg.dittao=totali_altpen.codimp)
				left outer join iscrizclassi on (iscrizcat.codgar=iscrizclassi.codgar and iscrizcat.ngara=iscrizclassi.ngara 
					and iscrizcat.codimp=iscrizclassi.codimp and iscrizcat.codcat=iscrizclassi.codcat and iscrizcat.tipcat=iscrizclassi.tipcat)
			where gare.codgar1 like '$%' and gare.genere in (10,20) 
			and ditg.abilitaz=1 and (ditg.dabilitaz is not null) and ditg.numordpl is not null;
		perform sp_restoreviews('v_ditte_elecat_sa');

        perform sp_backupanddropviews('v_ditte_elesum');
        --(M.C. 04/10/2017) Aggiunto campo IAGGIU.DITG
        create or replace view v_ditte_elesum (gara, codice, ragsoc, locimp, proimp, numord, iaggiuele, numinv, numpen, numalt, numir, numip) as
			(select gare.ngara, ditg.dittao, ditg.nomimo, impr.locimp, impr.proimp, ditg.numordpl, ditg.iaggiuele,
						sum(case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end), 
						sum(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end),
						sum(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end),
						sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
							(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) + 
							(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)),
						sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
							(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end))
			from ditg, impr, iscrizcat, gare 
			where  ditg.codgar5=gare.codgar1 and ditg.ngara5=gare.ngara 
			and ditg.dittao=impr.codimp
			and ditg.codgar5=iscrizcat.codgar and ditg.ngara5=iscrizcat.ngara and ditg.dittao=iscrizcat.codimp 
			and gare.genere in (10,20)
			and ditg.abilitaz=1 and (ditg.dabilitaz is not null) and ditg.numordpl is not null
			group by gare.ngara, ditg.dittao, ditg.nomimo, impr.locimp, impr.proimp, ditg.numordpl, ditg.iaggiuele);
        perform sp_restoreviews('v_ditte_elesum');
		
		-- (S.Santi 11.10.2017) View L190/2012: introdotta view intermedia per personalizzazione importo liquidato e introduzione di eventuali filtri
		create or replace view V_DATI_LOTTI_COMPLETA_CUSTOM as 
			select v_dati_lotti_completa.*, v_dati_lotti_completa.impsommeliq impsommeliq_custom from V_DATI_LOTTI_COMPLETA;

		perform sp_backupanddropviews('v_dati_lotti');
		create or replace view V_DATI_LOTTI as 
			select lotto,cig,datpub,codiceprop,codfiscprop,denomprop,oggetto,tipgarg,iterga,impaggiudic,dinvit,aggiudicataria,esineg,datneg,dattoa,
				altrisog,accqua,aqoper,datainizio,dataultimazione,impsommeliq_custom impsommeliq,dteoff,codfisresp,nomeresp
			from V_DATI_LOTTI_COMPLETA_CUSTOM where
				DATPUB >= TO_DATE('01/12/2012','dd/mm/yyyy') or (DATPUB is null and DINVIT >= TO_DATE('01/12/2012','dd/mm/yyyy'))
				or (DATPUB is null and DINVIT is null and DATTOA >= TO_DATE('01/12/2012','dd/mm/yyyy'))
				or (DATPUB is null and DINVIT is null and DATTOA is null and DATNEG >= TO_DATE('01/12/2012','dd/mm/yyyy'));
		perform sp_restoreviews('v_dati_lotti');


		update eldaver set numver = '6.16.6', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.6', datvet = now() where codapp = 'G1';
	
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,50,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';
	
		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.6' or numver like '6.16.6%')) THEN
               
        --Definizione nuovi campi
        ALTER TABLE GOEV ADD ISNOPRZ VARCHAR(1);
	    ALTER TABLE DITG ADD PUNTPRZ NUMERIC(24,9);
	    ALTER TABLE DITG ADD PUNTALT NUMERIC(24,9);

		--Reso configurabile tab.A1081
		UPDATE tab1 SET tab1mod='1' WHERE tab1cod='A1081' and tab1tip=1;
		INSERT INTO TAB6 (TAB6COD,TAB6TIP,TAB6DESC) VALUES ('G1_1','A1081','Tipologia di avviso');

                --Aggiornamento Tabellati
        INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1149',1,'0   Punteggio prezzo(1) Punteggio economico(0)',NULL,0,NULL);
        INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1149','OEPV: calcolo soglia anomalia su punteggio prezzo o su punteggio economico',NULL);

		-- Blocco aggiornamento attivato nella patch 6.16.6.a
		IF not exists (SELECT * FROM pg_views WHERE viewname='v_gare_termini') THEN
			delete from c0campi where c0c_mne_ber in ('G1CODGAR_STL','G1CODICE_STL','G1GENERE_STL','G1OGGETTO_STL','G1CODSTA_STL','G1STATO_STL','G1ESITO_STL');
			INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODGAR.V_GARE_STATOESITOLOTTI.GARE','G1CODGAR_STL','Cod.gara divisa in lotti o cod.fittizio gara a lotto unico','Codice gara interno','A21',NULL,NULL,NULL);
			INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','CODICE.V_GARE_STATOESITOLOTTI.GARE','G1CODICE_STL','Codice lotto di gara','Codice lotto di gara','A21',NULL,NULL,NULL);
			INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'GENERE.V_GARE_STATOESITOLOTTI.GARE','G1GENERE_STL','Genere del lotto di gara','Genere lotto','A100','A1063',NULL,NULL);
			INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'OGGETTO.V_GARE_STATOESITOLOTTI.GARE','G1OGGETTO_STL','Oggetto del lotto','Oggetto','A2000',NULL,'NOTE',NULL);
			INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODSTATO.V_GARE_STATOESITOLOTTI.GARE','G1CODSTA_STL','Codice stato del lotto','Codice stato','N2',NULL,NULL,NULL);
			INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'STATO.V_GARE_STATOESITOLOTTI.GARE','G1STATO_STL','Stato del lotto','Stato','A100',NULL,NULL,NULL);
			INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ESITO.V_GARE_STATOESITOLOTTI.GARE','G1ESITO_STL','Esito del lotto','Esito','A100',NULL,NULL,NULL);

			--Aggiornamento C0CAMPI
                         delete from c0campi where c0c_mne_ber in ('G1_ISNOPRZ','G1PUNTPRZ','G1PUNTALT');
                         INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ISNOPRZ.GOEV.GARE','G1_ISNOPRZ','Criterio econ.,ai fini calc.anomalia,non relativo al prezzo?','Crit.econ.non prezzo','A2',NULL,'SN','Ai fini del calcolo soglia anomalia, criterio relativo a');
        	         INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUNTPRZ.DITG.GARE','G1PUNTPRZ','Punteggio totale relativo al prezzo','Punteggio prezzo','F13.9 ',NULL,NULL,NULL);
        	         INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUNTALT.DITG.GARE','G1PUNTALT','Punteggio totale relativo ad altri elementi di valutazione','Punteggio altri elem','F13.9',NULL,NULL,NULL);

                        delete from c0entit where c0e_nom = 'V_GARE_STATOESITOLOTTI.GARE';
			INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('V_GARE_STATOESITOLOTTI.GARE',0,'E','STATO_LOTT','Lista lotti con dettaglio stato ed esito','CODICE.V_GARE_STATOESITOLOTTI.GARE','GARE.GARE','NGARA.GARE.GARE',NULL,NULL,'g1_lost0');
			UPDATE C0ENTIT SET COE_ARG='STATO_GARE' where c0e_nom='V_GARE_STATOESITO.GARE';

			 --Parametro per attivare flag 'Richiesta firma?' nei documenti di gara - parametro giÃ  inserito nella patch 6.16.6.a
			INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','documentiDb.richiestaFirma',NULL,'Richiesta firma documenti','Attivazione gestione richiesta firma digitale per i documenti su database. Impostare a 1 per attivare la gestione.',NULL);
			
			-- (S.Santi 27.11.2017) Ottimizzato view V_GARE_STATOESITO: creato view di appoggio V_GARE_TERMINI 
			--  e spostato esito lotti nella nuova view V_GARE_STATOESITOLOTTI
			create or replace view v_gare_termini as
				select codgar,iterga,
					case when iterga in (2,4) then 
						case when dtepar is not null then
							  to_timestamp(to_char(dtepar,'YYYY/MM/DD') || ' ' || 
							 case when otepar is not null and length(otepar)=5  
							 and (to_number(substr(otepar,1,2),'9999D0000') between 0 and 23)
							 and (to_number(substr(otepar,4,2),'9999D0000') between 0 and 60)
							 and substr(otepar,3,1)=':' 
							 then otepar || ':59' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
						else null end
					else 
						case when dteoff is not null then 
							to_timestamp(to_char(dteoff,'YYYY/MM/DD') || ' ' || 
							 case when oteoff is not null and length(oteoff)=5  
							 and (to_number(substr(oteoff,1,2),'9999D0000') between 0 and 23)
							 and (to_number(substr(oteoff,4,2),'9999D0000') between 0 and 60)
							 and substr(oteoff,3,1)=':' 
							 then oteoff || ':59' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
						else NULL end
					end dataoratermine
				from torn;

			perform sp_backupanddropviews('v_gare_statoesito');
			create or replace view v_gare_statoesito as
				select v_gare_torn.codgar, v_gare_torn.codice, v_gare_torn.tipgen genere, v_gare_torn.oggetto,
					 case when dataoratermine is not null and dataoratermine >= now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
							and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 1
						  when dataoratermine is not null and dataoratermine < now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
							and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 2
						  when v_gare_torn.esineg is not null or v_gare_torn.isaggiu='1' or v_gare_torn.islotticonclusi='1' then 3
						  else null end codstato,
					 case when dataoratermine is not null and dataoratermine >= now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
							and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 'In corso'
						  when dataoratermine is not null and dataoratermine < now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
							and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 'In aggiudicazione'
						  when v_gare_torn.esineg is not null or v_gare_torn.isaggiu='1' or v_gare_torn.islotticonclusi='1' then 'Conclusa'
						  else null end stato,
					  case when v_gare_torn.esineg is not null then (select tab1desc from tab1 where tab1cod='A1088' and tab1tip=v_gare_torn.esineg)
						  when v_gare_torn.isaggiu='1' and v_gare_torn.isstipula='1' then 'Emesso contratto/ordine' 
						  when v_gare_torn.isaggiu='1' then 'Aggiudicata' end esito
				from v_gare_torn 
					inner join v_gare_termini on (v_gare_torn.codgar=v_gare_termini.codgar);
			perform sp_restoreviews('v_gare_statoesito');

			create or replace view v_gare_statoesitolotti as
				select gare.codgar1, gare.ngara codice, 
					 case when exists (select B.ngara from gare B where gare.codgar1=B.ngara and B.genere=3) then '300' else '100' end genere,
					 gare.not_gar oggetto,
					 case when dataoratermine is not null and dataoratermine >= now() and gare.ditta is null and gare.esineg is null then 1
						  when dataoratermine is not null and dataoratermine < now() and gare.ditta is null and gare.esineg is null then 2
						  when gare.ditta is not null or gare.esineg is not null then 3
						  else null end codstato,
					 case when dataoratermine is not null and dataoratermine >= now() and gare.ditta is null and gare.esineg is null then 'In corso'
						  when dataoratermine is not null and dataoratermine < now() and gare.ditta is null and gare.esineg is null then 'In aggiudicazione'
						  when gare.ditta is not null or gare.esineg is not null then 'Concluso'
						  else null	end stato,
					  case when gare.esineg is not null then (select tab1desc from tab1 where tab1cod='A1088' and tab1tip=gare.esineg)
						   when gare.ditta is not null and gare.daatto is not null then 'Emesso contratto/ordine'
						   when gare.ditta is not null then 'Aggiudicato' end esito
			   from gare inner join torn on (gare.codgar1=torn.codgar)
				 left outer join v_gare_termini on v_gare_termini.codgar=torn.codgar
			   where  codgar1 not like '$%' and genere is null;

			--Nuova view documenti da firmare, utilizzata da applicativi esterni
			create or replace view v_gare_docfirma as
				--documenti della gara
				select (case when documgara.codgar like '$%' then documgara.ngara else documgara.codgar end) codicegara,
				(case when documgara.codgar like '$%' then gare.not_gar else torn.destor end) oggetto,
				'Documento gara' tipo, documgara.descrizione,
				 w_docdig.dignomdoc nomefile, w_docdig.idprg, w_docdig.iddocdig
				from w_docdig
				inner join documgara on (documgara.idprg=w_docdig.idprg and documgara.iddocdg=w_docdig.iddocdig )
				inner join torn on (documgara.codgar=torn.codgar)
				left outer join gare on (gare.ngara=documgara.ngara)
				where w_docdig.digfirma='1'
				union
				--allegati comunicazioni in bozza, sia pubbliche che riservate
				select (case when torn.codgar like '$%' then gare.ngara else torn.codgar end), 
				(case when torn.codgar like '$%' then gare.not_gar else torn.destor end),
				'Allegato comunicazione', w_docdig.digdesdoc,
				w_docdig.dignomdoc, w_docdig.idprg, w_docdig.iddocdig
				from w_docdig,w_invcom,gare,torn
				where torn.codgar=gare.codgar1 and gare.ngara=w_invcom.comkey1 and w_docdig.digent='W_INVCOM' and w_invcom.idprg=w_docdig.digkey1 and w_invcom.idcom=w_docdig.digkey2
				and w_invcom.comstato=1 
				and w_docdig.digfirma='1'
				union
				--documenti associati TORN
				select torn.codgar, torn.destor,
				'Documento associato', c0oggass.c0atit,
				w_docdig.dignomdoc, w_docdig.idprg, w_docdig.iddocdig
				from w_docdig, c0oggass, torn
				where c0aent='TORN' and c0oggass.c0akey1=torn.codgar and w_docdig.digent='C0OGGASS' and c0oggass.c0acod=w_docdig.digkey1 
				and w_docdig.digfirma='1'
				union
				--documenti associati GARE
				select (case when torn.codgar like '$%' then gare.ngara else torn.codgar end), 
				(case when torn.codgar like '$%' then gare.not_gar else torn.destor end),
				'Documento associato',  c0oggass.c0atit,
				w_docdig.dignomdoc, w_docdig.idprg, w_docdig.iddocdig
				from w_docdig, c0oggass, gare, torn
				where c0aent='GARE' and c0oggass.c0akey1=gare.ngara and torn.codgar=gare.codgar1 and w_docdig.digent='C0OGGASS' and c0oggass.c0acod=w_docdig.digkey1
				and w_docdig.digfirma='1';

			-- View documenti da firmare per utente
			create or replace view v_gare_docfirma_utenti as 
				select usrsys.syscon, usrsys.syscf, usrsys.sysute,
				 v_gare_docfirma.codicegara, v_gare_docfirma.oggetto, v_gare_docfirma.tipo, v_gare_docfirma.descrizione,
				 v_gare_docfirma.nomefile,v_gare_docfirma.idprg,v_gare_docfirma.iddocdig
				 from usrsys, g_permessi, v_gare_docfirma
				 where usrsys.syscon=g_permessi.syscon 
				 and (g_permessi.codgar=v_gare_docfirma.codicegara or g_permessi.codgar='$'||v_gare_docfirma.codicegara);

		END IF;
		

		-- URL pubblica portale Appalti per invio dati a Vigilanza
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','vigilanza.ws.urlPortaleAlice',NULL,'Integrazione WS Vigilanza','URL pubblica del Portale Appalti per accesso ai documenti di gara (es.: https://portaleappalti.test.it/PortaleAppalti/it/homepage.wp?actionPath=/ExtStr2/do/FrontEnd/Bandi/view.action&currentFrame=7&codice=)',NULL);

		--Aggiornamento profili
		--Funzione Integra Codice Cig
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.IntegraCodiceCig','Funzione "Integra codice CIG"',11615);

		perform sp_backupanddropviews('v_dati_ditte_partecipanti');
		create or replace view V_DATI_DITTE_PARTECIPANTI as
			select d.dittao as ditta,d.ngara5 as lotto,
			   (case when i.tipimp=3 or i.tipimp=10 then 2 else 1 end) as tipo,
				i.nomest as ragsoc,
				(case when gare.ditta is null 
					then (case when ditgaq.dittao is null then 2 else 1 end)
					else 1 end) as isAggiudicataria
			from ditg d inner join impr i on (d.dittao=i.codimp)
			left outer join gare on (d.ngara5=gare.ngara and d.dittao=gare.ditta)
			left outer join ditgaq on (d.ngara5=ditgaq.ngara and d.dittao=ditgaq.dittao)
			where  d.rtofferta is null;
		perform sp_restoreviews('v_dati_ditte_partecipanti');

		perform sp_backupanddropviews('v_dati_imprese_singole');
		create or replace view  V_DATI_IMPRESE_SINGOLE as
			select   cast('' as varchar(1)) as cod_associazione, codimp as cod_ditta, cast('' as varchar(1)) as tipo_ruolo, nomest as ragsoc, cfimp as codfisc, pivimp as piva,
			(case
				when nazimp=1 or nazimp is null then 'ITALIA'
				else 'ESTERO'
			end) as nazione, tipimp as tipoAssociazione
			from impr  where (tipimp not in(3,10) or (tipimp is null));
		perform sp_restoreviews('v_dati_imprese_singole');
		
		update eldaver set numver = '6.16.7', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.7', datvet = now() where codapp = 'G1';
	
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,50,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';
	
		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.7' or numver like '6.16.7%')) THEN
	
		--Definizione nuovi campi
	    ALTER TABLE GCAP ADD CODCARR VARCHAR(20);
		ALTER TABLE GCAP ADD CODRDA VARCHAR(20);
       
		--(S.Santi 22.12.2017) Modifica soglie comunitarie
		IF (select count(*) = 0 from tab1 where tab1cod='A1125' and tab1tip=1 and tab1desc='5548000 Euro - Gare per lavori') THEN
			update tab1 set tab1desc='5548000 Euro - Gare per lavori' where tab1cod='A1125' and tab1tip=1;
			update tab1 set tab1desc='221000 Euro - Gare per forniture e servizi' where tab1cod='A1125' and tab1tip=2;
			update catpub set liminf=5548000 where liminf=5225000;
			update catpub set limsup=5548000 where limsup=5225000;
			update catpub set liminf=221000 where liminf=209000;
			update catpub set limsup=221000 where limsup=209000;
			update catsca set liminf=5548000 where liminf=5225000;
			update catsca set limsup=5548000 where limsup=5225000;
			update catsca set liminf=221000 where liminf=209000;
			update catsca set limsup=221000 where limsup=209000;
			update confopeco set daimporto=221000 where daimporto=209000;
			update confopeco set aimporto=221000 where aimporto=209000;
		END IF;
		
		--Aggiornamento C0CAMPI
		delete from c0campi where c0c_mne_ber in ('G1_CODCARR','G1_CODRDA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODCARR.GCAP.GARE','G1_CODCARR','Codice carrello','Cod.carrello','A20',NULL,NULL,'Carrello');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODRDA.GCAP.GARE','G1_CODRDA','Codice RDA','Cod.RDA','A20',NULL,NULL,'Rda');

		IF (select count(*) = 0 from w_config where codapp='PG' and chiave = 'wserp.erp.url') THEN
		--Configurazione per il sistema di integrazione con un ERP
			INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wserp.erp.url',NULL,NULL,NULL,NULL);
			INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wserpconfigurazione.erp.url',NULL,NULL,NULL,NULL);
		--Configurazione della schedulazione Dati L190 con sistema di integrazione con un ERP
			INSERT INTO W_QUARTZ (CODAPP, BEAN_ID, CRON_EXPRESSION, CRON_SECONDS, CRON_MINUTES, CRON_HOURS, CRON_DAY_OF_MONTH, CRON_MONTH, CRON_DAY_OF_WEEK, CRON_YEAR, DESCRIZIONE)
				VALUES ('PG', 'acquisisciWSERPDatiL190Trigger', '0 0 0 1 1 ? 2099', '0', '0', '0', '1', '1', '?', '2099', 'Schedulazione dell''acquisizione tramite WSERP dei dati di esecuzione contratto L.190/2012');
        --Profilazione per il sistema di integrazione con un ERP
			INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SUBMENU','AMMINISTRAZIONE.Configurazione-integrazioneWSERP','Configurazione parametri integrazione WSERP',13490);
			INSERT INTO W_AZIONI  (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) VALUES ('SUBMENU', 'VIS', 'AMMINISTRAZIONE.Configurazione-integrazioneWSERP', 'Visualizza', 0, 1, 1, 301966675);
		END IF;		

		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','elencoCampi.solaLettura', null, 'Configurazione generale', 'Indicare l''elenco di campi in formato ENTITA.CAMPO separati da ";" per individuare i campi sempre in sola lettura indipendentemente dal profilo e per utenti NON AMMINISTRATORI DI SISTEMA (es.: IMPR.CFIMP;TEIM.CFTIM)', null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','assistenza.servizio.productId','913',null,'Id cartella in HDA a cui agganciare i ticket inseriti per il prodotto',null);
		
		perform sp_backupanddropviews('v_gare_statoesito');
		create or replace view v_gare_statoesito as
			select v_gare_torn.codgar, v_gare_torn.codice, v_gare_torn.genere genere, v_gare_torn.oggetto,
				 case when dataoratermine is not null and dataoratermine >= now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
						and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 1
					  when dataoratermine is not null and dataoratermine < now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
						and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 2
					  when v_gare_torn.esineg is not null or v_gare_torn.isaggiu='1' or v_gare_torn.islotticonclusi='1' then 3
					  else null end codstato,
				 case when dataoratermine is not null and dataoratermine >= now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
						and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 'In corso'
					  when dataoratermine is not null and dataoratermine < now() and v_gare_torn.esineg is null and v_gare_torn.isaggiu='2'
						and (v_gare_torn.islotticonclusi='2' or v_gare_torn.islotticonclusi is null) then 'In aggiudicazione'
					  when v_gare_torn.esineg is not null or v_gare_torn.isaggiu='1' or v_gare_torn.islotticonclusi='1' then 'Conclusa'
					  else null end stato,
				  case when v_gare_torn.esineg is not null then (select tab1desc from tab1 where tab1cod='A1088' and tab1tip=v_gare_torn.esineg)
					  when v_gare_torn.isaggiu='1' and v_gare_torn.isstipula='1' then 'Emesso contratto/ordine' 
					  when v_gare_torn.isaggiu='1' then 'Aggiudicata' end esito
			from v_gare_torn 
				inner join v_gare_termini on (v_gare_torn.codgar=v_gare_termini.codgar);
		perform sp_restoreviews('v_gare_statoesito');
		
		update eldaver set numver = '6.16.8', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.8', datvet = now() where codapp = 'G1';
	
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,50,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';
	
		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	
	ls_doumgara_codgar varchar(21);
	ls_doumgara_codgar_old varchar(21);
	ll_doumgara_gruppo numeric(7) := 0;
	ll_doumgara_gruppo_old numeric(7) := 0;
	ll_doumgara_norddocg numeric(7) := 0;
	ll_doumgara_new_numord numeric(7) := 0;
	ciclo_documgara cursor for select codgar, gruppo, norddocg from DOCUMGARA left join TAB1 on tab1cod='A1013' and TAB1TIP=BUSTA order by codgar, gruppo, tab1nord, fasele, norddocg;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.8' or numver like '6.16.8%')) THEN
	
		--Definizione nuovi campi
		--NUMORD.DOCUMGARA
		ALTER TABLE DOCUMGARA ADD NUMORD NUMERIC(7) NULL;
		--POSRDA.GCAP
		ALTER TABLE GCAP ADD POSRDA VARCHAR(20);
		--MEZZO.GARDOC_JOBS
		ALTER TABLE GARDOC_JOBS ADD MEZZO VARCHAR(100);

		------------------------------------
		-- INIZIALIZZAZIONE CAMPO NUMORD.DOCUMGARA
		--verifico che ci siano NUMORD nulli  
		IF (select count(*) > 0 from documgara where numord is null) THEN
			ls_doumgara_codgar_old := '';
			open ciclo_documgara;
			loop
				-- Inizializzazione i campi della query ciclo_documgara
				fetch ciclo_documgara into ls_doumgara_codgar,ll_doumgara_gruppo, ll_doumgara_norddocg;
				-- Se non ci sono piÃ¹ dati da scorrere, esce dal ciclo
				if not found then
					exit;
				end if;
				--verifico se cambia il codgar o il gruppo
				if (ls_doumgara_codgar <> ls_doumgara_codgar_old) or (ll_doumgara_gruppo <> ll_doumgara_gruppo_old) then
					ll_doumgara_new_numord := 0;
				end if;
				-- Inizializza ll_doumgara_new_numord
				ll_doumgara_new_numord := ll_doumgara_new_numord + 1;
				-- Gestisce l'update in NUMORD.DOCUMGARA
				if (ls_doumgara_codgar is not NULL) and (length(ls_doumgara_codgar) > 0) then
					if (ll_doumgara_norddocg is not NULL) and (ll_doumgara_norddocg > 0) then
						if (ll_doumgara_new_numord is not NULL) and (ll_doumgara_new_numord > 0) then
							UPDATE DOCUMGARA set NUMORD=ll_doumgara_new_numord where codgar=ls_doumgara_codgar and norddocg=ll_doumgara_norddocg;
						end if;
					end if;
				end if;
				--Imposta i vecchi valori di codgar e gruppo
				ls_doumgara_codgar_old := ls_doumgara_codgar;
				ll_doumgara_gruppo_old := ll_doumgara_gruppo;
			end loop;
			close ciclo_documgara;	
		END IF;			
		------------------------------------

		update tab1 set tab1mod='1' where tab1cod='A1088' and tab1tip in (1,2,3);
		update tab4 set tab4desc='Numero cifre decimali del punteggio tecnico e economico assegnato alla ditta' where tab4cod='G1_1' and tab4tip='A1049';
		
		--Aggiornamento C0CAMPI
		--NUMORD.DOCUMGARA.GARE
		delete from c0campi where c0c_mne_ber in ('G1NUMORDDG');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NUMORD.DOCUMGARA.GARE','G1NUMORDDG','Numero ordine','Numero ordine','N3',NULL,NULL,NULL);
		--POSRDA.GCAP.GARE
		delete from c0campi where c0c_mne_ber in ('G1_POSRDA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'POSRDA.GCAP.GARE','G1_POSRDA','Posizione RDA','Pos.RDA','A20',NULL,NULL,'Posizione Rda');
		delete from c0campi where c0c_mne_ber in ('G1NUMORD_DD');
		--NUMORD.V_GARE_DOCDITTA.GARE
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NUMORD.V_GARE_DOCDITTA.GARE','G1NUMORD_DD','Numero ordine','Numero ordine','N3',NULL,NULL,NULL);
		
		delete from c0campi where c0c_mne_ber in ('G1CODCARR_PP','G1CODRDA_PP','G1POSRDA_PP');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODCARR.V_GCAP_DPRE.GARE','G1CODCARR_PP','Codice carrello','Codice carrello','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODRDA.V_GCAP_DPRE.GARE','G1CODRDA_PP','Codice rda','Codice rda','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'POSRDA.V_GCAP_DPRE.GARE','G1POSRDA_PP','Posizione rda','Posizione rda','A20',NULL,NULL,NULL);

                delete from c0campi where c0c_mne_ber in ('G1MEZZO');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'MEZZO.GARDOC_JOBS.GARE','G1MEZZO','Mezzo','Mezzo','A100',NULL,NULL,'Mezzo');

		--Aggiornamento profili
		--Funzione Modifica Ordinamento Documentazione
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.ModificaOrdinamentoDocumentazione','Funzione Modifica disposizione documenti di gara o elenco',11632);
		
		--Funzione Registra imprese su Portale
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.FASIISCRIZIONE.RegistraImpresePortale','Funzione Registra imprese su portale',5411);

		--Abilito di default la configurazione per l'integrazione WSERP
		delete from W_AZIONI where TIPO = 'SUBMENU' and AZIONE = 'VIS' and OGGETTO = 'AMMINISTRAZIONE.Configurazione-integrazioneWSERP' and CRC = 301966675; 
		
		--Aggiornamento view
		--V_GARE_DOCDITTA
		perform sp_backupanddropviews('v_gare_docditta');
		create or replace view v_gare_docditta as
			select imprdocg.codgar,
				imprdocg.ngara,
				imprdocg.codimp,
				imprdocg.norddoci,
				imprdocg.proveni,
				case when proveni=1 then documgara.busta else imprdocg.busta end busta,
				tab1.tab1nord bustaord,
				tab1.tab1desc bustadesc,
				case when proveni=1 then documgara.descrizione else imprdocg.descrizione end descrizione,
				documgara.reqcap,
				documgara.tipodoc,
				documgara.contestoval,
				documgara.obbligatorio,
				documgara.modfirma,
				documgara.gentel,
				documgara.fasele,
				documgara.isarchi,
				coalesce(documgara.numord,10000) numord,
				imprdocg.datarilascio,
				imprdocg.orarilascio,
				imprdocg.datascadenza,
				imprdocg.situazdoci,
				imprdocg.doctel,
				imprdocg.idprg,
				imprdocg.iddocdg,
				w_docdig.dignomdoc,
				imprdocg.notedoci
			from imprdocg 
			left outer join documgara on (imprdocg.codgar = documgara.codgar and imprdocg.norddoci=documgara.norddocg and imprdocg.proveni=1 and documgara.gruppo=3)
			left outer join w_docdig on (imprdocg.idprg=w_docdig.idprg and imprdocg.iddocdg=w_docdig.iddocdig)
			left outer join tab1 on (tab1cod='A1013' and (tab1tip=imprdocg.busta or tab1tip=documgara.busta));
		perform sp_restoreviews('v_gare_docditta');

		perform sp_backupanddropviews('v_gcapd');
		-- (C.Febas 25.01.2018) Addizionati attributi per collegamento lavorazioni rda (ERP)
		create or replace view v_gcapd as
		  select gcap.ngara,gcap.contaf,gcap.norvoc,gcap.codvoc,gcap.unimis,gcap.quanti,gcap.prezun,
			gcap.perciva,gcap.clasi1,gcap.numpar,gcap.voce,gcap.solsic,gcap.sogrib,gcap.dittao,
			gcap.codcarr,gcap.codrda,gcap.posrda,ditg.dittao as cod_ditta, ditg.codgar5 as codgar, gare.codiga
		  from gcap, ditg, gare
		  where gcap.ngara=ditg.ngara5 and (gcap.dittao is null or gcap.dittao=ditg.dittao)
		    and gcap.ngara=gare.ngara;
   		perform sp_restoreviews('v_gcapd');

		perform sp_backupanddropviews('v_gcap_dpre');
		-- (C.Febas 25.01.2018) Addizionati attributi per collegamento lavorazioni rda (ERP)
		create or replace view v_gcap_dpre as
		  select (case when v_gcapd.dittao is null then '2' else '1' end) as issoloditta,
		   (case when v_gcapd.quanti=dpre.quanti or dpre.quanti is null then '2' else '1' end) as isquantimod,
		   v_gcapd.codgar, v_gcapd.ngara, v_gcapd.codiga, v_gcapd.contaf, v_gcapd.cod_ditta, v_gcapd.norvoc,
		   v_gcapd.codvoc, v_gcapd.voce, v_gcapd.solsic, v_gcapd.sogrib, v_gcapd.unimis,
		   v_gcapd.codcarr, v_gcapd.codrda, v_gcapd.posrda, dpre.quanti,
		   (case when dpre.unimis is null then v_gcapd.unimis else dpre.unimis end) as unimiseff, 
		   (case when dpre.quanti is null then v_gcapd.quanti else dpre.quanti end) as quantieff, 
		   (case when v_gcapd.solsic='1' or v_gcapd.sogrib='1' then v_gcapd.prezun else dpre.preoff end) as preoff, 
		   (case when dpre.perciva is null then v_gcapd.perciva else dpre.perciva end) as percivaeff, 
		   (case when v_gcapd.solsic='1' or v_gcapd.sogrib='1' then round(v_gcapd.prezun*v_gcapd.quanti,5) else dpre.impoff end) as impoff,
		   dpre.reqmin as reqmin			       
		from v_gcapd left outer join dpre on v_gcapd.cod_ditta=dpre.dittao and v_gcapd.ngara=dpre.ngara and v_gcapd.contaf=dpre.contaf;
   		perform sp_restoreviews('v_gcap_dpre');
		
		
		update eldaver set numver = '6.16.9', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.9', datvet = now() where codapp = 'G1';
	
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';
	
		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.9' or numver like '6.16.9%')) THEN

		--Correzione C0CAMPI
		UPDATE C0CAMPI SET C0C_FS='A20' WHERE C0C_MNE_BER='G1NGARA_DD';

		Update W_CONFIG set DESCRIZIONE='URL del web service per la richiesta del codice CIG (es.: http://localhost:8080/WS2Vigilanza/services/EldasoftSimogWS)' where codapp='PG' and chiave='it.eldasoft.inviodaticig.ws.url';
		--Parametro 'Formato allegati'
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','allegatiComunicazione.formato',NULL,'Formato allegati comunicazioni','Specificare l''elenco dei formati consentiti per gli allegati alle comunicazioni in uscita separati da ";" (es.: PDF;P7M;TSD)',NULL);

        --Aggiornamento profili
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GENEWEB.W_INVCOM-lista.archiviaComunicazione','Funzione Archivia comunicazione pubblica',12615);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.ALTRIDATI.ISPGD','Sezione "Integrazione con sistema di protocollazione e gestione documentale"',2797);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-scheda.ALTRIDATI.ISPGD','Sezione "Integrazione con sistema di protocollazione e gestione documentale"',2784);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-OFFUNICA-scheda.ALTRIDATI.ISPGD','Sezione "Integrazione con sistema di protocollazione e gestione documentale"',3844);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.CRITERIELEDITTE.ISPGD','Sezione "Integrazione con sistema di protocollazione e gestione documentale"',5733);

		update eldaver set numver = '6.16.10', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.10', datvet = now() where codapp = 'G1';
	
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';
	
		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.10' or numver like '6.16.10.%')) THEN
	
        ALTER TABLE TORN ADD NOFDIT NUMERIC(5);
        ALTER TABLE TORN ADD AMMRIN VARCHAR(1);
        ALTER TABLE TORN ADD DESRIN VARCHAR(2000);
		perform sp_backupanddropviews('torn');
        ALTER TABLE TORN ALTER COLUMN NGADIT TYPE NUMERIC(5);
		perform sp_restoreviews('torn');

		--Creazione tabella GARCONTR190
		CREATE TABLE GARCONTR190 (
  			ID NUMERIC(12) NOT NULL,
			CODGAR VARCHAR(21),
  			NGARA VARCHAR(20),
			DATACONTR TIMESTAMP,
			TITOLO VARCHAR(500),
			MESSAGGIO TEXT,
  			primary key (ID));
		
		ALTER TABLE GARCONTR190 ADD CONSTRAINT FK_GARCONTR190_GARE FOREIGN KEY (NGARA) REFERENCES GARE( NGARA ) ON DELETE CASCADE;
		
		--inserimento in w_genchiavi dell'occorrenza relativa a GARCONTR190
		insert into w_genchiavi (tabella,chiave) values ('GARCONTR190',0);

		-- Nuovi campi per criteri di rotazione per n.aggiudicazioni
        ALTER TABLE ISCRIZCAT ADD AGGREA NUMERIC(7);
        ALTER TABLE ISCRIZCLASSI ADD AGGREA NUMERIC(7);
        ALTER TABLE ISCRIZUFF ADD AGGREA NUMERIC(7);

		-- Ora sopralluogo
        ALTER TABLE GARE1 ADD SOPRORA VARCHAR(6);

		-- Inserisce le occ. in ISCRIZCAT relative alle categorie con codice '0', nel caso siano state cancellate in seguito a errore nel codice, ora risolto
		insert into iscrizcat (codgar,ngara,codimp,codcat,tipcat) select distinct i.codgar,i.ngara,i.codimp,'0',tab1tip from iscrizcat i,tab1 where tab1cod='A1007' and 
		 not exists (select * from iscrizcat ii where ii.codcat='0' and i.ngara=ii.ngara and i.codimp=ii.codimp);

		 --aggiornamento campo AGGREA con n.gare aggiudicate 
		update iscrizcat set aggrea=
		(with aggGare as (
		select iscrizcat.ngara,codimp,codcat,tipgen,count(gare.ngara) as nAggGare from gare,ditg,torn,iscrizcat where
		 torn.codgar=gare.codgar1 and (torn.aqoper is null or torn.aqoper=1) 
		 and (gare.elencoe=iscrizcat.ngara or (gare.elencoe is null and exists(select ngara from gare g1 where g1.genere=3 and g1.codgar1=gare.codgar1 and g1.elencoe=iscrizcat.ngara)))
		 and gare.ngara=ditg.ngara5 
		 and gare.dattoa is not null 
		 and (ditg.acquisizione=3 or (ditg.acquisizione is null and exists(select dittao from ditg d1 where d1.codgar5=d1.ngara5 and d1.codgar5=ditg.codgar5 and d1.acquisizione=3))) 
		 and (gare.ditta=ditg.dittao or (gare.ditta=ditg.rtofferta or (ditg.rtofferta is null and exists(select dittao from ditg d2 where d2.codgar5=d2.ngara5 and d2.codgar5=ditg.codgar5 and d2.rtofferta=gare.ditta))))
		 and iscrizcat.codimp=ditg.dittao and iscrizcat.codcat='0' and iscrizcat.tipcat=torn.tipgen
		group by iscrizcat.ngara,codimp,codcat,tipgen
		)
		select nAggGare from aggGare where iscrizcat.ngara=aggGare.ngara and iscrizcat.codimp=aggGare.codimp and iscrizcat.codcat=aggGare.codcat and iscrizcat.tipcat=aggGare.tipgen
		);
		--aggiornamento campo AGGREA con n.accordi quadro aggiudicati
		update iscrizcat set aggrea=coalesce(aggrea,0) + coalesce(
		(with aggAQ as(
		select iscrizcat.ngara,codimp,codcat,tipgen,count(gare.ngara) as nAggAQ from gare,ditg,torn,ditgaq,iscrizcat where
		 torn.codgar=gare.codgar1 and torn.aqoper=2
		 and (gare.elencoe=iscrizcat.ngara or (gare.elencoe is null and exists(select ngara from gare g1 where g1.genere=3 and g1.codgar1=gare.codgar1 and g1.elencoe=iscrizcat.ngara)))
		 and gare.dattoa is not null 
		 and gare.ngara=ditg.ngara5 and ditg.ngara5=ditgaq.ngara
		 and (ditg.acquisizione=3 or (ditg.acquisizione is null and exists(select dittao from ditg d1 where d1.codgar5=d1.ngara5 and d1.codgar5=ditg.codgar5 and d1.acquisizione=3))) 
		 and (ditgaq.dittao=ditg.dittao or (ditgaq.dittao=ditg.rtofferta or (ditg.rtofferta is null and exists(select dittao from ditg d2 where d2.codgar5=d2.ngara5 and d2.codgar5=ditg.codgar5 and d2.rtofferta=ditgaq.dittao))))
		 and iscrizcat.codimp=ditg.dittao and iscrizcat.codcat='0' and iscrizcat.tipcat=torn.tipgen
		group by iscrizcat.ngara,codimp,codcat,tipgen
		)
		select nAggAQ from aggAQ where iscrizcat.ngara=aggAQ.ngara and iscrizcat.codimp=aggAQ.codimp and iscrizcat.codcat=aggAQ.codcat and iscrizcat.tipcat=aggAQ.tipgen
		),0);
		--Resetta a null se impostato a 0
		update iscrizcat set aggrea=null where aggrea=0;

		-- Differenziato parametro calcolo aggiudicazione per sopra e sotto soglia
		UPDATE TAB1 SET TAB1DESC='5    - n.minimo per procedure sopra soglia' where TAB1COD='A1135' and TAB1TIP=1;
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1135',2,'5    - n.minimo per procedure sotto soglia',NULL,NULL,NULL);

		--Nuovi criteri di rotazione per n.aggiudicazioni
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1073',10,'Rotazione in base a aggiudicazioni',NULL,9,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1073',11,'Rotazione in base a aggiudicazioni su categoria',NULL,10,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1073',12,'Rotazione in base a aggiudicazioni su categoria e classe',NULL,11,NULL);
		UPDATE TAB1 set TAB1NORD=12 where TAB1COD='A1073' and TAB1TIP=2;

		INSERT INTO ALGORITMI (NUMALGO,CODAPP,CODALGO,TIPOALGO,DESCALGO) VALUES (10,'PG','A1073',10,'Presenta gli operatori in ordine inverso rispetto al numero di affidamenti ottenuti e alle penalitÃ  assegnate dall''ente. A paritÃ  di numero di affidamenti e penalitÃ , gli operatori sono ordinati secondo il numero ordine assegnato in elenco.');
		INSERT INTO ALGORITMI (NUMALGO,CODAPP,CODALGO,TIPOALGO,DESCALGO) VALUES (11,'PG','A1073',11,'Presenta gli operatori in ordine inverso rispetto al numero di affidamenti ottenuti sulla categoria o prestazione prevalente della gara e alle penalitÃ  assegnate dall''ente. A paritÃ  di numero di affidamenti e penalitÃ , gli operatori sono ordinati secondo il numero ordine assegnato in elenco.');
		INSERT INTO ALGORITMI (NUMALGO,CODAPP,CODALGO,TIPOALGO,DESCALGO) VALUES (12,'PG','A1073',12,'Presenta gli operatori in ordine inverso rispetto al numero di affidamenti ottenuti sulla categoria o prestazione prevalente della gara e sulla relativa classe e alle penalitÃ  assegnate dall''ente. A paritÃ  di numero di affidamenti e penalitÃ , gli operatori sono ordinati secondo il numero ordine assegnato in elenco.');
                
		--Aggiornamento C0CAMPI
		delete from c0campi where c0c_mne_ber in ('G1AGGREAIC','G1AGGREACL','G1AGGREAIU', 'G1AGGREA_CL','NUMAGG_VDE','NUMAP_VDE','NUMAGGCLA_VDE','NUMAPCLA_VDE','NUMAGGTOT_VDE','NUMAPTOT_VDE','NUMAGG_VDS','NUMAP_VDS','NUMAGGTOT_VDA','NUMAPTOT_VDA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AGGREA.ISCRIZCAT.GARE','G1AGGREAIC','N.aggiudicazioni della ditta relativamente alla categoria','N.aggiudicazioni','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AGGREA.ISCRIZCLASSI.GARE','G1AGGREACL','N.aggiudicazioni della ditta relativamente alla classe','N.aggiudicazioni','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AGGREA.ISCRIZUFF.GARE','G1AGGREAIU','N.aggiudicazioni della ditta relativamente alla categoria','N.aggiudicazioni','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AGGREA.V_ISCRIZCAT_CLASSI.GARE','G1AGGREA_CL','N.aggiudicazioni ottenute relativamente alla categ. o classe','N.aggiudicazioni','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMAGG.V_DITTE_ELECAT.GARE','NUMAGG_VDE','N.aggiudicazioni relativamente alla categoria','N.aggiudic.su categ.','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMAP.V_DITTE_ELECAT.GARE','NUMAP_VDE','N.aggiudicazioni su categ. come somma di aggiudic.e penalità','N.agg. + pen. categ.','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMAGGCLA.V_DITTE_ELECAT.GARE','NUMAGGCLA_VDE','N.aggiudicazioni relativamente alla classe della categoria','N.aggiudic.su classe','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMAPCLA.V_DITTE_ELECAT.GARE','NUMAPCLA_VDE','N.aggiudicazioni su classe come somma di aggiudic.e penalità','N.agg. + pen. classe','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMAGGTOT.V_DITTE_ELECAT.GARE','NUMAGGTOT_VDE','N.aggiudicazioni totale relativamente all''elenco','N.aggiudic.totale','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMAPTOT.V_DITTE_ELECAT.GARE','NUMAPTOT_VDE','N.aggiudicazioni come somma di aggiudic.e penalità totali','N.agg. + pen. totale','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMAGG.V_DITTE_ELESUM.GARE','NUMAGG_VDS','N.aggiudicazioni dell''operatore','N.aggiudicazioni','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMAP.V_DITTE_ELESUM.GARE','NUMAP_VDS','N.aggiudicazioni come somma di aggiudicazioni e penalità','N.agg. e penalità','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMAGGTOT.V_DITTE_ELECAT_SA.GARE','NUMAGGTOT_VDA','N.aggiudicazioni totale relativamente all''elenco','N.aggiudic.totale','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMAPTOT.V_DITTE_ELECAT_SA.GARE','NUMAPTOT_VDA','N.aggiudicazioni come somma di aggiudic.e penalità totali','N.agg. + pen. totale','N3',NULL,NULL,NULL);

		--Aggiornamento c0campi per aggiunta tabella GARCONTR190
		delete from c0campi where c0c_mne_ber in ('G1IDCTRL','G1CODGARCTRL','G1CODGARCTRL','G1NGARACTRL','G1DATACTRL','G1TITOLOCTRL','G1MESSAGGIOCTRL');
	   INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.GARCONTR190.GARE','G1IDCTRL','Id','Id','N10',NULL,NULL,NULL);
	   INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODGAR.GARCONTR190.GARE','G1CODGARCTRL','Codice della gara divisa in lotti','Codice gara in lotti','A21',NULL,NULL,NULL);
	   INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.GARCONTR190.GARE','G1NGARACTRL','Codice della gara o lotto di gara','Codice gara','A20',NULL,NULL,NULL);
	   INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATACONTR.GARCONTR190.GARE','G1DATACTRL','Data esito del controllo','Data esito','A19',NULL,'TIMESTAMP',NULL);
	   INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TITOLO.GARCONTR190.GARE','G1TITOLOCTRL','Titolo del controllo','Titolo controllo','A500',NULL,NULL,NULL);
	   INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'MESSAGGIO.GARCONTR190.GARE','G1MESSAGGIOCTRL','Messaggio del controllo','Messaggio','A2000',NULL,'CLOB',NULL);
		
		delete from c0campi where c0c_mne_ber in ('G1SOPRORA','G1NOFDIT','G1AMMRIN','G1DESRIN','NGADIT');
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'SOPRORA.GARE1.GARE','G1SOPRORA','Ora entro la quale la ditta deve fare il sopralluogo','Ora termine sopral.','A6',NULL,'ORA','Ora');
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NOFDIT.TORN.GARE','G1NOFDIT','Numero massimo lotti per cui la ditta può presentare offerta','N.max lotti pres.off','N5',NULL,NULL,'Num.massimo lotti per cui presentare offerta');
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AMMRIN.TORN.GARE','G1AMMRIN','Contratto d''appalto oggetto di rinnovo?','Oggetto di rinnovo?','A2',NULL,'SN',NULL);
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DESRIN.TORN.GARE','G1DESRIN','Descrizione dei rinnovi','Descrizione rinnovi','A2000',NULL,'NOTE',NULL);
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGADIT.TORN.GARE','NGADIT','Numero massimo lotti aggiudicabili da una ditta','N.max lotti aggiud.','N5',NULL,NULL,'Num.massimo lotti aggiudicabili dalla ditta');

		--Aggiornamento C0CAMPI - Aggiornamento di 6166to6167 fallito per errore solo su Postgres
		delete from c0campi where c0c_mne_ber in ('G1_ISNOPRZ','G1PUNTPRZ','G1PUNTALT');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ISNOPRZ.GOEV.GARE','G1_ISNOPRZ','Criterio econ.,ai fini calc.anomalia,non relativo al prezzo?','Crit.econ.non prezzo','A2',NULL,'SN','Ai fini del calcolo soglia anomalia, criterio relativo a');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUNTPRZ.DITG.GARE','G1PUNTPRZ','Punteggio totale relativo al prezzo','Punteggio prezzo','F13.9 ',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUNTALT.DITG.GARE','G1PUNTALT','Punteggio totale relativo ad altri elementi di valutazione','Punteggio altri elem','F13.9',NULL,NULL,NULL);

		--Aggiornamento C0ENTIT
		delete from c0entit where c0e_nom in ('GARCONTR190.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARCONTR190.GARE',0,'E','190_CONTR','Esito controlli sui dati di gare ai fini di L.190/2012','NGARA.GARCONTR190.GARE','GARE.GARE','NGARA.GARE.GARE',NULL,NULL,'g1_190c0');
		
		--Personalizzazione Cineca
		IF (select count(*) = 0 from w_config where codapp='PG' and chiave='cineca.ws.SoggettoCollettivo.client') THEN
		   INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cineca.ws.SoggettoCollettivo.client',NULL,'Personalizzazione Cineca','Attributo client Cineca',NULL);
		END IF;

        --Personalizzazione Regione Marche
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','sitoIstituzionale.ws.url',NULL,'Pubblicazione sito istituzionale Regione Marche','URL di accesso al servizio',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','sitoIstituzionale.ws.urlBandiPortaleAppalti',NULL,'Pubblicazione sito istituzionale Regione Marche','URL pubblica del Portale Appalti per accesso ai dati e documenti del bando di gara (es.: https://portaleappalti.test.it/PortaleAppalti/it/homepage.wp?actionPath=/ExtStr2/do/FrontEnd/Bandi/view.action&currentFrame=7&codice=)',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','sitoIstituzionale.ws.urlEsitiPortaleAppalti',NULL,'Pubblicazione sito istituzionale Regione Marche','URL pubblica del Portale Appalti per accesso ai dati e documenti dell''esito di gara (es.: https://portaleappalti.test.it/PortaleAppalti/it/homepage.wp?actionPath=/ExtStr2/do/FrontEnd/Esiti/view.action&currentFrame=7&codice=)',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','sitoIstituzionale.ws.urlAvvisiPortaleAppalti',NULL,'Pubblicazione sito istituzionale Regione Marche','URL pubblica del Portale Appalti per accesso ai dati e documenti di avvisi,elenchi e cataloghi (es.: https://portaleappalti.test.it/PortaleAppalti/it/homepage.wp?actionPath=/ExtStr2/do/FrontEnd/Avvisi/view.action&currentFrame=7&codice=)',NULL);

		--Property per gestione cambio password
		IF (select count(*) = 0 from w_config where codapp='PG' and chiave='account.intervalloMinimoCambioPassword') THEN
			Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','account.intervalloMinimoCambioPassword','30','Password','Intervallo minimo (espresso in SECONDI) tra un cambio password ed il successivo per lo stesso utente',null);
		END IF;

		--Property per integrazione controllo ditte art.80
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','art80.ws.url',null,'Verifica ditte art.80 DLgs.50/2016','Indirizzo URL del servizio (es.: http://portale.ente.it)',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','art80.ws.username',null,'Verifica ditte art.80 DLgs.50/2016','Utente',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','art80.ws.password',null,'Verifica ditte art.80 DLgs.50/2016','Password','1');

		--Processo schedulato per controllo ditte art.80
		Insert into W_QUARTZ (CODAPP,BEAN_ID,CRON_EXPRESSION,CRON_SECONDS,CRON_MINUTES,CRON_HOURS,CRON_DAY_OF_MONTH,CRON_MONTH,CRON_DAY_OF_WEEK,CRON_YEAR,DESCRIZIONE) VALUES ('PG','art80GetStatusAllTrigger', '0 0 0 1 1 ? 2099','0','0','0','1','1','?','2099', 'Schedulazione del processo di aggiornamento stato documentale verifica ditte art.80 DLgs.50/2016');

		--Inserimento in quartz della pianificazione del controllo L.190/2012
		INSERT INTO W_QUARTZ (CODAPP,BEAN_ID,CRON_EXPRESSION,CRON_SECONDS,CRON_MINUTES,CRON_HOURS,CRON_DAY_OF_MONTH,CRON_MONTH,CRON_DAY_OF_WEEK,CRON_YEAR,DESCRIZIONE) VALUES ('PG','controlloDati190ManagerTrigger','0 0 1 * * ? 2099','0','0','1','*','*','?','2099','Schedulazione del controllo dei dati delle gare ai fini dell''adempimento L.190/2012');
		
		--Aggiornamento profili
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.GAREAVVISI-scheda.DATIGEN.DEL-CPVCOMP','Elimina CPV oggetto complementare',6495);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.GAREAVVISI-scheda.DATIGEN.INS-CPVCOMP','Inserisci nuovo CPV oggetto complementare',6415);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GAREAVVISI-scheda.DATIGEN.ALTRIDATI','Sezione "Altri dati"',6475);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GAREAVVISI-scheda.DATIGEN.CPVPR','Sezione "CPV"',6476);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GAREAVVISI-scheda.DATIGEN.CPVCOMP','Sezioni dinamiche "CPV oggetto complementare (i)"',6478);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.FASIISCRIZIONE.AbilitaOperatori','Funzione Abilita operatori in attesa verifica',5413);

		--Aggiornamento w_oggetti e w_azioni
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('COLS','VIS','GARE.TORN.ELEPAR','Visualizza',0,1,1,295509597);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('COLS','VIS','GARE.TORN.NUMOPE','Visualizza',0,1,1,2703066557);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('COLS','VIS','GARE.TORN.PROFAS','Visualizza',0,1,1,1471734743);
		DELETE FROM W_OGGETTI WHERE TIPO = 'SEZ' AND OGGETTO = 'GARE.TORN-scheda.ALTRIDATI.COMPGUUE';
		DELETE FROM W_OGGETTI WHERE TIPO = 'SEZ' AND OGGETTO = 'GARE.GARE-scheda.ALTRIDATI.COMPGUUE';
		DELETE FROM W_OGGETTI WHERE TIPO = 'SEZ' AND OGGETTO = 'GARE.TORN-OFFUNICA-scheda.ALTRIDATI.COMPGUUE';
	   
		--Corretto voce profilo per sezione 'Codice CUP' gare a lotti plico unico
		if (select count(*)=0 from w_oggetti where tipo='SEZ' and oggetto='GARE.TORN-OFFUNICA-scheda.ALTRIDATI.CUP')
		THEN
			INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-OFFUNICA-scheda.ALTRIDATI.CUP','Sezione "Codice CUP"',4970);
		END IF;
		DELETE FROM W_OGGETTI where tipo='SEZ' and oggetto='GARE.TORN-OFFUNICA-scheda.ALTRIDATI.CUPSEZ';

		--Rimosso da codice il campo TIPTOR.TORN
		DELETE FROM W_AZIONI where tipo='COLS' and azione='VIS' and oggetto='GARE.TORN.TIPTOR';
	   
		-- (S.Santi 26.03.18) Aggiunto campo 'N.aggiudicazioni'
		perform sp_backupanddropviews('v_iscrizcat_classi');
		create or replace view v_iscrizcat_classi as
			select v_iscrizcat_tit.caisim, v_iscrizcat_tit.descat, v_iscrizcat_tit.descat descat1,
						v_iscrizcat_tit.tiplavg, v_iscrizcat_tit.titnord, v_iscrizcat_tit.titcat,
						v_iscrizcat_tit.caisord, v_iscrizcat_tit.quaobb, v_iscrizcat_tit.acontec, 
						v_iscrizcat_tit.isfoglia, v_iscrizcat_tit.numliv, v_iscrizcat_tit.numord, 
						-100 numclass, iscrizcat.infnumclass, iscrizcat.supnumclass, 
						null numclass_l, case when tiplavg=1 then iscrizcat.infnumclass else null end infnumcla_l, case when tiplavg=1 then iscrizcat.supnumclass else null end supnumcla_l, 
						null numclass_f, case when tiplavg=2 then iscrizcat.infnumclass else null end infnumcla_f, case when tiplavg=2 then iscrizcat.supnumclass else null end supnumcla_f, 
						null numclass_s, case when tiplavg=3 then iscrizcat.infnumclass else null end infnumcla_s, case when tiplavg=3 then iscrizcat.supnumclass else null end supnumcla_s, 
						null numclass_l15, case when tiplavg=4 then iscrizcat.infnumclass else null end infnumcla_l15, case when tiplavg=4 then iscrizcat.supnumclass else null end supnumcla_l15, 
						null numclass_sp, case when tiplavg=5 then iscrizcat.infnumclass else null end infnumcla_sp, case when tiplavg=5 then iscrizcat.supnumclass else null end supnumcla_sp, 
						iscrizcat.invrea, iscrizcat.invpen, iscrizcat.altpen, iscrizcat.notpen, iscrizcat.ultnot, iscrizcat.aggrea,
						iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp
				from v_iscrizcat_tit,iscrizcat 
				where v_iscrizcat_tit.caisim = iscrizcat.codcat and v_iscrizcat_tit.tiplavg = iscrizcat.tipcat
			union
			select v_iscrizcat_tit.caisim,
					'Classifica: '|| 
						case when tiplavg=1 then (select tab1desc from tab1 where tab1cod='A1015' and tab1tip=numclass) 
							when tiplavg=2 then (select tab1desc from tab1 where tab1cod='G_035' and tab1tip=numclass) 
							when tiplavg=3 then (select tab1desc from tab1 where tab1cod='G_036' and tab1tip=numclass) 
							when tiplavg=4 then (select tab1desc from tab1 where tab1cod='G_037' and tab1tip=numclass) 
							else (select tab1desc from tab1 where tab1cod='G_049' and tab1tip=numclass) end,
					v_iscrizcat_tit.descat,v_iscrizcat_tit.tiplavg, v_iscrizcat_tit.titnord, v_iscrizcat_tit.titcat, 
					v_iscrizcat_tit.caisord, null,null,
					v_iscrizcat_tit.isfoglia, v_iscrizcat_tit.numliv, v_iscrizcat_tit.numord, 
					iscrizclassi.numclass,null,null,
					case when tiplavg=1 then iscrizclassi.numclass else null end numclass_l, null,null,
					case when tiplavg=2 then iscrizclassi.numclass else null end numclass_f, null,null,
					case when tiplavg=3 then iscrizclassi.numclass else null end numclass_s, null,null,
					case when tiplavg=4 then iscrizclassi.numclass else null end numclass_l150, null,null,
					case when tiplavg=5 then iscrizclassi.numclass else null end numclass_sp, null,null,
					iscrizclassi.invrea, iscrizclassi.invpen, iscrizclassi.altpen, iscrizclassi.notpen, iscrizclassi.ultnot, iscrizclassi.aggrea,
					iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp
				from v_iscrizcat_tit,iscrizcat,iscrizclassi
				where v_iscrizcat_tit.caisim = iscrizcat.codcat and v_iscrizcat_tit.tiplavg = iscrizcat.tipcat
					and iscrizcat.ngara=iscrizclassi.ngara and iscrizcat.codimp=iscrizclassi.codimp 
					and iscrizcat.codcat=iscrizclassi.codcat and iscrizcat.tipcat=iscrizclassi.tipcat;
		perform sp_restoreviews('v_iscrizcat_classi');
		
		--(S.Santi 19.03.2018) Adeguamento per nuovi criteri di rotazione su numero aggiudicazioni
		--
		perform sp_backupanddropviews('v_ditte_elesum');
		create or replace view v_ditte_elesum as 
		   select gare.ngara gara, ditg.dittao codice, ditg.nomimo ragsoc, impr.locimp, impr.proimp, ditg.numordpl numord, ditg.iaggiuele,
						 sum(case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) numinv, 
						 sum(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) numpen,
						 sum(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt,
						 sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
							(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) + 
							(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numir,
						 sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
							(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numip,
						 sum(case when (iscrizcat.aggrea is null) then 0 else iscrizcat.aggrea end) numagg, 
						 sum((case when (iscrizcat.aggrea is null) then 0 else iscrizcat.aggrea end) + 
							(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numap
		   from ditg, impr, iscrizcat, gare 
		   where  ditg.codgar5=gare.codgar1 and ditg.ngara5=gare.ngara 
			  and ditg.dittao=impr.codimp
			  and ditg.codgar5=iscrizcat.codgar and ditg.ngara5=iscrizcat.ngara and ditg.dittao=iscrizcat.codimp 
			  and gare.genere in (10,20)
			  and ditg.abilitaz=1 and (ditg.dabilitaz is not null) and ditg.numordpl is not null
			  group by gare.ngara, ditg.dittao, ditg.nomimo, impr.locimp, impr.proimp, ditg.numordpl, ditg.iaggiuele;
		perform sp_restoreviews('v_ditte_elesum');

		--(S.Santi 19.03.2018) Adeguamento per nuovi criteri di rotazione su numero aggiudicazioni
		--
		perform sp_backupanddropviews('v_ditte_elecat');
		create or replace view v_ditte_elecat as
			with totali as 
		  (select iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp, 
				 sum(case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) numinv, 
				 sum(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) numpen,
				 sum(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt,
				 sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
					(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) + 
					(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numir,
				 sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
					(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numip,
				 sum(case when (iscrizcat.aggrea is null) then 0 else iscrizcat.aggrea end) numagg, 
				 sum((case when (iscrizcat.aggrea is null) then 0 else iscrizcat.aggrea end) + 
					(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numap
			from iscrizcat
			group by codgar, ngara, codimp)
		   select gare.ngara gara, ditg.dittao codice, ditg.nomimo ragsoc, impr.locimp, impr.proimp, ditg.numordpl numord, ditg.iaggiuele,
				  (case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) numinv,
				  (case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) numpen, 
				  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt, 
				  (case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
				  (case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) + 
				  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numir,
				  (case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
				  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numip,
				  (case when (iscrizcat.aggrea is null) then 0 else iscrizcat.aggrea end) numagg,
				  (case when (iscrizcat.aggrea is null) then 0 else iscrizcat.aggrea end) + 
				  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numap,
				  iscrizcat.codcat, iscrizcat.infnumclass, iscrizcat.supnumclass,
				  iscrizclassi.numclass,
				  (case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end) numinvcla,
				  (case when (iscrizclassi.invpen is null) then 0 else iscrizclassi.invpen end) numpencla, 
				  (case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end) numaltcla, 
				  (case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end) + 
				  (case when (iscrizclassi.invpen is null) then 0 else iscrizclassi.invpen end) +
				  (case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end) numircla,
				  (case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end) + 
				  (case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end) numipcla,
				  (case when (iscrizclassi.aggrea is null) then 0 else iscrizclassi.aggrea end) numaggcla,
				  (case when (iscrizclassi.aggrea is null) then 0 else iscrizclassi.aggrea end) + 
				  (case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end) numapcla,
				  totali.numinv numinvtot, totali.numpen numpentot, totali.numalt numalttot,
				  totali.numir numirtot, totali.numip numiptot,
				  totali.numagg numaggtot, totali.numap numaptot
			from ditg inner join gare on (ditg.codgar5=gare.codgar1 and ditg.ngara5=gare.ngara)
				inner join impr on (ditg.dittao=impr.codimp)
				inner join iscrizcat on (ditg.codgar5=iscrizcat.codgar and ditg.ngara5=iscrizcat.ngara and ditg.dittao=iscrizcat.codimp)
				inner join totali on (ditg.codgar5=totali.codgar and ditg.ngara5=totali.ngara and ditg.dittao=totali.codimp)
				left outer join iscrizclassi on (iscrizcat.codgar=iscrizclassi.codgar and iscrizcat.ngara=iscrizclassi.ngara 
					and iscrizcat.codimp=iscrizclassi.codimp and iscrizcat.codcat=iscrizclassi.codcat and iscrizcat.tipcat=iscrizclassi.tipcat)
			where gare.codgar1 like '$%' and gare.genere in (10,20) 
			   and ditg.abilitaz=1 and (ditg.dabilitaz is not null) and ditg.numordpl is not null;
		perform sp_restoreviews('v_ditte_elecat');

		--(S.Santi 19.03.2018) Adeguamento per nuovi criteri di rotazione su numero aggiudicazioni
		--
		perform sp_backupanddropviews('v_ditte_elecat_sa');
		create or replace view v_ditte_elecat_sa as
			with
			totali_altpen as 
				(select iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp, 
					 sum(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt
				from iscrizcat
				group by codgar, ngara, codimp),
			totali_sa as
				(select iscrizuff.cenint, iscrizuff.codgar, iscrizuff.ngara, iscrizuff.codimp, 
					 sum(case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) numinv, 
					 sum(case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end) numpen,
					 sum((case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
						(case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end)) numirnoalt,
					 sum(case when (iscrizuff.aggrea is null) then 0 else iscrizuff.aggrea end) numagg 
				from iscrizuff 
				group by iscrizuff.cenint, iscrizuff.codgar, iscrizuff.ngara, iscrizuff.codimp)
			select gare.ngara gara, ditg.dittao codice, ditg.nomimo ragsoc, impr.locimp, impr.proimp, ditg.numordpl numord, ditg.iaggiuele,
					  (case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) numinv,
					  (case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end) numpen, 
					  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt, 
					  (case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
					  (case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end) + 
					  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numir,
					  (case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
					  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numip,
					  (case when (iscrizuff.aggrea is null) then 0 else iscrizuff.aggrea end) numagg,
					  (case when (iscrizuff.aggrea is null) then 0 else iscrizuff.aggrea end) + 
					  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numap,
					  uffint.codein cenint, iscrizcat.codcat, iscrizcat.tipcat, iscrizcat.infnumclass, iscrizcat.supnumclass,
					  iscrizclassi.numclass,
					  (case when (totali_sa.numinv is null) then 0 else totali_sa.numinv end) numinvtot,
					  (case when (totali_sa.numpen is null) then 0 else totali_sa.numpen end) numpentot,
					  totali_altpen.numalt numalttot,
					  (case when (totali_sa.numirnoalt is null) then totali_altpen.numalt else totali_sa.numirnoalt + totali_altpen.numalt end) numirtot,
					  (case when (totali_sa.numinv is null) then totali_altpen.numalt else totali_sa.numinv + totali_altpen.numalt end) numiptot,
					  (case when (totali_sa.numagg is null) then 0 else totali_sa.numagg end) numaggtot,
					  (case when (totali_sa.numagg is null) then totali_altpen.numalt else totali_sa.numagg + totali_altpen.numalt end) numaptot			  
				from ditg inner join gare on (ditg.codgar5=gare.codgar1 and ditg.ngara5=gare.ngara)
					inner join impr on (ditg.dittao=impr.codimp)
					inner join iscrizcat on (ditg.codgar5=iscrizcat.codgar and ditg.ngara5=iscrizcat.ngara and ditg.dittao=iscrizcat.codimp)
					inner join uffint on (1=1)
					left outer join iscrizuff on (uffint.codein=iscrizuff.cenint and iscrizuff.codgar=iscrizcat.codgar and iscrizuff.ngara=iscrizcat.ngara 
									and iscrizuff.codimp=iscrizcat.codimp and iscrizuff.codcat=iscrizcat.codcat and iscrizuff.tipcat=iscrizcat.tipcat)
					left outer join totali_sa on (uffint.codein=totali_sa.cenint and ditg.codgar5=totali_sa.codgar and ditg.ngara5=totali_sa.ngara and ditg.dittao=totali_sa.codimp)
					inner join totali_altpen on (ditg.codgar5=totali_altpen.codgar and ditg.ngara5=totali_altpen.ngara and ditg.dittao=totali_altpen.codimp)
					left outer join iscrizclassi on (iscrizcat.codgar=iscrizclassi.codgar and iscrizcat.ngara=iscrizclassi.ngara 
						and iscrizcat.codimp=iscrizclassi.codimp and iscrizcat.codcat=iscrizclassi.codcat and iscrizcat.tipcat=iscrizclassi.tipcat)
				where gare.codgar1 like '$%' and gare.genere in (10,20) 
				   and ditg.abilitaz=1 and (ditg.dabilitaz is not null) and ditg.numordpl is not null;
		perform sp_restoreviews('v_ditte_elecat_sa');
		
		update eldaver set numver = '6.16.11', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.11', datvet = now() where codapp = 'G1';
	
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';
	
		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');



  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.11' or numver like '6.16.11.%')) THEN
	       
		ALTER TABLE GARECONT ADD CODBIC VARCHAR(11);
		ALTER TABLE GARECONT ADD DITGAQ VARCHAR(11);

		--Nuovo valore per 'Tipo classifica elenco'
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A2088',3,'Nessuna classifica',NULL,0,NULL);

		--Aggiornamento C0CAMPI
        delete from c0campi where c0c_mne_ber in ('G1CODBIC','G1CODBICDQ');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODBIC.GARECONT.GARE','G1CODBIC','Conto corrente dedicato: codice BIC (o SWIFT)','Coord.banc.:cod.BIC','A11',NULL,NULL,'Conto corrente dedicato:codice BIC');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODBIC.DITGAQ.GARE','G1CODBICDQ','Conto corrente dedicato: codice BIC (o SWIFT)','Coord.banc.:cod.BIC','A11',NULL,NULL,'Conto corrente dedicato:codice BIC');

 		UPDATE c0campi set  coc_des='Conto corrente dedicato: codice IBAN', coc_des_frm='Coord.banc.:cod.IBAN', coc_des_web='Conto corrente dedicato:codice IBAN' where c0c_mne_ber in ('G1COORBA','G1COORBADQ');

		--Aggiornamento profili
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.FASIISCRIZIONE.VerificaOpertoriArt80','Richiedi verifica operatori art.80',5414);

		update eldaver set numver = '6.16.12', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.12', datvet = now() where codapp = 'G1';
	
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';
	
		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');



  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.12' or numver like '6.16.12.%')) THEN

		-- Nuovi campi per RaiWay,Valore totale stimato dell'appalto
		ALTER TABLE GARE1 ADD IMPMANO NUMERIC(24,5);
		ALTER TABLE GARE1 ADD AMMRIN VARCHAR(1);
		ALTER TABLE GARE1 ADD DESRIN VARCHAR(2000);
		ALTER TABLE GARE1 ADD IMPRIN NUMERIC(24,5);
		ALTER TABLE GARE1 ADD AMMOPZ VARCHAR(1);
		ALTER TABLE GARE1 ADD DESOPZ VARCHAR(2000);
		ALTER TABLE GARE1 ADD IMPSERV NUMERIC(24,5);
		ALTER TABLE GARE1 ADD IMPPROR NUMERIC(24,5);
		ALTER TABLE GARE1 ADD IMPALTRO NUMERIC(24,5);

        --Nuova tabella per le richieste di acquisto per Raiway
		CREATE TABLE GARERDA (
  			ID NUMERIC(12) NOT NULL,
  			CODGAR VARCHAR(21),
                        DATCRE TIMESTAMP,
  			DATRIL TIMESTAMP,
  			NUMRDA VARCHAR(30),
		primary key (ID));
		ALTER TABLE GARERDA ADD CONSTRAINT FK_GARERDA_TORN FOREIGN KEY ( CODGAR) REFERENCES TORN( CODGAR ) ON DELETE CASCADE;

		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('GARERDA',0);

		--Inizializzazione campi in GARE1 con i valori dei corrispondenti campi dismessi in TORN
		update gare1 set ammopz=(select ammopz from torn where codgar=gare1.codgar1 and ammopz is not null) where not exists(select ngara from gare where genere=3 and ngara=gare1.ngara) and ammopz is null;
		update gare1 set desopz=(select desopz from torn where codgar=gare1.codgar1 and desopz is not null) where not exists(select ngara from gare where genere=3 and ngara=gare1.ngara) and desopz is null;
		update gare1 set ammrin=(select ammrin from torn where codgar=gare1.codgar1 and ammrin is not null) where not exists(select ngara from gare where genere=3 and ngara=gare1.ngara) and ammrin is null;
		update gare1 set desrin=(select desrin from torn where codgar=gare1.codgar1 and desrin is not null) where not exists(select ngara from gare where genere=3 and ngara=gare1.ngara) and desrin is null;

		--Nuovo valore per 'Stato abilitazione elenco operatori'
		IF (select count(*) = 0 from tab1 where tab1cod='A1075' and tab1tip=9) THEN
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1075',9,'Soccorso istruttorio in corso',NULL,2.5,NULL);
		END IF;
		
		--Aggiornamento C0CAMPI
        delete from c0campi where c0c_mne_ber in ('G1IMPMANOG','G1AMMRING','G1DESRING', 'G1IMPRIN','G1AMMOPZG','G1DESOPZG','G1IMPSERV','G1IMPPROR','G1IMPALTRO');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPMANO.GARE1.GARE','G1IMPMANOG','Costi della manodopera (art.23 c.16 DLgs.50/2016)','Costi manodopera','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AMMRIN.GARE1.GARE','G1AMMRING','Contratto d''appalto oggetto di rinnovo?','Oggetto di rinnovo?','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DESRIN.GARE1.GARE','G1DESRING','Descrizione dei rinnovi','Descrizione rinnovi','A2000',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPRIN.GARE1.GARE','G1IMPRIN','Importo rinnovi contratto','Importo rinnovi','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AMMOPZ.GARE1.GARE','G1AMMOPZG','Ricorso a opzioni?','Ricorso a opzioni?','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DESOPZ.GARE1.GARE','G1DESOPZG','Descrizione delle opzioni','Descrizione opzioni','A2000',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPSERV.GARE1.GARE','G1IMPSERV','Importo affidamento servizi analoghi','Importo serv.anal.','F15',NULL,'MONEY','Importo affidamento servizi analoghi');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPPROR.GARE1.GARE','G1IMPPROR','Importo proroga tecnica ','Importo proroga tecn','F15',NULL,'MONEY','Importo proroga tecnica');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPALTRO.GARE1.GARE','G1IMPALTRO','Importo altre opzioni','Importo altre opz.','F15',NULL,'MONEY','Importo altre opzioni');

        delete from c0campi where c0c_mne_ber in ('G1CODGAR_IM','G1NGARA_IM','G1IMPAPP_IM', 'G1IMPRIN_IM','G1IMPSERV_IM','G1IMPPROR_IM','G1IMPALTRO_IM','G1IMPMAX_IM');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODGAR.V_GARE_IMPORTI.GARE','G1CODGAR_IM','Codice della gara divisa in lotti','Codice gara in lotti','A21',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.V_GARE_IMPORTI.GARE','G1NGARA_IM','Codice gara','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPAPP.V_GARE_IMPORTI.GARE','G1IMPAPP_IM','Importo a base di gara','Imp.base di gara','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPRIN.V_GARE_IMPORTI.GARE','G1IMPRIN_IM','Importo rinnovo contratto','Imp.rinnovi','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPSERV.V_GARE_IMPORTI.GARE','G1IMPSERV_IM','Importo affidamento servizi analoghi','Imp.servizi analoghi','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPPROR.V_GARE_IMPORTI.GARE','G1IMPPROR_IM','Importo proroga tecnica','Imp.proroga','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPALTRO.V_GARE_IMPORTI.GARE','G1IMPALTRO_IM','Importo altre opzioni','Imp.altre opzioni','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'VALMAX.V_GARE_IMPORTI.GARE','G1IMPMAX_IM','Valore massimo stimato','Valore max.stimato','F15',NULL,'MONEY','Valore massimo stimato');

        delete from c0campi where c0c_mne_ber in ('G1IDGARERDA','G1CODGARRDA','G1DATCRERDA', 'G1DATRILRDA','G1NUMRDA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ID.GARERDA.GARE','G1IDGARERDA','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODGAR.GARERDA.GARE','G1CODGARRDA','Codice della gara','Codice gara','A21',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATCRE.GARERDA.GARE','G1DATCRERDA','Data creazione dell''RdA ','Data creazione','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATRIL.GARERDA.GARE','G1DATRILRDA','Data rilascio dell''RdA','Data rilascio','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMRDA.GARERDA.GARE','G1NUMRDA','Numero dell''RdA','Numero','A30',NULL,NULL,NULL);

		update C0CAMPI set COC_DES='Ulteriori note motivo ricorso a proc.non ordinaria', COC_DES_FRM='Ult.motivo non ord.', COC_DES_WEB='Ulteriori note motivo ricorso a proc.non ordinaria' where C0C_MNE_BER='G1ALTNEG';
		update C0CAMPI set COC_DES='Motivo del ricorso a procedura non ordinaria', COC_DES_FRM='Motivo proc.non ord.', COC_DES_WEB='Motivo ricorso a proced.non ordinaria' where C0C_MNE_BER='G1TIPNEG_G';
		update C0CAMPI set COC_DES='Motivo del ricorso a procedura non ordinaria', COC_DES_FRM='Motivo proc.non ord.', COC_DES_WEB='Motivo ricorso a proced.non ordinaria' where C0C_MNE_BER='G1TIPNEG';
		update C0CAMPI set COC_DES_FRM='Imp.compl.base gara', COC_DES_WEB='Importo complessivo a base di gara' where C0C_MNE_BER='G1IMPTOR';
		update C0CAMPI set COC_DES='Ricorso a opzioni? (NON USATO)',COC_DES_FRM='NON USATO',C0C_TIP='C' where C0C_MNE_BER='G1AMMOPZ';
		update C0CAMPI set COC_DES='Descrizione delle opzioni (NON USATO)',COC_DES_FRM='NON USATO',C0C_TIP='C' where C0C_MNE_BER='G1DESOPZ';
		update C0CAMPI set COC_DES='Contratto d''appalto oggetto di rinnovo? (NON USATO)',COC_DES_FRM='NON USATO',C0C_TIP='C' where C0C_MNE_BER='G1AMMRIN';
		update C0CAMPI set COC_DES='Descrizione dei rinnovi (NON USATO)',COC_DES_FRM='NON USATO',C0C_TIP='C' where C0C_MNE_BER='G1DESRIN';
		
		--Aggiornamento C0ENTIT
		delete from c0entit where c0e_nom in ('V_GARE_IMPORTI.GARE','GARERDA.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('V_GARE_IMPORTI.GARE',0,'E','GARE_IMPOR','Importi complessivi gara e lotti di gara','CODGAR.V_GARE_IMPORTI.GARE ','TORN.GARE','CODGAR.TORN.GARE',NULL,NULL,'g1_gimp0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARERDA.GARE',0,'E','GARA_RDA','Richieste di acquisto (RdA) della gara','CODGAR.GARERDA.GARE','TORN.GARE','CODGAR.TORN.GARE',NULL,NULL,'g1_rdag0');

         --Aggiornamento profili
		UPDATE W_OGGETTI SET descr='Funzione Crea formulari GUUE' where oggetto='ALT.GARE.GARE.InviaBandoAvviso';
		-- Sezione Opzioni e rinnovi - Rai way
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.ALTRIDATI.OPZ','Sezione Opzioni e rinnovi',2772);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.DATIGENOFFUNICA.OPZ','Sezione Opzioni e rinnovi',3965);
		-- Sezione dinamiche Richieste di acquisto - Raiway
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.DATIGEN.GARERDA','Sezioni dinamiche "Richiesta di acquisto"',2326);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.GARE-scheda.DATIGEN.DEL-GARERDA','Funzione elimina richiesta di acquisto',13470);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.GARE-scheda.DATIGEN.INS-GARERDA','Funzione nuova richiesta di acquisto',13480);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-scheda.DATIGEN.GARERDA','Sezioni dinamiche "Richiesta di acquisto',2128);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.TORN-scheda.DATIGEN.DEL-GARERDA','Funzione elimina richiesta di acquisto',13490);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.TORN-scheda.DATIGEN.INS-GARERDA','Funzione nuova richiesta di acquisto',13500);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-OFFUNICA-scheda.DATIGEN.GARERDA','Sezioni dinamiche "Richiesta di acquisto',3571);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.TORN-OFFUNICA-scheda.DATIGEN.DEL-GARERDA','Funzione elimina richiesta di acquisto',13510);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.TORN-OFFUNICA-scheda.DATIGEN.INS-GARERDA','Funzione nuova richiesta di acquisto',13520);
                
        INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('SEZ','VIS','GARE.TORN-scheda.DATIGEN.GARERDA','Visualizza',0,1,1,1568929277);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('SEZ','VIS','GARE.GARE-scheda.DATIGEN.GARERDA','Visualizza',0,1,1,660931221);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('SEZ','VIS','GARE.TORN-OFFUNICA-scheda.DATIGEN.GARERDA','Visualizza',0,1,1,3750502612);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('FUNZ','VIS','INS.GARE.GARE-scheda.DATIGEN.INS-GARERDA','Visualizza',0,1,1,4059537891);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('FUNZ','VIS','INS.GARE.TORN-scheda.DATIGEN.INS-GARERDA','Visualizza',0,1,1,119199506);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('FUNZ','VIS','INS.GARE.TORN-OFFUNICA-scheda.DATIGEN.INS-GARERDA','Visualizza',0,1,1,3444920732);

		-- View Importi di gara e lotto di gara
		create or replace view V_GARE_IMPORTI as
		 select torn.codgar,case when SUBSTR(torn.codgar,1,1)='$' then SUBSTR(torn.codgar,2,20) else null end ngara,
				case when SUBSTR(torn.codgar,1,1)='$' then sum(impapp) else imptor end impapp, sum(imprin) imprin, sum(impserv) impserv, sum(imppror) imppror, sum(impaltro) impaltro,
				coalesce(case when SUBSTR(torn.codgar,1,1)='$' then sum(impapp) else imptor end,0) + coalesce(sum(imprin),0) + coalesce(sum(impserv),0) + coalesce(sum(imppror),0) + coalesce(sum(impaltro),0) valmax
		  from torn,gare,gare1
		  where torn.codgar=gare.codgar1 and gare.ngara=gare1.ngara and
				not exists (select ngara from gare where torn.codgar=gare.codgar1 and gare.genere in (4,10,11,20))
				group by torn.codgar, torn.imptor
		 union
		 select gare.codgar1, gare.ngara, impapp impapp, imprin, impserv,imppror, impaltro,
				case when impapp is null and imprin is null and impserv is null and imppror is null and impaltro is null then null
				  else coalesce(impapp,0) + coalesce(imprin,0) + coalesce(impserv,0) + coalesce(imppror,0) + coalesce(impaltro,0) end valmax
		 from gare,gare1 where gare.ngara=gare1.ngara and SUBSTR(gare.codgar1,1,1)<>'$' and (gare.genere is null or gare.genere not in (3,4,10,11,20));

		update eldaver set numver = '6.16.13', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.13', datvet = now() where codapp = 'G1';
	
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';
	
		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');



  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.13' or numver like '6.16.13.%')) THEN
	
		--(S.Santi 17.07.2018) Correzione definizione campi per errore in agg.61611to61612 - solo Postgres
		IF not exists (SELECT column_name FROM information_schema.columns WHERE table_name='ditgaq' and column_name='codbic') THEN
			ALTER TABLE DITGAQ ADD CODBIC VARCHAR(11);
			ALTER TABLE GARECONT DROP COLUMN DITGAQ;
		end if;

		-- Nuovi campi per AVM --GCAP
		ALTER TABLE GCAP ADD DATACONS DATE;
		ALTER TABLE GCAP ADD LUOGOCONS VARCHAR(2000);
		-- Nuovi campi per AVM -- GARERDA
		ALTER TABLE GARERDA ADD POSRDA VARCHAR(20);
		ALTER TABLE GARERDA ADD DATACONS DATE;
		ALTER TABLE GARERDA ADD LUOGOCONS VARCHAR(2000);
		-- Nuovi campi per AVM -- GARE1
		ALTER TABLE GARE1 ADD NUMRDO VARCHAR(30);
		
		-- Nuova tabella GAREUUID
		CREATE TABLE GARUUID (
		ID NUMERIC(12) NOT NULL,
		CODGAR VARCHAR(21),
		TIPRIC VARCHAR(30),
		UUID VARCHAR(40),
		primary key (ID));
		ALTER TABLE GARUUID ADD CONSTRAINT FK_GARUUID_TORN FOREIGN KEY ( CODGAR) REFERENCES TORN( CODGAR ) ON DELETE CASCADE;

		insert into w_genchiavi (tabella,chiave) values ('GARUUID',0);

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1064',10,'Atti e documenti (art.29 c.1 DLgs 50/2016)',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('W_004', 11, 'Avvisi', NULL, 0,NULL);
		
		UPDATE C0CAMPI set COC_DES='Data rilascio controller dell''RdA', COC_DES_FRM='Data rilasc.controll', COC_DES_WEB ='Data rilascio controller' where C0C_MNE_BER = 'G1DATRILRDA';
		
		-- Nuovi campi per AVM --GCAP
		delete from c0campi where c0c_mne_ber in ('G1_DATACONS','G1_LUOGOCONS','G1POSRDA','G1DATACONS','G1LUOGOCONS','G1NUMRDO');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATACONS.GCAP.GARE','G1_DATACONS','Data consegna','Data consegna','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'LUOGOCONS.GCAP.GARE','G1_LUOGOCONS','Luogo di consegna','Luogo di consegna','A2000',NULL,NULL,NULL);
		-- Nuovi campi per AVM -- GARERDA
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'POSRDA.GARERDA.GARE','G1POSRDA','Posizione','Posizione','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATACONS.GARERDA.GARE','G1DATACONS','Data consegna','Data consegna','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'LUOGOCONS.GARERDA.GARE','G1LUOGOCONS','Luogo di consegna','Luogo di consegna','A2000',NULL,NULL,NULL);
		-- Nuovi campi per AVM -- GARE1
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMRDO.GARE1.GARE','G1NUMRDO','Numero Rdo','Numero Rdo','A30',NULL,NULL,NULL);
		-- Nuova tabella GAREUUID
		delete from c0campi where c0c_mne_ber in ('G1IDGARUID','G1CODGARU','G1TIPRICU', 'G1UUIDU');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ID.GARUUID.GARE','G1IDGARUID','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODGAR.GARUUID.GARE','G1CODGARU','Codice della gara','Codice gara','A21',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TIPRIC.GARUUID.GARE','G1TIPRICU','Tipo di richiesta a cui Ã¨ riferito il codice UUID generato','Tipo richiesta','A30',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'UUID.GARUUID.GARE','G1UUIDU','Identificativo univoco generale (UUID)','UUID','A40',NULL,NULL,NULL);
		
		-- Nuova tabella GAREUUID
		DELETE FROM C0ENTIT WHERE C0E_NOM IN ('GARUUID.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARUUID.GARE',0,'E','GARA_UUID','UUID della gara generati per integrazioni esterne','CODGAR.GARUUID.GARE','TORN.GARE','CODGAR.TORN.GARE',NULL,NULL,'g1_uuid0');

		if (select count(*)=0 from w_oggetti where tipo='FUNZ' and oggetto='ALT.GARE.TORN-scheda.DATIGEN.PubblicaSuPortale')
		THEN
			INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.TORN-scheda.DATIGEN.PubblicaSuPortale','Funzione Pubblica su portale',13460);
		END IF;

		--Nuovi parametri per SSO OpenID
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','sso.attribute.login',null,'Autenticazione Single-Sign-On','Attributo ricevuto e che individua la login',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','sso.attribute.firstName',null,'Autenticazione Single-Sign-On','Attributo ricevuto e che individua il nome utente',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','sso.attribute.lastName',null,'Autenticazione Single-Sign-On','Attributo ricevuto e che individua il cognome utente',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','sso.attribute.description',null,'Autenticazione Single-Sign-On','Attributo ricevuto e che individua la denominazione utente',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','sso.attribute.mail',null,'Autenticazione Single-Sign-On','Attributo ricevuto e che individua l''indirizzo mail',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','sso.attribute.fiscalCode',null,'Autenticazione Single-Sign-On','Attributo ricevuto e che individua il codice fiscale',null);
		
        UPDATE W_CONFIG set DESCRIZIONE='URL del web service per l''invio dati per composizione formulari GUUE (es.: http://localhost:8080/FEU/rest/)' where CODAPP='PG' and CHIAVE='it.eldasoft.bandoavvisosimap.ws.url';
		
		--riformulazione della view per introduzione dei nuovi attributi data e luogo consegna
		perform sp_backupanddropviews('v_gcapd');
		create or replace view v_gcapd as
		  select gcap.ngara,gcap.contaf,gcap.norvoc,gcap.codvoc,gcap.unimis,gcap.quanti,gcap.prezun,
		  gcap.perciva,gcap.clasi1,gcap.numpar,gcap.voce,gcap.solsic,gcap.sogrib,gcap.dittao,
		  gcap.codcarr,gcap.codrda,gcap.posrda,gcap.datacons,ditg.dittao as cod_ditta, ditg.codgar5 as codgar, gare.codiga
		  from gcap, ditg, gare
		  where gcap.ngara=ditg.ngara5 and (gcap.dittao is null or gcap.dittao=ditg.dittao)
		   and gcap.ngara=gare.ngara;
		perform sp_restoreviews('v_gcapd');
		--riformulazione della view per introduzione dei nuovi attributi data e luogo consegna
		perform sp_backupanddropviews('v_gcap_dpre');
		create or replace view v_gcap_dpre as
			select (case when v_gcapd.dittao is null then '2' else '1' end) as issoloditta,
				   (case when v_gcapd.quanti=dpre.quanti or dpre.quanti is null then '2' else '1' end) as isquantimod,
				   v_gcapd.codgar, v_gcapd.ngara, v_gcapd.codiga, v_gcapd.contaf, v_gcapd.cod_ditta, v_gcapd.norvoc,
				   v_gcapd.codvoc, v_gcapd.voce, v_gcapd.solsic, v_gcapd.sogrib, v_gcapd.unimis,
				   v_gcapd.codcarr, v_gcapd.codrda, v_gcapd.posrda, v_gcapd.datacons, dpre.quanti,
				   (case when dpre.unimis is null then v_gcapd.unimis else dpre.unimis end) as unimiseff, 
				   (case when dpre.quanti is null then v_gcapd.quanti else dpre.quanti end) as quantieff, 
				   (case when v_gcapd.solsic='1' or v_gcapd.sogrib='1' then v_gcapd.prezun else dpre.preoff end) as preoff, 
				   (case when dpre.perciva is null then v_gcapd.perciva else dpre.perciva end) as percivaeff, 
				   (case when v_gcapd.solsic='1' or v_gcapd.sogrib='1' then round(v_gcapd.prezun*v_gcapd.quanti,5) else dpre.impoff end) as impoff,
				   dpre.reqmin as reqmin			       
			 from v_gcapd left outer join dpre 
			   on v_gcapd.cod_ditta=dpre.dittao and v_gcapd.ngara=dpre.ngara and v_gcapd.contaf=dpre.contaf;
		perform sp_restoreviews('v_gcap_dpre');

		update eldaver set numver = '6.16.14', datvet = now() where codapp = 'PG';
		update eldaver set numver = '6.16.14', datvet = now() where codapp = 'G1';
	
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';
	
		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');



  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and (numver = '6.16.14' or numver like '6.16.14.%')) THEN
	
	       ALTER TABLE GARE1 ADD AQOPER NUMERIC(7);
               ALTER TABLE GARE1 ADD AQNUMOPE NUMERIC(3);
               
               CREATE TABLE DITGEVENTI (
			CODGAR VARCHAR(21) NOT NULL,
			NGARA VARCHAR(20) NOT NULL,
			DITTAO VARCHAR(10) NOT NULL,
			DATFS10 TIMESTAMP,
			DATFS10A TIMESTAMP,
			DATFS11 TIMESTAMP,
			DATFS11A TIMESTAMP,
			DATFS11B TIMESTAMP,
			DATFS11C TIMESTAMP,
			primary key (CODGAR,NGARA,DITTAO));
	       ALTER TABLE DITGEVENTI ADD CONSTRAINT FK_DITGEVENTI_DITG FOREIGN KEY ( CODGAR,DITTAO,NGARA) REFERENCES DITG( CODGAR5,DITTAO,NGARA5 ) ON DELETE CASCADE;
		   
			create table G1CRIREG (
			id numeric(12) not null,
			idcridef numeric(12),
			puntuale varchar(100), 
			valmin numeric(24,5), 
			valmax numeric(24,5),
			coeffi numeric(24,5),
			primary key(id));
			ALTER TABLE G1CRIREG ADD CONSTRAINT FK_G1CRIREG_G1CRIDEF FOREIGN KEY ( IDCRIDEF ) REFERENCES G1CRIDEF( ID ) ON DELETE CASCADE;
			
			ALTER TABLE G1CRIVAL ADD VALSTG VARCHAR(2000);
			ALTER TABLE G1CRIVAL ADD VALDAT TIMESTAMP;
			ALTER TABLE G1CRIVAL ADD VALNUM NUMERIC(24,5);

            CREATE TABLE GARVARPRE (
			ID NUMERIC(12) NOT NULL,
			NGARA VARCHAR(20),
			CONTAF NUMERIC(7),
			DITTAO VARCHAR(10),
			PREZZO NUMERIC(24,5),
			IMPORTO NUMERIC(24,5),
			NUMVAR NUMERIC(5),
			DATAORAVAR TIMESTAMP,
			PRIMARY KEY(ID));
            ALTER TABLE GARVARPRE ADD CONSTRAINT FK_GARVARPRE_DPRE FOREIGN KEY ( NGARA, CONTAF, DITTAO ) REFERENCES DPRE( NGARA, CONTAF, DITTAO) ON DELETE CASCADE;
            ALTER TABLE GARVARPRE ADD CONSTRAINT FK_GARVARPRE_GCAP FOREIGN KEY ( NGARA, CONTAF ) REFERENCES GCAP( NGARA, CONTAF) ON DELETE CASCADE;
				
			CREATE TABLE G1CRIMOD (
			ID NUMERIC(12) NOT NULL,
			TITOLO VARCHAR(100),
			DESCRI VARCHAR(2000),
			primary key (ID));	
			
			CREATE TABLE GOEVMOD (
			ID NUMERIC(12) NOT NULL,
			IDCRIMOD NUMERIC(12) NOT NULL,
			NECVAN NUMERIC(7),
			NORPAR NUMERIC(24,5),
			TIPPAR NUMERIC(7),
			ISNOPRZ VARCHAR(1),
			MAXPUN NUMERIC(24,5),
			MINPUN NUMERIC(24,5),
			DESPAR VARCHAR(2000),
			LIVPAR NUMERIC(7),
			NECVAN1 NUMERIC(7),
			NORPAR1 NUMERIC(24,5),
			primary key (ID));
			ALTER TABLE GOEVMOD ADD CONSTRAINT FK_GOEVMOD_G1CRIMOD FOREIGN KEY ( IDCRIMOD ) REFERENCES G1CRIMOD( ID ) ON DELETE CASCADE;
			
			ALTER TABLE G1CRIDEF ADD IDGOEVMOD NUMERIC(12);
			ALTER TABLE G1CRIDEF ADD CONSTRAINT FK_G1CRIDEF_GOEVMOD FOREIGN KEY ( IDGOEVMOD ) REFERENCES GOEVMOD( ID ) ON DELETE CASCADE;
			
			ALTER TABLE DPUN ADD PUNTEGRIP1 NUMERIC(24,9);
			ALTER TABLE DPUN ADD COEFFIRIP1 NUMERIC(24,9);

            ALTER TABLE TORN ADD TIPLAV NUMERIC(7);
			ALTER TABLE TORN ADD RICMANO VARCHAR(1);

			ALTER TABLE GARE1 ADD RIBAGGINI NUMERIC(24,9);
			ALTER TABLE GARE1 ADD IAGGIUINI NUMERIC(24,5);
			ALTER TABLE DITGAQ ADD RIBAGGINI NUMERIC(24,9);
			ALTER TABLE DITGAQ ADD IAGGIUINI NUMERIC(24,5);

			--Inserimento nuova occorrenza in w_genchiavi
			INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('G1CRIREG',0);
			INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('GARVARPRE',0);
			
			INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('GOEVMOD',0);
			INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('G1CRIMOD',0);
			
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1115',5,'1  Costi manodopera e sicurezza aziend.richiesti in offerta(1)  non richiesti (2)',NULL,0,NULL);

			--Inizializzazione dei campi AQOPER e AQNUMOPE di GARE1 con i valori dei corrispondenti campi in TORN
			update gare1 set aqoper = (select aqoper from torn where codgar1=codgar and aqoper is not null) where not exists(select ngara from gare where genere=3 and ngara=gare1.ngara) and aqoper is null;
			update gare1 set aqnumope = (select aqnumope from torn where codgar1=codgar and aqnumope is not null) where not exists(select ngara from gare where genere=3 and ngara=gare1.ngara) and aqnumope is null;

			--Sbiancamento del campo TIPLAV di GARE
			update gare set TIPLAV = null;

		   --Aggiornamento della data di DOCUMGARA.DATARILASCIO con la data di pubblicazione
		   update documgara set datarilascio = (select dinpubg from pubg where (pubg.ngara=documgara.ngara or pubg.ngara=documgara.codgar) and tippubg=12) where STATODOC = 5 and datarilascio is null and gruppo in (4,10) and exists (select dinpubg from pubg where (pubg.ngara=documgara.ngara or pubg.ngara=documgara.codgar) and tippubg=12);
		   update documgara set datarilascio = (select datpub from pubbli where codgar9=codgar and tippub=13 limit 1) where STATODOC = 5 and datarilascio is null and gruppo in (6,3,10) and exists (select datpub from pubbli where codgar9=codgar and tippub=13);
		   update documgara set datarilascio = (select datpub from pubbli where codgar9=codgar and tippub=11 limit 1) where STATODOC = 5 and datarilascio is null and gruppo in (1,2,3,10) and exists (select datpub from pubbli where codgar9=codgar and tippub=11);
	
			--Nuovo campo tabellato
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1147',1,'Elenco valori',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1147',2,'Elenco range',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1147',3,'Proporzionalità diretta',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1147',4,'Bilineare con soglia coefficiente 0.8 (al rialzo)',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1147',5,'Bilineare con soglia coefficiente 0.85 (al rialzo)',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1147',6,'Bilineare con soglia coefficiente 0.9 (al rialzo)',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1147',7,'Proporzionalità inversa',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1147',8,'Bilineare con soglia coefficiente 0.8 (al ribasso)',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1147',9,'Bilineare con soglia coefficiente 0.85 (al ribasso)',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1147',10,'Bilineare con soglia coefficiente 0.9 (al ribasso)',NULL,NULL,NULL);
			
			--Popolamento di TAB1 col nuovo valore A1150
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1150',6,'Costruzione',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1150',7,'Demolizione',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1150',8,'Recupero',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1150',9,'Ristrutturazione',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1150',10,'Restauro',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1150',12,'Manutenzione ordinaria',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1150',13,'Manutenzione straordinaria',NULL,NULL,NULL);
		  
			--Nuovi parametri
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1151',1,'0   bloccante(1) non bloccante(0)',NULL,NULL,NULL);
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1152',1,'1   Attiva blocco(1) Disattiva blocco(0)',NULL,NULL,NULL);

			--Corretto mappatura 'Tipo procedura' per Vigilanza-Richiesta cig
			update tab2 set tab2nord=14 where tab2cod='A1z05' and tab2tip=72 and tab2nord=25;

			INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1151','Modalità controllo unicità codice CIG',NULL);
			INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1152','Procedure telematiche: blocco invio comunicazioni per punto istruttore',NULL);

		--Inizializzo il nuovo campo torn RICMANO
		UPDATE TORN SET RICMANO = '1'
		where exists (select impsicazi, gartel from DITG where TORN.CODGAR = DITG.CODGAR5 AND (torn.gartel = 1 or (impmano is not null or impsicazi is not null)))
		and ricmano is null;
          

		-- Aggiornamento C0CAMPI
		delete from c0campi where c0c_mne_ber in ('G1AQOPERG1','G1AQNUMOPG1');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AQOPER.GARE1.GARE','G1AQOPERG1','Modalità selezione operatori per l''accordo quadro','Mod.operatori acc.q.','A100','A1118',NULL,'Conclusione accordo quadro con');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'AQNUMOPE.GARE1.GARE','G1AQNUMOPG1','Numero massimo operatori dell''accordo quadro','N.operatori acc.qua.','N3',NULL,NULL,'N.operatori accordo quadro');

		delete from c0campi where c0c_mne_ber in ('G1CODGARDE','G1NGARADE','G1DITTAODE','G1DATFS10','G1DATFS10A','G1DATFS11','G1DATFS11A','G1DATFS11B','G1DATFS11C');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','CODGAR.DITGEVENTI.GARE','G1CODGARDE','Codice della gara divisa in lotti','Codice gara in lotti','A21',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','NGARA.DITGEVENTI.GARE','G1NGARADE','Codice della gara','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','DITTAO.DITGEVENTI.GARE','G1DITTAODE','Cod. ditta partecipante alla gara','Codice ditta','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATFS10.DITGEVENTI.GARE','G1DATFS10','Data acquisizione domanda di partecipazione','Data acq.dom.partec.','A19',NULL,'TIMESTAMP',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATFS10A.DITGEVENTI.GARE','G1DATFS10A','Data apertura busta prequalifica','Data aper.busta preq','A19',NULL,'TIMESTAMP',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATFS11.DITGEVENTI.GARE','G1DATFS11','Data acquisizione offerta','Data acq.offerta','A19',NULL,'TIMESTAMP',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATFS11A.DITGEVENTI.GARE','G1DATFS11A','Data apertura busta amministrativa','Data aper.busta amm.','A19',NULL,'TIMESTAMP',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATFS11B.DITGEVENTI.GARE','G1DATFS11B','Data apertura busta tecnica','Data aper.busta tec.','A19',NULL,'TIMESTAMP',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATFS11C.DITGEVENTI.GARE','G1DATFS11C','Data apertura busta economica','Data aper.busta eco.','A19',NULL,'TIMESTAMP',NULL);
		
		delete from c0campi where c0c_mne_ber in ('G1IDCRIREG','G1IDCDEF1','G1PUNTUAR','G1VALMINR','G1VALMAXR','G1COEFFIR');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.G1CRIREG.GARE','G1IDCRIREG','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IDCRIDEF.G1CRIREG.GARE','G1IDCDEF1','Id dettaglio definizione criterio di valutazone','Id dett.definizione','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PUNTUALE.G1CRIREG.GARE','G1PUNTUAR','Valore puntuale','Valore puntuale','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'VALMIN.G1CRIREG.GARE','G1VALMINR','Limite inferiore dell''intervallo (>=)','Limite inferiore(>=)','F12.5',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'VALMAX.G1CRIREG.GARE','G1VALMAXR','Limite superiore dell''intervallo (<)','Limite superiore(<)','F12.5',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'COEFFI.G1CRIREG.GARE','G1COEFFIR','Coefficiente da applicare','Coefficiente','F12.9',NULL,NULL,NULL);

		delete from c0campi where c0c_mne_ber in ('G1VALSTG','G1VALDAT','G1VALNUM');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'VALSTG.G1CRIVAL.GARE','G1VALSTG','Valore offerto in formato stringa','Valore off.stringa','A2000',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'VALDAT.G1CRIVAL.GARE','G1VALDAT','Valore offerto in formato data','Valore off.data','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'VALNUM.G1CRIVAL.GARE','G1VALNUM','Valore offerto in formato numero','Valore off.numero','F12.5',NULL,NULL,NULL);

		delete from c0campi where c0c_mne_ber in ('G1TIPLAV','G1TIPLAVG','G1RICMANO');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TIPLAV.TORN.GARE','G1TIPLAV','Tipologia di lavoro','Tipologia lavoro','A100','A1150',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TIPLAV.GARE.GARE','G1TIPLAVG','Tipologia di lavoro','Tipologia lavoro','A100','A1150',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',null,'RICMANO.TORN.GARE','G1RICMANO','Richiesti costi manodopera e sicurezza aziend.in off.econ.?','Rich.manod.e sic.az?','A2',NULL,'SN','Richiesti costi manodopera e sicurezza aziendale?');

		delete from c0campi where c0c_mne_ber in ('G1IDVP','G1NGARAVP','G1CONTAFVP','G1DITTAOVP','G1PREZZOVP','G1IMPORTVP','G1NUMVARVP','G1DOVARVP');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.GARVARPRE.GARE','G1IDVP','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.GARVARPRE.GARE','G1NGARAVP','Codice gara a lotto unico o lotto di gara ','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CONTAF.GARVARPRE.GARE','G1CONTAFVP','Numero progressivo della lavorazione o fornitura','N.progressivo','N4',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DITTAO.GARVARPRE.GARE','G1DITTAOVP','Cod. ditta partecipante alla gara','Codice ditta','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PREZZO.GARVARPRE.GARE','G1PREZZOVP','Prezzo unitario variato','Prezzo unit.variato','F15',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPORTO.GARVARPRE.GARE','G1IMPORTVP','Importo totale (quantità x prezzo unit.)','Importo totale','F15',NULL,'MONEY5',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMVAR.GARVARPRE.GARE','G1NUMVARVP','Numero progressivo della variazione prezzo','Numero variazione','N5',NULL,'MONEY5',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATAORAVAR.GARVARPRE.GARE','G1DOVARVP','Data-ora della variazione','Data-ora variazione','A19',NULL,'TIMESTAMP',NULL);
		
		delete from c0campi where c0c_mne_ber in ('G1CODGAR_PRO','G1CODICE_PRO','G1OGGETT_PRO', 'G1CODCIG_PRO','G1CENINT_PRO','G1PROFIW_PRO','G1CODPRO_PRO','G1GENERE_PRO','G1TIPGAR_PRO','G1PROFIW_PRO','G1ISARCH_PRO');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','CODGAR.V_GARE_PROFILO.GARE','G1CODGAR_PRO','Cod.gara divisa in lotti o cod.fittizio gara a lotto unico','Codice gara interno','A21',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODICE.V_GARE_PROFILO.GARE','G1CODICE_PRO','Codice della gara','Codice gara','A21',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'OGGETTO.V_GARE_PROFILO.GARE','G1OGGETT_PRO','Oggetto della gara','Oggetto','A2000',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODCIG.V_GARE_PROFILO.GARE','G1CODCIG_PRO','Codice identificativo della gara (CIG)','Codice CIG','A2000',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CENINT.V_GARE_PROFILO.GARE','G1CENINT_PRO','Stazione appaltante','Stazione appaltante','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'GENERE.V_GARE_PROFILO.GARE','G1GENERE_PRO','Gara divisa in lotti?(distinz.gare in lotti con off.uni.(3))','Gara in lotti?','A100','A1052',NULL,'Gara divisa in lotti?');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TIPGAR.V_GARE_PROFILO.GARE','G1TIPGAR_PRO','Tipo di procedura','Tipo procedura','A100','A2044',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ISARCHI.V_GARE_PROFILO.GARE','G1ISARCH_PRO','Gara archiviata ?','Gara archiviata?','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PROFILOWEB.V_GARE_PROFILO.GARE','G1PROFIW_PRO','Campo interno per filtro in base al profilo web','Filtro su profiloweb','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODPROFILO.V_GARE_PROFILO.GARE','G1CODPRO_PRO','Codice profilo','Codice profilo','A50',NULL,NULL,NULL);

		delete from c0campi where c0c_mne_ber in ('G1IDGOEVM1');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDGOEVMOD.G1CRIDEF.GARE','G1IDGOEVM1','Id criterio di valutazione nel modello','Id criterio modello','N12',NULL,NULL,NULL);
					
		delete from c0campi where c0c_mne_ber in ('G1IDGOEVM','G1IDCMOD','G1NECVANM','G1NORPARM','G1TIPPARM','G1ISNOPRZM','G1MAXPUNM','G1MINPUNM','G1DESPARM','G1LIVPARM','G1NECVAN1M', 'G1NORPAR1M');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.GOEVMOD.GARE','G1IDGOEVM','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDCRIMOD.GOEVMOD.GARE','G1IDCMOD','Id modello','Id modello','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NECVAN.GOEVMOD.GARE','G1NECVANM','Numero progressivo del criterio di valutazione','N.criterio valutaz.','N4',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NORPAR.GOEVMOD.GARE','G1NORPARM','Numero d''ordine del criterio di valutazione','N.ordine criterio','F6.2',NULL,NULL,'N.criterio');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TIPPAR.GOEVMOD.GARE','G1TIPPARM','Criterio di valutazione busta tecnica(1) o economica(2)','Criterio tec./econ.','A100','A1002',NULL,'Tecnico o economico?');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ISNOPRZ.GOEVMOD.GARE','G1ISNOPRZM','Criterio econ.,ai fini calc.anomalia,non relativo al prezzo?','Crit.econ.non prezzo','A2',NULL,'SN','Ai fini del calcolo soglia anomalia, criterio relativo a');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'MAXPUN.GOEVMOD.GARE','G1MAXPUNM','Punteggio massimo previsto','Punteggio massimo','F8.3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'MINPUN.GOEVMOD.GARE','G1MINPUNM','Soglia minima di punteggio','Soglia minima','F8.3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DESPAR.GOEVMOD.GARE','G1DESPARM','Descrizione','Descrizione','A2000',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'LIVPAR.GOEVMOD.GARE','G1LIVPARM','Livello del criterio (criterio, sub-criterio)','Criterio o sub-crit.','N2',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NECVAN1.GOEVMOD.GARE','G1NECVAN1M','Numero progressivo del criterio padre per il sub-criterio','N.criterio padre','N4',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NORPAR1.GOEVMOD.GARE','G1NORPAR1M','Numero d''ordine del sub-criterio','N.ord. sub-criterio','F6.2',NULL,NULL,'N.sub-criterio');

		delete from c0campi where c0c_mne_ber in ('G1IDCRIMOD','G1TITCRM','G1DESCRM');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.G1CRIMOD.GARE','G1IDCRIMOD','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TITOLO.G1CRIMOD.GARE','G1TITCRM','Titolo del modello','Titolo','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DESCRI.G1CRIMOD.GARE','G1DESCRM','Descrizione del modello','Descrizione','A2000',NULL,'NOTE',NULL);

		delete from c0campi where c0c_mne_ber in ('G1_PUNTRI1','G1_COEFRIP1');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PUNTEGRIP1.DPUN.GARE','G1_PUNTRI1','Punteggio riparametrato intermedio','Punt.riparam.interm.','F13.9',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COEFFIRIP1.DPUN.GARE','G1_COEFRIP1','Coefficiente punteggio riparametrato intermedio','Coeff.riparam.inter.','F13.9',NULL,NULL,NULL);

		delete from c0campi where c0c_mne_ber in ('G1DATPUB_DD');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DATAPUB.V_GARE_DOCDITTA.GARE','G1DATPUB_DD','Data pubblicazione','Data pubblicazione','A10',NULL,'DATA_ELDA',NULL);
		
        delete from c0campi where c0c_mne_ber in ('G1RIBAGGINI','G1IAGGIUINI','G1RIBINIDQ','G1IAGINIDQ');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'RIBAGGINI.GARE1.GARE','G1RIBAGGINI','Ribasso di aggiudicazione precedente a rettifica','Ribasso aggiud.iniz.','F13.9',NULL,NULL,'Ribasso di aggiudicazione precedente a rettifica');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IAGGIUINI.GARE1.GARE','G1IAGGIUINI','Importo di aggiudicazione precedente a rettifica','Importo aggiud.iniz.','F15',NULL,'MONEY','Importo di aggiudicazione precedente a rettifica');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'RIBAGGINI.DITGAQ.GARE','G1RIBINIDQ','Ribasso di aggiudicazione precedente a rettifica','Ribasso aggiud.iniz.','F13.9',NULL,NULL,'Ribasso di aggiudicazione precedente a rettifica');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IAGGIUINI.DITGAQ.GARE','G1IAGINIDQ','Importo di aggiudicazione precedente a rettifica','Importo aggiud.iniz.','F15',NULL,'MONEY','Importo di aggiudicazione precedente a rettifica');
		
		UPDATE C0CAMPI set COC_DES_WEB='Formato valore offerto' where C0C_MNE_BER = 'G1FORMATO';
		UPDATE C0CAMPI set COC_DES_WEB='Formula per calcolo punteggio' where C0C_MNE_BER = 'G1FORMULA';
		UPDATE C0CAMPI set COC_DES='Procedura in caso di somma urgenza?' where C0C_MNE_BER = 'G1SOMMAUR';
		
                -- Aggiornamento C0ENTIT
		DELETE FROM C0ENTIT WHERE C0E_NOM IN ('DITGEVENTI.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('DITGEVENTI.GARE',0,'E','DITG_DATE','Date acquisizione buste telematiche della ditta in gara','CODGAR.DITGEVENTI.GARE,NGARA.DITGEVENTI.GARE,DITTAO.DITGEVENTI.GARE','DITG.GARE','CODGAR5.DITG.GARE,NGARA5.DITG.GARE,DITTAO.DITG.GARE',NULL,NULL,'g1_ditd0');

		delete from C0ENTIT where C0E_NOM in ('G1CRIREG.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('G1CRIREG.GARE',0,'E','CRIT_REGOL','Dettaglio regola di valutazione criterio OEPV','IDCRIDEF.G1CRIREG.GARE','G1CRIDEF.GARE ','ID.G1CRIDEF.GARE',NULL,NULL,'g1_crir0');

		delete from C0ENTIT where C0E_NOM in ('GARVARPRE.GARE','GARVARPRE.GARE#2');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARVARPRE.GARE',0,'E','VAR_PREZZI','Storico variazioni prezzi unitari base di gara e offerti','NGARA.GARVARPRE.GARE,CONTAF.GARVARPRE.GARE','GCAP.GARE','NGARA.GCAP.GARE,CONTAF.GCAP.GARE',NULL,NULL,'g1_varp0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARVARPRE.GARE#2',0,'C',NULL,'Storico variazioni prezzi unitari base di gara e offerti','NGARA.GARVARPRE.GARE,CONTAF.GARVARPRE.GARE,DITTAO.GARVARPRE.GARE','DPRE.GARE','NGARA.DPRE.GARE,CONTAF.DPRE.GARE,DITTAO.DPRE.GARE',NULL,NULL,'g1_varp0');
		
		DELETE FROM C0ENTIT WHERE C0E_NOM IN ('V_GARE_PROFILO.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('V_GARE_PROFILO.GARE',0,'E','PROFILO_GA','Lista gare con dettaglio profilo di gestione','CODGAR.V_GARE_PROFILO.GARE','TORN.GARE','CODGAR.TORN.GARE',NULL,NULL,'g1_gpro0');
		
		DELETE FROM C0ENTIT WHERE C0E_NOM IN ('G1CRIMOD.GARE','G1CRIDEF.GARE#2','G1CRIMOD.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('G1CRIMOD.GARE',0,'E','CRIT_MOD','Modelli di criteri','IDCRIDEF.G1CRIMOD.GARE','G1CRIDEF.GARE','ID.G1CRIDEF.GARE',NULL,NULL,'g1_crir0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GOEVMOD.GARE',0,'E','CRIT_MODEL','Criteri di valutazione in modello OEPV','IDCRIMOD.GOEVMOD.GARE','G1CRIMOD.GARE','ID.G1CRIMOD.GARE',NULL,NULL,'g1_crir0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('G1CRIDEF.GARE#2',0,'E','CRIT_MODEL','Dettaglio definizione criterio di valutazione per OEPV','IDGOEVMOD.G1CRIDEF.GARE','GOEVMOD.GARE','ID.GOEVMOD.GARE',NULL,NULL,'g1_crir0');
		  

		-- Aggiornamento W_OGGETTI
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.LISTALAVFORN.copiaAttributiAggiuntivi','Funzione copia attributi aggiuntivi',3310);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.LISTALAVFORN.importXLSVariazionePrezzi','Importa da Excel per variazione prezzi',3309);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.TORN-OFFUNICA-scheda.LISTALAVFORN.importXLSVariazionePrezzi','Importa da Excel per variazione prezzi',4222);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.V_GCAP_DPRE-lista.importXLSVariazionePrezzi','Funzione "Importa da Excel per variazione prezzi"',5862);
				
		-- Aggiornamento w_oggetti per nuovo profilo di ricerca
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.V_GARE_PROFILO-lista','Lista gare con dettaglio profilo',2062);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.V_GARE_PROFILO-trova','Ricerca avanzata gare',2061);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.V_GARE_PROFILO-trova.GEN','Sezione "Dati generali"',2063);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.V_GARE_PROFILO-trova.GARE','Sezione "Dati della gara a lotto unico o del lotto di gara"',2064);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.V_GARE_PROFILO-lista.ApriGare','Lista gare con dettaglio profilo',2065);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SUBMENU','GARE.Trova-profilo','Trova profilo gare',2070);
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SUBMENU','AMMINISTRAZIONE.Configurazione-G1CRIMOD','Configurazione Modelli criteri di valutazione OEPV',13800);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.G1CRIMOD-lista','Lista modelli di criteri',13870);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.G1CRIMOD-lista.DEL','Elimina',13880);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.G1CRIMOD-lista.LISTADELSEL','Elimina selezionati',13890);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.G1CRIMOD-lista.LISTANUOVO','Nuovo',13910);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.G1CRIMOD-lista.MOD','Modifica',13920);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.G1CRIMOD-scheda','Scheda modelli di criteri',13930);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.G1CRIMOD-scheda.SCHEDAMOD','Modifica',13940);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.G1CRIMOD-scheda.SCHEDANUOVO','Nuovo',13950);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.GOEVMOD-scheda','Scheda dei criteri in un modello',13960);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GOEVMOD-scheda.DATIGEN','Sezione "Dati generali"',13970);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GOEVMOD-scheda.SUBCRIT','Sezione "Sub-criteri"',13980);
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.CRITERI.ImportaDaModello','Funzione "Importa Criteri da un modello"',5961);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE.ControDatiL190','Funzione "Controllo dati ai fini di L.190/2012"',13990);

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.DATIGEN.ALTOFF','Sezione "Altri dati presentaz.offerta"',2375);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-scheda.DATIGEN.ALTOFF','Sezione "Altri dati presentaz.offerta"',2135);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-OFFUNICA-scheda.DATIGEN.ALTOFF','Sezione "Altri dati presentaz.offerta"',3665);

        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.AGGDEF.RettificaImportoAggiudizazione','Funzione rettifica importo aggiudicazione',3036);

		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('SUBMENU','VIS','GARE.Trova-profilo','Visualizza',0,1,1,1244040467);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('FUNZ','VIS','ALT.GARE.V_GARE_PROFILO-lista.ApriGare','Visualizza',0,1,1,277420119);
		
		INSERT INTO W_ACCLIV (TABELLA,DISCR,LIV1,VALORE) VALUES ('V_GARE_PROFILO','SYSABG','CODGAR','CODGAR');

		-- Aggiornamento W_CONFIG per i ws delle anagrafiche Cineca
        if (select count(*) = 0 from w_config where codapp = 'PG' and chiave='cineca.ws.DitteIndividuali.url') THEN
			INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cineca.ws.DitteIndividuali.url',NULL,'Personalizzazione Cineca','URL  di accesso al servizio Ditte Individuali di Cineca',NULL);
			INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cineca.ws.DitteIndividuali.client',NULL,'Personalizzazione Cineca','Attributo client del servizio Ditte Individuali di Cineca',NULL);
        end if;

        if (select count(*) = 0 from w_config where codapp = 'PG' and chiave='cineca.ws.PersonaFisica.url') THEN
			INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cineca.ws.PersonaFisica.url',NULL,'Personalizzazione Cineca','URL  di accesso al servizio Persone Fisiche di Cineca',NULL);
			INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cineca.ws.PersonaFisica.client',NULL,'Personalizzazione Cineca','Attributo client del servizio Persone Fisiche di Cineca',NULL);
        end if;
		
				--Aggiornamento W_CONFIG, le property relative a WDM devono essere presenti anche quando hanno valore nullo
                IF (select count(*) = 0 from w_config where codapp = 'PG' and chiave='wsdm.fascicoloprotocollo.url') THEN
                       INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdm.fascicoloprotocollo.url',NULL,NULL,NULL,NULL);
                END IF;
                IF (select count(*) = 0 from w_config where codapp = 'PG' and chiave='wsdmconfigurazione.fascicoloprotocollo.url') THEN
                       INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdmconfigurazione.fascicoloprotocollo.url',NULL,NULL,NULL,NULL);
                END IF;
                IF (select count(*) = 0 from w_config where codapp = 'PG' and chiave='pg.wsdm.invioMailPec') THEN
                       INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','pg.wsdm.invioMailPec',NULL,NULL,NULL,NULL);
                END IF;
                IF (select count(*) = 0 from w_config where codapp = 'PG' and chiave='wsdm.protocolloSingoloInvito') THEN
                       INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdm.protocolloSingoloInvito',NULL,NULL,NULL,NULL);
                END IF;
                IF (select count(*) = 0 from w_config where codapp = 'PG' and chiave='wsdm.documentale.url') THEN
                       INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdm.documentale.url',NULL,NULL,NULL,NULL);
                END IF;
                IF (select count(*) = 0 from w_config where codapp = 'PG' and chiave='wsdmconfigurazione.documentale.url') THEN
                       INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdmconfigurazione.documentale.url',NULL,NULL,NULL,NULL);
                END IF;
                IF (select count(*) = 0 from w_config where codapp = 'PG' and chiave='wsdm.loginComune') THEN
                       INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdm.loginComune',NULL,NULL,NULL,NULL);
                END IF;
                IF (select count(*) = 0 from w_config where codapp = 'PG' and chiave='pg.wsdm.applicaFascicolazione') THEN
                       INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','pg.wsdm.applicaFascicolazione',NULL,NULL,NULL,NULL);
                END IF;
                IF (select count(*) = 0 from w_config where codapp = 'PG' and chiave='wsdm.accediFascicoloDocumentale') THEN
                       INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdm.accediFascicoloDocumentale',NULL,NULL,NULL,NULL);
                END IF;
                IF (select count(*) = 0 from w_config where codapp = 'PG' and chiave='wsdm.stazioneAppaltante') THEN
                       INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdm.stazioneAppaltante',NULL,NULL,NULL,NULL);
                END IF;

		update w_config set sezione ='Invio dati Vigilanza Comunicazioni' where codapp='PG' and sezione='Integrazione WS Vigilanza';
		update w_config set sezione ='Invio dati Vigilanza Richiesta CIG' where codapp='PG' and sezione='Richiesta CIG';
		update w_config set descrizione='Nome applicativo per l''integrazione con il servizio WS Vigilanza (es.: Vigilanza, SitatSA Locale, Siab...)' where codapp='PG' and chiave='it.eldasoft.sil.pg.vigilanza.nomeApplicativo';
		update w_config set descrizione='Indirizzo URL per l''integrazione con il servizio WS Vigilanza (es.: http://localhost:8080/WS2Vigilanza/services/SitatWS )' where codapp='PG' and chiave='it.eldasoft.sil.pg.vigilanza.ws.url';
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','it.eldasoft.inviodaticig.nomeApplicativo',NULL,'Invio dati Vigilanza Richiesta CIG','Nome applicativo per l''integrazione con il servizio WS Vigilanza (es.: Vigilanza, SitatSA Locale, Siab...)',NULL);

		update w_quartz set descrizione='Schedulazione della lettura dati di gara da Vigilanza Richiesta CIG' where codapp='PG' and bean_id='inviaDatiRichiestaCigManagerTrigger';
		
		--Creazione view per profilo di ricerca
		create view V_GARE_PROFILO as
			select v_gare_torn.codice, v_gare_torn.codgar, v_gare_torn.oggetto,v_gare_torn.codcig,torn.cenint, v_gare_torn.profiloweb, 
				v_gare_torn.genere, v_gare_torn.tipgar, v_gare_torn.isarchi,
				case when tab2.tab2d1 ='default' then 'PG_GARE' else tab2.tab2d1 end as codprofilo
			from v_gare_torn inner join torn on (v_gare_torn.codgar=torn.codgar and torn.profiloweb is null)
				INNER JOIN TAB2 ON (TAB2COD='A1z03' AND ',' || TAB2.TAB2D2 || ',' LIKE '%,' || CAST(V_GARE_TORN.TIPGAR AS VARCHAR(4)) || ',%' AND TAB2D1 not like '$%')
			union
			select v_gare_torn.codice, v_gare_torn.codgar, v_gare_torn.oggetto,v_gare_torn.codcig,torn.cenint, v_gare_torn.profiloweb, 
				v_gare_torn.genere, v_gare_torn.tipgar, v_gare_torn.isarchi,
				tab2.tab2d1 as codprofilo
			from v_gare_torn inner join torn on (v_gare_torn.codgar=torn.codgar and torn.profiloweb is not null)
				  INNER JOIN TAB2 ON (TAB2COD='A1z03' AND tab2d1 like '$'||cast(v_gare_torn.profiloweb as varchar(2))||'$%');
				  
		--riformulazione della view v_gare_accordiquadro per considerare aqoper di GARE1
		perform sp_backupanddropviews('v_gare_accordiquadro');
		create or replace view v_gare_accordiquadro (ngara,tipgen,tipgarg,not_gar,codcig,cenint,datainizio,datafine,aqoper,aqdurata,aqtempo,isarchi) as
                select g.ngara,tipgen,tipgarg, not_gar, codcig, cenint,daatto as datainizio,
					case when aqdurata is null then null
						when aqtempo = 1 then daatto + INTERVAL '1 day' * coalesce (AQDURATA * 30,0)
						when aqtempo = 2 then daatto + INTERVAL '1 day' * coalesce (AQDURATA * 365,0)
					else null end as datafine,
					g1.aqoper, aqdurata, aqtempo,isarchi
				from gare g,torn,gare1 g1 where g.codgar1=codgar and g.ngara=g1.ngara and accqua='1' and daatto is not null and aqdurata is not null and aqtempo is not null;
		perform sp_restoreviews('v_gare_accordiquadro');
		
		-- (S.Santi 10.10.2018) Aggiunto data pubblicazione
		--
		perform sp_backupanddropviews('v_gare_docditta');
		create or replace view v_gare_docditta as
			select imprdocg.codgar,
				imprdocg.ngara,
				imprdocg.codimp,
				imprdocg.norddoci,
				imprdocg.proveni,
				case when proveni=1 then documgara.busta else imprdocg.busta end busta,
				tab1.tab1nord bustaord,
				tab1.tab1desc bustadesc,
				case when proveni=1 then documgara.descrizione else imprdocg.descrizione end descrizione,
				documgara.reqcap,
				documgara.tipodoc,
				documgara.contestoval,
				documgara.obbligatorio,
				documgara.modfirma,
				documgara.gentel,
				documgara.fasele,
				documgara.isarchi,
				coalesce(documgara.numord,10000) numord,
				documgara.datarilascio datapub,
				imprdocg.datarilascio,
				imprdocg.orarilascio,
				imprdocg.datascadenza,
				imprdocg.situazdoci,
				imprdocg.doctel,
				imprdocg.idprg,
				imprdocg.iddocdg,
				w_docdig.dignomdoc,
				imprdocg.notedoci
			from imprdocg 
			left outer join documgara on (imprdocg.codgar = documgara.codgar and imprdocg.norddoci=documgara.norddocg and imprdocg.proveni=1 and documgara.gruppo=3)
			left outer join w_docdig on (imprdocg.idprg=w_docdig.idprg and imprdocg.iddocdg=w_docdig.iddocdig)
			left outer join tab1 on (tab1cod='A1013' and (tab1tip=imprdocg.busta or tab1tip=documgara.busta));
		perform sp_restoreviews('v_gare_docditta');

		perform sp_backupanddropviews('V_DATI_LOTTI_COMPLETA');
		IF exists (select tablename from pg_tables where upper(tablename) = 'APPA') THEN
		EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
		with pubblicazioni
        		 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
        		select gare.ngara lotto,
        		   gare.codcig cig,
        		   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
        		   uff.codein codiceprop,
        		   uff.cfein codfiscprop,
        		   uff.nomein denomprop,
        		   not_gar oggetto,
        		   tipgarg,
        		   iterga,
        		   case when (torn.accqua is null or torn.accqua <>''1'') then
        			iaggiu 
        			else gc.impqua end impaggiudic,
        		   torn.dinvit,
        		   ditta aggiudicataria,
        		   gare.esineg,
        		   gare.datneg,
        		   gare.dattoa,
        		   torn.altrisog,
        		   torn.accqua,
        		   gare1.aqoper,
        		   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
        				when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
        			   else gc.dverbc end datainizio,
        		   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
        				when (gare.clavor is not null or gare.numera is not null) then appa.dult
        			   else gc.dcertu end dataultimazione,
        		   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
        				when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
        			   else gc.impliq end impsommeliq,
        		   torn.dteoff,
        		   tecni.cftec codfisresp,
        		   tecni.nomtec nomeresp
        		 from gare
        		 inner join torn on torn.codgar=gare.codgar1
        		 inner join gare1 on gare1.ngara=gare.ngara
                 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
        		 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
        		 left outer join uffint uff on (uff.codein=torn.cenint )
        		 left outer join tecni on (tecni.codtec=torn.codrup)
        		 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
        		 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20)))
        	   union
        		select gare.ngara lotto,
        		   gare.codcig cig,
        		   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
        		   uff.codein codiceprop,
        		   uff.cfein codfiscprop,
        		   uff.nomein denomprop,
        		   not_gar oggetto,
        		   tipgarg,
        		   iterga,
        		   case when (torn.accqua is null or torn.accqua <>''1'') then
        			iaggiu 
        			else gc.impqua end impaggiudic,
        		   torn.dinvit,
        		   ditta aggiudicataria,
        		   gare.esineg,
        		   gare.datneg,
        		   gare.dattoa,
        		   torn.altrisog,
        		   torn.accqua,
        		   gare1.aqoper,
        		   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
        				when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
        			   else gc.dverbc end datainizio,
        		   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
        				when (gare.clavor is not null or gare.numera is not null) then appa.dult
        			   else gc.dcertu end dataultimazione,
        		   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
        				when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
        			   else gc.impliq end impsommeliq,
        		   torn.dteoff,
        		   tecni.cftec codfisresp,
        		   tecni.nomtec nomeresp
        		 from gare
        		 inner join torn on torn.codgar=gare.codgar1
        		 inner join gare1 on gare1.ngara=gare.ngara
                         left outer join pubblicazioni on pubblicazioni.codgar9=torn.codgar
        		 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
        		 left outer join uffint uff on (uff.codein=torn.cenint )
        		 left outer join tecni on (tecni.codtec=torn.codrup)
        		 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
        		 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
        	   union
        		 select gare.ngara lotto,
        			gare.codcig cig,
        			null datpub,
        			uff.codein codiceprop,
        			uff.cfein codfiscprop,
        			uff.nomein denomprop,
        			gare.not_gar oggetto,
        			gare.tipgarg,
        			null iterga,
        			iaggiu impaggiudic,
        			null dinvit,
        			ditta aggiudicataria,
        			null esineg,
        			null datneg,
        			gare.daatto dattoa,
        		    null altrisog,
        		    null accqua,
        		    null aqoper,
        			gc.dverbc datainizio,
        			gc.dcertu dataultimazione,
        			gc.impliq impsommeliq,
        			torn.dteoff,
        			tecni.cftec codfisresp,
        			tecni.nomtec nomeresp
        		 from gare inner join torn on (gare.codgar1=torn.codgar)
        		 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
        		 left outer join uffint uff on (uff.codein=torn.cenint )
        		 left outer join tecni on (tecni.codtec=torn.codrup)
        		 where gare.genere=4';
        	else
        		EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
        		with pubblicazioni 
        		 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
        		select gare.ngara lotto,
        		   codcig cig,
        		   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
        		   uff.codein codiceprop,
        		   uff.cfein codfiscprop,
        		   uff.nomein denomprop,
        		   not_gar oggetto,
        		   tipgarg,
        		   iterga,
        		   case when (torn.accqua is null or torn.accqua <>''1'') then
        				iaggiu 
        			  else gc.impqua end impaggiudic,
        		   torn.dinvit,
        		   ditta aggiudicataria,
        		   gare.esineg,
        		   gare.datneg,
        		   gare.dattoa,
        		   torn.altrisog,
        		   torn.accqua,
        		   gare1.aqoper,
        		   gc.dverbc datainizio,
        		   gc.dcertu dataultimazione,
        		   gc.impliq impsommeliq,
        		   torn.dteoff,
        		   tecni.cftec codfisresp,
        		   tecni.nomtec nomeresp
        		from gare
        		 inner join torn on torn.codgar=gare.codgar1
        		 inner join gare1 on gare1.ngara=gare.ngara
                         left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
        		 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
        		 left outer join uffint uff on (uff.codein=torn.cenint )
        		 left outer join tecni on (tecni.codtec=torn.codrup)
        		 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20)))
        	  union
        		select gare.ngara lotto,
        		   codcig cig,
        		   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
        		   uff.codein codiceprop,
        		   uff.cfein codfiscprop,
        		   uff.nomein denomprop,
        		   not_gar oggetto,
        		   tipgarg,
        		   iterga,
        		   case when (torn.accqua is null or torn.accqua <>''1'') then
        				iaggiu 
        			  else gc.impqua end impaggiudic,
        		   torn.dinvit,
        		   ditta aggiudicataria,
        		   gare.esineg,
        		   gare.datneg,
        		   gare.dattoa,
        		   torn.altrisog,
        		   torn.accqua,
        		   gare1.aqoper,
        		   gc.dverbc datainizio,
        		   gc.dcertu dataultimazione,
        		   gc.impliq impsommeliq,
        		   torn.dteoff,
        		   tecni.cftec codfisresp,
        		   tecni.nomtec nomeresp
        		from gare
        		 inner join torn on torn.codgar=gare.codgar1
        		 inner join gare1 on gare1.ngara=gare.ngara
                         left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
        		 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
        		 left outer join uffint uff on (uff.codein=torn.cenint )
        		 left outer join tecni on (tecni.codtec=torn.codrup)
        		 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
        	   union
        		select gare.ngara lotto,
        			gare.codcig cig,
        			null datpub,
        			uff.codein codiceprop,
        			uff.cfein codfiscprop,
        			uff.nomein denomprop,
        			gare.not_gar oggetto,
        			gare.tipgarg,
        			null iterga,
        			iaggiu impaggiudic,
        			null dinvit,
        			ditta aggiudicataria,
        			null esineg,
        			null datneg,
        			gare.daatto dattoa,
        		    null altrisog,
        		    null accqua,
        		    null aqoper,
        			gc.dverbc datainizio,
        			gc.dcertu dataultimazione,
        			gc.impliq impsommeliq,
        			torn.dteoff,
        			tecni.cftec codfisresp,
        			tecni.nomtec nomeresp
        		 from gare inner join torn on (gare.codgar1=torn.codgar)
        		 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
        		 left outer join uffint uff on (uff.codein=torn.cenint )
        		 left outer join tecni on (tecni.codtec=torn.codrup)
        		 where gare.genere=4';
        	end if;
		perform sp_restoreviews('V_DATI_LOTTI_COMPLETA');

		update eldaver set numver = '7.0.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '7.0.0', datvet = now() where codapp = 'G1';

		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');



  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '7.0.%') THEN
	
		update eldaver set numver = '7.1.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '7.1.0', datvet = now() where codapp = 'G1';

		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');



  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '7.1.%') THEN
                
                ALTER TABLE GARE ALTER COLUMN PRECED TYPE VARCHAR(20);

		--Aggiornamento tabellati
		-- Verifica per tabellato inserito nella patch 7.1.2
		if (select count(*) = 0 from tab1 where tab1cod = 'A1153') THEN
			   INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1153',1,'0   Attiva blocco(1) Disattiva blocco(0)',NULL,0,NULL);
			   INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1153','Procedure NON telematiche: blocco dati dopo pubblicazione su portale',NULL);
		end if;

		--Aggiornamento C0CAMPI
		update c0campi set coc_des='Procedura telematica nella piattaforma?',coc_des_web='Procedura telematica nella piattaforma?' where c0c_mne_ber='G1GARTEL';
		update c0campi set coc_des='Procedura telematica nella piattaforma?',coc_des_web='Procedura telematica nella piattaforma?' where c0c_mne_ber='G1GARTEL_L';
		update c0campi set coc_des='Procedura telematica nella piattaforma?',coc_des_web='Procedura telematica nella piattaforma?' where c0c_mne_ber='G1GARTELAD';
		update c0campi set c0c_tip='E' where c0c_mne_ber='DATRILDG';

		delete from c0campi where c0c_mne_ber in ('PRECED');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PRECED.GARE.GARE','PRECED','Codice gara oggetto di rilancio off.economica','Gara rilancio off.ec','A20',NULL,NULL,'Codice gara oggetto di rilancio');


        -- Aggiornamento W_CONFIG per il ws di pubblicazione sul sito ATC
        update w_config set sezione='Pubblicazione sito istituzionale' where codapp='PG' and chiave='sitoIstituzionale.ws.urlBandiPortaleAppalti';
		update w_config set sezione='Pubblicazione sito istituzionale' where codapp='PG' and chiave='sitoIstituzionale.ws.urlEsitiPortaleAppalti';
		update w_config set sezione='Pubblicazione sito istituzionale' where codapp='PG' and chiave='sitoIstituzionale.ws.urlAvvisiPortaleAppalti';
		update w_config set sezione='Pubblicazione sito istituzionale' where codapp='PG' and chiave='sitoIstituzionale.ws.url';

		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','sitoIstituzionale.ws.tipo',NULL,'Pubblicazione sito istituzionale','Tipo di pubblicazione: 1=Regione Marche, 2=ATC ',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','sitoIstituzionale.ws.user',NULL,'Pubblicazione sito istituzionale','User del servizio (ATC)',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','sitoIstituzionale.ws.token',NULL,'Pubblicazione sito istituzionale','Token del servizio (ATC)',NULL);

		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','firmaremota.provider',null,'Firma digitale remota','Provider (Infocert...)',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','firmaremota.auto.url',null,'Firma digitale remota','URL Firma Remota Automatica',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','firmaremota.remote.url',null,'Firma digitale remota','URL Firma Remota',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','firmaremota.verify.url',null,'Firma digitale remota','URL Verifica Firma Remota',null);
		
		-- Aggiornamento W_OGGETTI
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FirmaRemotaDocumenti','Funzione firma digitale da remoto',14000);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FASIRICEZIONE.selDitteRilancio','Funzione "Selezione ditte per gara di rilancio"',11315);

		-- Aggiornamento W_AZIONI
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('COLS','MAN','GARE.GARE.PRECED','Obblig.',1,1,0,1949518289);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('COLS','VIS','GARE.GARE.PRECED','Visualizza',0,1,1,1482651279);

		update eldaver set numver = '7.2.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '7.2.0', datvet = now() where codapp = 'G1';

		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu UtilitÃ  -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	maxtip INT;
	conta INT;
	valtab2d2 VARCHAR;
	lentab2d2 INT;

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '7.2.%') THEN

		perform sp_backupanddropviews('g1crireg');
		ALTER TABLE g1crireg ALTER COLUMN COEFFI type NUMERIC(24,9);
		perform sp_restoreviews('g1crireg');

		CREATE TABLE GARILANCI (
			ID NUMERIC(12) NOT NULL,
			NGARA VARCHAR(20) NOT NULL,
			DITTAO VARCHAR(10) NOT NULL,
			NUMRIL NUMERIC(5),
			RIBAUO NUMERIC(24,9),
			IMPOFF NUMERIC(24,5),
			NGARARIL VARCHAR(20),
			DATAORAAGG TIMESTAMP,
			primary key (ID));
		ALTER TABLE GARILANCI ADD CONSTRAINT FK_GARILANCI_GARE FOREIGN KEY ( NGARA) REFERENCES GARE( NGARA) ON DELETE CASCADE;
		
		CREATE TABLE TAB_WSERP(
		  ID NUMERIC(12) NOT NULL,
		  CODICE VARCHAR(50),
		  VALORE VARCHAR(50),
		  DESCRIZIONE VARCHAR(200),
		  primary key (ID));
		  
                --Inserimento nuova occorrenza in w_genchiavi
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('GARILANCI',0);
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('TAB_WSERP',0);
                
		if (select count(*) = 0 from tab1 where tab1cod = 'A2044' and tab1tip=29 and tab1desc='Rilancio offerta economica') then
			-- (S.Santi 17.12.2018) Allineamento tabellati in seguito a introduzione tipo procedura 'Rilancio offerta economica'. Script presente anche in LFS/GIL
			-- Aggiunge una riga nel tabellato 'A2044' spostando prima quella con chiave uguale e aggiorna le entità che vi fanno riferimento
			if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='A2044' and TAB1TIP=29 and (TAB1DESC is null or TAB1DESC!='Rilancio offerta economica')) = 1) then
				maxtip := 0;
				SELECT MAX(TAB1TIP) INTO maxtip FROM TAB1 WHERE TAB1COD='A2044';
				conta := maxtip + 1;
				UPDATE TAB1 SET TAB1TIP=conta WHERE TAB1COD='A2044' and TAB1TIP=29;
				IF exists (select tablename from pg_tables where upper(tablename) = 'GARE') THEN
					UPDATE TORN SET TIPGAR=conta WHERE TIPGAR=29;
					UPDATE GARE SET TIPGARG=conta WHERE TIPGARG=29;
					UPDATE CATPUB SET TIPGAR=conta WHERE TIPGAR=29;
					UPDATE ARCHDOCG SET TIPOPROC=conta WHERE TIPOPROC=29;
					UPDATE CONFOPECO SET TIPOPROCEDURA=conta WHERE TIPOPROCEDURA=29;
				END IF;
				IF exists (select tablename from pg_tables where upper(tablename) = 'PERI') THEN
					UPDATE APPA SET TIPAGG=conta WHERE TIPAGG=29;
					UPDATE ORDI SET TIPAGG=conta WHERE TIPAGG=29;
				END IF;
				IF exists (select tablename from pg_tables where upper(tablename) = 'SCHCON') THEN
					UPDATE SCHCON SET TIPGARG=conta WHERE TIPGARG=29;
				END IF;
			end if;
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 29, 'Rilancio offerta economica', '1', 29);
		end if;
		if (select count(*) = 0 from tab2 where tab2cod = 'A1z03' and tab2tip=5 and tab2d1='PG_GARE_RILANCIO') then
			--Aggiorna parametri di configurazione - solo nel caso di Appalti
			if ((SELECT count(TAB2TIP) FROM TAB2 WHERE TAB2COD='A1z04' and TAB2TIP=5 and (TAB2D2 is null or TAB2D2 not like '%29%')) = 1) then
				SELECT COALESCE(TAB2D2,''), COALESCE(length(TAB2D2),0) into valtab2d2,lentab2d2 FROM TAB2 WHERE TAB2COD='A1z04' and TAB2TIP=5;
				if (lentab2d2>0) then
					valtab2d2 := valtab2d2 || ',';
				end if;
				valtab2d2 := valtab2d2 || '29';
				UPDATE TAB2 SET TAB2D2=valtab2d2 WHERE TAB2COD='A1z04' and TAB2TIP=5;
			end if;
			if ((SELECT count(TAB2TIP) FROM TAB2 WHERE TAB2COD='A1z03' and TAB2TIP=5 and TAB2D1<>'PG_GARE_RILANCIO') = 1) then
				maxtip := 0;
				SELECT MAX(to_number(TAB2TIP,'999999')) INTO maxtip FROM TAB2 WHERE TAB2COD='A1z03';
				conta := maxtip + 1;
				UPDATE TAB2 SET TAB2TIP=conta WHERE TAB2COD='A1z03' and TAB2TIP=5;
			end if;
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z03','5','PG_GARE_RILANCIO','29',NULL,0,NULL);
		end if;

		--(S.Santi 09.01.2019) Valorizza il campo torn RICMANO - nell'aggiornamento alla 7.0.0 non sono state considerate le gare telematiche aperte in corso (ovvero senza ditte inserite in gara)
		-- Solo se non è stata installata la patch 7.2.4
		if (select count(*) = 0 from eldaver where codapp = 'PG' and numver like '7.2.4') then
			UPDATE TORN SET RICMANO = '1' where gartel='1' and ricmano is null;
		end if;

		-- Aggiornamento C0CAMPI
		delete from c0campi where c0c_mne_ber in ('G1IDGR','G1NGARAGR','G1DITTAOGR','G1NUMRILGR','G1RIBAUOGR','G1IMPOFFGR','G1NGARARGR','G1DORILGR');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.GARILANCI.GARE','G1IDGR','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.GARILANCI.GARE','G1NGARAGR','Codice gara a lotto unico o lotto di gara','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DITTAO.GARILANCI.GARE','G1DITTAOGR','Cod. ditta partecipante alla gara','Codice ditta','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMRIL.GARILANCI.GARE','G1NUMRILGR','Numero progressivo del rilancio della ditta','Numero rilancio','N5',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'RIBAUO.GARILANCI.GARE','G1RIBAUOGR','Ribasso offerto dalla ditta','Ribasso offerto','F13.9',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'IMPOFF.GARILANCI.GARE','G1IMPOFFGR','Importo offerto dalla ditta','Importo offerto','F15',NULL,'MONEY5',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARARIL.GARILANCI.GARE','G1NGARARGR','Codice gara di rilancio','Codice gara rilancio','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DATAORAAGG.GARILANCI.GARE','G1DORILGR','Data-ora di aggiornamento da rilancio','Data-ora aggiornam.','A19',NULL,'TIMESTAMP',NULL);
		
		UPDATE C0CAMPI SET COC_DES='Offerta econ. della ditta aggiornata in seguito a rilancio', COC_DES_FRM='Rilancio off.econ.?' WHERE C0C_MNE_BER='G1ISRILANCI';

		delete from c0campi where c0c_mne_ber in ('TWSERP_ID','TWSERP_CODICE','TWSERP_VALORE','TWSERP_DESC');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.TAB_WSERP.GARE','TWSERP_ID','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODICE.TAB_WSERP.GARE','TWSERP_CODICE','Codice parametro','Codice','A50',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'VALORE.TAB_WSERP.GARE','TWSERP_VALORE','Valore parametro','Valore','A50',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DESCRIZIONE.TAB_WSERP.GARE','TWSERP_DESC','Descrizione parametro','Descrizione','A200',NULL,NULL,NULL);
		
        -- Aggiornamento C0ENTIT
		DELETE FROM C0ENTIT WHERE C0E_NOM IN ('GARILANCI.GARE','TAB_WSERP.GARE');
        INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARILANCI.GARE',0,'E','GARE_RILAN','Rilanci delle ditte mediante altra procedura','NGARA.GARILANCI.GARE,DITTAO.GARILANCI.GARE','DITG.GARE','NGARA5.DITG.GARE,DITTAO.DITG.GARE',NULL,NULL,'g1_gari0');
        INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('TAB_WSERP.GARE',0,'E','GARE_WSERP','Parametri tabellati per integrazione wserp','ID.TAB_WSERP.GARE',NULL,NULL,NULL,NULL,'g1_twserp0');
               
        -- Aggiornamento W_OGGETTI
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.FASIGARA.AggiornaOfferteRilancio','Funzione Aggiorna offerte da rilancio',14010);

		-- Inserimento note per dettaglio comunicazione
		INSERT INTO W_NOTE (TIPO,OGGETTO,PROG,MODOVIS,NOTA) VALUES (2,'GENEWEB.W_INVCOM-scheda.W_INVCOM',0,'2','ATTENZIONE: si sottolinea che nel caso il destinatario della comunicazione sia un raggruppamento temporaneo, viene considerata la sola ditta mandataria.');
		INSERT INTO W_NOTE (TIPO,OGGETTO,PROG,MODOVIS,NOTA) VALUES (2,'GENEWEB.W_INVCOM-scheda.W_INVCOM',0,'3','ATTENZIONE: si sottolinea che nel caso il destinatario della comunicazione sia un raggruppamento temporaneo, viene considerata la sola ditta mandataria.');

		-- (S.Santi 18.12.2018) Impostato filtro per escludere le procedure di rilancio offerta economica (solo procedure lotto unico)
		perform sp_backupanddropviews('v_dati_lotti_completa');
		IF exists (select tablename from pg_tables where upper(tablename) = 'APPA') THEN
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20))) and gare.preced is null
		   union
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when (torn.accqua =''1'' or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
		   union
			 select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				null altrisog,
				null accqua,
				null aqoper,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff,
				tecni.cftec codfisresp,
				tecni.nomtec nomeresp
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where gare.genere=4';
		else
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20))) and gare.preced is null
		  union
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
		   union
			select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				null altrisog,
				null accqua,
				null aqoper,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff,
				tecni.cftec codfisresp,
				tecni.nomtec nomeresp
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where gare.genere=4';
		end if;
		perform sp_restoreviews('v_dati_lotti_completa');
		
		update eldaver set numver = '7.3.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '7.3.0', datvet = now() where codapp = 'G1';

		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	v_max_idfiltro numeric(7):= 0;
	v_pres_filtro numeric(7):= 0;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '7.3.%') THEN
		IF exists (SELECT column_name FROM information_schema.columns WHERE table_name='g1filtriele' and column_name='filtrogen') THEN
		 ALTER TABLE G1FILTRIELE ADD TIPOFILTRO NUMERIC(7);
		 update g1filtriele set tipofiltro = CAST (filtrogen AS INTEGER);
		 ALTER TABLE G1FILTRIELE DROP COLUMN FILTROGEN;
		else
		 CREATE TABLE G1FILTRIELE (
					ID NUMERIC(12) NOT NULL,
					TITOLO VARCHAR(500),
					DESCRIZIONE VARCHAR(2000),
					TIPOELE VARCHAR(3),
					APPLICAELE VARCHAR(500),
					QUERYFILTRO VARCHAR(2000),
					MSGFILTRO VARCHAR(500),
					TIPOFILTRO NUMERIC(7),
					FILTROATT VARCHAR(1),
					primary key (ID));
					
		end if;

		SELECT coalesce(MAX(ID),0) INTO v_max_idfiltro FROM G1FILTRIELE;		
		SELECT count(*) INTO v_pres_filtro FROM G1FILTRIELE where tipofiltro = 2;
		IF (v_pres_filtro = 0) THEN
		 v_max_idfiltro := v_max_idfiltro + 1;
		 -- Inserimento configurazione per pulsante filtro su ulteriori categorie
		 Insert into G1FILTRIELE (ID, TITOLO, DESCRIZIONE, TIPOELE, APPLICAELE, QUERYFILTRO, MSGFILTRO, TIPOFILTRO, FILTROATT)
		 Values (v_max_idfiltro, 'Filtro su ulteriori categorie', 'Discriminante per utilizzare il filtro su ulteriori categorie', NULL, NULL, NULL, NULL, 2, '1');
		end if;

		SELECT count(*) INTO v_pres_filtro FROM G1FILTRIELE where tipofiltro = 3;
		IF (v_pres_filtro = 0) THEN
			v_max_idfiltro := v_max_idfiltro + 1;
			-- Inserimento configurazione per pulsante filtro su zone attivita
			Insert into G1FILTRIELE (ID, TITOLO, DESCRIZIONE, TIPOELE, APPLICAELE, QUERYFILTRO, MSGFILTRO, TIPOFILTRO, FILTROATT)
			Values (v_max_idfiltro, 'Filtro su zone attivita', 'Discriminante per utilizzare il filtro su zone attivita', NULL, NULL, NULL, NULL, 3, '2');
		end if;
		
		SELECT count(*) INTO v_pres_filtro FROM G1FILTRIELE where tipofiltro = 4;
		IF (v_pres_filtro = 0) THEN
		 v_max_idfiltro := v_max_idfiltro + 1;
		 -- Inserimento configurazione per pulsante filtro su esclusione affidatario uscente
		 Insert into G1FILTRIELE (ID, TITOLO, DESCRIZIONE, TIPOELE, APPLICAELE, QUERYFILTRO, MSGFILTRO, TIPOFILTRO, FILTROATT)
		 Values (v_max_idfiltro, 'Filtro esclusione affidatario uscente', 'Discriminante per utilizzare il filtro di esclusione affidatario uscente', NULL, NULL, NULL, NULL, 4, '1');
		end if;
			
		IF not exists (SELECT column_name FROM information_schema.columns WHERE table_name='confopeco' and column_name='nmaxsel') THEN
			--Nuovo campo 'Num.massimo operatori selezionabili'
			ALTER TABLE CONFOPECO ADD NMAXSEL NUMERIC(7);
		end if;

		--Nuovo campo 'Coordinatore sicurezza'
		ALTER TABLE GAREALBO ADD COORDSIC VARCHAR(1);
		ALTER TABLE DITG ADD COORDSIC VARCHAR(1);

        ALTER TABLE GARUUID ADD NGARA VARCHAR(20);
		
		--Valorizza ALTRISOG a 1, se nullo, nel caso di avvisi fatti da CUC
        update torn set altrisog=1 where  altrisog is null and exists (select codein from uffint where cenint=codein and iscuc='1');
		
		update TAB4 set TAB4DESC='OEPV: distinzione criteri busta economica relativi a prezzo o altro elemento di valutazione' where TAB4COD='G1_1' and TAB4TIP='A1149';
		update TAB1 set TAB1DESC=(select substring(tab1desc,1,1)|| '   attiva gestione(1) disattiva gestione(0)' from tab1 where tab1cod='A1149' and tab1tip=1) where TAB1COD='A1149' and TAB1TIP=1;

		--Codifica automatica procedure di rilancio offerta economica
        INSERT INTO G_CONFCOD (NOMENT,NOMCAM,TIPCAM,CODAPP,DESCAM,CONTAT,CODCAL,NUMORD) VALUES ('GARE','PRECED',-1,'G1','Suffisso procedura di rilancio',0,'"R"<00>',8);
                
		-- Aggiornamento C0CAMPI
		delete from c0campi where c0c_mne_ber in ('G1IDFE','G1TITFE','G1DESFE','G1TIPEFE','G1APPEFE','G1QUEFE','G1MSGFE','G1TIPFFE','G1ATTFE','G1GENFE');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.G1FILTRIELE.GARE','G1IDFE','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TITOLO.G1FILTRIELE.GARE','G1TITFE','Titolo','Titolo','A200',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'DESCRIZIONE.G1FILTRIELE.GARE','G1DESFE','Descrizione','Descrizione','A2000',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TIPOELE.G1FILTRIELE.GARE','G1TIPEFE','Tipo elenco','Tipo elenco','A3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'APPLICAELE.G1FILTRIELE.GARE','G1APPEFE','Applica ad elenchi','Applicazione','A2000',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'QUERYFILTRO.G1FILTRIELE.GARE','G1QUEFE','Query filtro','Query','A2000',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'MSGFILTRO.G1FILTRIELE.GARE','G1MSGFE','Messaggio filtro','Msg','A500',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TIPOFILTRO.G1FILTRIELE.GARE','G1TIPFFE','Tipo filtro','Tipo filtro','N7',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'FILTROATT.G1FILTRIELE.GARE','G1ATTFE','Filtro attivo?','Filtro att.?','A2',NULL,'SN',NULL);
		
		delete from c0campi where c0c_mne_ber in ('G1COORDSIC','G1COORDSICD');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'COORDSIC.GAREALBO.GARE','G1COORDSIC','Richiesto possesso requisiti coord.sic(art.98 DLgs.81/2008)?','Requisito coord.sic?','A2',NULL,'SN','Richiesto possesso requisiti coordinatore sicurezza (art.98 DLgs.81/2008)?');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'COORDSIC.DITG.GARE','G1COORDSICD','Possesso requisiti coord.sicurezza (art.98 DLgs.81/2008)?','Coord.sicurezza?','A2',NULL,'SN','Possesso requisiti coordinatore sicurezza?');

        delete from c0campi where c0c_mne_ber in ('G1NGARAU','G1NMAXSEL');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NGARA.GARUUID.GARE','G1NGARAU','Codice lotto di gara ','Codice lotto ','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NMAXSEL.CONFOPECO.GARE','G1NMAXSEL','Numero massimo operatori economici selezionabili','Num.max.op.selezion.','N3',NULL,NULL,'Num.massimo operatori selezionabili');

		update c0campi set COC_DES='Numero operatori economici da selezionare, ove esistenti',COC_DES_FRM='Num.min.operat.econ.',COC_DES_WEB='Num.minimo operatori economici da consultare' where C0C_MNE_BER='NUMMINOE';
		
		-- Aggiornamento C0ENTIT
		DELETE FROM C0ENTIT WHERE C0E_NOM IN ('G1FILTRIELE.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('G1FILTRIELE.GARE',0,'E','GARE_FIELE','Filtri elenco operatori','ID.G1FILTRIELE.GARE',NULL,NULL,NULL,NULL,'g1_fiele0');
		
		-- Aggiornamento W_OGGETTI
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.TORN-OFFUNICA-scheda.FASIGARA.MetodoCalcoloSoglia','Funzione consulta metodo calcolo soglia',4300);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.FASIGARA-APERTURA_DOC_AMM.MetodoCalcoloSoglia','Funzione consulta metodo calcolo soglia',2655);

		--Disabilitato il task di deregistrazione imprese e incrementato frequenza acquisizione registrazioni
		update w_quartz set cron_expression='0 30 0 * * ? 2099', cron_year='2099' where codapp='PG' and bean_id='deregistraImpreseNonInPortaleManagerTrigger';
		update w_quartz set cron_expression='0 1/5 * ? * *', cron_minutes='1/5' where codapp='PG' and bean_id='acquisisciRegistrazioniPortaleManagerTrigger';
		
		update eldaver set numver = '7.4.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '7.4.0', datvet = now() where codapp = 'G1';

		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');

  END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '7.4.%') THEN
		
		perform sp_backupanddropviews('documgara');
		ALTER TABLE DOCUMGARA ALTER COLUMN URLDOC TYPE VARCHAR(2000);
		perform sp_restoreviews('documgara');
		
		perform sp_backupanddropviews('gcap');
		ALTER TABLE GCAP ALTER COLUMN CODCARR TYPE VARCHAR(50);
		ALTER TABLE GCAP ALTER COLUMN CODRDA TYPE VARCHAR(50);
		ALTER TABLE GCAP ALTER COLUMN POSRDA TYPE VARCHAR(50);
		perform sp_restoreviews('gcap');
		
		ALTER TABLE GARERDA ALTER COLUMN NUMRDA TYPE VARCHAR(50);
		ALTER TABLE GARERDA ALTER COLUMN POSRDA TYPE VARCHAR(50);
		ALTER TABLE GARERDA ADD CODCARR VARCHAR(50);

		--tabella di estensione N cup gara
		CREATE TABLE GARECUP (
			ID NUMERIC(12) NOT NULL,
			NGARA VARCHAR(20),
			CUP VARCHAR(15),
			primary key (ID));
		ALTER TABLE GARECUP ADD CONSTRAINT FK_GARECUP_GARE FOREIGN KEY (NGARA) REFERENCES GARE( NGARA) ON DELETE CASCADE;
		
		ALTER TABLE TORN ADD SETTORE VARCHAR(5);

		ALTER TABLE GARDOC_JOBS ADD STRUTTURA VARCHAR(2000);

		update eldaver set numver = '7.5.0M1', datvet = now() where codapp = 'PG';
		update eldaver set numver = '7.5.0M1', datvet = now() where codapp = 'G1';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '7.5.0M1') THEN

		update TORN set SETTORE=(select case when substring(tab1desc,1,1)='S' then 'S' else 'O' end from tab1 where tab1cod='A1131' and tab1tip=1) where settore is null;

		DELETE FROM TAB1 WHERE TAB1COD = 'A1131';
		DELETE FROM TAB4 WHERE TAB4COD='G1_1' and TAB4TIP='A1131';
		
		INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) VALUES ('A1z08','O','O','Ordinario');
		INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2) VALUES ('A1z08','S','S','Speciale');

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC) VALUES ('A1154',1,'5548000 Euro - Gare per Lavori');
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC) VALUES ('A1154',2,'443000 Euro - Gare per Forniture e Servizi');
		INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1154','Soglie di rilevanza comunitaria settori speciali (art.35 c.2 DLgs.50/2016)',NULL);
		update TAB4 set tab4desc='Soglie di rilevanza comunitaria settori ordinari (art.35 c.1 DLgs.50/2016)' where tab4cod='G1_1' and tab4tip='A1125';

		INSERT INTO TAB1 (tab1cod,tab1tip,tab1desc,tab1nord) values('A1115',6,'O  Settore ordinario(O) Settore speciale(S)',0);
		
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('GARECUP',0);

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER IN ('G1IDCUP','G1NGARACUP','G1CUPCUP');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','ID.GARECUP.GARE','G1IDCUP','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NGARA.GARECUP.GARE','G1NGARACUP','Codice gara a lotto unico o lotto di gara','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CUP.GARECUP.GARE','G1CUPCUP','Codice CUP di progetto','Cod. CUP Progetto','A15',NULL,NULL,'Codice CUP di progetto');
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER IN ('G1SETTORE');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',null,'SETTORE.TORN.GARE','G1SETTORE','Tipo di settore','Tipo di settore','A100','A1z08',NULL,NULL);
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER IN ('G1STRUTTURADJ');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',null,'STRUTTURA.GARDOC_JOBS.GARE','G1STRUTTURADJ','Struttura','Struttura','A2000',NULL,NULL,NULL);

		UPDATE C0CAMPI set C0C_FS='A2000' where C0C_MNE_BER='G1URLDOC';
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER IN ('G1_CODCARR','G1_CODRDA','G1_POSRDA','G1CODCARR_PP','G1CODRDA_PP','G1POSRDA_PP','G1NUMRDA','G1POSRDA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODCARR.GCAP.GARE','G1_CODCARR','Codice carrello','Cod.carrello','A50',NULL,NULL,'Carrello');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODRDA.GCAP.GARE','G1_CODRDA','Codice RDA','Cod.RDA','A50',NULL,NULL,'Rda');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'POSRDA.GCAP.GARE','G1_POSRDA','Posizione RDA','Pos.RDA','A50',NULL,NULL,'Posizione Rda');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODCARR.V_GCAP_DPRE.GARE','G1CODCARR_PP','Codice carrello','Codice carrello','A50',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODRDA.V_GCAP_DPRE.GARE','G1CODRDA_PP','Codice rda','Codice rda','A50',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'POSRDA.V_GCAP_DPRE.GARE','G1POSRDA_PP','Posizione rda','Posizione rda','A50',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'NUMRDA.GARERDA.GARE','G1NUMRDA','Numero dell''RdA','Numero','A50',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'POSRDA.GARERDA.GARE','G1POSRDA','Posizione','Posizione','A50',NULL,NULL,NULL);
		
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODCARR.GARERDA.GARE','G1CODCARR','Codice carrello','Cod.carrello','A50',NULL,NULL,'Carrello');
		
		DELETE FROM C0ENTIT WHERE C0E_NOM IN ('GARECUP.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARECUP.GARE',0,'E','GARE_CUP','Codici CUP aggiuntivi della gara','NGARA.GARECUP.GARE','GARE.GARE','NGARA.GARE.GARE',NULL,NULL,'g1_cup0');
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.NotificaAggiornamentiCategorieElenco','Visualizza notifica aggiornamento categorie elenco',12895);
		
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wserp.erp.sbiancaCodFornitoreERP',NULL,NULL,NULL,NULL);
				
		--Processo schedulato per controllo aggiornamenti anagrafici da portale
		INSERT INTO W_QUARTZ (CODAPP,BEAN_ID,CRON_EXPRESSION,CRON_SECONDS,CRON_MINUTES,CRON_HOURS,CRON_DAY_OF_MONTH,CRON_MONTH,CRON_DAY_OF_WEEK,CRON_YEAR,DESCRIZIONE) VALUES ('PG','acquisizioneAggiornamentoAnagraficoTrigger', '0 2/5 * ? * *','0','2/5','*','?','*','*',null, 'Schedulazione dell''acquisizione da PortaleAppalti di richieste aggiornamento anagrafico');
		--Processo schedulato per acquisizione registrazioni in stato di errore 
		INSERT INTO W_QUARTZ (CODAPP,BEAN_ID,CRON_EXPRESSION,CRON_SECONDS,CRON_MINUTES,CRON_HOURS,CRON_DAY_OF_MONTH,CRON_MONTH,CRON_DAY_OF_WEEK,CRON_YEAR,DESCRIZIONE) VALUES ('PG','acquisisciRegistrazioniInErroreManagerTrigger', '0 * 0/2 ? * *','0','*','0/2','?','*','*',null, 'Schedulazione dell''acquisizione da PortaleAppalti di richieste registrazione in stato di errore');
		
		update eldaver set numver = '7.5.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '7.5.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;

select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '7.5.%') THEN

		ALTER TABLE TORN ADD INVERSA VARCHAR(1);
		ALTER TABLE DITG ADD AMMINVERSA VARCHAR(1);
		
		ALTER TABLE TORN ADD MODMANO NUMERIC(7);
		ALTER TABLE DITG ADD PERCMANO NUMERIC(24,5);
		
		ALTER TABLE GARERDA ADD CODVOC VARCHAR(20);
		ALTER TABLE GARERDA ADD VOCE VARCHAR(2000);
		ALTER TABLE GARERDA ADD UNIMIS VARCHAR(10);
		ALTER TABLE GARERDA ADD CODCAT VARCHAR(30);
		ALTER TABLE GARERDA ADD PERCIVA NUMERIC(2);
		ALTER TABLE GARERDA ADD QUANTI NUMERIC(24,5);
		ALTER TABLE GARERDA ADD PREZUN NUMERIC(24,5);
		
		update eldaver set numver = '7.6.0M1', datvet = now() where codapp = 'PG';
		update eldaver set numver = '7.6.0M1', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = '7.6.0M1') THEN
	
		UPDATE TORN SET MODMANO = 1 WHERE RICMANO = '1' AND MODMANO IS NULL;

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1155',1,'Importo',NULL,NULL,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1155',2,'Percentuale',NULL,NULL,NULL);	
	
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER IN ('G1INVERSA','G1AMMINVERSA','G1PERCMANO','G1MODMANO');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'INVERSA.TORN.GARE','G1INVERSA','Utilizzo della procedura inversa?','Procedura inversa?','A2',NULL,'SN','Utilizzo procedura inversa?');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'AMMINVERSA.DITG.GARE','G1AMMINVERSA','Ammessa alla gara dopo verifica con procedura inversa?','Ammiss.proc.inversa?','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PERCMANO.DITG.GARE','G1PERCMANO','Costi della manodopera in percent.(art.95 c.10 DLgs.50/2016)','Costi manod.in perc.','F13.5',NULL,'PRC','Costi manodopera');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'MODMANO.TORN.GARE','G1MODMANO','Costi manodopera espressi mediante importo(1) o percent.(2)','Mod.presentaz.manod.','A100','A1155',NULL,'Costi manodopera espressi mediante');

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER IN ('G1CODVOCRDA','G1VOCERDA','G1UNMISRDA','G1CODCATRDA','G1PEIVARDA','G1QUANTRDA','G1PREUNRDA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODVOC.GARERDA.GARE','G1CODVOCRDA','Codice articolo','Cod.articolo','A20',NULL,NULL,NULL);
 		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'VOCE.GARERDA.GARE','G1VOCERDA','Descrizione','Descrizione','A2000',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'UNIMIS.GARERDA.GARE','G1UNMISRDA','Unità di misura','Unità di misura','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODCAT.GARERDA.GARE','G1CODCATRDA','Codice categoria','Codice categoria','A30',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'PERCIVA.GARERDA.GARE','G1PEIVARDA','Aliquota IVA','Aliquota IVA','N2',NULL,'PRC',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'QUANTI.GARERDA.GARE','G1QUANTRDA','Quantità prevista','Quantità','F12.3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PREZUN.GARERDA.GARE','G1PREUNRDA','Prezzo unitario a base di gara','Prezzo unitario','F15',NULL,'MONEY5',NULL);

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER IN ('G1CENINT_L');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CENINT.V_GARE_TORN.GARE','G1CENINT_L','Stazione appaltante (colleg.arch.Uffici intestat.)','Stazione appaltante','A16',NULL,NULL,'Codice stazione appaltante');

		UPDATE C0ENTIT SET C0E_KEY='CODARCH.ARCHDOCG.GARE,NUMDOCG.ARCHDOCG.GARE' where C0E_NOM='ARCHDOCG.GARE';

		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('COLS','VIS','GARE.TORN.MODMANO','Visualizza.',0,1,1,3781197375);
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.GARE-scheda.DATIGENOFFUNICA.Agg-Categ-Prevalente','Nuova categoria prevalente o prestazione principale',3983);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.GARE-scheda.DATIGENOFFUNICA.Agg-Categ-Ulteriore','Nuova categoria ulteriore o prestazione secondaria',3985);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.GARE-scheda.DATIGENOFFUNICA.Elimina-Categ-Ulteriore','Elimina categoria ulteriore o prestazione secondaria',3990);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.DATIGENOFFUNICA.CATG','Sezione "Categoria prevalente" o "Prestazione principale"',3962);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.DATIGENOFFUNICA.OPES','Sezione dinamica "Ulteriore categoria" o "Prestazione secondaria"',3963);
		
		-- (S.Santi 19.04.2019) Aggiunto campo 'Ufficio intestatario' (CENINT.TORN)
		perform sp_backupanddropviews('v_gare_torn');
		create or replace view v_gare_torn as 
		with
		--n.lotti di ogni gara
		lotti
		as (
		select codgar1, array_to_string(array_agg(gare.codcig),',') codciglotti, count(*) numlotti from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati senza esito negativo
		lottiagg
		as (
		select codgar1, count(*) numlottiagg from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null and esineg is null
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati e con contratto stipulato senza esito negativo
		lottistip
		as (
		select codgar1, count(*) numlottistip from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null and esineg is null and daatto is not null
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati o con esito negativo
		lotticonc
		as (
		select codgar1, count(*) numlotticonc from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null or esineg is not null
		group by codgar1
		)
		select codgar, codgar as codice, tipgen, destor as oggetto, imptor as importo, tipgar, 
			cast('1' as varchar(1)) as islotti, (case when gare.genere=3 then 3 else 1 end) as genere, isarchi,
			case when (lotti.numlotti>0 and lottiagg.numlottiagg>0 and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu,
			case when (lotti.numlotti>0 and lottistip.numlottistip>0 and lottiagg.numlottiagg=lottistip.numlottistip and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isstipula,
			case when (lotti.numlotti>0 and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as islotticonclusi,
			(case when gare.genere=3 then gare.esineg else torn.esineg end) as esineg, lotti.codciglotti as codcig, profiloweb, gartel, cenint
		from torn 
			left outer join gare on (codgar=gare.ngara and gare.genere=3) 
			left outer join lotti on (lotti.codgar1=torn.codgar)
			left outer join lottiagg on (lottiagg.codgar1=torn.codgar)
			left outer join lottistip on (lottistip.codgar1=torn.codgar)
			left outer join lotticonc on (lotticonc.codgar1=torn.codgar)
			where codgar not like '$%' 
		union
		select torn.codgar, gare.ngara as codice, torn.tipgen, gare.not_gar as oggetto, gare.impapp as importo, gare.tipgarg,
			cast('2' as varchar(1)) as islotti, 2 as genere, torn.isarchi, 
			case when (gare.ditta is not null and gare.esineg is null) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu, 
			case when (gare.ditta is not null and gare.daatto is not null and gare.esineg is null) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isstipula, 
			null as islotticonclusi,
			gare.esineg, gare.codcig, torn.profiloweb, torn.gartel, torn.cenint
			from gare,torn 
			where torn.codgar=gare.codgar1 and torn.codgar like '$%' and (gare.genere is null or (gare.genere not in (4,10,11,20)));
		perform sp_restoreviews('v_gare_torn');

		update eldaver set numver = '7.6.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '7.6.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '7.6.%') THEN

                ALTER TABLE GARE1 ADD SOGLIA1 NUMERIC(24,9);
                ALTER TABLE GARE1 ADD SOGLIAVAR NUMERIC(24,9);
                ALTER TABLE GARE1 ADD MEDIARAP NUMERIC(24,9);
                ALTER TABLE GARE1 ADD SOGLIANORMA VARCHAR(20);
		
		update eldaver set numver = '8.0.0M1', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.0.0M1', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = '8.0.0M1') THEN
	
		--Adeguamento criteri selezione da elenco DL.32/2019
		update confopeco set aimporto=200000, numminop=3 where tipologia=1 and daimporto=40000 and aimporto=150000;
		update confopeco set daimporto=200000, aimporto=5548000, numminop=5 where tipologia=1 and daimporto=150000 and aimporto=1000000;
		update confopeco set daimporto=5548000 where tipologia=1 and daimporto=1000000 and (aimporto is null or aimporto=0);

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1156',1,'3    - n.minimo per procedure sopra soglia',NULL,NULL,NULL);
        INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1156',2,'3    - n.minimo per procedure sotto soglia',NULL,NULL,NULL);
		INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1156','Calcolo aggiudicazione: (DLgs.50/2016 + DL.32/2019) numero minimo ditte per calcolo anomalia OEPV',NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1157',1,'1   considera il prodotto delle due cifre(1) considera il numero composto dalle due cifre(0)',NULL,NULL,NULL);
		INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1157','Calcolo aggiudicazione: (DLgs.50/2016 + DL.32/2019) criterio prime due cifre decimali somma ribassi',NULL);

        INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z10','1','DLGS50_2016','20/04/2016',NULL,1,NULL);
		INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z10','2','DLGS56_2017','20/05/2017',NULL,2,NULL);
		INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z10','3','DL32_2019','19/04/2019',NULL,3,NULL);
        INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1z10','Criterio applicazione norme calcolo aggiudicazione',NULL);

        delete from tab1 where tab1cod='A2064';
		delete from tab4 where tab4cod='G1_1' and tab4tip='A2064';
		--Nasconde tabellati relativi a normativa DLgs.163/2006 e LR.Sicilia 14/2015
		delete from tab4 where tab4cod='G1_1' and tab4tip='A1048';
		delete from tab4 where tab4cod='G1_1' and tab4tip='A1107';
		delete from tab4 where tab4cod='G1_1' and tab4tip='A2063';
		delete from tab4 where tab4cod='G1_1' and tab4tip='A1019';
		delete from tab4 where tab4cod='G1_1' and tab4tip='A1116';
		delete from tab4 where tab4cod='G1_1' and tab4tip='A1127';

		UPDATE TAB4 set TAB4DESC='Calcolo aggiudicazione: (DLgs.50/2016 + DLgs.56/2017)criterio accorpamento off.uguali nel taglio ali' where tab4cod='G1_1' and tab4tip='A1134';
		UPDATE TAB4 set TAB4DESC='Calcolo aggiudicazione: (DLgs.50/2016 + DLgs.56/2017) coeff.per calcolo soglia metodo E' where tab4cod='G1_1' and tab4tip='A1140';
		UPDATE TAB4 set TAB4DESC='Calcolo aggiudicazione: (DLgs.50/2016 + DLgs.56/2017) criterio somma ribassi metodo B' where tab4cod='G1_1' and tab4tip='A1132';
		UPDATE TAB4 set TAB4DESC='Calcolo aggiudicazione: (DLgs.50/2016 + DLgs.56/2017) modalità sorteggio calcolo soglia' where tab4cod='G1_1' and tab4tip='A1128';
		UPDATE TAB4 set TAB4DESC='Calcolo aggiudicazione: (DLgs.50/2016 + DLgs.56/2017) % per taglio delle ali' where tab4cod='G1_1' and tab4tip='A2065';
		UPDATE TAB4 set TAB4DESC='Calcolo aggiudicazione: (DLgs.50/2016) numero minimo ditte per calcolo anomalia Miglior prezzo' where tab4cod='G1_1' and tab4tip='A1135';
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER IN ('G1SOGLIA1','G1SOGLIAVAR','G1MEDIARAP','G1SOGLIANORM');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SOGLIA1.GARE1.GARE','G1SOGLIA1','Soglia di anomalia intermedia (DL.32/2019)','Soglia an.intermedia','F13.9',NULL,'PRC','Prima soglia di anomalia');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SOGLIAVAR.GARE1.GARE','G1SOGLIAVAR','Percentuale di decremento prima soglia anomalia(DL.32/2019)','Percent. decr.soglia','F13.9',NULL,'PRC','Percentuale decremento prima soglia di anomalia');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'MEDIARAP.GARE1.GARE','G1MEDIARAP','Rapporto tra media scarti e media ribassi (DL.32/2019)','Rapporto medie','F13.9',NULL,NULL,'Rapporto tra media scarti e media ribassi');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SOGLIANORMA.GARE1.GARE','G1SOGLIANORM','Norma applicata per il calcolo soglia anomalia ','Norma calcolo soglia','A20',NULL,NULL,NULL);

		UPDATE C0CAMPI set COC_DES='Somma dei ribassi offerti' where C0C_MNE_BER='G1SOMMARIB';

        UPDATE C0CAMPI set COC_DES='Cat.superspecialistica subappaltabile al 30%?', COC_DES_FRM='Supersp.subapp.30%?',COC_DES_WEB='Superspecialistica subapp.al 30%?' where C0C_MNE_BER='G1ACONTEUL';
        UPDATE C0CAMPI set COC_DES='Categoria scorporabile?', COC_DES_FRM='Categoria scorpor.?',COC_DES_WEB='Scorporabile?' where C0C_MNE_BER='G1QUAOBBUL';
        UPDATE C0CAMPI set COC_DES='Cat.superspecialistica subappaltabile al 30%?', COC_DES_FRM='Supersp.subapp.30%?',COC_DES_WEB='Superspecialistica subapp.al 30%?' where C0C_MNE_BER='G1ACONTEC_C';
        UPDATE C0CAMPI set COC_DES='Categoria scorporabile?', COC_DES_FRM='Categoria scorpor.?',COC_DES_WEB='Scorporabile?' where C0C_MNE_BER='G1QUAOBB_C';

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FASIGARA.AnnullaAperturaOfferte','Procedure telematiche: annulla apertura offerte',11122);
		
		INSERT INTO W_CONFIG (CODAPP, CHIAVE, VALORE, SEZIONE, DESCRIZIONE, CRIPTATO) VALUES ('PG', 'wsdm.gestioneERP',NULL,NULL,NULL,NULL);
		
		INSERT INTO W_QUARTZ (CODAPP,BEAN_ID,CRON_EXPRESSION,CRON_SECONDS,CRON_MINUTES,CRON_HOURS,CRON_DAY_OF_MONTH,CRON_MONTH,CRON_DAY_OF_WEEK,CRON_YEAR,DESCRIZIONE) VALUES ('PG','aggiornaERPvsWSDMStatoGaraTrigger', '0 0 0 1 1 ? 2099', '0', '0', '0', '1', '1', '?', '2099', 'Schedulazione dell''aggiornamento tramite WSDM dello stato di gara');

		-- (S.Santi 08.05.2019) Introdotto condizione per non ereditare nella fase amministrativa l'ammissione della fase di prequalifica
		perform sp_backupanddropviews('v_ditgammis');
		create or replace view v_ditgammis as
			SELECT CODGAR, NGARA, g1.DITTAO, TAB1TIP as FASGAR, TAB1DESC,
				case when (ditg.partgar='2' and ditg.fasgar in (-4,2,5,6) and tab1tip >=ditg.fasgar) then null else g1.ammgar end AMMGAR,
				MOTIVESCL, DETMOTESCL 
				FROM DITGAMMIS g1, (SELECT * FROM TAB1 WHERE tab1cod='A1011') FASI,DITG
				WHERE g1.fasgar =(SELECT MAX(fasgar) FROM DITGAMMIS g2 WHERE g2.fasgar<=TAB1TIP AND (tab1tip<1 or g2.fasgar>=1) AND g1.codgar=g2.codgar AND g1.ngara=g2.ngara AND g1.dittao=g2.dittao)
				and ditg.ngara5=g1.ngara and ditg.dittao=g1.dittao
			union 
				SELECT d.codgar5,d.ngara5,d.dittao,tab1tip as FASGAR,TAB1DESC,ditgammis.ammgar,null,null
				FROM ditg d cross join (SELECT * FROM TAB1 WHERE tab1cod='A1011') FASI
				left outer join ditgammis on (d.ngara5=ditgammis.ngara and d.dittao=ditgammis.dittao and ditgammis.fasgar<=tab1tip and (tab1tip<1 or ditgammis.fasgar>=1))
				WHERE ditgammis.ammgar is null;
		perform sp_restoreviews('v_ditgammis');

		update eldaver set numver = '8.0.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.0.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.0.%') THEN
	
		ALTER TABLE GARERDA ADD ESERCIZIO VARCHAR(4);
		ALTER TABLE GARERDA ADD NGARA VARCHAR(20);
		ALTER TABLE GARDOC_JOBS ADD SUPPORTO VARCHAR(100);
		
		--Modificato il constraint su DITGEVENTI per consentire la modifica del codice ditta
		ALTER TABLE DITGEVENTI DROP CONSTRAINT FK_DITGEVENTI_DITG;
		ALTER TABLE DITGEVENTI ADD CONSTRAINT FK_DITGEVENTI_DITG FOREIGN KEY ( CODGAR,DITTAO,NGARA) REFERENCES DITG( CODGAR5,DITTAO,NGARA5 ) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

		update eldaver set numver = '8.1.0M1', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.1.0M1', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
v_max_confopeco numeric(7):= 0;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = '8.1.0M1') THEN
	
	    --aggiornamento della fase di gara in seguito alla dismissione della gestione della comprova requisiti
        update gare set fasgar=2, stepgar=35 where fasgar=3 or fasgar=4;

        INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1158',1,'1   sorteggio automatico(1) manuale(0)',NULL,NULL,NULL);
		INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1158','Modalità sorteggio ditte per verifica requisiti',NULL);
	
		--archivia valori tabellato relativi a comprova requisiti per le sedute di gara
		UPDATE TAB1 SET TAB1ARC='1' where TAB1COD='A2086' and TAB1TIP in (3,4);

		update tab1 set tab1desc=substr(tab1desc,1,1)||'   Previsto sorteggio ditte per verifica requisiti(1) non previsto(2)' where tab1cod='A1115' and tab1tip=3;

		update GAREALBO set tipoclass=3 where tipoclass is null;

		--Adeguamento criteri selezione da elenco L.55/2019 (conversione in legge del DL.32/2019)
		update confopeco set aimporto=150000, numminop=3 where tipologia=1 and daimporto=40000 and aimporto=200000;
		update confopeco set daimporto=150000, aimporto=350000, numminop=10 where tipologia=1 and daimporto=200000 and aimporto=5548000;
		update confopeco set daimporto=350000, aimporto=1000000, numminop=15 where tipologia=1 and daimporto=5548000 and (aimporto is null or aimporto=0);
		IF (SELECT count(*)=0 FROM confopeco where tipoprocedura=5 and tipologia=1 and daimporto=1000000 and aimporto=0) THEN
			SELECT coalesce(MAX(NUMCONFOP),0) INTO v_max_confopeco FROM confopeco;
			 v_max_confopeco := v_max_confopeco + 1;
			INSERT INTO CONFOPECO (NUMCONFOP,TIPOPROCEDURA,TIPOLOGIA,ISABILITATO,DAIMPORTO,AIMPORTO,NUMMINOP) VALUES (v_max_confopeco,5,1,'1',1000000,0,5);
		end if;

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1ESERCIZIORDA','G1NGARARDA','G1SUPPORTODJ');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ESERCIZIO.GARERDA.GARE','G1ESERCIZIORDA','Esercizio','Esercizio','A4', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NGARA.GARERDA.GARE','G1NGARARDA','Codice lotto','Codice lotto','A20', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SUPPORTO.GARDOC_JOBS.GARE','G1SUPPORTODJ','Supporto','Supporto','A100',NULL,NULL,NULL);

        update C0CAMPI set COC_DES = 'Sorteggio ditte per verifica requisiti?', COC_DES_FRM = 'Sorteg.ditte verif.?', COC_DES_WEB = 'Sorteggio ditte per verifica requisiti?' where C0C_MNE_BER = 'G1COMPREQ';
        update C0CAMPI set COC_DES = 'Ditta sorteggiata per verifica requisiti?' where C0C_MNE_BER = 'G1ESTIMPD';
        update C0CAMPI set COC_DES = 'Ditta sorteggiata per verifica requisiti?' where C0C_MNE_BER = 'G1ESTIMPD_DF';
        update C0CAMPI set COC_DES = 'Data di sorteggio delle ditte per verifica requisiti', COC_DES_WEB='Data sorteggio ditte per verifica requisiti' where C0C_MNE_BER = 'DGARA';
        update C0CAMPI set COC_DES = 'Ora di sorteggio delle ditte per verifica requisiti' where C0C_MNE_BER = 'OGARA';
        update C0CAMPI set COC_DES = 'Estrazione 10% imprese per controllo documenti?(NON USATO)', COC_DES_FRM = 'NON USATO', C0C_TIP='C' where C0C_MNE_BER = 'G1ESTIMP';
        update C0CAMPI set COC_DES = 'Impresa controllata e in ordine con i documenti?(NON USATO)', COC_DES_FRM = 'NON USATO' where C0C_MNE_BER = 'G1ESTIMPE';
                
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GestioneUnicaERP','Gestione unica gare con ERP',14020);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FASIGARA.SorteggioDitteVerificaRequisiti','Funzione "Sorteggio ditte per verifica requisiti"',11125);
		
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('FUNZ','VIS','ALT.GARE.GestioneUnicaERP','Visualizza',0,1,1,3232745797);

		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdm.gestioneStrutturaCompetente',NULL,NULL,NULL,NULL);

		--	esteso significato e funzionalita del task che pertanto viene rinominato
		update W_QUARTZ set bean_id = 'aggiornaERPStatoGaraTrigger', descrizione = 'Schedulazione dell''aggiornamento tramite ERP dello stato di gara' where bean_id ='aggiornaERPvsWSDMStatoGaraTrigger';
		
		-- (S.Santi 28.06.2019) Tolto visualizzazione fasi 3 e 4 e relativo controllo su COMPREQ.TORN
		perform sp_backupanddropviews('v_gare_dittefasi');
		create or replace view v_gare_dittefasi as
			with ditte as (select tab1tip num_fase,tab1desc desc_fase,codgar5 codgar,ngara5 ngara,dittao,nomimo, nprogg,numordpl,
					 (case when tab1tip = 2 then estimp else null end) sorteggio,
					 (case when tab1tip in (-4,2,5,6) then partgar else null end) partecipa,
					  fasgar fase_esclu 
					  from tab1,ditg where tab1cod='A1011'
					  and ((tab1tip <1 and (acquisizione is null or acquisizione <>5)) or (tab1tip>=1 and rtofferta is null)))
			select ditte.*,ammgar ammissione,motivescl,detmotescl
			  from gare, v_gare_genere, torn, gare1,
					 ditte, v_ditgammis 
			  where ditte.ngara=gare.ngara
				 and ditte.ngara=v_gare_genere.codice and v_gare_genere.genere not in (10,11,20,4)
				 and gare.codgar1=torn.codgar
				 and gare.ngara=gare1.ngara
				 and ditte.ngara=v_ditgammis.ngara and ditte.dittao=v_ditgammis.dittao and ditte.num_fase=v_ditgammis.fasgar
				 and ((torn.iterga=1 and num_fase>=1) or (torn.iterga in (3,5,6) and num_fase>=-3) or (torn.iterga in (2,4)))
				 and (num_fase<>3 and num_fase<>4)
				 and (
					   (
					   ((v_gare_genere.genere <>3 and (((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5) or (modlicg=6 or gare1.valtec='1') or (modlicg is null and num_fase=1)))
							 or (
							 (v_gare_genere.genere=3 and gare.bustalotti=2 and num_fase < 7 and 
							   (
							   (not exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1')) and num_fase<>5)
								or exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1'))
								)
							   ))
							   or
							   (v_gare_genere.genere=3 and gare.bustalotti=1 and num_fase < 5))
						 and v_gare_genere.genere<>300)
						or 
						(v_gare_genere.genere=300 and num_fase in (-4,2,5,6,7,8) and ((modlicg=6 or gare1.valtec='1') or ((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5)))
					 )
				 and (num_fase<=fase_esclu or fase_esclu is null or fase_esclu=0);
		perform sp_restoreviews('v_gare_dittefasi');

		 update eldaver set numver = '8.1.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.1.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.1.%') THEN
	
		ALTER TABLE DITG ADD STAGGIALI NUMERIC(2);

        update eldaver set numver = '8.2.0M1', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.2.0M1', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = '8.2.0M1') THEN
	
		--Nuovi criteri di rotazione per aggiudicazioni e inviti
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1073',13,'Rotazione in base a aggiudicazioni e inviti',NULL,12,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1073',14,'Rotazione in base a aggiudicazioni e inviti su categoria',NULL,13,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1073',15,'Rotazione in base a aggiudicazioni e inviti su categoria e classe',NULL,14,NULL);
		update tab1 set tab1nord=100 where tab1cod='A1073' and tab1tip=2;

		INSERT INTO ALGORITMI (NUMALGO,CODAPP,CODALGO,TIPOALGO,DESCALGO) VALUES (13,'PG','A1073',13,'Presenta gli operatori in ordine inverso rispetto al numero di affidamenti ottenuti e alle penalità assegnate dall''ente. A parità di numero di affidamenti e penalità, gli operatori sono ordinati secondo gli inviti ricevuti e, a parità di quest''ultimi, secondo il numero ordine assegnato in elenco.');
		INSERT INTO ALGORITMI (NUMALGO,CODAPP,CODALGO,TIPOALGO,DESCALGO) VALUES (14,'PG','A1073',14,'Presenta gli operatori in ordine inverso rispetto al numero di affidamenti ottenuti sulla categoria o prestazione prevalente della gara e alle penalità assegnate dall''ente. A parità di numero di affidamenti e penalità, gli operatori sono ordinati secondo gli inviti ricevuti sulla categoria e, a parità di quest''ultimi, secondo il numero ordine assegnato in elenco.');
		INSERT INTO ALGORITMI (NUMALGO,CODAPP,CODALGO,TIPOALGO,DESCALGO) VALUES (15,'PG','A1073',15,'Presenta gli operatori in ordine inverso rispetto al numero di affidamenti ottenuti sulla categoria o prestazione prevalente della gara e sulla relativa classe e alle penalità assegnate dall''ente. A parità di numero di affidamenti e penalità, gli operatori sono ordinati secondo gli inviti ricevuti sulla categoria e relativa classe e, a parità di quest''ultimi, secondo il numero ordine assegnato in elenco.');

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER = 'G1STAGGIAL';
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'STAGGIALI.DITG.GARE','G1STAGGIAL','Stato ditta rientrante nelle ali nel calcolo aggiudicazione','Stato aggiudic.ala','A100','A1016',NULL,NULL);

        update eldaver set numver = '8.2.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.2.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.2.%') THEN

		ALTER TABLE GCAP ADD PESO NUMERIC(24,5);
		ALTER TABLE DPRE ADD RIBPESO NUMERIC(24,9);
		perform sp_backupanddropviews('dpre');
		ALTER TABLE DPRE ALTER COLUMN PERRIB TYPE NUMERIC(24,9);
		perform sp_restoreviews('dpre');

		ALTER TABLE GARDOC_WSDM ADD COS_NOME_FILE VARCHAR(500);
		ALTER TABLE GARDOC_WSDM ADD COS_INDICE VARCHAR(500);
		ALTER TABLE GARDOC_WSDM ADD COS_PID VARCHAR(50);
		ALTER TABLE GARDOC_WSDM ADD COS_UID VARCHAR(50);
		
		update eldaver set numver = '8.3.0M1', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.3.0M1', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = '8.3.0M1') THEN

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1053',3,'Somma sconti pesati',NULL,0,NULL);

 		--Aggiornamento tabellati - verifica l'esistenza perchè già introdotti in patch versione precedente
		if (select count(*) = 0 from tab1 where tab1cod = 'A1159' and tab1tip=1) THEN
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1159',1,'1   sottrazione algebrica(1) riduzione in percentuale(0)',NULL,NULL,NULL);
			INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1159','Calcolo aggiudicazione: (DLgs.50/2016 + DL.32/2019) criterio decremento soglia con num.off.>=15',NULL);
		end if;
		
		--Forzato ordinamento sul tab.'Formato criterio oepv'
		update tab1 set tab1nord=9 where tab1cod='A1143' and tab1tip=1;
		update tab1 set tab1nord=8 where tab1cod='A1143' and tab1tip=2;
		update tab1 set tab1nord=4 where tab1cod='A1143' and tab1tip=3;
		update tab1 set tab1nord=5 where tab1cod='A1143' and tab1tip=4;
		update tab1 set tab1nord=6 where tab1cod='A1143' and tab1tip=5;
		update tab1 set tab1nord=7 where tab1cod='A1143' and tab1tip=6;
		update tab1 set tab1nord=1 where tab1cod='A1143' and tab1tip=50;
		update tab1 set tab1nord=2 where tab1cod='A1143' and tab1tip=51;
		update tab1 set tab1nord=3 where tab1cod='A1143' and tab1tip=52;
		update tab1 set tab1nord=100 where tab1cod='A1143' and tab1tip=100;
		update tab1 set tab1desc='Valuta (importo in euro)' where tab1cod='A1143' and tab1tip=2;

		--Rimosso parametro per controllo su applicabilita' criterio 'miglior prezzo'
		delete from tab1 where tab1cod='A1129';
		delete from tab4 where tab4tip='A1129';

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1_PESO','G1_PERRID','G1RIBPESO','G1PERRID_P','G1PESO_P','G1RIBPES_P');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PESO.GCAP.GARE','G1_PESO','Peso attribuito alla lavorazione','Peso','F8.3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PERRIB.DPRE.GARE','G1_PERRID','Ribasso sul prezzo unitario offerto dalla ditta ','Ribasso prezzo unit.','F13.9',NULL,'PRC','Ribasso offerto');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'RIBPESO.DPRE.GARE','G1RIBPESO','Ribasso sul prezzo unitario pesato','Ribasso pesato','F13.9',NULL,'PRC',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PERRIB.V_GCAP_DPRE.GARE','G1PERRID_P','Ribasso sul prezzo unitario offerto dalla ditta','Ribasso prezzo unit.','F13.9',NULL,'PRC','Ribasso offerto');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PESO.V_GCAP_DPRE.GARE','G1PESO_P','Peso attribuito alla lavorazione','Peso','F8.3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'RIBPESO.V_GCAP_DPRE.GARE','G1RIBPES_P','Ribasso sul prezzo unitario pesato','Ribasso pesato','F13.9',NULL,'PRC',NULL);
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1COSNOMEFILE','G1COSINDICE','G1COSPID','G1COSUID');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COS_NOME_FILE.GARDOC_WSDM.GARE','G1COSNOMEFILE','Nome file assegnato per la messa in conservazione','Nome file in conserv','A500',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COS_INDICE.GARDOC_WSDM.GARE','G1COSINDICE','Nome file di indice del pacchetto di versamento','Nome file di indice','A500',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COS_PID.GARDOC_WSDM.GARE','G1COSPID','Codice PID pacchetto versamento','Codice PID','A50',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COS_UID.GARDOC_WSDM.GARE','G1COSUID','Codice UID di conservazione del documento','UID conserv.docum.','A50',NULL,NULL,NULL);

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1AMMINV_DF');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'AMMINVERSA.V_GARE_DITTEFASI.GARE','G1AMMINV_DF','Ammessa alla gara dopo verifica con procedura inversa?','Ammiss.proc.inversa?','A2',NULL,'SN',NULL);

        update C0CAMPI set COC_DES = 'Valore di decremento prima soglia anomalia(DL.32/2019)', COC_DES_FRM = 'Valore decrem.soglia', COC_DES_WEB = 'Decremento prima soglia di anomalia', COC_DOM=null where C0C_MNE_BER = 'G1SOGLIAVAR';

		INSERT INTO W_QUARTZ (CODAPP,BEAN_ID,CRON_EXPRESSION,CRON_SECONDS,CRON_MINUTES,CRON_HOURS,CRON_DAY_OF_MONTH,CRON_MONTH,CRON_DAY_OF_WEEK,CRON_YEAR,DESCRIZIONE) VALUES ('PG','generazioneInvioIndiceCOSTrigger', '0 0 2 1/16 * ? 2099','0','0','2','1/16','*','?','2099', 'Schedulazione dell''invio dei documenti al sistema di conservazione digitale');
		
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cos.sftp.url',NULL,'Conservazione digitale','URL FTP',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cos.sftp.port', NULL, 'Conservazione digitale','Porta', NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cos.sftp.login',NULL,'Conservazione digitale','Login di accesso al sistema di conservazione digitale',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cos.sftp.password',NULL,'Conservazione digitale','Password di accesso al sistema di conservazione digitale','1');
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cos.sftp.aliasSp','Appalti-e-Gare','Conservazione digitale', 'Alias SP', NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cos.sftp.aliasDa','AGC-PRATICHE-GARE','Conservazione digitale','Alias DA', NULL);
	    INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cos.sftp.pathBase',NULL,'Conservazione digitale','Path assoluto area ftp (da anteporre al path base - es.: /nfswork/homeutenti/Test-Pratiche)',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cos.formatiConsentiti','txt,xml,pdf','Conservazione digitale','Estensioni accettate dal sistema di conservazione digitale. Indicare i formati separati da "," (es: txt,xml,pdf)',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cos.formatiConsentitiFirmaDigitale','p7m,tsd','Conservazione digitale','Estensioni considerate dal sistema di conservazione come firma digitale. Indicare i formati separati da "," (es: p7m,pdf)',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cos.maxRigheIndice','5000','Conservazione digitale','Numero massimo di documenti del pacchetto di versamento', NULL);
		
		--Aggiornamento configurazioni - verifica l'esistenza perchè già introdotto in patch versione precedente
		if (select count(*) = 0 from w_config where codapp='PG' and chiave='wsdm.bloccoIndirizzoMittente') THEN
			INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdm.bloccoIndirizzoMittente','1',NULL,NULL,NULL);
		end if;
        INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdm.applicaRiservatezza','0',NULL,NULL,NULL);
        INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','wsdm.associaDocumentiProtocollo','0',NULL,NULL,NULL);
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.AssociaDocDitteAProtocollo','Funzione associa documenti ditte a protocollo (JIRIDE)',13074);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.TrasferisciCos','Funzione trasferimento documenti a sistema di conservazione (COS)',13075);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SUBMENU','STRUMENTI.ImportaDatiL190','Importa dati L190',14030);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FASIGARA.AnnullaRiservatezza','Funzione annulla riservatezza dati in JIRIDE in fase apert.doc.amministrativa',14040);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.AGGDEF.AnnullaRiservatezza','Funzione annulla riservatezza dati in JIRIDE',14045);
		
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('SUBMENU','VIS','STRUMENTI.ImportaDatiL190','Visualizza',0,1,1,762523658);
		
		-- (M.Caminiti 16.07.2019) Aggiunto campi relativi a ribasso pesato
		perform sp_backupanddropviews('v_gcapd');
		create or replace view v_gcapd as
                  select gcap.ngara,gcap.contaf,gcap.norvoc,gcap.codvoc,gcap.unimis,gcap.quanti,gcap.prezun,gcap.peso,
                  gcap.perciva,gcap.clasi1,gcap.numpar,gcap.voce,gcap.solsic,gcap.sogrib,gcap.dittao,
                  gcap.codcarr,gcap.codrda,gcap.posrda,gcap.datacons,ditg.dittao as cod_ditta, ditg.codgar5 as codgar, gare.codiga
                  from gcap, ditg, gare
                  where gcap.ngara=ditg.ngara5 and (gcap.dittao is null or gcap.dittao=ditg.dittao)
                   and gcap.ngara=gare.ngara;
		perform sp_restoreviews('v_gcapd');

		perform sp_backupanddropviews('v_gcap_dpre');
		create or replace view v_gcap_dpre as
        	select (case when v_gcapd.dittao is null then '2' else '1' end) as issoloditta,
        		   (case when v_gcapd.quanti=dpre.quanti or dpre.quanti is null then '2' else '1' end) as isquantimod,
        		   v_gcapd.codgar, v_gcapd.ngara, v_gcapd.codiga, v_gcapd.contaf, v_gcapd.cod_ditta, v_gcapd.norvoc,
        		   v_gcapd.codvoc, v_gcapd.voce, v_gcapd.solsic, v_gcapd.sogrib, v_gcapd.unimis,
        		   v_gcapd.codcarr, v_gcapd.codrda, v_gcapd.posrda, v_gcapd.datacons, dpre.quanti,
        		   (case when dpre.unimis is null then v_gcapd.unimis else dpre.unimis end) as unimiseff,
        		   (case when dpre.quanti is null then v_gcapd.quanti else dpre.quanti end) as quantieff, 
        		   (case when v_gcapd.solsic='1' or v_gcapd.sogrib='1' then v_gcapd.prezun else dpre.preoff end) as preoff, 
        		   (case when dpre.perciva is null then v_gcapd.perciva else dpre.perciva end) as percivaeff, 
        		   (case when v_gcapd.solsic='1' or v_gcapd.sogrib='1' then round(v_gcapd.prezun*v_gcapd.quanti,5) else dpre.impoff end) as impoff,
        		   dpre.reqmin as reqmin, v_gcapd.peso, dpre.perrib, dpre.ribpeso
        	 from v_gcapd left outer join dpre
        	   on v_gcapd.cod_ditta=dpre.dittao and v_gcapd.ngara=dpre.ngara and v_gcapd.contaf=dpre.contaf;
		perform sp_restoreviews('v_gcap_dpre');

		-- (S.Santi 03.09.2019) Aggiunto campo AMMINVERSA.DITG
		perform sp_backupanddropviews('v_gare_dittefasi');
		create or replace view v_gare_dittefasi as
			with ditte as (select tab1tip num_fase,tab1desc desc_fase,codgar5 codgar,ngara5 ngara,dittao,nomimo, nprogg,numordpl,
					 (case when tab1tip = 2 then estimp else null end) sorteggio,
					 (case when tab1tip in (-4,2,5,6) then partgar else null end) partecipa,
					  fasgar fase_esclu,amminversa
					  from tab1,ditg where tab1cod='A1011'
					  and ((tab1tip <1 and (acquisizione is null or acquisizione <>5)) or (tab1tip>=1 and rtofferta is null)))
			select ditte.*,ammgar ammissione,motivescl,detmotescl
			  from gare, v_gare_genere, torn, gare1,
					 ditte, v_ditgammis 
			  where ditte.ngara=gare.ngara
				 and ditte.ngara=v_gare_genere.codice and v_gare_genere.genere not in (10,11,20,4)
				 and gare.codgar1=torn.codgar
				 and gare.ngara=gare1.ngara
				 and ditte.ngara=v_ditgammis.ngara and ditte.dittao=v_ditgammis.dittao and ditte.num_fase=v_ditgammis.fasgar
				 and ((torn.iterga=1 and num_fase>=1) or (torn.iterga in (3,5,6) and num_fase>=-3) or (torn.iterga in (2,4)))
				 and (num_fase<>3 and num_fase<>4)
				 and (
					   (
					   ((v_gare_genere.genere <>3 and (((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5) or (modlicg=6 or gare1.valtec='1') or (modlicg is null and num_fase=1)))
							 or (
							 (v_gare_genere.genere=3 and gare.bustalotti=2 and num_fase < 7 and 
							   (
							   (not exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1')) and num_fase<>5)
								or exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1'))
								)
							   ))
							   or
							   (v_gare_genere.genere=3 and gare.bustalotti=1 and num_fase < 5))
						 and v_gare_genere.genere<>300)
						or 
						(v_gare_genere.genere=300 and num_fase in (-4,2,5,6,7,8) and ((modlicg=6 or gare1.valtec='1') or ((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5)))
					 )
				 and (num_fase<=fase_esclu or fase_esclu is null or fase_esclu=0);
		perform sp_restoreviews('v_gare_dittefasi');

		 update eldaver set numver = '8.3.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.3.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.3.%') THEN

		CREATE TABLE G1CF_PUBB (
			ID NUMERIC(3) NOT NULL,
			NOME VARCHAR(250),
			NUMORD NUMERIC(3),
			CL_WHERE_VIS VARCHAR(2000),
			GRUPPO NUMERIC(3),
			INVIOSCP VARCHAR(1),
			primary key(ID));
			
		CREATE TABLE GARATTISCP (
			ID NUMERIC(12) NOT NULL,
			CODGAR VARCHAR(21),
			NGARA VARCHAR(20),
			TIPOLOGIA NUMERIC(7),
			DATPUB TIMESTAMP,
			UUID VARCHAR(40),
			primary key(ID));
		ALTER TABLE GARATTISCP ADD CONSTRAINT FK_GARATTISCP_TORN FOREIGN KEY ( CODGAR) REFERENCES TORN( CODGAR ) ON DELETE CASCADE;

		ALTER TABLE DOCUMGARA ADD TIPOLOGIA NUMERIC(7);
		ALTER TABLE DOCUMGARA ADD DATAPROV TIMESTAMP;
		ALTER TABLE DOCUMGARA ADD NUMPROV VARCHAR(20);
		
		ALTER TABLE GARECONT ADD ESECSCIG VARCHAR(1);
		
		ALTER TABLE GARE1 ADD CODCUI VARCHAR(22);
		ALTER TABLE GARE1 ADD ANNINT NUMERIC(4);
		
		update eldaver set numver = 'M1.8.4.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M1.8.4.0', datvet = now() where codapp = 'G1';
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiorna_riferimenti(codice IN Numeric, conta IN Numeric) RETURNS void AS $$
DECLARE
	v_cnt_gare Numeric(10) := 0;
    v_cnt_peri Numeric(10) := 0;
    v_cnt_schcon Numeric(10) := 0;
	v_cnt_tab2 Numeric(10);
	i Numeric(10);
	tabellato varchar(10);
BEGIN
	IF exists (select tablename from pg_tables where upper(tablename) = 'GARE') THEN
			UPDATE TORN SET TIPGAR=conta WHERE TIPGAR=codice;
			UPDATE GARE SET TIPGARG=conta WHERE TIPGARG=codice;
			UPDATE CATPUB SET TIPGAR=conta WHERE TIPGAR=codice;
			UPDATE ARCHDOCG SET TIPOPROC=conta WHERE TIPOPROC=codice;
			UPDATE CONFOPECO SET TIPOPROCEDURA=conta WHERE TIPOPROCEDURA=codice;
	END IF;
	IF exists (select tablename from pg_tables where upper(tablename) = 'PERI') THEN
			UPDATE APPA SET TIPAGG=conta WHERE TIPAGG=codice;
			UPDATE ORDI SET TIPAGG=conta WHERE TIPAGG=codice;
	END IF;
	IF exists (select tablename from pg_tables where upper(tablename) = 'SCHCON') THEN
			UPDATE SCHCON SET TIPGARG=conta WHERE TIPGARG=codice;
	END IF;
	
	-- Aggiornamento del valore dei tabellati 'A1z03' e 'A1z04' nel nuovo valore calcolato
	tabellato := 'A1z03';
	FOR i IN 1..3 LOOP
		if (i = 2) then
			tabellato := 'A1z04';
		end if;
		if (i = 3) then
			tabellato := 'A1z05';
		end if;
		--Caso in cui sia presente solo il valore 'codice' in tab2d2
		if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD=tabellato and TAB2D2 = CAST(codice as text)) then
			UPDATE TAB2 SET TAB2D2=REPLACE(TAB2D2,CAST(codice as text),CAST(conta as text)) WHERE TAB2COD=tabellato and TAB2D2 = CAST(codice as text);
		end if;
		--Caso in cui sia presente il valore ',codice,' in tab2d2
		if ((SELECT count(TAB2TIP) >0 FROM tab2 WHERE TAB2COD=tabellato and TAB2D2 like '%,' || CAST(codice as text) || ',%')) then
			UPDATE tab2 SET TAB2D2=REPLACE(TAB2D2, ',' || CAST(codice as text) || ',', ',' || CAST(conta as text) || ',') WHERE TAB2COD=tabellato and TAB2D2 like '%,' || CAST(codice as text) || ',%';
		end if;
		--Caso in cui sia presente il valore 'codice,' in tab2d2
		if ((SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD=tabellato and TAB2D2 like CAST(codice as text) || ',%') ) then
			UPDATE tab2 SET TAB2D2=CAST(conta as text) || SUBSTR(TAB2D2,3,LENGTH(TAB2D2)) WHERE TAB2COD=tabellato and TAB2D2 like CAST(codice as text) || ',%' ;
		end if;
		--Caso in cui sia presente il valore ',codice' in tab2d2
		if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD=tabellato and TAB2D2 like '%,' ||  CAST(codice as text)) then
			UPDATE tab2 SET TAB2D2=SUBSTR(TAB2D2,1, LENGTH(TAB2D2) - 2) || CAST(conta as text) WHERE TAB2COD=tabellato and TAB2D2 like '%,' || CAST(codice as text);
		end if;
	END LOOP;

END;
$$ LANGUAGE plpgsql;


-- Procedura - sposta_valori - viene rimappato (sui tabellati A2044, A1z03 e A1z04)il codice passato come parametro in nuovo valore, prendendo il primo valore massimo disponibile
--                             superiore al 100 in A2044.
CREATE OR REPLACE FUNCTION sposta_valori(codice IN Numeric) RETURNS void AS $$
DECLARE
	v_cnt_a2044_old Numeric(10) := 0;
    maxtip Numeric(10) := 0;
    conta Numeric(10) := 0;
BEGIN
	SELECT count(TAB1TIP) into v_cnt_a2044_old FROM TAB1 WHERE TAB1COD='A2044' and TAB1TIP=codice ;
    if (SELECT count(TAB1TIP)=1 FROM TAB1 WHERE TAB1COD='A2044' and TAB1TIP=codice) then
        maxtip := 0;
        SELECT MAX(TAB1TIP) INTO maxtip FROM TAB1 WHERE TAB1COD='A2044';
        conta := maxtip + 1;
        if(conta < 100) then
            conta := 100;
        end if;
        UPDATE TAB1 SET TAB1TIP=conta WHERE TAB1COD='A2044' and TAB1TIP=codice;
        PERFORM aggiorna_riferimenti(codice,conta);
	
    end if;

END;
$$ LANGUAGE plpgsql;


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	i Numeric(10);
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M1.8.4.0') THEN
		
		-- Operazioni propedeutiche per i tabellati A2044 e A1z03 e A1z04
		-- Si deve controntollare se i valori 30,80,81,82,83,84,85,86,87,88 sono già adoperati ed eventualmente
		-- vanno rimappati con valori superiori al 100 e modificare tutti i loro riferimenti col nuovo valore assegnato
		-- Verifica se l'aggiornamento è già stato eseguito
		if (select count(*)=0 from tab1 where tab1cod = 'A2044' and tab1tip=30 and tab1desc='Richiesta di Offerta') then
			PERFORM sposta_valori(30);
			FOR i IN 80..88 LOOP
				PERFORM sposta_valori(i);
			END LOOP;    

			-- Spostamento del valore 79 in 30 nel tabellato 'A2044'
			UPDATE TAB1 SET TAB1TIP=30,TAB1NORD=30 WHERE TAB1COD='A2044' and TAB1TIP=79;
			PERFORM aggiorna_riferimenti(79,30);
			
			--Inserimento dei valori 79,80,81,82,83,84,85,86,87,88 nel tabellato A2044
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 79, '29-PROCEDURA RISTRETTA SEMPLIFICATA', '1', 79);
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord,tab1arc) VALUES ('A2044', 80, '30-PROCEDURA DERIVANTE DA LEGGE REGIONALE', '1', 80,'1');
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 81, '31-AFFIDAMENTO DIRETTO PER VARIANTE SUPERIORE AL 20% DELL''IMPORTO CONTRATTUALE', '1', 81);
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 82, '32-AFFIDAMENTO RISERVATO', '1', 82);
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 83, '33-PROCEDURA NEGOZIATA PER AFFIDAMENTI SOTTO SOGLIA', '1', 83);
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 84, '34-PROCEDURA ART.16 COMMA 2-BIS DPR 380/2001 PER OPERE URBANIZ. A SCOMPUTO PRIMARIE SOTTO SOGLIA', '1', 84);
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 85, '35-PARTERNARIATO PER LINNOVAZIONE', '1', 85);
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 86, '36-AFFIDAMENTO DIRETTO PER LAVORI, SERVIZI O FORNITURE SUPPLEMENTARI', '1', 86);
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 87, '37-PROCEDURA COMPETITIVA CON NEGOZIAZIONE', '1', 87);
			INSERT INTO TAB1 (tab1cod, tab1tip, tab1desc, tab1mod, tab1nord) VALUES ('A2044', 88, '38-PROCEDURA DISCIPLINATA DA REGOLAMENTO INTERNO PER SETTORI SPECIALI', '1', 88);
			
			--Aggiornamento descrizioni A2044
			UPDATE TAB1 SET TAB1DESC='Procedura negoziata senza previa pubblicazione' WHERE TAB1COD='A2044' and TAB1TIP = 5;
			UPDATE TAB1 SET TAB1DESC='Affidamento diretto',tab1mod='1' WHERE TAB1COD='A2044' and TAB1TIP = 20;
			UPDATE TAB1 SET TAB1DESC='Interpello (art.110 DLgs 50/2016)',tab1mod='1' WHERE TAB1COD='A2044' and TAB1TIP = 21;
			UPDATE TAB1 SET TAB1DESC='Affidamento diretto a società in house',tab1mod='1' WHERE TAB1COD='A2044' and TAB1TIP = 22;
			UPDATE TAB1 SET TAB1DESC='Affidamento diretto in adesione ad accordo quadro/convenzione',tab1nord=25 WHERE TAB1COD='A2044' and TAB1TIP = 25;
			UPDATE TAB1 SET TAB1DESC='Confronto competitivo in adesione ad accordo quadro/convenzione',tab1nord=26 WHERE TAB1COD='A2044' and TAB1TIP = 26;
			UPDATE TAB1 SET TAB1DESC='Procedura negoziata con previa indizione di gara (settori speciali)',tab1nord=27,tab1arc='1' WHERE TAB1COD='A2044' and TAB1TIP = 27;
			UPDATE TAB1 SET TAB1DESC='Procedura negoziata con previa indagine di mercato',tab1nord=28 WHERE TAB1COD='A2044' and TAB1TIP = 28;
			UPDATE TAB1 SET TAB1DESC='03-PROCEDURA NEGOZIATA PREVIA PUBBLICAZIONE' WHERE TAB1COD='A2044' and TAB1TIP = 53;
			UPDATE TAB1 SET TAB1DESC='04-PROCEDURA NEGOZIATA SENZA PREVIA PUBBLICAZIONE' WHERE TAB1COD='A2044' and TAB1TIP = 54;
			UPDATE TAB1 SET TAB1DESC='06-PROCEDURA NEGOZIATA SENZA PREVIA INDIZIONE DI GARA (SETTORI SPECIALI)' WHERE TAB1COD='A2044' and TAB1TIP = 56;
			UPDATE TAB1 SET TAB1DESC='22-PROCEDURA NEGOZIATA CON PREVIA INDIZIONE DI GARA (SETTORI SPECIALI)' WHERE TAB1COD='A2044' and TAB1TIP = 72;
			UPDATE TAB1 SET TAB1DESC='23-AFFIDAMENTO DIRETTO' WHERE TAB1COD='A2044' and TAB1TIP = 73;
			UPDATE TAB1 SET TAB1DESC='25-AFFIDAMENTO DIRETTO A SOCIETA'' RAGGRUPPATE/CONSORZ. O CONTROLLATE IN CONCESSIONI E PARTENARIATI' WHERE TAB1COD='A2044' and TAB1TIP = 75;
		end if;
		
		update eldaver set numver = 'M2.8.4.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M2.8.4.0', datvet = now() where codapp = 'G1';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	DECLARE valtab2d2 VARCHAR;
	DECLARE lentab2d2 INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M2.8.4.0') THEN
		if (select count(*)=0 from tab2 where tab2cod = 'A1z05' and tab2tip='88' and tab2d1='Procedura disciplinata da regolamento interno per settori speciali') then

			--Aggiornamento A1z03
			SELECT COALESCE(TAB2D2,''), COALESCE(length(TAB2D2),0) into valtab2d2,lentab2d2 FROM TAB2 WHERE TAB2COD='A1z03' and TAB2TIP=3;
			if (lentab2d2>0) then
				valtab2d2 := valtab2d2 || ',';
			end if;
			valtab2d2 := valtab2d2 || '79,80,81,82,83,84,85,86,87,88';
			UPDATE TAB2 SET TAB2D2=valtab2d2 WHERE TAB2COD='A1z03' and TAB2TIP=3;
			
			--Aggiornamento A1z04
			SELECT COALESCE(TAB2D2,''), COALESCE(length(TAB2D2),0) into valtab2d2,lentab2d2 FROM TAB2 WHERE TAB2COD='A1z04' and TAB2TIP=2;
			if (lentab2d2>0) then
				valtab2d2 := valtab2d2 || ',';
			end if;
			valtab2d2 := valtab2d2 || '80,85,87';
			UPDATE TAB2 SET TAB2D2=valtab2d2 WHERE TAB2COD='A1z04' and TAB2TIP=2;
			
			SELECT COALESCE(TAB2D2,''), COALESCE(length(TAB2D2),0) into valtab2d2,lentab2d2 FROM TAB2 WHERE TAB2COD='A1z04' and TAB2TIP=5;
			if (lentab2d2>0) then
				valtab2d2 := valtab2d2 || ',';
			end if;
			valtab2d2 := valtab2d2 || '79,81,82,83,84,86,88';
			UPDATE TAB2 SET TAB2D2=valtab2d2 WHERE TAB2COD='A1z04' and TAB2TIP=5;
			
			--Aggiornamento A1z05
			--Sposta il valore 28 nel 54 (negoziata previa indagine in negoziata senza bando)
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 = '28') then
				UPDATE TAB2 SET TAB2D2=null WHERE TAB2COD='A1z05' and TAB2D2 = '28';
			end if;
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 like '%,28,%') then
				UPDATE tab2 SET TAB2D2=REPLACE(TAB2D2, ',28,', ',') WHERE TAB2COD='A1z05' and TAB2D2 like '%,28,%';
			end if;
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 like '28,%') then
				UPDATE tab2 SET TAB2D2=SUBSTR(TAB2D2,4,LENGTH(TAB2D2)) WHERE TAB2COD='A1z05' and TAB2D2 like '28,%' ;
			end if;
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 like '%,28') then
				 UPDATE tab2 SET TAB2D2=SUBSTR(TAB2D2,1, LENGTH(TAB2D2) - 3) WHERE TAB2COD='A1z05' and TAB2D2 like '%,28';
			end if;
			update tab2 set tab2d2=coalesce(tab2d2,'') || ',28' where tab2cod='A1z05' and tab2tip='54';
			--Toglie il valore '30', dato che viene mappato in modo fisso nel successivo insert
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 = '30') then
				UPDATE TAB2 SET TAB2D2=null WHERE TAB2COD='A1z05' and TAB2D2 = '30';
			end if;
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 like '%,30,%') then
				UPDATE tab2 SET TAB2D2=REPLACE(TAB2D2, ',30,', ',') WHERE TAB2COD='A1z05' and TAB2D2 like '%,30,%';
			end if;
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 like '30,%') then
				UPDATE tab2 SET TAB2D2=SUBSTR(TAB2D2,4,LENGTH(TAB2D2)) WHERE TAB2COD='A1z05' and TAB2D2 like '30,%' ;
			end if;
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 like '%,30') then
				 UPDATE tab2 SET TAB2D2=SUBSTR(TAB2D2,1, LENGTH(TAB2D2) - 3) WHERE TAB2COD='A1z05' and TAB2D2 like '%,30';
			end if;
			--Toglie il valore '3', dato che viene mappato in modo fisso nel successivo insert
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 = '3') then
				UPDATE TAB2 SET TAB2D2=null WHERE TAB2COD='A1z05' and TAB2D2 = '3';
			end if;
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 like '%,3,%') then
				UPDATE tab2 SET TAB2D2=REPLACE(TAB2D2, ',3,', ',') WHERE TAB2COD='A1z05' and TAB2D2 like '%,3,%';
			end if;
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 like '3,%') then
				UPDATE tab2 SET TAB2D2=SUBSTR(TAB2D2,3,LENGTH(TAB2D2)) WHERE TAB2COD='A1z05' and TAB2D2 like '3,%' ;
			end if;
			if (SELECT count(TAB2TIP)>0 FROM tab2 WHERE TAB2COD='A1z05' and TAB2D2 like '%,3') then
				 UPDATE tab2 SET TAB2D2=SUBSTR(TAB2D2,1, LENGTH(TAB2D2) - 2) WHERE TAB2COD='A1z05' and TAB2D2 like '%,3';
			end if;

			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z05','79','Procedura ristretta semplificata','3',NULL,25,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z05','80','Procedura derivante da legge regionale',NULL,NULL,NULL,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z05','81','Affidamento diretto per variante superiore al 20% dell''importo contrattuale',NULL,NULL,31,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z05','82','Affidamento riservato',NULL,NULL,32,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z05','83','Procedura negoziata per affidamenti sotto soglia','30',NULL,28,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z05','84','Procedura art.16 comma 2-bis DPR 380/2001 per opere urbaniz. a scomputo primarie sotto soglia',NULL,NULL,33,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z05','85','Partenariato per l''innovazione',NULL,NULL,34,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z05','86','Affidamento diretto per lavori, servizi o forniture supplementari',NULL,NULL,35,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z05','87','Procedura competitiva con negoziazione',NULL,NULL,29,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z05','88','Procedura disciplinata da regolamento interno per settori speciali',NULL,NULL,27,NULL);
			update tab2 set tab2d1='Procedura negoziata previa pubblicazione' where tab2cod='A1z05' and tab2tip='53';
			update tab2 set tab2d1='Procedura negoziata senza previa pubblicazione' where tab2cod='A1z05' and tab2tip='54';
			update tab2 set tab2d1='Dialogo competitivo' where tab2cod='A1z05' and tab2tip='55';
			update tab2 set tab2d1='Procedura negoziata senza previa indizione di gara (settori speciali)' where tab2cod='A1z05' and tab2tip='56';
			update tab2 set tab2d1='Procedura selettiva ex art. 238 c.7 D.Lgs.163/2006' where tab2cod='A1z05' and tab2tip='64';
			update tab2 set tab2d1='Procedura negoziata con previa indizione di gara (settori speciali)' where tab2cod='A1z05' and tab2tip='72';
			update tab2 set tab2d1='Affidamento diretto' where tab2cod='A1z05' and tab2tip='73';
			update tab2 set tab2d1='Affidamento diretto a società raggruppate/consorz. o controllate in concessioni e partenariati' where tab2cod='A1z05' and tab2tip='75';

		end if;
		update eldaver set numver = 'M3.8.4.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M3.8.4.0', datvet = now() where codapp = 'G1';
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
drop function aggiorna_riferimenti(codice IN Numeric, conta IN Numeric);
drop function sposta_valori(codice IN Numeric);


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M3.8.4.0') THEN
		
		UPDATE DOCUMGARA SET TIPOLOGIA = 80 WHERE GRUPPO = 1 AND NGARA IN (SELECT NGARA FROM GARE WHERE GENERE=10 OR GENERE=20);
		UPDATE DOCUMGARA SET TIPOLOGIA = 85 WHERE GRUPPO = 1 AND NGARA IN (SELECT NGARA FROM GARE WHERE GENERE=11);
		UPDATE DOCUMGARA SET TIPOLOGIA = 3 WHERE GRUPPO = 1 AND NGARA IN (SELECT NGARA FROM GARE WHERE (GENERE!=10 AND GENERE!=20 AND GENERE!=11) OR GENERE IS NULL);
		UPDATE DOCUMGARA SET TIPOLOGIA = 20 WHERE GRUPPO = 4;
		UPDATE DOCUMGARA SET TIPOLOGIA = 6 WHERE GRUPPO = 6;
		UPDATE DOCUMGARA SET TIPOLOGIA = 90 WHERE GRUPPO = 5;
		UPDATE DOCUMGARA SET TIPOLOGIA = 99 WHERE GRUPPO = 10;
		
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (1,'Delibera a contrarre o atto equivalente',10,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip NOT IN (''16'',''17'')))',15,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (2,'Avviso per manifestazione di interesse, indagini di mercato (art.36 comma 2b,2c.2d) e avviso contratto di sponsorizzazione (art.19)',20,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''4'',''10'',''28''))) and torn.iterga=4',1,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (3,'Bando di gara di appalto, concessione o concorso e documentazione di gara',30,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''6'',''8'',''20'',''29'',''30'',''34'')))',1,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (4,'Avviso in merito alla modifica dell''ordine di importanza dei criteri, bando di concessione (art.173)',40,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''20'',''29'',''30'',''32'',''34'')))',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (5,'Avviso costituzione del privilegio',50,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'')))',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (6,'Lettera di invito',60,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''2'',''4'',''10'',''15'',''19'',''28'',''29'',''30'',''32'',''34''))) or (gare.tipgarg = 29)',6,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (7,'Provvedimento che determina le esclusioni dalla procedura di affidamento e le ammissioni all''esito delle valutazioni dei requisiti soggettivi, economico-finanziari, e tecnico-professionali',70,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''10'',''20'',''28'',''29'',''30'',''32'',''34'')))',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (8,'Provvedimento di nomina commissione di aggiudicazione e Curricula dei componenti della stessa in caso di criterio di aggiudicazione oepv ',80,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''10'',''20'',''28'',''29'',''30'',''32'',''34'')))',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (9,'Provvedimento per eventuali esclusioni a seguito verifica offerte tecniche',90,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''10'',''20'',''28'',''29'',''30'',''32'',''34'')))',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (10,'Provvedimento per eventuali esclusioni a seguito apertura offerte economiche',100,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''10'',''20'',''28'',''29'',''30'',''32'',''34'')))',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (11,'Provvedimento per formazione Commissione per la valutazione dell''offerta anomala nel caso del criterio del prezzo più basso',110,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''10'',''20'',''28'',''29'',''30'',''32'',''34'')))',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (12,'Provvedimento per eventuale esclusione offerta anomala',120,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''10'',''20'',''28'',''29'',''30'',''32'',''34'')))',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (13,'Provvedimento di aggiudicazione non efficace con elenco verbali della commissione di gara',130,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''6'',''8'',''10'',''15'',''17'',''20'',''28'',''29'',''30'',''32'',''33'',''34'')))',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (16,'Provvedimento di revoca dell''aggiudicazione o dell''adesione',160,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (gare.tipgarg <> 29)',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (17,'Provvedimento di gara non aggiudicata o deserta',170,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''10'',''20'',''28'',''29'',''30'',''32'',''34'')))',4,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (18,'Provvedimento di aggiudicazione efficace',180,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''6'',''8'',''10'',''15'',''16'',''20'',''28'',''29'',''30'',''32'',''33'',''34'')))',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (19,'Decreto o determina di affidamento  di lavori, servizi e forniture di somma urgenza e di protezione civile (art.163)',190,'(TORN.SOMMAUR = ''1'') and (GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''15'',''16'')))',4,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (20,'Avviso di aggiudicazione o affidamento (esito di gara)',210,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip NOT IN (''31'')))',4,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (22,'Provvedimento di autorizzazione subappalto',220,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip NOT IN (''16'',''18'',''31''))) and (TORN.ACCQUA=''2'' or TORN.ACCQUA is null)',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (23,'Atto per eventuale scioglimento contratto per eccesso durata sospensione esecuzione',230,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip NOT IN (''16'',''18'',''31'')))',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (24,'Provvedimento di eventuali modifiche al contratto d''appalto',240,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip NOT IN (''18'',''31''))) and (TORN.ACCQUA=''2'' or TORN.ACCQUA is null)',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (25,'Provvedimento di eventuale recesso dal contratto',250,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (TORN.ACCQUA=''2'' or TORN.ACCQUA is null) and (gare.tipgarg <> 29)',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (26,'Provvedimento di eventuale risoluzione del contratto',260,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (TORN.ACCQUA=''2'' or TORN.ACCQUA is null) and (gare.tipgarg <> 29)',10,'1');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (80,'Bando o avviso',800,'GARE.GENERE in (10,20)',1,'2');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (85,'Avviso',850,'GARE.GENERE = 11',1,'2');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (90,'Documento per la trasparenza (elenco soggetti beneficiari)',900,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (gare.tipgarg <> 29)',5,'2');
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (99,'Altro documento',990,'1=1',10,'1');
		
		--Aggiornamento pregresso esecuzione contratto stesso cig
		update garecont set esecscig='2' where ngara in (select g.ngara from gare1 g,torn t  where g.codgar1= t.codgar and t.accqua = '1' and g.aqoper=1) and esecscig is null;
		update garecont set esecscig='2' where ngara in (select codgar from torn where accqua = '1' and aqoper=1) and esecscig is null;
		
		--Aggiornamento dei campi GARE.CUPPRG e GARE.CUPMST dei lotti delle gare ad offerta unica con i valori dei campi GARE.CUPPRG e GARE.CUPMST della gara complementare
		update gare  set cupprg = (select g1.cupprg from gare g1 where g1.genere =3 and g1.codgar1=gare.codgar1), cupmst = (select g1.cupmst from gare g1 where g1.genere =3 and g1.codgar1=gare.codgar1) 
		where gare.ngara in (select codice from v_gare_genere where genere =300 );

		--Popolamento di GARCPV dei lotti di gare ad offerta unica, con i valori delle corrispondenti occorrenze delle gare complementari
		IF ( select count(g.ngara) =0  from garcpv gc, gare g where gc.ngara=g.ngara and g.ngara!=g.codgar1 and g.codgar1 in (select g1.codgar1 from gare g1 where g.codgar1=g1.codgar1 and g1.genere=3 ))  THEN
		   insert into garcpv(ngara,numcpv,codcpv,tipcpv) select g1.ngara,numcpv,codcpv,tipcpv from garcpv gc,gare g, gare g1 where g.ngara=GC.NGARA and g.genere = 3 and g1.codgar1=g.codgar1 and g1.codgar1 != g1.ngara;
		end if;


		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1008',15,'Delibera a contrarre nel portale Appalti',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1008',16,'Prima pubblicazione Servizio Contratti Pubblici',NULL,0,NULL);
		UPDATE TAB1 set TAB1DESC='RDO in area riservata nel portale Appalti' where TAB1COD='A1008' and TAB1TIP=13;
		UPDATE TAB1 set TAB1DESC='Elenco soggetti beneficiari nel portale Appalti' where TAB1COD='A1008' and TAB1TIP=14;

        INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1064',15,'Delibera a contrarre',NULL,0,NULL);
		
		--Adeguamento tabellati Vigilanza 5.0.0
		--Uniformato dicitura per facilitare filtro parametri
		update tab6 set tab6desc='Tipo procedura' where tab6cod='G1_1' and tab6tip='A2044';
		update tab4 set tab4desc='Corrispondenza tra profilo e tipo procedura di gara' where tab4cod='G1_1' and tab4tip='A1z03';
		update tab4 set tab4desc='Corrispondenza tra iter di gara e tipo procedura di gara' where tab4cod='G1_1' and tab4tip='A1z04';
		update tab4 set tab4desc='Corrispondenza tra scelta contraente L.190/2012 e tipo procedura di gara' where tab4cod='G1_1' and tab4tip='A1z05';
		update tab4 set tab4desc='Corrispondenza tra modalità realizzazione SIMOG e tipo procedura di gara' where tab4cod='G1_1' and tab4tip='A1z06';
		
		--Tipo procedura - nuovo parametro per mappatura con Vigilanza
		IF (SELECT count(*)=0 FROM tab2 where tab2cod='A1z11') THEN
			insert into tab2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) select 'A1z11',cast(cast(tab2nord as integer) as text),tab2d1,coalesce(tab2d2,'') || case when coalesce(tab2d2,'')='' then tab2tip else ',' || tab2tip end,NULL,tab2nord,NULL from tab2 where tab2cod='A1z05' and tab2tip in ('51','52','53','54','55','56','57','58','64','67','71','72','73','74','75','76','77','78','79','81','82','83','84','85','86','87','88');
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z11','30','Procedura negoziata con previa indizione di gara (settori speciali)',NULL,NULL,30,NULL);
			update tab2 set tab2d2=coalesce(tab2d2,'') || case when coalesce(tab2d2,'')='' then '72' else ',72' end || case when coalesce((select tab2d2 from tab2 where tab2cod='A1z05' and tab2tip='72'),'')='' then '' else ',' || coalesce((select tab2d2 from tab2 where tab2cod='A1z05' and tab2tip='72'),'') end where tab2cod='A1z11' and tab2tip='30'; --negoziata previa pubblicazione settori speciali
			update tab2 set tab2d1='Procedura negoziata derivante da avvisi con cui si indice una gara', tab2d2=null where tab2cod='A1z11' and tab2tip='14';
			update tab2 set tab2d1='* '||tab2d1 where tab2cod='A1z11' and tab2tip in ('7','9','11','12','13','14','25','27');

			INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1z11','Corrispondenza tra scelta contraente SIMOG e tipo procedura di gara',NULL);
		end if;
		
		--Motivo ricorso procedura negoziata
		UPDATE TAB1 set TAB1ARC='1' where TAB1COD='A1040' and (TAB1TIP<=32 or (TAB1TIP>=100 and TAB1TIP<200));
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',33,'Procedura a seguito di precedente gara annullata o deserta o senza esito',NULL,100,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',34,'Lavori, beni e servizi infungibili per opera d''arte',NULL,101,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',35,'Lavori, beni e servizi infungibili per motivi tecnici',NULL,102,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',36,'Lavori, beni e servizi infungibili per diritti esclusivi',NULL,103,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',37,'Estrema urgenza',NULL,104,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',38,'Scopo di ricerca',NULL,105,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',39,'Consegne complementari',NULL,106,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',40,'Forniture quotate e acquistate sul mercato delle materie prime',NULL,107,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',41,'Condizioni particolarmente vantaggiose',NULL,108,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',42,'II fase concorso di progettazione e idee',NULL,109,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',43,'Ripetizione lavori o servizi analoghi',NULL,110,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1040',44,'Procedura di affidamento a contraente vincolato da disposizioni sovraordinate',NULL,111,NULL);
		UPDATE TAB1 set TAB1NORD=200 where TAB1COD='A1040' and TAB1TIP=200;

		--Modalita realizzazione
		IF (SELECT count(*)=0 FROM tab2 where tab2cod='A1z06' and tab2tip='13') THEN
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z06','13','Contratto di disponibilità',NULL,NULL,13,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z06','14','Interventi di sussidiarietà orizzontale',NULL,NULL,14,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z06','15','Contratti di parternariato sociale (baratto amministrativo)',NULL,NULL,15,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z06','16','Co-progettazione di servizi sociali',NULL,NULL,16,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z06','17','Accordo quadro',NULL,NULL,17,NULL);
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z06','18','Convenzione',NULL,NULL,18,NULL);
			update tab2 set tab2d2=coalesce(tab2d2,'') || case when coalesce((select tab2d2 from tab2 where tab2cod='A1z06' and tab2tip='7'),'')='' then '' when coalesce(tab2d2,'')='' then coalesce((select tab2d2 from tab2 where tab2cod='A1z06' and tab2tip='7'),'') else ',' || coalesce((select tab2d2 from tab2 where tab2cod='A1z06' and tab2tip='7'),'') end where tab2cod='A1z06' and tab2tip='1'; --affidamento cottimo
			update tab2 set tab2d2=coalesce(tab2d2,'') || case when coalesce((select tab2d2 from tab2 where tab2cod='A1z06' and tab2tip='9'),'')='' then '' when coalesce(tab2d2,'')='' then coalesce((select tab2d2 from tab2 where tab2cod='A1z06' and tab2tip='9'),'') else ',' || coalesce((select tab2d2 from tab2 where tab2cod='A1z06' and tab2tip='9'),'') end where tab2cod='A1z06' and tab2tip='17'; --accordo quadro
			UPDATE TAB2 SET TAB2ARC = '1',TAB2D2=null WHERE TAB2COD='A1z06' and (TAB2TIP = '7' or TAB2TIP = '9');
		end if;
		
		--Aggiorna MODREA.TORN con nuovo valore tab.A1z06
		update TORN set MODREA = 17 where MODREA = 9;
		
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('GARATTISCP',0);
		
		delete from c0campi where c0c_mne_ber in ('G1IDCFPUBB','G1NOMECFP','G1NUMORDCFP','G1WHEREVCFP','G1GRUPPOCFP','G1INVIOSCFP');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E','P','ID.G1CF_PUBB.GARE','G1IDCFPUBB','Id','Id','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NOME.G1CF_PUBB.GARE','G1NOMECFP','Descrizione tipologia del documento','Tipologia documento','A250',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NUMORD.G1CF_PUBB.GARE','G1NUMORDCFP','Numero ordine','Numero ordine','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CL_WHERE_VIS.G1CF_PUBB.GARE','G1WHEREVCFP','Condizione per la gestione della tipologia','Condizione tipologia','A2000',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'GRUPPO.G1CF_PUBB.GARE','G1GRUPPOCFP','Gruppo documentazione','Gruppo','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'INVIOSCP.G1CF_PUBB.GARE','G1INVIOSCFP','Previsto invio a SCP? ','Invio a SCP?','A2',NULL,'SN',NULL);

		delete from c0campi where c0c_mne_ber in ('G1TIPOLODG','G1NUMPROV','G1DATAPROV');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TIPOLOGIA.DOCUMGARA.GARE','G1TIPOLODG','Tipologia documento','Tipologia documento','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NUMPROV.DOCUMGARA.GARE','G1NUMPROV','Numero provvedimento','Num.provvedimento','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DATAPROV.DOCUMGARA.GARE','G1DATAPROV','Data provvedimento','Data provvedimento','A10',NULL,'DATA_ELDA',NULL);
		
		delete from c0campi where c0c_mne_ber in ('G1IDSCP','G1CODGARSCP','G1NGARASCP','G1TIPOSCP','G1DATPUBSCP','G1UUIDSCP');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','ID.GARATTISCP.GARE','G1IDSCP','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODGAR.GARATTISCP.GARE','G1CODGARSCP','Codice della gara','Codice gara','A21',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NGARA.GARATTISCP.GARE','G1NGARASCP','Numero della gara','Numero gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TIPOLOGIA.GARATTISCP.GARE','G1TIPOSCP','Tipologia atto','Tipologia atto','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DATPUB.GARATTISCP.GARE','G1DATPUBSCP','Data-ora di pubblicazione','Data pubblicazione','A19',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'UUID.GARATTISCP.GARE','G1UUIDSCP','Identificativo univoco generale (UUID)','UUID','A40',NULL,NULL,NULL);
		
		delete from c0campi where c0c_mne_ber in ('G1ESECSCIG');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'ESECSCIG.GARECONT.GARE','G1ESECSCIG','Esecuzione del contratto sullo stesso CIG?','Esec.stesso CIG?','A2',NULL,'SN','Esecuzione contratto sullo stesso CIG?');
		
		update C0CAMPI set COC_DES_WEB = 'Ricorso al prezzo fisso (OEPV senza busta economica)?' where C0C_MNE_BER = 'G1COSTOFISSO';
		update C0CAMPI set COC_DES='Tipo di documentazione richiesta ai concorrenti',COC_DES_FRM='Tipo document.rich.',COC_DES_WEB = 'Tipo documentazione' where C0C_MNE_BER = 'TIPODOCAD';
		update C0CAMPI set COC_DES='Tipo di documentazione richiesta ai concorrenti',COC_DES_FRM='Tipo document.rich.',COC_DES_WEB = 'Tipo documentazione' where C0C_MNE_BER = 'G1TIPODOC_DD';

        delete from c0campi where c0c_mne_ber in ('G1CODCUI','G1ANNINT');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'CODCUI.GARE1.GARE','G1CODCUI','Codice Unico Intervento - CUI','CUI','A22',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ANNINT.GARE1.GARE','G1ANNINT','Prima annualità ultimo programma in cui è inserito l''interv','Annualità ultimo pgm','N4',NULL,NULL,'Prima annualità dell''ultimo programma');

		DELETE FROM C0ENTIT WHERE C0E_NOM IN ('G1CF_PUBB.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('G1CF_PUBB.GARE',0,'E','CONF_DOCUM','Configurazione tipologie documenti di gara','ID.G1CF_PUBB.GARE',NULL,NULL,NULL,NULL,'g1_cfpu0');
		
		DELETE FROM C0ENTIT WHERE C0E_NOM IN ('GARATTISCP.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARATTISCP.GARE',0,'E','GARE_SCP','Atti della gara pubblicati su SCP','CODGAR.GARATTISCP.GARE',NULL,NULL,NULL,NULL,'g1_scp0');
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GENEWEB.W_INVCOM-scheda.W_INVCOM.ReinvioMailDocumentale','Funzione reinvio mail in carico al documentale',5071);
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.DATIGENOFFUNICA.RILA','Sezione "Riferimento al lavoro"',3952);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.DATIGENOFFUNICA.CPVPR','Sezione "CPV oggetto principale"',3964);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.DATIGENOFFUNICA.CPVCOMP','Sezioni dinamiche "CPV oggetto complementare (i)"',3965);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.DATIGENOFFUNICA.CUP','Sezione "Codice CUP"',3966);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.GARE-scheda.DATIGENOFFUNICA.DEL-CPVCOMP','Elimina "CPV oggetto complementare"',3991);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.GARE-scheda.DATIGENOFFUNICA.INS-CPVCOMP','Inserisci "CPV oggetto complementare"',3991);

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('PAGE','GARE.TORN-scheda.PUBBLICITA','Pagina "Pubblicazioni"',2210);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-scheda.PUBBLICITA.PUBBANDO','Sezioni dinamiche "Pubblicazioni bando"',14040);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-scheda.PUBBLICITA.PUBESITO','Sezioni dinamiche "Pubblicazioni esito"',14060);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.TORN-scheda.PUBBLICITA.SCHEDAMOD','Modifica',14070);
		UPDATE W_OGGETTI SET DESCR='Pagina "Documenti e atti"', ORD=2160 WHERE TIPO='PAGE' and OGGETTO='GARE.TORN-scheda.DOCUMGARA';

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('PAGE','GARE.TORN-OFFUNICA-scheda.PUBBLICITA','Pagina "Pubblicazioni"',4250);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-OFFUNICA-scheda.PUBBLICITA.PUBBANDO','Sezioni dinamiche "Pubblicazioni bando"',14120);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-OFFUNICA-scheda.PUBBLICITA.PUBESITO','Sezioni dinamiche "Pubblicazioni esito"',14140);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.TORN-OFFUNICA-scheda.PUBBLICITA.SCHEDAMOD','Modifica',14100);
		UPDATE W_OGGETTI SET DESCR='Pagina "Documenti e atti"', ORD=3860 WHERE TIPO='PAGE' and OGGETTO='GARE.TORN-OFFUNICA-scheda.DOCUMGARA';

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('PAGE','GARE.GARE-scheda.PUBBLICITA','Pagina "Pubblicazioni"',2720);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.PUBBLICITA.PUBBANDO','Sezioni dinamiche "Pubblicazioni bando"',14150);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.PUBBLICITA.PUBESITO','Sezioni dinamiche "Pubblicazioni esito"',14170);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.GARE-scheda.PUBBLICITA.SCHEDAMOD','Modifica',14160);
		UPDATE W_OGGETTI SET DESCR='Pagina "Documenti e atti"', ORD=2490 WHERE TIPO='PAGE' and OGGETTO='GARE.GARE-scheda.DOCUMGARA';
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.DOCUMGARA-Tipologia-scheda','Maschera documenti suddivisi per tipologia',14240);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.DOCUMGARA-Tipologia-scheda.DOCUMGARA','Sezione documenti suddivisi per tipologia',14250);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.DOCUMGARA-Tipologia-scheda.SCHEDAMOD','Modfica del dettaglio dei documenti',14260);
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.ALTRIDATI.CUI','Sezione "Programmazione"',2771);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.DATIGENOFFUNICA.CUI','Sezione "Programmazione"',3967);

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.InviaAttiSCP','Funzione di invio atti a servizio contratti pubblici',14130);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.PubblicaSuPortale','Funzione Pubblica su portale',14135);
		
		--Nascosta la sottopagina 'Requisiti concorrenti' nella pagina 'Documenti e atti'
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('SEZ','VIS','GARE.GARE-scheda.DOCUMGARA.DOCUMREQ','Visualizza',0,1,1,4276081619);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('SEZ','VIS','GARE.TORN-scheda.DOCUMGARA.DOCUMREQ','Visualizza',0,1,1,2861529350);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('SEZ','VIS','GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DOCUMREQ','Visualizza',0,1,1,4058196000);

		UPDATE W_CONFIG SET DESCRIZIONE='Tipologia protocollo SSO. Valori ammessi: 0 [default]=non prevista, 1=Shibboleth, 2=Cohesion, 3=SSOBart, 4=OpenID, 5=SPID' WHERE CODAPP='PG' AND CHIAVE='sso.protocollo';
		
		-- (C.F. 03.10.2019) nuove property per sso SPID		
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','sso.spid.ws.auth.url',NULL,'Autenticazione Single-Sign-On','URL servizio autenticazione al sistema di SSO SPID', NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','sso.spid.service.provider',NULL,'Autenticazione Single-Sign-On','Provider autenticazione al sistema di SSO SPID', NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','sso.spid.authlevel',NULL,'Autenticazione Single-Sign-On','Livello autenticazione al sistema di SSO SPID', NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','sso.spid.authlevel.url',NULL,'Autenticazione Single-Sign-On','URL livello autenticazione al sistema di SSO SPID', NULL);

		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','uploadFile.estensioniAmmesse', 'TXT;RTF;DOC;DOCX;ODT;CSV;XLS;XLSX;ODS;PDF;P7M;TSD;JPG;PNG;XML;ZIP', 'Configurazione generale', 'Indicare l''elenco delle estensioni ammesse, separate da ";",  in fase di upload file', null);

		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','integrazioneLFS.filtroUffint','1','Integrazione LFS','Filtro dei lavori sull''ufficio intestatario corrente quando attivo da configurazione l''accesso per ufficio intestatario (1 = filtro applicato, 0 = filtro non applicato)', NULL);
		UPDATE W_CONFIG SET SEZIONE='Integrazione LFS' WHERE CHIAVE ='it.eldasoft.sil.pg.pathDocumentiAssociatiPL';
		UPDATE W_CONFIG SET SEZIONE='Integrazione LFS' WHERE CHIAVE ='it.eldasoft.sil.pg.integrazione.dec';

		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','ag008.7.raggr','0','Archivio imprese','Società di professionisti: abilita la gestione del raggruppamento (0 = gestione disabilitata, 1 = gestione abilitata)',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','ag008.8.raggr','0','Archivio imprese','Società di ingegneria: abilita la gestione del raggruppamento (0 = gestione disabilitata, 1 = gestione abilitata)',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','ag008.12.raggr','0','Archivio imprese','Studio associato: abilita la gestione del raggruppamento (0 = gestione disabilitata, 1 = gestione abilitata)',null);
		
		--Nuove property per invio dati SCP
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','portaleAppalti.urlPubblica',NULL,'Portale Appalti','URL pubblica del portale Appalti (es.: https://portaleappalti.test.it/PortaleAppalti/)',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','invioScp.urlEsitiPortaleAppalti','/it/homepage.wp?actionPath=/ExtStr2/do/FrontEnd/Esiti/view.action&currentFrame=7&codice=',NULL,'Desinenza URL del Portale Appalti sezione esiti',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','invioScp.urlDeliberaPortaleAppalti','/it/ppgare_delibere_contrarre.wp',NULL,'Desinenza URL del Portale Appalti sezione delibere',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','invioScp.urlBandiPortaleAppalti','/it/homepage.wp?actionPath=/ExtStr2/do/FrontEnd/Bandi/view.action&currentFrame=7&codice=',NULL,'Desinenza URL del Portale Appalti sezione bandi',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','invioScp.urlAvvisiPortaleAppalti','/it/homepage.wp?actionPath=/ExtStr2/do/FrontEnd/Avvisi/view.action&currentFrame=7&codice=',NULL,'Desinenza URL del Portale Appalti sezione avvisi',NULL);

		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','invioScp.ws.urlLogin',NULL,'Invio dati SCP','URL del servizio di autenticazione (https://www.serviziocontrattipubblici.it/WSLogin/rest)',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','invioScp.ws.keyClient',NULL,'Invio dati SCP','Chiave (password) dell''applicazione per accesso al servizio di autenticazione (ClientKey)','1');
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','invioScp.ws.idClient',NULL,'Invio dati SCP','Identificativo dell''applicazione per accedere al servizio di autenticazione (ClientID)',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','invioScp.ws.username',NULL,'Invio dati SCP','Identificativo dell''utente per accesso al servizio di autenticazione (Username)',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','invioScp.ws.password',NULL,'Invio dati SCP','Password dell''utente per accesso al servizio di autenticazione (Password)','1');
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','invioScp.ws.url',NULL,'Invio dati SCP','URL dei servizi di pubblicazione atti e avvisi (https://www.serviziocontrattipubblici.it/WSPubblicazioni/rest)',NULL);
		
		UPDATE W_CONFIG SET CHIAVE = 'cos.sftp.pathBasePrefisso', DESCRIZIONE='Path assoluto area ftp da anteporre al path base (es.: /nfswork/homeutenti/Test-Pratiche)' WHERE CHIAVE = 'cos.sftp.pathBase';
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','cos.sftp.pathBase','/sftp/input/','Conservazione digitale','Path base area ftp (es.: /sftp/input/)',NULL);
		
		-- (S.Santi 19.09.2019) Modificato join su profiloweb per gestire il caso in cui i profili hanno prefisso del tipo '$001$' anziche' '$1$'
		perform sp_backupanddropviews('v_gare_profilo');
		create or replace view V_GARE_PROFILO as
			select v_gare_torn.codice, v_gare_torn.codgar, v_gare_torn.oggetto,v_gare_torn.codcig,torn.cenint, v_gare_torn.profiloweb, 
				v_gare_torn.genere, v_gare_torn.tipgar, v_gare_torn.isarchi,
				case when tab2.tab2d1 ='default' then 'PG_GARE' else tab2.tab2d1 end as codprofilo
			from v_gare_torn inner join torn on (v_gare_torn.codgar=torn.codgar and torn.profiloweb is null)
				INNER JOIN TAB2 ON (TAB2COD='A1z03' AND ',' || TAB2.TAB2D2 || ',' LIKE '%,' || CAST(V_GARE_TORN.TIPGAR AS VARCHAR(4)) || ',%' AND TAB2D1 not like '$%')
			union
			select v_gare_torn.codice, v_gare_torn.codgar, v_gare_torn.oggetto,v_gare_torn.codcig,torn.cenint, v_gare_torn.profiloweb, 
				v_gare_torn.genere, v_gare_torn.tipgar, v_gare_torn.isarchi,
				tab2.tab2d1 as codprofilo
			from v_gare_torn inner join torn on (v_gare_torn.codgar=torn.codgar and torn.profiloweb is not null)
				  INNER JOIN TAB2 ON TAB2COD='A1z03' and tab2d1 like '$%' AND torn.profiloweb = to_number(substring(substring(tab2d1,2,100),1,position('$' in substring(tab2d1,2,100))-1),'99999');
		perform sp_restoreviews('v_gare_profilo');
		
		-- (S.Santi 16.10.2019) Inserito filtro per impedire le adesioni su accordi quadro unico operatore con esecuzione contratto sullo stesso CIG		
		perform sp_backupanddropviews('v_gare_accordiquadro');
		create or replace view v_gare_accordiquadro (ngara,tipgen,tipgarg,not_gar,codcig,cenint,datainizio,datafine,aqoper,aqdurata,aqtempo,isarchi) as
            select g.ngara,tipgen,tipgarg, not_gar, codcig, torn.cenint,daatto as datainizio,
				case when aqdurata is null then null
					when aqtempo = 1 then daatto + INTERVAL '1 day' * coalesce (AQDURATA * 30,0)
					when aqtempo = 2 then daatto + INTERVAL '1 day' * coalesce (AQDURATA * 365,0)
				else null end as datafine,
						g1.aqoper, aqdurata, aqtempo,isarchi
			from gare g inner join torn on (g.codgar1=codgar)
				inner join gare1 g1 on (g1.ngara=g.ngara)
				left outer join garecont gc on ((gc.codimp=g.ditta or gc.codimp is null) and ((gc.ngara=g.ngara and gc.ncont=1)
				or (gc.ngara=g.codgar1 and (gc.ngaral is null or gc.ngaral=g.ngara))))
			where accqua='1' and daatto is not null and aqdurata is not null and aqtempo is not null
			and (gc.esecscig is null or gc.esecscig<>'1');
		perform sp_restoreviews('v_gare_accordiquadro');
		
		-- (S.Santi 16.10.2019) Nel caso di accordo quadro unico operatore con esecuzione contratto sullo stesso CIG 
		--   considera importo liquidato nell'appalto, se esistente, anzichè quello nella gara
		perform sp_backupanddropviews('v_dati_lotti_completa');
		IF exists (select tablename from pg_tables where upper(tablename) = 'APPA') THEN
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20))) and gare.preced is null
		   union
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
		   union
			 select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				null altrisog,
				null accqua,
				null aqoper,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff,
				tecni.cftec codfisresp,
				tecni.nomtec nomeresp
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where gare.genere=4';
		else
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20))) and gare.preced is null
		  union
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   not_gar oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1)
		   union
			select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
				gare.not_gar oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				null altrisog,
				null accqua,
				null aqoper,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff,
				tecni.cftec codfisresp,
				tecni.nomtec nomeresp
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where gare.genere=4';
		end if;
		perform sp_restoreviews('v_dati_lotti_completa');
		
		update eldaver set numver = '8.4.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.4.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.4.%') THEN
                
		ALTER TABLE GARE1 ADD SOGLIACALC NUMERIC(7);
		
		ALTER TABLE G1CF_PUBB ADD CL_WHERE_ULT VARCHAR(2000);

		update eldaver set numver = '8.5.0M1', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.5.0M1', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = '8.5.0M1') THEN

		--Aggiorna il campo Tipologia sulle gare a lotti
		UPDATE DOCUMGARA SET TIPOLOGIA = 3 WHERE GRUPPO = 1 AND CODGAR IN (SELECT CODGAR1 FROM GARE WHERE (GENERE!=10 AND GENERE!=20 AND GENERE!=11) OR GENERE IS NULL) and TIPOLOGIA is null;
		UPDATE DOCUMGARA SET TIPOLOGIA = 2 WHERE GRUPPO = 1 AND TIPOLOGIA = 3 AND CODGAR IN (SELECT CODGAR FROM TORN,GARE WHERE CODGAR=CODGAR1 and ITERGA=4 and exists(select * from tab2 where tab2cod='A1z11' and (','||tab2d2||',' like '%,'||cast(gare.tipgarg as text)||',%' or ','||tab2d2||',' like '%,'||cast(torn.tipgar as text)||',%') and (tab2tip IN ('4','10','25','28'))));

		update gare1 set sogliacalc=1 where ngara in (select ngara from gare where calcsoang ='1' and modlicg!=6 and media is not null and media <> 0) and sogliacalc is null;

		--Nuova tipologia di atto
		Insert into G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) values (14,'Provvedimento di adesione',140,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''18'',''19'')))',10,'1');

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1160',1,'1   arrotondamento(1) troncamento(2)',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1161',1,'arrotondamento',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1161',2,'troncamento',NULL,0,NULL);
        INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1160','Calcolo aggiudicazione: arrotondamento o troncamento nel calcolo soglia di anomalia',NULL);

		UPDATE TAB1 SET TAB1DESC='5548000 Euro - Soglia gare per Lavori' WHERE TAB1COD='A1116' AND TAB1TIP=2;
        UPDATE TAB1 SET TAB1DESC='221000 Euro - Soglia gare per Forniture e Servizi' WHERE TAB1COD='A1116' AND TAB1TIP=3;
		UPDATE TAB1 SET TAB1DESC='30/09/2019 - Data inizio applicazione' WHERE TAB1COD='A1116' AND TAB1TIP=4;
        UPDATE TAB1 SET TAB1DESC='31/12/2099 - Data fine applicazione' WHERE TAB1COD='A1116' AND TAB1TIP=5;
		INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1116','Calcolo aggiudicazione: criterio calcolo soglia anomalia L.R.Sicilia 13/2019',NULL);

		UPDATE TAB1 SET TAB1DESC='Pubblicazione per la trasparenza nel portale Appalti' WHERE TAB1COD='A1008' AND TAB1TIP=14;
		UPDATE TAB1 SET TAB1DESC='17-AFFIDAMENTO DIRETTO EX ART. 5 DELLA LEGGE 381/91' WHERE TAB1COD='A2044' AND TAB1TIP=67;
		UPDATE TAB1 SET TAB1DESC='25-AFFIDAMENTO DIRETTO A SOCIETA'' RAGGRUPPATE/CONSORZIATE O CONTROLLATE NELLE CONCESSIONI E NEI PARTENARIATI' WHERE TAB1COD='A2044' AND TAB1TIP=75;
		UPDATE TAB1 SET TAB1DESC='34-PROCEDURA ART.16 COMMA 2-BIS DPR 380/2001 PER OPERE URBANIZZAZIONE A SCOMPUTO PRIMARIE SOTTO SOGLIA COMUNITARIA' WHERE TAB1COD='A2044' AND TAB1TIP=84;
		UPDATE TAB1 SET TAB1DESC='35-PARTERNARIATO PER L''INNOVAZIONE' WHERE TAB1COD='A2044' AND TAB1TIP=85;
		
        delete from c0campi where c0c_mne_ber in ('G1SOGLIACALC');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'SOGLIACALC.GARE1.GARE','G1SOGLIACALC','Applicato arrotondam.(1) o troncamento(2) nel calc.soglia','Arrot.o tronc.soglia','A100','A1161',NULL,'Applicato arrotondamento o troncamento?');

        delete from c0campi where c0c_mne_ber in ('G1WHEREUCFP');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CL_WHERE_ULT.G1CF_PUBB.GARE','G1WHEREUCFP','Ulteriore condizione per la gestione della tipologia','Ulteriore condiz.tip','A2000',NULL,NULL,NULL);

		UPDATE C0CAMPI SET COC_DES='Applica calcolo soglia anomalia L.R.Sicilia 13/2019?', COC_DES_WEB='Applica calcolo L.R.Sicilia 13/2019?' WHERE  C0C_MNE_BER='G1LEGREGSIC';
        UPDATE C0CAMPI SET COC_MNE_UNI='NGARA.ISCRIZUFF.GARE' WHERE  C0C_MNE_BER='G1NGARAIU';

		UPDATE C0ENTIT set C0E_KEY='CODIMP.V_CATE_ELENCHI.GARE',COE_KEY_EX='CODIMP.IMPR.GENE' where C0E_NOM='V_CATE_ELENCHI.GARE';
		UPDATE C0ENTIT set C0E_KEY='IDANTICORLOTTI.ANTICORPARTECIP.GARE' where C0E_NOM='ANTICORPARTECIP.GARE';

		--Pulizia voci di profilo
		--Sezione CUP, CPV della pagina altri dati di una gara ad offerta unica e della sezione 'Pubblicazione su SCP' per tutti i tipi dia gara 
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.ALTRIDATI.CUP' AND TIPO='SEZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.ALTRIDATI.CPVPR' AND TIPO='SEZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.ALTRIDATI.CPVCOMP' AND TIPO='SEZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.ALTRIDATI.DEL-CPVCOMP' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.ALTRIDATI.INS-CPVCOMP' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.ALTRIDATI.SCP' AND TIPO='SEZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-scheda.ALTRIDATI.SCP' AND TIPO='SEZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.GARE-scheda.ALTRIDATI.SCP' AND TIPO='SEZ';
		
		--Pubblicazioni bando ed esito
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.GARE-scheda.PUBBANDO' AND TIPO='PAGE';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-scheda.PUBBANDO' AND TIPO='PAGE';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.PUBBANDO' AND TIPO='PAGE';
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.GARE-scheda.PUBBANDO.PubblicaSuPortale' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.TORN-scheda.PUBBANDO.PubblicaSuPortale' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.TORN-OFFUNICA-scheda.PUBBANDO.PubblicaSuPortale' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.GARE-scheda.PUBBANDO.PUBBANDO' AND TIPO='SEZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.PUBBANDO.PUBBANDO' AND TIPO='SEZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-scheda.PUBBANDO.PUBBANDO' AND TIPO='SEZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-scheda.PUBBANDO.SCHEDAMOD' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.GARE-scheda.PUBBANDO.SCHEDAMOD' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.PUBBANDO.SCHEDAMOD' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.GARE-scheda.PUBBANDO.InsertPredefiniti' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.TORN-scheda.PUBBANDO.InsertPredefiniti' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.TORN-OFFUNICA-scheda.PUBBANDO.InsertPredefiniti' AND TIPO='FUNZ';

		UPDATE W_OGGETTI SET OGGETTO='INS.GARE.GARE-scheda.PUBBLICITA.INS-PUBBANDO' WHERE OGGETTO='INS.GARE.GARE-scheda.PUBBANDO.INS-PUBBANDO' AND TIPO='FUNZ';
		UPDATE W_OGGETTI SET OGGETTO='DEL.GARE.GARE-scheda.PUBBLICITA.DEL-PUBBANDO' WHERE OGGETTO='DEL.GARE.GARE-scheda.PUBBANDO.DEL-PUBBANDO' AND TIPO='FUNZ';
		UPDATE W_OGGETTI SET OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.PUBBLICITA.INS-PUBBANDO' WHERE OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.PUBBANDO.INS-PUBBANDO' AND TIPO='FUNZ';
		UPDATE W_OGGETTI SET OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.PUBBLICITA.DEL-PUBBANDO' WHERE OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.PUBBANDO.DEL-PUBBANDO' AND TIPO='FUNZ';
		UPDATE W_OGGETTI SET OGGETTO='INS.GARE.TORN-scheda.PUBBLICITA.INS-PUBBANDO' WHERE OGGETTO='INS.GARE.TORN-scheda.PUBBANDO.INS-PUBBANDO' AND TIPO='FUNZ';
		UPDATE W_OGGETTI SET OGGETTO='DEL.GARE.TORN-scheda.PUBBLICITA.DEL-PUBBANDO' WHERE OGGETTO='DEL.GARE.TORN-scheda.PUBBANDO.DEL-PUBBANDO' AND TIPO='FUNZ';

		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.GARE-scheda.PUBESITO' AND TIPO='PAGE';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.PUBESITO' AND TIPO='PAGE';
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.GARE-scheda.PUBESITO.PubblicaSuPortale' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.TORN-OFFUNICA-scheda.PUBESITO.PubblicaSuPortale' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.GARE-scheda.PUBESITO.PUBESITO' AND TIPO='SEZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.PUBESITO.PUBESITO' AND TIPO='SEZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.GARE-scheda.PUBESITO.SCHEDAMOD' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.PUBESITO.SCHEDAMOD' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.TORN-OFFUNICA-scheda.PUBESITO.InsertPredefiniti' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.GARE-scheda.PUBESITO.InsertPredefiniti' AND TIPO='FUNZ';

		UPDATE W_OGGETTI SET OGGETTO='INS.GARE.GARE-scheda.PUBBLICITA.INS-PUBESITO' WHERE OGGETTO='INS.GARE.GARE-scheda.PUBESITO.INS-PUBESITO' AND TIPO='FUNZ';
		UPDATE W_OGGETTI SET OGGETTO='DEL.GARE.GARE-scheda.PUBBLICITA.DEL-PUBESITO' WHERE OGGETTO='DEL.GARE.GARE-scheda.PUBESITO.DEL-PUBESITO' AND TIPO='FUNZ';
		UPDATE W_OGGETTI SET OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.PUBBLICITA.INS-PUBESITO',DESCR='Nuova pubblicazione esito' WHERE OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.PUBESITO.INS-PUBESITO' AND TIPO='FUNZ';
		UPDATE W_OGGETTI SET OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.PUBBLICITA.DEL-PUBESITO',DESCR='Elimina pubblicazione esito' WHERE OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.PUBESITO.DEL-PUBESITO' AND TIPO='FUNZ';
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.TORN-scheda.PUBBLICITA.INS-PUBESITO','Nuova pubblicazione esito',14140);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.TORN-scheda.PUBBLICITA.DEL-PUBESITO','Elimina pubblicazione esito',14150);

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.PUBBLICITA.InsertPredefiniti','Funzione Inserisci pubblicazioni predefinite',14160);

        --Documentazione gara
		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-DOCUMGARA' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-DOCUMCONC' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-DOCUMREQ' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-DOCUMINVITI' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-ATTI' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-DOCUMESITO' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-DOCUMTRASP' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-DOCUMGARA' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-DOCUMCONC' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-DOCUMREQ' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-DOCUMINVITI' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-ATTI' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-DOCUMESITO' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-DOCUMTRASP' AND TIPO='FUNZ';

        DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-scheda.DOCUMGARA.INS-DOCUMGARA' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-scheda.DOCUMGARA.INS-DOCUMCONC' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-scheda.DOCUMGARA.INS-DOCUMREQ' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-scheda.DOCUMGARA.INS-ATTI' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-scheda.DOCUMGARA.DEL-DOCUMGARA' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-scheda.DOCUMGARA.DEL-DOCUMCONC' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-scheda.DOCUMGARA.DEL-DOCUMREQ' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-scheda.DOCUMGARA.DEL-ATTI' AND TIPO='FUNZ';

		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.INS-DOCUMGARA' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.INS-DOCUMCONC' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.INS-DOCUMREQ' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.INS-DOCUMESITO' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.INS-ATTI' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.INS-DOCUMINVITI' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.INS-DOCUMTRASP' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DEL-DOCUMGARA' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DEL-DOCUMCONC' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DEL-DOCUMREQ' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DEL-DOCUMESITO' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DEL-ATTI' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DEL-DOCUMINVITI' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DEL-DOCUMTRASP' AND TIPO='FUNZ';
        
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMTRASP' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMTRASP' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMESITO' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMESITO' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-ATTI' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-ATTI' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-scheda.DOCUMGARA.MOD-ATTI' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMINVITI' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMINVITI' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMGARA' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMGARA' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-scheda.DOCUMGARA.MOD-DOCUMGARA' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMREQ' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMREQ' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-scheda.DOCUMGARA.MOD-DOCUMREQ' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-scheda.DOCUMGARA.MOD-DOCUMCONC' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMCONC' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.MOD-DOCUMCONC' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.SCHEDAMOD' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-scheda.DOCUMGARA.SCHEDAMOD' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.SCHEDAMOD' AND TIPO='FUNZ';

        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.DOCUMGARA-Tipologia-scheda.DOCUMGARA' AND TIPO='SEZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.GARE-scheda.DOCUMGARA.InsertPredefiniti' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.TORN-OFFUNICA-scheda.DOCUMGARA.InsertPredefiniti' AND TIPO='FUNZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.IntegrazioneDocumenti' AND TIPO='FUNZ';
		
        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-scheda.DOCUMGARA.DOCUMTRASP' AND TIPO='SEZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-scheda.DOCUMGARA.DOCUMINVITI' AND TIPO='SEZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-scheda.DOCUMGARA.DOCUMESITO' AND TIPO='SEZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-scheda.DOCUMGARA.ATTI' AND TIPO='SEZ';

        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DOCUMESITO' AND TIPO='SEZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DOCUMTRASP' AND TIPO='SEZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DOCUMINVITI' AND TIPO='SEZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.TORN-OFFUNICA-scheda.DOCUMGARA.ATTI' AND TIPO='SEZ';

        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.GARE-scheda.DOCUMGARA.DOCUMESITO' AND TIPO='SEZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.GARE-scheda.DOCUMGARA.DOCUMTRASP' AND TIPO='SEZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.GARE-scheda.DOCUMGARA.DOCUMINVITI' AND TIPO='SEZ';
        DELETE FROM W_OGGETTI WHERE OGGETTO='GARE.GARE-scheda.DOCUMGARA.ATTI' AND TIPO='SEZ';

        UPDATE W_OGGETTI SET  DESCR='Sezioni dinamiche "Documenti e atti"' WHERE (OGGETTO ='GARE.GARE-scheda.DOCUMGARA.DOCUMGARA' OR OGGETTO ='GARE.TORN-scheda.DOCUMGARA.DOCUMGARA' OR OGGETTO ='GARE.TORN-OFFUNICA-scheda.DOCUMGARA.DOCUMGARA') AND TIPO='SEZ';

        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.InsertPredefiniti','Funzione Inserisci documenti predefiniti',5470);

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.ImpostaFiltroLotti','Funzione Imposta filtro lotti di gara',14137);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.IMPRDOCG-lista.EsportaDocumentiBusta','Funzione Esporta documenti presentati dalla ditta in un file zip',5705);
		
        DELETE FROM W_AZIONI WHERE TIPO='COLS' and OGGETTO='GARE.TORN.UFFDET';

		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','archivioImprese.registraSuPortale','1','Archivio imprese','Abilita funzione di registrazione su portale Appalti (0=funzione non disponibile, 1=funzione disponibile)',null);
				
		update eldaver set numver = '8.5.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.5.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.5.%') THEN
                
		ALTER TABLE GARECONT ADD RAGCONS VARCHAR(2000);
		ALTER TABLE GARECONT ADD VARCONS VARCHAR(2000);

		-------------------------------------------------
		-- (20.02.2020) View per sezione 'Consulenti e collaboratori' su portale 
		-- Da personalizzare presso il cliente per gestire eventuali dati pregressi
		-------------------------------------------------
		create or replace view v_consulenti_custom as
			select
				cast(null as text) codgar,
				cast(null as text) ngara,
				cast(null as text) codice,
				cast(null as text) codicesoggetto,
				cast(null as text) soggettopercettore,
				cast(null as text) protocollo,
				cast(null as timestamp) as data,
				cast(null as text) ragioneincarico,
				cast(null as text) oggprest,
				cast(null as numeric(24,5)) compensoprevisto,
				cast(null as text) partevariabile,
				cast(null as timestamp) inizio,
				cast(null as timestamp)fine,
				cast(null as text) procedura,
				cast(null as INT) numpart
			from gare
			where 1=0;

		update eldaver set numver = 'M18.6.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M18.6.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	maxtip INT;
	conta INT;
	maxcat INT;
	v_codtab INT;
	maxtab INT;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M18.6.0') THEN

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1162',1,'1   attiva controllo(1) disattiva controllo(0)',NULL,0,NULL);
		INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1162','Lista lavorazioni: controllo univocità codice lavorazione',NULL);

		-- Modifica soglie comunitarie
		IF (select count(*) = 0 from tab1 where tab1cod='A1125' and tab1tip=1 and tab1desc='5350000 Euro - Gare per Lavori') THEN
			update tab1 set tab1desc='5350000 Euro - Gare per Lavori' where tab1cod='A1125' and tab1tip=1;
			update tab1 set tab1desc='214000 Euro - Gare per Forniture e Servizi' where tab1cod='A1125' and tab1tip=2;
			update tab1 set tab1desc='5350000 Euro - Gare per Lavori' where tab1cod='A1154' and tab1tip=1;
			update tab1 set tab1desc='428000 Euro - Gare per Forniture e Servizi' where tab1cod='A1154' and tab1tip=2;
			UPDATE TAB1 SET TAB1DESC='5350000 Euro - Soglia gare per Lavori' WHERE TAB1COD='A1116' AND TAB1TIP=2;
			UPDATE TAB1 SET TAB1DESC='214000 Euro - Soglia gare per Forniture e Servizi' WHERE TAB1COD='A1116' AND TAB1TIP=3;
			update catpub set liminf=5350000 where liminf=5548000;
			update catpub set limsup=5350000 where limsup=5548000;
			update catpub set liminf=214000 where liminf=221000;
			update catpub set limsup=214000 where limsup=221000;
			update catpub set liminf=428000 where liminf=443000;
			update catpub set limsup=428000 where limsup=443000;
			update catsca set liminf=5350000 where liminf=5548000;
			update catsca set limsup=5350000 where limsup=5548000;
			update catsca set liminf=214000 where liminf=221000;
			update catsca set limsup=214000 where limsup=221000;
			update catsca set liminf=428000 where liminf=443000;
			update catsca set limsup=428000 where limsup=443000;
			update confopeco set daimporto=214000 where daimporto=221000;
			update confopeco set aimporto=214000 where aimporto=221000;
			update confopeco set daimporto=428000 where daimporto=443000;
			update confopeco set aimporto=428000 where aimporto=443000;
		END IF;
		
		--Corretto descrizione
		update tab2 set tab2d1='Contratto d''appalto discendente da accordo quadro/convenzione con successivo confronto compet.' where tab2cod='A1z06' and tab2tip=2;

		--Nuovo profilo semplificato 'Selezione operatori da elenco'
		if (select count(*) = 0 from tab2 where tab2cod = 'A1z03' and tab2tip=6 and tab2d1='PG_GARE_ROTAZIONE') then
			if ((SELECT count(TAB2TIP) FROM TAB2 WHERE TAB2COD='A1z03' and TAB2TIP=6 and TAB2D1<>'PG_GARE_ROTAZIONE') = 1) then
				maxtip := 0;
				SELECT MAX(to_number(TAB2TIP,'999999')) INTO maxtip FROM TAB2 WHERE TAB2COD='A1z03';
				conta := maxtip + 1;
				UPDATE TAB2 SET TAB2TIP=conta WHERE TAB2COD='A1z03' and TAB2TIP=6;
			end if;
			INSERT INTO TAB2 (TAB2COD,TAB2TIP,TAB2D1,TAB2D2,TAB2MOD,TAB2NORD,TAB2ARC) VALUES ('A1z03','6','PG_GARE_ROTAZIONE','20',NULL,0,NULL);
		end if;
		
		IF (select count(*) = 0 from g1cf_pubb where id = 91) THEN
			INSERT INTO G1CF_PUBB (ID,NOME,NUMORD,CL_WHERE_VIS,GRUPPO,INVIOSCP) VALUES (91,'Documento per la trasparenza: consulenti e collaboratori',910,'(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (gare.tipgarg is null or gare.tipgarg <> 29)',5,'2');
		END IF;
		Update G1CF_PUBB set NOME='Documento per la trasparenza: elenco soggetti beneficiari',CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (gare.tipgarg is null or gare.tipgarg <> 29)' where id=90;
		Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (gare.tipgarg is null or gare.tipgarg <> 29)' where id=16;
		Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (TORN.ACCQUA=''2'' or TORN.ACCQUA is null) and (gare.tipgarg is null or gare.tipgarg <> 29)' where id=25;
		Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (TORN.ACCQUA=''2'' or TORN.ACCQUA is null) and (gare.tipgarg is null or gare.tipgarg <> 29)' where id=26;

		--Rimosso valore 27 da tabellato di mappatura tipo procedura SIMOG
		update tab2 set tab2d2=coalesce(tab2d2,'') || case when coalesce((select tab2d2 from tab2 where tab2cod='A1z11' and tab2tip='27'),'')='' then '' else ',' || coalesce((select tab2d2 from tab2 where tab2cod='A1z11' and tab2tip='27'),'') end where tab2cod='A1z11' and tab2tip='10'; --negoziata senza pubblicazione settori speciali
		delete from tab2 where tab2cod='A1z11' and tab2tip='27';
		update tab2 set tab2d1='Procedura negoziata senza previa indizione di gara (settori speciali)' where tab2cod='A1z11' and tab2tip='10';
		update tab2 set tab2d1='* Affidamento diretto per lavori, servizi o forniture supplementari' where tab2cod='A1z11' and tab2tip='35';

		--Aggiunge pubblicazioni predefinite
		if (select count(*) = 0 from catpub where tipcla=2 and tiplav=2 and liminf is null and limsup=214000) then
			SELECT MAX(CODTAB) into maxcat FROM CATPUB;
			maxcat := maxcat + 1;
			INSERT INTO CATPUB (CODTAB,TIPCLA,TIPLAV,TIPGAR,LIMINF,LIMSUP) VALUES (maxcat,2,2,0,NULL,214000);
			INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (maxcat,1,4);
			INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (maxcat,2,2);
			INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (maxcat,3,8);
			INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (maxcat,4,9);
			INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (maxcat,5,10);
		end if;
		if (select count(*) = 0 from catpub where tipcla=2 and tiplav=3 and liminf is null and limsup=214000) then
			SELECT MAX(CODTAB) into maxcat FROM CATPUB;
			maxcat := maxcat + 1;
			INSERT INTO CATPUB (CODTAB,TIPCLA,TIPLAV,TIPGAR,LIMINF,LIMSUP) VALUES (maxcat,2,3,0,NULL,214000);
			INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (maxcat,1,4);
			INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (maxcat,2,2);
			INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (maxcat,3,8);
			INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (maxcat,4,9);
			INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (maxcat,5,10);
		end if;
		if (select count(*) = 1 from catpub where tipcla=1 and tiplav=1 and liminf is null and limsup=500000) then
			select CODTAB into v_codtab from catpub where tipcla=1 and tiplav=1 and liminf is null and limsup=500000;
			if (select count(*) = 0 from tabpub where codtab=v_codtab and tippub in (8,9,10)) then
				SELECT MAX(CODPUB) into maxtab FROM TABPUB where CODTAB=v_codtab;
				maxtab := maxtab + 1;
				INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (v_codtab,maxtab,8);
				maxtab := maxtab + 1;
				INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (v_codtab,maxtab,9);
				maxtab := maxtab + 1;
				INSERT INTO TABPUB (CODTAB,CODPUB,TIPPUB) VALUES (v_codtab,maxtab,10);
			end if;
		end if;

        delete from c0campi where c0c_mne_ber in ('G1RAGCONS','G1VARCONS');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'RAGCONS.GARECONT.GARE','G1RAGCONS','Ragione incarico consulente o collaboratore','Ragione incar.cons.','A2000',NULL,'NOTE','Ragione incarico consulente o collaboratore');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'VARCONS.GARECONT.GARE','G1VARCONS','Parte variabile compenso consulente o collaboratore','Parte variabile cons','A2000',NULL,'NOTE','Parte variabile compenso consulente o collaboratore');

		UPDATE C0CAMPI SET COC_DES='Oneri della sicurezza aziendale (art.95 c.10 DLgs.50/2016)', COC_DES_FRM='Oneri sicur.aziend.', COC_DES_WEB='Oneri sicurezza aziendale' WHERE  C0C_MNE_BER='G1IMPSICAZI';

		--Property integrazione WSDM delay mail in carico al documentale
		insert into w_config (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','wsdm.invioMailPec.delay',NULL,NULL,NULL,NULL);
		--Property integrazione SITAT Piani Triennali
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','integrazionePT.url',NULL,'Integrazione Piani Triennali','URL servizio per consultazione interventi Piani Triennali (es. http://localhost:8080/Vigilanza/rest/IntegrazioneLFS)',NULL);
		--Property gestione gateway integrazione verifica ditte art.80
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','art80.ws.url.gateway',0,'Verifica ditte art.80 DLgs.50/2016','L''indirizzo indicato (URL) utilizza un "gateway" ? (0 - no, 1 - si)',null);
		--Dismessa e nascosta property url portale per Invio a Vigilanza
		update w_config set sezione=null,descrizione='(NON USATA) ' || descrizione where codapp='PG' and chiave='vigilanza.ws.urlPortaleAlice' and sezione is not null;
		
		--Eliminazioni voci non più utilizzate
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.GAREAVVISI-scheda.PUBBLI.PubblicaSuPortale' AND TIPO='FUNZ';
		DELETE FROM W_OGGETTI WHERE OGGETTO='ALT.GARE.TORN-scheda.DATIGEN.PubblicaSuPortale' AND TIPO='FUNZ';

		--Reintrodotta e adeguata la gestione del controllo da profilo di modifica,eliminazione e inserimento delle singole sezioni dei documenti di gara
		UPDATE W_OGGETTI SET DESCR='Dettaglio documenti e atti',ORD='3170' WHERE TIPO='MASC' AND OGGETTO='GARE.DOCUMGARA-Tipologia-scheda';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='MOD.GARE.DOCUMGARA-Tipologia-scheda.SCHEDAMOD';

		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='DEL.GARE.GARE-scheda.FASIRICEZIONE.DEL-ATTI';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='DEL.GARE.GARE-scheda.FASIRICEZIONE.DEL-DOCUMCONC';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='DEL.GARE.GARE-scheda.FASIRICEZIONE.DEL-DOCUMINVITI';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.FASIRICEZIONE.DEL-DOCUMCONC';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='DEL.GARE.TORN-OFFUNICA-scheda.FASIRICEZIONE.DEL-DOCUMINVITI';

		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='INS.GARE.GARE-scheda.FASIRICEZIONE.INS-ATTI';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='INS.GARE.GARE-scheda.FASIRICEZIONE.INS-DOCUMCONC';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='INS.GARE.GARE-scheda.FASIRICEZIONE.INS-DOCUMINVITI';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.FASIRICEZIONE.INS-ATTI';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.FASIRICEZIONE.INS-DOCUMCONC';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='INS.GARE.TORN-OFFUNICA-scheda.FASIRICEZIONE.INS-DOCUMINVITI';
		
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='MOD.GARE.GARE-scheda.FASIRICEZIONE.MOD-ATTI';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='MOD.GARE.GARE-scheda.FASIRICEZIONE.MOD-DOCUMCONC';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='MOD.GARE.GARE-scheda.FASIRICEZIONE.MOD-DOCUMINVITI';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.FASIRICEZIONE.MOD-ATTI';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.FASIRICEZIONE.MOD-DOCUMCONC';
		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='MOD.GARE.TORN-OFFUNICA-scheda.FASIRICEZIONE.MOD-DOCUMINVITI';

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.DOCUMGARA-Tipologia-scheda.MOD-DOCUMGARA', 'Modifica sezione documenti e atti (bando)', 5386);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.DOCUMGARA-Tipologia-scheda.MOD-DOCUMCONC', 'Modifica sezione documenti richiesti ai concorrenti', 5476);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.DOCUMGARA-Tipologia-scheda.MOD-DOCUMINVITI', 'Modifica sezione documenti e atti (invito)', 11320);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.DOCUMGARA-Tipologia-scheda.MOD-ATTI', 'Modifica sezione documenti e atti (atti)', 11324);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.DOCUMGARA-Tipologia-scheda.MOD-DOCUMESITO', 'Modifica sezione documenti e atti (esito)', 11322);

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.DOCUMGARA-Tipologia-scheda.INS-DOCUMGARA','Inserisci documento o atto (bando)',5390);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.DOCUMGARA-Tipologia-scheda.INS-DOCUMCONC','Inserisci documento richiesto ai concorrenti',5480);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.DOCUMGARA-Tipologia-scheda.INS-DOCUMINVITI','Inserisci documento o atto (invito)',11320);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.DOCUMGARA-Tipologia-scheda.INS-ATTI','Inserisci documento o atto (atto)',11321);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.DOCUMGARA-Tipologia-scheda.INS-DOCUMESITO','Inserisci documento o atto (esito)',5486);

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.DOCUMGARA-Tipologia-scheda.DEL-DOCUMGARA','Elimina documento o atto (bando)',5385);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.DOCUMGARA-Tipologia-scheda.DEL-DOCUMCONC','Elimina  documento richiesto ai concorrenti',5475);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.DOCUMGARA-Tipologia-scheda.DEL-DOCUMINVITI','Elimina documento o atto (invito)',11330);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.DOCUMGARA-Tipologia-scheda.DEL-ATTI','Elimina documento o atto (atto)',11331);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.DOCUMGARA-Tipologia-scheda.DEL-DOCUMESITO','Elimina documento o atto (esito)',5484);

		--Controllo della funzione Funzione Esporta documenti presentati dalla ditta in un file zip specifico per la fase amministrativa
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.IMPRDOCG-lista.FASE-AMM.EsportaDocumentiBusta','Funzione Esporta documenti presentati dalla ditta in un file zip (fase amministrativa)',5704);
		UPDATE W_OGGETTI SET DESCR='Funzione Esporta documenti presentati dalla ditta in un file zip (altre fasi)' where  OGGETTO='ALT.GARE.IMPRDOCG-lista.EsportaDocumentiBusta' AND TIPO='FUNZ';
                
		UPDATE W_PROAZI SET OGGETTO='MOD.GARE.DOCUMGARA-Tipologia-scheda.MOD-DOCUMGARA',CRC='3234838734' WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMGARA' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='MOD.GARE.DOCUMGARA-Tipologia-scheda.MOD-DOCUMCONC',CRC='4070199723' WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMCONC' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='MOD.GARE.DOCUMGARA-Tipologia-scheda.MOD-DOCUMINVITI',CRC='150729717' WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMINVITI' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='MOD.GARE.DOCUMGARA-Tipologia-scheda.MOD-ATTI',CRC='3523952528' WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-ATTI' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='MOD.GARE.DOCUMGARA-Tipologia-scheda.MOD-DOCUMESITO',CRC='3934080763' WHERE OGGETTO='MOD.GARE.GARE-scheda.DOCUMGARA.MOD-DOCUMESITO' AND TIPO='FUNZ';

		UPDATE W_PROAZI SET OGGETTO='INS.GARE.DOCUMGARA-Tipologia-scheda.INS-DOCUMGARA',CRC='1402204001' WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-DOCUMGARA' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='INS.GARE.DOCUMGARA-Tipologia-scheda.INS-DOCUMCONC',CRC='1640367620' WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-DOCUMCONC' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='INS.GARE.DOCUMGARA-Tipologia-scheda.INS-DOCUMINVITI',CRC='3563783384' WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-DOCUMINVITI' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='INS.GARE.DOCUMGARA-Tipologia-scheda.INS-ATTI',CRC='2361713477' WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-ATTI' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='INS.GARE.DOCUMGARA-Tipologia-scheda.INS-DOCUMESITO',CRC='2894572757' WHERE OGGETTO='INS.GARE.GARE-scheda.DOCUMGARA.INS-DOCUMESITO' AND TIPO='FUNZ';

		UPDATE W_PROAZI SET OGGETTO='DEL.GARE.DOCUMGARA-Tipologia-scheda.DEL-DOCUMGARA',CRC='2123219313' WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-DOCUMGARA' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='DEL.GARE.DOCUMGARA-Tipologia-scheda.DEL-DOCUMCONC',CRC='1289234452' WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-DOCUMCONC' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='DEL.GARE.DOCUMGARA-Tipologia-scheda.DEL-DOCUMINVITI',CRC='1115633240' WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-DOCUMINVITI' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='DEL.GARE.DOCUMGARA-Tipologia-scheda.DEL-ATTI',CRC='3902515713' WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-ATTI' AND TIPO='FUNZ';
		UPDATE W_PROAZI SET OGGETTO='DEL.GARE.DOCUMGARA-Tipologia-scheda.DEL-DOCUMESITO',CRC='2971509407' WHERE OGGETTO='DEL.GARE.GARE-scheda.DOCUMGARA.DEL-DOCUMESITO' AND TIPO='FUNZ';

		--Estensione decimali peso 
		update c0campi set c0c_fs = 'F8.4' where c0c_mne_ber = 'G1_PESO';
		update c0campi set c0c_fs = 'F8.4' where c0c_mne_ber = 'G1PESO_P';
		
		update eldaver set numver = '8.6.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.6.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.6.%') THEN

		CREATE TABLE GARPRO_WSDM(
			ID NUMERIC(12) NOT NULL,
			SYSCON NUMERIC(12),
			NGARA VARCHAR(20) NOT NULL,
			TIPOLOGIA NUMERIC(7),
			CLASSIFICA VARCHAR(100),
			CLASSIFICA_TIT VARCHAR(100),
			COD_REG VARCHAR(100),
			TIPO_DOC VARCHAR(100),
			MITT_INT VARCHAR(100),
			INDICE VARCHAR(100),
			UO_MITTDEST VARCHAR(100),
			MEZZO VARCHAR(100),
			STRUTTURA VARCHAR(2000),
			SUPPORTO VARCHAR(100),
			INDIRIZZO_MITT  VARCHAR(100),
			MEZZO_INVIO VARCHAR(100),
			LIVELLO_RIS  VARCHAR(100),
			OGGETTO_MAIL  VARCHAR(300),
			primary key(ID));
		ALTER TABLE GARPRO_WSDM ADD CONSTRAINT FK_GARPRO_WSDM_GARE FOREIGN KEY ( NGARA) REFERENCES GARE( NGARA ) ON DELETE CASCADE;

		ALTER TABLE DITG ADD NGARAEXP VARCHAR(20);

		update eldaver set numver = 'M1.8.7.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M1.8.7.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M1.8.7.0') THEN
                
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('GARPRO_WSDM',0);
			
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1008',23,'Invio RDO con protocollazione in corso',NULL,0,NULL);
	   INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1078',7,'Importazione da file formato M-Appalti',NULL,0,NULL);

		--Nuovo parametro per controllare le funzioni di import-export M-Appalti
	   INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1164',1,'0   attiva funzione di export(1) disattiva(0)',NULL,0,NULL);
	   INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1164',2,'0   attiva funzione di import(1) disattiva(0)',NULL,0,NULL);
	   INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1164','Export e import ditte in gara in formato M-Appalti',NULL);

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1IDGARGW','G1NGARAGW','G1SYSCONGW','G1TIPOLOGIAGW','G1CLASSGW','G1CLASSTITGW','G1CODREGGW','G1TIPODOCGW','G1MITTINTGW','G1INDICEGW','G1UOMITTDESTGW','G1MEZZOGW','G1STRUTTURAGW','G1SUPPORTOGW','G1INDMITTGW','G1MEZZOINVIOGW','G1LIVRISGW','G1OGGETTMAILGW');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'P',NULL,'ID.GARPRO_WSDM.GARE','G1IDGARGW','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NGARA.GARPRO_WSDM.GARE','G1NGARAGW','Cod.gara divisa in lotti o cod.fittizio gara a lotto unico','Codice gara interno','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SYSCON.GARPRO_WSDM.GARE','G1SYSCONGW','Codice utente che ha richiesto l''operazione ','Codice utente','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TIPOLOGIA.GARPRO_WSDM.GARE','G1TIPOLOGIAGW','Tipo di operazione (1 RdO)','Tipo operazione','N7',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CLASSIFICA.GARPRO_WSDM.GARE','G1CLASSGW','Classifica','Classifica','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CLASSIFICA_TIT.GARPRO_WSDM.GARE','G1CLASSTITGW','Classifica\Titolazione','Classifica\Titol.','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COD_REG.GARPRO_WSDM.GARE','G1CODREGGW','Codice registro','Codice registro','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TIPO_DOC.GARPRO_WSDM.GARE','G1TIPODOCGW','Tipo documento','Tipo documento','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'MITT_INT.GARPRO_WSDM.GARE','G1MITTINTGW','Mittente interno','Mittente interno','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'INDICE.GARPRO_WSDM.GARE','G1INDICEGW','Indice','Indice','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'UO_MITTDEST.GARPRO_WSDM.GARE','G1UOMITTDESTGW','Unita organizzativa mittente/destinataria','U.O. mitt/dest','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'MEZZO.GARPRO_WSDM.GARE','G1MEZZOGW','Mezzo','Mezzo','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'STRUTTURA.GARPRO_WSDM.GARE','G1STRUTTURAGW','Struttura','Struttura','A2000',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SUPPORTO.GARPRO_WSDM.GARE','G1SUPPORTOGW','Supporto','Supporto','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'INDIRIZZO_MITT.GARPRO_WSDM.GARE','G1INDMITTGW','Indirizzo mittente','Indirizzo mittente','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'MEZZO_INVIO.GARPRO_WSDM.GARE','G1MEZZOINVIOGW','Mezzo invio','Mezzo invio','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'LIVELLO_RIS.GARPRO_WSDM.GARE','G1LIVRISGW','Livello riservatezza','Livello riservatezza','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'OGGETTO_MAIL.GARPRO_WSDM.GARE','G1OGGETTMAILGW','Oggetto mail','Oggetto mail','A300',NULL,NULL,NULL);

	   DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1NGARAEXP');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NGARAEXP.DITG.GARE','G1NGARAEXP','Codice gara da cui la ditta è importata in formato JSON','Codice gara export','A20',NULL,NULL,NULL);		

		update c0campi set coc_des_web='Parte variabile compenso' where C0C_MNE_BER='G1VARCONS';
		update c0campi set coc_des_web='Ragione incarico' where C0C_MNE_BER='G1RAGCONS';

	   INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('GARPRO_WSDM.GARE',0,'E','PROT_WSDM','Estensione dati gara per protocollazione mediante task','NGARA.GARPRO_WSDM.GARE','GARE.GARE','NGARA.GARE.GARE',NULL,NULL,'g1_prot0');
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FASIRICEZIONE.EsportaDitteInGara','Funzione "Esporta ditte in gara in formato JSON"',11325);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FASIRICEZIONE.ImportaDitteInGara','Funzione "Importa ditte in gara in formato JSON"',11335);

		IF (select count(*) = 0 from W_OGGETTI where tipo='SEZ' and oggetto='GARE.GARE-scheda.CONTRATTO.CONSULENTI') THEN
			INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda.CONTRATTO.CONSULENTI','Sezione Consulenti e collaboratori',10213);
			INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.GARE-scheda-contratto.ATTOCONTR.CONSULENTI','Sezione Consulenti e collaboratori',10233);
		END IF;
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.AssociaGaraAElenco','Funzione di associazione in automatico di una gara ad elenco',2070);

        INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('FUNZ','VIS','ALT.GARE.AssociaGaraAElenco','Visualizza',0,1,1,3790939291);

        INSERT INTO W_QUARTZ (CODAPP,BEAN_ID,CRON_EXPRESSION,CRON_SECONDS,CRON_MINUTES,CRON_HOURS,CRON_DAY_OF_MONTH,CRON_MONTH,CRON_DAY_OF_WEEK,CRON_YEAR,DESCRIZIONE) VALUES ('PG','protocollaComunicazioneSchedulerTrigger','0 0/1 * * * ?','0','0/1','*','*','*','?',NULL,'Protocollazione delle comunicazioni di invito a presentare offerta');
		insert into W_QUARTZ (CODAPP,BEAN_ID,CRON_EXPRESSION,CRON_SECONDS,CRON_MINUTES,CRON_HOURS,CRON_DAY_OF_MONTH,CRON_MONTH,CRON_DAY_OF_WEEK,CRON_YEAR,DESCRIZIONE) VALUES ('PG','impostaStatoVerificheSchedulerTrigger', '0 0 0 1 1 ? 2099','0','0','0','1','1','?','2099', 'Verifiche interne Art. 80: impostazione stato scadenze');

		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','account.durata','180','Gestione account','Durata massima account senza accessi (espressa in GIORNI) per utenti con applicati i controlli di sicurezza',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','account.loginKO.maxNumTentativi','5','Gestione account','Numero massimo di tentativi di autenticazione oltre il quale viene bloccato l''accesso provvisoriamente',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','account.loginKO.delaySecondi','30','Gestione account','Ritardo (espresso in SECONDI) introdotto in caso di tentativo di autenticazione per un utente bloccato provvisoriamente per superamento del limite di tentativi di autenticazione fallita',null);
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','account.loginKO.durataBloccoMinuti','30','Gestione account','Durata del blocco provvisorio (espresso in MINUTI) per un utente avente superato il limite di tentativi di autenticazione fallita',null);
		
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','it.eldasoft.generatoreRicerche.tracciaTabelle','TORN;GARE;DITG;PUBBLI;GARECONT;EDIT;W_LOGEVENTI;W_INVCOM;W_INVCOMDES;W_DOCDIG','Generatore report','Elenco delle tabelle, separate da ";", le cui esecuzioni vanno tracciate con un evento',null);

		--Crea view V_GARE_PROFILO rimossa in seguito a un errore negli script di versioni precedenti
		perform sp_backupanddropviews('v_gare_profilo');
		create or replace view V_GARE_PROFILO as
			select v_gare_torn.codice, v_gare_torn.codgar, v_gare_torn.oggetto,v_gare_torn.codcig,torn.cenint, v_gare_torn.profiloweb, 
				v_gare_torn.genere, v_gare_torn.tipgar, v_gare_torn.isarchi,
				case when tab2.tab2d1 ='default' then 'PG_GARE' else tab2.tab2d1 end as codprofilo
			from v_gare_torn inner join torn on (v_gare_torn.codgar=torn.codgar and torn.profiloweb is null)
				INNER JOIN TAB2 ON (TAB2COD='A1z03' AND ',' || TAB2.TAB2D2 || ',' LIKE '%,' || CAST(V_GARE_TORN.TIPGAR AS VARCHAR(4)) || ',%' AND TAB2D1 not like '$%')
			union
			select v_gare_torn.codice, v_gare_torn.codgar, v_gare_torn.oggetto,v_gare_torn.codcig,torn.cenint, v_gare_torn.profiloweb, 
				v_gare_torn.genere, v_gare_torn.tipgar, v_gare_torn.isarchi,
				tab2.tab2d1 as codprofilo
			from v_gare_torn inner join torn on (v_gare_torn.codgar=torn.codgar and torn.profiloweb is not null)
				  INNER JOIN TAB2 ON TAB2COD='A1z03' and tab2d1 like '$%' AND torn.profiloweb = to_number(substring(substring(tab2d1,2,100),1,position('$' in substring(tab2d1,2,100))-1),'99999');
		perform sp_restoreviews('v_gare_profilo');

		update eldaver set numver = '8.7.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.7.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.7.%') THEN

		ALTER TABLE GARECONT ADD DCONSD TIMESTAMP;

        CREATE TABLE G1AQSPESA(
			ID NUMERIC(12) NOT NULL,
			NGARA VARCHAR(20) NOT NULL,
			NCONT NUMERIC(3) NOT NULL,
			CENINT VARCHAR(16),
			NPRORIC VARCHAR(40),
			DATRIC TIMESTAMP,
			IMPRIC NUMERIC(24,5),
			NPROAUT VARCHAR(40),
			DATAUT TIMESTAMP,
			IMPAUT NUMERIC(24,5),
			NOTE VARCHAR(2000),
			PRIMARY KEY(ID));
		ALTER TABLE G1AQSPESA ADD CONSTRAINT FK_G1AQSPESA_GARECONT FOREIGN KEY ( NGARA,NCONT) REFERENCES GARECONT( NGARA,NCONT) ON DELETE CASCADE;
                
        CREATE TABLE G1ADESIONIEST(
			ID NUMERIC(12) NOT NULL,
			CODCIG VARCHAR(10),
			CODCIGAQ VARCHAR(10),
			TIPGEN  NUMERIC(2),
			CENINT VARCHAR(16),
			CFEIN VARCHAR(16),
			NOMEIN VARCHAR(254),
			CFRUP VARCHAR(16),
			NOMTEC VARCHAR(161),
			OGGETTO VARCHAR(2000),
			IMPAPP NUMERIC(24,5),
			NOMEST VARCHAR(2000),
			CFIMP VARCHAR(16),
			PIVIMP VARCHAR(16),
			TIPIMP NUMERIC(2),
			IAGGIU  NUMERIC(24,5),
			DATTOA TIMESTAMP,
			SYSCON NUMERIC(12),
			NOTE  VARCHAR(2000),
			PRIMARY KEY(ID));
			
		CREATE TABLE WSVIGILANZA_PG (
			ID NUMERIC(10) not null,
			FASE VARCHAR(50), 
			KEY1 VARCHAR(30), 
			KEY2 VARCHAR(30), 
			KEY3 VARCHAR(30), 
			KEY4 VARCHAR(30), 
			KEY5 VARCHAR(30), 
			INVVIG_DATA TIMESTAMP, 
			INVVIG_XML_REQ TEXT, 
			INVVIG_ESITO NUMERIC(1), 
			INVVIG_MESSAGGIO TEXT,
			INVVIG_XML_RESP TEXT,
			primary key (ID));		

           ALTER TABLE ANTICORLOTTI ADD IDCONTRATTO VARCHAR(20);

		--(S.Santi 21.04.2020) Elenco adesioni ad accordo quadro esteso alle adesioni, gestite esternamente ad Appalti e registrate mediante servizio
		--
		create or replace view v_gare_adesioni as
			select gare.codcig,
				torn.codcigaq, 
				torn.tipgen,
				torn.cenint,
				uffint.cfein,
				uffint.nomein,
				torn.codrup,
				tecni.cftec,
				tecni.nomtec,
				gare.not_gar oggetto,
				gare.impapp,
				gare.ditta,
				impr.nomest, 
				case when impr.tipimp in (3,10) then imprman.cfimp else impr.cfimp end cfimp,
				case when impr.tipimp in (3,10) then imprman.pivimp else impr.pivimp end pivimp,
				impr.tipimp,
				gare.iaggiu,
				gare.dattoa,
				gare.ngara,
				torn.ngaraaq
			from gare
			inner join torn on (codgar=codgar1)
			inner join impr on (ditta = codimp)
			left outer join ragimp on (impr.codimp=ragimp.codime9 and ragimp.impman='1')
			left outer join impr imprman on (imprman.codimp=ragimp.coddic)
			left outer join uffint on (cenint=codein)
			left outer join tecni on (codrup=codtec)
			where isadesione ='1' and NGARAAQ is not null and ditta is not null and dattoa is not null
			union
			select codcig, codcigaq, tipgen, cenint, cfein, nomein, cast('' as varchar(1)) codrup, cfrup, nomtec, oggetto, impapp, cast('' as varchar(1)) ditta, nomest, cfimp, pivimp, tipimp, iaggiu, dattoa, cast('' as varchar(1)) ngara, cast('' as varchar(1)) ngaraaq
			from g1adesioniest;
	
		--(S.Santi 21.04.2020) Sintesi controllo spesa per accordo quadro
		--
		create or replace view v_spese_adesioni as
			with spese_adesioni as
				(select cenint, sum(impric) impric_tot, sum(impaut) impaut_tot,null iaggiu_tot, ngara, ncont
				from g1aqspesa 
				group by ngara, ncont, cenint
				union
				select ga.cenint, null,null,sum(ga.iaggiu), gc.ngara, gc.ncont
				 from v_gare_adesioni ga,garecont gc,gare
				 where (gare.ngara=ga.ngaraaq or gare.codcig=ga.codcigaq) and
				 ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1)
						or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
				  group by ga.cenint, gc.ngara, gc.ncont)
			select sp.ngara,sp.ncont,sp.cenint,uffint.nomein, gc.impqua, sum(impric_tot) impric, sum(impaut_tot) impaut, sum(iaggiu_tot) impimp
			from spese_adesioni sp
			inner join garecont gc on (sp.ngara=gc.ngara and sp.ncont=gc.ncont)
			left outer join uffint on (sp.cenint=uffint.codein)
			group by sp.ngara, sp.ncont, sp.cenint, uffint.nomein, gc.impqua;
	
		update eldaver set numver = 'M1.8.8.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M1.8.8.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M1.8.8.0') THEN

		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('G1AQSPESA',0);
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('WSVIGILANZA_PG', 0);		

        INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1016',10,'In graduatoria',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1163',1,'0   esclusione effettiva(1)  fittizia(0)',NULL,0,NULL);
		INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1163','Calcolo aggiudicazione: esclusione ali fittizia o effettiva',NULL);

        DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1DCONSD');
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DCONSD.GARECONT.GARE','G1DCONSD','Data di consegna lavori','Data consegna lavori','A10',NULL,'DATA_ELDA',NULL);

		UPDATE c0campi SET COC_DES='Codice o sigla della commessa',COC_DES_FRM='Codice commessa' where C0C_MNE_BER='CLAVOR';
		UPDATE c0campi SET COC_DES='Codice o sigla della commessa',COC_DES_FRM='Codice commessa' where C0C_MNE_BER='CODDEF';

        DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1IDSPESA','G1NGARASPE','G1NCONTSPE','G1CENINTSPE','G1NPRORICSPE','G1DATRICSPE','G1IMPRICSPE','G1NPROAUTSPE','G1DATAUTSPE','G1IMPAUTSPE','G1NOTESPE');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','ID.G1AQSPESA.GARE','G1IDSPESA','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NGARA.G1AQSPESA.GARE','G1NGARASPE','Codice gara a lotto unico o lotto di gara','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NCONT.G1AQSPESA.GARE','G1NCONTSPE','Numero progressivo del contratto','Num.progressivo','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CENINT.G1AQSPESA.GARE','G1CENINTSPE','Stazione appaltante aderente all''accordo quadro','Staz.appalt.aderente','A16',NULL,NULL,'Stazione appaltante aderente');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NPRORIC.G1AQSPESA.GARE','G1NPRORICSPE','Numero protocollo richiesta prenotazione di spesa','Num.prot.richiesta','A40',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DATRIC.G1AQSPESA.GARE','G1DATRICSPE','Data protocollo richiesta prenotazione di spesa','Data prot.richiesta ','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IMPRIC.G1AQSPESA.GARE','G1IMPRICSPE','Importo richiesto','Importo richiesto','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NPROAUT.G1AQSPESA.GARE','G1NPROAUTSPE','Numero protocollo autorizzazione','Num.prot.autorizzaz.','A40',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DATAUT.G1AQSPESA.GARE','G1DATAUTSPE','Data protocollo autorizzazione','Data prot.autorizz.','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IMPAUT.G1AQSPESA.GARE','G1IMPAUTSPE','Importo autorizzato','Importo autorizzato','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NOTE.G1AQSPESA.GARE','G1NOTESPE','Eventuali note','Note','A2000',NULL,'NOTE',NULL);

        DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1IDADE_AE','G1CODCIG_AE','G1CODCIGAQ_AE','G1TIPGEN_AE','G1CENINT_AE','G1CFEIN_AE','G1NOMEIN_AE','G1CFRUP_AE','G1NOMTEC_AE','G1OGGETTO_AE','G1IMPAPP_AE','G1NOMEST_AE','G1CFIMP_AE','G1PIVIMP_AE','G1TIPIMP_AE','G1IAGGIU_AE','G1DATTOA_AE','G1SYSCON_AE','G1NOTE_AE');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','ID.G1ADESIONIEST.GARE','G1IDADE_AE','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODCIG.G1ADESIONIEST.GARE','G1CODCIG_AE','Codice identificativo della gara (CIG)','Codice CIG','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODCIGAQ.G1ADESIONIEST.GARE','G1CODCIGAQ_AE','Codice CIG accordo quadro','CIG accordo quadro','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TIPGEN.G1ADESIONIEST.GARE','G1TIPGEN_AE','Tipo di appalto (Lavori, Forniture o Servizi)','Tipo di appalto','A100','A1007',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CENINT.G1ADESIONIEST.GARE','G1CENINT_AE','Codice stazione appaltante aderente','Cod.ente aderente','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CFEIN.G1ADESIONIEST.GARE','G1CFEIN_AE','Codice fiscale stazione appaltante aderente','Cod.fisc.ente ader.','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NOMEIN.G1ADESIONIEST.GARE','G1NOMEIN_AE','Denominazione stazione appaltante aderente','Denominazione ente','A254',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CFRUP.G1ADESIONIEST.GARE','G1CFRUP_AE','Codice fiscale responsabile unico procedimento','Cod.fisc.RUP','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NOMTEC.G1ADESIONIEST.GARE','G1NOMTEC_AE','Cognome e nome del RUP','Nome RUP','A161',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'OGGETTO.G1ADESIONIEST.GARE','G1OGGETTO_AE','Oggetto della gara','Oggetto','A2000',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IMPAPP.G1ADESIONIEST.GARE','G1IMPAPP_AE','Importo totale a base di gara,comprensivo della sicurezza','Imp. a base di gara','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NOMEST.G1ADESIONIEST.GARE','G1NOMEST_AE','Ragione sociale della ditta aggiudicataria','Ragione sociale agg.','A2000',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CFIMP.G1ADESIONIEST.GARE','G1CFIMP_AE','Codice fiscale della ditta','Codice fiscale ditta','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PIVIMP.G1ADESIONIEST.GARE','G1PIVIMP_AE','Partita iva della ditta','Partita iva ditta','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TIPIMP.G1ADESIONIEST.GARE','G1TIPIMP_AE','Tipologia dell''impresa','Tipologia','A100','Ag008',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IAGGIU.G1ADESIONIEST.GARE','G1IAGGIU_AE','Importo di aggiudicazione definitiva della gara','Importo di aggiud.','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DATTOA.G1ADESIONIEST.GARE','G1DATTOA_AE','Data dell''atto di aggiudicazione della gara','Data atto aggiudic.','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SYSCON.G1ADESIONIEST.GARE','G1SYSCON_AE','Codice utente che ha inviato i dati','Codice utente','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NOTE.G1ADESIONIEST.GARE','G1NOTE_AE','Eventuali note','Note','A2000',NULL,'NOTE',NULL);

        DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1CODCIG_VAE','G1CODCIGAQ_VAE','G1TIPGEN_VAE','G1CENINT_VAE','G1CFEIN_VAE','G1NOMEIN_VAE','G1CODRUP_VAE','G1CFRUP_VAE','G1NOMTEC_VAE','G1OGGETTO_VAE','G1IMPAPP_VAE','G1CODIMP_VAE','G1NOMEST_VAE','G1CFIMP_VAE','G1PIVIMP_VAE','G1TIPIMP_VAE','G1IAGGIU_VAE','G1DATTOA_VAE','G1NGARA_VAE','G1NGARAAQ_VAE');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','CODCIG.V_GARE_ADESIONI.GARE','G1CODCIG_VAE','Codice identificativo della gara (CIG)','Codice CIG','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODCIGAQ.V_GARE_ADESIONI.GARE','G1CODCIGAQ_VAE','Codice CIG accordo quadro','CIG accordo quadro','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TIPGEN.V_GARE_ADESIONI.GARE','G1TIPGEN_VAE','Tipo di appalto (Lavori, Forniture o Servizi)','Tipo di appalto','A100','A1007',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CENINT.V_GARE_ADESIONI.GARE','G1CENINT_VAE','Codice stazione appaltante aderente','Cod.ente aderente','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CFEIN.V_GARE_ADESIONI.GARE','G1CFEIN_VAE','Codice fiscale stazione appaltante aderente','Cod.fisc.ente ader.','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NOMEIN.V_GARE_ADESIONI.GARE','G1NOMEIN_VAE','Denominazione stazione appaltante aderente','Denominazione ente','A254',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODRUP.V_GARE_ADESIONI.GARE','G1CODRUP_VAE','Codice responsabile unico di procedimento','Cod. RUP','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CFRUP.V_GARE_ADESIONI.GARE','G1CFRUP_VAE','Codice fiscale responsabile unico procedimento','Cod.fisc.RUP','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NOMTEC.V_GARE_ADESIONI.GARE','G1NOMTEC_VAE','Cognome e nome del RUP','Nome RUP','A161',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'OGGETTO.V_GARE_ADESIONI.GARE','G1OGGETTO_VAE','Oggetto della gara','Oggetto','A2000',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IMPAPP.V_GARE_ADESIONI.GARE','G1IMPAPP_VAE','Importo totale a base di gara,comprensivo della sicurezza','Imp. a base di gara','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODIMP.V_GARE_ADESIONI.GARE','G1CODIMP_VAE','Codice ditta aggiudicataria','Codice ditta aggiud.','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NOMEST.V_GARE_ADESIONI.GARE','G1NOMEST_VAE','Ragione sociale della ditta aggiudicataria','Ragione sociale agg.','A2000',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CFIMP.V_GARE_ADESIONI.GARE','G1CFIMP_VAE','Codice fiscale della ditta','Codice fiscale ditta','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PIVIMP.V_GARE_ADESIONI.GARE','G1PIVIMP_VAE','Partita iva della ditta','Partita iva ditta','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TIPIMP.V_GARE_ADESIONI.GARE','G1TIPIMP_VAE','Tipologia dell''impresa','Tipologia','A100','Ag008',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IAGGIU.V_GARE_ADESIONI.GARE','G1IAGGIU_VAE','Importo di aggiudicazione definitiva della gara','Importo di aggiud.','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DATTOA.V_GARE_ADESIONI.GARE','G1DATTOA_VAE','Data dell''atto di aggiudicazione della gara','Data atto aggiudic.','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NGARA.V_GARE_ADESIONI.GARE','G1NGARA_VAE','Codice gara a lotto unico o lotto di gara','Codice gara','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NGARAAQ.V_GARE_ADESIONI.GARE','G1NGARAAQ_VAE','Codice gara dell''accordo quadro','Codice gara acc.qua.','A20',NULL,NULL,NULL);

        DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1NGARA_VSA','G1NCONT_VSA','G1CENINT_VSA','G1NOMEIN_VSA','G1IMPQUA_VSA','G1IMPRIC_VSA','G1IMPAUT_VSA','G1IMPIMP_VSA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','NGARA.V_SPESE_ADESIONI.GARE','G1NGARA_VSA','Codice gara accordo quadro ','Codice gara acc.qua.','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','NCONT.V_SPESE_ADESIONI.GARE','G1NCONT_VSA','Numero progressivo del contratto','Num.progr.contratto','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','CENINT.V_SPESE_ADESIONI.GARE','G1CENINT_VSA','Codice stazione appaltante aderente','Cod.ente aderente','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NOMEIN.V_SPESE_ADESIONI.GARE','G1NOMEIN_VSA','Denominazione stazione appaltante aderente','Denominazione ente','A254',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IMPQUA.V_SPESE_ADESIONI.GARE','G1IMPQUA_VSA','Importo netto massimo complessivo dell''accordo quadro','Imp.accordo quadro','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IMPRIC.V_SPESE_ADESIONI.GARE','G1IMPRIC_VSA','Importo richiesto','Importo richiesto','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IMPAUT.V_SPESE_ADESIONI.GARE','G1IMPAUT_VSA','Importo autorizzato','Importo autorizzato','F15',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IMPIMP.V_SPESE_ADESIONI.GARE','G1IMPIMP_VSA','Importo impegnato','Importo impegnato','F15',NULL,'MONEY',NULL);
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1IDVIG','G1FASEVIG','G1KEY1VIG','G1KEY2VIG','G1KEY3VIG','G1KEY4VIG','G1KEY5VIG','G1DATAVIG','G1XMLREQVIG','G1ESITOVIG','G1MSGVIG','G1XMLRESVIG');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P',	'ID.WSVIGILANZA_PG.GARE', 'G1IDVIG', 'Id.', 'Id.', 'N10', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'FASE.WSVIGILANZA_PG.GARE', 'G1FASEVIG', 'Fase', 'Fase', 'A50', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'KEY1.WSVIGILANZA_PG.GARE', 'G1KEY1VIG', 'Campo 1', 'Campo 1', 'A30', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'KEY2.WSVIGILANZA_PG.GARE', 'G1KEY2VIG', 'Campo 2', 'Campo 2', 'A30', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'KEY3.WSVIGILANZA_PG.GARE', 'G1KEY3VIG', 'Campo 3', 'Campo 3', 'A30', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'KEY4.WSVIGILANZA_PG.GARE', 'G1KEY4VIG', 'Campo 4', 'Campo 4', 'A30', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'KEY5.WSVIGILANZA_PG.GARE', 'G1KEY5VIG', 'Campo 5', 'Campo 5', 'A30', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'INVVIG_DATA.WSVIGILANZA_PG.GARE', 'G1DATAVIG', 'Data invio', 'Data invio', 'A19', NULL, 'TIMESTAMP', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'INVVIG_XML_REQ.WSVIGILANZA_PG.GARE', 'G1XMLREQVIG', 'XML inviato', 'XML inviato', 'A2000', NULL, 'CLOB', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (1,'E',NULL,'INVVIG_ESITO.WSVIGILANZA_PG.GARE', 'G1ESITOVIG', 'Esito', 'Esito', 'N1', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (1,'E',NULL,'INVVIG_MESSAGGIO.WSVIGILANZA_PG.GARE', 'G1MSGVIG', 'Messaggio di esito ', 'Messaggio esito', 'A2000', NULL, 'CLOB', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (1,'E',NULL,'INVVIG_XML_RESP.WSVIGILANZA_PG.GARE', 'G1XMLRESVIG', 'XML di risposta', 'XML Risposta', 'A2000', NULL, 'CLOB', NULL);
		
        DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1IDCONTANTICORL');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDCONTRATTO.ANTICORLOTTI.GARE','G1IDCONTANTICORL','Codice contratto SAP da cui deriva il lotto','Codice contratto SAP','A20',NULL,NULL,NULL);

		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('G1AQSPESA.GARE',0,'E','GARA_SP_AQ','Prenotazione di spesa per accordo quadro','NGARA.G1AQSPESA.GARE,NCONT.G1AQSPESA.GARE','GARECONT.GARE','NGARA.GARECONT.GARE,NCONT.GARECONT.GARE',NULL,NULL,'g1_spaq0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('G1ADESIONIEST.GARE',0,'E','DATI_ADES','Adesioni ad accordo quadro da dati esterni','ID.G1ADESIONIEST.GARE',NULL,NULL,NULL,NULL,'g1_dade0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('V_GARE_ADESIONI.GARE',0,'E','GARA_ADESI','Adesioni ad accordo quadro da dati esterni','NGARA.V_GARE_ADESIONI.GARE','GARE.GARE','NGARA.GARE.GARE',NULL,NULL,'g1_ades0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('V_SPESE_ADESIONI.GARE',0,'E','GARA_SPESA','Sintesi controllo di spesa per accordo quadro','NGARA.V_SPESE_ADESIONI.GARE,NCONT.V_SPESE_ADESIONI.GARE','GARECONT.GARE','NGARA.GARECONT.GARE,NCONT.GARECONT.GARE',NULL,NULL,'g1_spes0');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('WSVIGILANZA_PG.GARE', 0, 'E', 'VIGILA_GAR', 'Invii dati a Vigilanza', 'KEY1.WSVIGILANZA_PG.GARE', 'TORN.GARE', 'CODGAR.TORN.GARE', NULL, NULL, 'g1_vigpg');	
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.InsertDelibereAContrare','Funzione Inserisci documenti esito da delibere a contrarre',5490);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.TrasmettiAOperatoriInterni','Funzione Trasmissione a operatori interni (PALEO)',13080);
        
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('PAGE','GARE.GARE-scheda.SPESA','Pagina "Controllo spesa"',2708);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.GARE-scheda.SPESA.LISTANUOVO','Funzione nuova prenotazione di spesa',14320);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.G1AQSPESA-lista','Lista prenotazioni di spesa',14330);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.V_GARE_ADESIONI-lista','Dettaglio impegnato in adesioni e confronti competitivi',14340);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.G1AQSPESA-lista.DEL','Funzione elimina prenotazione di spesa',14350);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.GARE.G1AQSPESA-lista.LISTADELSEL','Funzione elimina prenotazione di spesa selezionati',14360);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.G1AQSPESA-lista.LISTANUOVO','Funzione nuova prenotazione di spesa',14370);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.G1AQSPESA-lista.MOD','Funzione modifica prenotazione di spesa',14380);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GARE.G1AQSPESA-scheda','Dettaglio prenotazione di spesa',14390);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.GARE.G1AQSPESA-scheda.SCHEDAMOD','Funzione modifica prenotazione di spesa',14400);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.G1AQSPESA-scheda.SCHEDANUOVO','Funzione nuova prenotazione di spesa',14410);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('PAGE','GARE.GARE-scheda-contratto.SPESA','Pagina "Controllo spesa"',4560);
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.GARE.GARE-scheda-contratto.SPESA.LISTANUOVO','Funzione nuova prenotazione di spesa',14430);
        
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.ANTICOR-scheda.ANNORIF.importaDatiSAP','Funzione importa dati da SAP',10051);

        INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('COLS','VIS','GARE.GARECONT.DCONSD','Visualizza',0,1,1,3476309558);

        INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('FUNZ','VIS','ALT.GARE.ANTICOR-scheda.ANNORIF.importaDatiSAP','Visualizza',0,1,1,1529330542);
        INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('COLS','VIS','GARE.ANTICORLOTTI.IDCONTRATTO','Visualizza',0,1,1,15164123);

		update eldaver set numver = '8.8.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.8.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.8.%') THEN

	--	strutture modulo NSO Ordini
			CREATE TABLE NSO_ORDINI(
				ID NUMERIC(12) NOT NULL,
				ID_PADRE NUMERIC(12),
				ID_ORIGINARIO NUMERIC(12),
				SYSCON NUMERIC(12),
				VERSIONE NUMERIC(12),
				DATA_INIZIO_VAL TIMESTAMP,
				DATA_FINE_VAL TIMESTAMP,
				CODORD VARCHAR(10) NOT NULL,			
				NGARA VARCHAR(20),
				OGGETTO VARCHAR(2000),
				CODEIN VARCHAR(16),
				RIF_OFFERTA VARCHAR(20),
				DATA_ORDINE TIMESTAMP,
				STATO_ORDINE NUMERIC(12),
				AZIONE_ORDINE NUMERIC(12),
				IS_REVISIONE VARCHAR(1),
				REFERENTE VARCHAR(500),
				CENTRO_COSTO VARCHAR(500),
				DATA_SCADENZA TIMESTAMP,
				DATA_LIMITE_MOD TIMESTAMP,
				CODORD_COLLEGATO VARCHAR(10),
				CIG VARCHAR(10),
				ESENZIONE_CIG VARCHAR(20),
				CUP VARCHAR(15),
				NREPAT VARCHAR(20),
				NOTE VARCHAR(2000),
				IS_DIV_BENEF VARCHAR(1), 
				DATA_INIZIO_FORN TIMESTAMP,
				DATA_FINE_FORN TIMESTAMP,
				CODEIN_FATTURA VARCHAR(16),
				UFFICIO_FATTURA VARCHAR(500),
				CONDIZIONI_PAGAMENTO VARCHAR(500),
				ARROTONDAMENTO NUMERIC(24,5),
				primary key(ID));
				
			CREATE TABLE NSO_ORDINANTI(
				ID NUMERIC(12) NOT NULL,
				NSO_ORDINI_ID NUMERIC(12),
				TIPO  NUMERIC(12),
				CODEIN VARCHAR(16),
				NOMEIN VARCHAR(500),
				ENDPOINT VARCHAR(200),
				VIA VARCHAR(60),
				CITTA VARCHAR(36),
				CAP VARCHAR(5),
				CODNAZ NUMERIC(7),
				PIVA VARCHAR(14),
				NOTE VARCHAR(2000),
				primary key(ID));

		ALTER TABLE NSO_ORDINANTI ADD CONSTRAINT FK_NSO_ORDINANTI_NSO_ORDINI FOREIGN KEY (NSO_ORDINI_ID) REFERENCES NSO_ORDINI(ID) ON DELETE CASCADE;			

				
			CREATE TABLE NSO_BENEFICIARIO(
				ID NUMERIC(12) NOT NULL,
				NSO_ORDINI_ID NUMERIC(12),
				DENOMINAZIONE VARCHAR(500),
				CONTATTO_RIF VARCHAR(500),
				INDIRIZZO VARCHAR(200),
				LOCALITA VARCHAR(50),
				CAP VARCHAR(5),
				CITTA VARCHAR(50),
				CODNAZ NUMERIC(7),
				primary key(ID));
				
			ALTER TABLE NSO_BENEFICIARIO ADD CONSTRAINT FK_NSO_BENEFICIARIO_NSO_ORDINI	FOREIGN KEY (NSO_ORDINI_ID) REFERENCES NSO_ORDINI(ID) ON DELETE CASCADE;
			
			CREATE TABLE NSO_FORNITORE(
				ID NUMERIC(12) NOT NULL,
				NSO_ORDINI_ID NUMERIC(12),
				CODIMP VARCHAR(10),
				NOMIMP VARCHAR(200),
				ENDPOINT VARCHAR(200),
				CFIMP VARCHAR(16),
				VIA VARCHAR(60),
				CITTA VARCHAR(36),
				CAP VARCHAR(5),
				CODNAZ NUMERIC(7),
				PERSONA_RIF  VARCHAR(500),
				primary key(ID));
				
			ALTER TABLE NSO_FORNITORE ADD CONSTRAINT FK_NSO_FORNITORE_NSO_ORDINI FOREIGN KEY (NSO_ORDINI_ID) REFERENCES NSO_ORDINI(ID) ON DELETE CASCADE;
			
			CREATE TABLE NSO_PUNTICONS(
				ID NUMERIC(12) NOT NULL,
				NSO_ORDINI_ID NUMERIC(12),
				CODEIN VARCHAR(16),	
				COD_PUNTO_CONS VARCHAR(100),
				INDIRIZZO VARCHAR(200),
				LOCALITA VARCHAR(100),
				CAP VARCHAR(5),
				CITTA VARCHAR(36),
				CODNAZ NUMERIC(7),
				ALTRE_INDIC VARCHAR(2000),
				ALTRO_PUNTO_CONS VARCHAR(2),
				CONS_DOMICILIO VARCHAR(2),	
				primary key(ID));
				
			ALTER TABLE NSO_PUNTICONS ADD CONSTRAINT FK_NSO_PUNTICONS_NSO_ORDINI FOREIGN KEY (NSO_ORDINI_ID) REFERENCES NSO_ORDINI(ID) ON DELETE CASCADE;
			
			CREATE TABLE NSO_LINEE_ORDINI(
				ID NUMERIC(12) NOT NULL,
				NSO_ORDINI_ID NUMERIC(12),
				ID_LINEA NUMERIC(12), 
				CODICE VARCHAR(20),
				DESCRIZIONE VARCHAR(2000),
				QUANTITA NUMERIC(24,5),
				UNIMIS VARCHAR(10),
				PREZZO_UNITARIO NUMERIC(24,5),
				IVA NUMERIC(24,5),
				CODICE_ESENZIONE VARCHAR(10),
				CENTRO_COSTO VARCHAR(500),
				CONS_PARZIALE VARCHAR(2),
				DATA_INIZIO_CONS TIMESTAMP,
				DATA_FINE_CONS TIMESTAMP,
				CODCPV VARCHAR(20),
				NOTE  VARCHAR(2000),
				CODEIN_RICH VARCHAR(20),
				primary key(ID));
				
			ALTER TABLE NSO_LINEE_ORDINI ADD CONSTRAINT FK_NSO_LINEE_ORDINI_NSO_ORDINI FOREIGN KEY (NSO_ORDINI_ID) REFERENCES NSO_ORDINI(ID) ON DELETE CASCADE;
			
			CREATE TABLE NSO_WS_ORDINI(
				ID NUMERIC(12) NOT NULL,
				CODORD VARCHAR(10) NOT NULL,	
				DATA_ORDINE VARCHAR(20) NOT NULL,
				NOME_FILE VARCHAR(500),
				IDT VARCHAR(200) ,
				primary key(ID,CODORD,DATA_ORDINE));
				
			ALTER TABLE NSO_WS_ORDINI ADD XML_FILE BYTEA;	
	
	        ALTER TABLE IMPRDOCG ADD DATALETTURA TIMESTAMP;
            ALTER TABLE IMPRDOCG ADD SYSCONLET NUMERIC(12);
				
			create or replace view V_NSO_CONSEGNE as 
				(select codcons_nso, nomein, cast(viaein||' '||nciein as varchar(100)) indirizzo,cast(' ' as varchar(1)) localita, proein, capein, citein, codnaz from uffint
				union
				select codcons_nso,  nompun, cast(viaein||' '||nciein as varchar(100)) indirizzo,cast(' ' as varchar(1)) localita, proein, capein, citein, codnaz from punticon);
                
                ALTER TABLE GARECONT ADD CONTSPE VARCHAR(1);

		update eldaver set numver = 'M1.8.9.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M1.8.9.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M1.8.9.0') THEN

		--	strutture modulo NSO Ordini
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('NSO_ORDINI.GARE', 0, 'E', 'ORDINI_NSO', 'Ordini NSO', 'ID.NSO_ORDINI.GARE', NULL, NULL, 'g1_nsoo2', 'g1_nsoo1', 'g1_nsoo0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('NSO_ORDINANTI.GARE', 0, 'E', 'ORDIN_NSO', 'Ordinanti', 'NSO_ORDINI_ID.NSO_ORDINANTI.GARE', 'NSO_ORDINI.GARE', 'ID.NSO_ORDINI', 'g_nsoor2', 'g_nsoor1', 'g_nsoor0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('NSO_BENEFICIARIO.GARE', 0, 'E', 'BENEF_NSO', 'Beneficiario', 'NSO_ORDINI_ID.NSO_BENEFICIARIO.GARE', 'NSO_ORDINI.GARE', 'ID.NSO_ORDINI', 'g_nsobe2', 'g_nsobe1', 'g_nsobe0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('NSO_FORNITORE.GARE', 0, 'E', 'FORN_NSO', 'Fornitore', 'NSO_ORDINI_ID.NSO_FORNITORE.GARE', 'NSO_ORDINI.GARE', 'ID.NSO_ORDINI', 'g_nsofo2', 'g_nsofo1', 'g_nsofo0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('NSO_PUNTICONS.GARE', 0, 'E', 'PCONS_NSO', 'Punti consegna', 'NSO_ORDINI_ID.NSO_PUNTICONS.GARE', 'NSO_ORDINI.GARE', 'ID.NSO_ORDINI', 'g_nsopu2', 'g_nsopu1', 'g_nsopu0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('NSO_LINEE_ORDINI.GARE', 0, 'E', 'LINEO_NSO', 'Linee ordini', 'NSO_ORDINI_ID.NSO_LINEE_ORDINI.GARE', 'NSO_ORDINI.GARE', 'ID.NSO_ORDINI', 'g_nsolo2', 'g_nsolo1', 'g_nsolo0');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('V_NSO_CONSEGNE.GARE', 0, 'E', 'CONS_NSO', 'Indirizzi consegna NSO', 'CODCONS_NSO.V_NSO_CONSEGNE.GARE', NULL, NULL, NULL, NULL, 'g_0icnso');
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('NSO_WS_ORDINI.GARE', 0, 'E', 'WSO_NSO', 'WS ordini NSO', 'ID.NSO_WS_ORDINI.GARE,CODORD.NSO_WS_ORDINI.GARE,DATA_ORDINE.NSO_WS_ORDINI.GARE', NULL, NULL, NULL, NULL, 'g_0wsnso');
		
		-- NSO ordini
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', 'P', 'ID.NSO_ORDINI.GARE', 'NSO_ORD_ID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'ID_PADRE.NSO_ORDINI.GARE', 'NSO_ORD_IDPADRE', 'Id padre', 'Id padre', 'N12', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'ID_ORIGINARIO.NSO_ORDINI.GARE', 'NSO_ORD_IDORIG', 'Id originario', 'Id originario', 'N12', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'VERSIONE.NSO_ORDINI.GARE', 'NSO_ORD_VERSIONE', 'Versione', 'Versione', 'N12', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'SYSCON.NSO_ORDINI.GARE', 'NSO_ORD_SYSCON', 'Id utente', 'Id utente', 'N12', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'DATA_INIZIO_VAL.NSO_ORDINI.GARE', 'NSO_ORD_DIVAL', 'Data inizio validita''', 'Data inizio val.', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'DATA_FINE_VAL.NSO_ORDINI.GARE', 'NSO_ORD_DFVAL', 'Data fine validita''', 'Data fine val.', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CODORD.NSO_ORDINI.GARE', 'NSO_ORD_CODORD', 'Codice ordine', 'Cod.Ordine', 'A10', NULL, NULL, 'Codice ordine');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NGARA.NSO_ORDINI.GARE','NSO_ORD_NGARA','Codice lotto','Codice lotto','A20', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'OGGETTO.NSO_ORDINI.GARE', 'NSO_ORD_OGGETTO', 'Oggetto', 'Oggetto', 'A500', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CODEIN.NSO_ORDINI.GARE','NSO_ORD_CODEIN','Codice ufficio intestatario','Cod. Uffint','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'RIF_OFFERTA.NSO_ORDINI.GARE','NSO_ORD_RIFOFF','Riferimento offerta','Rif.offerta','A20', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'DATA_ORDINE.NSO_ORDINI.GARE', 'NSO_ORD_DORD', 'Data ordine', 'Data ordine', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'STATO_ORDINE.NSO_ORDINI.GARE', 'NSO_ORD_STORD', 'Stato ordine', 'Stato', 'N12', 'NSO01', 'A100', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'AZIONE_ORDINE.NSO_ORDINI.GARE', 'NSO_ORD_AZORD', 'Azione', 'Azione su ord.', 'N12', 'NSO03', 'A100', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	Values (0,'E',NULL,'IS_REVISIONE.NSO_ORDINI.GARE','NSO_ORD_ISREV','Ordine in revisione?','In revisione?','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'REFERENTE.NSO_ORDINI.GARE','NSO_ORD_REFER','Referente','Referente','A500', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CENTRO_COSTO.NSO_ORDINI.GARE','NSO_ORD_CCOST','Centro di costo','Centro costo','A500', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'DATA_SCADENZA.NSO_ORDINI.GARE', 'NSO_ORD_DSCAD', 'Data scadenza', 'Data scadenza', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'DATA_LIMITE_MOD.NSO_ORDINI.GARE', 'NSO_ORD_DLIMM', 'Data limite modifiche', 'Data lim.mod.', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CODORD_COLLEGATO.NSO_ORDINI.GARE', 'NSO_ORD_CODOCOLL', 'Codice ordine collegato', 'Cod.ord.coll.', 'A10', NULL, NULL, 'Codice ordine collegato');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CIG.NSO_ORDINI.GARE','NSO_ORD_CIG','Codice CIG','Cod. CIG','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'ESENZIONE_CIG.NSO_ORDINI.GARE','NSO_ORD_ESECIG','Esenzione CIG','Esenzione CIG','A10',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CUP.NSO_ORDINI.GARE','NSO_ORD_CUP','Codice CUP','Cod. CUP','A15',NULL,NULL,'Codice CUP di progetto');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'NREPAT.NSO_ORDINI.GARE','NSO_ORD_NREPAT','Numero repertorio dell''atto contrattuale','N.repert.atto contr.','A20',NULL,NULL,'Numero repertorio');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'NOTE.NSO_ORDINI.GARE','NSO_ORD_NOTE','Eventuali note','Note','A2000',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	Values (0,'E',NULL,'IS_DIV_BENEF.NSO_ORDINI.GARE','NSO_ORD_ISDBEN','Beneficiario diverso?','Benef. diverso?','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CODEIN_FATTURA.NSO_ORDINI.GARE','NSO_ORD_CFATT','Uffint fatturazione','Uffint fatturazione','A16',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'UFFICIO_FATTURA.NSO_ORDINI.GARE','NSO_ORD_UFATT','Ufficio fatturazione','Ufficio fatturazione','A500',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CONDIZIONI_PAGAMENTO.NSO_ORDINI.GARE','NSO_ORD_CONDPAG','Condizioni pagamento','Condizioni pagamento','A500',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	Values (0,'E',NULL,'ARROTONDAMENTO.NSO_ORDINI.GARE','NSO_ORD_ARROT','Arrotondamento','Arrotondamento','F13.2',NULL,'MONEY',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'DATA_INIZIO_FORN.NSO_ORDINI.GARE', 'NSO_ORD_DIFESER', 'Data inizio fornitura/erogazione del servizio', 'Data inizio f/e', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'DATA_FINE_FORN.NSO_ORDINI.GARE', 'NSO_ORD_DFFESER', 'Data fine fornitura/erogazione del servizio', 'Data fine f/e', 'A10', NULL, 'DATA_ELDA', NULL);
		-- NSO ordinanti
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'ID.NSO_ORDINANTI.GARE', 'NSO_ON_ID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'NSO_ORDINI_ID.NSO_ORDINANTI.GARE', 'NSO_ON_ORDID', 'Id ordine', 'Id ordine', 'N12', NULL, NULL, 'Id ordine');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'TIPO.NSO_ORDINANTI.GARE', 'NSO_ON_TIPO', 'Tipo', 'Tipo', 'N12', 'NSO02', 'A100', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CODEIN.NSO_ORDINANTI.GARE','NSO_ON_CODEIN','Codice uffint','Codice uffint','A16', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'NOMEIN.NSO_ORDINANTI.GARE','NSO_ON_NOMEIN','Nome uffint','Nome uffint','A254', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'ENDPOINT.NSO_ORDINANTI.GARE', 'NSO_ON_ENDP', 'Endpoint NSO', 'Endpoint NSO', 'A200', NULL, NULL, NULL);			
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'VIA.NSO_ORDINANTI.GARE', 'NSO_ON_VIA', 'Indirizzo (via/piazza/corso)', 'Indirizzo', 'A60', NULL, NULL, NULL);
		 INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CITTA.NSO_ORDINANTI.GARE', 'NSO_ON_CITTA', 'Localita''dell''intestatario', 'Comune', 'A36', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CAP.NSO_ORDINANTI.GARE', 'NSO_ON_CAP', 'Codice di avviamento postale', 'C.A.P.', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODNAZ.NSO_ORDINANTI.GARE', 'NSO_ON_CNAZ', 'Nazione', 'Nazione', 'A2', 'Ag010', NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'PIVA.NSO_ORDINANTI.GARE', 'NSO_ON_PIVA', 'Partita I.V.A. o V.A.T.', 'Partita I.V.A.', 'A14', NULL, NULL, 'Partita I.V.A. o V.A.T.');
		-- NSO beneficiario			
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', 'P', 'ID.NSO_BENEFICIARIO.GARE', 'NSO_BE_ID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'NSO_ORDINI_ID.NSO_BENEFICIARIO.GARE', 'NSO_BE_ORDID', 'Id ordine', 'Id ordine', 'N12', NULL, NULL, 'Id ordine');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'DENOMINAZIONE.NSO_BENEFICIARIO.GARE','NSO_BE_DENOM','Denominazione','Denominazione','A500', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CONTATTO_RIF.NSO_BENEFICIARIO.GARE','NSO_BE_CONTRIF','Contatto di riferimento','Cont.rif.','A500', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'INDIRIZZO.NSO_BENEFICIARIO.GARE','NSO_BE_IND','Indirizzo','Indirizzo','A200', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'LOCALITA.NSO_BENEFICIARIO.GARE','NSO_BE_LOC','Localita','Localita','A50', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CAP.NSO_BENEFICIARIO.GARE','NSO_BE_CAP', 'Codice di avviamento postale', 'C.A.P.', 'A5', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CITTA.NSO_BENEFICIARIO.GARE','NSO_BE_CITTA','Citta','Citta','A50', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CODNAZ.NSO_BENEFICIARIO.GARE', 'NSO_BE_CNAZ', 'Nazione', 'Nazione', 'A2', 'Ag010', NULL, NULL);
		-- NSO fornitore
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', 'P', 'ID.NSO_FORNITORE.GARE', 'NSO_FO_ID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'NSO_ORDINI_ID.NSO_FORNITORE.GARE', 'NSO_FO_ORDID', 'Id ordine', 'Id ordine', 'N12', NULL, NULL, 'Id ordine');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CODIMP.NSO_FORNITORE.GARE','NSO_FO_CODIMP','Codice fornitore','Codice fornitore','A10', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'ENDPOINT.NSO_FORNITORE.GARE', 'NSO_FO_ENDP', 'Endpoint NSO', 'Endpoint NSO', 'A200', NULL, NULL, NULL);			
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'NOMIMP.NSO_FORNITORE.GARE','NSO_FO_NOMIMP','Nome fornitore','Nome fornitore','A200', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CFIMP.NSO_FORNITORE.GARE','NSO_FO_CFIMP','C.F. fornitore','C.F. fornitore','A200', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'VIA.NSO_FORNITORE.GARE', 'NSO_FO_VIA', 'Indirizzo (via/piazza/corso)', 'Indirizzo', 'A60', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CITTA.NSO_FORNITORE.GARE', 'NSO_FO_CITTA', 'Localita''del fornitore', 'Comune', 'A36', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CAP.NSO_FORNITORE.GARE', 'NSO_FO_CAP', 'Codice di avviamento postale', 'C.A.P.', 'A5', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CODNAZ.NSO_FORNITORE.GARE', 'NSO_FO_CNAZ', 'Nazione', 'Nazione', 'A2', 'Ag010', NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'PERSONA_RIF.NSO_FORNITORE.GARE', 'NSO_FO_PERSRIF', 'Persona rif.', 'Persona', 'A500', NULL, NULL, NULL);
		--	NSO punti di consegna		
 		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', 'P', 'ID.NSO_PUNTICONS.GARE', 'NSO_PU_ID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'NSO_ORDINI_ID.NSO_PUNTICONS.GARE', 'NSO_PU_ORDID', 'Id ordine', 'Id ordine', 'N12', NULL, NULL, 'Id ordine');		
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CODEIN.NSO_PUNTICONS.GARE','NSO_PU_CODEIN','Codice ufficio','Codice ufficio','A10', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'COD_PUNTO_CONS.NSO_PUNTICONS.GARE','NSO_PU_CODPC','Codice punto consegna','Cod. punto cons.','A100', NULL, NULL, NULL);	
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'INDIRIZZO.NSO_PUNTICONS.GARE', 'NSO_PU_IND', 'Indirizzo (via/piazza/corso)', 'Indirizzo', 'A60', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'LOCALITA.NSO_PUNTICONS.GARE', 'NSO_PU_LOC', 'Localita'' della consegna', 'Localita''', 'A36', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CAP.NSO_PUNTICONS.GARE', 'NSO_PU_CAP', 'Codice di avviamento postale', 'C.A.P.', 'A5', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CITTA.NSO_PUNTICONS.GARE', 'NSO_PU_CITTA', 'Citta''della consegna', 'Comune', 'A36', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CODNAZ.NSO_PUNTICONS.GARE', 'NSO_PU_CNAZ', 'Nazione', 'Nazione', 'A2', 'Ag010', NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	Values (0,'E',NULL,'ALTRE_INDIC.NSO_PUNTICONS.GARE','NSO_PU_ALTRI','Altre indicazioni','Altre indicazioni','A2000',NULL,'NOTE',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	Values (0,'E',NULL,'ALTRO_PUNTO_CONS.NSO_PUNTICONS.GARE','NSO_PU_ALTRPC','Altro punto di consegna?','Altro p.cons.?','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	Values (0,'E',NULL,'CONS_DOMICILIO.NSO_PUNTICONS.GARE','NSO_PU_CONSDOM','Consegna a domicilio?','Cons. a domicilio?','A2',NULL,'SN',NULL);
		-- NSO linee ordini
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', 'P', 'ID.NSO_LINEE_ORDINI.GARE', 'NSO_LO_ID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'NSO_ORDINI_ID.NSO_LINEE_ORDINI.GARE', 'NSO_LO_ORDID', 'Id ordine', 'Id ordine', 'N12', NULL, NULL, 'Id ordine');		
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'ID_LINEA.NSO_LINEE_ORDINI.GARE', 'NSO_LO_LINID', 'Id riga', 'Id riga', 'N12', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CODICE.NSO_LINEE_ORDINI.GARE', 'NSO_LO_COD', 'Codice', 'Codice', 'A20', NULL, NULL, NULL);			
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'DESCRIZIONE.NSO_LINEE_ORDINI.GARE', 'NSO_LO_DESCR', 'Descrizione', 'Descrizione', 'A2000', NULL,'NOTE', NULL);			
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'QUANTITA.NSO_LINEE_ORDINI.GARE','NSO_LO_QUANTI','Quantita''','Quantita''','F24.5',NULL,NULL,NULL);			
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	Values (0,'E',NULL,'UNIMIS.NSO_LINEE_ORDINI.GARE','NSO_LO_UM','Unita'' di misura','Unita'' di misura','A10',NULL,NULL,NULL);			
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'PREZZO_UNITARIO.NSO_LINEE_ORDINI.GARE','NSO_LO_PU','Prezzo unitario a base di gara','Prezzo unitario','F24.5',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'IVA.NSO_LINEE_ORDINI.GARE','NSO_LO_IVA','Iva','Iva','F24.5',NULL,'PRC',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CODICE_ESENZIONE.NSO_LINEE_ORDINI.GARE', 'NSO_LO_CESE', 'Codice esenzione', 'Codice esenzione', 'A10', NULL,NULL, NULL);			
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CENTRO_COSTO.NSO_LINEE_ORDINI.GARE','NSO_LO_CCOST','Centro di costo','Centro costo','A500', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	Values (0,'E',NULL,'CONS_PARZIALE.NSO_LINEE_ORDINI.GARE','NSO_LO_CONSP','Consegna parziale?','Cons. parziale?','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'DATA_INIZIO_CONS.NSO_LINEE_ORDINI.GARE', 'NSO_LO_DICONS', 'Data inizio consegna', 'Data inizio cons.', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'DATA_FINE_CONS.NSO_LINEE_ORDINI.GARE', 'NSO_LO_DFCONS', 'Data fine consena', 'Data fine cons', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'CODCPV.NSO_LINEE_ORDINI.GARE', 'NSO_LO_CPV', 'Codice cpv', 'Codice cpv', 'A20', NULL,NULL, NULL);			
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'NOTE.NSO_LINEE_ORDINI.GARE', 'NSO_LO_NOTE', 'Note', 'Note', 'A2000', NULL,'NOTE', NULL);			
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'CODEIN_RICH.NSO_LINEE_ORDINI.GARE','NSO_LO_CODEINR','Codice ufficio richiedente','Ufficio rich.','A10', NULL, 'MONEY', NULL);
			-- NSO_WS_ORDINI
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'ID.NSO_WS_ORDINI.GARE', 'NSO_WS_ID',  'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'CODORD.NSO_WS_ORDINI.GARE', 'NSO_WS_CODORD',  'Codice ordine', 'Codice ordine', 'A10', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'DATA_ORDINE.NSO_WS_ORDINI.GARE', 'NSO_WS_DATORD',  'Data ordine', 'Data ordine', 'A10', NULL, 'DATA_ELDA', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'NOME_FILE.NSO_WS_ORDINI.GARE', 'NSO_WS_NFILE',  'Nome file', 'Nome file', 'A500', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'IDT.NSO_WS_ORDINI.GARE', 'NSO_WS_IDT',  'IDT', 'Id. Trasporto NSO', 'A200', NULL, NULL, 'Identificativo di Trasporto NSO');
			--view V_NSO_CONSEGNE
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODCONS_NSO.V_NSO_CONSEGNE.GARE', 'VCNSO_CODCONS', 'Punto consegna NSO', 'Punto cons. NSO', 'A20', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'NOMEIN.V_NSO_CONSEGNE.GARE', 'VCNSO_NOMEIN', 'Denominazione', 'Denominazione', 'A254', NULL, 'NOTE', NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'INDIRIZZO.V_NSO_CONSEGNE.GARE', 'VCNSO_IND', 'Indirizzo (via/piazza/corso)', 'Indirizzo', 'A60', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'PROEIN.V_NSO_CONSEGNE.GARE', 'VCNSO_PROEIN', 'Provinciao', 'Provincia', 'A36', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'LOCALITA.V_NSO_CONSEGNE.GARE', 'VCNSO_LOC', 'Localita''', 'Localita''', 'A1', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CAPEIN.V_NSO_CONSEGNE.GARE', 'VCNSO_CAPEIN', 'Codice di avviamento postale', 'C.A.P.', 'A5', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CITEIN.V_NSO_CONSEGNE.GARE', 'VCNSO_CITEIN', 'Citta''', 'Citta''', '32', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'CODNAZ.V_NSO_CONSEGNE.GARE', 'VCNSO_CODNAZ', 'Nazione', 'Nazione', 'A2', 'Ag010', NULL, NULL);

        DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1DATALETDI','G1SYSCONDI');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DATALETTURA.IMPRDOCG.GARE','G1DATALETDI','Data prima lettura documento (primo download)','Data prima lettura','A19',NULL,'TIMESTAMP',NULL);
        INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SYSCONLET.IMPRDOCG.GARE','G1SYSCONDI','Codice utente che ha fatto la prima lettura (primo download)','Cod.utente prima let','N12',NULL,NULL,NULL);
			
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1DATALET_DD','G1SYSCONLET_DD');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'DATALETTURA.V_GARE_DOCDITTA.GARE', 'G1DATALET_DD', 'Data prima lettura documento (primo download)', 'Data prima lettura', 'A19', NULL, 'TIMESTAMP', NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0, 'E', NULL, 'SYSCONLET.V_GARE_DOCDITTA.GARE', 'G1SYSCONLET_DD', 'Codice utente che ha fatto la prima lettura (primo download)', 'Cod.utente prima let', 'N12', NULL, NULL, NULL);

        DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1CONTSPE');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CONTSPE.GARECONT.GARE','G1CONTSPE','Attiva controllo spesa nelle adesioni all''accordo quadro?','Attiva contr.spesa?','A2',NULL,'SN','Attiva controllo spesa?');

        DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1GARAACCQ','G1CONTSPEACCQ','G1NCONTSACCQ');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'GARA.V_GARE_ACCORDIQUADRO.GARE','G1GARAACCQ','Codice gara stipula accordo quadro','Cod.gara stipula aq.','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NCONT.V_GARE_ACCORDIQUADRO.GARE','G1NCONTSACCQ','Numero progressivo stipula accordo quadro','Num.progr.stipula aq','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'CONTSPE.V_GARE_ACCORDIQUADRO.GARE','G1CONTSPEACCQ','Controllo spesa attivo?','Controllo spesa?','A2',NULL,'SN',NULL);

		UPDATE C0CAMPI set COC_DES_WEB='N.gg. validità iscrizione (da data dom.iscrizione o ultimo rinnovo)' where C0C_MNE_BER='VALISCRGA';
		UPDATE C0CAMPI set COC_DES_FRM='Sorteggio verif.req?',COC_DES_WEB='Sorteggiata?' where C0C_MNE_BER='G1ESTIMPD';

		INSERT INTO G_CONFCOD (NOMENT,NOMCAM,TIPCAM,CODAPP,DESCAM,CONTAT,CODCAL,NUMORD) VALUES ('NSO_ORDINI','CODORD',-1,'G1','Codice ordine (Modulo NSO)',0,'"O"<00000>',9);

		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('NSO_ORDINI',0);
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('NSO_ORDINANTI',0);
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('NSO_BENEFICIARIO',0);
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('NSO_FORNITORE',0);
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('NSO_PUNTICONS',0);
		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('NSO_LINEE_ORDINI',0);

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('NSO01',1,'In lavorazione',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('NSO01',2,'Completato',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('NSO01',3,'Annullato',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('NSO01',4,'Inviato',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('NSO01',5,'In attesa di conferma dal fornitore',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('NSO01',6,'Confermato',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('NSO01',7,'Rifiutato',NULL,0,NULL);

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('NSO02',1,'Ordinante IPA',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('NSO02',2,'Ordinante cliente',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('NSO02',3,'Ordinante emissore',NULL,0,NULL);

        INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1115',7,'1  Attiva controllo spesa in adesioni(1)  non attiva(2)',NULL,0,NULL);

		UPDATE TAB1 set TAB1DESC='No (oppure mediante calcolo esterno alla piattaforma)' where TAB1COD='A1144' and TAB1TIP=3;

		--Allineamento G1CF_PUBB con dati di inizializzazione
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''4'',''10'',''25'',''28''))) and torn.iterga=4' where ID=2;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''6'',''8'',''9'',''11'',''13'',''14'',''20'',''29'',''30'',''34'')))' where ID=3;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''9'',''11'',''13'',''14'',''20'',''29'',''30'',''32'',''34'')))' where ID=4;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''2'',''4'',''7'',''9'',''10'',''11'',''12'',''13'',''14'',''15'',''19'',''25'',''28'',''29'',''30'',''32'',''34'',''35''))) or (gare.tipgarg = 29)' where ID=6;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''9'',''10'',''11'',''13'',''14'',''20'',''25'',''28'',''29'',''30'',''32'',''34'')))' where ID=7;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''9'',''10'',''11'',''13'',''14'',''20'',''25'',''28'',''29'',''30'',''32'',''34'')))' where ID=8;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''9'',''10'',''11'',''13'',''14'',''20'',''25'',''28'',''29'',''30'',''32'',''34'')))' where ID=9;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''9'',''10'',''11'',''13'',''14'',''20'',''25'',''28'',''29'',''30'',''32'',''34'')))' where ID=10;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''9'',''10'',''11'',''13'',''14'',''20'',''25'',''28'',''29'',''30'',''32'',''34'')))' where ID=11;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''9'',''10'',''11'',''13'',''14'',''20'',''25'',''28'',''29'',''30'',''32'',''34'')))' where ID=12;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''6'',''7'',''8'',''9'',''10'',''11'',''12'',''13'',''14'',''15'',''17'',''20'',''25'',''28'',''29'',''30'',''32'',''33'',''34'',''35'')))' where ID=13;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''18'',''19'')))' where ID=14;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (gare.tipgarg is null or gare.tipgarg <> 29)' where ID=16;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''9'',''10'',''11'',''13'',''14'',''20'',''25'',''28'',''29'',''30'',''32'',''34'')))' where ID=17;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''1'',''2'',''4'',''6'',''7'',''8'',''9'',''10'',''11'',''12'',''13'',''14'',''15'',''16'',''20'',''25'',''28'',''29'',''30'',''32'',''33'',''34'',''35'')))' where ID=18;
        Update G1CF_PUBB set CL_WHERE_VIS='(TORN.SOMMAUR = ''1'') and (GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and exists(select * from tab2 where tab2cod=''A1z11'' and ('',''||tab2d2||'','' like ''%,''||cast(gare.tipgarg as text)||'',%'' or '',''||tab2d2||'','' like ''%,''||cast(torn.tipgar as text)||'',%'') and (tab2tip IN (''7'',''12'',''15'',''16'',''35'')))' where ID=19;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (TORN.ACCQUA=''2'' or TORN.ACCQUA is null) and (gare.tipgarg is null or gare.tipgarg <> 29)' where ID=25;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (TORN.ACCQUA=''2'' or TORN.ACCQUA is null) and (gare.tipgarg is null or gare.tipgarg <> 29)' where ID=26;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (gare.tipgarg is null or gare.tipgarg <> 29)' where ID=90;
        Update G1CF_PUBB set CL_WHERE_VIS='(GARE.GENERE is null or GARE.GENERE not in (10,11,20)) and (gare.tipgarg is null or gare.tipgarg <> 29)' where ID=91;

        Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','avviso.downloadDocumenti.prefissoQuantitativo' ,NULL,'Personalizzazione Comune Bari','Indicare il prefisso dei file di cui si vuole controllare il download',null);
		
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','nso.ws.url',NULL,'Integrazione NSO','base URL per endpoint nso-integration',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','nso.ws.url.validateOrder.path',NULL,'Integrazione NSO','path per validateOrder endpoint nso-integration',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','nso.ws.url.processOrder.path',NULL,'Integrazione NSO','path per processOrder endpoint nso-integration',NULL);
		
		--Spostato la property a livello generale, in modo da condividere il valore con LFS.
		UPDATE W_CONFIG SET valore = coalesce(valore,'') || 'TORN;GARE;DITG;PUBBLI;GARECONT;EDIT;W_LOGEVENTI;W_INVCOM;W_INVCOMDES;W_DOCDIG;DOCUMGARA;V_DITGAMMIS;V_GARE_DITTEFASI;V_GARE_DOCDITTA;V_WS_DITG;V_WS_BANDI_PER_OFFERTA;V_WS_GARE_LOTTI_PUB_RIS;V_WS_DOCUMENTI_DIGITALI;V_WS_FASI_GARA_PARTECIPANTI;' where codapp='W_' and chiave='it.eldasoft.generatoreRicerche.tracciaTabelle';
	
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.creazioneOrdini','Modulo Ordini NSO',2062);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('FUNZ','VIS','ALT.GARE.creazioneOrdini','Visualizza',0,1,1,2393405189);

		update eldaver set numver = 'M2.8.9.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M2.8.9.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M2.8.9.0') THEN
	
		perform sp_backupanddropviews('v_gare_accordiquadro');
		create or replace view v_gare_accordiquadro (ngara,tipgen,tipgarg,not_gar,codcig,cenint,datainizio,datafine,aqoper,aqdurata,aqtempo,isarchi,gara,ncont,contspe) as
                select g.ngara,tipgen,tipgarg, not_gar, codcig, torn.cenint,daatto as datainizio,
		case when aqdurata is null then null
			when aqtempo = 1 then daatto + INTERVAL '1 day' * coalesce (AQDURATA * 30,0)
			when aqtempo = 2 then daatto + INTERVAL '1 day' * coalesce (AQDURATA * 365,0)
			else null end as datafine,
                g1.aqoper, aqdurata, aqtempo,isarchi, gc.ngara, gc.ncont, gc.contspe
			from gare g inner join torn on (g.codgar1=codgar)
				inner join gare1 g1 on (g1.ngara=g.ngara)
				left outer join garecont gc on ((gc.codimp=g.ditta or gc.codimp is null) and ((gc.ngara=g.ngara and gc.ncont=1)
				or (gc.ngara=g.codgar1 and (gc.ngaral is null or gc.ngaral=g.ngara))))
			where accqua='1' and daatto is not null and aqdurata is not null and aqtempo is not null
			and (gc.esecscig is null or gc.esecscig<>'1');
		perform sp_restoreviews('v_gare_accordiquadro');
			
		--(26.05.2020) Aggiunto campi primo download file
		perform sp_backupanddropviews('v_gare_docditta');
		create or replace view v_gare_docditta as
			select imprdocg.codgar,
				imprdocg.ngara,
				imprdocg.codimp,
				imprdocg.norddoci,
				imprdocg.proveni,
				case when proveni=1 then documgara.busta else imprdocg.busta end busta,
				tab1.tab1nord bustaord,
				tab1.tab1desc bustadesc,
				case when proveni=1 then documgara.descrizione else imprdocg.descrizione end descrizione,
				documgara.reqcap,
				documgara.tipodoc,
				documgara.contestoval,
				documgara.obbligatorio,
				documgara.modfirma,
				documgara.gentel,
				documgara.fasele,
				documgara.isarchi,
				coalesce(documgara.numord,10000) numord,
				documgara.datarilascio datapub,
				imprdocg.datarilascio,
				imprdocg.orarilascio,
				imprdocg.datascadenza,
				imprdocg.situazdoci,
				imprdocg.doctel,
				imprdocg.idprg,
				imprdocg.iddocdg,
				w_docdig.dignomdoc,
				imprdocg.notedoci,
				imprdocg.datalettura,
				imprdocg.sysconlet
			from imprdocg 
			left outer join documgara on (imprdocg.codgar = documgara.codgar and imprdocg.norddoci=documgara.norddocg and imprdocg.proveni=1 and documgara.gruppo=3)
			left outer join w_docdig on (imprdocg.idprg=w_docdig.idprg and imprdocg.iddocdg=w_docdig.iddocdig)
			left outer join tab1 on (tab1cod='A1013' and (tab1tip=imprdocg.busta or tab1tip=documgara.busta));
		perform sp_restoreviews('v_gare_docditta');	

		--
		perform sp_backupanddropviews('v_gare_torn');
		create or replace view v_gare_torn as 
		with
		--n.lotti di ogni gara
		lotti
		as (
		select codgar1, array_to_string(array_agg(gare.codcig),',') codciglotti, count(*) numlotti from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati senza esito negativo
		lottiagg
		as (
		select codgar1, count(*) numlottiagg from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null and esineg is null
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati e con contratto stipulato senza esito negativo
		lottistip
		as (
		select codgar1, count(*) numlottistip from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null and esineg is null and daatto is not null
		group by codgar1
		),
		--n.lotti di ogni gara aggiudicati o con esito negativo
		lotticonc
		as (
		select codgar1, count(*) numlotticonc from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null or esineg is not null
		group by codgar1
		)
		select codgar, codgar as codice, tipgen, destor as oggetto, imptor as importo, tipgar, 
			cast('1' as varchar(1)) as islotti, (case when gare.genere=3 then 3 else 1 end) as genere, isarchi,
			case when (lotti.numlotti>0 and lottiagg.numlottiagg>0 and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu,
			case when (lotti.numlotti>0 and lottistip.numlottistip>0 and lottiagg.numlottiagg=lottistip.numlottistip and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isstipula,
			case when (lotti.numlotti>0 and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as islotticonclusi,
			(case when gare.genere=3 then gare.esineg else torn.esineg end) as esineg, lotti.codciglotti as codcig, profiloweb, gartel, cenint
		from torn 
			left outer join gare on (codgar=gare.ngara and gare.genere=3) 
			left outer join lotti on (lotti.codgar1=torn.codgar)
			left outer join lottiagg on (lottiagg.codgar1=torn.codgar)
			left outer join lottistip on (lottistip.codgar1=torn.codgar)
			left outer join lotticonc on (lotticonc.codgar1=torn.codgar)
			where codgar not like '$%' 
		union all
		select torn.codgar, gare.ngara as codice, torn.tipgen, gare.not_gar as oggetto, gare.impapp as importo, gare.tipgarg,
			cast('2' as varchar(1)) as islotti, 2 as genere, torn.isarchi, 
			case when (gare.ditta is not null and gare.esineg is null) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu, 
			case when (gare.ditta is not null and gare.daatto is not null and gare.esineg is null) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isstipula, 
			null as islotticonclusi,
			gare.esineg, gare.codcig, torn.profiloweb, torn.gartel, torn.cenint
			from gare,torn 
			where torn.codgar=gare.codgar1 and torn.codgar like '$%' and (gare.genere is null or (gare.genere not in (4,10,11,20)));
		perform sp_restoreviews('v_gare_torn');	

		update eldaver set numver = '8.9.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.9.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.9.%') THEN

		ALTER TABLE TORN ADD SORTINV VARCHAR(1);
		ALTER TABLE DITG ADD SORTINV VARCHAR(1);
                ALTER TABLE GARE1 ADD ESCAUTO NUMERIC(7);
                
		update eldaver set numver = 'M1.8.10.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M1.8.10.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	v_cnt_wsdm numeric(10);
	v_cnt_wsdmuffi numeric(10);
	v_cnt_vigilanza numeric(10);
	wsdmconfi_id numeric(10);
	config_chiave varchar(100);
	config_valore varchar(500);
	ciclo_config cursor for select chiave,valore from w_config where codapp='PG' and chiave in (
		'wsdm.fascicoloprotocollo.url',
		'wsdmconfigurazione.fascicoloprotocollo.url',
		'pg.wsdm.invioMailPec',
		'wsdm.invioMailPec.delay',
		'wsdm.protocolloSingoloInvito',
		'wsdm.documentale.url',
		'wsdmconfigurazione.documentale.url',
		'wsdm.loginComune',
		'pg.wsdm.applicaFascicolazione',
		'wsdm.accediFascicoloDocumentale',
		'wsdm.gestioneStrutturaCompetente',
		'wsdm.applicaRiservatezza',
		'wsdm.associaDocumentiProtocollo',
		'wsdm.bloccoIndirizzoMittente',
		'wsdm.gestioneERP'
		) and (valore is not null and trim(valore)<>'');
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M1.8.10.0') THEN

		--Porting configurazione integrazione WSDM
 		if (select count(*)=0 from wsdmconfi where codapp='PG') then
			select count(*) into v_cnt_wsdm from w_config where codapp='PG' and (chiave='wsdm.fascicoloprotocollo.url' or chiave='wsdm.documentale.url') and valore is not null and trim(valore)<>'';
			if (v_cnt_wsdm>0) then
				wsdmconfi_id := 0;
				select chiave into wsdmconfi_id from w_genchiavi where tabella='WSDMCONFI';
				wsdmconfi_id := wsdmconfi_id + 1;
				INSERT INTO WSDMCONFI(id,codapp,descri) VALUES(wsdmconfi_id,'PG','Integrazione documentale Appalti');
				update W_GENCHIAVI set chiave=wsdmconfi_id where tabella='WSDMCONFI';

				open ciclo_config;
				loop
					fetch ciclo_config into config_chiave, config_valore;
					if not found then
						exit;
					end if;
					INSERT INTO wsdmconfipro(idconfi,chiave,valore) values(wsdmconfi_id,config_chiave,config_valore);
				end loop;
				close ciclo_config;

				--Eventuale configurazione per stazione appaltante
				select count(*) into v_cnt_wsdmuffi from w_config where codapp='PG' and chiave='wsdm.stazioneAppaltante' and valore is not null and trim(valore)<>'';
				if (v_cnt_wsdmuffi>0) then
					select valore into config_valore from W_CONFIG where codapp='PG' and chiave='wsdm.stazioneAppaltante';
					INSERT INTO WSDMCONFIUFF(IDCONFI,CODEIN) VALUES(wsdmconfi_id, config_valore);
				end if;

				--Aggiorna riferimento alla configurazione nelle credenziali relative all'integrazione wsdm
				UPDATE WSLOGIN set idconfiwsdm=wsdmconfi_id where servizio='FASCICOLOPROTOCOLLO' or servizio='DOCUMENTALE';

			end if;
		end if;
		
		update w_config set codapp = 'W_' where chiave = 'it.eldasoft.sil.pl.vigilanza.ws.login.comune';
		update w_config set codapp = 'W_' where chiave = 'it.eldasoft.sil.pl.vigilanza.ws.login.utente';
		update w_config set codapp = 'W_' where chiave = 'it.eldasoft.sil.pl.vigilanza.ws.login.password';
		update w_config set codapp = 'W_' where chiave = 'it.eldasoft.sil.pl.vigilanza.ossreg';
		
		update w_config set sezione = null where chiave = 'it.eldasoft.sil.pg.vigilanza.nomeApplicativo' and codapp='PG';
		update w_config set sezione = null where chiave = 'it.eldasoft.sil.pg.vigilanza.ws.url' and codapp='PG';
		
		update w_config set sezione = null where chiave = 'it.eldasoft.inviodaticig.ws.url' and codapp='PG';
		update w_config set sezione = null where chiave = 'it.eldasoft.inviodaticig.nomeApplicativo' and codapp='PG';
		
 		--Definizione tabellati WSDM configurabili
		--IRIDE
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (1,'PG','ruolo','Ruolo utente','IRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (2,'PG','tipodocumento','Tipo documento','IRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (3,'PG','mittenteinterno','Mittente interno','IRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (4,'PG','mezzo','Mezzo invio','IRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (5,'PG','indirizzomittente','Indirizzo mittente','IRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (6,'PG','classificafascicolo','Classifica fascicolo','IRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (7,'PG','livelloriservatezza','Livello di riservatezza','IRIDE',NULL);
		--JIRIDE
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (10,'PG','ruolo','Ruolo utente','JIRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (11,'PG','classifica','Classifica elemento documentale (in assenza di fascicolazione)','JIRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (12,'PG','tipodocumento','Tipo documento','JIRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (13,'PG','mittenteinterno','Mittente interno','JIRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (14,'PG','mezzo','Mezzo invio','JIRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (15,'PG','indirizzomittente','Indirizzo mittente','JIRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (16,'PG','classificafascicolo','Classifica fascicolo','JIRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (17,'PG','tipofascicolo','Tipo fascicolo','JIRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (18,'PG','tipocollegamento','Tipo di collegamento elementi documentali','JIRIDE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (19,'PG','livelloriservatezza','Livello di riservatezza','JIRIDE',NULL);
		--PALEO
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (20,'PG','ruolo','Ruolo utente','PALEO',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (21,'PG','codiceuo','Codice unità organizzativa','PALEO',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (22,'PG','codiceregistro','Codice registro','PALEO',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (23,'PG','classificafascicolo','Classifica fascicolo','PALEO',NULL);
		--ENGINEERING
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (30,'PG','idindice','Indice','ENGINEERING',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (31,'PG','idtitolazione','Classifica elemento documentale','ENGINEERING',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (32,'PG','idunitaoperativamittente','Unità operativa mittente','ENGINEERING',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (33,'PG','idunitaoperativadestinataria','Unità operativa destinataria (protocollo interno)','ENGINEERING',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (34,'PG','classificafascicolo','Classifica fascicolo','ENGINEERING',NULL);
		--ENGINEERINGDOC
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (40,'PG','idunitaoperativamittente','Unità operativa mittente','ENGINEERINGDOC',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (41,'PG','idunitaoperativadestinataria','Unità operativa destinataria','ENGINEERINGDOC',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (42,'PG','idfolder','Identificativo fascicolo','ENGINEERINGDOC',NULL);
		--ARCHIFLOW
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (50,'PG','tipodocumento','Tipo documento','ARCHIFLOW',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (51,'PG','mezzo','Mezzo invio','ARCHIFLOW',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (52,'PG','indirizzomittente','Mittente interno','ARCHIFLOW',NULL);
		--ARCHIFLOWFA
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (60,'PG','mezzo','Mezzo invio','ARCHIFLOWFA',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (61,'PG','mittenteinterno','Mittente interno','ARCHIFLOWFA',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (62,'PG','supporto','Supporto','ARCHIFLOWFA',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (63,'PG','classificafascicolo','Classifica fascicolo','ARCHIFLOWFA',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (64,'PG','tipodocumento','Tipo documento','ARCHIFLOWFA',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (65,'PG','struttura','Struttura','ARCHIFLOWFA',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (66,'PG','indirizzomittente','Mittente interno','ARCHIFLOWFA',NULL);
		--TITULUS
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (70,'PG','mezzo','Mezzo invio','TITULUS',NULL);
		--FOLIUM
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (80,'PG','struttura','Struttura','FOLIUM',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (81,'PG','note','Note','FOLIUM',NULL);
		--EASYDOC
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (90,'PG','classifica','Classifica elemento documentale','EASYDOC',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (91,'PG','channelcode','channelcode','EASYDOC',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (92,'PG','mailchannelcode','mailchannelcode','EASYDOC',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (93,'PG','mailconfigurationcode','mailconfigurationcode','EASYDOC',NULL);
		--PRISMA
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (100,'PG','struttura','Struttura','PRISMA',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (101,'PG','idunitaoperativamittente','Unità operativa mittente','PRISMA',NULL);
		--INFOR
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (110,'PG','codiceregistro','Codice registro','INFOR',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (111,'PG','classificafascicolo','Classifica fascicolo','INFOR',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (112,'PG','idunitaoperativamittente','Unità operativa mittente','INFOR',NULL);
		--URBI
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (120,'PG','tipodocumento','Tipo documento','URBI',NULL);
		--PROTSERVICE
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (130,'PG','classifica','Classifica elemento documentale','PROTSERVICE',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (131,'PG','tipodocumento','Tipo documento','PROTSERVICE',NULL);
		--JPROTOCOL
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (140,'PG','classifica','Classifica elemento documentale','JPROTOCOL',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (141,'PG','classificafascicolo','Classifica fascicolo','JPROTOCOL',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (142,'PG','struttura','Struttura','JPROTOCOL',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (143,'PG','tipoassegnazione','Tipo assegnazione','JPROTOCOL',NULL);
		--ITALPROT
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (150,'PG','classifica','Classifica elemento documentale','ITALPROT',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (151,'PG','tipodocumento','Tipo documento','ITALPROT',NULL);

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1078',8,'Inserimento in gara dopo la fase di prequalifica',NULL,0,NULL);

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1165',1,'Applicata con DL 76/2020(semplificazioni): procedura sottosoglia e numero offerte ammesse inferiore a 10',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1165',2,'Applicata: procedura sottosoglia e numero offerte ammesse superiore o uguale a 10',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1165',3,'Non applicata: procedura sottosoglia e numero offerte ammesse inferiore a 10',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1165',4,'Non applicata: procedura soprasoglia',NULL,0,NULL);

		UPDATE TAB1 SET TAB1DESC='Riparametrazione punteggi subcriteri e criteri' WHERE TAB1COD='A1145' and TAB1TIP=2;
		UPDATE TAB1 SET TAB1DESC='Riparametrazione punteggi sucriteri, criteri e totale' WHERE TAB1COD='A1145' and TAB1TIP=3;

		-- Adeguamento DL.76/2020 semplificazioni - modifica numero inviti per fascia
		update CONFOPECO set NUMMINOP=0 where tipologia=1 and daimporto=40000 and aimporto=150000 and numminop=3;
		update CONFOPECO set NUMMINOP=5 where tipologia=1 and daimporto=150000 and aimporto=350000 and numminop=10;
		update CONFOPECO set NUMMINOP=10 where tipologia=1 and daimporto=350000 and aimporto=1000000 and numminop=15;
		update CONFOPECO set NUMMINOP=15 where tipologia=1 and daimporto=1000000 and aimporto=0;
		update CONFOPECO set aimporto=150000 where tipologia=2 and daimporto=0 and aimporto=40000;
		update CONFOPECO set daimporto=150000 where tipologia=2 and daimporto=40000 and aimporto=214000;
		update CONFOPECO set aimporto=150000 where tipologia=3 and daimporto=0 and aimporto=40000;
		update CONFOPECO set daimporto=150000 where tipologia=3 and daimporto=40000 and aimporto=214000;

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1SORTINV','G1SORTINVD');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SORTINV.TORN.GARE','G1SORTINV','Sorteggio automatico degli operatori da invitare?','Sorteggio invito?','A2',NULL,'SN','Sorteggio automatico ditte da invitare?');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SORTINV.DITG.GARE','G1SORTINVD','Ditta sorteggiata in fase di invito?','Sorteggio invito?','A2',NULL,'SN','Sorteggiata?');

        DELETE FROM C0CAMPI WHERE C0C_MNE_BER ='G1ESCAUTO';
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ESCAUTO.GARE1.GARE','G1ESCAUTO','Applicata esclusione automatica offerte anomale?','Esclus.autom.off.an.','A200','A1165',NULL,'Esclusione automatica offerte anomale');

		UPDATE C0CAMPI SET COC_DES='Num.previsto di operatori da invitare a presentare off.',COC_DES_FRM='Num.operatori invito',COC_DES_WEB='Numero ditte da invitare' WHERE C0C_MNE_BER='G1NUMOPE';
		UPDATE C0CAMPI SET COC_DES='Num.min.previsto di operatori da invitare a presentare off.',COC_DES_FRM='Num.min.operat.inv.',COC_DES_WEB='Num.minimo previsto di operatori' WHERE C0C_MNE_BER='G1MINOPE';
		UPDATE C0CAMPI SET COC_DES='Num.max.previsto di operatori da invitare a presentare off.',COC_DES_FRM='Num.max.operat.inv.',COC_DES_WEB='Num.massimo previsto di operatori' WHERE C0C_MNE_BER='G1MAXOPE';

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FASIRICEZIONE.AttivaDitteDaInvitare','Attiva elenco ditte da invitare',11086);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FASIRICEZIONE.SorteggioInviti','Funzione "Sorteggio inviti"',11089);
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SUBMENU','AMMINISTRAZIONE.Configurazione-VIGILANZA','Configurazione parametri integrazione Vigilanza',13280);

        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.InserisciDocDaProtocollo','Inserimento documenti da protocollo (TITULUS)',14440);
                
		DELETE from W_AZIONI WHERE TIPO='COLS' AND AZIONE='VIS' AND OGGETTO = 'GARE.TORN.NUMOPE';
                
		update eldaver set numver = '8.10.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.10.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.10.%') THEN

		CREATE TABLE NSO_ALLEGATI (
			ID NUMERIC(12) NOT NULL,
			NSO_ORDINI_ID NUMERIC(12),
			NPROGR NUMERIC(7) NOT NULL,
			TIPODOC NUMERIC(7),
			DESCRIZIONE VARCHAR(2000),
			IDPRG VARCHAR(2),
			IDDOCDIG NUMERIC(12),
			DATARILASCIO TIMESTAMP,
			DURATA NUMERIC(7),
			DATASCADENZA TIMESTAMP,
			STATODOC NUMERIC(7),
			MODFIRMA NUMERIC(7),
			URLDOC VARCHAR(2000),
			ISARCHI VARCHAR(1),
			primary key(ID));

		ALTER TABLE NSO_ALLEGATI ADD CONSTRAINT FK_NSO_ALLEGATI_NSO_ORDINI FOREIGN KEY (NSO_ORDINI_ID) REFERENCES NSO_ORDINI(ID) ON DELETE CASCADE;
		
		ALTER TABLE NSO_LINEE_ORDINI ADD ESENZIONE_IVA VARCHAR(20);
		
		DROP TABLE NSO_WS_ORDINI CASCADE;
		
		CREATE TABLE NSO_WS_ORDINI(
				ID NUMERIC(12) NOT NULL,
				CODORD VARCHAR(10) NOT NULL,	
				DATA_ORDINE VARCHAR(20) NOT NULL,
				NOME_FILE VARCHAR(500),
				IDT VARCHAR(200),
				ENDPOINT VARCHAR(20),
				DATA_SCADENZA TIMESTAMP,
				DATA_RICEZIONE_NSO TIMESTAMP,
				TIPO_COMUNICAZIONE VARCHAR(20),
				PRESENZA_ALLEGATI NUMERIC(1,0),
				ORDINE_PADRE VARCHAR(10),
				ORDINE_PADRE_ID NUMERIC(12),
				ID_ORDINE NUMERIC(12),
				ORDINE_ORIGINARIO_ID NUMERIC(12),
				ORDINE_ORIGINARIO VARCHAR(10),
				STATO_CORRENTE_COMUNICAZIONE NUMERIC (12), 
				STATO_CORRENTE_ORDINE NUMERIC (12), 
				CODIMP_FORNITORE VARCHAR(10),
				UFFINT VARCHAR(16),
				CIG VARCHAR(10),
				NGARA VARCHAR(20),
				IMPORTO_TOTALE NUMERIC(24,5)
				);
				
		ALTER TABLE NSO_WS_ORDINI ADD XML_FILE BYTEA;

		ALTER TABLE NSO_WS_ORDINI  ADD PRIMARY KEY (ID);
		CREATE SEQUENCE SEQ_NSO_WS_ORDINI_PK START WITH 1 INCREMENT BY 1  NO CYCLE;
		
		CREATE TABLE NSO_WS_STATO_COMUNICAZIONE (
			ID NUMERIC(12) NOT NULL,
			CODICE VARCHAR(2) NOT NULL,
			DESCRIZIONE VARCHAR(50) NOT NULL,
			PRIMARY KEY (ID)
		);
		
		--creazione tabella per le risposte alle comunicazioni
		CREATE TABLE NSO_WS_COMUNICAZIONI (
			IDT VARCHAR (255), -- LINK TO NSO_WS_ORDINI
			DATA_RICEZIONE TIMESTAMP, -- LINK TO NSO_WS_ORDINI
			STATO_COMUNICAZIONE NUMERIC (12), -- LINK TO NSO_WS_STATO_COMUNICAZIONE
			ORDINE_COLLEGATO VARCHAR (50), -- CODORD#DATA_ORDINE#ENDPOINT
			NOME_FILE VARCHAR (255)
		);
		-- AGGIUNTA BYTE[] PER CORPO COMUNICAZIONE
		ALTER TABLE NSO_WS_COMUNICAZIONI ADD COLUMN XML_FILE_B64 BYTEA;
		ALTER TABLE NSO_WS_COMUNICAZIONI  ADD PRIMARY KEY (IDT,STATO_COMUNICAZIONE);
		
		CREATE TABLE NSO_WS_STATO_ORDINE(
			ID NUMERIC(12) NOT NULL,
			DESCRIZIONE VARCHAR(50),
			ID_APPALTI NUMERIC(12),
			ID_PROSSIMO_STATO NUMERIC(12),
			PRIMARY KEY (ID)
		);
		
		CREATE TABLE NSO_WS_RISP_NSO_LOG (
		  ID NUMERIC(12) NOT NULL,
		  IDT VARCHAR (255),
		  NOME_FILE VARCHAR (255),
		  DATA_RICEZIONE TIMESTAMP,
		  IS_PROCESSED NUMERIC (1)
		 );
		ALTER TABLE NSO_WS_RISP_NSO_LOG ADD COLUMN XML_FILE_B64 BYTEA;
		ALTER TABLE NSO_WS_RISP_NSO_LOG  ADD PRIMARY KEY (ID);
		CREATE SEQUENCE SEQ_NSO_WS_IN_RESP_LOG_PK START WITH 1 INCREMENT BY 1  NO CYCLE;

		CREATE TABLE NSO_WS_TMP_RSP (
			 IDT VARCHAR(200) NOT NULL,
			 REC_TIME VARCHAR(200),
			 ERROR_CODE VARCHAR(50),
			 CODE VARCHAR(50)
		 );
		 ALTER TABLE NSO_WS_TMP_RSP  ADD PRIMARY KEY (IDT);


		ALTER TABLE TORN ADD GARPRIV VARCHAR(1);
		ALTER TABLE DITG ADD RIBOEPV NUMERIC(24,9);
		
		update eldaver set numver = 'M1.8.11.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M1.8.11.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$

BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M1.8.11.0') THEN
	
		-- Allinea il nuovo campo 'Ribasso OEPV' con il valore dell'eventuale criterio di valutazione 'Offerta espressa mediante ribasso'
		update ditg set riboepv=(select valnum*-1 from g1crival,g1cridef where g1crival.idcridef=g1cridef.id and formato=51 and g1crival.ngara=ditg.ngara5 and g1crival.dittao=ditg.dittao) where riboepv is null;

		--Gare privatistiche
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1166',1,'Gara di vendita',NULL,NULL,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1166',2,'Gara di acquisto',NULL,NULL,NULL);

		-- inserts NSO
		insert into NSO_WS_STATO_ORDINE VALUES (1,'inviato nso da BO',4,2);
		insert into NSO_WS_STATO_ORDINE VALUES (2,'in attesa conferma fornitore',5,null);
		insert into NSO_WS_STATO_ORDINE VALUES (3,'inviata conferma nso da FO',null,6);
		insert into NSO_WS_STATO_ORDINE VALUES (4,'inviato rifiuto nso da FO',null,8);
		insert into NSO_WS_STATO_ORDINE VALUES (5,'inviata modifica nso da FO',null,9);
		insert into NSO_WS_STATO_ORDINE VALUES (6,'accettato',6,null);
		insert into NSO_WS_STATO_ORDINE VALUES (7,'accettato automaticamente',6,null);
		insert into NSO_WS_STATO_ORDINE VALUES (8,'rifiutato',7,null);
		insert into NSO_WS_STATO_ORDINE VALUES (9,'accettato con modifiche',null,null);--futura

		insert into NSO_WS_STATO_COMUNICAZIONE VALUES (1,'CN','in carico nso');--stato fittizzio
		insert into NSO_WS_STATO_COMUNICAZIONE VALUES (2,'OS','scartato nso');
		insert into NSO_WS_STATO_COMUNICAZIONE VALUES (3,'OC','consegnato nso');
		insert into NSO_WS_STATO_COMUNICAZIONE VALUES (4,'OM','errore temporaneo nso');
		insert into NSO_WS_STATO_COMUNICAZIONE VALUES (5,'OA','processato, ma non consegnato nso');
		
		--	Modulo NSO Ordini: Allegati NSO
		INSERT INTO c0entit (c0e_nom, c0e_num, c0e_tip, coe_arg, c0e_des, c0e_key, c0e_nom_ex, coe_key_ex, c0e_frm_ri, coe_frm_ca, coe_frm_re) VALUES ('NSO_ALLEGATI.GARE', 0, 'E', 'ALLE_NSO', 'Allegati', 'NSO_ORDINI_ID.NSO_ALLEGATI.GARE', 'NSO_ORDINI.GARE', 'ID.NSO_ORDINI', 'g_nsoal2', 'g_nsoal1', 'g_nsoal0');
		--	Allegati NSO
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', 'P', 'ID.NSO_ALLEGATI.GARE', 'NSO_AL_ID', 'Id', 'Id', 'N12', NULL, NULL, NULL);
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'NSO_ORDINI_ID.NSO_ALLEGATI.GARE', 'NSO_AL_ORDID', 'Id ordine', 'Id ordine', 'N12', NULL, NULL, 'Id ordine');
		INSERT INTO c0campi (coc_conta, c0c_tip, c0c_chi, coc_mne_uni, c0c_mne_ber, coc_des, coc_des_frm, c0c_fs, c0c_tab1, coc_dom, coc_des_web) VALUES (0, 'E', NULL, 'NPROGR.NSO_ALLEGATI.GARE', 'NSO_AL_NPROGR', 'Num. progr. allegato', 'N.progr.allegato', 'N7', NULL, NULL, 'Num. progr. allegato');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'TIPODOC.NSO_ALLEGATI.GARE','NSO_AL_TIPODOC','Tipo di documentazione','Tipo documentazione','A100','A1057',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DESCRIZIONE.NSO_ALLEGATI.GARE','NSO_AL_DESCR','Descrizione allegato','Descrizione','A2000', NULL, NULL, NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDPRG.NSO_ALLEGATI.GARE','NSO_AL_IDPRG','Codice applicativo (riferimento ad arch.documenti digitali)','Codice applicativo','A2',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDDOCDIG.NSO_ALLEGATI.GARE','NSO_AL_IDDOCDIG','ID documento (riferimento ad arch.documenti digitali)','Codice documento','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DATARILASCIO.NSO_ALLEGATI.GARE','NSO_AL_DATRIL','Data pubblicazione','Data pubblicazione','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'C',NULL,'DURATA.NSO_ALLEGATI.GARE','NSO_AL_DURATA','Durata del doc per stabilire la scadenza (in gg.)','Durata','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'C',NULL,'DATASCADENZA.NSO_ALLEGATI.GARE','NSO_AL_DATSCAD','Data scadenza validità documento','Data scadenza','A10',NULL,'DATA_ELDA',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'STATODOC.NSO_ALLEGATI.GARE','NSO_AL_STODOC','Stato del documento (pubblicato, da pubblicare, bozza)','Stato doc.','A100','A1061',NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'MODFIRMA.NSO_ALLEGATI.GARE','NSO_AL_MODFIRMA','Formato del documento','Formato documento','A100','A1105',NULL,'Formato del documento');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'URLDOC.NSO_ALLEGATI.GARE','NSO_AL_URLDOC','URL di pubblicazione del documento','URL di pubblicazione','A2000',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ISARCHI.NSO_ALLEGATI.GARE','NSO_AL_ISARCHI','Documento archiviato o superato ?','Doc. archiviato?','A2',NULL,'SN',NULL);
		
		delete from C0CAMPI where C0C_MNE_BER in ('NSO_ORD_ESECIG','NSO_LO_ESEIVA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'ESENZIONE_CIG.NSO_ORDINI.GARE','NSO_ORD_ESECIG','Esenzione CIG','Esenzione CIG','A20',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB)	VALUES (0,'E',NULL,'ESENZIONE_IVA.NSO_LINEE_ORDINI.GARE','NSO_LO_ESEIVA','Esenzione IVA','Esenzione IVA','A20',NULL,NULL,NULL);
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1GARPRIV');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'GARPRIV.TORN.GARE','G1GARPRIV','Gara privatistica di vendita o di acquisto?','Gara privatistica?','A200','A1166',NULL,NULL);

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1RIBOEPV');
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'RIBOEPV.DITG.GARE','G1RIBOEPV','Ribasso offerto presentato dalla ditta (solo proc.OEPV)','Ribasso off. OEPV','F13.9',NULL,NULL,NULL);
	        
        INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('NSO_ALLEGATI',0);

		--Dismesso property per attivare task di controllo scadenza iscrizioni
		if (select count(*)=0 from w_config where codapp='PG' and chiave='it.eldasoft.sil.pg.controlloScadenzaIscrizioniElencoCatalogo' and trim(valore)='1') then
			if (select count(*)=0 from w_quartz where codapp='PG' and bean_id='controlloIscrizioniAElencoScaduteManagerTrigger' and cron_year='2099') then
				update w_quartz set cron_year='2099',cron_expression=cron_expression || ' 2099' where codapp='PG' and bean_id='controlloIscrizioniAElencoScaduteManagerTrigger';
			end if;
		end if;
		update w_config set sezione = null where codapp='PG' and chiave='it.eldasoft.sil.pg.controlloScadenzaIscrizioniElencoCatalogo';

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GarePrivateVendita','Gestione gare privatistiche di vendita',14600); 
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GarePrivateAcquisto','Gestione gare privatistiche di acquisto',14610); 
                
        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.AttivaDicituraAffidamenti','Attiva diciture specifiche per gli affidamenti',2067); 

		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('FUNZ','VIS','ALT.GARE.GarePrivateAcquisto','Visualizza',0,1,1,2681046106);
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('FUNZ','VIS','ALT.GARE.GarePrivateVendita','Visualizza',0,1,1,72154054);
		
		INSERT INTO W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('FUNZ','VIS','ALT.GARE.AttivaDicituraAffidamenti','Visualizza',0,1,1,1552824487);

		delete from W_NOTE where tipo = 2 and oggetto = 'GENEWEB.W_CONFCOM-scheda' and prog >= 0;
        INSERT INTO W_NOTE (TIPO,OGGETTO,PROG,MODOVIS,NOTA) values ( 2, 'GENEWEB.W_CONFCOM-scheda', 0,'3','Si riporta di seguito la lista dei mnemonici che possono essere utilizzati nell''oggetto e nel testo del modello di comunicazione.<br>Tali mnemonici devono essere riportati tra # per essere identificati.<br><br><b>Mnemonici per le comunicazioni inserite dalla pagina ''Dati generali'' di gare,elenchi o avvisi</b>:<br>CODGAR&nbsp;&nbsp;Codice gara divisa in lotti<br>NGARA&nbsp;&nbsp;Codice gara,elenco o avviso<br>CODIGA&nbsp;&nbsp;N.lotto<br>G1CODCIG&nbsp;&nbsp;Codice CIG<br>OGGETA&nbsp;&nbsp;Oggetto gara o lotto<br>G1DESTOR&nbsp;&nbsp;Oggetto gara divisa in lotti<br>OGGETTOGA&nbsp;&nbsp;Oggetto elenco operatori o catalogo<br>DTEPAR&nbsp;&nbsp;Data termine richiesta partecipaz.<br>OTEPAR&nbsp;&nbsp;Ora termine richiesta partecipaz.<br>DTEOFF&nbsp;&nbsp;Data termine presentaz.offerta<br>OTEOFF&nbsp;&nbsp;Ora termine presentaz.offerta<br>DESOFF&nbsp;&nbsp;Data apertura offerte<br>OESOFF&nbsp;&nbsp;Ora apertura offerte<br>DATAOGGI&nbsp;&nbsp;Data corrente<br>NOMTECRUP&nbsp;&nbsp;Nome RUP<br>CFTECRUP&nbsp;&nbsp;Codice fiscale RUP<br><div><br></div><div><b>Mnemonici per le comunicazioni inserite dalla lista operatori in gara o elenco</b>:</div>G1NPROGG&nbsp;&nbspN.pres.offerta<br>G1NUMORDPL&nbsp;&nbspN.presentazione rich.partecipaz.<br>DITTAO&nbsp;&nbsp;Codice operatore<br>NOMIMP&nbsp;&nbsp;Ragione sociale operatore<br>CFIMP&nbsp;&nbsp;Codice fiscale operatore<br>PIVIMP&nbsp;&nbsp;Partita Iva operatore<br>G_DTRISOA&nbsp;&nbsp;Data scadenza SOA triennale<br>G_DSCANC&nbsp;&nbsp;Data scadenza SOA quinquennale');
        INSERT INTO W_NOTE (TIPO,OGGETTO,PROG,MODOVIS,NOTA) values ( 2, 'GENEWEB.W_CONFCOM-scheda', 0,'2','Si riporta di seguito la lista dei mnemonici che possono essere utilizzati nell''oggetto e nel testo del modello di comunicazione.<br>Tali mnemonici devono essere riportati tra # per essere identificati.<br><br><b>Mnemonici per le comunicazioni inserite dalla pagina ''Dati generali'' di gare,elenchi o avvisi</b>:<br>CODGAR&nbsp;&nbsp;Codice gara divisa in lotti<br>NGARA&nbsp;&nbsp;Codice gara,elenco o avviso<br>CODIGA&nbsp;&nbsp;N.lotto<br>G1CODCIG&nbsp;&nbsp;Codice CIG<br>OGGETA&nbsp;&nbsp;Oggetto gara o lotto<br>G1DESTOR&nbsp;&nbsp;Oggetto gara divisa in lotti<br>OGGETTOGA&nbsp;&nbsp;Oggetto elenco operatori o catalogo<br>DTEPAR&nbsp;&nbsp;Data termine richiesta partecipaz.<br>OTEPAR&nbsp;&nbsp;Ora termine richiesta partecipaz.<br>DTEOFF&nbsp;&nbsp;Data termine presentaz.offerta<br>OTEOFF&nbsp;&nbsp;Ora termine presentaz.offerta<br>DESOFF&nbsp;&nbsp;Data apertura offerte<br>OESOFF&nbsp;&nbsp;Ora apertura offerte<br>DATAOGGI&nbsp;&nbsp;Data corrente<br>NOMTECRUP&nbsp;&nbsp;Nome RUP<br>CFTECRUP&nbsp;&nbsp;Codice fiscale RUP<br><div><br></div><div><b>Mnemonici per le comunicazioni inserite dalla lista operatori in gara o elenco</b>:</div>G1NPROGG&nbsp;&nbspN.pres.offerta<br>G1NUMORDPL&nbsp;&nbspN.presentazione rich.partecipaz.<br>DITTAO&nbsp;&nbsp;Codice operatore<br>NOMIMP&nbsp;&nbsp;Ragione sociale operatore<br>CFIMP&nbsp;&nbsp;Codice fiscale operatore<br>PIVIMP&nbsp;&nbsp;Partita Iva operatore<br>G_DTRISOA&nbsp;&nbsp;Data scadenza SOA triennale<br>G_DSCANC&nbsp;&nbsp;Data scadenza SOA quinquennale');

		-- (S.Santi 13.08.2020) Aggiunto filtro per escludere dall'adempimento L.190/2012 le gare privatistiche di vendita e di acquisto
		perform sp_backupanddropviews('v_dati_lotti_completa');
		IF exists (select tablename from pg_tables where upper(tablename) = 'APPA') THEN
				EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
				with pubblicazioni 
				 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
				select gare.ngara lotto,
				   gare.codcig cig,
				   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
				   uff.codein codiceprop,
				   uff.cfein codfiscprop,
				   uff.nomein denomprop,
				   not_gar oggetto,
				   tipgarg,
				   iterga,
				   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
					else gc.impqua end impaggiudic,
				   torn.dinvit,
				   ditta aggiudicataria,
				   gare.esineg,
				   gare.datneg,
				   gare.dattoa,
				   torn.altrisog,
				   torn.accqua,
				   gare1.aqoper,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
						when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
					   else gc.dverbc end datainizio,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
						when (gare.clavor is not null or gare.numera is not null) then appa.dult
					   else gc.dcertu end dataultimazione,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
						when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
					   else gc.impliq end impsommeliq,
				   torn.dteoff,
				   tecni.cftec codfisresp,
				   tecni.nomtec nomeresp
				 from gare
				 inner join torn on torn.codgar=gare.codgar1
				 inner join gare1 on gare1.ngara=gare.ngara
						 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
				 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
				 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20))) and gare.preced is null and torn.garpriv is null
			   union
				select gare.ngara lotto,
				   gare.codcig cig,
				   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
				   uff.codein codiceprop,
				   uff.cfein codfiscprop,
				   uff.nomein denomprop,
				   not_gar oggetto,
				   tipgarg,
				   iterga,
				   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
					else gc.impqua end impaggiudic,
				   torn.dinvit,
				   ditta aggiudicataria,
				   gare.esineg,
				   gare.datneg,
				   gare.dattoa,
				   torn.altrisog,
				   torn.accqua,
				   gare1.aqoper,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
						when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
					   else gc.dverbc end datainizio,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
						when (gare.clavor is not null or gare.numera is not null) then appa.dult
					   else gc.dcertu end dataultimazione,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
						when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
					   else gc.impliq end impsommeliq,
				   torn.dteoff,
				   tecni.cftec codfisresp,
				   tecni.nomtec nomeresp
				 from gare
				 inner join torn on torn.codgar=gare.codgar1
				 inner join gare1 on gare1.ngara=gare.ngara
						 left outer join pubblicazioni on pubblicazioni.codgar9=torn.codgar
				 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
				 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1) and torn.garpriv is null
			   union
				 select gare.ngara lotto,
					gare.codcig cig,
					null datpub,
					uff.codein codiceprop,
					uff.cfein codfiscprop,
					uff.nomein denomprop,
					gare.not_gar oggetto,
					gare.tipgarg,
					null iterga,
					iaggiu impaggiudic,
					null dinvit,
					ditta aggiudicataria,
					null esineg,
					null datneg,
					gare.daatto dattoa,
					null altrisog,
					null accqua,
					null aqoper,
					gc.dverbc datainizio,
					gc.dcertu dataultimazione,
					gc.impliq impsommeliq,
					torn.dteoff,
					tecni.cftec codfisresp,
					tecni.nomtec nomeresp
				 from gare inner join torn on (gare.codgar1=torn.codgar)
				 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 where gare.genere=4';
			else
				EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
				with pubblicazioni 
				 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
				select gare.ngara lotto,
				   codcig cig,
				   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
				   uff.codein codiceprop,
				   uff.cfein codfiscprop,
				   uff.nomein denomprop,
				   not_gar oggetto,
				   tipgarg,
				   iterga,
				   case when (torn.accqua is null or torn.accqua <>''1'') then
						iaggiu 
					  else gc.impqua end impaggiudic,
				   torn.dinvit,
				   ditta aggiudicataria,
				   gare.esineg,
				   gare.datneg,
				   gare.dattoa,
				   torn.altrisog,
				   torn.accqua,
				   gare1.aqoper,
				   gc.dverbc datainizio,
				   gc.dcertu dataultimazione,
				   gc.impliq impsommeliq,
				   torn.dteoff,
				   tecni.cftec codfisresp,
				   tecni.nomtec nomeresp
				from gare
				 inner join torn on torn.codgar=gare.codgar1
				 inner join gare1 on gare1.ngara=gare.ngara
						 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
				 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20))) and gare.preced is null and torn.garpriv is null
			  union
				select gare.ngara lotto,
				   codcig cig,
				   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
				   uff.codein codiceprop,
				   uff.cfein codfiscprop,
				   uff.nomein denomprop,
				   not_gar oggetto,
				   tipgarg,
				   iterga,
				   case when (torn.accqua is null or torn.accqua <>''1'') then
						iaggiu 
					  else gc.impqua end impaggiudic,
				   torn.dinvit,
				   ditta aggiudicataria,
				   gare.esineg,
				   gare.datneg,
				   gare.dattoa,
				   torn.altrisog,
				   torn.accqua,
				   gare1.aqoper,
				   gc.dverbc datainizio,
				   gc.dcertu dataultimazione,
				   gc.impliq impsommeliq,
				   torn.dteoff,
				   tecni.cftec codfisresp,
				   tecni.nomtec nomeresp
				from gare
				 inner join torn on torn.codgar=gare.codgar1
				 inner join gare1 on gare1.ngara=gare.ngara
						 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
				 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1) and torn.garpriv is null
			   union
				select gare.ngara lotto,
					gare.codcig cig,
					null datpub,
					uff.codein codiceprop,
					uff.cfein codfiscprop,
					uff.nomein denomprop,
					gare.not_gar oggetto,
					gare.tipgarg,
					null iterga,
					iaggiu impaggiudic,
					null dinvit,
					ditta aggiudicataria,
					null esineg,
					null datneg,
					gare.daatto dattoa,
					null altrisog,
					null accqua,
					null aqoper,
					gc.dverbc datainizio,
					gc.dcertu dataultimazione,
					gc.impliq impsommeliq,
					torn.dteoff,
					tecni.cftec codfisresp,
					tecni.nomtec nomeresp
				 from gare inner join torn on (gare.codgar1=torn.codgar)
				 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 where gare.genere=4';
			end if;
		perform sp_restoreviews('v_dati_lotti_completa');

		
		update eldaver set numver = '8.11.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '8.11.0', datvet = now() where codapp = 'G1';
		
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

		
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '8.11.%') THEN
		
		CREATE TABLE G1CRIVALCOM (
		  ID NUMERIC(12) NOT NULL,
		  IDCRIVAL NUMERIC(12),
		  IDGFOF NUMERIC(12),
		  IDCRIDEF NUMERIC(12),
		  COEFFI NUMERIC(24,9),
		  primary key(ID));
		ALTER TABLE G1CRIVALCOM ADD CONSTRAINT FK_G1CRIVALCOM_G1CRIVAL FOREIGN KEY ( IDCRIVAL) REFERENCES G1CRIVAL( ID ) ON DELETE CASCADE;
		
		ALTER TABLE TORN ADD PRERIB NUMERIC(2);
		
		perform sp_backupanddropviews('g1crireg');
		ALTER TABLE G1CRIREG ALTER COLUMN PUNTUALE TYPE VARCHAR(200);
		perform sp_restoreviews('g1crireg');

		ALTER TABLE DITG ADD DSORTEV TIMESTAMP;
		ALTER TABLE DITG ADD ACQAUTO VARCHAR(1);
		
		ALTER TABLE GFOF ADD ESPGIU VARCHAR(1);
		ALTER TABLE GFOF ADD ID NUMERIC(12);

		ALTER TABLE GARPRO_WSDM ADD SOTTOTIPO VARCHAR(100);
		ALTER TABLE GARPRO_WSDM ALTER COLUMN OGGETTO_MAIL TYPE VARCHAR(2000);
		ALTER TABLE GARDOC_JOBS ADD SOTTOTIPO VARCHAR(100);

		--RECREATION OF TABLE NSO_WS_ORDINI FORGOT ONE FIELD
		DROP TABLE NSO_WS_ORDINI;
		CREATE TABLE NSO_WS_ORDINI(
				ID NUMERIC(12) NOT NULL,
				CODORD VARCHAR(10) NOT NULL,	
				DATA_ORDINE VARCHAR(20) NOT NULL,
				NOME_FILE VARCHAR(500),
				IDT VARCHAR(200),
				ENDPOINT VARCHAR(20),
				DATA_SCADENZA TIMESTAMP,
				DATA_RICEZIONE_NSO TIMESTAMP,
				TIPO_COMUNICAZIONE VARCHAR(20),
				PRESENZA_ALLEGATI NUMERIC(1,0),
				ORDINE_PADRE VARCHAR(10),
				ORDINE_PADRE_ID NUMERIC(12),
				ID_ORDINE NUMERIC(12),
				ORDINE_ORIGINARIO_ID NUMERIC(12),
				ORDINE_ORIGINARIO VARCHAR(10),
				STATO_CORRENTE_COMUNICAZIONE NUMERIC (12), 
				STATO_CORRENTE_ORDINE NUMERIC (12), 
				CODIMP_FORNITORE VARCHAR(10),
				UFFINT VARCHAR(16),
				CIG VARCHAR(10),
				NGARA VARCHAR(20),
				IMPORTO_TOTALE NUMERIC(24,5),
				DATA_LIMITE_MOD TIMESTAMP
				);
				
		ALTER TABLE NSO_WS_ORDINI ADD XML_FILE BYTEA;

		ALTER TABLE NSO_WS_ORDINI  ADD PRIMARY KEY (ID);


		update eldaver set numver = 'M1.9.0.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M1.9.0.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();


CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
	gfof_pk varchar(2000);
	new_id numeric(12) := 0;
  
	gfof_ngara2 varchar(20);
	gfof_codfof varchar(10);
	gfof_incfof numeric(7);
	gfof_numcomm numeric(7);
	ciclo_gfof cursor for select ngara2,codfof,incfof,numcomm from gfof where id is null order by ngara2,codfof; 
  
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M1.9.0.0') THEN

		open ciclo_gfof;
		loop
			fetch ciclo_gfof into gfof_ngara2, gfof_codfof, gfof_incfof, gfof_numcomm;
			if not found then
				exit;
			end if;
			new_id := new_id + 1;
			update gfof set id = new_id where ngara2 = gfof_ngara2 and codfof = gfof_codfof and incfof = gfof_incfof and numcomm = gfof_numcomm;
		end loop;
		close ciclo_gfof;	
		
		if (select count(*) = 0  from gfof where id is null or id=0) then
			ALTER TABLE gfof ALTER COLUMN ID SET NOT NULL;
			select constraint_name into gfof_pk from information_schema.table_constraints where upper(table_name) = 'GFOF' and constraint_type='PRIMARY KEY';
			if (gfof_pk is not NULL) and (length(gfof_pk) > 0) then
				EXECUTE ('ALTER TABLE gfof DROP CONSTRAINT '||gfof_pk);
				ALTER TABLE gfof ADD PRIMARY KEY (ID);
			end if;
		end if;
		
		insert into w_genchiavi (tabella, chiave) values('GFOF',new_id);
		update gfof set espgiu = '2' where indisponibilita = '1';	

		update eldaver set numver = 'M2.9.0.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M2.9.0.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M2.9.0.0') THEN

		--- L190 ---------------------
		delete from W_TAGS where CODAPP = 'PG' and TAGCOD = 'L190';
		delete from W_TAGSLIST where CODAPP = 'PG' and TAGCOD = 'L190';

		Insert into W_TAGS (CODAPP,TAGCOD,TAGVIEW,TAGDESC,TAGCOLOR,TAGBORDERCOLOR,TAGMOD,TAGVIS,TAGPROFILI) values ('PG','L190','L190','Dati richiesti per l''adempimento L. 190/2012 (XML ANAC)','#ffcc99','#ff0000',null,'1','PG_GARE,PG_GARE_AFFIDA,PG_GARE_ANTICOR,PG_GARE_ODA_ALICE,PG_GARE_RDO_ALICE');

		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','UFFINT','NOMEIN', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','UFFINT','CFEIN', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','TECNI','CFTEC','Non è un dato pubblicato, ma utilizzato internamente all''Amministrazione per report o filtri sui dati da pubblicare (facoltativo)',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','TECNI','NOMTEC','Non è un dato pubblicato, ma utilizzato internamente all''Amministrazione per report o filtri sui dati da pubblicare (facoltativo)',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','GARE','NOT_GAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','GARE','CODCIG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','GARE','IAGGIU', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','GARE','TIPGARG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','GARE','NOMIMA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','TORN','CENINT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','TORN','CODRUP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','TORN','TIPGAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','TORN','DINVIT','Dato utilizzato per determinare lo stato della procedura',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','TORN','DTEOFF','Dato utilizzato per determinare lo stato della procedura e la visibilità pubblica dell''elenco dei concorrenti',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','GARECONT','DCERTU', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','GARECONT','DVERBC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','GARECONT','IMPLIQ', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','GARECONT','IMPQUA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','GARE','DATTOA','Dato utilizzato per determinare lo stato della procedura e l''anno di riferimento',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','GARE','DATNEG','Dato utilizzato per determinare lo stato della procedura e l''anno di riferimento',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','PUBBLI','DATPUB','Dato utilizzato per determinare lo stato della procedura e l''anno di riferimento',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','DITG','NOMIMO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','RAGIMP','IMPMAN', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','RAGIMP','NOMDIC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','IMPR','NOMEST', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','IMPR','CFIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','IMPR','PIVIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','IMPR','NOMIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','L190','IMPR','TIPIMP','Utilizzato per determinare se si tratta di raggruppamento di concorrenti',null);

		--- LFS ---------------------
		delete from W_TAGS where CODAPP = 'PG' and TAGCOD = 'LFS';
		delete from W_TAGSLIST where CODAPP = 'PG' and TAGCOD = 'LFS';

		Insert into W_TAGS (CODAPP,TAGCOD,TAGVIEW,TAGDESC,TAGCOLOR,TAGBORDERCOLOR,TAGMOD,TAGVIS,TAGPROFILI) values ('PG','LFS','LFS','LFS - Trasferimento a seguito di esecuzione contratto','#9AFFAB','#800000',null,'1','PG_GARE,PG_GARE_AFFIDA');

		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','TORN','TIPGEN', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','TORN','NUMAVCP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','TORN','CODCIGAQ', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','TORN','NAVVIG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','TORN','DESOFF', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','TORN','TIPGAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','TORN','CENINT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','UFFINT','NOMEIN', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','CLAVOR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','NUMERA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','CODCIG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','DACQCIG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','NOMIMA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','TIPGARG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','CRITLICG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','DETLICG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','DVERAG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','TATTOA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','NATTOA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','DATTOA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','DCOMAG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','NCOMAG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','RIBAGG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','TIATTO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','NREPAT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','DAATTO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','IAGGIU', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','RIDISO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','IMPGAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','NQUIET', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','DQUIET', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','ISTCRE', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','INDIST', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARECONT','IMPQUA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARECONT','LREGCO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARECONT','NREGCO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARECONT','DREGCO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARECONT','NUMCONT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARECONT','DSCAPO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARECONT','DCONSD', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARECONT','COORBA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARECONT','CODBIC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARECONT','BANAPP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','IMPAPP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','IMPSIC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','IMPSMI', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','IMPSCO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','IMPCOR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','IMPMIS', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','IMPNRL', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','IMPNRM', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','IMPNRC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','ONPRGE', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','ONSOGRIB', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','NOT_GAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','NUMSSL', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','NOMSSL', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','PROSLA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','LOCLAV', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','LOCINT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','TEUTIL', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','TEMESI', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','CUPPRG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','CODCUI', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','TATTOG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','NATTOG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARE','DATTOG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','GARCPV','CODCPV', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','CATG','CATIGA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','OPES','CATOFF', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','DITG','RICSUB', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','LFS','IMPR','NOMEST', null,null);

		--- CC --------------------
		delete from W_TAGS where CODAPP = 'PG' and TAGCOD = 'CC';
		delete from W_TAGSLIST where CODAPP = 'PG' and TAGCOD = 'CC';

		Insert into W_TAGS (CODAPP,TAGCOD,TAGVIEW,TAGDESC,TAGCOLOR,TAGBORDERCOLOR,TAGMOD,TAGVIS,TAGPROFILI) values ('PG','CC','art.15','DLgs n. 33/2013 art.15, cc. 1,2 - Consulenti e Collaboratori','#99cc00','#800000',null,'1','PG_GARE,PG_GARE_AFFIDA,PG_GARE_ANTICOR');

		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','TORN','DESTOR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','TORN','TIPGAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','GARE','NOT_GAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','GARE','TIPGARG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','GARE','CODCIG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','GARE','DAATTO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','GARE','NREPAT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','GARE','IAGGIU', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','GARE','NOMIMA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','IMPR','NOMEST', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','IMPR','CFIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','IMPR','PIVIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','GARECONT','RAGCONS', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','GARECONT','VARCONS', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','GARECONT','DVERBC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','CC','GARECONT','DCERTU', null,null);

		---- BDAP ---------------------
		delete from W_TAGS where CODAPP = 'PG' and TAGCOD = 'BDAP';
		delete from W_TAGSLIST where CODAPP = 'PG' and TAGCOD = 'BDAP';

		Insert into W_TAGS (CODAPP,TAGCOD,TAGVIEW,TAGDESC,TAGCOLOR,TAGBORDERCOLOR,TAGMOD,TAGVIS,TAGPROFILI) values ('PG','BDAP','BDAP','BDAP / MEF - Dati DL229','#99ccff','#800000',null,'1','PG_GARE,PG_GARE_AFFIDA,PG_GARE_RDO_ALICE');

		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','TORN','DESOFF', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','TORN','DTEOFF', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','TORN','DTEPAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','TORN','DINVIT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','TORN','CODRUP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','NOT_GAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','CODCIG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','DACQCIG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','CRITLICG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','TIPGARG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','IMPAPP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','DVPROV', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','NOMIMA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','RIBAGG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP',null,'RIBASSO_AGGIUD', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','IAGGIU', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','DATTOA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','CLAVOR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','NUMERA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','IMPR','CFIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','IMPR','NOMEST', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','IMPR','CODATT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','IMPR','CODCIT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','IMPR','NATGIUI', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','IMPR','CAPIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','IMPR','INDIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','IMPR','LOCIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','IMPR','NCIIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','IMPR','PROIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','IMPR','CLADIM', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP',null,'PERSDIP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','BDAP','GARE','DITTAP', null,null);

		---- ANAC ----------------------
		delete from W_TAGS where CODAPP = 'PG' and TAGCOD = 'ANAC';
		delete from W_TAGSLIST where CODAPP = 'PG' and TAGCOD = 'ANAC';

		Insert into W_TAGS (CODAPP,TAGCOD,TAGVIEW,TAGDESC,TAGCOLOR,TAGBORDERCOLOR,TAGMOD,TAGVIS,TAGPROFILI) values ('PG','ANAC','ANAC','ANAC - Schede Simog / Osservatorio','#ffcc00','#800000',null,'1','PG_GARE,PG_GARE_AFFIDA,PG_GARE_RDO_ALICE');

		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','DESTOR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','NUMAVCP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','TIPGEN', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','SETTORE', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','MODREA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','CODCIGAQ', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','AQDURATA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','TIPGAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','CODNUTS', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','URBASCO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','PROURG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','PREINF', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','TERRID', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','DTEPAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','DTEOFF', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','RICASTAE', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','DINVIT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','OGGCONT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','SOMMAUR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','CENINT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TORN','CODRUP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC',null,'RIBASSO_AGGIUD', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE1','CODCUI', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','CODIGA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','NOT_GAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','CODCIG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','TIPGARG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','CRITLICG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','LOCINT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','OGGCONT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','CUPPRG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','TIPNEG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','NOFVAL', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','LIMMAX', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','DATTOA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','IAGGIU', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','RIBAGG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','IMPAPP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','IMPNRL', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','IMPSIC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','ONPRGE', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','DAATTO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','TEUTIL', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','IMPGAR', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARE','NOMIMA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','CATG','CATIGA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','CATG','NUMCLA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','OPES','CATOFF', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','OPES','NUMCLU', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARCPV','CODCPV', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','V_GARE_IMPORTI','VALMAX', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','PUBBLI','DATPUB', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','PUBBLI','TIPPUB', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','PUBG','DINPUBG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','PUBG','TIPPUBG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','DITG','RICSUB', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','DITGAQ','DITTAO', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','DITGAVVAL','TIPOAV', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','DITGAVVAL','DITTAAV', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARECONT','DAVVES', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','GARALTSOG','CENINT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','UFFINT','NOMEIN', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','UFFINT','CFANAC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','UFFINT','CFEIN', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','UFFINT','ISCUC','Dato non trasmesso, ma utilizzato per attivare il codice fiscale fittizio ANAC ',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','UFFINT','NOMRES', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','COGTEI', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','NOMETEI', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','NOMTEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','CFTEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','INDTEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','NCITEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','PROTEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','CAPTEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','LOCTEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','CITTEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','FAXTEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','TELTEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TECNI','EMATEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','TIPIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','NOMEST', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','CFIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','PIVIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','NATGIUI', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','CAPIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','INDIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','NCIIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','LOCIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','NAZIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','CODCIT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','PROIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','TELIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','FAXIMP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','EMAI2IP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','EMAIIP', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','INDWEB', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','NCCIAA', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','REGDIT', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','NINAIL', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','NINPS', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPR','ALBTEC', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','IMPLEG','NOMLEG', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TEIM','COGTIM','La trasmissione ad ANAC riguarda il ruolo legale rappresentante',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TEIM','NOMETIM','La trasmissione ad ANAC riguarda il ruolo legale rappresentante',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TEIM','NOMTIM','La trasmissione ad ANAC riguarda il ruolo legale rappresentante',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','TEIM','CFTIM','La trasmissione ad ANAC riguarda il ruolo legale rappresentante',null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','RAGIMP','IMPMAN', null,null);
		Insert into W_TAGSLIST (CODAPP,TAGCOD,TAGENTITY,TAGFIELD,TAGINFO,TAGMOD) values ('PG','ANAC','RAGIMP','NOMDIC', null,null);

		update eldaver set numver = 'M3.9.0.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M3.9.0.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M3.9.0.0') THEN
	
		insert into w_genchiavi (tabella, chiave) values('G1CRIVALCOM',0);
		
		IF (select length(tab1desc) > 0 from tab1 where tab1cod = 'A1101' and tab1tip = 1) THEN
		  UPDATE TAB1 set TAB1DESC=SUBSTR(TAB1DESC,1,1) || '  Selezione manuale(0) Selezione automatica(1)  Entrambe (2)' WHERE  TAB1COD = 'A1101' and  TAB1TIP = 1;
		END IF;
		Update TAB4 SET TAB4DESC='Modalità selezione operatori da elenco in gara' where tab4cod='G1_1' and tab4tip='A1101';

		--Correzione descrizione tabellato
		UPDATE TAB1 set TAB1DESC='Riparametrazione punteggi subcriteri, criteri e totale' where TAB1COD='A1145' and TAB1TIP=3;
		
		insert into W_QUARTZ (CODAPP,BEAN_ID,CRON_EXPRESSION,CRON_SECONDS,CRON_MINUTES,CRON_HOURS,CRON_DAY_OF_MONTH,CRON_MONTH,CRON_DAY_OF_WEEK,CRON_YEAR,DESCRIZIONE) VALUES ('PG','condivisioneGaraComponentiCommisioneTrigger', '0 1/15 * * * ? 2099','0','1/15','*','*','*','?','2099', 'Condivisione privilegi gara per componenti commissione');
    
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1PRERIB');
	    INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PRERIB.TORN.GARE','G1PRERIB','Numero di decimali ammessi per ribasso offerto','N.decimali ribasso','N2',NULL,NULL,'N.decimali ammessi per ribasso offerto');

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1DSORTEV','G1ACQAUTO');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DSORTEV.DITG.GARE','G1DSORTEV','Data sorteggio per verifica documenti elenco operatori','Data sort.verif.doc.','A10',NULL,'DATA_ELDA','Data sorteggio');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ACQAUTO.DITG.GARE','G1ACQAUTO','Ditta selezionata da elenco con modalità automatica','Sel.autom.da elenco?','A1',NULL,'SN',NULL);
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1IDGFOF','G1ESPGIU');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','ID.GFOF.GARE','G1IDGFOF','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'ESPGIU.GFOF.GARE','G1ESPGIU','Esprime giudizio ?','Esprime giudizio?','A2',NULL,'SN',NULL);
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1IDVALCOM','G1IDGFOCOM','G1IDDEFCOM','G1COEFFCOM','G1IDCRICOM');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','ID.G1CRIVALCOM.GARE','G1IDCRICOM','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDCRIVAL.G1CRIVALCOM.GARE','G1IDVALCOM','Id dettaglio valore offerto criterio di valutazione','Id dett.valore','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDGFOF.G1CRIVALCOM.GARE','G1IDGFOCOM','Id componente commissione che esprime il giudizio','Id compon.commiss.','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDCRIDEF.G1CRIVALCOM.GARE','G1IDDEFCOM','Id dettaglio definizione criterio di valutazone','Id dett.definizione','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'COEFFI.G1CRIVALCOM.GARE','G1COEFFCOM','Coefficiente assegnato dal singolo componente commissione','Coefficiente','F13.9',NULL,NULL,NULL);
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1SOTTOTIPOGW','G1SOTTOTIPODJ');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SOTTOTIPO.GARPRO_WSDM.GARE','G1SOTTOTIPOGW','Sottotipo','Sottotipo','A100',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SOTTOTIPO.GARDOC_JOBS.GARE','G1SOTTOTIPODJ','Sottotipo','Sottotipo','A100',NULL,NULL,NULL);

		UPDATE C0CAMPI SET C0C_FS='A200' WHERE  C0C_MNE_BER='G1PUNTUAR';
		UPDATE C0CAMPI SET C0C_CHI=NULL WHERE C0C_MNE_BER in ('NGARA_FUN','CODFOF','INCFOF','NUMCOMMFOF');
		UPDATE C0CAMPI SET C0C_FS='A2000' WHERE C0C_MNE_BER = 'G1OGGETTMAILGW';

		DELETE FROM C0ENTIT WHERE C0E_NOM in ('G1CRIVALCOM.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('G1CRIVALCOM.GARE',0,'E','CRIT_VAL_C','Dettaglio valutazione criterio OEPV per componente commiss.','IDCRIVAL.G1CRIVALCOM.GARE','G1CRIVAL.GARE','ID.G1CRIVAL.GARE',NULL,NULL,'g1_crvc0');

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GARE-scheda.FASIISCRIZIONE.SorteggioVerificaDoc','Funzione Sorteggio per verifica documenti',5414);

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.GOEV-dettaglioValutazioneTecEco-lista.AssegnaCoefficenteCommissione','Funzione Assegna coefficiente criterio per componenti commissione',13375);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.AttivaCommissione','Gestione funzionalità specifiche per profilo commissione',2068);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('SEZ','GARE.TORN-OFFUNICA-scheda.COMMIS.RICHNOMMIT','Sezione "Richiesta nomina al MIT"',4005);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.CondividiGaraPermessiCommissione','Funzione Condividi e proteggi gara componenti commissione',2069);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FASIGARA.ImpostaFiltroVerificaValutazione','Funzione Imposta filtro per verifica valutazione - OEPV',13395); 

        INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.CreaFascicolo','Funzione Crea fascicolo documentale',13455);
                
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.VerificaDocumentiSelezioneDitteElenco','Funzione Consultazione documenti iscrizione a elenco',6805);
       
		UPDATE W_OGGETTI SET DESCR='Funzione Assegna coefficente criterio' where TIPO='FUNZ' and OGGETTO='ALT.GARE.GOEV-dettaglioValutazioneTecEco-lista.AssegnaCoefficente';
		
		INSERT INTO W_AZIONI (tipo,azione,oggetto,descr,valore,inor,viselenco,crc) values ('FUNZ','VIS','ALT.GARE.AttivaCommissione','Visualizza',0,1,1,2935442078);
		INSERT INTO W_AZIONI (tipo,azione,oggetto,descr,valore,inor,viselenco,crc) values ('SEZ','VIS','GARE.TORN-OFFUNICA-scheda.COMMIS.RICHNOMMIT','Visualizza',0,1,1,3454035358);
		
        --JDOC
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (160,'PG','sottotipo','Sottotipo','JDOC',NULL);
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (161,'PG','mezzo','Mezzo','JDOC',NULL);
		
		-- (S.Santi 12.10.2020) Modificato calcolo dataoratermine impostando i secondi a '00', come nel portale (APPALTI-363)
		perform sp_backupanddropviews('v_gare_genere');
		create or replace view v_gare_genere (codgar, codice, genere, oggetto, importo, dataoratermine) as
		   select t.codgar, t.codgar as codice, (case when gare.genere=3 then 3 else 1 end) as genere, t.destor as oggetto, t.imptor as importo, 
			 case when t.iterga in (2,4) then 
				case when t.dtepar is not null then
					  to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
					 case when t.otepar is not null and length(t.otepar)=5  
					 and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
					 and substr(t.otepar,3,1)=':' 
					 then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else null end
			 else 
				case when t.dteoff is not null then 
					to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' || 
					 case when t.oteoff is not null and length(t.oteoff)=5  
					 and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
					 and substr(t.oteoff,3,1)=':' 
					 then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else NULL end
			 end dataoratermine
			 from ( torn t LEFT JOIN gare ON t.codgar=gare.ngara and gare.genere=3) where t.codgar not like '$%'
		   union
		   select codgar1, ngara as codice, (case when genere=4 then 4 when genere=10 then 10 when genere=11 then 11 when genere=20 then 20 else 2 end) as genere, not_gar as oggetto, impapp as importo,
			 case when (genere is null and t.iterga in (2,4)) then 
				case when t.dtepar is not null then
					 to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
					 case when t.otepar is not null and length(t.otepar)=5  
					 and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
					 and substr(t.otepar,3,1)=':' 
					 then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else NULL end 
			when (genere is null) then
				case when t.dteoff is not null then
					 to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' || 
					 case when t.oteoff is not null and length(t.oteoff)=5  
					 and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
					 and substr(t.oteoff,3,1)=':' 
					 then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				 else NULL end
				else null end dataoratermine
			 from gare, torn t where gare.codgar1=t.codgar and gare.codgar1 like '$%'
		   union
		   select codgar1, ngara as codice, 100 as genere, not_gar as oggetto, impapp as importo,
			 case when t.iterga in (2,4) then 
				case when t.dtepar is not null then 
					  to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
				 case when t.otepar is not null and length(t.otepar)=5  
				 and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
				 and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
				 and substr(t.otepar,3,1)=':' 
				 then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else NULL end 
			 else 
				case when t.dteoff is not null then
					to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' || 
				 case when t.oteoff is not null and length(t.oteoff)=5  
				 and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
				 and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
				 and substr(t.oteoff,3,1)=':' 
				 then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else NULL end
			 end dataoratermine
			from gare, torn t where gare.codgar1=t.codgar and codgar1 not like '$%' and genere is null
				 and not exists (select B.ngara from gare B where gare.codgar1=B.ngara and B.genere=3)
		   union
		   select codgar1, ngara as codice, 300 as genere, not_gar as oggetto, impapp as importo, 
			 case when t.iterga in (2,4) then 
				case when t.dtepar is not null then
					  to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
					 case when t.otepar is not null and length(t.otepar)=5  
					 and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
					 and substr(t.otepar,3,1)=':' 
					 then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else null end
			 else 
				case when t.dteoff is not null then 
					to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' || 
					 case when t.oteoff is not null and length(t.oteoff)=5  
					 and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
					 and substr(t.oteoff,3,1)=':' 
					 then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else NULL end
			 end dataoratermine
			   from gare, torn t where gare.codgar1=t.codgar and codgar1 not like '$%' and genere is null
				 and exists (select B.ngara from gare B where gare.codgar1=B.ngara and B.genere=3);
		perform sp_restoreviews('v_gare_genere');

		perform sp_backupanddropviews('v_gare_termini');
		create or replace view v_gare_termini as
			select codgar,iterga,
				case when iterga in (2,4) then 
					case when dtepar is not null then
						  to_timestamp(to_char(dtepar,'YYYY/MM/DD') || ' ' || 
						 case when otepar is not null and length(otepar)=5  
						 and (to_number(substr(otepar,1,2),'9999D0000') between 0 and 23)
						 and (to_number(substr(otepar,4,2),'9999D0000') between 0 and 60)
						 and substr(otepar,3,1)=':' 
						 then otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
					else null end
				else 
					case when dteoff is not null then 
						to_timestamp(to_char(dteoff,'YYYY/MM/DD') || ' ' || 
						 case when oteoff is not null and length(oteoff)=5  
						 and (to_number(substr(oteoff,1,2),'9999D0000') between 0 and 23)
						 and (to_number(substr(oteoff,4,2),'9999D0000') between 0 and 60)
						 and substr(oteoff,3,1)=':' 
						 then oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
					else NULL end
				end dataoratermine
			from torn;
		perform sp_restoreviews('v_gare_termini');

		perform sp_backupanddropviews('v_gare_dittefasi');
		create or replace view v_gare_dittefasi as
			with ditte as (select tab1tip num_fase,tab1desc desc_fase,codgar5 codgar,ngara5 ngara,dittao,nomimo, nprogg,numordpl,
					 (case when tab1tip = 2 then estimp else null end) sorteggio,
					 (case when tab1tip in (-4,2,5,6) then partgar else null end) partecipa,
					  fasgar fase_esclu,amminversa
					  from tab1,ditg where tab1cod='A1011'
					  and ((tab1tip <1 and (acquisizione is null or acquisizione <>5)) or (tab1tip>=1 and rtofferta is null)))
			select ditte.*,ammgar ammissione,motivescl,detmotescl
			  from gare, v_gare_genere, torn, gare1,
					 ditte, v_ditgammis 
			  where ditte.ngara=gare.ngara
				 and ditte.ngara=v_gare_genere.codice and v_gare_genere.genere not in (10,11,20,4)
				 and gare.codgar1=torn.codgar
				 and gare.ngara=gare1.ngara
				 and ditte.ngara=v_ditgammis.ngara and ditte.dittao=v_ditgammis.dittao and ditte.num_fase=v_ditgammis.fasgar
				 and ((torn.iterga=1 and num_fase>=1) or (torn.iterga in (3,5,6) and num_fase>=-3) or (torn.iterga in (2,4)))
				 and (num_fase<>3 and num_fase<>4)
				 and (
					   (
					   ((v_gare_genere.genere <>3 and (((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5) or (modlicg=6 or gare1.valtec='1') or (modlicg is null and num_fase=1)))
							 or (
							 (v_gare_genere.genere=3 and gare.bustalotti=2 and num_fase < 7 and 
							   (
							   (not exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1')) and num_fase<>5)
								or exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1'))
								)
							   ))
							   or
							   (v_gare_genere.genere=3 and gare.bustalotti=1 and num_fase < 5))
						 and v_gare_genere.genere<>300)
						or 
						(v_gare_genere.genere=300 and num_fase in (-4,1,2,5,6,7,8) and ((modlicg=6 or gare1.valtec='1') or ((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5)))
					 )
				 and (num_fase<=fase_esclu or fase_esclu is null or fase_esclu=0);
		perform sp_restoreviews('v_gare_dittefasi');

        update eldaver set numver = '9.0.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '9.0.0', datvet = now() where codapp = 'G1';
		
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

		
		
	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();
CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '9.0.%') THEN
		
		ALTER TABLE GARPRO_WSDM ADD OGGETTO_MAIL_TEMP TEXT;
		
		--tabella delle posizioni rda per integrazione WSERP (non visibile ma ad uso interno)
		CREATE TABLE GAREPOSRDA (
		  ID NUMERIC(12) NOT NULL,
		  RDA_ID NUMERIC(12)NOT NULL,
		  NUMRDA VARCHAR(50),
		  POSRDA VARCHAR(50),
		  DESCRIZIONE VARCHAR(2000),
		  CODARTICOLO VARCHAR(50),
		  QUANTITA NUMERIC(24,5),
		  PREZZO NUMERIC(24,5),
		  UNIMIS VARCHAR(10),
		  WBE VARCHAR(50),
		  CDC VARCHAR(50),
		  CONTOCOGE VARCHAR(50),
		  PREZZORIB NUMERIC(24,5),
		  primary key(ID)); 
		  
		ALTER TABLE GAREPOSRDA ADD CONSTRAINT FK_GAREPOSRDA_GARERDA FOREIGN KEY ( RDA_ID) REFERENCES GARERDA( ID ) ON DELETE CASCADE;
		
		ALTER TABLE GARE1 ADD TIPOCONTRATTOERP VARCHAR(5);
		
		ALTER TABLE DITG ADD NCOMOPE VARCHAR(30);
		ALTER TABLE DITG ADD DITTAINV VARCHAR(10);
		ALTER TABLE DITG ADD DREVOCA TIMESTAMP;
		
		--AGGIUNTA CREAZIONE TABELLE PER L190-ANGULAR
		IF NOT EXISTS (SELECT TABLENAME FROM PG_TABLES WHERE UPPER(TABLENAME)='ANTICORINPUT') THEN
			CREATE TABLE ANTICORINPUT (
				ID NUMERIC(12) NOT NULL,
				IDANTICOR NUMERIC(12) NOT NULL,
				FLGAGGIORNA NUMERIC(1) ,
				FLGIMPLIQUIDATO NUMERIC(1) ,
				FLGIMPAGGIUDICAZIONE NUMERIC(1) ,
				FLGDATAINIZIO NUMERIC(1) ,
				FLGDATAULTIMAZIONE NUMERIC(1) ,
				FLGPARTECIPANTE NUMERIC(1) ,
				ANNO NUMERIC(7) NULL,
				UFFINT VARCHAR(20) NOT NULL,
				USRSYS NUMERIC(12) NULL,
				CODEIN VARCHAR(16) NULL,
				CFEIN VARCHAR(20) NULL,
				FILEDATANAME VARCHAR(200) NULL,
				FILEDATA BYTEA NULL,
				CONSTRAINT ANTICORINPUT_PKEY PRIMARY KEY (ID)
			);
			-- CREAZIONE SEQUENCE PER HIBERNATE
			CREATE SEQUENCE SEQ_ANTICORINPUT_PK	START WITH 1 INCREMENT BY 1	NO CYCLE;
			
		END IF;
		IF NOT EXISTS (SELECT TABLENAME FROM PG_TABLES WHERE UPPER(TABLENAME)='ANTICORJOB') THEN
			CREATE TABLE ANTICORJOB (
				JOBID VARCHAR(255) NOT NULL,
				IDANTICORINPUT NUMERIC(12) NOT NULL,
				DATAINSERIMENTO TIMESTAMP NULL,
				DATAULTIMOAGGIORNAMENTO TIMESTAMP NULL,
				JOBTYPE VARCHAR(50) NULL,
				JOBSTATUS VARCHAR(50) NULL,
				FLGNASCOSTO NUMERIC(1) DEFAULT 0,
				ERRORS BYTEA NULL,
				CONSTRAINT ANTICORJOB_PKEY PRIMARY KEY (JOBID)
			);
		END IF;
		--FINE AGGIUNTA CREAZIONE TABELLE PER L190-ANGULAR
		
		update eldaver set numver = 'M1.9.1.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M1.9.1.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
    codiceGara varchar(21);
	numeroGara varchar(20);
	dittaRT varchar(10);
	dittaOriginale varchar(10);
	ciclo_ditg cursor for select CODGAR5,NGARA5, DITTAO from ditg where ACQUISIZIONE = 5 and dittainv is null;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M1.9.1.0') THEN
	
		--Inizializzazione n.progressivo busta per operatore
        UPDATE DITG set NCOMOPE = '1' where NCOMOPE is null;
		update w_invcom set comkey3='1' where idprg='PA' and (comtipo like 'FS10%' or comtipo like 'FS11%') and (comkey3 is null or comkey3='');

		open ciclo_ditg;
		loop
			fetch ciclo_ditg into codiceGara, numeroGara, dittaRT;
			if not found then
			   exit;
			end if;
			if (select count(*) > 0 from ditg  where codgar5=codiceGara and ngara5=numeroGara and rtofferta=dittaRT) then
					  select dittao into dittaOriginale from ditg  where codgar5=codiceGara and ngara5=numeroGara and rtofferta=dittaRT;
			  update ditg set dittainv =   dittaOriginale  where codgar5=codiceGara and dittao=dittaRT;
					end if;
		end loop;
		close ciclo_ditg;

		insert into w_genchiavi (tabella, chiave) values('GAREPOSRDA',0);
        if (select count(*) = 0 from W_GENCHIAVI where tabella = 'GFOF') then
			insert into w_genchiavi (tabella, chiave) values('GFOF',0);
		end if;

		UPDATE GARPRO_WSDM set OGGETTO_MAIL_TEMP = OGGETTO_MAIL;
		ALTER TABLE GARPRO_WSDM DROP COLUMN OGGETTO_MAIL;
		ALTER TABLE GARPRO_WSDM RENAME COLUMN OGGETTO_MAIL_TEMP TO OGGETTO_MAIL;

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1075',10,'Rinuncia iscrizione',NULL,7.5,NULL);
		
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A2082',6,'Rialzo percentuale',NULL,1,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A2081',3,'Prezzo più alto',NULL,3,NULL);

		--Inserisce voce solo se non già introdotta con inizializzazione LFS
		if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='A2047' and TAB1TIP=17) = 0) then
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A2047',17,'Prezzo più alto - rialzo su importo a base di gara',NULL,6,NULL);
		end if;
		
		delete from W_NOTE where tipo = 2 and oggetto = 'GENEWEB.W_CONFCOM-scheda' and prog >= 0;
        INSERT INTO W_NOTE (TIPO,OGGETTO,PROG,MODOVIS,NOTA) values ( 2, 'GENEWEB.W_CONFCOM-scheda', 0,'3','Si riporta di seguito la lista dei mnemonici che possono essere utilizzati nell''oggetto e nel testo del modello di comunicazione.<br>Tali mnemonici devono essere riportati tra # per essere identificati.<br><br><b>Mnemonici per le comunicazioni inserite dalla pagina ''Dati generali'' di gare,elenchi o avvisi</b>:<br>CODGAR&nbsp;&nbsp;Codice gara divisa in lotti<br>NGARA&nbsp;&nbsp;Codice gara,elenco o avviso<br>CODIGA&nbsp;&nbsp;N.lotto<br>G1CODCIG&nbsp;&nbsp;Codice CIG<br>OGGETA&nbsp;&nbsp;Oggetto gara o lotto<br>G1DESTOR&nbsp;&nbsp;Oggetto gara divisa in lotti<br>OGGETTOGA&nbsp;&nbsp;Oggetto elenco operatori o catalogo<br>DTEPAR&nbsp;&nbsp;Data termine richiesta partecipaz.<br>OTEPAR&nbsp;&nbsp;Ora termine richiesta partecipaz.<br>DTEOFF&nbsp;&nbsp;Data termine presentaz.offerta<br>OTEOFF&nbsp;&nbsp;Ora termine presentaz.offerta<br>DESOFF&nbsp;&nbsp;Data apertura offerte<br>OESOFF&nbsp;&nbsp;Ora apertura offerte<br>DATAOGGI&nbsp;&nbsp;Data corrente<br>NOMTECRUP&nbsp;&nbsp;Nome RUP<br>CFTECRUP&nbsp;&nbsp;Codice fiscale RUP<br>INCTECRUP&nbsp;&nbsp;Titolo RUP<br><div><br></div><div><b>Mnemonici per le comunicazioni inserite dalla lista operatori in gara o elenco</b>:</div>G1NPROGG&nbsp;&nbspN.pres.offerta<br>G1NUMORDPL&nbsp;&nbspN.presentazione rich.partecipaz.<br>DITTAO&nbsp;&nbsp;Codice operatore<br>NOMIMP&nbsp;&nbsp;Ragione sociale operatore<br>CFIMP&nbsp;&nbsp;Codice fiscale operatore<br>PIVIMP&nbsp;&nbsp;Partita Iva operatore<br>G_DTRISOA&nbsp;&nbsp;Data scadenza SOA triennale<br>G_DSCANC&nbsp;&nbsp;Data scadenza SOA quinquennale');
        INSERT INTO W_NOTE (TIPO,OGGETTO,PROG,MODOVIS,NOTA) values ( 2, 'GENEWEB.W_CONFCOM-scheda', 0,'2','Si riporta di seguito la lista dei mnemonici che possono essere utilizzati nell''oggetto e nel testo del modello di comunicazione.<br>Tali mnemonici devono essere riportati tra # per essere identificati.<br><br><b>Mnemonici per le comunicazioni inserite dalla pagina ''Dati generali'' di gare,elenchi o avvisi</b>:<br>CODGAR&nbsp;&nbsp;Codice gara divisa in lotti<br>NGARA&nbsp;&nbsp;Codice gara,elenco o avviso<br>CODIGA&nbsp;&nbsp;N.lotto<br>G1CODCIG&nbsp;&nbsp;Codice CIG<br>OGGETA&nbsp;&nbsp;Oggetto gara o lotto<br>G1DESTOR&nbsp;&nbsp;Oggetto gara divisa in lotti<br>OGGETTOGA&nbsp;&nbsp;Oggetto elenco operatori o catalogo<br>DTEPAR&nbsp;&nbsp;Data termine richiesta partecipaz.<br>OTEPAR&nbsp;&nbsp;Ora termine richiesta partecipaz.<br>DTEOFF&nbsp;&nbsp;Data termine presentaz.offerta<br>OTEOFF&nbsp;&nbsp;Ora termine presentaz.offerta<br>DESOFF&nbsp;&nbsp;Data apertura offerte<br>OESOFF&nbsp;&nbsp;Ora apertura offerte<br>DATAOGGI&nbsp;&nbsp;Data corrente<br>NOMTECRUP&nbsp;&nbsp;Nome RUP<br>CFTECRUP&nbsp;&nbsp;Codice fiscale RUP<br>INCTECRUP&nbsp;&nbsp;Titolo RUP<br><div><br></div><div><b>Mnemonici per le comunicazioni inserite dalla lista operatori in gara o elenco</b>:</div>G1NPROGG&nbsp;&nbspN.pres.offerta<br>G1NUMORDPL&nbsp;&nbspN.presentazione rich.partecipaz.<br>DITTAO&nbsp;&nbsp;Codice operatore<br>NOMIMP&nbsp;&nbsp;Ragione sociale operatore<br>CFIMP&nbsp;&nbsp;Codice fiscale operatore<br>PIVIMP&nbsp;&nbsp;Partita Iva operatore<br>G_DTRISOA&nbsp;&nbsp;Data scadenza SOA triennale<br>G_DSCANC&nbsp;&nbsp;Data scadenza SOA quinquennale');
				
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','listaDitte.gare.note','0','Lista ditte in gara o elenco','Notifica campo Note valorizzato per ditta in gara mediante diversa icona di accesso a pop-up dati ulteriori. Impostare 1 per attivare la notifica.',NULL);
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','listaDitte.elenco.note','0','Lista ditte in gara o elenco','Notifica campo Note valorizzato per operatore in elenco mediante diversa icona di accesso a pop-up dati ulteriori. Impostare 1 per attivare la notifica.',NULL);
		UPDATE W_CONFIG SET SEZIONE = 'Lista ditte in gara o elenco' WHERE SEZIONE = 'Paginazione lista ditte';
		
		--addizionato campo tipo contratto erp per integrazione erp
        DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1TIPOCONTRERP');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'TIPOCONTRATTOERP.GARE1.GARE','G1TIPOCONTRERP','Tipo contratto erp','Tipo contr. erp','A5',NULL,NULL,NULL);
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1NCOMOPE','G1DITTAINV');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NCOMOPE.DITG.GARE','G1NCOMOPE','Num.progr.plico presentato dallo stesso operatore(COMKEY3)','N.plico stesso oper.','A30',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DITTAINV.DITG.GARE','G1DITTAINV','Codice ditta da cui è derivata l''RT in fase di offerta ','Ditta di origine RT','A10',NULL,NULL,NULL);

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1DREVOCA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DREVOCA.DITG.GARE','G1DREVOCA','Data revoca o rinuncia iscrizione da elenco o catalogo','Data revoca iscriz.','A10',NULL,'DATA_ELDA','Data revoca o rinuncia iscrizione');
		
		UPDATE C0CAMPI SET COC_DOM='CLOB' WHERE  C0C_MNE_BER='G1OGGETTMAILGW';

		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.V_GARE_ADESIONI-lista.apriDocAssociati','Funzione Visualizza documenti associati all''adesione dall''accordo quadro',14700);	
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','GENEWEB.W_INVCOM-IN-scheda','Comunicazione in ingresso',6000);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('PAGE','GENEWEB.W_INVCOM-IN-scheda.W_INVCOM','Dati generali',6005);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('PAGE','GENEWEB.W_INVCOM-IN-scheda.W_DOCDIG','Allegati',6010);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GENEWEB.W_INVCOM-scheda.W_DOCDIG.EsportaDocumentiBusta','Funzione Esporta allegati della comunicazione in un file zip',14710);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GENEWEB.W_INVCOM-IN-scheda.W_DOCDIG.EsportaDocumentiBusta','Funzione Esporta allegati della comunicazione in un file zip',14720);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FascicoloDocumentaleCommessa','Funzione Fascicolo documentale della commessa / appalto',13435);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES  ('SEZ','GARE.V_GARE_PROFILO-trova.GARERDA','Sezione "Dati della richiesta di acquisto"',2065);

		INSERT INTO W_AZIONI(TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) VALUES ('SEZ','VIS','GARE.V_GARE_PROFILO-trova.GARERDA','Visualizza',0,1,1,1199716256);
		
		--sezioni dinamiche richieste di acquisto lotto gara plico unico
		Insert into W_OGGETTI (TIPO, OGGETTO, DESCR, ORD) Values ('SEZ', 'GARE.GARE-scheda.DATIGENOFFUNICA.GARERDA', 'Sezioni dinamiche "Richiesta di acquisto"', 3992);
		Insert into W_OGGETTI (TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'MOD.GARE.GARE-scheda.DATIGENOFFUNICA.MOD-GARERDA', 'Funzione modifica richiesta di acquisto', 3993);
		Insert into W_OGGETTI (TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'DEL.GARE.GARE-scheda.DATIGENOFFUNICA.DEL-GARERDA', 'Funzione elimina richiesta di acquisto', 3994);
		Insert into W_OGGETTI (TIPO, OGGETTO, DESCR, ORD) Values ('FUNZ', 'INS.GARE.GARE-scheda.DATIGENOFFUNICA.INS-GARERDA', 'Funzione inserisci richiesta di acquisto', 3995);
		Insert into W_AZIONI (TIPO, AZIONE, OGGETTO, DESCR, VALORE, INOR, VISELENCO, CRC) Values ('SEZ', 'VIS', 'GARE.GARE-scheda.DATIGENOFFUNICA.GARERDA', 'Visualizza', 0, 1, 1, 812542755);
		
		UPDATE W_OGGETTI SET DESCR='Ricerca avanzata profilo trova procedure' WHERE TIPO='MASC' and OGGETTO='GARE.V_GARE_PROFILO-trova';

		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (24,'PG','tipiTrasmissione','Tipo trasmissione','PALEO',NULL);

		-- (S.Santi 03.12.2020) Aggiunto nel campo 'oggetto' il valore di NREPAT.GARE ai fini di import SAP RaiWay
		perform sp_backupanddropviews('v_dati_lotti_completa');
		IF exists (select tablename from pg_tables where upper(tablename) = 'APPA') THEN
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   case when not_gar is not null then
				(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
				else 
				(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20))) and gare.preced is null and torn.garpriv is null
		   union all
			select gare.ngara lotto,
			   gare.codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   case when not_gar is not null then
				(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
				else 
				(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
				iaggiu 
				else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
					when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
				   else gc.dverbc end datainizio,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
					when (gare.clavor is not null or gare.numera is not null) then appa.dult
				   else gc.dcertu end dataultimazione,
			   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
					or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
					when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
				   else gc.impliq end impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			 from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1) and torn.garpriv is null
		   union all
			 select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
			   case when not_gar is not null then
				(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
				else 
				(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				null altrisog,
				null accqua,
				null aqoper,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff,
				tecni.cftec codfisresp,
				tecni.nomtec nomeresp
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where gare.genere=4';
		else
			EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
			with pubblicazioni 
			 as (select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9)
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   case when not_gar is not null then
				(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
				else 
				(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20))) and gare.preced is null and torn.garpriv is null
		  union all
			select gare.ngara lotto,
			   codcig cig,
			   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
			   uff.codein codiceprop,
			   uff.cfein codfiscprop,
			   uff.nomein denomprop,
			   case when not_gar is not null then
				(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
				else 
				(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
			   tipgarg,
			   iterga,
			   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
				  else gc.impqua end impaggiudic,
			   torn.dinvit,
			   ditta aggiudicataria,
			   gare.esineg,
			   gare.datneg,
			   gare.dattoa,
			   torn.altrisog,
			   torn.accqua,
			   gare1.aqoper,
			   gc.dverbc datainizio,
			   gc.dcertu dataultimazione,
			   gc.impliq impsommeliq,
			   torn.dteoff,
			   tecni.cftec codfisresp,
			   tecni.nomtec nomeresp
			from gare
			 inner join torn on torn.codgar=gare.codgar1
			 inner join gare1 on gare1.ngara=gare.ngara
					 left outer join  pubblicazioni on pubblicazioni.codgar9=torn.codgar
			 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1) and torn.garpriv is null
		   union all
			select gare.ngara lotto,
				gare.codcig cig,
				null datpub,
				uff.codein codiceprop,
				uff.cfein codfiscprop,
				uff.nomein denomprop,
			   case when not_gar is not null then
				(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
				else 
				(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
				gare.tipgarg,
				null iterga,
				iaggiu impaggiudic,
				null dinvit,
				ditta aggiudicataria,
				null esineg,
				null datneg,
				gare.daatto dattoa,
				null altrisog,
				null accqua,
				null aqoper,
				gc.dverbc datainizio,
				gc.dcertu dataultimazione,
				gc.impliq impsommeliq,
				torn.dteoff,
				tecni.cftec codfisresp,
				tecni.nomtec nomeresp
			 from gare inner join torn on (gare.codgar1=torn.codgar)
			 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
			 left outer join uffint uff on (uff.codein=torn.cenint )
			 left outer join tecni on (tecni.codtec=torn.codrup)
			 where gare.genere=4';
		end if;
		perform sp_restoreviews('v_dati_lotti_completa');

		update eldaver set numver = '9.1.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '9.1.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '9.1.%') THEN

		CREATE TABLE G1DOCSOC (
		  ID NUMERIC(12) NOT NULL,
		  IDPRG VARCHAR(2),
		  IDCOM NUMERIC(12),
		  NUMORD NUMERIC(7),
		  DESCRIZIONE VARCHAR(2000),
		  OBBLIGATORIO VARCHAR(1),
		  FORMATO NUMERIC(7),
		 constraint PK_G1DOCSOC primary key(ID));

		ALTER TABLE G1DOCSOC ADD CONSTRAINT FK_G1DOCSOC_INVCOM FOREIGN KEY ( IDPRG, IDCOM ) REFERENCES W_INVCOM( IDPRG, IDCOM) ON DELETE CASCADE;

		update eldaver set numver = 'M1.9.2.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M1.9.2.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M1.9.2.0') THEN
		
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1167',1,'PG_GARE_AVVISI',NULL,NULL,NULL);
        INSERT INTO TAB4 (TAB4COD,TAB4TIP,TAB4DESC,TAB4GRP) VALUES ('G1_1','A1167','Profili di gestione degli avvisi',NULL);

		--Parametro calcolo agg. L.R.Sicilia introdotto nella patch 9.1.4
		if ((SELECT count(TAB1TIP) FROM TAB1 WHERE TAB1COD='A1116' and TAB1TIP=6) = 0) then
			INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1116',6,'0   accorpamento off.uguali all''interno e a cavallo delle ali (0)  nessun accorpamento (2)',NULL,0,NULL);
		end if;

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('W_008', 1, 'Richiesta soccorso istruttorio', NULL, 0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('W_004', 56, 'Funzione ''Richiesta soccorso istruttorio''', NULL, 0,'1');

		--Archivia le voci relativi ai modelli associati a funzioni di appalti
		UPDATE TAB1 set TAB1ARC='1' where TAB1COD='W_004' and TAB1TIP>50 and TAB1TIP<=56;

		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1IDDOCSOC','G1IDPRGDS','G1IDCOMDS','G1NUMORDDS','G1DESCRIDS','G1OBBLIDS','G1FORMATODS');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E','P','ID.G1DOCSOC.GARE','G1IDDOCSOC','Id','Id','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDPRG.G1DOCSOC.GARE','G1IDPRGDS','ID comunicazione socc.istrutt.: codice applicativo','Id comun.:cod.appl.','A2',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'IDCOM.G1DOCSOC.GARE','G1IDCOMDS','ID comunicazione socc.istrutt.: n.progressivo','Id comun.: n.progr.','N12',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NUMORD.G1DOCSOC.GARE','G1NUMORDDS','Numero ordine','Numero ordine','N3',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DESCRIZIONE.G1DOCSOC.GARE','G1DESCRIDS','Descrizione','Descrizione','A2000',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'OBBLIGATORIO.G1DOCSOC.GARE','G1OBBLIDS','Documento obbligatorio ?','Doc. obbligatorio?','A2',NULL,'SN',NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'FORMATO.G1DOCSOC.GARE','G1FORMATODS','Formato del documento','Formato documento','A100','A1105',NULL,'Formato del documento');
		
		DELETE FROM C0ENTIT WHERE C0E_NOM in ('G1DOCSOC.GARE');
		INSERT INTO C0ENTIT (C0E_NOM,C0E_NUM,C0E_TIP,COE_ARG,C0E_DES,C0E_KEY,C0E_NOM_EX,COE_KEY_EX,C0E_FRM_RI,COE_FRM_CA,COE_FRM_RE) VALUES ('G1DOCSOC.GARE',0,'E','DOC_SOC_IS','Documenti richiesti per soccorso istruttorio','ID.G1DOCSOC.GARE',NULL,NULL,NULL,NULL,'g1_docs0');

		UPDATE W_PROFILI SET DESCRIZIONE = 'Ricerca una procedura di affidamento o avviso in tutti i profili applicativi in base a codice, CIG e oggetto' where COD_PROFILO='PG_GARE_PROFILO' and CODAPP='PG';

		--(C.Febas 13.01.2021) attivazione integrazione anagrafiche U-GOV con WSERP
		Insert into W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) values ('PG','integrazioneAnagraficheUGOV',null,'Personalizzazione Cineca','Abilita integrazione con anagrafiche U-GOV (0=integrazione non attiva, 1=integrazione attiva)',null);

		--(S.Santi 29.12.2020) Sostituito UNION con UNION ALL
		perform sp_backupanddropviews('v_gare_genere');
		create or replace view v_gare_genere (codgar, codice, genere, oggetto, importo, dataoratermine) as
		   select t.codgar, t.codgar as codice, (case when gare.genere=3 then 3 else 1 end) as genere, t.destor as oggetto, t.imptor as importo, 
			 case when t.iterga in (2,4) then 
				case when t.dtepar is not null then
					  to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
					 case when t.otepar is not null and length(t.otepar)=5  
					 and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
					 and substr(t.otepar,3,1)=':' 
					 then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else null end
			 else
				case when t.dteoff is not null then 
					to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' ||
					 case when t.oteoff is not null and length(t.oteoff)=5  
					 and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
					 and substr(t.oteoff,3,1)=':' 
					 then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else NULL end
			 end dataoratermine
			 from ( torn t LEFT JOIN gare ON t.codgar=gare.ngara and gare.genere=3) where t.codgar not like '$%'
		   union all
		   select codgar1, ngara as codice, (case when genere=4 then 4 when genere=10 then 10 when genere=11 then 11 when genere=20 then 20 else 2 end) as genere, not_gar as oggetto, impapp as importo,
			 case when (genere is null and t.iterga in (2,4)) then 
				case when t.dtepar is not null then
					 to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
					 case when t.otepar is not null and length(t.otepar)=5  
					 and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
					 and substr(t.otepar,3,1)=':' 
					 then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else NULL end 
			when (genere is null) then
				case when t.dteoff is not null then
					 to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' || 
					 case when t.oteoff is not null and length(t.oteoff)=5  
					 and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
					 and substr(t.oteoff,3,1)=':' 
					 then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				 else NULL end
				else null end dataoratermine
			 from gare, torn t where gare.codgar1=t.codgar and gare.codgar1 like '$%'
		   union all
		   select codgar1, ngara as codice, 100 as genere, not_gar as oggetto, impapp as importo,
			 case when t.iterga in (2,4) then 
				case when t.dtepar is not null then 
					  to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
				 case when t.otepar is not null and length(t.otepar)=5  
				 and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
				 and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
				 and substr(t.otepar,3,1)=':' 
				 then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else NULL end 
			 else 
				case when t.dteoff is not null then
					to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' || 
				 case when t.oteoff is not null and length(t.oteoff)=5  
				 and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
				 and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
				 and substr(t.oteoff,3,1)=':' 
				 then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else NULL end
			 end dataoratermine
			from gare, torn t where gare.codgar1=t.codgar and codgar1 not like '$%' and genere is null
				 and not exists (select B.ngara from gare B where gare.codgar1=B.ngara and B.genere=3)
		   union all
		   select codgar1, ngara as codice, 300 as genere, not_gar as oggetto, impapp as importo, 
			 case when t.iterga in (2,4) then 
				case when t.dtepar is not null then
					  to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
					 case when t.otepar is not null and length(t.otepar)=5  
					 and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
					 and substr(t.otepar,3,1)=':' 
					 then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else null end
			 else 
				case when t.dteoff is not null then 
					to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' || 
					 case when t.oteoff is not null and length(t.oteoff)=5  
					 and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
					 and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
					 and substr(t.oteoff,3,1)=':' 
					 then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS') 
				else NULL end
			 end dataoratermine
			   from gare, torn t where gare.codgar1=t.codgar and codgar1 not like '$%' and genere is null
				 and exists (select B.ngara from gare B where gare.codgar1=B.ngara and B.genere=3);
		perform sp_restoreviews('v_gare_genere');

		perform sp_backupanddropviews('v_gare_aggiudicate');
		create or replace view v_gare_aggiudicate as
			select v_gare_genere.codgar,v_gare_genere.codice,v_gare_genere.oggetto,'0' islotti,gare.codcig,gare.tipgarg,
			gare.dinlavg,gare.teutil,gare.temesi,
			gare.dattoa,gare.iaggiu,gare.ditta,
			impr.nomest,impr.cfimp,impr.pivimp,
			case when impr.tipimp in (3,10) then '1' else '0' end isrt,
			case when impr.natgiui=12 then '1' else '0' end isonlus,
			dd.codleg,teim.nomtim,teim.cftim
			from gare inner join v_gare_genere on v_gare_genere.codice=gare.ngara
				  inner join impr on gare.ditta=impr.codimp
				  left outer join (select codimp2,min(codleg) codleg from impleg d where d.legini is not null and d.legfin is null group by d.codimp2) dd on dd.codimp2=impr.codimp
				  left outer join teim on teim.codtim=dd.codleg
			where v_gare_genere.genere in (2,100) and gare.ditta is not null and gare.dattoa is not null
		  union all
			select v_gare_genere.codgar,v_gare_genere.codgar,v_gare_genere.oggetto,'1' islotti,'' codcig,gare.tipgarg,
			gare.dinlavg,gare.teutil,gare.temesi,
			gare.dattoa,ee.iaggiu,ee.ditta,
			impr.nomest,impr.cfimp,impr.pivimp,
			case when impr.tipimp in (3,10) then '1' else '0' end isrt,
			case when impr.natgiui=12 then '1' else '0' end isonlus,
			dd.codleg,teim.nomtim,teim.cftim
			from gare inner join v_gare_genere on gare.ngara=v_gare_genere.codice
				inner join torn on gare.codgar1=torn.codgar
				inner join (select codgar1,ditta,sum(iaggiu) iaggiu from gare e where e.ditta is not null group by codgar1,ditta) ee on ee.codgar1=v_gare_genere.codgar
				inner join impr on ee.ditta=impr.codimp
				left outer join (select codimp2,min(codleg) codleg from impleg d where d.legini is not null and d.legfin is null group by d.codimp2) dd on dd.codimp2=impr.codimp
				left outer join teim on teim.codtim=dd.codleg
			where v_gare_genere.genere=3 and gare.dattoa is not null and torn.modcont=2
		  union all
			select v_gare_genere.codgar,v_gare_genere.codice,v_gare_genere.oggetto,'0' islotti,lotto.codcig,gare.tipgarg,
			gare.dinlavg,gare.teutil,gare.temesi,
			lotto.dattoa,lotto.iaggiu,lotto.ditta,
			impr.nomest,impr.cfimp,impr.pivimp,
			case when impr.tipimp in (3,10) then '1' else '0' end isrt,
			case when impr.natgiui=12 then '1' else '0' end isonlus,
			dd.codleg,teim.nomtim,teim.cftim
			from gare inner join v_gare_genere on gare.ngara=v_gare_genere.codgar
				inner join torn on gare.codgar1=torn.codgar
				inner join gare lotto on lotto.ngara=v_gare_genere.codice
				inner join impr on lotto.ditta=impr.codimp
				left outer join (select codimp2,min(codleg) codleg from impleg d where d.legini is not null and d.legfin is null group by d.codimp2) dd on dd.codimp2=impr.codimp
				left outer join teim on teim.codtim=dd.codleg
			where v_gare_genere.genere=300 and lotto.ditta is not null and lotto.dattoa is not null and torn.modcont=1
		  union all
			select v_gare_genere.codgar,v_gare_genere.codice,v_gare_genere.oggetto,'0' islotti,gare.codcig,gare.tipgarg,
			gare.dinlavg,gare.teutil,gare.temesi,
			gare.daatto,gare.iaggiu,gare.ditta,
			impr.nomest,impr.cfimp,impr.pivimp,
			case when impr.tipimp in (3,10) then '1' else '0' end isrt,
			case when impr.natgiui=12 then '1' else '0' end isonlus,
			dd.codleg,teim.nomtim,teim.cftim
			from gare inner join v_gare_genere on v_gare_genere.codice=gare.ngara
				  inner join garecont on gare.ngara=garecont.ngara
				  inner join impr on gare.ditta=impr.codimp
				  left outer join (select codimp2,min(codleg) codleg from impleg d where d.legini is not null and d.legfin is null group by d.codimp2) dd on dd.codimp2=impr.codimp
				  left outer join teim on teim.codtim=dd.codleg
			where v_gare_genere.genere = 4 and gare.ditta is not null and garecont.stato>3;
		perform sp_restoreviews('v_gare_aggiudicate');
		 
		perform sp_backupanddropviews('v_gare_adesioni');
		create or replace view v_gare_adesioni as
			select gare.codcig,
				torn.codcigaq, 
				torn.tipgen,
				torn.cenint,
				uffint.cfein,
				uffint.nomein,
				torn.codrup,
				tecni.cftec,
				tecni.nomtec,
				gare.not_gar oggetto,
				gare.impapp,
				gare.ditta,
				impr.nomest, 
				case when impr.tipimp in (3,10) then imprman.cfimp else impr.cfimp end cfimp,
				case when impr.tipimp in (3,10) then imprman.pivimp else impr.pivimp end pivimp,
				impr.tipimp,
				gare.iaggiu,
				gare.dattoa,
				gare.ngara,
				torn.ngaraaq
			from gare
			inner join torn on (codgar=codgar1)
			inner join impr on (ditta = codimp)
			left outer join ragimp on (impr.codimp=ragimp.codime9 and ragimp.impman='1')
			left outer join impr imprman on (imprman.codimp=ragimp.coddic)
			left outer join uffint on (cenint=codein)
			left outer join tecni on (codrup=codtec)
			where isadesione ='1' and NGARAAQ is not null and ditta is not null and dattoa is not null
			union all
			select codcig, codcigaq, tipgen, cenint, cfein, nomein, cast('' as varchar(1)) codrup, cfrup, nomtec, oggetto, impapp, cast('' as varchar(1)) ditta, nomest, cfimp, pivimp, tipimp, iaggiu, dattoa, cast('' as varchar(1)) ngara, cast('' as varchar(1)) ngaraaq
			from g1adesioniest;
		perform sp_restoreviews('v_gare_adesioni');

		perform sp_backupanddropviews('v_gare_categorie');
		create or replace view v_gare_categorie as 
			select ngara, (cast('1' as varchar(1))) isprev, ncatg, caisim catiga, descat, tiplavg, titcat, impiga, impbasg, numcla,
			 case when tiplavg=1 then (select tab1desc from tab1 where tab1cod='A1015' and tab1tip=numcla)
						when tiplavg=2 then (select tab1desc from tab1 where tab1cod='G_035' and tab1tip=numcla) 
						when tiplavg=3 then (select tab1desc from tab1 where tab1cod='G_036' and tab1tip=numcla)
						when tiplavg=4 then (select tab1desc from tab1 where tab1cod='G_037' and tab1tip=numcla) 
						else (select tab1desc from tab1 where tab1cod='G_049' and tab1tip=numcla) end descla,
			 '' quaobb, '' acontec, '' ultnote,
			 isfoglia, numliv, numord, 
			 case when catiga=caisim then '1' else '0' end iscatgara
			from catg, v_cais_tit
			where (catg.catiga=v_cais_tit.caisim or catg.catiga=v_cais_tit.codliv1 or catg.catiga=v_cais_tit.codliv2 
				or catg.catiga=v_cais_tit.codliv3 or catg.catiga=v_cais_tit.codliv4)
			union all
			select ngara3, (cast('2' as varchar(1))) isprev, nopega, caisim, descat, tiplavg, titcat, iscoff, impapo, numclu, 
			 case when tiplavg=1 then (select tab1desc from tab1 where tab1cod='A1015' and tab1tip=numclu)
				when tiplavg=2 then (select tab1desc from tab1 where tab1cod='G_035' and tab1tip=numclu) 
				when tiplavg=3 then (select tab1desc from tab1 where tab1cod='G_036' and tab1tip=numclu)
				when tiplavg=4 then (select tab1desc from tab1 where tab1cod='G_037' and tab1tip=numclu) 
				else (select tab1desc from tab1 where tab1cod='G_049' and tab1tip=numclu) end descla,
			 opes.quaobb, opes.acontec, descop,
			 isfoglia, numliv, numord, 
			 case when catoff=caisim then '1' else '0' end iscatgara
			from opes, v_cais_tit
			where (opes.catoff=v_cais_tit.caisim or opes.catoff=v_cais_tit.codliv1 or opes.catoff=v_cais_tit.codliv2 
				or opes.catoff=v_cais_tit.codliv3 or opes.catoff=v_cais_tit.codliv4);
		perform sp_restoreviews('v_gare_categorie');

		perform sp_backupanddropviews('v_iscrizcat_tit');
		create or replace view v_iscrizcat_tit as 
			select caisim,descat,tiplavg,titnord, titcat,caisord,quaobb,acontec,isfoglia,numliv,numord from v_cais_tit
			union all 
			select '0','Gare per '||TAB1DESC,TAB1TIP,0,'-1',null,'','','1',1,'9'||cast (tab1tip as text)||'0000000000*****' 
			from v_cais_tit,tab1 where caisim='OG1' and tab1cod='A1007';
		perform sp_restoreviews('v_iscrizcat_tit');

		perform sp_backupanddropviews('v_iscrizcat_classi');
		create or replace view v_iscrizcat_classi as
			select v_iscrizcat_tit.caisim, v_iscrizcat_tit.descat, v_iscrizcat_tit.descat descat1,
						v_iscrizcat_tit.tiplavg, v_iscrizcat_tit.titnord, v_iscrizcat_tit.titcat,
						v_iscrizcat_tit.caisord, v_iscrizcat_tit.quaobb, v_iscrizcat_tit.acontec, 
						v_iscrizcat_tit.isfoglia, v_iscrizcat_tit.numliv, v_iscrizcat_tit.numord, 
						-100 numclass, iscrizcat.infnumclass, iscrizcat.supnumclass, 
						null numclass_l, case when tiplavg=1 then iscrizcat.infnumclass else null end infnumcla_l, case when tiplavg=1 then iscrizcat.supnumclass else null end supnumcla_l, 
						null numclass_f, case when tiplavg=2 then iscrizcat.infnumclass else null end infnumcla_f, case when tiplavg=2 then iscrizcat.supnumclass else null end supnumcla_f, 
						null numclass_s, case when tiplavg=3 then iscrizcat.infnumclass else null end infnumcla_s, case when tiplavg=3 then iscrizcat.supnumclass else null end supnumcla_s, 
						null numclass_l15, case when tiplavg=4 then iscrizcat.infnumclass else null end infnumcla_l15, case when tiplavg=4 then iscrizcat.supnumclass else null end supnumcla_l15, 
						null numclass_sp, case when tiplavg=5 then iscrizcat.infnumclass else null end infnumcla_sp, case when tiplavg=5 then iscrizcat.supnumclass else null end supnumcla_sp, 
						iscrizcat.invrea, iscrizcat.invpen, iscrizcat.altpen, iscrizcat.notpen, iscrizcat.ultnot, iscrizcat.aggrea,
						iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp
				from v_iscrizcat_tit,iscrizcat 
				where v_iscrizcat_tit.caisim = iscrizcat.codcat and v_iscrizcat_tit.tiplavg = iscrizcat.tipcat
			union all
			select v_iscrizcat_tit.caisim,
					'Classifica: '|| 
						case when tiplavg=1 then (select tab1desc from tab1 where tab1cod='A1015' and tab1tip=numclass) 
							when tiplavg=2 then (select tab1desc from tab1 where tab1cod='G_035' and tab1tip=numclass) 
							when tiplavg=3 then (select tab1desc from tab1 where tab1cod='G_036' and tab1tip=numclass) 
							when tiplavg=4 then (select tab1desc from tab1 where tab1cod='G_037' and tab1tip=numclass) 
							else (select tab1desc from tab1 where tab1cod='G_049' and tab1tip=numclass) end,
					v_iscrizcat_tit.descat,v_iscrizcat_tit.tiplavg, v_iscrizcat_tit.titnord, v_iscrizcat_tit.titcat, 
					v_iscrizcat_tit.caisord, null,null,
					v_iscrizcat_tit.isfoglia, v_iscrizcat_tit.numliv, v_iscrizcat_tit.numord, 
					iscrizclassi.numclass,null,null,
					case when tiplavg=1 then iscrizclassi.numclass else null end numclass_l, null,null,
					case when tiplavg=2 then iscrizclassi.numclass else null end numclass_f, null,null,
					case when tiplavg=3 then iscrizclassi.numclass else null end numclass_s, null,null,
					case when tiplavg=4 then iscrizclassi.numclass else null end numclass_l150, null,null,
					case when tiplavg=5 then iscrizclassi.numclass else null end numclass_sp, null,null,
					iscrizclassi.invrea, iscrizclassi.invpen, iscrizclassi.altpen, iscrizclassi.notpen, iscrizclassi.ultnot, iscrizclassi.aggrea,
					iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp
				from v_iscrizcat_tit,iscrizcat,iscrizclassi
				where v_iscrizcat_tit.caisim = iscrizcat.codcat and v_iscrizcat_tit.tiplavg = iscrizcat.tipcat
					and iscrizcat.ngara=iscrizclassi.ngara and iscrizcat.codimp=iscrizclassi.codimp 
					and iscrizcat.codcat=iscrizclassi.codcat and iscrizcat.tipcat=iscrizclassi.tipcat;
		perform sp_restoreviews('v_iscrizcat_classi');

		-- (S.Santi 18.12.2020) Aggiunto avvisi
		create or replace view V_GARE_PROFILO as
			select v_gare_torn.codice, v_gare_torn.codgar, v_gare_torn.oggetto,v_gare_torn.codcig,torn.cenint, v_gare_torn.profiloweb,
			v_gare_torn.genere, v_gare_torn.tipgar, v_gare_torn.isarchi,
			case when tab2.tab2d1 ='default' then 'PG_GARE' else tab2.tab2d1 end as codprofilo
			from v_gare_torn inner join torn on (v_gare_torn.codgar=torn.codgar and torn.profiloweb is null)
			INNER JOIN TAB2 ON (TAB2COD='A1z03' AND ',' || TAB2.TAB2D2 || ',' LIKE '%,' || CAST(V_GARE_TORN.TIPGAR AS VARCHAR(4)) || ',%' AND TAB2D1 not like '$%')
			union all
			select v_gare_torn.codice, v_gare_torn.codgar, v_gare_torn.oggetto,v_gare_torn.codcig,torn.cenint, v_gare_torn.profiloweb,
			v_gare_torn.genere, v_gare_torn.tipgar, v_gare_torn.isarchi,
			tab2.tab2d1 as codprofilo
			from v_gare_torn inner join torn on (v_gare_torn.codgar=torn.codgar and torn.profiloweb is not null)
			INNER JOIN TAB2 ON TAB2COD='A1z03' and tab2d1 like '$%' AND torn.profiloweb = to_number(substring(substring(tab2d1,2,100),1,position('$' in substring(tab2d1,2,100))-1),'99999')
			union all
			select gareavvisi.ngara codice,gareavvisi.codgar,gareavvisi.oggetto,cast(null as text) codcig,torn.cenint,cast(null as numeric(3,0)) profiloweb,
			11,cast(null as numeric(7,0)) tipgar,gareavvisi.isarchi, tab1.tab1desc
			from gareavvisi inner join torn on (gareavvisi.codgar=torn.codgar)
			inner join gare on (gareavvisi.ngara=gare.ngara)
			inner join tab1 on (tab1cod='A1167' and tab1desc is not null);

		-- (S.Santi 22.01.2021) Sostituito CTE con view per risolvere pb di saturazione tablespace TEMP, riscontrato su DB Oracle
		--n.lotti di ogni gara
		create or replace view v_gare_torn_lotti as
		select codgar1, array_to_string(array_agg(gare.codcig),',') codciglotti, count(*) numlotti from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		group by codgar1;
		--n.lotti di ogni gara aggiudicati senza esito negativo
		create or replace view v_gare_torn_lottiagg as
		select codgar1, count(*) numlottiagg from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null and esineg is null
		group by codgar1;
		--n.lotti di ogni gara aggiudicati e con contratto stipulato senza esito negativo
		create or replace view v_gare_torn_lottistip as
		select codgar1, count(*) numlottistip from gare
		where (genere<>3 or genere is null) and codgar1 not like '$%'
		and ditta is not null and esineg is null and daatto is not null
		group by codgar1;
		--n.lotti di ogni gara aggiudicati o con esito negativo
		create or replace view v_gare_torn_lotticonc as
			select codgar1, count(*) numlotticonc from gare
			where (genere<>3 or genere is null) and codgar1 not like '$%'
			and ditta is not null or esineg is not null
			group by codgar1;
		--
		perform sp_backupanddropviews('v_gare_torn');
		create or replace view v_gare_torn as 
		select codgar, codgar as codice, tipgen, destor as oggetto, imptor as importo, tipgar, 
			cast('1' as varchar(1)) as islotti, (case when gare.genere=3 then 3 else 1 end) as genere, isarchi,
			case when (lotti.numlotti>0 and lottiagg.numlottiagg>0 and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu,
			case when (lotti.numlotti>0 and lottistip.numlottistip>0 and lottiagg.numlottiagg=lottistip.numlottistip and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isstipula,
			case when (lotti.numlotti>0 and lotti.numlotti=lotticonc.numlotticonc) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as islotticonclusi,
			(case when gare.genere=3 then gare.esineg else torn.esineg end) as esineg, lotti.codciglotti as codcig, profiloweb, gartel, cenint
		from torn 
			left outer join gare on (codgar=gare.ngara and gare.genere=3) 
			left outer join v_gare_torn_lotti lotti on (lotti.codgar1=torn.codgar)
			left outer join v_gare_torn_lottiagg lottiagg on (lottiagg.codgar1=torn.codgar)
			left outer join v_gare_torn_lottistip lottistip on (lottistip.codgar1=torn.codgar)
			left outer join v_gare_torn_lotticonc lotticonc on (lotticonc.codgar1=torn.codgar)
			where codgar not like '$%' 
		union all
		select torn.codgar, gare.ngara as codice, torn.tipgen, gare.not_gar as oggetto, gare.impapp as importo, gare.tipgarg,
			cast('2' as varchar(1)) as islotti, 2 as genere, torn.isarchi, 
			case when (gare.ditta is not null and gare.esineg is null) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isaggiu, 
			case when (gare.ditta is not null and gare.daatto is not null and gare.esineg is null) then cast('1' as varchar(1)) else cast('2' as varchar(1)) end as isstipula, 
			null as islotticonclusi,
			gare.esineg, gare.codcig, torn.profiloweb, torn.gartel, torn.cenint
			from gare,torn 
			where torn.codgar=gare.codgar1 and torn.codgar like '$%' and (gare.genere is null or (gare.genere not in (4,10,11,20)));
		perform sp_restoreviews('v_gare_torn');

		create or replace view v_gare_dittefasi_ditte as
			select tab1tip num_fase,tab1desc desc_fase,codgar5 codgar,ngara5 ngara,dittao,nomimo, nprogg,numordpl,
				 (case when tab1tip = 2 then estimp else null end) sorteggio,
				 (case when tab1tip in (-4,2,5,6) then partgar else null end) partecipa,
				  fasgar fase_esclu,amminversa
				  from tab1,ditg where tab1cod='A1011'
				  and ((tab1tip <1 and (acquisizione is null or acquisizione <>5)) or (tab1tip>=1 and rtofferta is null));
		--
		perform sp_backupanddropviews('v_gare_dittefasi');
		create or replace view v_gare_dittefasi as
			select ditte.*,ammgar ammissione,motivescl,detmotescl
			  from gare, v_gare_genere, torn, gare1,
					 v_gare_dittefasi_ditte ditte, v_ditgammis 
			  where ditte.ngara=gare.ngara
				 and ditte.ngara=v_gare_genere.codice and v_gare_genere.genere not in (10,11,20,4)
				 and gare.codgar1=torn.codgar
				 and gare.ngara=gare1.ngara
				 and ditte.ngara=v_ditgammis.ngara and ditte.dittao=v_ditgammis.dittao and ditte.num_fase=v_ditgammis.fasgar
				 and ((torn.iterga=1 and num_fase>=1) or (torn.iterga in (3,5,6) and num_fase>=-3) or (torn.iterga in (2,4)))
				 and (num_fase<>3 and num_fase<>4)
				 and (
					   (
					   ((v_gare_genere.genere <>3 and (((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5) or (modlicg=6 or gare1.valtec='1') or (modlicg is null and num_fase=1)))
							 or (
							 (v_gare_genere.genere=3 and gare.bustalotti=2 and num_fase < 7 and 
							   (
							   (not exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1')) and num_fase<>5)
								or exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1'))
								)
							   ))
							   or
							   (v_gare_genere.genere=3 and gare.bustalotti=1 and num_fase < 5))
						 and v_gare_genere.genere<>300)
						or 
						(v_gare_genere.genere=300 and num_fase in (-4,1,2,5,6,7,8) and ((modlicg=6 or gare1.valtec='1') or ((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5)))
					 )
				 and (num_fase<=fase_esclu or fase_esclu is null or fase_esclu=0);
		perform sp_restoreviews('v_gare_dittefasi');

		create or replace view  v_spese_adesioni_importi as
			select cenint, sum(impric) impric_tot, sum(impaut) impaut_tot,null iaggiu_tot, ngara, ncont
			from g1aqspesa 
			group by ngara, ncont, cenint
			union
			select ga.cenint, null,null,sum(ga.iaggiu), gc.ngara, gc.ncont
			 from v_gare_adesioni ga,garecont gc,gare
			 where (gare.ngara=ga.ngaraaq or gare.codcig=ga.codcigaq) and
			 ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1)
					or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
			  group by ga.cenint, gc.ngara, gc.ncont;
		--
		perform sp_backupanddropviews('v_spese_adesioni');
		create or replace view v_spese_adesioni as
			select sp.ngara,sp.ncont,sp.cenint,uffint.nomein, gc.impqua, sum(impric_tot) impric, sum(impaut_tot) impaut, sum(iaggiu_tot) impimp
			from v_spese_adesioni_importi sp
			inner join garecont gc on (sp.ngara=gc.ngara and sp.ncont=gc.ncont)
			left outer join uffint on (sp.cenint=uffint.codein)
			group by sp.ngara, sp.ncont, sp.cenint, uffint.nomein, gc.impqua;
		perform sp_restoreviews('v_spese_adesioni');

		create or replace view v_ditte_elecat_totali as
		  select iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp, 
				 sum(case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) numinv, 
				 sum(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) numpen,
				 sum(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt,
				 sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
					(case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) + 
					(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numir,
				 sum((case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
					(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numip,
				 sum(case when (iscrizcat.aggrea is null) then 0 else iscrizcat.aggrea end) numagg, 
				 sum((case when (iscrizcat.aggrea is null) then 0 else iscrizcat.aggrea end) + 
					(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end)) numap
			from iscrizcat
			group by codgar, ngara, codimp;
		--
		perform sp_backupanddropviews('v_ditte_elecat');
		create or replace view v_ditte_elecat as
		   select gare.ngara gara, ditg.dittao codice, ditg.nomimo ragsoc, impr.locimp, impr.proimp, ditg.numordpl numord, ditg.iaggiuele,
				  (case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) numinv,
				  (case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) numpen, 
				  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt, 
				  (case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
				  (case when (iscrizcat.invpen is null) then 0 else iscrizcat.invpen end) + 
				  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numir,
				  (case when (iscrizcat.invrea is null) then 0 else iscrizcat.invrea end) + 
				  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numip,
				  (case when (iscrizcat.aggrea is null) then 0 else iscrizcat.aggrea end) numagg,
				  (case when (iscrizcat.aggrea is null) then 0 else iscrizcat.aggrea end) + 
				  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numap,
				  iscrizcat.codcat, iscrizcat.infnumclass, iscrizcat.supnumclass,
				  iscrizclassi.numclass,
				  (case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end) numinvcla,
				  (case when (iscrizclassi.invpen is null) then 0 else iscrizclassi.invpen end) numpencla, 
				  (case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end) numaltcla, 
				  (case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end) + 
				  (case when (iscrizclassi.invpen is null) then 0 else iscrizclassi.invpen end) +
				  (case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end) numircla,
				  (case when (iscrizclassi.invrea is null) then 0 else iscrizclassi.invrea end) + 
				  (case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end) numipcla,
				  (case when (iscrizclassi.aggrea is null) then 0 else iscrizclassi.aggrea end) numaggcla,
				  (case when (iscrizclassi.aggrea is null) then 0 else iscrizclassi.aggrea end) + 
				  (case when (iscrizclassi.altpen is null) then 0 else iscrizclassi.altpen end) numapcla,
				  totali.numinv numinvtot, totali.numpen numpentot, totali.numalt numalttot,
				  totali.numir numirtot, totali.numip numiptot,
				  totali.numagg numaggtot, totali.numap numaptot
			from ditg inner join gare on (ditg.codgar5=gare.codgar1 and ditg.ngara5=gare.ngara)
				inner join impr on (ditg.dittao=impr.codimp)
				inner join iscrizcat on (ditg.codgar5=iscrizcat.codgar and ditg.ngara5=iscrizcat.ngara and ditg.dittao=iscrizcat.codimp)
				inner join v_ditte_elecat_totali totali on (ditg.codgar5=totali.codgar and ditg.ngara5=totali.ngara and ditg.dittao=totali.codimp)
				left outer join iscrizclassi on (iscrizcat.codgar=iscrizclassi.codgar and iscrizcat.ngara=iscrizclassi.ngara 
					and iscrizcat.codimp=iscrizclassi.codimp and iscrizcat.codcat=iscrizclassi.codcat and iscrizcat.tipcat=iscrizclassi.tipcat)
			where gare.codgar1 like '$%' and gare.genere in (10,20) 
			   and ditg.abilitaz=1 and (ditg.dabilitaz is not null) and ditg.numordpl is not null;
		perform sp_restoreviews('v_ditte_elecat');

		create or replace view v_ditte_elecat_sa_totpen as
			select iscrizcat.codgar, iscrizcat.ngara, iscrizcat.codimp, 
				 sum(case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt
			from iscrizcat
			group by codgar, ngara, codimp;
		--
		create or replace view v_ditte_elecat_sa_totsa as
			select iscrizuff.cenint, iscrizuff.codgar, iscrizuff.ngara, iscrizuff.codimp, 
				 sum(case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) numinv, 
				 sum(case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end) numpen,
				 sum((case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
					(case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end)) numirnoalt,
				 sum(case when (iscrizuff.aggrea is null) then 0 else iscrizuff.aggrea end) numagg 
			from iscrizuff 
			group by iscrizuff.cenint, iscrizuff.codgar, iscrizuff.ngara, iscrizuff.codimp;
		--
		perform sp_backupanddropviews('v_ditte_elecat_sa');
		create or replace view v_ditte_elecat_sa as
			select gare.ngara gara, ditg.dittao codice, ditg.nomimo ragsoc, impr.locimp, impr.proimp, ditg.numordpl numord, ditg.iaggiuele,
					  (case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) numinv,
					  (case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end) numpen, 
					  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numalt, 
					  (case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
					  (case when (iscrizuff.invpen is null) then 0 else iscrizuff.invpen end) + 
					  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numir,
					  (case when (iscrizuff.invrea is null) then 0 else iscrizuff.invrea end) + 
					  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numip,
					  (case when (iscrizuff.aggrea is null) then 0 else iscrizuff.aggrea end) numagg,
					  (case when (iscrizuff.aggrea is null) then 0 else iscrizuff.aggrea end) + 
					  (case when (iscrizcat.altpen is null) then 0 else iscrizcat.altpen end) numap,
					  uffint.codein cenint, iscrizcat.codcat, iscrizcat.tipcat, iscrizcat.infnumclass, iscrizcat.supnumclass,
					  iscrizclassi.numclass,
					  (case when (totali_sa.numinv is null) then 0 else totali_sa.numinv end) numinvtot,
					  (case when (totali_sa.numpen is null) then 0 else totali_sa.numpen end) numpentot,
					  totali_altpen.numalt numalttot,
					  (case when (totali_sa.numirnoalt is null) then totali_altpen.numalt else totali_sa.numirnoalt + totali_altpen.numalt end) numirtot,
					  (case when (totali_sa.numinv is null) then totali_altpen.numalt else totali_sa.numinv + totali_altpen.numalt end) numiptot,
					  (case when (totali_sa.numagg is null) then 0 else totali_sa.numagg end) numaggtot,
					  (case when (totali_sa.numagg is null) then totali_altpen.numalt else totali_sa.numagg + totali_altpen.numalt end) numaptot			  
				from ditg inner join gare on (ditg.codgar5=gare.codgar1 and ditg.ngara5=gare.ngara)
					inner join impr on (ditg.dittao=impr.codimp)
					inner join iscrizcat on (ditg.codgar5=iscrizcat.codgar and ditg.ngara5=iscrizcat.ngara and ditg.dittao=iscrizcat.codimp)
					inner join uffint on (1=1)
					left outer join iscrizuff on (uffint.codein=iscrizuff.cenint and iscrizuff.codgar=iscrizcat.codgar and iscrizuff.ngara=iscrizcat.ngara 
									and iscrizuff.codimp=iscrizcat.codimp and iscrizuff.codcat=iscrizcat.codcat and iscrizuff.tipcat=iscrizcat.tipcat)
					left outer join v_ditte_elecat_sa_totsa totali_sa on (uffint.codein=totali_sa.cenint and ditg.codgar5=totali_sa.codgar and ditg.ngara5=totali_sa.ngara and ditg.dittao=totali_sa.codimp)
					inner join v_ditte_elecat_sa_totpen totali_altpen on (ditg.codgar5=totali_altpen.codgar and ditg.ngara5=totali_altpen.ngara and ditg.dittao=totali_altpen.codimp)
					left outer join iscrizclassi on (iscrizcat.codgar=iscrizclassi.codgar and iscrizcat.ngara=iscrizclassi.ngara 
						and iscrizcat.codimp=iscrizclassi.codimp and iscrizcat.codcat=iscrizclassi.codcat and iscrizcat.tipcat=iscrizclassi.tipcat)
				where gare.codgar1 like '$%' and gare.genere in (10,20) 
				   and ditg.abilitaz=1 and (ditg.dabilitaz is not null) and ditg.numordpl is not null;
		perform sp_restoreviews('v_ditte_elecat_sa');

		create or replace view v_dati_lotti_pubblicazioni as 
			select min(datpub) mindatpub,pubbli.codgar9 from pubbli group by pubbli.codgar9;
		--
		perform sp_backupanddropviews('v_dati_lotti_completa');
		IF exists (select tablename from pg_tables where upper(tablename) = 'APPA') THEN
				EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
				select gare.ngara lotto,
				   gare.codcig cig,
				   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
				   uff.codein codiceprop,
				   uff.cfein codfiscprop,
				   uff.nomein denomprop,
				   case when not_gar is not null then
					(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
					else 
					(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
				   tipgarg,
				   iterga,
				   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
					else gc.impqua end impaggiudic,
				   torn.dinvit,
				   ditta aggiudicataria,
				   gare.esineg,
				   gare.datneg,
				   case when gare.ditta is not null then gare.dattoa else null end dattoa,
				   torn.altrisog,
				   torn.accqua,
				   gare1.aqoper,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
						when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
					   else gc.dverbc end datainizio,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
						when (gare.clavor is not null or gare.numera is not null) then appa.dult
					   else gc.dcertu end dataultimazione,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
						when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
					   else gc.impliq end impsommeliq,
				   torn.dteoff,
				   tecni.cftec codfisresp,
				   tecni.nomtec nomeresp
				 from gare
				 inner join torn on torn.codgar=gare.codgar1
				 inner join gare1 on gare1.ngara=gare.ngara
						 left outer join v_dati_lotti_pubblicazioni pubblicazioni on pubblicazioni.codgar9=torn.codgar
				 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
				 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20))) and gare.preced is null and torn.garpriv is null
			   union
				select gare.ngara lotto,
				   gare.codcig cig,
				   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
				   uff.codein codiceprop,
				   uff.cfein codfiscprop,
				   uff.nomein denomprop,
				   case when not_gar is not null then
					(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
					else 
					(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
				   tipgarg,
				   iterga,
				   case when (torn.accqua is null or torn.accqua <>''1'') then
					iaggiu 
					else gc.impqua end impaggiudic,
				   torn.dinvit,
				   ditta aggiudicataria,
				   gare.esineg,
				   gare.datneg,
				   case when gare.ditta is not null then gare.dattoa else null end dattoa,
				   torn.altrisog,
				   torn.accqua,
				   gare1.aqoper,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dverbc
						when (gare.clavor is not null or gare.numera is not null) then appa.dconsd
					   else gc.dverbc end datainizio,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.dcertu
						when (gare.clavor is not null or gare.numera is not null) then appa.dult
					   else gc.dcertu end dataultimazione,
				   case when ((torn.accqua =''1'' and ((gare1.aqoper=1 and (gc.esecscig is null or gc.esecscig<>''1''))
						or gare1.aqoper=2)) or torn.altrisog=2 or torn.altrisog=3) then gc.impliq
						when (gare.clavor is not null or gare.numera is not null) then appa.itotaleliqui
					   else gc.impliq end impsommeliq,
				   torn.dteoff,
				   tecni.cftec codfisresp,
				   tecni.nomtec nomeresp
				 from gare
				 inner join torn on torn.codgar=gare.codgar1
				 inner join gare1 on gare1.ngara=gare.ngara
						 left outer join v_dati_lotti_pubblicazioni pubblicazioni on pubblicazioni.codgar9=torn.codgar
				 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 left outer join appa on (appa.codlav=gare.clavor and appa.nappal= gare.numera)
				 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1) and torn.garpriv is null
			   union
				 select gare.ngara lotto,
					gare.codcig cig,
					null datpub,
					uff.codein codiceprop,
					uff.cfein codfiscprop,
					uff.nomein denomprop,
				   case when not_gar is not null then
					(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
					else 
					(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
					gare.tipgarg,
					null iterga,
					iaggiu impaggiudic,
					null dinvit,
					ditta aggiudicataria,
					null esineg,
					null datneg,
					gare.daatto dattoa,
					null altrisog,
					null accqua,
					null aqoper,
					gc.dverbc datainizio,
					gc.dcertu dataultimazione,
					gc.impliq impsommeliq,
					torn.dteoff,
					tecni.cftec codfisresp,
					tecni.nomtec nomeresp
				 from gare inner join torn on (gare.codgar1=torn.codgar)
				 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 where gare.genere=4';
			else
				EXECUTE 'create or replace view V_DATI_LOTTI_COMPLETA as
				select gare.ngara lotto,
				   codcig cig,
				   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
				   uff.codein codiceprop,
				   uff.cfein codfiscprop,
				   uff.nomein denomprop,
				   case when not_gar is not null then
					(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
					else 
					(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
				   tipgarg,
				   iterga,
				   case when (torn.accqua is null or torn.accqua <>''1'') then
						iaggiu 
					  else gc.impqua end impaggiudic,
				   torn.dinvit,
				   ditta aggiudicataria,
				   gare.esineg,
				   gare.datneg,
				   case when gare.ditta is not null then gare.dattoa else null end dattoa,
				   torn.altrisog,
				   torn.accqua,
				   gare1.aqoper,
				   gc.dverbc datainizio,
				   gc.dcertu dataultimazione,
				   gc.impliq impsommeliq,
				   torn.dteoff,
				   tecni.cftec codfisresp,
				   tecni.nomtec nomeresp
				from gare
				 inner join torn on torn.codgar=gare.codgar1
				 inner join gare1 on gare1.ngara=gare.ngara
						 left outer join v_dati_lotti_pubblicazioni pubblicazioni on pubblicazioni.codgar9=torn.codgar
				 left outer join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 where torn.codgar like ''$%'' and (gare.genere is null or (gare.genere not in (4,10,11,20))) and gare.preced is null and torn.garpriv is null
			  union
				select gare.ngara lotto,
				   codcig cig,
				   case when pubblicazioni.mindatpub is null then torn.dpubav else pubblicazioni.mindatpub end datpub,
				   uff.codein codiceprop,
				   uff.cfein codfiscprop,
				   uff.nomein denomprop,
				   case when not_gar is not null then
					(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
					else 
					(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
				   tipgarg,
				   iterga,
				   case when (torn.accqua is null or torn.accqua <>''1'') then
						iaggiu 
					  else gc.impqua end impaggiudic,
				   torn.dinvit,
				   ditta aggiudicataria,
				   gare.esineg,
				   gare.datneg,
				   case when gare.ditta is not null then gare.dattoa else null end dattoa,
				   torn.altrisog,
				   torn.accqua,
				   gare1.aqoper,
				   gc.dverbc datainizio,
				   gc.dcertu dataultimazione,
				   gc.impliq impsommeliq,
				   torn.dteoff,
				   tecni.cftec codfisresp,
				   tecni.nomtec nomeresp
				from gare
				 inner join torn on torn.codgar=gare.codgar1
				 inner join gare1 on gare1.ngara=gare.ngara
						 left outer join v_dati_lotti_pubblicazioni pubblicazioni on pubblicazioni.codgar9=torn.codgar
				 left outer join garecont gc on ((gc.codimp=gare.ditta or gc.codimp is null) and ((gc.ngara=gare.ngara and gc.ncont=1) or (gc.ngara=gare.codgar1 and (gc.ngaral is null or gc.ngaral=gare.ngara))))
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 where not(torn.codgar like ''$%'' or gare.ngara=gare.codgar1) and torn.garpriv is null
			   union
				select gare.ngara lotto,
					gare.codcig cig,
					null datpub,
					uff.codein codiceprop,
					uff.cfein codfiscprop,
					uff.nomein denomprop,
				   case when not_gar is not null then
					(case when gare.nrepat is not null then not_gar || ''  #NREPAT#'' || gare.nrepat else gare.not_gar end)
					else 
					(case when gare.nrepat is not null then ''#NREPAT#'' || gare.nrepat else null end) end oggetto,
					gare.tipgarg,
					null iterga,
					iaggiu impaggiudic,
					null dinvit,
					ditta aggiudicataria,
					null esineg,
					null datneg,
					gare.daatto dattoa,
					null altrisog,
					null accqua,
					null aqoper,
					gc.dverbc datainizio,
					gc.dcertu dataultimazione,
					gc.impliq impsommeliq,
					torn.dteoff,
					tecni.cftec codfisresp,
					tecni.nomtec nomeresp
				 from gare inner join torn on (gare.codgar1=torn.codgar)
				 inner join garecont gc on (gc.ngara=gare.ngara and gc.ncont=1)
				 left outer join uffint uff on (uff.codein=torn.cenint )
				 left outer join tecni on (tecni.codtec=torn.codrup)
				 where gare.genere=4';
			end if;
		perform sp_restoreviews('v_dati_lotti_completa');


		update eldaver set numver = '9.2.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '9.2.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver like '9.2.%') THEN

		ALTER TABLE GARE ADD RIBOEPV NUMERIC(24,9);
		ALTER TABLE DITG ADD NUMORDINV NUMERIC(7);
		ALTER TABLE GAREALBO ADD RIFISCR NUMERIC(7);
		ALTER TABLE G1FILTRIELE ADD FILTROMAN VARCHAR(1);
		
		--Tab. mappatura tabellati Appalti/NSO
		CREATE TABLE NSO_WS_TABELLATI(
			ID NUMERIC(12) NOT NULL,
			VALORE_TABELLATO VARCHAR(20),
			DESCRIZIONE VARCHAR(50),
			VALORE_APPALTI VARCHAR(5),
			VALORE_NSO VARCHAR(5),
			PRIMARY KEY (ID));
		
		ALTER TABLE GARE1 ADD SEZIONITEC VARCHAR(1);
		ALTER TABLE GOEV ADD SEZTEC NUMERIC(7);
		ALTER TABLE DOCUMGARA ADD SEZTEC NUMERIC(7);
		ALTER TABLE DITGEVENTI ADD DATFS11B1 TIMESTAMP;
		
		ALTER TABLE DITG ADD AMMINVERSA_TMP NUMERIC(7);
		update DITG set AMMINVERSA_TMP = TO_NUMBER(AMMINVERSA,'999999999');
		perform sp_backupanddropviews('ditg');
		ALTER TABLE DITG DROP COLUMN AMMINVERSA;
		ALTER TABLE DITG RENAME COLUMN AMMINVERSA_TMP TO AMMINVERSA;
		perform sp_restoreviews('ditg');
		
		update eldaver set numver = 'M1.9.3.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = 'M1.9.3.0', datvet = now() where codapp = 'G1';

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

CREATE OR REPLACE FUNCTION aggiornamento()
	RETURNS void AS
$$
DECLARE
v_cnt_conf numeric(12) := 0;
BEGIN
    IF (select count(*) = 1 from eldaver where codapp = 'PG' and numver = 'M1.9.3.0') THEN
		
		UPDATE W_INVCOM SET COMTIPMA = NULL;
		
		--Inizializza 'Ribasso agg.OEPV' con valore ditta aggiudicataria
		update gare set riboepv=(select riboepv from ditg where ditg.ngara5=gare.ngara and ditg.dittao=gare.ditta) where riboepv is null and modlicg=6;
		update ditgaq set ribagg=(select riboepv from ditg where ditg.ngara5=ditgaq.ngara and ditg.dittao=ditgaq.dittao) where ribagg is null and exists(select ngara from gare where ditgaq.ngara=gare.ngara and modlicg=6);

		INSERT INTO W_GENCHIAVI (TABELLA,CHIAVE) VALUES ('G1DOCSOC',0);
		
		select max(numpro) + 1 into v_cnt_conf from W_CONFCOM ;
		INSERT INTO W_CONFCOM (NUMPRO,GENERE,MODTIT,MODDESC,NUMORD,COMINTEST,COMMSGOGG,COMMSGTES,FILTROSOG,CRITTES,COMMODELLO) VALUES (v_cnt_conf,56,'Comunicazione richiesta soccorso istruttorio','Comunicazione richiesta soccorso istruttorio',1,'1','Richiesta di soccorso istruttorio','con la presente si comunica la richiesta di integrazione come da documentazione allegata.

Cordiali saluti.',NULL,NULL,1);
		update TAB1 set TAB1DESC='Soccorso istruttorio' where TAB1COD='W_008' and TAB1TIP=1;

		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('W_004', 30, 'ARCHIVIATO - NON DISPONIBILE', NULL, 0,NULL);
		UPDATE W_CONFCOM SET GENERE=30 WHERE CRITTES = 2 and GENERE in (4,5,6);

		update garealbo set rifiscr = 1 where valiscr > 0;
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1RIBOEPVG','G1NUMORDINV','G1NUMORDI_DF','G1SORTINVD_DF');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'RIBOEPV.GARE.GARE','G1RIBOEPVG','Ribasso di aggiudicazione nel caso di OEPV','Ribasso agg. OEPV','F13.9',NULL,'PRC','Ribasso di aggiudicazione');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NUMORDINV.DITG.GARE','G1NUMORDINV','Numero d''ordine di invito','Numero ord. invito','N7',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'NUMORDINV.V_GARE_DITTEFASI.GARE','G1NUMORDI_DF','Numero d''ordine di invito','Numero ord. invito','N7',NULL,NULL,NULL);
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SORTINV.V_GARE_DITTEFASI.GARE','G1SORTINVD_DF','Ditta sorteggiata in fase di invito?','Sorteggio invito?','A2',NULL,'SN',NULL);
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1SEZIONITEC','G1_SEZTEC','SEZTECDG','G1SEZTEC_DD');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SEZIONITEC.GARE1.GARE','G1SEZIONITEC','OEPV con busta tecnica divisa in sezioni qualit./quantit.?','OEPV busta tec.sez.?','A2',NULL,'SN','Busta tecnica divisa in sezioni qualitativa e quantitativa?');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SEZTEC.GOEV.GARE','G1_SEZTEC','Sezione busta tecnica qualitativa(1) o quantitativa(2)','Sezione busta tec.','A100','A1168',NULL,'Sezione');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SEZTEC.DOCUMGARA.GARE','SEZTECDG','Sezione busta tecnica qualitativa(1) o quantitativa(2)','Sezione busta tec.','A100','A1168',NULL,'Sezione');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'SEZTEC.V_GARE_DOCDITTA.GARE','G1SEZTEC_DD','Sezione busta tecnica qualitativa(1) o quantitativa(2)','Sezione busta tec.','A100','A1168',NULL,'Sezione busta tecnica');
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1DATFS11B1');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'DATFS11B1.DITGEVENTI.GARE','G1DATFS11B1','Data apertura busta tecnica sez.tecnico-qualitativa','Data aper.tec.quali.','A19',NULL,'TIMESTAMP',NULL);
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('RIFISCRGA');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'RIFISCR.GAREALBO.GARE','RIFISCRGA','Riferimento inizio valid.iscriz.(1 dom.iscriz., 2 abilitaz.)','Riferim.inizio valid','A100','A1169',NULL,'Riferimento per inizio validità iscrizione');
		
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1PIVIMP_AG');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'E',NULL,'PIVIMP.V_GARE_AGGIUDICATE.GARE','G1PIVIMP_AG','Partita I.V.A. della ditta','Partita I.V.A. ditta','A16',NULL,NULL,NULL);
	
		DELETE FROM C0CAMPI WHERE C0C_MNE_BER in ('G1MANFE');
		INSERT INTO C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) Values (0,'E',NULL,'FILTROMAN.G1FILTRIELE.GARE','G1MANFE','Filtro obbligatorio?','Filtro obbl.?','A2',NULL,'SN',NULL);
		
		update C0CAMPI set C0C_FS='A100', C0C_TAB1 = 'A1170',COC_DOM = null WHERE C0C_MNE_BER ='G1AMMINVERSA';
		update C0CAMPI set C0C_FS='A100', C0C_TAB1 = 'A1170',COC_DOM = null WHERE C0C_MNE_BER ='G1AMMINV_DF';
		
		--Stato Ammissione nuovi valori
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1054',7,'Non verificata',NULL,0,'1');
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1054',8,'Si, dopo socc.istruttorio',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1054',9,'No, dopo socc.istruttorio',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1054',10,'Soccorso istruttorio in corso',NULL,0,NULL);
		UPDATE TAB1 SET TAB1ARC='1' WHERE TAB1COD='A1054' AND TAB1TIP=3;
		UPDATE TAB1 SET TAB1ARC='1' WHERE TAB1COD='A1054' AND TAB1TIP=4;
		UPDATE TAB1 SET TAB1ARC='1' WHERE TAB1COD='A1054' AND TAB1TIP=6;
		
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1168',1,'Tecnico-qualitativa',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1168',2,'Tecnico-quantitativa',NULL,0,NULL);
		
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1170',1,'Idonea',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1170',2,'Non idonea',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1170',10,'Soccorso istruttorio in corso',NULL,0,NULL);
		
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1169',1,'Data presentazione domanda di iscrizione o ultimo rinnovo',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1169',2,'Data abilitazione o ultimo rinnovo',NULL,0,NULL);
		INSERT INTO TAB1 (TAB1COD,TAB1TIP,TAB1DESC,TAB1MOD,TAB1NORD,TAB1ARC) VALUES ('A1083',3,'1   - Rispetto a data iscrizione(1) o data abilitazione(2)',NULL,0,NULL);
		
		INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','comunicazioniInGare.soccorsoIstruttorio.filtroTermine',NULL,'Comunicazioni in ingresso e uscita','Gestione filtro su data termine per le comunicazioni in ingresso di soccorso istruttorio in procedure di gara. Impostare a 1 per attivare la gestione.',NULL);
        INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','comunicazioniInElenco.soccorsoIstruttorio.filtroTermine',NULL,'Comunicazioni in ingresso e uscita','Gestione filtro su data termine per le comunicazioni in ingresso di soccorso istruttorio in elenchi operatori. Impostare a 1 per attivare la gestione.',NULL);
        UPDATE W_CONFIG set SEZIONE='Comunicazioni in ingresso e uscita' where CODAPP = 'PG' and CHIAVE = 'allegatiComunicazione.formato';
		
		if ((SELECT count(chiave) FROM w_config WHERE codapp='PG' and chiave='denominazioneEnte') = 0) then
			INSERT INTO W_CONFIG (CODAPP,CHIAVE,VALORE,SEZIONE,DESCRIZIONE,CRIPTATO) VALUES ('PG','denominazioneEnte', null, 'Configurazione generale', 'Denominazione ente', null);
		end if;
		
		INSERT INTO WSDMCFTAB (ID,CODAPP,CODICE,DESCRI,SISTEMA,ISARCHI) values (162,'PG','tipodocumento','Tipo documento','JDOC',NULL);

		DELETE FROM W_OGGETTI WHERE TIPO='FUNZ' AND OGGETTO='ALT.GARE.FASIRICEZIONE.SorteggioInviti' AND ORD = 11089;
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.FASIRICEZIONE.SorteggioOrdineInvito','Funzione "Sorteggio ordine invito"',11089);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','ALT.GARE.RichiestaSoccorsoIstruttorio','Funzione "Richiedi soccorso istruttorio"',11950);
		
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('PAGE','GARE.IMPRDOCG-lista.DOCUMENTI','Pagina Documenti richiesti e presentati',5661);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('PAGE','GARE.IMPRDOCG-lista.COMUNICAZIONISOCCISTRUTT','Pagina Comunicazioni soccorso istruttorio',5662);
		INSERT INTO W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('PAGE','GARE.IMPRDOCG-lista.COMUNICAZIONIRICEVUTE','Pagina Comunicazioni inviate e ricevute',5663);
				
		Insert into W_QUARTZ (CODAPP,BEAN_ID,CRON_EXPRESSION,CRON_SECONDS,CRON_MINUTES,CRON_HOURS,CRON_DAY_OF_MONTH,CRON_MONTH,CRON_DAY_OF_WEEK,CRON_YEAR,DESCRIZIONE) values ('PG','inviaConversazioniSchedulerTrigger','0 0 0 1 1 ? 2099','0','0','0','1','1','?','2099','Processo di invio delle conversazioni interne');
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('MASC','GENEWEB.W_DISCUSS_P-lista','Lista delle conversazioni',14750);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','DEL.GENEWEB.W_DISCUSS_P-lista.LISTADEL','Elimina conversazione',14760);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','DEL.GENEWEB.W_DISCUSS_P-lista.LISTADELSEL','Elimina conversazioni selezionate',14770);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','INS.GENEWEB.W_DISCUSS_P-lista.LISTANUOVO','Nuova conversazione',14780);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','MOD.GENEWEB.W_DISCUSS_P-lista.MOD','Modifica conversazione',14790);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('MASC','GENEWEB.W_DISCUSS_P-scheda','Scheda della conversazione',14800);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('PAGE','GENEWEB.W_DISCUSS_P-scheda.conversazione','Pagina Conversazione',14810);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','MOD.GENEWEB.W_DISCUSS_P-scheda.conversazione.SCHEDAMOD','Modifica conversazione',14820);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','INS.GENEWEB.W_DISCUSS_P-scheda.conversazione.SCHEDANUOVO','Nuova conversazione',14830);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('PAGE','GENEWEB.W_DISCUSS_P-scheda.messaggiconversazione','Pagina dei messaggi della conversazione',14840);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','DEL.GENEWEB.W_DISCUSS_P-scheda.messaggiconversazione.DEL','Elimina messaggio della conversazione',14850);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','DEL.GENEWEB.W_DISCUSS_P-scheda.messaggiconversazione.LISTADELSEL','Elimina messaggi selezionati',14860);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','INS.GENEWEB.W_DISCUSS_P-scheda.messaggiconversazione.LISTANUOVO','Nuovo messaggio',14870);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','MOD.GENEWEB.W_DISCUSS_P-scheda.messaggiconversazione.MOD','Modifica messaggio',14880);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('MASC','GENEWEB.W_DISCUSS-scheda','Scheda messaggio di una conversazione',14890);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('PAGE','GENEWEB.W_DISCUSS-scheda.allegati','Pagina allegati',14900);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('PAGE','GENEWEB.W_DISCUSS-scheda.destinatari','Pagina destinatari',14910);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('PAGE','GENEWEB.W_DISCUSS-scheda.messaggio','Pagina messaggio',14920);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','MOD.GENEWEB.W_DISCUSS-scheda.messaggio.SCHEDAMOD','Modifica messaggio',14930);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','INS.GENEWEB.W_DISCUSS-scheda.messaggio.SCHEDANUOVO','Nuovo messaggio',14940);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','DEL.GENEWEB.W_DISCUSS-scheda.destinatari.DEL','Elimina destinatario',14950);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','DEL.GENEWEB.W_DISCUSS-scheda.destinatari.LISTADELSEL','Elimina destinatari selezionati',14960);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','DEL.GENEWEB.W_DISCUSS-scheda.allegati.LISTADELSEL','Elimina allegati selezionati',14970);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','INS.GENEWEB.W_DISCUSS-scheda.allegati.LISTANUOVO','Nuovo allegato',14980);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('MASC','GENEWEB.W_DISCALL-scheda','Scheda allegato di messaggio di conversazione',14990);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','MOD.GENEWEB.W_DISCALL-scheda.SCHEDAMOD','Modifica',15000);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','INS.GENEWEB.W_DISCALL-scheda.SCHEDANUOVO','Nuovo',15010);
		Insert into W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','ALT.GARE.GARE.Discussioni','Funzione Conversazioni',14730);
		Insert into W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) values ('FUNZ','VIS','ALT.GARE.GARE.Discussioni','Visualizza',0,1,1,187333297);
		
		-- (S.Santi 12.04.2021) Aggiunto campo 'sezione' per i documenti della busta tecnica. Nel caso di gara plico unico offerta unica (imprdcog.ngara=imprdocg.codgar),
		--    vale 1 se per almeno un lotto della gara sono previste le sezioni.
		perform sp_backupanddropviews('v_gare_docditta');
		create or replace view v_gare_docditta as
		select imprdocg.codgar,
			imprdocg.ngara,
			imprdocg.codimp,
			imprdocg.norddoci,
			imprdocg.proveni,
			case when proveni=1 then documgara.busta else imprdocg.busta end busta,
			tab1.tab1nord bustaord,
			tab1.tab1desc bustadesc,
			case when proveni=1 then documgara.descrizione else imprdocg.descrizione end descrizione,
			documgara.reqcap,
			documgara.tipodoc,
			documgara.contestoval,
			documgara.obbligatorio,
			documgara.modfirma,
			documgara.gentel,
			documgara.fasele,
			documgara.isarchi,
			coalesce(documgara.numord,10000) numord,
			documgara.datarilascio datapub,
			case when proveni=1 then documgara.seztec else
			(case when imprdocg.ngara<>imprdocg.codgar
				then (case when (select count(sezionitec) from gare1 where codgar1=imprdocg.codgar and ngara=imprdocg.ngara and sezionitec='1') > 0 then 1 else null end )
				else (case when (select count(sezionitec) from gare1 where codgar1=imprdocg.codgar and sezionitec='1') > 0 then 1 else null end) end) end seztec,
			imprdocg.datarilascio,
			imprdocg.orarilascio,
			imprdocg.datascadenza,
			imprdocg.situazdoci,
			imprdocg.doctel,
			imprdocg.idprg,
			imprdocg.iddocdg,
			w_docdig.dignomdoc,
			imprdocg.notedoci,
			imprdocg.datalettura,
			imprdocg.sysconlet
		from imprdocg 
		left outer join documgara on (imprdocg.codgar = documgara.codgar and imprdocg.norddoci=documgara.norddocg and imprdocg.proveni=1 and documgara.gruppo=3)
		left outer join w_docdig on (imprdocg.idprg=w_docdig.idprg and imprdocg.iddocdg=w_docdig.iddocdig)
		left outer join tab1 on (tab1cod='A1013' and (tab1tip=imprdocg.busta or tab1tip=documgara.busta));
		perform sp_restoreviews('v_gare_docditta');
		
		-- (S.Santi 22.03.2021) Aggiunto campi NUMORDINV.DITG e SORTINV.DITG
		--
		perform sp_backupanddropviews('v_gare_dittefasi_ditte');
		create or replace view v_gare_dittefasi_ditte as
			select tab1tip num_fase,tab1desc desc_fase,codgar5 codgar,ngara5 ngara,dittao,nomimo, nprogg,numordpl,numordinv,sortinv,
				 (case when tab1tip = 2 then estimp else null end) sorteggio,
				 (case when tab1tip in (-4,2,5,6) then partgar else null end) partecipa,
				  fasgar fase_esclu,amminversa
				  from tab1,ditg where tab1cod='A1011'
				  and ((tab1tip <1 and (acquisizione is null or acquisizione <>5)) or (tab1tip>=1 and rtofferta is null));
		perform sp_restoreviews('v_gare_dittefasi_ditte');

		perform sp_backupanddropviews('v_gare_dittefasi');
		create or replace view v_gare_dittefasi as
			select ditte.*,ammgar ammissione,motivescl,detmotescl
			  from gare, v_gare_genere, torn, gare1,
					 v_gare_dittefasi_ditte ditte, v_ditgammis 
			  where ditte.ngara=gare.ngara
				 and ditte.ngara=v_gare_genere.codice and v_gare_genere.genere not in (10,11,20,4)
				 and gare.codgar1=torn.codgar
				 and gare.ngara=gare1.ngara
				 and ditte.ngara=v_ditgammis.ngara and ditte.dittao=v_ditgammis.dittao and ditte.num_fase=v_ditgammis.fasgar
				 and ((torn.iterga=1 and num_fase>=1) or (torn.iterga in (3,5,6) and num_fase>=-3) or (torn.iterga in (2,4)))
				 and (num_fase<>3 and num_fase<>4)
				 and (
					   (
					   ((v_gare_genere.genere <>3 and (((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5) or (modlicg=6 or gare1.valtec='1') or (modlicg is null and num_fase=1)))
							 or (
							 (v_gare_genere.genere=3 and gare.bustalotti=2 and num_fase < 7 and 
							   (
							   (not exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1')) and num_fase<>5)
								or exists (select B.ngara from gare B,gare1 C where B.codgar1=ditte.ngara and B.codgar1<>B.ngara and B.ngara=C.ngara and (B.modlicg=6 or C.valtec='1'))
								)
							   ))
							   or
							   (v_gare_genere.genere=3 and gare.bustalotti=1 and num_fase < 5))
						 and v_gare_genere.genere<>300)
						or 
						(v_gare_genere.genere=300 and num_fase in (-4,1,2,5,6,7,8) and ((modlicg=6 or gare1.valtec='1') or ((modlicg<>6 and (gare1.valtec='2' or gare1.valtec is null)) and num_fase<>5)))
					 )
				 and (num_fase<=fase_esclu or fase_esclu is null or fase_esclu=0);
		perform sp_restoreviews('v_gare_dittefasi');

		update eldaver set numver = '9.3.0', datvet = now() where codapp = 'PG';
		update eldaver set numver = '9.3.0', datvet = now() where codapp = 'G1';
		
		--Messaggio aggiornamento versione
		insert into w_message_out(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_type)
		select (select COALESCE(max(message_id),0)+1 from w_message_out),CURRENT_TIMESTAMP,('Aggiornato il prodotto Appalti&Contratti alla versione '||numver||'. Le note di rilascio sono consultabili dal menu Utilità -> Manuali'),null,48,null
		from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1';

		insert into w_message_out_rec(recipient_id,message_id,recipient_syscon)
		select (select COALESCE(max(recipient_id),0) from w_message_out_rec)+ROW_NUMBER() OVER (ORDER BY syscon asc),(select max(message_id) from w_message_out), syscon
		from usrsys
		where sysdisab='0'
		and exists(select w_accpro.cod_profilo
			from w_accpro inner join w_profili on w_accpro.cod_profilo=w_profili.cod_profilo
			where usrsys.syscon=w_accpro.id_account and w_profili.codapp='PG')
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
			where eldaver.codapp='PG' and w_config.valore='1');
	
		insert into w_message_in(message_id,message_date,message_subject,message_body,message_sender_syscon,message_recipient_syscon,message_recipient_read,message_recipient_archive)
		select (select COALESCE(max(message_id),0) from w_message_in)+ROW_NUMBER() OVER (ORDER BY recipient_syscon asc),o.message_date,o.message_subject,o.message_body,o.message_sender_syscon,r.recipient_syscon,0,null
		from w_message_out o inner join w_message_out_rec r on o.message_id=r.message_id
		where o.message_id=(select max(message_id) from w_message_out)
		and exists(select w_config.valore from eldaver inner join w_config on eldaver.codapp=w_config.codapp and w_config.chiave='messaggi.interni.abilitati'
		where eldaver.codapp='PG' and w_config.valore='1');

	END IF;
END;
$$
LANGUAGE 'plpgsql' ;
select * from aggiornamento();
drop function aggiornamento();

create or replace view v_ws_stati_bandi as
 select '1' as codstato,'In corso' as descstato
 union
 select '2' as codstato,'In aggiudicazione' as descstato
 union
 select '3' as codstato,'Conclusa' as descstato;

create or replace view v_ws_stati_elenchi as
 select '1' as codstato,'Iscrizione aperta' as descstato
 union
 select '2' as codstato,'Iscrizione chiusa' as descstato;

create or replace view v_ws_classif_lavori_elenchi as
select *
  from tab1
 where tab1cod = 'A1015'
   and tab1tip <= (
                   select case when (custom_class is null or custom_class = 0) then max_class else custom_class end
				   from (select max_class,
				               (select to_number(substr(tab1desc, 1, position(' ' in tab1desc)-1),'9999D0000')
							      from tab1
								 where tab1cod = 'A1084') custom_class
						   from (select max(tab1tip) max_class from tab1 where tab1cod = 'A1015') tabmax) tabappoggio
);

create or replace view v_ws_ditg as
 select case when codime9 is null or tipimp is null or tipimp not in (3,10) then dittao else coddic end codman,
        case when dittao<>coddic and tipimp in (3,10) then dittao else null end codati,
        case when dittao<>coddic and tipimp in (3,10) then impr.nomest else null end nomeati,
		i.*
   from ditg i 
	    inner join impr on (i.dittao=impr.codimp and i.rtofferta is null)
        left outer join ragimp r on (i.dittao=r.codime9 and '1'=r.impman);

create or replace view v_ws_stazioni_app as 
 select codein codice, nomein denominazione, cfein codfiscale, viaein indirizzo, nciein numcivico, capein cap, citein comune, proein provincia, telein telefono, faxein fax, emaiin email, emai2in pec
   from uffint
  where exists (select cenint from torn where cenint=codein)
  union 
 select codein codice, nomein denominazione, cfein codfiscale, viaein indirizzo, nciein numcivico, capein cap, citein comune, proein provincia, telein telefono, faxein fax, emaiin email, emai2in pec
   from uffint
  where exists (select cenint from garaltsog where cenint=codein);

create or replace view v_ws_bandi_pub as 
  select codgar9 codgar,min(datpub) datpub
  from pubbli
  where tippub=11 and datpub<=now()
  group by codgar9;

create or replace view v_ws_bandi_ris as 
  select codgar9 codgar,min(datpub) datpub
  from pubbli
  where tippub=13 and datpub<=now()
  group by codgar9;

create or replace view v_ws_bandi_pub_ris as 
  select  codgar9 codgar,min(tippub) tippub,min(datpub) datpub
  from pubbli p 
  where tippub in (11,13) and datpub<=now()
  group by codgar9;

  -- (11.01.2018)
-- Pubblicazione esito della gara. Se lotti, recupero il valore di uno dei lotti
-- Tolto view che recuperaq la pubblicazione esito per gara/lotto
create or replace view v_ws_esiti_pub as 
  select codgar1 codgar,tippubg,min(dinpubg) dinpubg
  from gare,pubg
  where gare.ngara=pubg.ngara and pubg.tippubg=12 and pubg.dinpubg<=now()
  group by codgar1,tippubg;

create or replace view v_ws_gare_rettifiche as 
  select id, replace(codgar,'$','') codice, tipter, datter, orater, drettif
  from garrettif
  where tipter in (1, 2);

create or replace view v_ws_gare_iselenco as
  select codgar1 codgar,max(elencoe) elencoe
  from gare 
  where elencoe is not null
  group by codgar1;

-- Il campo TIPOLOGIA assume i seguenti valori:
--    1 = Lotto di gara con offerte distinte
--    2 = Gara a lotto unico
--    3 = Gara divisa in lotti con offerte unica   
--    4 = Lotto di gara con offerta unica    
create or replace view v_ws_gare_lotti as 
  select g.ngara ngara, t.codgar codgar,
       (case when t.codgar like '$%' then replace(t.codgar,'$','') else t.codgar end) codice,
	     g.codiga codiceinterno,
       coalesce(case when g.genere=3 then t.destor else g.not_gar end,' ') oggetto,
       coalesce(case when t.codgar like '$%' then g.not_gar else t.destor end,' ') oggtor,
       coalesce(case when g.codiga is not null then g.impapp else
           case when t.codgar like '$%' then g.impapp else t.imptor end
       end,0) importo,
       coalesce(case when t.codgar like '$%' then g.impapp else t.imptor end,0) imptor,
	   coalesce(g.impnrl,0) impnoribasso,
	   coalesce(g.impsic,0) impsicurezza,
	   coalesce(g.onprge,0) imponeriprogett,
	   t.ricmano ricmano,
	   t.modmano modmano,
       (case when t.codgar like '$%' then 2 when g.genere=3 then 3 else (case when g1.genere=3 then 4 else 1 end)  end) tipologia,
       t.cenint codsa,u.nomein descsa, u.cfein cfiscsa, 
	   u.tipoin codtipsa, u.proein, u.citein, u.viaein, u.nciein,
	   t.uffdet,
       t.codrup respproc,tec.nomtec descrup,
       t.tipgen codtipoapp,  ''::text   desctipoapp,
       (case when t.codgar like '$%' then g.tipgarg else t.tipgar end) codtipogar,  ''::text   desctipgar,
	   t.iterga coditergara,
	   (case when g.genere=3 then t.critlic else g.critlicg end) codcriagg, ''::text desccriagg,
	   (case when g.genere=3 then t.modlic else g.modlicg end) codmodagg,
   	   (case when g.genere=3 then (case when t.valtec='1' then 1 else 0 end) else (case when gare1.valtec='1' then 1 else 0 end) end) valtec,
	   (case when gare1.costofisso='1' then 1 else 0 end) costofisso,
	     t.dtepar datterminepar,
	     t.otepar oraterminepar,
	     t.dinvit datletterainv,
	     t.dteoff dattermineoff, 
	     t.oteoff oratermineoff,
       case when t.dtepar is not null then
        to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
         case when t.otepar is not null and length(t.otepar)=5  
         and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
         and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
         and substr(t.otepar,3,1)=':' 
         then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone 
         else NULL end dataoraterminepar,
       case when t.dteoff is not null then
        to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' || 
         case when t.oteoff is not null and length(t.oteoff)=5  
         and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
         and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
         and substr(t.oteoff,3,1)=':'
         then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone
         else NULL end dataoratermineoff,
		   t.dindoc,
       case when t.dindoc is not null then
        to_timestamp(to_char(t.dindoc,'YYYY/MM/DD') || ' ' || '23:59:59', 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone
        else NULL end  dataoraterminedoc,
		t.dultagg,
 	   g.codcig codciglotto,
 	   case when t.codgar like '$%' then g.codcig else '' end codcig,
	   case when g.genere=3 then '' else g.cupprg end codcupprglotto,
	   case when t.codgar like '$%' or g.genere=3 then g.cupprg when g1.genere=3 then g1.cupprg else '' end codcupprg,
	   t.isarchi,
   	   g.elencoe,
	   case when g.elencoe is null then 0 else 1 end iselencolotto,
       case when g.ditta is null then 0 else 1 end isaggiu,
	   case when esiti.dinpubg is null then 0 else 1 end isesito,
	   esiti.dinpubg dataesito,
	   i.nomest aggiudicataria,
	   g.iaggiu,
	   g.dattoa,
		t.codscp, t.urlscp, t.codavscp, t.urlavscp,
	   g.tattog, g.dattog, g.nattog, t.norma1, t.norma,
	   case when t.accqua = '1' then 1 else 0 end isaccordoquadro,
	   case when t.aqoper = 2 then 1 else 0 end naggiudicatari,
	   case when t.gartel = '1' then 1 else 0 end gartel,
	   case when t.offtel = '1' then 1 else 0 end offtel,
	   g.ribcal,
	   case when t.offaum = '1' then 1 else 0 end offaum,
	   case when g.sicinc = '1' then 1 else 0 end sicinc,
	   case when g.onsogrib = '1' then 1 else 0 end onsogrib,
	   case when gare1.ultdetlic = 1 or gare1.ultdetlic = 3 then 1 else 0 end isoffpermuta,
	   case when gare1.ultdetlic = 2 or gare1.ultdetlic = 3 then 1 else 0 end isoffcanoneass,
	   t.valoff,
	   case when g1.genere=3 then (case when g1.bustalotti = 2 then 0 else 1 end) else null end bustedistinte,
	   case when t.ricastae='1' then 1 else 0 end as ricastae,
	   gare1.aedinvit,
	   case when g1.genere=3 then g1.fasgar else g.fasgar end fasgar,
	   (case when g.preced is not null then 1 else 0 end) rilancio,
	   (case when t.inversa='1' then 1 else 0 end) inversa,
	   (case when t.sommaur='1' then 1 else 0 end) sommaur,
	   t.altrisog,
	   t.garpriv,
	   t.prerib
  from  gare g inner join torn t on (g.codgar1=t.codgar)
        left outer join gare1 on (gare1.ngara=g.ngara)
        left outer join gare g1 on (g1.codgar1=t.codgar and g1.genere=3)
		left outer join uffint u on (u.codein=t.cenint)
		left outer join tecni tec on (tec.codtec=t.codrup)
		left outer join impr i on (g.ditta = i.codimp)
        left outer join v_ws_esiti_pub esiti on (esiti.codgar=g.codgar1)
  where t.cenint is not null
   and (g.genere is null or (g.genere<>10 and g.genere<>11 and g.genere<>20));


create or replace view v_ws_gare_lotti_tab as 
  select ga.ngara, ga.codgar, ga.codice,
       ga.oggetto, oggtor,
       cast (importo as numeric(24,5)) importo,
	   cast (imptor as numeric(24,5)) imptor,
	   cast (impnoribasso as numeric(24,5)) impnoribasso,
	   cast (impsicurezza as numeric(24,5)) impsicurezza, 
	   cast (imponeriprogett as numeric(24,5)) imponeriprogett,
	   ga.ricmano ricmano,
	   ga.modmano modmano,
       tipologia,
       codsa, descsa, cfiscsa, 
	   codtipsa, proein, citein, viaein, nciein,
       respproc, descrup,
       codtipoapp, t1.tab1desc desctipoapp,
       codtipogar, t2.tab1desc desctipogar,
	   coditergara,
       codcriagg,  t3.tab1desc desccriagg,
	   codmodagg,
	   valtec,
	   costofisso,
       dattermineoff,oratermineoff,
       datterminepar,oraterminepar,
	   datletterainv,
	   case when datterminepar is null then dattermineoff else datterminepar end dattermine,
	   case when datterminepar is null then oratermineoff else oraterminepar end oratermine,
	   dataoraterminepar,
	   dataoratermineoff,
	   dindoc,
       dataoraterminedoc,
	   dultagg,
       codciglotto, codcig, 
	   codcupprglotto, codcupprg,
       isarchi,
	   elencoe, iselencolotto,
       isaggiu,
	   isesito,
	   dataesito,
	   aggiudicataria, iaggiu, dattoa,
	   codscp, urlscp, codavscp, urlavscp,
	   tattog, dattog, nattog, norma1, norma,
	   isaccordoquadro, naggiudicatari,
	   gartel, offtel, ribcal, offaum, sicinc, onsogrib, isoffpermuta, isoffcanoneass, valoff, bustedistinte, 
	   ga.ricastae, ga.aedinvit, ga.fasgar,
	   ga.rilancio,
	   ga.inversa,
	   ga.sommaur,
	   ga.altrisog,
	   ga.garpriv,
	   ga.prerib
	from v_ws_gare_lotti ga left outer join tab1 t1 on (t1.tab1cod='A1007' and t1.tab1tip=ga.codtipoapp)
							left outer join tab1 t2 on (t2.tab1cod='A2044' and t2.tab1tip=ga.codtipogar)
							left outer join tab1 t3 on (t3.tab1cod='A2081' and t3.tab1tip=ga.codcriagg);

create or replace view v_ws_gare_lotti_riservate as 
  select ngara, g.codgar, codice,
         oggetto, oggtor, importo,
         imptor, impnoribasso, impsicurezza, g.ricmano, g.modmano, imponeriprogett, tipologia,
		 codsa, descsa, cfiscsa, 
		 codtipsa, proein, citein, viaein, nciein,
         respproc,   descrup,
         codtipoapp, desctipoapp,
         codtipogar, desctipogar,
		 coditergara,
         codcriagg,  desccriagg,
		 codmodagg,
		 valtec,
		 costofisso,
         eb.datpub,
	     dattermineoff, 
	     oratermineoff,
	     datterminepar,
	     oraterminepar,
	     datletterainv,
		 dattermine,
		 oratermine,
	     dataoraterminepar,
	     dataoratermineoff,
  	     dindoc,
         dataoraterminedoc,
		 dultagg,
  	     codcig, codciglotto,
		 codcupprg,
		 isarchi,
	     elencoe, iselencolotto,
         isaggiu,
		 isesito,
		 dataesito,
		 iaggiu,
	     codscp, urlscp, codavscp, urlavscp,
		 tattog, nattog, dattog, norma1, norma,
		 isaccordoquadro, naggiudicatari,
		 gartel, offtel, ribcal, offaum, sicinc, onsogrib, isoffpermuta, isoffcanoneass, valoff, bustedistinte, 
		 g.ricastae, g.aedinvit, g.fasgar,
		 g.rilancio,
		 g.inversa,
		 g.sommaur,
		 g.altrisog,
		 g.garpriv,
		 g.prerib
  from v_ws_gare_lotti_tab g, v_ws_bandi_ris eb
  where g.codgar=eb.codgar;

create or replace view v_ws_gare_lotti_pubbliche as 
  select ngara, g.codgar, codice,
         oggetto, oggtor, importo,
         imptor, impnoribasso, impsicurezza, g.ricmano, g.modmano, imponeriprogett, tipologia,
		 codsa, descsa, cfiscsa, 
		 codtipsa, proein, citein, viaein, nciein,
         respproc,   descrup,
         codtipoapp, desctipoapp,
         codtipogar, desctipogar,
		 coditergara,
         codcriagg,  desccriagg,
		 codmodagg,
		 valtec,
		 costofisso,
         eb.datpub,
	     dattermineoff, 
	     oratermineoff,
	     datterminepar,
	     oraterminepar,
	     datletterainv,
		 dattermine,
		 oratermine,
	     dataoraterminepar,
	     dataoratermineoff,
	     dindoc,
         dataoraterminedoc,
		 dultagg,
		 codcig, codciglotto,
		 codcupprg,
		 isarchi,
	     elencoe, iselencolotto,
         isaggiu,
		 isesito,
		 dataesito,
		 iaggiu,
	     codscp, urlscp, codavscp, urlavscp,
		 tattog, nattog, dattog, norma1, norma,
		 isaccordoquadro, naggiudicatari,
		 gartel, offtel, ribcal, offaum, sicinc, onsogrib, isoffpermuta, isoffcanoneass, valoff, bustedistinte, 
		 g.ricastae, g.aedinvit, g.fasgar,
		 g.rilancio,
		 g.inversa,
		 g.sommaur,
		 g.altrisog,
		 g.garpriv,
		 g.prerib
  from v_ws_gare_lotti_tab g, v_ws_bandi_pub eb
  where g.codgar=eb.codgar;

create or replace view v_ws_gare_lotti_pub_ris as 
	select ngara, g.codgar, codice,
         oggetto, oggtor, importo,
         imptor, impnoribasso, impsicurezza, g.ricmano, g.modmano, imponeriprogett, tipologia,
		 codsa, descsa, cfiscsa, 
		 codtipsa, proein, citein, viaein, nciein,
         respproc,   descrup,
         codtipoapp, desctipoapp,
         codtipogar, desctipogar,
		 coditergara,
         codcriagg,  desccriagg,
		 codmodagg,
		 valtec,
		 costofisso,
	     dattermineoff, 
	     oratermineoff,
	     datterminepar,
	     oraterminepar,
	     datletterainv,
		 dattermine,
		 oratermine,
	     dataoraterminepar,
	     dataoratermineoff,
	     dindoc,
	     dataoraterminedoc,
		 dultagg,
		 codcig, codciglotto,
		 codcupprg,
		 isarchi,
	     elencoe, iselencolotto,
         isaggiu,
		 isesito,
		 dataesito,
	     iaggiu,
	     codscp, urlscp, codavscp, urlavscp,
		 tattog, nattog, dattog, norma1, norma,
		 isaccordoquadro, naggiudicatari,
		 gartel, offtel, ribcal, offaum, sicinc, onsogrib, isoffpermuta, isoffcanoneass, valoff, bustedistinte, 
		 ricastae, aedinvit, fasgar,
		pb.datpub,
		g.rilancio,
		g.inversa,
		g.sommaur,
		g.altrisog,
		g.garpriv,
		g.prerib
	from v_ws_bandi_pub_ris pb 
	inner join v_ws_gare_lotti_tab g on pb.codgar = g.codgar;

create or replace view v_ws_gare_documenti as 
  select d.ngara, d.codgar,
    (case when d.codgar like '$%' then replace(d.codgar,'$','') else d.codgar end) codice,
    d.norddocg ordine, d.numord, d.datarilascio datpub, w.iddocdig iddoc, d.urldoc,
	case when d.descrizione is null then '(descrizione non presente)' else d.descrizione end descdoc,
	w.dignomdoc filedoc, d.gruppo,
    d.tipodoc codtipodoc, t1.tab1desc desctipodoc, d.contestoval,
	case when d.obbligatorio='1' then 1 else 0 end obbligatorio,
	d.dittaagg, busta,
    d.modfirma codformato,
	case when d.gentel='1' then 1 else 0 end gentel,
	EXTRACT(year FROM d.datarilascio) annoinizioperscadenza,
	d.dataprov, d.numprov,
	d.tipologia	
	from (documgara d left outer join w_docdig w on (d.iddocdg=w.iddocdig and w.idprg='PG')
		              left outer join tab1 t1    on (t1.tab1cod='A1057' and t1.tab1tip=d.tipodoc ))
					  left outer join gare1      on (d.codgar = gare1.codgar1 and (d.ngara=gare1.ngara or (d.ngara is null and d.codgar=gare1.ngara)))
  where (d.fasgar=1 or d.fasgar is null)
    and (d.isarchi is null or d.isarchi='0')
	and d.statodoc=5
	and (busta is null or busta <> 3 or (busta = 3 and (gare1.costofisso is null or gare1.costofisso <> '1')));

create or replace view v_ws_documenti_digitali as 
  select d.idprg,d.iddocdig,d.digent,d.digkey1,d.digkey2,d.digkey3,d.digkey4,d.digkey5,d.digtipdoc,d.dignomdoc,d.digdesdoc,d.digogg,null usernome
    from w_docdig d inner join documgara dg on d.idprg=dg.idprg and d.iddocdig=dg.iddocdg
   where d.idprg='PG' and d.digent='DOCUMGARA' 
     and dg.gruppo<>6
	 and dg.gruppo<>11 
	 and dg.gruppo<>12
	 and (dg.isarchi is null or dg.isarchi='0')
union all
  select d.idprg,d.iddocdig,d.digent,d.digkey1,d.digkey2,d.digkey3,d.digkey4,d.digkey5,d.digtipdoc,d.dignomdoc,d.digdesdoc,d.digogg,u.usernome
    from w_docdig d inner join documgara dg on d.idprg=dg.idprg and d.iddocdig=dg.iddocdg 
	                inner join ditg i       on (dg.ngara=i.ngara5 or dg.codgar=i.ngara5) 
					inner join impr imp     on i.dittao=imp.codimp
					inner join w_puser u    on (u.userent='IMPR' and (u.userkey1=imp.codimp or u.userkey1 = (select r.coddic from ragimp r where r.codime9=imp.codimp and r.impman='1')))
   where d.idprg='PG' and d.digent='DOCUMGARA' 
     and (dg.gruppo=6 or dg.gruppo=11 or dg.gruppo=12)
	 and (dg.isarchi is null or dg.isarchi='0')
union all
  select d.idprg,d.iddocdig,d.digent,d.digkey1,d.digkey2,d.digkey3,d.digkey4,d.digkey5,d.digtipdoc,d.dignomdoc,d.digdesdoc,d.digogg,null
    from w_docdig d inner join w_invcom c on d.idprg=c.idprg and cast( d.digkey2 as INT)=c.idcom
   where d.idprg='PG' and d.digent='W_INVCOM' 
     and c.compub=1 and (c.comstato='3' or c.comstato='4' or c.comstato='10' or c.comstato='11')
union all
  select d.idprg,d.iddocdig,d.digent,d.digkey1,d.digkey2,d.digkey3,d.digkey4,d.digkey5,d.digtipdoc,d.dignomdoc,d.digdesdoc,d.digogg,u.usernome
    from w_docdig d inner join w_invcom c      on d.idprg=c.idprg and cast( d.digkey2 as INT)=c.idcom 
                    inner join w_invcomdes des on (c.idcom=des.idcom)
                    inner join impr i          on (i.codimp = des.descodsog)
                    inner join w_puser u       on (u.userent='IMPR' AND u.userkey1=des.descodsog)
   where d.idprg='PG' and d.digent='W_INVCOM' 
     and c.compub=2 and (c.comstato='3' or c.comstato='4' or c.comstato='10' or c.comstato='11')
     and i.tipimp not in (3,10)
     and des.idcomdes = (select min(d2.idcomdes) from w_invcomdes d2 where des.idcom=d2.idcom and des.descodsog = d2.descodsog)
union all
  select d.idprg,d.iddocdig,d.digent,d.digkey1,d.digkey2,d.digkey3,d.digkey4,d.digkey5,d.digtipdoc,d.dignomdoc,d.digdesdoc,d.digogg,u.usernome
    from w_docdig d inner join w_invcom c      on d.idprg=c.idprg and cast( d.digkey2 as INT)=c.idcom 
                    inner join w_invcomdes des on (c.idcom=des.idcom)
					inner join impr i          on (i.codimp = des.descodsog)
                    inner join ragimp r        on (r.codime9 = i.codimp)
                    inner join w_puser u       on (u.userent='IMPR' AND u.userkey1=r.coddic)
   where d.idprg='PG' and d.digent='W_INVCOM' 
     and c.compub=2 and (c.comstato='3' or c.comstato='4' or c.comstato='10' or c.comstato='11')
     and i.tipimp in (3,10)
     and r.impman = '1'
	 and des.idcomdes = (select min(d2.idcomdes) from w_invcomdes d2 where des.idcom=d2.idcom and des.descodsog = d2.descodsog)
union all
  select d.idprg,d.iddocdig,d.digent,d.digkey1,d.digkey2,d.digkey3,d.digkey4,d.digkey5,d.digtipdoc,d.dignomdoc,d.digdesdoc,d.digogg,c.comkey1
    from w_docdig d inner join w_invcom c on d.idprg=c.idprg and cast( d.digkey1 as INT)=c.idcom 
   where d.idprg='PA' and d.digent='W_INVCOM' and c.comtipo='FS12'
union all
  select d.idprg,d.iddocdig,d.digent,d.digkey1,d.digkey2,d.digkey3,d.digkey4,d.digkey5,d.digtipdoc,d.dignomdoc,d.digdesdoc,d.digogg,null usernome
    from w_docdig d
   where d.idprg='PG' and d.digent='MEALLARTCAT' 
union all
  select d.idprg,d.iddocdig,d.digent,d.digkey1,d.digkey2,d.digkey3,d.digkey4,d.digkey5,d.digtipdoc,d.dignomdoc,d.digdesdoc,d.digogg,u.usernome
    from w_docdig d inner join mealliscrizprod ap on d.idprg=ap.idprg and d.iddocdig=ap.iddocdig
	                inner join meiscrizprod p     on ap.idiscrizprod=p.id
					inner join impr i             on p.codimp=i.codimp
					inner join w_puser u          on (u.userent='IMPR' and (u.userkey1=i.codimp or u.userkey1=(select r.coddic from ragimp r where r.codime9=i.codimp and r.impman='1')))
   where d.idprg='PG' and d.digent='MEALLISCRIZPROD';

create or replace view v_ws_gare_categorie as 
  select ngara ,ncatg  numord,catiga codice,cat.descat descrizione,impiga impiscrizione,impbasg importo,numcla classifica, 
    case when cat.tiplavg=1 then (select tab1desc from tab1 where tab1cod='A1015' and tab1tip=c.numcla) 
		 when cat.tiplavg=2 then (select tab1desc from tab1 where tab1cod='G_035' and tab1tip=c.numcla) 
		 when cat.tiplavg=3 then (select tab1desc from tab1 where tab1cod='G_036' and tab1tip=c.numcla) 
		 when cat.tiplavg=4 then (select tab1desc from tab1 where tab1cod='G_037' and tab1tip=c.numcla) 
		 else (select tab1desc from tab1 where tab1cod='G_049' and tab1tip=c.numcla) 
	end descclassifica,
    1 prevalente,
    case when cat.tiplavg=1 then 1 else 0 end perlavori, tt.tab1tip tipoappalto, t5.tab5desc titolo
  from (catg c inner join cais cat on (cat.caisim=c.catiga and (cat.isarchi is null or cat.isarchi <> '1'))
			   left outer join tab1 tt on (tt.tab1cod='G_038' and cat.tiplavg=tt.tab1tip)
			   left outer join tab5 t5 on (t5.tab5cod='G_j05' and cat.titcat=t5.tab5tip))
  where 
       catiga is not null
union 
  select ngara3,nopega numord,catoff codice,cat.descat descrizione,iscoff impiscrizione,impapo importo,numclu classifica, 
    case when cat.tiplavg=1 then (select tab1desc from tab1 where tab1cod='A1015' and tab1tip=c.numclu) 
		 when cat.tiplavg=2 then (select tab1desc from tab1 where tab1cod='G_035' and tab1tip=c.numclu) 
		 when cat.tiplavg=3	then (select tab1desc from tab1 where tab1cod='G_036' and tab1tip=c.numclu) 
		 when cat.tiplavg=4	then (select tab1desc from tab1 where tab1cod='G_037' and tab1tip=c.numclu) 
		 else (select tab1desc from tab1 where tab1cod='G_049' and tab1tip=c.numclu) 
	end descclassifica,
	0 prevalente,
    case when cat.tiplavg=1 then 1 else 0 end perlavori, tt.tab1tip tipoappalto, t5.tab5desc titolo
  from (opes c inner join cais cat on (cat.caisim=c.catoff and (cat.isarchi is null or cat.isarchi <> '1'))
			   left outer join tab1 tt on (tt.tab1cod='G_038' and cat.tiplavg=tt.tab1tip)
			   left outer join tab5 t5 on (t5.tab5cod='G_j05' and cat.titcat=t5.tab5tip))
  where 
       catoff is not null;
	   
-- Considera tutte le occ. relative ai termini di iscrizione calcolando in un unico campo la data e ora.
-- Viene utilizzata dalla view 'v_ws_elenchi_ter' che individua invece il termine di iscrizione corrente o il prossimo o l''ultimo.
-- Si assume che i termini siano inseriti in ordine temporale
create or replace view v_ws_pubbterm as 
  select p.ngara,p.codgar,p.numpt,p.dpubavvban,p.opubavvban,p.dtermpres, p.otermpres,
   case when p.dpubavvban is not null then
    to_timestamp(to_char(p.dpubavvban,'YYYY/MM/DD') || ' ' ||
      case when p.opubavvban is not null and length(p.opubavvban)=5 
      and (to_number(substr(p.opubavvban,1,2),'9999D0000') between 0 and 23)
      and (to_number(substr(p.opubavvban,4,2),'9999D0000') between 0 and 60)
      and substr(p.opubavvban,3,1)=':' 
      then p.opubavvban || ':00' else '00:00:00' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone
    else
    NULL end initpres,
    case when p.dtermpres is not null then
    to_timestamp(to_char(p.dtermpres,'YYYY/MM/DD') || ' ' || 
      case when p.otermpres is not null and length(p.otermpres)=5  
      and (to_number(substr(p.otermpres,1,2),'9999D0000') between 0 and 23)
      and (to_number(substr(p.otermpres,4,2),'9999D0000') between 0 and 60)
      and substr(p.otermpres,3,1)=':' 
      then p.otermpres || ':59' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone
    else
      NULL end termpres
  from pubbterm p;

create or replace view v_ws_gare_fascicoli as 
select key1 as codice, codice as codicefascicolo, anno as annofascicolo, numero as numerofascicolo, classifica as classificafascicolo, codaoo as codaoofascicolo,
       coduff as codufffascicolo,
	   struttura as strutturafascicolo,
	   isriserva as riservafascicolo
  from wsfascicolo
 where entita = 'GARE';

 create or replace view v_ws_elenchi_ter as 
  select p.ngara,p.codgar,p.numpt,p.dpubavvban,p.opubavvban,p.dtermpres, p.otermpres,
   p.initpres, p.termpres 
  from v_ws_pubbterm p 
  where numpt=(select max(numpt) from v_ws_pubbterm p1 where 
				p1.ngara=p.ngara and now()>=p1.initpres and (now()<=p1.termpres or p1.termpres is null)) 
     or numpt=(select min(numpt) from v_ws_pubbterm p1 where 
				p1.ngara=p.ngara and now()<p1.initpres 
				and not exists (select numpt from v_ws_pubbterm p2 where p2.ngara=p.ngara and now()>=p2.initpres and (now()<=p2.termpres or p2.termpres is null))) 
     or numpt=(select max(numpt) from v_ws_pubbterm p1 where 
				p1.ngara=p.ngara 
				and not exists (select numpt from v_ws_pubbterm p3 where p3.ngara=p.ngara and now()<p3.initpres) 
				and not exists (select numpt from v_ws_pubbterm p4 where p4.ngara=p.ngara and now()>=p4.initpres and (now()<=p4.termpres or p4.termpres is null)));
 
create or replace view v_ws_elenchi_sa as 
  select  g.ngara,g.codgar1 codgar, g.ngara codice,
    t.cenint codsa,u.nomein dessa,
    t.codrup respproc
  from gare g, 
       torn t left outer join uffint u  on (t.cenint=u.codein)
  where g.codgar1=t.codgar;

-- Il campo FASE assume i seguenti valori:
--    1 = Iscrizione aperta                 --> data inizio iscrizione <= data corrente <= data fine iscrizione (o data fine iscrizione nulla)
--    2 = Iscrizione chiusa e elenco valido --> data fine iscrizione < data corrente <= data termine validità (o data termine validità nulla)
--    0 = Iscrizione non ancora aperta o elenco non valido --> altrimenti
-- Il campo ISVALIDO assume i seguenti valori:
--    1 = Elenco valido       --> data corrente <= data fine validità (o data fine validità nulla)
--    0 = Elenco non valido   --> data fine validità < data corrente
create or replace view v_ws_elenchi as 
  select  g.ngara,g.codgar1 codgar, g.ngara codice,
    ga.oggetto,
    t.cenint codsa,u.nomein descsa,
    t.codrup respproc,tec.nomtec desrup, 
    t1.tab1tip codtipoelenco, t1.tab1desc desctipoelenco,
    ga.periodo, 
	p.datpub,
	ga.dinizval datinival,
	ga.dtermval datfinval,
	ter.dpubavvban datiniisc,
	ter.opubavvban orainiisc,
    ter.dtermpres datfinisc,
	ter.otermpres orafinisc,
	t.dultagg,
    ga.isarchi,
    (case when (now()>=ter.initpres and (now()<=ter.termpres or ter.dtermpres is null)) then '1' else '2' end) codstato,
	(case when (now()>=ter.initpres and (now()<=ter.termpres or ter.dtermpres is null)) then 'Iscrizione aperta' else 'Iscrizione chiusa' end) descstato,
	(case when (now()>=ter.initpres and (now()<=ter.termpres or ter.dtermpres is null)) 
	 then 1 
	 else (case when (now()>ter.termpres and (date_trunc('year',now())<=ga.dtermval or ga.dtermval is null)) then 2 else 0 end)
	 end) fase,
	 case when ga.dtermval < date_trunc('year',now()) then 0 else 1 end isvalido,
	 ga.tipoclass,
	 (case when ca.visprezzioe = '1' then 1 else 0 end) visprezzioe,
	 ca.numprodart,
	 g.genere,
	 (case when ga.iscrirt = '1' then 1 else 0 end) iscrirt,
	 (case when ga.pubope = '1' then 1 else 0 end) pubope,
	 (case when ga.coordsic = '1' then 1 else 0 end) coordsic
  from gare g, 
       garealbo ga left outer join  v_ws_elenchi_ter ter on (ga.codgar=ter.codgar)
	   left outer join mecatalogo ca on (ga.codgar=ca.codgar and ga.ngara=ca.ngara),
	   tab1 t1,
       (torn t left outer join uffint u  on (t.cenint=u.codein)
	           left outer join tecni tec on (t.codrup=tec.codtec)),
	   v_ws_bandi_pub p
  where ga.codgar=g.codgar1   and ga.ngara=g.ngara and g.codgar1 like '$%' and g.genere in (10,20)
    and ga.tipoele=t1.tab1tip and t1.tab1cod='A1071' 
    and ga.codgar=p.codgar
    and g.codgar1=t.codgar;

create or replace view v_ws_aggiscr_posticipate as 
select c.idcom, c.comkey1 usernome, c.comkey2 codice
from w_invcom c inner join garacquisiz ga on c.idprg=ga.idprg and c.idcom=ga.idcom
where ga.stato=1 and c.comtipo='FS4' and c.comstato='6';	

create or replace view v_ws_articoli_catalogo as
  select art.ngara, 
         art.nopega idcategoria,
         catoff codcategoria,
		 descat desccategoria, 
         id, 
		 tipo codtipoarticolo, 
		 tt.tab1desc desctipoarticolo, 
		 cod, 
		 descr, 
		 descrtecn, 
		 colore, 
		 case when obblimg='1' then 1 else 0 end obblimg,
		 case when obbldescagg='1' then 1 else 0 end obbldescagg,
		 case when obbldim='1' then 1 else 0 end obbldim,
		 case when obblcertif='1' then 1 else 0 end obblcertif,
		 certifrich, 
		 case when obblschtecn='1' then 1 else 0 end obblschtecn,
		 case when obblgar='1' then 1 else 0 end obblgar,
		 unimisprz codunimisprz, 
		 tup.tab1desc descunimisprz, 
		 decunimisprz,
		 unimisacq codunimisacq, 
		 tua.tab1desc descunimisacq, 
		 decunimisacq,
		 przunitper codprzunitper, 
		 tp.tab1desc descprzunitper, 
		 tempomaxcons, 
		 unimistempocons codunimistempocons, 
		 tc.tab1desc descunimistempocons,
		 note,
		 qunimisacq,
		 qminunimis,
		 qmaxunimis,
		 case when chkprod='1' then 1 else 0 end chkprod
  from opes c inner join cais cat on (cat.caisim=c.catoff and (cat.isarchi is null or cat.isarchi <> '1'))
            inner join meartcat art on c.ngara3=art.ngara and c.nopega=art.nopega
			inner join tab1 tt on art.tipo=tt.tab1tip and tt.tab1cod='ME001'
			inner join tab1 tup on art.unimisprz=tup.tab1tip and tup.tab1cod='ME007'
			inner join tab1 tua on art.unimisacq=tua.tab1tip and tua.tab1cod='ME007'
			inner join tab1 tp on art.przunitper=tp.tab1tip and tp.tab1cod='ME003'
			inner join tab1 tc on art.unimistempocons=tc.tab1tip and tc.tab1cod='ME004'
  where art.stato=2;
  	
create or replace view v_ws_schede_tecn_articolo as
  select idartcat, art.iddocdig as iddoc, w.dignomdoc as descdoc, w.dignomdoc filedoc, cast(null as timestamp) datpub
  from meallartcat art inner join w_docdig w on (art.iddocdig=w.iddocdig and art.idprg=w.idprg);

-- view per estrarre tutti i prodotti di un mercato elettronico
create or replace view v_ws_prodotti as
	select 
		id,
		codgar,
		codimp,
		ngara,
		idartcat,
		qunimisprz,
		qunimisacq, 
		tempocons,
		marcaprodut,
		codprodut,
		nome,
		codoe,
		przunit,
		przunitprod,
		descagg,
		dimensioni,
		garanzia,
		perciva codperciva,
		ti.tab1desc descperciva,
		datscadoff,
		stato codstato,
		ts.tab1desc descstato,
		u.usernome
	from meiscrizprod
		inner join v_ws_ditg on ngara=ngara5 and codimp=dittao
		inner join w_puser u on codman=u.userkey1 and u.userent='IMPR'
		inner join tab1 ti on perciva=ti.tab1tip and ti.tab1cod='G_055'
		inner join tab1 ts on stato=ts.tab1tip and ts.tab1cod='ME005';

-- view per estrarre tutti i prodotti in catalogo (e quindi usabili) per il mercato elettronico
create or replace view v_ws_prodotti_in_catalogo as
	select * from v_ws_prodotti where codstato=4;
	
-- view per estrarre tutti i documenti caricati per un prodotto
create or replace view v_ws_prodotti_allegati as
  select idiscrizprod, tipo, prod.iddocdig as iddoc, w.dignomdoc as descdoc, w.dignomdoc filedoc, cast(null as timestamp) datpub
  from mealliscrizprod prod inner join w_docdig w on (prod.iddocdig=w.iddocdig and prod.idprg=w.idprg);

-- view per estrarre tutti gli operatori abilitati a cataloghi elettronici
create or replace view v_ws_oe_abilitati_catalogo as
	select ngara5 as codice, dittao as codimp, usernome
	from v_ws_ditg inner join w_puser on codman=userkey1 and userent='IMPR' inner join gare on ngara5=ngara
	where genere=20 and abilitaz=1;

-- view per estrarre tutti gli operatori abilitati a effettuare il rinnovo a catalogo o elenco
create or replace view v_ws_oe_abilitati_rinnovo as
	select ngara5 as codice, dittao as codimp, usernome
	from v_ws_ditg inner join w_puser on codman=userkey1 and userent='IMPR' inner join gare g on ngara5=g.ngara inner join garealbo a on g.ngara=a.ngara
	where genere in (10,20) 
	and a.tipologia <> 3
	and a.valiscr is not null
	and abilitaz in (1,8) 
	and not exists (select idcom from w_invcom where idprg='PA' and comtipo='FS3' and comstato=5 and comkey1=usernome and comkey2=ngara5);

create or replace view v_ws_fornitori_catiscrizione as 
  select c.ngara, c.codgar,
        (case when c.codgar like '$%' then replace(c.codgar,'$','') else c.codgar end) codice,
        c.codimp,c.codcat categoria,c.tipcat tipocategoria,c.infnumclass clasmin,c.supnumclass clasmax, c.ultinf nota, u.usernome, d.coordsic
  from iscrizcat c, v_ws_ditg d, w_puser u
  where c.codimp=d.dittao and c.ngara=d.ngara5
  and d.codman=u.userkey1 and userent='IMPR'
  and codcat <> '0';

-- estrae gli allegati alle comunicazioni ricevute dal backoffice e quelli inviati dal portale (come sola richiesta di comunicazione)
create or replace view v_ws_comunicazioni_documenti as 
  select d.idprg, d.idcom,w.iddocdig iddoc, case when w.digdesdoc is null then 'Allegato' else w.digdesdoc end descdoc, w.dignomdoc filedoc, cast(null as timestamp) datpub
  from w_invcom d, w_docdig w
  where
       d.idprg='PG' and
       w.digkey1=d.idprg and
       w.digkey2=cast(d.idcom as text) and 
       w.digent='W_INVCOM' and 
       w.idprg=d.idprg
  union all
  select d.idprg, d.idcom,w.iddocdig iddoc, case when w.digdesdoc is null then 'Allegato' else w.digdesdoc end descdoc, w.dignomdoc filedoc, cast(null as timestamp) datpub
  from w_invcom d, w_docdig w
  where
       d.idprg = 'PA' and
       w.digkey1=cast(d.idcom as text) and 
       w.digent='W_INVCOM' and 
       w.idprg=d.idprg and
	   d.comtipo = 'FS12';
	   
-- nella 6.11.3 con la gestione dei rinnovi va tolta la condizione "d.fasele is null or"
create or replace view v_ws_elenchi_documenti as 
  select gl.ngara,gl.codice,d.norddocg ordine,d.numord,w.iddocdig iddoc,d.urldoc,case when d.descrizione is null then '(descrizione non presente)' else d.descrizione end descdoc,w.dignomdoc filedoc, d.gruppo,
    d.tipodoc codtipodoc,t1.tab1desc desctipodoc,d.contestoval,case when d.obbligatorio='1' then 1 else 0 end obbligatorio,
    case when (d.fasele is null or d.fasele=1 or d.fasele=2) then 1 else 0 end dociscrizione,
    case when (d.fasele is null or d.fasele=2 or d.fasele=3) then 1 else 0 end docrinnovo,
    d.modfirma codformato, cast(null as timestamp) datpub
  from v_ws_elenchi gl,
      (documgara d left outer join w_docdig w on (d.iddocdg=w.iddocdig and w.digent='DOCUMGARA'  and w.idprg='PG')
	               left outer join tab1 t1    on (t1.tab1cod='A1057'   and t1.tab1tip=d.tipodoc))
  where gl.ngara=d.ngara 
    and (d.fasgar=1 or d.fasgar is null)
	and (d.isarchi is null or d.isarchi='0');

create or replace view v_ws_elenchi_categorie as 
  select ngara3 ngara,nopega numord,catoff codice,cat.descat descrizione,
	tt.tab1tip tipoappalto, tt.tab1nord numordtipoappalto, t5.tab5desc titolo,
	codliv1, codliv2, codliv3, codliv4, 
	case when cat.codliv4 is not null then 5 when cat.codliv3 is not null then 4 when cat.codliv2 is not null then 3 when cat.codliv1 is not null then 2 else 1 end livello,
	case when (select count(*) from cais where cais.codliv1=cat.caisim or cais.codliv2=cat.caisim or cais.codliv3=cat.caisim or cais.codliv4=cat.caisim)=0 then 1 else 0 end foglia,
	caisord,
	case when substr(tord.tab1desc,1,1)='2' then upper(cat.descat) else upper(catoff) end ordcategorie
  from (opes c inner join cais cat on (cat.caisim=c.catoff and (cat.isarchi is null or cat.isarchi <> '1'))
               left outer join tab1 tt on (tt.tab1cod='G_038' and cat.tiplavg=tt.tab1tip)
               left outer join tab5 t5 on (t5.tab5cod='G_j05' and cat.titcat=t5.tab5tip) )
			   left outer join tab1 tord on (tord.tab1cod = 'G_057' and tord.tab1tip=1),
	   v_ws_elenchi e
  where e.ngara= c.ngara3;

-- view per estrarre l''alberatura delle categorie iscritte di ogni impresa
create or replace view v_ws_elenchi_cat_iscritte as  
  SELECT cat.ngara, cat.codice, descrizione, tipoappalto, titolo, codliv1, codliv2, codliv3, codliv4, livello, foglia, caisord, ordcategorie, usernome
    FROM v_ws_elenchi_categorie cat inner join v_ws_fornitori_catiscrizione iscr on cat.ngara=iscr.ngara and cat.codice=iscr.categoria;

create or replace view v_ws_comunicazioni_primo_dest as  
  select min(idcomdes) minidcomdes, idcom, descodsog from w_invcomdes group by idcom, descodsog;

-- view per estrarre le comunicazioni che l''amministrazione invia agli operatori, siano esse comunicazioni pubbliche, siano esse riservate e destinate all''impresa 
-- sia quando partecipa singolarmente che in RTI come mandataria
create or replace view v_ws_comunicazioni_da_sa as 
    select comkey1 codice, m.idcom, null idcomdes,
	m.commsgogg, m.commsgtes,
	m.comdatins, DATE_TRUNC('day', m.comdatapub) datainvio, m.comdatapub dataorainvio, null dataoralettura, null nomeuser, comdatprot dataoraprotocollo, comnumprot numprotocollo, idcfg,
	0 bloccarispondi,
	m.idprgris, m.idcomris, d.desintest, m.committ, m.commodello, m.comtipma, m.comdatsca, m.comorasca
    from w_invcom m left outer join w_invcomdes d on (d.idcom=m.idcom)
	where m.idprg='PG'
	  and compub=1 
	  and (comstato='3' or comstato='4') 
  union all
    select comkey1 codice, m.idcom, d.idcomdes,
	m.commsgogg, m.commsgtes,
	m.comdatins, DATE_TRUNC('day', d.desdatinv) datainvio, d.desdatinv dataorainvio, d.desdatlet dataoralettura, u.usernome nomeuser, comdatprot dataoraprotocollo, comnumprot numprotocollo, idcfg,
	case when comnorispondi='1' then 1 else 0 end bloccarispondi,
	m.idprgris, m.idcomris, d.desintest, m.committ, m.commodello, m.comtipma, m.comdatsca, m.comorasca
    from (w_invcom m inner join w_invcomdes d on (m.idcom=d.idcom)
	                 inner join impr i        on (i.codimp = d.descodsog)
	                 inner join w_puser u     on (u.userent='IMPR' AND u.userkey1=d.descodsog))
					 inner join v_ws_comunicazioni_primo_dest d2 on (d.idcom=d2.idcom and d.descodsog = d2.descodsog)
    where m.idprg='PG' 
      and compub=2 
	  and (comstato='3' or comstato='4' or comstato='10' or comstato='11') 
      and (i.tipimp is null or i.tipimp not in (3,10))
	  and d.idcomdes = d2.minidcomdes
  union all
    select comkey1 codice, m.idcom, d.idcomdes,
	m.commsgogg, m.commsgtes,
	m.comdatins, DATE_TRUNC('day', d.desdatinv) datainvio, d.desdatinv dataorainvio, d.desdatlet dataoralettura, u.usernome nomeuser, comdatprot dataoraprotocollo, comnumprot numprotocollo, idcfg,
	case when comnorispondi='1' then 1 else 0 end bloccarispondi,
	m.idprgris, m.idcomris, d.desintest, m.committ, m.commodello, m.comtipma, m.comdatsca, m.comorasca
    from (w_invcom m inner join w_invcomdes d on (m.idcom=d.idcom)
	                 inner join impr i        on (i.codimp = d.descodsog)
	                 inner join ragimp r      on (r.codime9 = i.codimp)
	                 inner join w_puser u     on (u.userent='IMPR' AND u.userkey1=r.coddic))
					 inner join v_ws_comunicazioni_primo_dest d2 on (d.idcom=d2.idcom and d.descodsog = d2.descodsog)
    where m.idprg='PG' 
      and compub=2 
	  and (comstato='3' or comstato='4' or comstato='10' or comstato='11') 
      and i.tipimp in (3,10)
      and r.impman = '1'
	  and d.idcomdes = d2.minidcomdes;

-- view per estrarre le comunicazioni che gli operatori inviano tramite portale all''amministrazione
create or replace view v_ws_comunicazioni_per_sa as 
    select idcom, comkey1 nomeuser, comkey2 codice, commsgogg oggetto, commsgtes testo, DATE_TRUNC('day', comdatins) datainvio, comdatins dataorainvio, comdatlet dataoralettura, comdatprot dataoraprotocollo, comnumprot numprotocollo, idcfg, committ, commodello, comtipma, comdatsca, comorasca
    from w_invcom 
	where idprg='PA'
	  and coment is null
	  and comtipo='FS12'
	  and comstato='3';

-- view per estrarre gli invii effettivamente effettuati dall''operatore (si escludono i chiarimenti, si pone in join lo stato per evitare di estrarre comunicazioni updatate a stati inesistenti)
create or replace view v_ws_invii as
	select idcom, comkey1, comkey2, comtipo, comstato, comdatastato
	from w_invcom inner join tab2 on comstato = tab2tip and tab2cod = 'G_z20'
	where idprg='PA' and comstato <> '1' and comtipo <> 'FS12';

create or replace view v_ws_elenchi_ricisc as 
  select comkey1,comkey2, (case when comstato='1' then 1 else 2 end) stato
  from w_invcom  com
  where idprg='PA' and comtipo='FS2'
  and idcom=(select max(idcom) from w_invcom com2 where com2.idprg=com.idprg and com2.comtipo=com.comtipo and com2.comkey1=com.comkey1 and com2.comkey2=com.comkey2 and com2.comstato IN ('1','5','6','7'))
  and (comstato in ('1','5') 
       or
	   (comstato in ('6','7') and exists(select ngara5 from v_ws_ditg d, w_puser u where d.ngara5=com.comkey2 and d.codman=u.userkey1 and u.userent='IMPR' and u.usernome=com.comkey1))
	   )
UNION
  select u.usernome, d.ngara5, 2
  from ditg d, w_puser u
  where u.userent='IMPR' and u.userkey1=d.dittao
  and not exists(select idcom from w_invcom c where idprg='PA' and comtipo='FS2' and c.comkey1=u.usernome and d.ngara5=c.comkey2);

create or replace view v_ws_fornitori as 
  select codimp,nomest, natgiui, tipimp, cfimp, pivimp, nome as nometec, cognome as cognometec, 
       indimp as indirizzo, nciimp as civico, capimp as cap, locimp as comune, proimp as provincia, t1.tab1desc as nazione,
	   mgsflg, indweb, telimp, faximp, telcel, emaiip, emai2ip,
	   inctec, dnatec, cnatec, pronas, sextec, 
	   tipalb, albtec, datalb, ts.tabcod3 as proalb, 
	   tcapre, ncapre,
	   nisanc, disanc, dscanc, duranc, dtrisoa, dversoa, octsoa, dantim,
	   ninps, dinps, linps, posinps, ninail, dinail, linail, posinail, ncedil, dcedil, lcedil, codcedil, aistprev, 
	   coorba, codbic, sogmov, codatt,
	   numiso, datiso, octiso, acertatt, dscnos, (case when rinnos='2' then '0' else rinnos end) flag_rinnos, drinos, zoneat,
	   oggsoc, 
	   (case when soggdurc='2' then '0' else soggdurc end) flag_soggdurc,
	   settprod, 
	   (case when assobbl='2' then '0' else assobbl end) flag_assobbl,
	   (case when ismpmi='2' then '0' else ismpmi end) flag_ismpmi,
	   (case when iscriwl = '2' then '0' else iscriwl end) iscriwl, 
       wlprefe, wlsezio, wldiscri, wldscad, 
       (case when wlincorso = '2' then '0' else wlincorso end) wlincorso, 
	   cladim,
	   (case when iscriae = '2' then '0' else iscriae end) iscriae, 
	   aedscad,
	   (case when aeincorso = '2' then '0' else aeincorso end) aeincorso, 
	   (case when iscriesp = '2' then '0' else iscriesp end) iscriesp, 
	   (case when iscrirat = '2' then '0' else iscrirat end) iscrirat, 
	   rating, ratdscad,
	   (case when ratincorso = '2' then '0' else ratincorso end) ratincorso, 
	   usernome,userent,
	   i.ultdic, i.regfisc, i.sociounico, i.dintsoa
  from impr i 
       left outer join tab1 t1 on (i.nazimp=t1.tab1tip and 'Ag010'=t1.tab1cod)
	   left outer join tabsche ts on (ts.tabcod= 'S2003' and ts.tabcod1= '07' and i.proalb = ts.tabcod2),
       w_puser p
  where 
	i.codimp=p.userkey1;

	
create or replace view v_ws_fornitori_cciaa as 		  
  select codimp, regdit, discif, ncciaa, dcciaa, ts.tabcod3 as pcciaa, dantim,
		 (case when iscrcciaa='2' then '0' else iscrcciaa end) flag_iscrcciaa
  from impr i left outer join tabsche ts on (ts.tabcod= 'S2003' and ts.tabcod1= '07' and i.pcciaa = ts.tabcod2);

create or replace view v_ws_fornitori_indirizzi as 		  
  select codimp5 as codimp,indtip,indind as indirizzo,indnc as civico,indloc as comune,indpro as provincia, t1.tab1desc as nazione, indcap as cap,indtel as telimp,indfax as faximp 
    from impind left outer join tab1 t1 on (nazimp=t1.tab1tip and 'Ag010'=t1.tab1cod);
	
create or replace view v_ws_fornitori_tec as 
  select codleg codtim, codimp2 as codimp,1 as inctim, 1 as incprog, cast(null as numeric) as incqual, notleg as incnote, legini as incini,legfin as incfin, (case when respdich='2' then '0' else respdich end) flag_respdich, id
  from impleg il,teim t
  where codleg=t.codtim
  union
  select coddte codtim, codimp3 as codimp,2 as inctim, 1 as incprog, cast(null as numeric) as incqual, notdte as incnote, dirini as incini,dirfin as incfin, (case when respdich='2' then '0' else respdich end) flag_respdich, id
  from impdte id,teim t
  where coddte=t.codtim
  union
  select codtec codtim, codimp4 as codimp,3 as inctim, numazi as incprog, incazi as incqual, notazi as incnote, iniazi as incini,finazi as incfin, (case when respdich='2' then '0' else respdich end) flag_respdich, numazi id
  from impazi ia,teim t
  where codtec=t.codtim
  union
  select codtec codtim, codimp,4 as inctim, numcol as incprog, inctip as incqual, notcol as incnote, incini, incfin, null flag_respdich, numcol id
  from g_impcol ic,teim t
  where codtec=t.codtim;

create or replace view v_ws_fornitori_datiannui as
  select codimp, anno, numdip
  from impanno;

create or replace view v_ws_tecnici as 
  select codtim, 
     cogtim, nometim, inctec as inctim, cftim, pivatei, sextim, dnatim, cnatim, pronas,
	 indtim as indirizzo, ncitim as civico, captim as cap, loctim as comune, protim as provincia, t1.tab1desc as nazione,
	 tipalb, albtim as albtec, datalb, ts.tabcod3 as proalb, tcapre, ncapre
  from teim t 
     left outer join tab1 t1 on (t.naztim=t1.tab1tip and 'Ag010'=t1.tab1cod)
	 left outer join tabsche ts on (ts.tabcod= 'S2003' and ts.tabcod1= '07' and t.proalb = ts.tabcod2);

create or replace view v_ws_tipi_impresa as 
  select tab1tip codice,tab1desc descrizione, (case when tab1tip>5 then 1 else 0 end) ditta_individuale, (case when tab1tip=6 then 1 else 0 end) libero_professionista, (case when tab1tip=13 then 1 else 0 end) impresa_sociale, (case when tab1tip=2 or tab1tip=11 then 1 else 0 end) consorzio, tab1nord ordine
  from tab1 
  where tab1cod='Ag008' and (tab1tip<>3 and tab1tip<>10);

-- oltre le gare pubbliche (aperte e ristrette), si recuperano anche le negoziate non in corso 
-- in modo da vederle nella lista dei bandi scaduti
create or replace view v_ws_bandi as 
	select t.codgar, t.codice, t.oggetto,t.importo,
	   t.genere tipologia,
	   torn.cenint codsa,uffint.nomein descsa, uffint.cfein cfiscsa, 
	   uffint.tipoin codtipsa, uffint.proein, uffint.citein, uffint.viaein, uffint.nciein,
	   torn.codrup,
	   torn.ricmano,
	   torn.modmano,
	   t.tipgen codtipoapp, t1.tab1desc desctipoapp,
	   t.tipgar codtipogar, t2.tab1desc desctipogar,
	   torn.iterga coditergara,
	   (case when t.genere=2 then gare.critlicg else torn.critlic end) codcriagg, 
	   (case when t.genere=2 then t3.tab1desc else t4.tab1desc end) desccriagg,
	   (case when t.genere=2 then gare.modlicg else torn.modlic end) codmodagg,
	   pb.datpub,
	   torn.dtepar datterminepar,
	   torn.otepar oraterminepar,
	   torn.dinvit datletterainv,
	   torn.dteoff dattermineoff, 
	   torn.oteoff oratermineoff,
       case when torn.dtepar is not null then
        to_timestamp(to_char(torn.dtepar,'YYYY/MM/DD') || ' ' || 
         case when torn.otepar is not null and length(torn.otepar)=5  
         and (to_number(substr(torn.otepar,1,2),'9999D0000') between 0 and 23)
         and (to_number(substr(torn.otepar,4,2),'9999D0000') between 0 and 60)
         and substr(torn.otepar,3,1)=':' 
         then torn.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone 
         else NULL end dataoraterminepar,
       case when torn.dteoff is not null then
        to_timestamp(to_char(torn.dteoff,'YYYY/MM/DD') || ' ' || 
         case when torn.oteoff is not null and length(torn.oteoff)=5  
         and (to_number(substr(torn.oteoff,1,2),'9999D0000') between 0 and 23)
         and (to_number(substr(torn.oteoff,4,2),'9999D0000') between 0 and 60)
         and substr(torn.oteoff,3,1)=':'
         then torn.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone
         else NULL end dataoratermineoff,
		case when torn.dtepar is null then torn.dteoff else torn.dtepar end dattermine,
		case when torn.dtepar is null then torn.oteoff else torn.otepar end oratermine,
		t.codcig codcigall,
		(case when t.genere=2 then t.codcig else null end) codcig,
		coalesce(gare.cupprg,'') codcupprg,
		t.isarchi,
		gse.codstato codstatogara,
		gse.stato descstatogara,
		gse.esito descstatoesito,
		pe.dinpubg dataesito,
		GREATEST(EXTRACT(year FROM pb.datpub), coalesce(EXTRACT(year FROM pe.dinpubg),1000)) annoinizioperscadenza,
		torn.dultagg,
		(case when t.gartel = '1' then 1 else 0 end) gartel,
		(case when torn.offtel = '1' then 1 else 0 end) offtel,
		(case when t.genere=3 then (case when gare.bustalotti = 2 then 0 else 1 end) else null end) bustedistinte,
		(case when torn.ricastae='1' then 1 else 0 end) ricastae,
		(case when torn.offaum = '1' then 1 else 0 end) offaum,
		(case when torn.accqua = '1' then 1 else 0 end) isaccordoquadro,
	    (case when torn.aqoper = 2 then 1 else 0 end) naggiudicatari,
		torn.valoff,
		gare.fasgar,
		torn.codscp, torn.urlscp,
		(case when gare.preced is not null then 1 else 0 end) rilancio,
	  --dati solo per gara lotto unico
		cast((case when t.genere=2 then coalesce(gare.impnrl,0) else null end) as numeric(24,5)) impnoribasso,
		cast((case when t.genere=2 then coalesce(gare.impsic,0) else null end) as numeric(24,5)) impsicurezza,
		cast((case when t.genere=2 then coalesce(gare.onprge,0) else null end) as numeric(24,5)) imponeriprogett,
 	    cast((case when t.genere=2 then gare.iaggiu else null end) as numeric(24,5)) iaggiu,
		0 costofisso,
		0 ribcal,
		0 sicinc,
		0 onsogrib,
		0 isoffpermuta,
		0 isoffcanoneass,
		gare1.aedinvit,
		(case when torn.inversa='1' then 1 else 0 end) inversa,
		(case when torn.sommaur='1' then 1 else 0 end) sommaur,
		torn.altrisog,
		torn.garpriv,
		torn.prerib
from v_ws_bandi_pub_ris pb 
	inner join v_gare_torn t on (t.codgar=pb.codgar)
	inner join v_gare_statoesito gse on (t.codgar=gse.codgar)
	inner join torn on (t.codgar=torn.codgar)
	left outer join gare on (t.codice=gare.ngara)
	left outer join uffint on (torn.cenint=uffint.codein)
	left outer join gare1 on (t.codice=gare1.ngara)
	left outer join v_ws_esiti_pub pe on (t.codgar=pe.codgar)
	left outer join tab1 t1 on (t.tipgen=t1.tab1tip and t1.tab1cod='A1007')
	left outer join tab1 t2 on (t.tipgar=t2.tab1tip and t2.tab1cod='A2044')
	left outer join tab1 t3 on (gare.critlicg=t3.tab1tip and t3.tab1cod='A2081')
	left outer join tab1 t4 on (torn.critlic=t4.tab1tip and t4.tab1cod='A2081')
where torn.cenint is not null;

create or replace view v_ws_bandi_per_partecipazione as 
  select ga.ngara,ga.codgar, ga.codice,
    ga.oggtor oggetto,	   
    ga.imptor importo,
	ga.impnoribasso,
	ga.impsicurezza,
	ga.imponeriprogett,
    ga.tipologia,
    ga.codsa, ga.descsa,
    ga.respproc, ga.descrup,
    ga.codtipoapp, ga.desctipoapp,
    ga.codtipogar, ga.desctipogar,
	ga.coditergara,
    ga.codcriagg, ga.desccriagg,
	ga.codmodagg,
	ga.valtec,
	ga.costofisso,
    ga.datpub,
    ga.dattermineoff dattermineoff,ga.oratermineoff,
	ga.datterminepar datterminepar,ga.oraterminepar,
	case when ga.dattermineoff is not null then ga.dattermineoff else ga.datterminepar end dattermine,
	case when ga.dattermineoff is not null then ga.oratermineoff else ga.oraterminepar end oratermine,
	ga.dultagg,
	ga.codcig, ga.codcupprg,
    ga.isarchi,
    gse.codstato codstatogara,
	gse.stato descstatogara,
	ga.dataesito,	
	gse.esito descstatoesito,
	ga.isaccordoquadro, ga.naggiudicatari,
	ga.gartel, ga.offtel, ga.ribcal, ga.offaum, ga.sicinc, ga.onsogrib, ga.isoffpermuta, ga.isoffcanoneass, ga.valoff, ga.bustedistinte, 
	p.usernome,
	ga.ricastae, ga.aedinvit, ga.fasgar,
	ga.inversa
  from  v_ws_gare_lotti_pubbliche ga inner join v_gare_statoesito gse on (ga.codice=gse.codice),
        w_puser p    
  where ga.ngara=(select max(ngara) from v_ws_gare_lotti ga1 where ga1.codice=ga.codice and ga1.tipologia<>4) 
	and ga.dataoraterminepar>=now()
	and gse.codstato <> 3;
	
create or replace view v_ws_gare_lotti_inviti as 
    select codice, usernome, max(ngara) ngara 
    from v_ws_gare_lotti ga1, v_ws_ditg i, w_puser p 
    where ga1.ngara=i.ngara5 and i.invgar=1 and p.userkey1=i.codman 
    group by codice, usernome;

create or replace view v_ws_gare_lotti_per_offerta as 
    select codice, max(ngara) ngara from v_ws_gare_lotti where tipologia<>4 group by codice;

create or replace view v_ws_bandi_per_offerta as 
  select ga.ngara,ga.codgar, ga.codice,
    ga.oggtor oggetto,	   
    ga.imptor importo,
	ga.impnoribasso,
	ga.impsicurezza,
	ga.ricmano,
	ga.modmano,
	ga.imponeriprogett,
    ga.tipologia,
    ga.codsa, ga.descsa,
    ga.respproc, ga.descrup,
    ga.codtipoapp, ga.desctipoapp,
    ga.codtipogar, ga.desctipogar,
	ga.coditergara,
    ga.codcriagg, ga.desccriagg,
	ga.codmodagg,
	ga.valtec,
	ga.costofisso,
    ga.datpub,
    ga.dattermineoff dattermineoff,ga.oratermineoff,ga.dataoratermineoff,
	ga.datterminepar datterminepar,ga.oraterminepar,ga.dataoraterminepar,
	case when ga.dattermineoff is not null then ga.dattermineoff else ga.datterminepar end dattermine,
	case when ga.dattermineoff is not null then ga.oratermineoff else ga.oraterminepar end oratermine,
	ga.dultagg,
	ga.codcig, ga.codcupprg,
    ga.isarchi,
    gse.codstato codstatogara,
	gse.stato descstatogara,
	ga.dataesito,	
	gse.esito descstatoesito,
	ga.isaccordoquadro, ga.naggiudicatari,
	ga.gartel, ga.offtel, ga.ribcal, ga.offaum, ga.sicinc, ga.onsogrib, ga.isoffpermuta, ga.isoffcanoneass, ga.valoff, ga.bustedistinte, 
	datletterainv,
	ga2.usernome,
	ga.ricastae, ga.aedinvit, ga.fasgar,
	ga.rilancio,
	ga.inversa,
	ga.sommaur,
	ga.altrisog,
	ga.garpriv,
	ga.prerib
  from v_ws_gare_lotti_riservate ga 
	   inner join v_gare_statoesito gse on (ga.codice=gse.codice)
	   inner join v_ws_gare_lotti_inviti ga2 on (ga.ngara = ga2.ngara)
  where ga.dataoratermineoff is not null 
	--and ga.dataoratermineoff>=now()
	--and (ga.dataoraterminepar is null or ga.dataoraterminepar<now()) and datletterainv is not null	
	and datletterainv is not null		
	and gse.codstato <> 3
  union 
    select ga.ngara,ga.codgar, ga.codice,
    ga.oggtor oggetto,
    ga.imptor importo,
	ga.impnoribasso,
	ga.impsicurezza,
	ga.ricmano,
	ga.modmano,
	ga.imponeriprogett,
    ga.tipologia,
    ga.codsa, ga.descsa,
    ga.respproc, ga.descrup,
    ga.codtipoapp, ga.desctipoapp,
    ga.codtipogar, ga.desctipogar,
	ga.coditergara,
    ga.codcriagg, ga.desccriagg,
	ga.codmodagg,
	ga.valtec,
	ga.costofisso,
    ga.datpub,
    ga.dattermineoff dattermineoff,ga.oratermineoff,ga.dataoratermineoff,
	ga.datterminepar datterminepar,ga.oraterminepar,ga.dataoraterminepar,
	case when ga.dattermineoff is not null then ga.dattermineoff else ga.datterminepar end dattermine,
	case when ga.dattermineoff is not null then ga.oratermineoff else ga.oraterminepar end oratermine,
	ga.dultagg,
	ga.codcig, ga.codcupprg,
    ga.isarchi,
    gse.codstato codstatogara,
	gse.stato descstatogara,
	ga.dataesito,	
	gse.esito descstatoesito,
	ga.isaccordoquadro, ga.naggiudicatari,
	ga.gartel, ga.offtel, ga.ribcal, ga.offaum, ga.sicinc, ga.onsogrib, ga.isoffpermuta, ga.isoffcanoneass, ga.valoff, ga.bustedistinte, 
	datletterainv,
	p.usernome,
	ga.ricastae, ga.aedinvit, ga.fasgar,
	ga.rilancio,
	ga.inversa,
	ga.sommaur,
	ga.altrisog,
	ga.garpriv,
	ga.prerib
  from v_ws_gare_lotti_pubbliche ga 
       inner join v_gare_statoesito gse on (ga.codice=gse.codice)
	   inner join v_ws_gare_lotti_per_offerta ga1 on (ga1.codice=ga.codice and ga.ngara=ga1.ngara),
	   w_puser p   
  where ga.dataoratermineoff is not null 
    --and ga.dataoratermineoff>=now() 	
	and ga.dataoraterminepar is null 
	and datletterainv is null
	and gse.codstato <> 3;

create or replace view v_ws_bandi_per_comprovareq as 
  select ga.ngara,ga.codgar, ga.codice,
    ga.oggtor oggetto,	   
    ga.imptor importo,
	ga.impnoribasso,
	ga.impsicurezza,
	ga.ricmano,
	ga.modmano,
	ga.imponeriprogett,
    ga.tipologia,
    ga.codsa, ga.descsa,
    ga.respproc, ga.descrup,
    ga.codtipoapp, ga.desctipoapp,
    ga.codtipogar, ga.desctipogar,
	ga.coditergara,
    ga.codcriagg, ga.desccriagg,
	ga.codmodagg,
	ga.valtec,
	ga.costofisso,
    ga.datpub,
    ga.dattermineoff dattermineoff,ga.oratermineoff,
	ga.datterminepar datterminepar,ga.oraterminepar,
	case when ga.dattermineoff is not null then ga.dattermineoff else ga.datterminepar end dattermine,
	case when ga.dattermineoff is not null then ga.oratermineoff else ga.oraterminepar end oratermine,
	ga.dultagg,
	ga.dindoc,
	ga.codcig, ga.codcupprg,
    ga.isarchi,
    gse.codstato codstatogara,
	gse.stato descstatogara,
	ga.dataesito,	
	gse.esito descstatoesito,
	ga.isaccordoquadro, ga.naggiudicatari,
	ga.gartel, ga.offtel, ga.ribcal, ga.offaum, ga.sicinc, ga.onsogrib, ga.isoffpermuta, ga.isoffcanoneass, ga.valoff, ga.bustedistinte, 
	ga2.usernome,
	ga.ricastae, ga.aedinvit, ga.fasgar,
	ga.rilancio,
	ga.inversa,
	ga.sommaur,
	ga.altrisog,
	ga.garpriv,
	ga.prerib
  from  v_ws_gare_lotti_pub_ris ga inner join v_gare_statoesito gse on (ga.codice=gse.codice),
	    (select max(ngara) as ngara, codice, usernome from v_ws_gare_lotti ga1, v_ws_ditg i, w_puser p where ga1.ngara=i.ngara5 
	    							and i.invgar=1 and i.estimp=1 and (i.fasgar > 3 or i.fasgar is null)
  									and p.userkey1=i.codman group by codice, usernome) ga2   
  where ga.ngara=ga2.ngara
	and ga.dataoraterminedoc>=now()
	and gse.codstato <> 3;
	
create or replace view v_ws_bandi_per_procaggiud as 
  select ga.ngara,ga.codgar, ga.codice,
    ga.oggtor oggetto,	   
    ga.imptor importo,
	ga.impnoribasso,
	ga.impsicurezza,
	ga.ricmano,
	ga.modmano,
	ga.imponeriprogett,
    ga.tipologia,
    ga.codsa, ga.descsa,
    ga.respproc, ga.descrup,
    ga.codtipoapp, ga.desctipoapp,
    ga.codtipogar, ga.desctipogar,
	ga.coditergara,
    ga.codcriagg, ga.desccriagg,
	ga.codmodagg,
	ga.valtec,
	ga.costofisso,
    ga.datpub,
    ga.dattermineoff dattermineoff,ga.oratermineoff,
	ga.datterminepar datterminepar,ga.oraterminepar,
	case when ga.dattermineoff is not null then ga.dattermineoff else ga.datterminepar end dattermine,
	case when ga.dattermineoff is not null then ga.oratermineoff else ga.oraterminepar end oratermine,
	ga.dultagg,
	ga.codcig, ga.codcupprg,
    ga.isarchi,
    gse.codstato codstatogara,
	gse.stato descstatogara,
	ga.dataesito,	
	gse.esito descstatoesito,
	ga.isaccordoquadro, ga.naggiudicatari,
	ga.gartel, ga.offtel, ga.ribcal, ga.offaum, ga.sicinc, ga.onsogrib, ga.isoffpermuta, ga.isoffcanoneass, ga.valoff, ga.bustedistinte, 
	ga2.usernome,
	ga.ricastae, ga.aedinvit, ga.fasgar,
	ga.rilancio,
	ga.inversa,
	ga.sommaur,
	ga.altrisog,
	ga.garpriv,
	ga.prerib
  from  v_ws_gare_lotti_pub_ris ga inner join v_gare_statoesito gse on (ga.codice=gse.codice)        
		inner join torn t on (ga.codgar=t.codgar),
	    (select max(ngara) as ngara, codice, usernome from v_ws_gare_lotti ga1, v_ws_ditg i, w_puser p where ga1.ngara=i.ngara5 
  									and p.userkey1=i.codman group by codice, usernome) ga2   		
where ga.ngara = ga2.ngara
	and ga.dataoratermineoff<now();

create or replace view v_ws_bandi_per_aste as 
  select 
    ga.ngara, ga.codgar, ga.codice, ga.oggtor oggetto, ga.imptor importo, ga.impnoribasso, ga.impsicurezza, ga.ricmano, ga.modmano, ga.imponeriprogett, 
	ga.tipologia, 
	ga.codsa, ga.descsa, ga.respproc, ga.descrup, ga.codtipoapp, ga.desctipoapp, 
	ga.codtipogar, ga.desctipogar, ga.coditergara, ga.codcriagg, ga.desccriagg, ga.codmodagg, 
    ga.valtec, ga.costofisso, ga.datpub, ga.dattermineoff, ga.oratermineoff, ga.datterminepar, ga.oraterminepar, 
	case when ga.dattermineoff is not null 
         then ga.dattermineoff else ga.datterminepar end dattermine, 
	case when ga.dattermineoff is not null 
	     then ga.oratermineoff else ga.oraterminepar end  oratermine, 
    ga.dultagg, ga.codcig, ga.codcupprg, ga.isarchi, gse.codstato  codstatogara, gse.stato  descstatogara, 
    ga.dataesito, gse.esito  descstatoesito, ga.isaccordoquadro, ga.naggiudicatari, ga.gartel, ga.offtel, 
	ga.ribcal, ga.offaum, ga.sicinc, ga.onsogrib, ga.isoffpermuta, 
    ga.isoffcanoneass, ga.valoff, ga.bustedistinte, ga2.usernome, ga.ricastae, ga.aedinvit,
    f.dataoraini, f.dataorafine, 
	ga.fasgar, ga.rilancio,
	(case when t.inversa='1' then 1 else 0 end) inversa,
	(case when t.sommaur='1' then 1 else 0 end) sommaur,
	t.altrisog,
	t.garpriv,
	t.prerib
  from v_ws_gare_lotti_pub_ris ga 
       inner join v_gare_statoesito gse on ga.codice = gse.codice 
       inner join torn t on ga.codgar = t.codgar 
       inner join (select max(ga1.ngara) ngara, ga1.codice, p.usernome
                   from v_ws_gare_lotti ga1 
				        inner join v_ws_ditg i on ga1.ngara = i.ngara5 
						inner join w_puser p on i.codman = p.userkey1
                   group by ga1.codice, p.usernome) ga2 on ga.ngara = ga2.ngara
       inner join aefasi f on f.ngara = ga.ngara
  where (ga.dataoratermineoff < now());
	
create or replace view v_ws_lotti_per_partecipazione as 
  select ga.*,
		gse.stato descstatogara,
		gse.esito descstatoesito  
  from  v_ws_gare_lotti ga inner join v_gare_statoesitolotti gse on (ga.ngara=gse.codice)
	where gse.codstato <> 3
	and (ga.tipologia = 1 or ga.tipologia = 4)
    and (ga.dataoraterminepar is null or ga.dataoraterminepar>now()); 

create or replace view v_ws_lotti_per_offerta as
  select ga.*,
		gse.stato descstatogara,
		gse.esito descstatoesito,
		p.usernome,
		i.ncomope progofferta
  from  v_ws_gare_lotti ga inner join v_gare_statoesitolotti gse on (ga.ngara=gse.codice),
	    	 v_ws_ditg i, w_puser p 
	where ga.tipologia=1 
		and ga.ngara=i.ngara5 and i.invgar=1 and (i.ammgar<>'2' or i.ammgar is null)
  	and p.userkey1=i.codman 
		and ga.dataoratermineoff>=now()
		and (ga.dataoraterminepar is null or ga.dataoraterminepar<=now()) and datletterainv is not null
		and gse.codstato <> 3
  union 
  select ga.*,
		gse.stato descstatogara,
		gse.esito descstatoesito,
		p.usernome,
		null progofferta
  from  v_ws_gare_lotti ga inner join v_gare_statoesitolotti gse on (ga.ngara=gse.codice),
	    w_puser p   
  where ga.tipologia=1 
  	and ga.dataoratermineoff>=now()
    and ga.dataoraterminepar is null and datletterainv is null
	and gse.codstato <> 3;

create or replace view v_ws_lotti_per_offerte_pl_un as
  select ga.*,
         gse.stato descstatogara,
         gse.esito descstatoesito,
         p.usernome,
		 i.ncomope progofferta
   from  v_ws_gare_lotti ga inner join v_gare_statoesitolotti gse on (ga.ngara=gse.codice),
         v_ws_ditg i, w_puser p 
   where ga.tipologia=4
     and ga.gartel = 1
     and ga.bustedistinte = 1
	 and ga.ngara=i.ngara5 and (i.ammgar='1' or i.ammgar is null)     
     and p.userkey1=i.codman 
     and datletterainv is not null
union 
  select ga.*,
         gse.stato descstatogara,
         gse.esito descstatoesito,
         p.usernome,
		 null progofferta
   from  v_ws_gare_lotti ga inner join v_gare_statoesitolotti gse on (ga.ngara=gse.codice),
         w_puser p   
   where ga.tipologia=4
     and ga.gartel = 1
     and ga.bustedistinte = 1
     and datletterainv is null;

create or replace view v_ws_lotti_per_comprovareq as 
  select ga.*,
		gse.stato descstatogara,
		gse.esito descstatoesito,
		p.usernome,
		i.ncomope progofferta
  from  v_ws_gare_lotti ga inner join v_gare_statoesitolotti gse on (ga.ngara=gse.codice),
	    v_ws_ditg i, w_puser p 
	where ga.tipologia=1 
		and ga.ngara=i.ngara5 and i.invgar=1 and i.estimp=1 and (i.fasgar > 3 or i.fasgar is null)
  	and p.userkey1=i.codman  
		and ga.dataoraterminedoc>=now()
		and gse.codstato <> 3;

create or replace view v_ws_dettaglio_bando as 
  select ga.ngara,ga.codgar, case when ga.tipologia <> 4 then ga.codice else ga.ngara end codice,
    ga.oggtor oggetto,	   
    case when ga.tipologia = 4 then ga.importo else ga.imptor end importo,
	ga.impnoribasso,
	ga.impsicurezza,
	ga.ricmano,
	ga.modmano,
	ga.imponeriprogett,
    ga.tipologia,
    ga.codsa, ga.descsa,
    ga.respproc, ga.descrup,
    ga.codtipoapp, ga.desctipoapp,
    ga.codtipogar, ga.desctipogar,
	ga.coditergara,
    ga.codcriagg, ga.desccriagg,
	ga.codmodagg,
	ga.valtec,
	ga.costofisso,
    pb.datpub,
    ga.dattermineoff dattermineoff,ga.oratermineoff,
	ga.datterminepar datterminepar,ga.oraterminepar,
	ga.dattermine,
	ga.oratermine,
	ga.dultagg, 
	ga.codcig, ga.codcupprg,
    ga.isarchi,
    gse.codstato codstatogara,
	gse.stato descstatogara,
	gse.esito descstatoesito,
	ga.dataesito,
	ga.isaccordoquadro, ga.naggiudicatari,
	ga.gartel, ga.offtel, ga.ribcal, ga.offaum, ga.sicinc, ga.onsogrib, ga.isoffpermuta, ga.isoffcanoneass, ga.valoff, ga.bustedistinte, 
	ga.ricastae, ga.aedinvit, ga.fasgar,
	ga.rilancio,
	ga.inversa,
	ga.sommaur,
	ga.altrisog,
	ga.garpriv,
	ga.prerib
  from v_ws_bandi_pub_ris pb
       inner join v_ws_gare_lotti_tab ga  on (ga.codgar=pb.codgar)
       inner join v_gare_statoesito gse on (ga.codgar=gse.codgar)
       inner join v_ws_gare_lotti_per_offerta ga1 on (ga1.codice=ga.codice)
  where (ga.ngara=ga1.ngara or ga.bustedistinte=1);
	
-- View per estrarre la lista lavorazioni e forniture per inserire una offerta telematica
create or replace view v_ws_voci_dettaglio_offerta as 
  select gcap.ngara codice,
    gcap.contaf progressivo,
	norvoc numordine,
	codvoc,
	voce,
	(case when gcap.datacons is not null
		then coalesce(gcap_est.desest,'')||chr(10)||'Data consegna '||coalesce(to_char(gcap.datacons,'DD/MM/YYYY'),'')
		else gcap_est.desest end) desest,
	clasi1 codclasi1,
	tab1.tab1desc descclasi1,
	case when solsic = '1' then 1 else 0 end solsic,
	case when sogrib = '1' then 1 else 0 end sogrib,
	unimis.desuni unimis,
	quanti,
	prezun,
	gcap.peso
  from gcap 
  left outer join gcap_est on gcap.ngara = gcap_est.ngara and gcap.contaf = gcap_est.contaf
  left outer join unimis on gcap.unimis = unimis.tipo and unimis.conta=-1
  left outer join tab1 on gcap.clasi1 = tab1.tab1tip and tab1.tab1cod='A1051';

-- View per estrarre gli attributi aggiuntivi definiti per una gara a partire dagli attributi su XGCAP
create or replace view v_ws_attrib_agg_offerta as
select ngara codice, dyncam_name nome, dyncam_desc descrizione, gcd.numord,
    (case when coc_dom='DATA_ELDA' then 1 
          when coc_dom='MONEY' then 2 
          when c0c_tab1 is not null then 3 
          when coc_dom='SN' then 6 
          when substr(c0c_fs,1,1) in ('F','N') then 5 
          when substr(c0c_fs,1,1)='A' then
               case when coc_dom='NOTE' and c0c_fs='A2000' then 4 else 7 end
          end) tipo,
    (case when coc_dom='DATA_ELDA' then null
          when coc_dom='MONEY' then '15.2' 
          when c0c_tab1 is not null then null 
          when coc_dom='SN' then null 
          when substr(c0c_fs,1,1) in ('F','N','A') then substr(c0c_fs,2,length(c0c_fs)-1)
          end) formato,
    c0c_tab1 tabellato, 
	case when obbligatorio = '1' then 1 else 0 end obbligatorio
  from garconfdati gcd inner join dyncam d on d.dynent_name = 'XDPRE' and gcd.campo = d.dyncam_name inner join c0campi c on d.dyncam_name||'.'||d.dynent_name||'.GARE'=c.coc_mne_uni;

create or replace view v_ws_fornitori_ati as 
 select i.ngara5 ngara, i.codgar5 codgar,
       (case when i.codgar5 like '$%' then replace(i.codgar5,'$','') else i.codgar5 end) codice,
       codati, nomeati, codman, usernome,
	   i.ncomope progofferta
  from v_ws_ditg i inner join w_puser p on p.userkey1=codman;

create or replace view v_ws_mandanti_ati as 
select distinct codice, usernome, nomimp, tipimp, tab1desc as nazione, cfimp, pivimp, quodic, progofferta
  from v_ws_fornitori_ati 
       inner join ragimp on codati = codime9 and (impman is null or impman = '2' )
       inner join impr on coddic = codimp
       left outer join tab1 on tab1cod = 'Ag010' and nazimp = tab1tip;

create or replace view v_ws_avvisi as 
  select g.ngara ngara,t.codgar codgar, 
	(case when t.codgar like '$%' then replace(t.codgar,'$','') else t.codgar end) codice,
    case when g.genere in (10,20) then to_number(ge.tipoele,'9999D0000') else ga.tipoapp end codtipoapp,
    case when g.genere in (10,20) then t1.tab1desc else t2.tab1desc end desctipoapp,
	case when g.genere in (10,20) then 0 else ga.tipoavv end codtipoavv,
    case when g.genere in (10,20) then 'Elenco operatori economici' else t3.tab1desc end desctipoavv,
    case when g.genere in (10,20) then ge.oggetto else ga.oggetto end oggetto,
    t.cenint codsa, u.nomein descsa, u.cfein cfiscsa, u.tipoin codtipsa, t5.tab1desc desctipsa,
	case when usuap.codein is not null then usuap.proein else u.proein end provsede,
	case when usuap.codein is not null then usuap.citein else u.citein end comsede, 
	case when usuap.codein is not null then (usuap.viaein || case when usuap.nciein is not null then ',' else '' end || usuap.nciein) 
		else (u.viaein || case when u.nciein is not null then ',' else '' end || u.nciein) end indsede,
    t.codrup respproc,tec.nomtec descrup, 
    eb.datpub,
    t.isarchi,
	case when genere in (10,20) then ter.dtermpres else ga.datsca end datascadenza,
	case when genere in (10,20) then ter.otermpres else null end orascadenza,
    case when g.genere in (10,20) then (case when ter.termpres is not null then
		ter.termpres
		else to_timestamp('9999/12/31 23:59:59', 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone end
		)
        else (case when ga.datsca is not null then
        to_timestamp(to_char(ga.datsca,'YYYY/MM/DD') || ' ' || '23:59:59', 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone
        else to_timestamp('9999/12/31 23:59:59', 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone end) end dataorascadenza,
	case when g.genere in (10,20) 
		then GREATEST(EXTRACT(year FROM eb.datpub), coalesce(EXTRACT(year FROM ter.termpres),1000))
		else GREATEST(EXTRACT(year FROM eb.datpub), coalesce(EXTRACT(year FROM ga.datsca),1000)) end annoinizioperscadenza,
	t.dultagg,
	t.codscp, t.urlscp,
	t.altrisog,
	t.garpriv,
	t.prerib
  from  gare g inner join torn t on (g.codgar1=t.codgar)
        inner join v_ws_bandi_pub eb on (t.codgar=eb.codgar)
		left outer join uffint u on (u.codein=t.cenint)
		left outer join tecni tec on (tec.codtec=t.codrup)
		left outer join garealbo ge on (g.ngara=ge.ngara)
		left outer join gareavvisi ga on (g.ngara=ga.ngara)
		left outer join v_ws_elenchi_ter ter on (g.ngara=ter.ngara)
		left outer join tab1 t1 on (t1.tab1cod='A1071' and t1.tab1tip=to_number(ge.tipoele,'9999D0000'))
		left outer join tab1 t2 on (t2.tab1cod='A1071' and t2.tab1tip=ga.tipoapp)
		left outer join tab1 t3 on (t3.tab1cod='A1081' and t3.tab1tip=ga.tipoavv)
		left outer join tab1 t5 on (t5.tab1cod='G_044' and t5.tab1tip=u.tipoin)
		left outer join tab1 tabsuap on (tabsuap.tab1cod='A1089' and tabsuap.tab1tip=1)
		left outer join uffint usuap on (usuap.codein=tabsuap.tab1desc)
  where (g.genere in (10,20,11));
  
create or replace view v_ws_esiti_ultimo_lotto as 
	SELECT ga1.codice, max(ga1.ngara) AS ngaramax
	FROM v_ws_gare_lotti ga1, pubg
	WHERE ga1.ngara = pubg.ngara
	AND pubg.tippubg=12 and pubg.dinpubg<=now()
	group by ga1.codice;

create or replace view v_ws_esiti as 
  select ga.ngara,ga.codgar, ga.codice,
    ga.oggtor oggetto,
    ga.imptor importo,
	ga.impnoribasso,
	ga.impsicurezza,
	ga.imponeriprogett,
    ga.tipologia,
    ga.codsa, ga.descsa, ga.cfiscsa, 
	ga.codtipsa, ga.proein, ga.citein, ga.viaein, ga.nciein,
    ga.respproc, ga.descrup,
    ga.codtipoapp, ga.desctipoapp,
    ga.codtipogar, ga.desctipogar,
	ga.coditergara,
    ga.codcriagg, ga.desccriagg,
	ga.codmodagg,
	ga.valtec,
	ga.costofisso,
	eb.datpub,
    ga.dattermineoff dattermineoff,ga.oratermineoff,
	ga.datterminepar datterminepar,ga.oraterminepar,
	ga.dattermine,
	ga.oratermine,
	ga.dataoraterminepar,
	ga.dataoratermineoff,
	ga.codcig, ga.codcupprg, 
	ga.elencoe,
    ga.isarchi,
	(case when el.elencoe is null then 0 else 1 end) iselenco,
	gse.codstato codstatogara,
	gse.stato descstatogara,
	gse.esito descstatoesito,
	ga.dataesito,
	GREATEST(EXTRACT(year FROM ga.dataesito), coalesce(EXTRACT(year FROM eb.datpub),1000)) annoinizioperscadenza,
	ga.dultagg,
	ga.iaggiu,
	ga.codavscp, ga.urlavscp,
	ga.isaccordoquadro, ga.naggiudicatari,
	ga.gartel, ga.offtel, ga.ribcal, ga.offaum, ga.sicinc, ga.onsogrib, ga.isoffpermuta, ga.isoffcanoneass, ga.valoff, ga.bustedistinte,
	(case when ga.sommaur='1' then 1 else 0 end) sommaur,
	ga.altrisog,
	ga.garpriv,
	ga.prerib
 from v_ws_gare_lotti_tab ga 
	 left outer join v_gare_statoesito gse on (ga.codice = gse.codice) 
	 left outer join v_ws_bandi_pub eb on ga.codgar=eb.codgar
  	 left outer join v_ws_gare_iselenco el on (el.codgar=ga.codgar)
	 inner join v_ws_esiti_ultimo_lotto on ga.ngara = v_ws_esiti_ultimo_lotto.ngaramax and ga.codice = v_ws_esiti_ultimo_lotto.codice;


create or replace view v_ws_oda as
select ga.codice ngara, t.codgar, ga.codice, ga.oggetto, c.imptot,
	t.cenint codsa, u.nomein descsa, ga.codcig, 
	g.tiatto codtipoatto, ta.tab1desc desctipoatto, g.nrepat numrepatto, g.daatto datatto, t.dultagg,
	c.stato codstato, ts.tab1desc descstato, c.idprg, c.iddocdg iddoc, des.idcom, des.idcomdes, des.desdatlet datlet, ut.usernome,
	ga.nomest ragsocaggiud, ga.cfimp cfaggiud, ga.pivimp pivaggiud
from v_gare_aggiudicate ga 
    inner join torn t on ga.codgar = t.codgar
    inner join uffint u on t.cenint = u.codein
    inner join gare g on ga.codice = g.ngara and ga.ditta = g.ditta
    inner join w_puser ut on ut.userent = 'IMPR' and ((ga.isrt = '0' and ut.userkey1 = g.ditta) or (ga.isrt = '1' and ut.userkey1 = (select coddic from ragimp r where r.codime9 = g.ditta and r.impman = '1')))
    inner join garecont c on ga.codice = c.ngara
    left outer join tab1 ts on ts.tab1cod = 'ME008' and c.stato = ts.tab1tip
    left outer join tab1 ta on ta.tab1cod = 'A2042' and g.tiatto = ta.tab1tip
    left outer join w_docdig doc on doc.idprg = c.idprg and doc.iddocdig = c.iddocdg and doc.digent = 'W_INVCOM' and doc.digkey1 = c.idprg 
    left outer join w_invcomdes des on des.idprg = c.idprg and des.idcom=doc.digkey2 and des.descodsog=ut.userkey1
where ((c.stato is null and g.nrepat is not null) or c.stato in (4,5,6))
and c.iddocdg is not null;

-- view per estrarre i punti ordinanti di una gara
create or replace view v_ws_gare_ordinanti as
select g.numper, case when g.propri=1 then 1 else 0 end propri, ga.ngara codice, g.syscon, u.sysute sysute
from g_permessi g inner join usrsys u on g.syscon = u.syscon inner join gare ga on g.codgar=ga.codgar1
where g.meruolo=1;

-- view per estrarre i punti istruttori di una gara
create or replace view v_ws_gare_istruttori as
select g.numper, case when g.propri=1 then 1 else 0 end propri, ga.ngara codice, g.syscon, u.sysute sysute
from g_permessi g inner join usrsys u on g.syscon = u.syscon inner join gare ga on g.codgar=ga.codgar1
where g.meruolo=2;


-- Set di view per l''estrazione della lista affidamenti secondo le specifiche dell''art.18 L.134/2012 (Amministrazione aperta)
-- Considera le gare aggiudicate definitivamente (nel caso di offerta unica ci sono tante righe per la stessa gara quante sono le ditte aggiudicatarie di almeno un lotto)
-- con data atto aggiudicazione valorizzata e con pubblicazione sul portale di un esito di tipo amministrazione trasparente (la data pubblicazione viene denominata anche
-- data esito e data affidamento)

create or replace view v_ws_esiti_ammaperta as 
select p.ngara,p.dinpubg,p.dfipubg 
  from pubg p 
 where tippubg=14 and dinpubg=(select max(dinpubg) from pubg where ngara=p.ngara and tippubg=14) 
   and dinpubg<=now() and (now()<=dfipubg or dfipubg is null);

create or replace view v_ws_gare_lotti_ammaperta as
  select g.ngara, t.codgar, g.codcig codciglotto,
       (case when t.codgar like '$%' then replace(t.codgar,'$','') else t.codgar end) codice,
      coalesce(case when g.genere=3 then t.destor else g.not_gar end,' ') oggetto,
	   u.nomein descsa, 
	   t.uffdet,
	   t.codrup respproc, tec.nomtec descrup,
	   (case when t.codgar like '$%' then g.tipgarg else t.tipgar end) codtipogar,
	   	 t.dtepar datterminepar,
	   	 t.otepar oraterminepar,
	     t.dinvit datletterainv,
	     t.dteoff dattermineoff, 
	     t.oteoff oratermineoff,
 		case when t.dtepar is not null then
        to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
         case when t.otepar is not null and length(t.otepar)=5  
         and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
         and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
         and substr(t.otepar,3,1)=':' 
         then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone 
         else NULL end dataoraterminepar,
       case when t.dteoff is not null then
        to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' || 
         case when t.oteoff is not null and length(t.oteoff)=5  
         and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
         and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
         and substr(t.oteoff,3,1)=':'
         then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone
         else NULL end dataoratermineoff,
	   case when esiti.dinpubg is null then 0 else 1 end isesito,
	   esiti.dinpubg dataesito,
	   t.norma1, t.norma
  from  gare g inner join torn t on (g.codgar1=t.codgar)
          left outer join gare g1 on (g1.codgar1=t.codgar and g1.genere=3)
		  left outer join uffint u on (u.codein=t.cenint)
		  left outer join tecni tec on (tec.codtec=t.codrup)
          left outer join v_ws_esiti_ammaperta esiti on (esiti.ngara=g.ngara or esiti.ngara=g1.ngara)
  where t.cenint is not null
    and (g.genere is null or (g.genere<>10 and g.genere<>11));

create or replace view v_ws_gare_lotti_tab_ammaperta as
  select ga.ngara, ga.codgar, ga.codice, ga.codciglotto,
       ga.oggetto, descsa,
	   ga.uffdet,
	   ga.descrup,	   
	   codtipogar, t2.tab1desc desctipogar,
	   ga.isesito,
	   ga.dataesito,
	   EXTRACT(year FROM ga.dataesito) annoinizioperscadenza,
	   norma1, norma
	from v_ws_gare_lotti_ammaperta ga left outer join tab1 t2 on (t2.tab1cod='A2044' and t2.tab1tip=ga.codtipogar)
	                                  left outer join tab1 t4 on (t4.tab1cod='A1080' and t4.tab1tip=1);
	
-- il controllo sulla durata della pubblicazione non legge il parametro impostato lato portale ma si fissa di default a 5 anni nella condizione di where.
-- per cambiare la durata di pubblicazione occorre modificare la condizione di where nella view
create or replace view v_ws_gare_ammaperta as
 select g.ngara, g.codgar, g.codice, g.codciglotto, g.oggetto,
	ag.ditta codbeneficiario, ag.nomest beneficiario, ag.cfimp, ag.pivimp,rt.cfimp cfimp_rt, rt.pivimp pivimp_rt, 
	 (case when ag.isrt='1' then (
		(case when rt.cfimp is null or rt.cfimp=rt.pivimp then '' else 'C.F. '||rt.cfimp end)
		 || (case when rt.pivimp is null then '' when rt.cfimp is null or rt.cfimp=rt.pivimp then 'P.I. '||rt.pivimp else ', P.I. '||rt.pivimp end))
		else (
		(case when ag.cfimp is null or ag.cfimp=ag.pivimp then '' else 'C.F. '||ag.cfimp end)
		 || (case when ag.pivimp is null then '' when ag.cfimp is null or ag.cfimp=ag.pivimp then 'P.I. '||ag.pivimp else ', P.I. '||ag.pivimp end)) end) cfpi,
    ag.iaggiu importo, g.dataesito data_affidamento, 
	(case when t1.tab1desc is null then '' else t1.tab1desc || ' ' end) || coalesce(g.norma,'') norma, 
	(case when g.descsa is null then '' else g.descsa end) || (case when t2.tab1desc is null then '' when g.descsa is null then ''||t2.tab1desc else ' - '||t2.tab1desc end) ufficio,
	g.descrup responsabile_proc, g.desctipogar modalita
from v_ws_gare_lotti_tab_ammaperta g inner join v_gare_aggiudicate ag on (ag.codice=g.ngara)
                      left outer join tab1 t1 on (t1.tab1cod='A1091' and t1.tab1tip=g.norma1)
                      left outer join tab1 t2 on (t2.tab1cod='A1092' and t2.tab1tip=g.uffdet)
                      left outer join ragimp on (ag.ditta=ragimp.codime9 and ragimp.impman='1')
                      left outer join impr rt on (ragimp.coddic=rt.codimp)
 where g.isesito = 1 and (annoinizioperscadenza + 5 >= EXTRACT(year FROM now()))
   -- estrai solo i soggetti beneficiari (90 o vuoto) escludendo i consulenti collaboratori (91) 
   and (exists (select d.codgar from documgara d  
	            where d.codgar = g.codgar
		        and (d.isarchi is null or d.isarchi = '0') and d.tipologia = 90 and d.gruppo=5)
				or not exists(select d.codgar from documgara d  
							  where d.codgar = g.codgar
							  and (d.isarchi is null or d.isarchi = '0') and d.gruppo=5));

-- View per estrarre i documenti specifici allegati alla gara per la trasparenza
create or replace view v_ws_gare_ammaperta_doc as
select d.codice, 
	d.dittaagg,
	d.iddoc,
	d.descdoc descrizione,
	d.filedoc nomefile,
	w.digogg oggetto,
	d.tipologia, 
	d.datpub
 from v_ws_gare_documenti d left outer join w_docdig w on (d.iddoc=w.iddocdig and w.idprg='PG')
 where d.gruppo=5;

 --Consulenti e collaboratori
create or replace view v_ws_consulenti_lotti as
  select g.ngara, t.codgar,
	   g.codcig codciglotto,
       (case when t.codgar like '$%' then replace(t.codgar,'$','') else t.codgar end) codice,
       coalesce(case when g.genere=3 then t.destor else g.not_gar end,' ') oggetto,
	   (case when t.codgar like '$%' then g.tipgarg else t.tipgar end) codtipogar,
	   g.nrepat, g.daatto,
	   case when esiti.dinpubg is null then 0 else 1 end isesito,
	   t.cenint codsa, u.nomein descsa
  from  gare g inner join torn t on (g.codgar1=t.codgar)
          left outer join gare g1 on (g1.codgar1=t.codgar and g1.genere=3)
          left outer join v_ws_esiti_ammaperta esiti on (esiti.ngara=g.ngara or esiti.ngara=g1.ngara)
		  inner join uffint u on t.cenint = u.codein
  where (g.genere is null or (g.genere not in (10,11,20,4)));
	
create or replace view v_ws_consulenti as
 select g.codgar, g.ngara, g.codice, ag.ditta codicesoggetto,
	 coalesce(ag.nomest,'') || (case when ag.isrt='1' then (
		(case when rt.cfimp is null or rt.cfimp=rt.pivimp then '' else ' (C.F. '||rt.cfimp end)
		 || (case when rt.pivimp is null then '' when rt.cfimp is null or rt.cfimp=rt.pivimp then ' (P.I. '||rt.pivimp else ', P.I. '||rt.pivimp end) || ')')
		else (
		(case when ag.cfimp is null or ag.cfimp=ag.pivimp then '' else ' (C.F. '||ag.cfimp end)
		 || (case when ag.pivimp is null then '' when ag.cfimp is null or ag.cfimp=ag.pivimp then ' (P.I. '||ag.pivimp else ', P.I. '||ag.pivimp end)) || ')' end) soggettopercettore,
	g.nrepat protocollo,
	g.daatto as data,
	gc.ragcons ragioneincarico,
	case when g.codciglotto is not null and g.oggetto is not null then '(' || g.codciglotto || ') ' || g.oggetto
		 when g.codciglotto is null and g.oggetto is not null then g.oggetto
		 else '' end oggprest,
    ag.iaggiu compensoprevisto, 
	gc.varcons partevariabile,
	case when lotti.datainizio is null then gc.dverbc else lotti.datainizio end inizio,
	case when lotti.dataultimazione is null then gc.dcertu else lotti.dataultimazione end fine,
	(select tab1.tab1desc from tab1 where tab1.tab1cod = 'A2044' and tab1.tab1tip = g.codtipogar) procedura,
	(select count(*) from ditg where ditg.ngara5 = g.ngara) numpart,
	g.codsa, g.descsa
from v_ws_consulenti_lotti g inner join v_gare_aggiudicate ag on (ag.codice=g.ngara)
		  left outer join ragimp on (ag.ditta=ragimp.codime9 and ragimp.impman='1')
		  left outer join impr rt on (ragimp.coddic=rt.codimp)
		  left outer join v_dati_lotti lotti on (lotti.lotto = g.ngara)
		  left outer join garecont gc on gc.codimp = ag.ditta and ((gc.ngara=ag.codice and gc.ncont=1) or (gc.ngara=ag.codgar and (gc.ngaral is null or gc.ngaral=ag.codice)))
 where g.isesito = 1
   and exists (select codgar from documgara d
			  where tipologia = 91 and (isarchi is null or isarchi = '0')
			  and d.codgar = g.codgar and d.datarilascio is not null);
			  
-- View per la lista adempimenti per anno e per stazione appaltante
create or replace view v_ws_adempimenti_anticor as 
 select a.codein, sa.nomein, sa.cfein, a.annorif, a.urlsito, 
        case when a.pubblicato = '1' then 1 else 0 end pubblicato,
		datapubbl datapubblicazione, dataagg dataaggiornamento, datappr dataapprovazione
   from anticor a left outer join uffint sa on a.codein = sa.codein
  where a.completato = 1;
  
--View per lista appalti aggiudicati secondo le specifiche della L.190/2012 (legge 'anticorruzione')
-- Considera le gare pubblicate ed esportate mediante apposita funzione di backoffice e quindi "congelate" per i dati anticorruzione
create or replace view v_ws_gare_anticor as
 select a.annorif, l.id idanticorlotti, 
        case when substr(l.cig,1,1)='$' or substr(l.cig,1,1)='#' or substr(upper(l.cig),1,5)='NOCIG' then cast('0000000000' as character varying(10)) else l.cig end cig, 
		l.codfiscprop, l.denomprop, l.oggetto, l.sceltacontr codsceltacontr, t.tab1desc descsceltacontr, l.impaggiudic, l.datainizio, l.dataultimazione, l.impsommeliq
   from anticor a inner join anticorlotti l on a.id = l.idanticor inner join tab1 t on l.sceltacontr =  t.tab1tip and t.tab1cod = 'A2044'
  where a.completato=1
    and l.pubblica=1;

--View per lista appalti aggiudicati secondo le specifiche della L.190/2012 (legge 'anticorruzione')
-- Elenco delle ditte invitate alle gare
create or replace view v_ws_gare_anticor_ditte as
 select p.idanticorlotti, d.idanticorpartecip, p.aggiudicataria, d.ragsoc, d.codfisc, d.idfiscest, d.ruolo codruolo, t.tab1desc descruolo
   from anticorpartecip p inner join anticorditte d on p.id = d.idanticorpartecip left outer join tab1 t on d.ruolo =  t.tab1tip and t.tab1cod = 'A1094';

-- View per estrarre la lista degli enti committenti di una gara 
create or replace view v_ws_aderente_lotto as
 select gl.codgar, gl.ngara, gl.codice, gl.codcig, gs.cenint, u.cfein, u.nomein 
   from v_ws_gare_lotti gl inner join garaltsog gs on gs.ngara = gl.ngara inner join uffint u on u.codein = gs.cenint;

create or replace view v_ws_gare_pubb_esito as	 
select torn.codgar,min(DINPUBG) mindatpub from pubg,gare,torn where pubg.ngara=gare.ngara and gare.codgar1=torn.codgar and tippubg=12 group by torn.codgar;
   
-- View per estrarre la lista dei contratti per standardizzare l'operazione AMA di prospetto trasparenza mensile
create or replace function sp_v_ws_trasp_contratti() returns void as
$$
declare 
  cont_exists boolean;
begin
  select into cont_exists (select EXISTS (
			SELECT 1 
			FROM   pg_catalog.pg_class c
			JOIN   pg_catalog.pg_namespace n ON n.oid = c.relnamespace
			AND    upper(c.relname) = 'CONT'
			AND    c.relkind = 'r'    --tabelle
			)) ;
  if cont_exists then
    -- ----------------------------------------------------------------------
    -- crea v_ws_trasp_contratti basata su CONT
    -- ----------------------------------------------------------------------
create or replace view v_ws_trasp_contratti_ult_contr as
select c.codlav, c.nappal, c.nimpco from cont c
	   join (select codlav, nappal, max(nproat) as ult_nproat from cont where daatto is not null group by codlav, nappal) u
			 on c.codlav=u.codlav and c.nappal=u.nappal and c.nproat=u.ult_nproat;

create or replace view v_ws_trasp_contratti as
select g.ngara codice,
	case when pubblicazioni_bando.mindatpub is null then t.dpubav else pubblicazioni_bando.mindatpub end datapubbgara,
	t.dinvit datainvito,
	g.dattoa dataaggiudicazione,
	pubblicazioni_esito.mindatpub datapubbesito,
	g.codcig cig,
	uffint.codein codiceprop,
	uffint.cfein codfiscprop,
	uffint.nomein denomprop,
	g.not_gar oggetto,
	g.tipgarg,
	coalesce(tab1.tab1desc, 'NON DEFINITO') descsceltacontr,
	case when t.accqua=1 and g1.aqoper=2 then 0 else 1 end singolaaggiudicataria,
	g.ditta codaggiudicataria,
	impr.nomest descaggiudicataria, 
	impr.cfimp codfiscaggiudicataria, 
	impr.pivimp partivaaggiudicataria,
	case when (t.accqua is null or t.accqua <>'1') then g.iaggiu else gc.impqua end impaggiudic,
	case when lotticustom.lotto is null then gc.dverbc else lotticustom.datainizio end datainizio, 
	case when lotticustom.lotto is null then gc.dcertu else lotticustom.dataultimazione end datafine, 
	case when lotticustom.lotto is null then gc.impliq else lotticustom.impsommeliq_custom end impsommeliq,
	case when cu.nimpco is null then g.iaggiu else cu.nimpco end impultcontr
from gare g inner join torn t on (g.codgar1=t.codgar)
	inner join gare1 g1 on (g.ngara=g1.ngara)
	inner join v_ws_gare_pubb_esito pubblicazioni_esito on (pubblicazioni_esito.codgar=t.codgar)
    left outer join v_dati_lotti_pubblicazioni pubblicazioni_bando on (pubblicazioni_bando.codgar9=t.codgar)
	left outer join uffint on (t.cenint=uffint.codein)
	left outer join tab2 on (tab2.tab2cod = 'A1z05' and (tab2.tab2tip = g.tipgarg or (',' || tab2.tab2d2 || ',') like ('%,' || cast(g.tipgarg as text) || ',%')))
	left outer join tab1 on (tab1.tab1cod = 'A2044' and tab1tip = tab2.tab2tip)
	left outer join impr on (g.ditta=impr.codimp)
	left outer join garecont gc on ((gc.codimp=g.ditta or gc.codimp is null) and ((gc.ngara=g.ngara and gc.ncont=1)
			or (gc.ngara=g.codgar1 and (gc.ngaral is null or gc.ngaral=g.ngara))))
	left outer join v_dati_lotti_completa_custom lotticustom on (lotticustom.lotto = g.ngara)
	left outer join v_ws_trasp_contratti_ult_contr cu on (cu.codlav=g.clavor and cu.nappal=g.numera and g.ditta is not null)
where (g.genere is null or g.genere<>3) and g.codcig is not null;

-- versione estesa per servizi: tolto filtro su pubblicazioni esito e aggiunto data-ora termine presentazione domanda e offerta
create or replace view v_ws_trasp_contratti_estesa as
select g.ngara codice,
	case when pubblicazioni_bando.mindatpub is null then t.dpubav else pubblicazioni_bando.mindatpub end datapubbgara,
	t.dinvit datainvito,
	g.dattoa dataaggiudicazione,
	pubblicazioni_esito.mindatpub datapubbesito,
	g.codcig cig,
	uffint.codein codiceprop,
	uffint.cfein codfiscprop,
	uffint.nomein denomprop,
	g.not_gar oggetto,
	g.tipgarg,
	coalesce(tab1.tab1desc, 'NON DEFINITO') descsceltacontr,
	case when t.accqua=1 and g1.aqoper=2 then 0 else 1 end singolaaggiudicataria,
	g.ditta codaggiudicataria,
	impr.nomest descaggiudicataria, 
	impr.cfimp codfiscaggiudicataria, 
	impr.pivimp partivaaggiudicataria,
	case when (t.accqua is null or t.accqua <>'1') then g.iaggiu else gc.impqua end impaggiudic,
	case when lotticustom.lotto is null then gc.dverbc else lotticustom.datainizio end datainizio, 
	case when lotticustom.lotto is null then gc.dcertu else lotticustom.dataultimazione end datafine, 
	case when lotticustom.lotto is null then gc.impliq else lotticustom.impsommeliq_custom end impsommeliq,
	case when cu.nimpco is null then g.iaggiu else cu.nimpco end impultcontr,
	t.dtepar, t.otepar,
	t.dteoff, t.oteoff,
   case when t.dtepar is not null then
	to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
	 case when t.otepar is not null and length(t.otepar)=5  
	 and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
	 and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
	 and substr(t.otepar,3,1)=':' 
	 then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone 
	 else NULL end dataoraterminepar,
   case when t.dteoff is not null then
	to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' || 
	 case when t.oteoff is not null and length(t.oteoff)=5  
	 and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
	 and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
	 and substr(t.oteoff,3,1)=':'
	 then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone
	 else NULL end dataoratermineoff
from gare g inner join torn t on (g.codgar1=t.codgar)
	inner join gare1 g1 on (g.ngara=g1.ngara)
	left outer join v_ws_gare_pubb_esito pubblicazioni_esito on (pubblicazioni_esito.codgar=t.codgar)
    left outer join v_dati_lotti_pubblicazioni pubblicazioni_bando on (pubblicazioni_bando.codgar9=t.codgar)
	left outer join uffint on (t.cenint=uffint.codein)
	left outer join tab2 on (tab2.tab2cod = 'A1z05' and (tab2.tab2tip = g.tipgarg or (',' || tab2.tab2d2 || ',') like ('%,' || cast(g.tipgarg as text) || ',%')))
	left outer join tab1 on (tab1.tab1cod = 'A2044' and tab1tip = tab2.tab2tip)
	left outer join impr on (g.ditta=impr.codimp)
	left outer join garecont gc on ((gc.codimp=g.ditta or gc.codimp is null) and ((gc.ngara=g.ngara and gc.ncont=1)
			or (gc.ngara=g.codgar1 and (gc.ngaral is null or gc.ngaral=g.ngara))))
	left outer join v_dati_lotti_completa_custom lotticustom on (lotticustom.lotto = g.ngara)
	left outer join v_ws_trasp_contratti_ult_contr cu on (cu.codlav=g.clavor and cu.nappal=g.numera and g.ditta is not null)
where (g.genere is null or g.genere<>3) and g.codcig is not null;

  else 
    -- ----------------------------------------------------------------------
    -- crea v_ws_trasp_contratti con importo contratto NULL
    -- ----------------------------------------------------------------------
create or replace view v_ws_trasp_contratti as
select g.ngara codice,
		case when pubblicazioni_bando.mindatpub is null then t.dpubav else pubblicazioni_bando.mindatpub end datapubbgara,
		t.dinvit datainvito,
		g.dattoa dataaggiudicazione,
		pubblicazioni_esito.mindatpub datapubbesito,
		g.codcig cig,
		uffint.codein codiceprop,
		uffint.cfein codfiscprop,
		uffint.nomein denomprop,
		g.not_gar oggetto,
		g.tipgarg,
		coalesce(tab1.tab1desc, 'NON DEFINITO') descsceltacontr,
		case when t.accqua=1 and g1.aqoper=2 then 0 else 1 end singolaaggiudicataria,
		g.ditta codaggiudicataria,
		impr.nomest descaggiudicataria, 
		impr.cfimp codfiscaggiudicataria, 
		impr.pivimp partivaaggiudicataria,
		case when (t.accqua is null or t.accqua <>'1') then g.iaggiu else gc.impqua end impaggiudic,
		case when lotticustom.lotto is null then gc.dverbc else lotticustom.datainizio end datainizio, 
		case when lotticustom.lotto is null then gc.dcertu else lotticustom.dataultimazione end datafine, 
		case when lotticustom.lotto is null then gc.impliq else lotticustom.impsommeliq_custom end impsommeliq,
		cast(null as numeric(24,5)) impultcontr
from gare g inner join torn t on (g.codgar1=t.codgar)
	inner join gare1 g1 on (g.ngara=g1.ngara)
	inner join v_ws_gare_pubb_esito pubblicazioni_esito on (pubblicazioni_esito.codgar=t.codgar)
    left outer join v_dati_lotti_pubblicazioni pubblicazioni_bando on (pubblicazioni_bando.codgar9=t.codgar)
	left outer join uffint on (t.cenint=uffint.codein)
	left outer join tab2 on (tab2.tab2cod = 'A1z05' and (tab2.tab2tip = g.tipgarg or (',' || tab2.tab2d2 || ',') like ('%,' || cast(g.tipgarg as text) || ',%')))
	left outer join tab1 on (tab1.tab1cod = 'A2044' and tab1tip = tab2.tab2tip)
	left outer join impr on (g.ditta=impr.codimp)
	left outer join garecont gc on ((gc.codimp=g.ditta or gc.codimp is null) and ((gc.ngara=g.ngara and gc.ncont=1)
			or (gc.ngara=g.codgar1 and (gc.ngaral is null or gc.ngaral=g.ngara))))
	left outer join v_dati_lotti_completa_custom lotticustom on (lotticustom.lotto = g.ngara)
where (g.genere is null or g.genere<>3) and g.codcig is not null;

-- versione estesa per servizi: tolto filtro su pubblicazioni esito e aggiunto data-ora termine presentazione domanda e offerta
create or replace view v_ws_trasp_contratti_estesa as
select g.ngara codice,
		case when pubblicazioni_bando.mindatpub is null then t.dpubav else pubblicazioni_bando.mindatpub end datapubbgara,
		t.dinvit datainvito,
		g.dattoa dataaggiudicazione,
		pubblicazioni_esito.mindatpub datapubbesito,
		g.codcig cig,
		uffint.codein codiceprop,
		uffint.cfein codfiscprop,
		uffint.nomein denomprop,
		g.not_gar oggetto,
		g.tipgarg,
		coalesce(tab1.tab1desc, 'NON DEFINITO') descsceltacontr,
		case when t.accqua=1 and g1.aqoper=2 then 0 else 1 end singolaaggiudicataria,
		g.ditta codaggiudicataria,
		impr.nomest descaggiudicataria, 
		impr.cfimp codfiscaggiudicataria, 
		impr.pivimp partivaaggiudicataria,
		case when (t.accqua is null or t.accqua <>'1') then g.iaggiu else gc.impqua end impaggiudic,
		case when lotticustom.lotto is null then gc.dverbc else lotticustom.datainizio end datainizio, 
		case when lotticustom.lotto is null then gc.dcertu else lotticustom.dataultimazione end datafine, 
		case when lotticustom.lotto is null then gc.impliq else lotticustom.impsommeliq_custom end impsommeliq,
		cast(null as numeric(24,5)) impultcontr,
		t.dtepar, t.otepar,
		t.dteoff, t.oteoff,
       case when t.dtepar is not null then
        to_timestamp(to_char(t.dtepar,'YYYY/MM/DD') || ' ' || 
         case when t.otepar is not null and length(t.otepar)=5  
         and (to_number(substr(t.otepar,1,2),'9999D0000') between 0 and 23)
         and (to_number(substr(t.otepar,4,2),'9999D0000') between 0 and 60)
         and substr(t.otepar,3,1)=':' 
         then t.otepar || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone 
         else NULL end dataoraterminepar,
       case when t.dteoff is not null then
        to_timestamp(to_char(t.dteoff,'YYYY/MM/DD') || ' ' || 
         case when t.oteoff is not null and length(t.oteoff)=5  
         and (to_number(substr(t.oteoff,1,2),'9999D0000') between 0 and 23)
         and (to_number(substr(t.oteoff,4,2),'9999D0000') between 0 and 60)
         and substr(t.oteoff,3,1)=':'
         then t.oteoff || ':00' else '23:59:59' end, 'YYYY/MM/DD HH24:MI:SS')::timestamp without time zone
         else NULL end dataoratermineoff
from gare g inner join torn t on (g.codgar1=t.codgar)
	inner join gare1 g1 on (g.ngara=g1.ngara)
	left outer join v_ws_gare_pubb_esito pubblicazioni_esito on (pubblicazioni_esito.codgar=t.codgar)
    left outer join v_dati_lotti_pubblicazioni pubblicazioni_bando on (pubblicazioni_bando.codgar9=t.codgar)
	left outer join uffint on (t.cenint=uffint.codein)
	left outer join tab2 on (tab2.tab2cod = 'A1z05' and (tab2.tab2tip = g.tipgarg or (',' || tab2.tab2d2 || ',') like ('%,' || cast(g.tipgarg as text) || ',%')))
	left outer join tab1 on (tab1.tab1cod = 'A2044' and tab1tip = tab2.tab2tip)
	left outer join impr on (g.ditta=impr.codimp)
	left outer join garecont gc on ((gc.codimp=g.ditta or gc.codimp is null) and ((gc.ngara=g.ngara and gc.ncont=1)
			or (gc.ngara=g.codgar1 and (gc.ngaral is null or gc.ngaral=g.ngara))))
	left outer join v_dati_lotti_completa_custom lotticustom on (lotticustom.lotto = g.ngara)
where (g.genere is null or g.genere<>3) and g.codcig is not null;

  end if;
end;
$$ language plpgsql;
select sp_v_ws_trasp_contratti();
drop function sp_v_ws_trasp_contratti();


-- View per estrarre la lista degli operatori invitati per standardizzare l'operazione AMA di prospetto trasparenza mensile  
 create or replace view v_ws_trasp_contratti_partecip as
	select
		ngara5 codice,
		dittao ditta,
		nomest ragsoc,
		cfimp codfisc,
		pivimp partiva,
		case when tipimp in (3,10) then 1 else 0 end rti
	from ditg left outer join impr on (dittao = codimp)
	where (partgar != 2 or partgar is null) and (acquisizione is null or acquisizione <> 5);

-- View per estrarre la lista delle imprese aggiudicatarie in caso di accordo quadro (n aggiudicatarie)
create or replace view v_ws_gare_n_aggiudicatari as
	select 
		ngara codice,
		numord,
		dittao ditta, 
		nomest ragsoc,
		cfimp codfisc, 
		pivimp partiva,
		case when tipimp in (3,10) then 1 else 0 end rti
	from ditgaq r left outer join impr i on (r.dittao = i.codimp);

-- View per estrarre la lista dei componenti di una RTI nel caso di operatori invitati per standardizzare l'operazione AMA di prospetto trasparenza mensile  
create or replace view v_ws_trasp_contratti_dett_rti as
	select r.codime9 codimprti, 
		r.nomdic ragsoc, 
		i.cfimp codfisc, 
		i.pivimp partiva,
		case when r.impman = 1 then 1 else 0 end mandataria
		from ragimp r left outer join impr i on (r.coddic = i.codimp);


-- view per predisporre l'estrazione dei dati nelle diverse fasi di espletamento gara
create or replace view v_ws_fasi_gara_partecipanti as
select df.num_fase, df.desc_fase,
	df.codgar, df.ngara codice,
	(case when df.codgar not like '$%' and df.codgar <> df.ngara then df.codgar else g.ngara end) ngara, 	
	(case when df.codgar not like '$%' and df.codgar <> df.ngara then df.ngara else null end) lotto, 
	g.codiga codinternolotto, 
	(case when df.codgar not like '$%' and df.codgar <> df.ngara then g.not_gar else null end) oggettolotto, 
	df.dittao codopeconomico, df.nomimo denopeconomico, i.cfimp cfopeconomico, (case when d.codati is null then 0 else 1 end) rti, u.usernome, 
	df.numordpl numplico, 
	(case when df.partecipa = 1 then 1 else 0 end) partecipalotto, ammissione, tamm.tab1desc descammissione,
	d.ncomope progofferta
from v_gare_dittefasi df
	inner join gare g on df.codgar = g.codgar1 and df.ngara = g.ngara
	inner join v_ws_ditg d on df.codgar = d.codgar5 and df.ngara = d.ngara5 and df.dittao = d.dittao
	inner join impr i on d.dittao = i.codimp
	inner join w_puser u on u.userent = 'IMPR' and d.codman = u.userkey1 
	left outer join tab1 tamm on tamm.tab1cod = 'A1054' and df.ammissione = tamm.tab1tip
where num_fase >= 1;

-- view per estrarre i dati in fase di apertura documentazione amministrativa
create or replace view v_ws_apertura_doc_amm as
select p.codgar, p.codice, p.ngara, p.lotto, p.codinternolotto, p.oggettolotto, 
	p.codopeconomico, p.denopeconomico, p.cfopeconomico, p.rti,  
	p.numplico, (case when c.idcom is null then 0 else (case when c.comstato in ('5','13') then 1 else 2 end) end) statobusta, 
	p.partecipalotto, p.ammissione, p.descammissione
from v_ws_fasi_gara_partecipanti p 
	left outer join w_invcom c on c.idprg='PA' and p.usernome=c.comkey1 and p.codice=c.comkey2 and c.comstato<>'1' 
								  and c.comkey3=p.progofferta and comtipo='FS11A'
where p.num_fase = 2;

-- view per estrarre i dati in fase di apertura busta tecnica e sua valutazione
create or replace view v_ws_apertura_val_tecnica as
select p.codgar, p.codice, p.lotto, p.codinternolotto, p.oggettolotto, 
	p.codopeconomico, p.denopeconomico, p.cfopeconomico, p.rti, 
	p.numplico, (case when c.idcom is null then 0 else (case when c.comstato in ('5','13') then 1 else 2 end) end) statobusta, 
	(case when g.genere=3 then t.modlic else g.modlicg end) codmodagg,
	dg.puntec, dg.puntecrip, 
	p.partecipalotto, p.ammissione, p.descammissione
from v_ws_fasi_gara_partecipanti p 
	inner join gare g on p.codgar = g.codgar1 and p.codice = g.ngara
	inner join torn t on g.codgar1=t.codgar
	inner join ditg dg on g.codgar1 = dg.codgar5 and g.ngara = dg.ngara5 and p.codopeconomico = dg.dittao 
	left outer join w_invcom c on c.idprg='PA' and p.usernome=c.comkey1 and (p.codice=c.comkey2 or p.codgar=c.comkey2) and c.comstato<>'1' 
								  and c.comkey3=p.progofferta and comtipo='FS11B'
where p.num_fase = 5;

-- view per estrarre i dati in fase di apertura busta economica
create or replace view v_ws_apertura_off_economica as
select p.codgar, p.codice, p.lotto, p.codinternolotto, p.oggettolotto, 
	p.codopeconomico, p.denopeconomico, p.cfopeconomico, p.rti, 
	p.numplico, (case when c.idcom is null then 0 else (case when c.comstato in ('5','13') then 1 else 2 end) end) statobusta, 
	(case when g.genere=3 then t.modlic else g.modlicg end) codmodagg,
	g.ribcal, dg.ribauo, dg.impoff, dg.puneco, dg.punecorip,
	p.partecipalotto, p.ammissione, p.descammissione
from v_ws_fasi_gara_partecipanti p 
	inner join gare g on p.codgar = g.codgar1 and p.codice = g.ngara
	inner join torn t on g.codgar1=t.codgar
	inner join ditg dg on g.codgar1 = dg.codgar5 and g.ngara = dg.ngara5 and p.codopeconomico = dg.dittao 
	left outer join w_invcom c on c.idprg='PA' and p.usernome=c.comkey1 and (p.codice=c.comkey2 or p.codgar=c.comkey2) and c.comstato<>'1' 
								  and c.comkey3=p.progofferta and comtipo='FS11C'
where p.num_fase = 6;

-- view per estrarre i dati in fase della graduatoria di aggiudicazione
create or replace view v_ws_gara_graduatoria as
select p.codgar, p.codice, p.lotto, p.codinternolotto, p.oggettolotto, 
	p.codopeconomico, p.denopeconomico, p.cfopeconomico, p.rti, 
	p.numplico,
	(case when g.genere=3 then t.modlic else g.modlicg end) codmodagg,
	g.ribcal, dg.ribauo, dg.impoff, 
	(case when g.dittap is not null then 1 else 0 end) garaaggiudicata,
	dg.staggi graduatoria,
	tagg.tab1desc descgraduatoria,
	(case when t.inversa = '1' then 1 else 0 end) inversa,
	(case when dg.amminversa is null then null else (case when dg.amminversa = '1' then 1 else 0 end) end) amminversa
from v_ws_fasi_gara_partecipanti p 
	inner join gare g on p.codgar = g.codgar1 and p.codice = g.ngara
	inner join torn t on g.codgar1=t.codgar
	inner join ditg dg on g.codgar1 = dg.codgar5 and g.ngara = dg.ngara5 and p.codopeconomico = dg.dittao and p.progofferta=dg.ncomope
	inner join tab1 tagg on tagg.tab1cod = 'A1016' and dg.staggi = tagg.tab1tip
where p.num_fase = 6 and dg.ammgar=1;

-- view per estrarre i documenti allegati per ogni busta inviata
create or replace view v_ws_apertura_buste_allegati as
select gdd.codgar, gdd.ngara codice, gdd.codimp codopeconomico, gdd.busta, gdd.bustaord, gdd.descrizione, gdd.dignomdoc nomefile,
	gdd.datalettura
from v_gare_docditta gdd inner join v_ws_ditg d on gdd.codgar = d.codgar5 and gdd.ngara = d.ngara5 and gdd.codimp = d.dittao
where busta is not null and gdd.dignomdoc is not null;

-- View per tabella informativa indicizzazione: lista di bandi (V_WS_BANDI), avvisi (V_WS_AVVISI) e esiti (V_WS_ESITI).
-- N.B.: Nel caso di bandi e esiti, se si tratta di gara divisa in lotti, viene riportata sia la gara che i lotti (V_WS_GARE_LOTTI_TAB con TIPOLOGIA=1)
create or replace view v_ws_gare_tabinf as
  select b.codice codice, 
    'Bando' tipo,
	b.oggetto titolo,
	b.codtipoapp tipoappalto,
	b.desctipoapp tipocontratto,
	case when tipologia=2 then null::integer else 0 end islotto,
	null::text codicelotto,
	b.cfiscsa codicefiscaleente,
	b.descsa nomeente,
	b.codtipsa tipoente,
	t1.tab1desc desctipoente,
    case when usuap.codein is not null then usuap.proein else b.proein end provincia,
    case when usuap.codein is not null then usuap.citein else b.citein end comune, 
    case when usuap.codein is not null then (usuap.viaein || case when usuap.nciein is not null then ',' else '' end || usuap.nciein) 
	 else (b.viaein || case when b.nciein is not null then ',' else '' end || b.nciein) end indirizzo,
	case when (b.importo is not null and b.importo > 0) then 0 else 1 end senzaimporto,
	b.importo importobaseasta,
	case when b.tipologia=2 and b.dataesito is not null then b.iaggiu else null::numeric(24,5) end importoaggiudicazione,
	b.desccriagg criterioaggiudicazione,
	b.datpub dtpubblicazione,
	b.dattermine dtscadenzabando,
	b.dataesito+ interval  '1 day' *180 dtscadenzaesito,
	null::timestamp dtscadenzaavviso,
	c.codice requisiti,
	c.descrizione descrequisiti,
	garcpv.codcpv codicecpv,
	tabcpv.cpvdesc desccpv,
	b.codscp codicescp,
	b.urlscp urlscp,
	b.codcig codicecig
	from v_ws_bandi b
	 left outer join v_ws_gare_categorie c on (b.codice=c.ngara and c.prevalente=1 and c.tipoappalto=1)
	 left outer join garcpv on (b.codice=garcpv.ngara and garcpv.tipcpv=1)
	 left outer join tabcpv on (garcpv.codcpv=tabcpv.cpvcod4)
  	 left outer join tab1 t1 on (t1.tab1cod='G_044' and t1.tab1tip=b.codtipsa)
	 left outer join tab1 tabsuap on (tabsuap.tab1cod='A1089' and tabsuap.tab1tip=1)
	 left outer join uffint usuap on (usuap.codein=tabsuap.tab1desc)
	where (codstatogara <> 1 OR coditergara not in (3,5,6))
 union 
  select bl.codice codice, 
    'Bando' tipo,
	bl.oggetto titolo,
	bl.codtipoapp tipoappalto,
	bl.desctipoapp tipocontratto,
	1 islotto,
	bl.ngara codicelotto,
	bl.cfiscsa codicefiscaleente,
	bl.descsa nomeente,
	bl.codtipsa tipoente,
	t1.tab1desc desctipoente,
    case when usuap.codein is not null then usuap.proein else bl.proein end provincia,
    case when usuap.codein is not null then usuap.citein else bl.citein end comune, 
    case when usuap.codein is not null then (usuap.viaein || case when usuap.nciein is not null then ',' else '' end || usuap.nciein) 
	 else (bl.viaein || case when bl.nciein is not null then ',' else '' end || bl.nciein) end indirizzo,
	case when (bl.importo is not null and bl.importo > 0) then 0 else 1 end senzaimporto,
	bl.importo importobaseasta,
	case when bl.dataesito is null then null else bl.iaggiu::numeric(24,5) end importoaggiudicazione,
	bl.desccriagg criterioaggiudicazione,
	bl.datpub dtpubblicazione,
	bl.dattermine dtscadenzabando,
	bl.dataesito+ interval  '1 day' *180 dtscadenzaesito,
	null::timestamp dtscadenzaavviso,
	c.codice requisiti,
	c.descrizione descrequisiti,
	garcpv.codcpv codicecpv,
	tabcpv.cpvdesc desccpv,
	bl.codscp codicescp,
	bl.urlscp urlscp,
	bl.codciglotto codicecig
	from v_ws_gare_lotti_pubbliche bl
	 left outer join v_ws_gare_categorie c on ((bl.ngara=c.ngara and c.prevalente=1 and c.tipoappalto=1 and bl.tipologia=1) or 
	           (bl.codgar=c.ngara and c.prevalente=1 and c.tipoappalto=1 and bl.tipologia=4))
	 left outer join garcpv on (bl.ngara=garcpv.ngara and garcpv.tipcpv=1)
     left outer join tabcpv on (garcpv.codcpv=tabcpv.cpvcod4)
  	 left outer join tab1 t1 on (t1.tab1cod='G_044' and t1.tab1tip=bl.codtipsa)
	 left outer join tab1 tabsuap on (tabsuap.tab1cod='A1089' and tabsuap.tab1tip=1)
	 left outer join uffint usuap on (usuap.codein=tabsuap.tab1desc)
	where (bl.tipologia=1 or bl.tipologia=4)
 union
  select av.ngara codice,
    'Avviso' tipo,
	av.oggetto titolo,
	case when av.codtipoapp>=100 then 1 when av.codtipoapp>=10 then 2 when av.codtipoapp=1 then 3 else 4 end tipoappalto,
	case when av.codtipoapp>=100 then 'Lavori' when av.codtipoapp>=10 then 'Forniture' when av.codtipoapp=1 then 'Servizi' else 'Altro' end tipocontratto,
	null::integer islotto,
	null::text codicelotto,
	av.cfiscsa codicefiscaleente,
	av.descsa nomeente,
	av.codtipsa tipoente,
	av.desctipsa desctipoente,
	av.provsede provincia,
	av.comsede comune,
	av.indsede indirizzo,
	1 senzaimporto,
	null::numeric(24,5) importobaseasta,
	null::numeric(24,5) importoaggiudicazione,
	null::text criterioaggiudicazione,
	av.datpub dtpubblicazione,
	av.datascadenza dtscadenzabando,
	null::timestamp dtscadenzaesito,
	av.datascadenza+ interval  '1 day' *180 dtscadenzaavviso,
	null::text requisiti,
	null::text descrequisiti,
	null::text codicecpv,
	null::text desccpv,
	av.codscp codicescp,
	av.urlscp urlscp,
	null::text codicecig
  from v_ws_avvisi av
union
    select es.codice codice, 
    'Esito' tipo,
	es.oggetto titolo,
	es.codtipoapp tipoappalto,
	es.desctipoapp tipocontratto,
	case when tipologia=2 then null::integer else 0 end islotto,
	null::text codicelotto,
	es.cfiscsa codicefiscaleente,
	es.descsa nomeente,
	es.codtipsa tipoente,
	t1.tab1desc desctipoente,
    case when usuap.codein is not null then usuap.proein else es.proein end provincia,
    case when usuap.codein is not null then usuap.citein else es.citein end comune, 
    case when usuap.codein is not null then (usuap.viaein || case when usuap.nciein is not null then ',' else '' end || usuap.nciein) 
	 else (es.viaein || case when es.nciein is not null then ',' else '' end || es.nciein) end indirizzo,
	case when (es.importo is not null and es.importo > 0) then 0 else 1 end senzaimporto,
	es.importo importobaseasta,
	case when es.tipologia=1 then null::numeric(24,5) else es.iaggiu end importoaggiudicazione,
	es.desccriagg criterioaggiudicazione,
	es.datpub dtpubblicazione,
	case when es.datpub is null then null else es.dattermine end dtscadenzabando,
	es.dataesito+ interval  '1 day' *180 dtscadenzaesito,
	null::timestamp dtscadenzaavviso,
	c.codice requisiti,
	c.descrizione descrequisiti,
	garcpv.codcpv codicecpv,
	tabcpv.cpvdesc desccpv,
	es.codavscp codicescp,
	es.urlavscp urlscp,
	es.codcig codicecig
	from v_ws_esiti es
	 left outer join v_ws_gare_categorie c on (es.codice=c.ngara and c.prevalente=1 and c.tipoappalto=1)
	 left outer join garcpv on (es.codice=garcpv.ngara and garcpv.tipcpv=1)
     left outer join tabcpv on (garcpv.codcpv=tabcpv.cpvcod4)
  	 left outer join tab1 t1 on (t1.tab1cod='G_044' and t1.tab1tip=es.codtipsa)
	 left outer join tab1 tabsuap on (tabsuap.tab1cod='A1089' and tabsuap.tab1tip=1)
	 left outer join uffint usuap on (usuap.codein=tabsuap.tab1desc)
 union 
  select esl.codice codice, 
    'Esito' tipo,
	esl.oggetto titolo,
	esl.codtipoapp tipoappalto,
	esl.desctipoapp tipocontratto,
	1 islotto,
	esl.ngara codicelotto,
	esl.cfiscsa codicefiscaleente,
	esl.descsa nomeente,
	esl.codtipsa tipoente,
	t1.tab1desc desctipoente,
    case when usuap.codein is not null then usuap.proein else esl.proein end provincia,
    case when usuap.codein is not null then usuap.citein else esl.citein end comune, 
    case when usuap.codein is not null then (usuap.viaein || case when usuap.nciein is not null then ',' else '' end || usuap.nciein) 
	 else (esl.viaein || case when esl.nciein is not null then ',' else '' end || esl.nciein) end indirizzo,
	case when (esl.importo is not null and esl.importo > 0) then 0 else 1 end senzaimporto,
	esl.importo importobaseasta,
	esl.iaggiu importoaggiudicazione,
	esl.desccriagg criterioaggiudicazione,
	bl.datpub dtpubblicazione,
	case when bl.datpub is null then null else esl.dattermine end dtscadenzabando,
	esl.dataesito+ interval  '1 day' *180 dtscadenzaesito,
	null::timestamp dtscadenzaavviso,
	c.codice requisiti,
	c.descrizione descrequisiti,
	garcpv.codcpv codicecpv,
	tabcpv.cpvdesc desccpv,
	esl.codavscp codicescp,
	esl.urlavscp urlscp,
	esl.codciglotto codicecig
	from v_ws_gare_lotti_tab esl
	 left outer join v_ws_bandi_pub bl on esl.codgar=bl.codgar
	 left outer join v_ws_gare_categorie c on ((esl.ngara=c.ngara and c.prevalente=1 and c.tipoappalto=1 and esl.tipologia=1) or 
	           (esl.codgar=c.ngara and c.prevalente=1 and c.tipoappalto=1 and esl.tipologia=4))
	 left outer join garcpv on (esl.ngara=garcpv.ngara and garcpv.tipcpv=1)
     left outer join tabcpv on (garcpv.codcpv=tabcpv.cpvcod4)
  	 left outer join tab1 t1 on (t1.tab1cod='G_044' and t1.tab1tip=esl.codtipsa)
	 left outer join tab1 tabsuap on (tabsuap.tab1cod='A1089' and tabsuap.tab1tip=1)
	 left outer join uffint usuap on (usuap.codein=tabsuap.tab1desc)
	where (esl.tipologia=1 or esl.tipologia=4)
	  and esl.dataesito is not null;

	  
create or replace view v_ws_gare_tabinf_doc as
 select d.codice, 
    d.ngara codicelotto,
    t.tipo,
	d.iddoc,
	d.urldoc,
	d.descdoc descrizione,
	d.filedoc nomefile,
	w.digogg oggetto
 from v_ws_gare_documenti d
  inner join v_ws_gare_tabinf t on (d.codice=t.codice and (t.islotto is null or t.islotto=0))
  left outer join w_docdig w on (d.iddoc=w.iddocdig and w.idprg='PG')
 where ((d.gruppo=1 and (t.tipo='Bando' or t.tipo='Avviso')) or 
      (d.gruppo=4 and t.tipo='Esito'));

create or replace view v_ws_sommaurgenza as
select
	g.codgar,
	l.ngara,
	l.not_gar,
	pe.dt_primo_esito,
	pe.dt_prima_pubb,
	case when l.dattog is not null then cast(l.dattog as date)
		 when l.dattoa is not null then cast(l.dattoa as date)
		 when g.dinvit is not null then cast(g.dinvit as date)
		 when l.dattog is not null then cast(l.dattog as date)
		 else case when pe.dt_primo_esito is not null then cast(pe.dt_primo_esito as date)
				   else cast(pe.dt_prima_pubb as date)
		 end
	end as data,
	substr(replace(g.codgar, '$',''),1,6) codgara,
	l.codcig,
	tk.tab1desc stato,
	tl.tab1desc as tipo_procedura,
	cast(l.impapp as decimal(15,2)) as imp_base_gara
from torn g
	inner join gare l on l.codgar1=g.codgar
	inner join v_gare_statoesito gse on (g.codgar=gse.codgar)
	inner join (select l.codgar1, max(elencoe) as cod_elenco, min(p.datpub) as dt_prima_pubb, min(e.DINPUBG) as dt_primo_esito
			from gare l
				left join pubbli p on p.codgar9=l.codgar1
				left join pubg e on e.ngara=l.ngara
		  group by l.codgar1) pe on pe.codgar1=g.codgar
	left join tab1 tl on tl.tab1cod='A2044' and tl.tab1tip=l.tipgarg
	left join tab1 tk on tk.tab1cod='A1011' and tk.tab1tip=l.fasgar
where
	(l.genere not in (10,11) or l.genere is null)
	and g.codgar <> l.ngara
	and g.sommaur=1
	and ((gse.codstato=1 and g.iterga not in (3,5,6)) or gse.codstato<>1)
	and (g.codgar in (select codgar from v_ws_bandi_pub_ris) or 
	     g.codgar in (select codgar from v_ws_esiti_pub));
